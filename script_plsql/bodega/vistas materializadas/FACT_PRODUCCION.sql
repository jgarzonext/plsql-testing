----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('FACT_PRODUCCION','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."FACT_PRODUCCION" ("FPROD_ID", "FPROD_NUM_POLIZA", "FPROD_NUM_CERTIFICADO", "FPROD_ORDEN", "FPROD_VLR_PRIMA", "FPROD_PORC_PARTICIPACION", 
  "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN", "FPROD_FK_SUCURSAL", "FPROD_FK_FECHA_FIN", 
  "FPROD_FK_FECHA_COLOCACION", "FPROD_FK_CLIENTE", "FPROD_FK_AGENTE", "FPROD_FK_TECNICA", "FPROD_FK_VINCULO_PERSONA", "FPROD_FK_USUARIO", "FPROD_FK_TIPO_CERTIFICADO", "FPROD_FK_FECHA_INI", 
  "FPROD_PRF", "FPROD_ANTCERTIFICADO")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT SEQ_FPROD_ID.NEXTVAL@BODEGA FPROD_ID,
          S.NPOLIZA FPROD_NUM_POLIZA, 
          RDM.NCERTDIAN FPROD_NUM_CERTIFICADO, 
          G.CGARANT FPROD_ORDEN,
          VR.IPRINET FPROD_VLR_PRIMA,
          DECODE(S.CTIPCOA,8, C.PLOCCOA,0) FPROD_PORC_PARTICIPACION,
          AXIS.F_SYSDATE FECHA_REGISTRO,
          'ACTIVO' ESTADO,
          TO_DATE('01/01/1986') START_ESTADO,
          AXIS.F_SYSDATE END_ESTADO,
          AXIS.F_SYSDATE FECHA_CONTROL,
          TRUNC(AXIS.F_SYSDATE, 'month') FECHA_INICIAL,
          TRUNC(LAST_DAY(AXIS.F_SYSDATE)) FECHA_FIN,
            AXIS.PAC_AGENTES.f_get_cageliq(24, 2, S.cagente)   FPROD_FK_SUCURSAL,
          0 FPROD_FK_FECHA_FIN,
          0 FPROD_FK_FECHA_COLOCACION,
          T.SPERSON FPROD_FK_CLIENTE,
          s.cagente FPROD_FK_AGENTE,
          0 FPROD_FK_TECNICA,
          0 FPROD_FK_VINCULO_PERSONA,
          0 FPROD_FK_USUARIO,
          0 FPROD_FK_TIPO_CERTIFICADO,
          0 FPROD_FK_FECHA_INI, 
          0 FPROD_PRF,
          0 FPROD_ANTCERTIFICADO
   FROM AXIS.SEGUROS S,
         AXIS.MOVSEGURO M,
         AXIS.RANGO_DIAN_MOVSEGURO RDM,
         AXIS.RECIBOS R,
         AXIS.VDETRECIBOS VR,
         AXIS.COACUADRO C,
         (SELECT SSEGURO, CGARANT, MAX(NMOVIMI) 
          FROM AXIS.GARANSEG
          GROUP BY SSEGURO, CGARANT)G,
          AXIS.CAMPANAS CA,
          AXIS.TOMADORES T,
          AXIS.PER_PERSONAS P
   WHERE S.SSEGURO = RDM.SSEGURO(+)
     AND RDM.SSEGURO   =   M.SSEGURO(+)
     AND RDM.NMOVIMI   =   M.NMOVIMI(+)
     AND S.SSEGURO     =   R.SSEGURO
     AND R.NRECIBO     =   VR.NRECIBO
     AND S.SSEGURO     =   C.SSEGURO(+) 
     AND S.SSEGURO     =   G.SSEGURO(+)
     AND S.FEMISIO BETWEEN CA.FINICAM AND CA.FFINCAM
     AND S.SSEGURO     =   T.SSEGURO(+)
     AND S.CAGENTE     =   P.CAGENTE(+);

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."FACT_PRODUCCION"  IS 'snapshot table for snapshot DWH_CONF.FACT_PRODUCCION';
