----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('DIM_CONTRATO','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."DIM_CONTRATO" ("SERIE", "CONTRATO", "NOMBRE_CONTRATO", "BASE", "ORIGEN", "TEC_ID", "CLASE_DE_CONTRATO","CODIGO_CLASE_CONTRATO", "FECHA_DEL_CONTRATO", 
"FECHA_INICIO_CONTRATO", "FECHA_FINAL_CONTRATO", "CONT_ID")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT ' ' SERIE,
   T.SCONTRA CONTRATO, 
   CC.TDESCRIPCION NOMBRE_CONTRATO, 
   SUM(T.ITOTTRA) BASE,
   AXIS.FF_DESVALORFIJO(106, 8, cc.ctiprea) ORIGEN,
   ' ' TEC_ID, 
   AXIS.FF_DESVALORFIJO(106, 8, cc.ctiprea) CLASE_DE_CONTRATO,
   cc.CTIPREA CODIGO_CLASE_CONTRATO,
	ct.fconini FECHA_DEL_CONTRATO,
	ct.fconini FECHA_INICIO_CONTRATO,
	ct.fconfin FECHA_FINAL_CONTRATO,
        ct.scontra CONT_ID
       --SUM((T.ITOTTRA* C.PCESION)/100) CESION
FROM AXIS.TRAMOS T, AXIS.CODICONTRATOS CC, AXIS.CUADROCES C, AXIS.CONTRATOS CT
WHERE --T.SCONTRA=700
 T.SCONTRA=CC.SCONTRA
AND T.SCONTRA=C.SCONTRA  
AND T.NVERSIO=C.NVERSIO
AND T.CTRAMO=C.CTRAMO
AND CT.SCONTRA=C.SCONTRA  
AND CT.NVERSIO=C.NVERSIO

GROUP BY 
       T.SCONTRA , 
       CC.TDESCRIPCION,
       cc.CTIPREA,
       AXIS.FF_DESVALORFIJO(106, 8, cc.ctiprea), 
       ct.fconini,
       ct.fconini,
       ct.fconfin,
       ct.scontra;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."DIM_CONTRATO"  IS 'snapshot table for snapshot DWH_CONF.DIM_CONTRATO';
