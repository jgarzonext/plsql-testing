----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('FACT_CUMULOS','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."FACT_CUMULOS" ("CUM_ID", "CUM_NUM_POLIZA", "CUM_NUM_CERTIFICADO", "CUM_NUM_ORDEN", 
  "CUM_NUM_COBERTURA", "CUM_VALOR_ASEGURADO", "CUM_FECHA_DESDE", "CUM_FECHA_HASTA", "CUM_PRIMA_REASEG", "CUM_FECHA_COLOCACION", "CUM_CLASE_CONTRATO1", 
  "CUM_CONTRATO1", "CUM_PORCENTAJE1", "CUM_VALOR_RESEG1", "CUM_CLASE_CONTRATO2", "CUM_CONTRATO2", "CUM_PORCENTAJE2", "CUM_VALOR_RESEG2", "CUM_CLASE_CONTRATO3", 
  "CUM_CONTRATO3", "CUM_PORCENTAJE3", "CUM_VALOR_RESEG3", "CUM_CLASE_CONTRATO4", "CUM_CONTRATO4", "CUM_PORCENTAJE4", "CUM_VALOR_RESEG4", 
  "CUM_CLASE_CONTRATO5", "CUM_CONTRATO5", "CUM_PORCENTAJE5", "CUM_VALOR_RESEG5", "CUM_CLASE_CONTRATOFAC", "CUM_PORCENTAJEFAC", "CUM_VALOR_RESEGFAC", 
  "CUM_FK_TIEMPO", "CUM_FK_GEOGRAFICA", "CUM_FK_MONEDA", 
  "CUM_FK_TECNICA", "CUM_FK_RANGOVLRASEGURADO", "CUM_FK_PERSONA", "FECHA_CONTROL", "FECHA_REGISTRO", "FECHA_INICIO", 
  "FECHA_FIN", "PAQUETE", "SUCREA", "CUM_CLIENTE_FK", "CUM_CONSORCIO")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT ' ' CUM_ID,
       Q1.CUM_NUM_POLIZA,
       Q1.CUM_NUM_CERTIFICADO,
       Q1.CUM_NUM_ORDEN,
       Q1.CUM_NUM_COBERTURA,
       Q1.CUM_VALOR_ASEGURADO,
       Q1.CUM_FECHA_DESDE,
       Q1.CUM_FECHA_HASTA,
     Q1.CUM_PRIMA_REASEG,
       Q1.CUM_FECHA_COLOCACION,
       Q1.CUM_CLASE_CONTRATO1,
       Q1.CUM_CONTRATO1,
       ROUND (DECODE(Q1.CUMULO_TOTAL,0,0,((Q1.CUM_VALOR_RESEG1*100)/Q1.CUMULO_TOTAL)),2)CUM_PORCENTAJE1,
       Q1.CUM_VALOR_RESEG1,
       Q1.CUM_CLASE_CONTRATO2,
       Q1.CUM_CONTRATO2,
       ROUND(DECODE(Q1.CUMULO_TOTAL,0,0,((Q1.CUM_VALOR_RESEG2*100)/Q1.CUMULO_TOTAL)),2)CUM_PORCENTAJE2,
       Q1.CUM_VALOR_RESEG2,
       Q1.CUM_CLASE_CONTRATO3,
       Q1.CUM_CONTRATO3,
       ROUND(DECODE(Q1.CUMULO_TOTAL,0,0,((Q1.CUM_VALOR_RESEG3*100)/Q1.CUMULO_TOTAL)),2)CUM_PORCENTAJE3,
       Q1.CUM_VALOR_RESEG3,
     ' ' CUM_CLASE_CONTRATO4,
       Q1.CUM_CONTRATO4,
       ROUND(DECODE(Q1.CUMULO_TOTAL,0,0,((Q1.CUM_VALOR_RESEG4*100)/Q1.CUMULO_TOTAL)),2)CUM_PORCENTAJE4,
       Q1.CUM_VALOR_RESEG4,
     ' ' CUM_CLASE_CONTRATO5,
       Q1.CUM_CONTRATO5,
       ROUND(DECODE(Q1.CUMULO_TOTAL,0,0,((Q1.CUM_VALOR_RESEG5*100)/Q1.CUMULO_TOTAL)),2)CUM_PORCENTAJE5,
       Q1.CUM_VALOR_RESEG5,
       --Q1.CUMULO_TOTAL,
        Q1.CUM_CLASE_CONTRATOFAC,
        Q1.CUM_PORCENTAJEFAC,
        Q1.CUM_VALOR_RESEGFAC,
        Q1.CUM_FK_TIEMPO,
        Q1.CUM_FK_GEOGRAFICA,
        Q1.CUM_FK_MONEDA,
        Q1.CUM_FK_TECNICA,
        Q1.CUM_FK_RANGOVLRASEGURADO,
        Q1.CUM_FK_PERSONA,
        Q1.FECHA_CONTROL,
    Q1.FECHA_REGISTRO,
        Q1.FECHA_INICIO,
        Q1.FECHA_FIN,
        Q1.PAQUETE,
        Q1.SUCREA,
        Q1.CUM_CLIENTE_FK,
    Q1.CUM_CONSORCIO
        FROM
(SELECT A.CUM_NUM_POLIZA,
       A.CUM_NUM_CERTIFICADO,
       A.CUM_NUM_ORDEN,
       A.CUM_NUM_COBERTURA,
       SUM(A.CUM_VALOR_ASEGURADO)CUM_VALOR_ASEGURADO,
       A.CUM_FECHA_DESDE,
       A.CUM_FECHA_HASTA,
     SUM(A.CUM_PRIMA_REASEG)CUM_PRIMA_REASEG,
       A.CUM_FECHA_COLOCACION,
       A.CUM_CLASE_CONTRATO1,
       A.CUM_CONTRATO1,
       SUM(A.CUM_VALOR_RESEG1) CUM_VALOR_RESEG1,
       A.CUM_CLASE_CONTRATO2,
       A.CUM_CONTRATO2,
       SUM(A.CUM_VALOR_RESEG2) CUM_VALOR_RESEG2,
       A.CUM_CLASE_CONTRATO3,
       A.CUM_CONTRATO3,
       SUM(A.CUM_VALOR_RESEG3) CUM_VALOR_RESEG3,
       A.CUM_CONTRATO4,
       SUM(A.CUM_VALOR_RESEG4) CUM_VALOR_RESEG4,
       A.CUM_CONTRATO5,
       SUM(A.CUM_VALOR_RESEG5) CUM_VALOR_RESEG5,
       SUM(A.CUMULO_TOTAL) CUMULO_TOTAL,
        A.CUM_CLASE_CONTRATOFAC,
        A.CUM_PORCENTAJEFAC,
        A.CUM_VALOR_RESEGFAC,
        A.CUM_FK_TIEMPO,
        A.CUM_FK_GEOGRAFICA,
        A.CUM_FK_MONEDA,
        A.CUM_FK_PERSONA,
        A.CUM_FK_TECNICA,
        A.CUM_FK_RANGOVLRASEGURADO,
    A.FECHA_CONTROL,
        A.FECHA_REGISTRO, 
        A.FECHA_INICIO,
        A.FECHA_FIN,
        A.PAQUETE,
        A.SUCREA,
        A.CUM_CLIENTE_FK,
    A.CUM_CONSORCIO
       FROM
(
SELECT DISTINCT 
S.SSEGURO,
  S.NPOLIZA CUM_NUM_POLIZA,
  RDM.NCERTDIAN CUM_NUM_CERTIFICADO,
  M.NMOVIMI CUM_NUM_ORDEN,
  G.CGARANT CUM_NUM_COBERTURA,
  G.ICAPITAL CUM_VALOR_ASEGURADO,
  G.FINIEFE CUM_FECHA_DESDE,
  G.FFINEFE CUM_FECHA_HASTA,
  G.IPRIDEV CUM_PRIMA_REASEG,
  ' ' CUM_FECHA_COLOCACION,
  ' ' CUM_CLASE_CONTRATO1,
 CTO1.CUM_CONTRATO1,  
  ' ' CUM_PORCENTAJE1,
  DECODE(CES.CTRAMO, 1, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0) + DECODE(CES.CTRAMO, 0, 
                        DECODE(NVL(CTRAMPA, 0), 1, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0), 0) CUM_VALOR_RESEG1,
  ' ' CUM_CLASE_CONTRATO2,
  CTO2.CUM_CONTRATO2,
  ' ' CUM_PORCENTAJE2,
  DECODE(CES.CTRAMO, 2, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0) + DECODE(CES.CTRAMO, 0,
                        DECODE(NVL(CTRAMPA, 0), 2,  NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0), 0) CUM_VALOR_RESEG2,
  ' ' CUM_CLASE_CONTRATO3,
  CTO3.CUM_CONTRATO3,
  ' ' CUM_PORCENTAJE3,
  DECODE(CES.CTRAMO, 3, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0) + DECODE(CES.CTRAMO, 0,
                        DECODE(NVL(CTRAMPA, 0), 3, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0), 0) CUM_VALOR_RESEG3,
  CTO4.CUM_CONTRATO4,
  ' ' CUM_PORCENTAJE4,
  DECODE(CES.CTRAMO, 4, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0) + DECODE(CES.CTRAMO, 0,
                        DECODE(NVL(CTRAMPA, 0), 4, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0), 0) CUM_VALOR_RESEG4,
  CTO5.CUM_CONTRATO5,
  ' ' CUM_PORCENTAJE5,
  DECODE(CES.CTRAMO, 5, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0) + DECODE(CES.CTRAMO, 0,
                        DECODE(NVL(CTRAMPA, 0), 4, NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE(SYSDATE), DCE.ICAPCES)), 0), 0), 0) CUM_VALOR_RESEG5,
  NVL((AXIS.PAC_ECO_TIPOCAMBIO.F_IMPORTE_CAMBIO(MON.CMONINT, 'COP', TO_DATE
                        (SYSDATE), DCE.ICAPCES)), 0) CUMULO_TOTAL,
  ' ' CUM_CLASE_CONTRATOFAC,
  ' ' CUM_PORCENTAJEFAC,
  ' ' CUM_VALOR_RESEGFAC,
  AXIS.F_SYSDATE CUM_FK_TIEMPO,
  AXIS.PAC_AGENTES.f_get_cageliq(24, 2, S.cagente)CUM_FK_GEOGRAFICA,
  MON.CMONEDA CUM_FK_MONEDA,
  ' ' CUM_FK_TECNICA,
  A.SPERSON CUM_FK_RANGOVLRASEGURADO,
  T.SPERSON CUM_FK_PERSONA, 
  AXIS.F_SYSDATE FECHA_CONTROL,
  AXIS.F_SYSDATE FECHA_REGISTRO, 
  TRUNC(AXIS.F_SYSDATE, 'month') FECHA_INICIO,
  TRUNC(LAST_DAY(AXIS.F_SYSDATE)) FECHA_FIN,
  ' ' PAQUETE,
  ' ' SUCREA,
  ' ' CUM_CLIENTE_FK,
  ' ' CUM_CONSORCIO
  FROM AXIS.SEGUROS S, AXIS.CUMULOS p,  AXIS.garanseg g, AXIS.REARIESGOS R, AXIS.CESIONESREA CES,
       AXIS.MONEDAS MON, AXIS.DET_CESIONESREA DCE,  AXIS.GARANGEN GGE,AXIS.PER_PERSONAS PE,
       AXIS.RANGO_DIAN_MOVSEGURO rdm, AXIS.MOVSEGURO M,AXIS.TOMADORES T,AXIS.ASEGURADOS A,

        (SELECT DISTINCT CT.TCONTRA CUM_CONTRATO1, CES.CTRAMO, CES.SSEGURO, CT.NVERSIO
        FROM AXIS.CONTRATOS CT, AXIS.CESIONESREA CES
        WHERE CT.SCONTRA=CES.SCONTRA  AND CES.CTRAMO=1 AND CT.NVERSIO=(SELECT MIN(NVERSIO)FROM AXIS.CONTRATOS
                                                                                        WHERE SSEGURO=CES.SSEGURO))CTO1,
        (SELECT DISTINCT CT.TCONTRA CUM_CONTRATO2, CES.CTRAMO, CES.SSEGURO, CT.NVERSIO
        FROM AXIS.CONTRATOS CT, AXIS.CESIONESREA CES
        WHERE CT.SCONTRA=CES.SCONTRA  AND CES.CTRAMO=2 AND CT.NVERSIO=(SELECT MIN(NVERSIO)FROM AXIS.CONTRATOS
                                                                                        WHERE SSEGURO=CES.SSEGURO))CTO2,
        (SELECT DISTINCT CT.TCONTRA CUM_CONTRATO3, CES.CTRAMO, CES.SSEGURO, CT.NVERSIO
        FROM AXIS.CONTRATOS CT, AXIS.CESIONESREA CES
        WHERE CT.SCONTRA=CES.SCONTRA  AND CES.CTRAMO=3 AND CT.NVERSIO=(SELECT MIN(NVERSIO)FROM AXIS.CONTRATOS
                                                                                        WHERE SSEGURO=CES.SSEGURO))CTO3,
        (SELECT DISTINCT CT.TCONTRA CUM_CONTRATO4, CES.CTRAMO, CES.SSEGURO, CT.NVERSIO
        FROM AXIS.CONTRATOS CT, AXIS.CESIONESREA CES
        WHERE CT.SCONTRA=CES.SCONTRA  AND CES.CTRAMO=4 AND CT.NVERSIO=(SELECT MIN(NVERSIO)FROM AXIS.CONTRATOS
                                                                                        WHERE SSEGURO=CES.SSEGURO))CTO4,
        (SELECT DISTINCT CT.TCONTRA CUM_CONTRATO5, CES.CTRAMO, CES.SSEGURO, CT.NVERSIO
        FROM AXIS.CONTRATOS CT, AXIS.CESIONESREA CES
        WHERE CT.SCONTRA=CES.SCONTRA  AND CES.CTRAMO=5 AND CT.NVERSIO=(SELECT MIN(NVERSIO)FROM AXIS.CONTRATOS
                                                                                        WHERE SSEGURO=CES.SSEGURO))CTO5
  WHERE P.SCUMULO     =     R.SCUMULO
    AND S.SSEGURO     =     R.SSEGURO
    and G.SSEGURO     =     S.SSEGURO
    --
    and g.nmovimi     =     m.nmovimi
    --
    and S.SSEGURO     =     CES.SSEGURO
    AND MON.CIDIOMA   =     8
    AND MON.CMONEDA   =     AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(s.SPRODUC)
    AND CES.FEFECTO  <=     TO_DATE(SYSDATE)
    AND CES.FVENCIM   >     TO_DATE(SYSDATE)
    AND (CES.FANULAC  >     TO_DATE(SYSDATE)   OR CES.FANULAC  IS NULL)
    AND (CES.FREGULA  >     TO_DATE(SYSDATE)   OR CES.FREGULA  IS NULL)
    AND CES.CGENERA         IN (1, 3, 4, 5, 9, 10, 20, 40, 41)
    AND DCE.SCESREA   =     CES.SCESREA
    AND DCE.SSEGURO   =     S.SSEGURO
    AND NVL(DCE.CDEPURA,'N') = 'N'
    AND DCE.CGARANT   =     GGE.CGARANT
    --
    and g.cgarant     =     gge.cgarant
    --
    AND S.SSEGURO     =     T.SSEGURO(+)
    AND S.SSEGURO     =     A.SSEGURO(+)
    --
    AND PE.SPERSON    =     DCE.SPERSON
    AND S.SSEGURO     =     M.SSEGURO
    AND M.SSEGURO     =     RDM.SSEGURO(+)
    AND M.NMOVIMI     =     RDM.NMOVIMI (+)
    --
    AND CTO1.SSEGURO(+)=    S.SSEGURO
    AND CTO2.SSEGURO(+)=    S.SSEGURO
    AND CTO3.SSEGURO(+)=    S.SSEGURO
    AND CTO4.SSEGURO(+)=    S.SSEGURO
    AND CTO5.SSEGURO(+)=    S.SSEGURO
)A

 GROUP BY  A.CUM_NUM_POLIZA,
       A.CUM_NUM_CERTIFICADO,
       A.CUM_NUM_ORDEN,
       A.CUM_NUM_COBERTURA,
       A.CUM_FECHA_DESDE,
       A.CUM_FECHA_HASTA,
       A.CUM_FECHA_COLOCACION,
       A.CUM_CLASE_CONTRATO1,
       A.CUM_CONTRATO1,
       A.CUM_CLASE_CONTRATO2,
       A.CUM_CONTRATO2,
       A.CUM_CLASE_CONTRATO3,
       A.CUM_CONTRATO3,
       A.CUM_CONTRATO4,
       A.CUM_CONTRATO5,
         A.CUM_CLASE_CONTRATOFAC,
        A.CUM_PORCENTAJEFAC,
        A.CUM_VALOR_RESEGFAC,
        A.CUM_FK_TIEMPO,
        A.CUM_FK_GEOGRAFICA,
        A.CUM_FK_MONEDA,
        A.CUM_FK_PERSONA,
        A.CUM_FK_TECNICA,
        A.CUM_FK_RANGOVLRASEGURADO,
        A.FECHA_REGISTRO, 
        A.FECHA_CONTROL,
        A.FECHA_INICIO,
        A.FECHA_FIN,
        A.PAQUETE,
        A.SUCREA,
        A.CUM_CLIENTE_FK, 
    A.CUM_CONSORCIO   )Q1;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."FACT_CUMULOS"  IS 'snapshot table for snapshot DWH_CONF.FACT_CUMULOS';
