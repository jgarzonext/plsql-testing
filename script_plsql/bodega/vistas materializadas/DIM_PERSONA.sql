----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('DIM_PERSONA','MATERIALIZED VIEW');  
END;
/
----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."DIM_PERSONA" ("PER_CODIGO", "PER_PERSONA", "PER_PERSONA_NOMBRE", "PER_TIPO_PERSONA", "PER_TIPO_PERSONA_DESC", "PER_DIRECC_OFICINA", "PER_DIRECC_RESIDENCIA", 
  "PER_CIUDAD", "PER_DEPARTAMENTO", "PER_EMAIL", "PER_TELEFONO_CELULAR", "PER_TELEFONO_OFICINA", "PER_NUM_EXTENSION", "PER_NUM_FAX", "PER_CIIU", "PER_CIIU_DESC", "PER_SUCURSAL", 
  "PER_REPRESENTE_LEGAL", "PER_CUMULO_CONFISCO", "PER_CUPO_PROVISIONAL", "PER_CUPO_AFIANZADO", "PER_FECHA_CUPO", "PER_EXENTO_CONTRAGAR", "PER_EXENTO_CIRC_CONOC", "PER_FECHA_INGRESO",  
  "PER_CONFIRED", "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN", "TIPOSOC", "PER_SUCREA", "PER_SUCMOD", "PER_FECREA", "PER_FECMOD")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT P.SPERSON PER_CODIGO, P.NNUMIDE PER_PERSONA, D.TNOMBRE PER_PERSONA_NOMBRE,
    P.CTIPPER PER_TIPO_PERSONA, AXIS.FF_DESVALORFIJO(85, AXIS.PAC_MD_COMMON.F_GET_CXTIDIOMA(), P.CTIPPER) PER_TIPO_PERSONA_DESC,
    nvl(AXIS.PAC_ISQLFOR.f_direccion(p.sperson, 1), ' ') PER_DIRECC_OFICINA,
    nvl(AXIS.PAC_ISQLFOR.f_direccion(p.sperson, 2), ' ') PER_DIRECC_RESIDENCIA,
    nvl(AXIS.PAC_ISQLFOR.f_poblacion(P.SPERSON, 1), ' ') PER_CIUDAD,
    nvl(AXIS.PAC_ISQLFOR.f_provincia(P.SPERSON, 1), ' ') PER_DEPARTAMENTO,
    nvl(AXIS.PAC_ISQLFOR.f_per_contactos(P.SPERSON, 3), ' ') PER_EMAIL,
    nvl(AXIS.PAC_ISQLFOR.f_per_contactos(P.SPERSON, 6), ' ') PER_TELEFONO_CELULAR,
    nvl(AXIS.PAC_ISQLFOR.f_per_contactos(P.SPERSON, 1), ' ') PER_TELEFONO_OFICINA,
    ' ' PER_NUM_EXTENSION, 
    nvl(AXIS.PAC_ISQLFOR.f_per_contactos(P.SPERSON, 2), ' ') PER_NUM_FAX,
    FIN.CCIIU PER_CIIU,
    FIN.TATRIBU PER_CIIU_DESC,
    AXIS.PAC_AGENTES.f_get_cageliq(24, 2, p.cagente) PER_SUCURSAL,
            AXIS.PAC_ISQLFOR_CONF.F_PER_RELACIONADAS(1,1,p.cagente) PER_REPRESENTE_LEGAL,
    NVl(AXIS.PAC_ISQLFOR_CONF.F_cumulo_persona(P.SPERSON), 0)PER_CUMULO_CONFISCO,
    NVL(FE.ICUPOS,0)PER_CUPO_PROVISIONAL,
    NVL(FE.ICUPOG,0)PER_CUPO_AFIANZADO,
    FE.FCUPO PER_FECHA_CUPO,
    NVL(PARP.NVALPAR,0)PER_EXENTO_CONTRAGAR,
    ' ' PER_EXENTO_CIRC_CONOC, 
	P.FALTA PER_FECHA_INGRESO,
    AXIS.F_DESAGENTE_T(FA.CAGENTE)PER_CONFIRED,
    AXIS.F_SYSDATE FECHA_REGISTRO,
    'ACTIVO' ESTADO,
    TO_DATE('01/01/1986') START_ESTADO,
    ' ' END_ESTADO,
    AXIS.F_SYSDATE FECHA_CONTROL,
    TRUNC(AXIS.F_SYSDATE, 'month') FECHA_INICIAL,
    TRUNC(LAST_DAY(AXIS.F_SYSDATE)) FECHA_FIN, 
    SOC.TATRIBU TIPOSOC,
    ' ' PER_SUCREA,
    ' ' PER_SUCMOD,
    ' ' PER_FECREA,
    ' ' PER_FECMOD
  FROM AXIS.PER_DETPER D,
     AXIS.PER_PERSONAS P,
  (SELECT * FROM AXIS.PER_PARPERSONAS 
        WHERE CPARAM='PER_EXCENTO_CONTGAR')PARP,
     (SELECT CAGENTE FROM AXIS.FICHA_AGENTE WHERE TTIPCANAL LIKE '%CONFIRED%' )FA,
     (SELECT FIN.SPERSON, FIN.CCIIU, DV.TATRIBU
          FROM AXIS.FIN_GENERAL FIN,
               AXIS.DETVALORES DV
          WHERE DV.CVALOR= 8001072 
             AND DV.CIDIOMA=8
             AND FIN.CCIIU=DV.CATRIBU) FIN,
      (SELECT FE.*,FG.SPERSON
                FROM AXIS.FIN_ENDEUDAMIENTO FE, AXIS.FIN_GENERAL FG 
               WHERE FE.SFINANCI=FG.SFINANCI )FE,
      (SELECT FIN.SPERSON SPERSON, FIN.CTIPSOCI, DV.TATRIBU
          FROM AXIS.FIN_GENERAL FIN,
               AXIS.DETVALORES DV
          WHERE DV.CVALOR= 8001073 
             AND DV.CIDIOMA=8
             AND FIN.CTIPSOCI=DV.CATRIBU) SOC
  WHERE P.SPERSON       =   D.SPERSON
    AND P.CAGENTE       =   FA.CAGENTE(+)
    AND FE.SPERSON(+)   =   P.SPERSON
    AND P.SPERSON       =   FIN.SPERSON(+)
    AND P.SPERSON       =   SOC.SPERSON(+)
    AND PARP.SPERSON(+) =   P.SPERSON
    AND PARP.CAGENTE(+) =   P.CAGENTE
    AND AXIS.PAC_CONTEXTO.f_inicializarctx(AXIS.PAC_PARAMETROS.f_parempresa_t(24,'USER_BBDD'))=0;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."DIM_PERSONA"  IS 'snapshot table for snapshot CONF_DWH.DIM_PERSONA';
