----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('DIM_GRUPO_POLIZA','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
CREATE MATERIALIZED VIEW "CONF_DWH"."DIM_GRUPO_POLIZA" ("POL_ID", "PER_ROL_POL_ID", "NUM_POLIZA_ROLE", "NOM_PERSONA_ROLE", "ID_PERSONA_ROLE", "ROLE", "POL_SUCUR", "POL_COASEG", "POL_CERTIF",
 "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL")
ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH SYSDATE+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
AS SELECT SEQ_OUT_GRUPO_POLIZA_POL_ID.NEXTVAL@BODEGA POL_ID, 
SEQ_OUT_GRUPO_POLIZA_POL_ID.NEXTVAL@BODEGA PER_ROL_POL_ID,
GP.NUM_POLIZA_ROLE,
GP.NOM_PERSONA_ROLE,
GP.ID_PERSONA_ROLE,
GP.ROLE,
GP.POL_SUCUR,
GP.POL_COASEG,
GP.POL_CERTIF,
GP.FECHA_REGISTRO,
GP.ESTADO,
GP.START_ESTADO,
GP.END_ESTADO,
GP.FECHA_CONTROL
from (  
select S.NPOLIZA NUM_POLIZA_ROLE, 
PD.TNOMBRE1 || ' ' || PD.TNOMBRE2 ||  ' ' || PD.TAPELLI1 || ' ' || PD.TAPELLI2 NOM_PERSONA_ROLE, 
P.NNUMIDE ID_PERSONA_ROLE, 
'ASEGURADO' ROLE, 
AXIS.PAC_AGENTES.F_GET_CAGELIQ(24, 2, S.CAGENTE) POL_SUCUR, 
NVL(C.PCESCOA,0) POL_COASEG, 
rdm.NCERTDIAN POL_CERTIF, 
AXIS.F_SYSDATE FECHA_REGISTRO, 
'ACTIVO' ESTADO,
AXIS.F_SYSDATE START_ESTADO,
AXIS.F_SYSDATE END_ESTADO,
AXIS.F_SYSDATE FECHA_CONTROL
FROM AXIS.SEGUROS S, 
AXIS.PER_DETPER PD, 
AXIS.ASEGURADOS A, 
AXIS.PER_PERSONAS P, 
AXIS.COACEDIDO C, AXIS.rango_dian_movseguro rdm, AXIS.movseguro m
WHERE A.SSEGURO = S.SSEGURO
AND A.SPERSON = PD.SPERSON
AND A.SPERSON = P.SPERSON
AND PD.SPERSON = P.SPERSON
AND S.SSEGURO = C.SSEGURO(+)
and m.sseguro = rdm.sseguro
and m.nmovimi = rdm.nmovimi 
and s.sseguro = m.sseguro
union 
select S.NPOLIZA NUM_POLIZA_ROLE, 
PD.TNOMBRE1 || ' ' || PD.TNOMBRE2 ||  ' ' || PD.TAPELLI1 || ' ' || PD.TAPELLI2 NOM_PERSONA_ROLE, 
P.NNUMIDE ID_PERSONA_ROLE, 
'TOMADOR' ROLE, 
AXIS.PAC_AGENTES.F_GET_CAGELIQ(24, 2, S.CAGENTE) POL_SUCUR, 
NVL(C.PCESCOA,0) POL_COASEG, 
rdm.NCERTDIAN POL_CERTIF, 
AXIS.F_SYSDATE FECHA_REGISTRO, 
'ACTIVO' ESTADO,
AXIS.F_SYSDATE START_ESTADO,
AXIS.F_SYSDATE END_ESTADO,
AXIS.F_SYSDATE FECHA_CONTROL
FROM AXIS.SEGUROS S, 
AXIS.PER_DETPER PD, 
AXIS.TOMADORES T, 
AXIS.PER_PERSONAS P, 
AXIS.COACEDIDO C,  AXIS.rango_dian_movseguro rdm, AXIS.movseguro m
WHERE T.SSEGURO = S.SSEGURO
AND T.SPERSON = PD.SPERSON
AND T.SPERSON = P.SPERSON
AND PD.SPERSON = P.SPERSON
AND S.SSEGURO = C.SSEGURO(+)
and m.sseguro = rdm.sseguro
and m.nmovimi = rdm.nmovimi 
and s.sseguro = m.sseguro
union 
select S.NPOLIZA NUM_POLIZA_ROLE, 
PD.TNOMBRE1 || ' ' || PD.TNOMBRE2 ||  ' ' || PD.TAPELLI1 || ' ' || PD.TAPELLI2 NOM_PERSONA_ROLE, 
P.NNUMIDE ID_PERSONA_ROLE, 
'BENEFICIARO' ROLE, 
AXIS.PAC_AGENTES.F_GET_CAGELIQ(24, 2, S.CAGENTE) POL_SUCUR, 
NVL(C.PCESCOA,0) POL_COASEG, 
rdm.NCERTDIAN POL_CERTIF, 
AXIS.F_SYSDATE FECHA_REGISTRO, 
'ACTIVO' ESTADO,
AXIS.F_SYSDATE START_ESTADO,
AXIS.F_SYSDATE END_ESTADO,
AXIS.F_SYSDATE FECHA_CONTROL
FROM AXIS.SEGUROS S, 
AXIS.PER_DETPER PD, 
AXIS.BENESPSEG B, 
AXIS.PER_PERSONAS P, 
AXIS.COACEDIDO C,  AXIS.rango_dian_movseguro rdm, AXIS.movseguro m
WHERE B.SSEGURO = S.SSEGURO
AND B.SPERSON = PD.SPERSON
AND B.SPERSON = P.SPERSON
AND PD.SPERSON = P.SPERSON
AND S.SSEGURO = C.SSEGURO(+)
and m.sseguro = rdm.sseguro
and m.nmovimi = rdm.nmovimi 
and s.sseguro = m.sseguro
) GP
;

COMMENT ON MATERIALIZED VIEW "CONF_DWH"."DIM_GRUPO_POLIZA"  IS 'SNAPSHOT TABLE FOR SNAPSHOT DWH_CONF.DIM_GRUPO_POLIZA';
