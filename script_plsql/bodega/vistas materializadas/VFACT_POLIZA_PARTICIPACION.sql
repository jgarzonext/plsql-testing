--------------------------------------------------------
--  DDL for Materialized View VFACT_POLIZA_PARTICIPACION
--------------------------------------------------------

  CREATE MATERIALIZED VIEW "CONF_DWH"."VFACT_POLIZA_PARTICIPACION" ("FPLP_ID", "FPLP_NUM_POLIZA", "FPLP_NUM_CERTIFICADO", "FPLP_VAL_PRIMA", "FPLP_VAL_ASEG", "FPLP_PARTICIPACION", "FPLP_FK_SUCURSAL", "FPLP_FK_FECHA_INI", "FPLP_FK_FECHA_TER", "FPLP_FK_FECHA_EXP", "FPLP_FK_FECHA_CREA", "FPLP_FK_CLIENTE", "FPLP_FK_AGENTE", "FPLP_FK_TOMADOR", "FPLP_FK_PERSONA_PAR", "FPLP_FK_USUARIO", "FPLP_FK_TIPO_CERTIFICADO", "FPLP_FK_VINCULO_PERSONA", "FPLP_FK_ESTADO_VIGENCIA_POLIZA", "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 0 INITRANS 2 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "CONF_DWH" 
  BUILD IMMEDIATE
  USING INDEX 
  REFRESH FORCE ON DEMAND
  USING DEFAULT LOCAL ROLLBACK SEGMENT
  USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT A.FPLP_NUM_POLIZA||'-'||ROWNUM FPLP_ID, A.* FROM
(SELECT  
FPLP_NUM_POLIZA,
FPLP_NUM_CERTIFICADO,
SUM(FPLP_VAL_PRIMA) FPLP_VAL_PRIMA ,
SUM(FPLP_VAL_ASEG) FPLP_VAL_ASEG,
FPLP_PARTICIPACION,
FPLP_FK_SUCURSAL,
FPLP_FK_FECHA_INI,
FPLP_FK_FECHA_TER,
FPLP_FK_FECHA_EXP,
FPLP_FK_FECHA_CREA,  
FPLP_FK_CLIENTE,
FPLP_FK_AGENTE,
FPLP_FK_TOMADOR,
FPLP_FK_PERSONA_PAR,
FPLP_FK_USUARIO,
FPLP_FK_TIPO_CERTIFICADO,
FPLP_FK_VINCULO_PERSONA,
FPLP_FK_ESTADO_VIGENCIA_POLIZA,
FECHA_REGISTRO,
ESTADO,
START_ESTADO,
END_ESTADO,
FECHA_CONTROL,
FECHA_INICIAL,
FECHA_FIN 
 FROM
(SELECT 
S.NPOLIZA FPLP_NUM_POLIZA, 
RDM.NCERTDIAN FPLP_NUM_CERTIFICADO,
VR.IPRINET FPLP_VAL_PRIMA,
NVL((SELECT SUM(g.icapital)
                FROM garanseg g
               WHERE g.sseguro = m.sseguro
                 AND g.nmovimi = (SELECT MAX(mm.nmovimi)
                                    FROM garanseg mm
                                   WHERE mm.sseguro = m.sseguro
                                     AND mm.nmovimi <= m.nmovimi)),
             0) FPLP_VAL_ASEG,
 DECODE(S.CTIPCOA,8, C.PLOCCOA,0) FPLP_PARTICIPACION,
 pac_agentes.f_get_cageliq(24, 2, S.cagente)  FPLP_FK_SUCURSAL,
 ' ' FPLP_FK_FECHA_INI,
 ' ' FPLP_FK_FECHA_TER,
 ' ' FPLP_FK_FECHA_EXP,
 ' ' FPLP_FK_FECHA_CREA,  
 A.SPERSON FPLP_FK_CLIENTE,
 P.SPERSON FPLP_FK_AGENTE,
 T.SPERSON FPLP_FK_TOMADOR,
 ' ' FPLP_FK_PERSONA_PAR,
 ' ' FPLP_FK_USUARIO,
 ' ' FPLP_FK_TIPO_CERTIFICADO,
 ' ' FPLP_FK_VINCULO_PERSONA,
 S.CSITUAC FPLP_FK_ESTADO_VIGENCIA_POLIZA,
 
 F_SYSDATE FECHA_REGISTRO,
 'ACTIVO' ESTADO,
 TO_DATE('01/01/1986') START_ESTADO,
 ' ' END_ESTADO,
 F_SYSDATE FECHA_CONTROL,
 TRUNC(F_SYSDATE, 'month') FECHA_INICIAL,
 TRUNC(LAST_DAY(F_SYSDATE)) FECHA_FIN
FROM SEGUROS S,
     MOVSEGURO M,
     RANGO_DIAN_MOVSEGURO RDM,
     RECIBOS R,
     VDETRECIBOS VR,
     COACUADRO C,
     TOMADORES T,
     ASEGURADOS A,
     PER_PERSONAS P


WHERE s.sseguro = RDM.SSEGURO(+)
  and RDM.SSEGURO   =   M.SSEGURO(+)
  AND RDM.NMOVIMI   =   M.NMOVIMI(+)
  AND S.SSEGURO     =   R.SSEGURO
  AND R.NRECIBO     =   VR.NRECIBO
  AND S.SSEGURO     =   C.SSEGURO(+) 
  AND S.SSEGURO     =     T.SSEGURO(+)
  AND S.SSEGURO     =     A.SSEGURO(+)
  AND P.CAGENTE(+)  =     S.CAGENTE

  )
  GROUP BY 
FPLP_NUM_POLIZA,
FPLP_NUM_CERTIFICADO,
FPLP_PARTICIPACION,
FPLP_FK_SUCURSAL,
FPLP_FK_FECHA_INI,
FPLP_FK_FECHA_TER,
FPLP_FK_FECHA_EXP,
FPLP_FK_FECHA_CREA,  
FPLP_FK_CLIENTE,
FPLP_FK_AGENTE,
FPLP_FK_TOMADOR,
FPLP_FK_PERSONA_PAR,
FPLP_FK_USUARIO,
FPLP_FK_TIPO_CERTIFICADO,
FPLP_FK_VINCULO_PERSONA,
FPLP_FK_ESTADO_VIGENCIA_POLIZA,
FECHA_REGISTRO,
ESTADO,
START_ESTADO,
END_ESTADO,
FECHA_CONTROL,
FECHA_INICIAL,
FECHA_FIN 
            ORDER BY FPLP_NUM_POLIZA)A;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."VFACT_POLIZA_PARTICIPACION"  IS 'snapshot table for snapshot CONF_DWH.VFACT_POLIZA_PARTICIPACION';
