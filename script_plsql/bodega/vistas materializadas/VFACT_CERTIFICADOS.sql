--------------------------------------------------------
--  DDL for Materialized View VFACT_CERTIFICADOS
--------------------------------------------------------

  CREATE MATERIALIZED VIEW "CONF_DWH"."VFACT_CERTIFICADOS" ("NUM_POLIZA", "NUM_ORDEN", "NUM_CERTIFICADO", "CER_PRIMA_DIRECTA", "CER_PRIMA_CEDIDA", "CER_PRIMA_ACEPTADA", "CER_TIPO_COASEGURO", "CER_PORC_COASEGURO", "GTOS_EXPEDICIÓN", "PRIMA_EMIT", "PRIMA_TOT", "COMISION", "IND_CLIENTE_NUEVO", "VALOR_ASEGURADO", "TRM_EXPED", "FECHA_DESDE", "FECHA_HASTA", "FECHA_EXPEDICION", "FECHA_CONTABILIZACION", "IVA", "TIEMPO_ENTREGA", "VLR_CONTRATO", "AUTORIZA", "SERIEDADOFERTA", "VLR_PROPUESTA", "UBICACIÓN", "DEPARTAMENTO", "SUPERVISOR", "CER_FK_TIEMPO", "CER_FK_RIESGO", "CER_FK_GEOGRAFICA", "CER_FK_MONEDA", "CER_FK_TOMADOR", "CER_FK_ASEGURADO", "CER_FK_CLIENTE", "CER_FK_TECNICO", "CER_FK_INTERMEDIARIO", "CER_FK_TIPOCERTIFICADO", "CER_FK_USUARIO", "CER_FK_RANGOVLRASEGURADO", "FECHA_REGISTRO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 0 INITRANS 2 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "CONF_DWH" 
  BUILD IMMEDIATE
  USING INDEX 
  REFRESH FORCE ON DEMAND
  USING DEFAULT LOCAL ROLLBACK SEGMENT
  USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT a.NUM_POLIZA, a.NUM_ORDEN, a.NUM_CERTIFICADO, SUM(a.CER_PRIMA_DIRECTA) CER_PRIMA_DIRECTA, SUM(a.CER_PRIMA_CEDIDA) CER_PRIMA_CEDIDA, SUM(a.CER_PRIMA_ACEPTADA) CER_PRIMA_ACEPTADA,
       a.CER_TIPO_COASEGURO, a.CER_PORC_COASEGURO, SUM(a.GTOS_EXPEDICIÓN) GTOS_EXPEDICIÓN, SUM(a.PRIMA_EMIT)PRIMA_EMIT, SUM(a.PRIMA_TOT) PRIMA_TOT, SUM(a.COMISION) COMISION,
       cast(a.IND_CLIENTE_NUEVO as number) IND_CLIENTE_NUEVO, SUM(a.VALOR_ASEGURADO) VALOR_ASEGURADO, a.TRM_EXPED,  a.FECHA_DESDE, a.FECHA_HASTA, a.FECHA_EXPEDICION,
       a.FECHA_CONTABILIZACION, sum(a.IVA)IVA, a.TIEMPO_ENTREGA, SUM(a.VLR_CONTRATO)VLR_CONTRATO, cast(a.AUTORIZA as varchar2(25))AUTORIZA, a.SERIEDADOFERTA,
       SUM(a.VLR_PROPUESTA)VLR_PROPUESTA, a.UBICACIÓN, a.DEPARTAMENTO,  a.SUPERVISOR, a.CER_FK_TIEMPO, a.CER_FK_RIESGO,
       a.CER_FK_GEOGRAFICA, a.CER_FK_MONEDA, a.CER_FK_TOMADOR, a.CER_FK_ASEGURADO,a.CER_FK_CLIENTE, a.CER_FK_TECNICO,
       a.CER_FK_INTERMEDIARIO,a.CER_FK_TIPOCERTIFICADO, a.CER_FK_USUARIO,a.CER_FK_RANGOVLRASEGURADO, a.FECHA_REGISTRO,
       a.FECHA_CONTROL, a.FECHA_INICIAL,a.FECHA_FIN
         
       
FROM
(SELECT S.CAGENTE,
  s.npoliza NUM_POLIZA,
  m.nmovimi NUM_ORDEN,
  rdm.NCERTDIAN NUM_CERTIFICADO,
  s.sseguro, r.nrecibo,
  vr.iprinet CER_PRIMA_DIRECTA,
  vr.icednet CER_PRIMA_CEDIDA,
  DECODE(S.CTIPCOA,8,vr.iprinet,0) CER_PRIMA_ACEPTADA,
  s.ctipcoa CER_TIPO_COASEGURO, 
  c.ploccoa CER_PORC_COASEGURO,
  NVL(( DECODE(r.ctiprec, 9, -1, 1) * vr.iderreg),0) GTOS_EXPEDICIÓN,
  vr.iprinet PRIMA_EMIT,
  NVL((DECODE(r.ctiprec, 9, -1, 1) * vr.itotalr) ,0)PRIMA_TOT,
  vr.icombru COMISION,
  '' IND_CLIENTE_NUEVO,  
  cap.icapital VALOR_ASEGURADO,
  PAC_ECO_TIPOCAMBIO.F_CAMBIO(PAC_MONEDAS.F_MONEDA_SEGURO('SEG', S.SSEGURO), 8,S.FEMISIO)  TRM_EXPED,
  S.FEFECTO FECHA_DESDE,
  S.FVENCIM FECHA_HASTA,
  S.FEMISIO FECHA_EXPEDICION,
  CASE WHEN s.fefecto>s.femisio then s.fefecto
       WHEN s.femisio>s.fefecto then s.femisio
       WHEN s.femisio=s.fefecto then s.femisio
       END FECHA_CONTABILIZACION,   
  NVL( DECODE(r.ctiprec, 9, -1, 1) * vr.iips,0) IVA,
  ' ' TIEMPO_ENTREGA,
  CASE WHEN PS.CPREGUN IN (2883) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END VLR_CONTRATO,
  ' ' AUTORIZA,
  CASE WHEN PS.CPREGUN IN (2878) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END SERIEDADOFERTA,
  CASE WHEN PS.CPREGUN IN (2883) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END VLR_PROPUESTA,
  CASE WHEN PS.CPREGUN IN (2887) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END UBICACIÓN,
  CASE WHEN PS.CPREGUN IN (2886) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END DEPARTAMENTO,
  CASE WHEN PS.CPREGUN IN (6505) AND PS.SSEGURO=S.SSEGURO AND PS.NMOVIMI=M.NMOVIMI
       THEN PS.TRESPUE END SUPERVISOR, 
  ' ' CER_FK_TIEMPO,
  ri.nriesgo CER_FK_RIESGO,
  pac_agentes.f_get_cageliq(24, 2, S.cagente) CER_FK_GEOGRAFICA,
  MON.CMONEDA CER_FK_MONEDA,
  T.SPERSON CER_FK_TOMADOR,
  A.SPERSON CER_FK_ASEGURADO,
  ' ' CER_FK_CLIENTE,
  ' ' CER_FK_TECNICO,
  P.SPERSON CER_FK_INTERMEDIARIO,
  ' ' CER_FK_TIPOCERTIFICADO,
  ' ' CER_FK_USUARIO,
  ' ' CER_FK_RANGOVLRASEGURADO,
  M.FEFECTO FECHA_REGISTRO,
  F_SYSDATE FECHA_CONTROL,
  TRUNC(F_SYSDATE, 'month') FECHA_INICIAL,
  TRUNC(LAST_DAY(F_SYSDATE)) FECHA_FIN
  FROM 
      
  seguros s,monedas mon,
  movseguro m,recibos r, vdetrecibos vr, coacuadro c, rango_dian_movseguro rdm,
  TOMADORES T,
  ASEGURADOS A,
  PER_PERSONAS P,
  riesgos ri,
  (SELECT PS.TRESPUE, PS.CPREGUN, PS.SSEGURO, PS.NMOVIMI 
    FROM PREGUNPOLSEG PS, PREGUNTAS P
   WHERE PS.CPREGUN IN (2883,2878,2887,2886)  AND PS.CPREGUN=P.CPREGUN AND P.CIDIOMA=8)PS,
  (SELECT sum(g.icapital)icapital, g.sseguro, g.nmovimi
    FROM garanseg g
   WHERE g.nmovimi = (SELECT MAX(mm.nmovimi)
                                    FROM garanseg mm
                                   WHERE mm.sseguro = g.sseguro
                                     AND mm.nmovimi =g.nmovimi)
  group by g.sseguro, g.nmovimi)CAP
  
  WHERE    s.sseguro      =   m.sseguro
     and   r.sseguro      =   m.sseguro
     and   r.nmovimi      =   m.NMOVIMI
     and   r.nrecibo      =   vr.nrecibo
     and   s.sseguro      =   c.sseguro(+)
     and   m.sseguro      =   rdm.sseguro(+)
     and   m.nmovimi      =   rdm.nmovimi (+)
     and   r.nrecibo      =   vr.nrecibo(+)
     and   cap.sseguro(+) =   m.sseguro
     and   cap.nmovimi    =   m.nmovimi
     and   PS.SSEGURO(+)  =   S.SSEGURO
     AND   MON.CIDIOMA    =     8
     AND   MON.CMONEDA    =     PAC_MONEDAS.F_MONEDA_PRODUCTO(s.SPRODUC)
     AND   S.SSEGURO      =     T.SSEGURO(+)
     AND   S.SSEGURO      =     A.SSEGURO(+)
     AND   S.CAGENTE      =   P.CAGENTE(+)
     and   s.sseguro      =   ri.sseguro
            )a
GROUP BY a.NUM_POLIZA, a.NUM_ORDEN, a.NUM_CERTIFICADO,
       a.CER_TIPO_COASEGURO, a.CER_PORC_COASEGURO, 
       a.IND_CLIENTE_NUEVO,  a.TRM_EXPED,  a.FECHA_DESDE, a.FECHA_HASTA, a.FECHA_EXPEDICION,
       a.FECHA_CONTABILIZACION, a.TIEMPO_ENTREGA, a.AUTORIZA, a.SERIEDADOFERTA,
        a.UBICACIÓN, a.DEPARTAMENTO,  a.SUPERVISOR, a.CER_FK_TIEMPO, a.CER_FK_RIESGO,
       a.CER_FK_GEOGRAFICA, a.CER_FK_MONEDA, a.CER_FK_TOMADOR, a.CER_FK_ASEGURADO,a.CER_FK_CLIENTE, a.CER_FK_TECNICO,
       a.CER_FK_INTERMEDIARIO,a.CER_FK_TIPOCERTIFICADO, a.CER_FK_USUARIO,a.CER_FK_RANGOVLRASEGURADO, a.FECHA_REGISTRO,
       a.FECHA_CONTROL, a.FECHA_INICIAL,a.FECHA_FIN;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."VFACT_CERTIFICADOS"  IS 'snapshot table for snapshot CONF_DWH.VFACT_CERTIFICADOS';
