----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('FACT_COBERTURAS','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."FACT_COBERTURAS" ("COB_ID", "COB_NUM_POLIZA", "COB_NUM_CERTIFICADO", "COB_NUM_ORDEN", "COB_NUM_COBERTURA", "COB_PRIMA_EMITIDA", "COB_PRIMA_DIRECTA", "COB_PRIMA_CEDIDA", 
  "COB_PRIMA_ACEPTADA", "COB_VALOR_ASEGURADO", "COB_VALOR_COMISIONES", "COB_VALOR_PAGO", "COB_VALOR_GASTOS", "COB_VALOR_RECU", "COB_VALOR_DEDU", "COB_FECHA_DESDE", "COB_FECHA_HASTA", 
  "COB_FK_TIEMPO", "COB_FK_GEOGRAFICA", "COB_FK_MONEDA", "COB_FK_PERSONA", "COB_FK_TECNICA", "COB_FK_RANGOVLRASEGURADO", "FECHA_CONTROL", "FECHA_REGISTRO", "FECHA_INICIO", "FECHA_FIN", "FECHAINICIO_POST", "FECHAFIN_POST")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT COB_ID.NEXTVAL@BODEGA CER_ID,
  AA.* 
  FROM (select a.COB_NUM_POLIZA, a.COB_NUM_CERTIFICADO, a.COB_NUM_ORDEN, a.COB_NUM_COBERTURA, nvl(sum(a.COB_PRIMA_EMITIDA),0) COB_PRIMA_EMITIDA, 
  nvl(sum(a.cob_prima_directa),0)cob_prima_directa, nvl(sum(a.cob_prima_cedida),0)cob_prima_cedida,
  nvl(sum(DECODE(a.CTIPCOA,8,a.COB_PRIMA_EMITIDA,0)),0) COB_PRIMA_ACEPTADA,  a.COB_VALOR_ASEGURADO,
  nvl(sum(a.COB_VALOR_COMISIONES),0)COB_VALOR_COMISIONES, nvl(a.COB_VALOR_PAGO,0)COB_VALOR_PAGO, a.COB_VALOR_GASTOS,  nvl(a.COB_VALOR_RECU,0)COB_VALOR_RECU, 
  nvl(a.COB_VALOR_DEDU,0)COB_VALOR_DEDU, a.COB_FECHA_DESDE,a.COB_FECHA_HASTA,
  a.COB_FK_TIEMPO, a.COB_FK_GEOGRAFICA,a.COB_FK_MONEDA, a.COB_FK_PERSONA, a.COB_FK_TECNICA,
  a.COB_FK_RANGOVLRASEGURADO,  a.FECHA_CONTROL, a.FECHA_REGISTRO, a.FECHA_INICIO,
  a.FECHA_FIN, a.FECHAINICIO_POST, a.FECHAFIN_POST from
(SELECT  s.npoliza COB_NUM_POLIZA,
  rdm.NCERTDIAN COB_NUM_CERTIFICADO,
  m.nmovimi COB_NUM_ORDEN,
  GARAN.CGARANT COB_NUM_COBERTURA,
  CASE WHEN dr.CCONCEP=0 AND dr.nrecibo = r.nrecibo AND dr.cgarant=GARAN.cgarant
       THEN dr.ICONCEP END COB_PRIMA_EMITIDA,
   CASE WHEN dr.CCONCEP=0 AND dr.nrecibo = r.nrecibo AND dr.cgarant=GARAN.cgarant
       THEN dr.ICONCEP END COB_PRIMA_DIRECTA,
  CASE WHEN dr.CCONCEP=50 AND dr.nrecibo = r.nrecibo AND dr.cgarant=GARAN.cgarant
       THEN dr.ICONCEP END COB_PRIMA_CEDIDA,
  s.ctipcoa,
   GARAN.icapital COB_VALOR_ASEGURADO,
  CASE WHEN dr.CCONCEP=11 AND dr.nrecibo = r.nrecibo AND dr.cgarant=GARAN.cgarant
       THEN dr.ICONCEP END COB_VALOR_COMISIONES,
  CASE WHEN pago.sseguro=s.sseguro AND pago.cgarant = garan.cgarant
  THEN pago.COB_VALOR_PAGO END COB_VALOR_PAGO,
  0 COB_VALOR_GASTOS,
  0 COB_VALOR_RECU,
  0 COB_VALOR_DEDU,
  GARAN.FINIEFE COB_FECHA_DESDE,
  GARAN.FFINEFE COB_FECHA_HASTA,
  DTM.TIE_ID COB_FK_TIEMPO,
  DG.GEO_ID COB_FK_GEOGRAFICA,
  MON.CMONEDA COB_FK_MONEDA,
  T.SPERSON COB_FK_PERSONA,
  0 COB_FK_TECNICA,
  A.SPERSON COB_FK_RANGOVLRASEGURADO,
  AXIS.F_SYSDATE FECHA_CONTROL,
  AXIS.F_SYSDATE FECHA_REGISTRO, 
  TRUNC(AXIS.F_SYSDATE, 'month') FECHA_INICIO,
  TRUNC(LAST_DAY(SYSDATE)) FECHA_FIN, 
  to_date('01/01/1986') FECHAINICIO_POST, 
  to_date('01/01/1986') FECHAFIN_POST


  FROM AXIS.seguros s, AXIS.recibos r,  AXIS.movseguro m,AXIS.rango_dian_movseguro rdm, AXIS.monedas mon, DIM_TIEMPO@BODEGA DTM,
  (SELECT G.IPRIANU, G.CGARANT, G.SSEGURO, G.NORDEN, G.ICAPITAL, G.NMOVIMI, G.FINIEFE, G.FFINEFE
       FROM AXIS.GARANSEG G
       WHERE NMOVIMI=(SELECT MAX(NMOVIMI) FROM AXIS.GARANSEG
                        WHERE SSEGURO=G.SSEGURO
                          AND CGARANT=G.CGARANT
                        GROUP BY SSEGURO, CGARANT))GARAN,
    AXIS.detrecibos dr,
  AXIS.TOMADORES T,
  AXIS.ASEGURADOS A,
  DIM_GEOGRAFICA@BODEGA DG, 
  AXIS.AGEREDCOM AC,
   (select sum(stpg.isinret) COB_VALOR_PAGO, si.sseguro, stpg.cgarant
      FROM AXIS.sin_siniestro si, AXIS.sin_tramita_pago stp, AXIS.sin_tramita_movpago stm, AXIS.sin_tramita_pago_gar stpg 
      where si.nsinies = stp.nsinies
         and stp.sidepag = stm.sidepag
         and stm.cestpag = 1
         and stp.sidepag = stpg.sidepag
        group by si.sseguro, stpg.cgarant
    )PAGO
  WHERE s.sseguro     =   r.sseguro
    AND garan.sseguro =   S.SSEGURO
    AND s.sseguro     =   m.sseguro
    AND r.nmovimi     =   m.NMOVIMI
    and m.sseguro     =   rdm.sseguro(+)
    and m.nmovimi     =   rdm.nmovimi 
    AND dr.nrecibo(+) =   r.nrecibo
    AND MON.CIDIOMA   =     8
    AND MON.CMONEDA   =     AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(s.SPRODUC)
    AND S.SSEGURO     =     T.SSEGURO(+)
    AND S.SSEGURO     =     A.SSEGURO(+)
    and pago.sseguro(+) = s.sseguro
    AND DG.GEO_SUCURSAL = SUBSTR(AXIS.PAC_AGENTES.F_GET_CAGELIQ(24, AC.CTIPAGE, S.CAGENTE), 3,5) 
    AND AC.CAGENTE = S.CAGENTE
    AND AC.CTIPAGE IN (2,3)
    AND DTM.TIE_FECHA = R.FEFECTO
    )a
    
    group by a.COB_NUM_POLIZA, a.COB_NUM_CERTIFICADO, a.COB_NUM_ORDEN, a.COB_NUM_COBERTURA, a.COB_VALOR_ASEGURADO,
  a.COB_VALOR_PAGO, a.COB_VALOR_GASTOS, a.COB_VALOR_RECU, a.COB_VALOR_DEDU,a.COB_FECHA_DESDE,a.COB_FECHA_HASTA,
  a.COB_FK_TIEMPO, a.COB_FK_GEOGRAFICA,a.COB_FK_MONEDA, a.COB_FK_PERSONA, a.COB_FK_TECNICA,
  a.COB_FK_RANGOVLRASEGURADO,a.FECHA_CONTROL, a.FECHA_REGISTRO, a.FECHA_INICIO,
  a.FECHA_FIN, a.FECHAFIN_POST, a.FECHAINICIO_POST
  )AA       
;

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."FACT_COBERTURAS"  IS 'snapshot table for snapshot DWH_CONF.FACT_COBERTURAS';
