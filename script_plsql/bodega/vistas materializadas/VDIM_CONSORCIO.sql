--------------------------------------------------------
--  DDL for Materialized View VDIM_CONSORCIO
--------------------------------------------------------

  CREATE MATERIALIZED VIEW "CONF_DWH"."VDIM_CONSORCIO" ("CONS_CODIGO", "INTERMEDIARIO_TID", "NNUMIDE", "INTERMEDIARIO_NOM", "INTERMEDIARIO_TAMAÑO", "DIRECC_OFICINA", "CIUDAD", "DEPARTAMENTO", "EMAIL", "TELEFONO_CELULAR", "TELEFONO_OFICINA", "NUM_EXTENSION", "NUM_FAX", "CCIIU", "CCIIU_DESC", "SUCURSAL", "REPRESENT_LEGAL", "CAGENTE", "CONS_ID", "CONS_NIT", "CONS_NOMBRE", "CONS_DIRECC_OFICINA", "CONS_CIUDAD", "CONS_DEPARTAMENTO", "CONS_EMAIL", "CONS_TELEFONO_CELULAR", "CONS_NUM_EXTENSION", "CONS_NUM_FAX", "CONS_CIIU", "CONS_CIIU_DESC", "CONS_SUCURSAL", "CONS_REPRESENTE_LEGAL", "CONS_EXENTO_CONTRAGARANTIA", "CONS_CUPO_PROVISIONAL", "CONS_FECHA_CUPO", "CONS_CUPO_AFIANZADO", "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 0 INITRANS 2 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "CONF_DWH" 
  BUILD IMMEDIATE
  USING INDEX 
  REFRESH FORCE ON DEMAND
  USING DEFAULT LOCAL ROLLBACK SEGMENT
  USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT A.CONS_CODIGO,
       A.INTERMEDIARIO_TID,
       A.NNUMIDE,
       A.INTERMEDIARIO_NOM,
       A.INTERMEDIARIO_TAMAÑO,
       A.DIRECC_OFICINA,
       A.CIUDAD,
       A.DEPARTAMENTO,
       A.EMAIL,
       A.TELEFONO_CELULAR,
       A.TELEFONO_OFICINA, 
       A.NUM_EXTENSION,
       A.NUM_FAX,
       A.CCIIU,    
       A.CCIIU_DESC,
       A.SUCURSAL,
       A.REPRESENT_LEGAL,
       C.CAGENTE,
       C.CONS_ID,
       C.CONS_NIT, 
       C.CONS_NOMBRE,
       C.CONS_DIRECC_OFICINA,
       C.CONS_CIUDAD,
       C.CONS_DEPARTAMENTO,
       C.CONS_EMAIL,
       C.CONS_TELEFONO_CELULAR,
       cast(C.CONS_NUM_EXTENSION as number)CONS_NUM_EXTENSION,
       C.CONS_NUM_FAX,
       C.CONS_CIIU,    
       C.CONS_CIIU_DESC,
       C.CONS_SUCURSAL,
       C.CONS_REPRESENTE_LEGAL,
       C.CONS_EXENTO_CONTRAGARANTIA,
       C.CONS_CUPO_PROVISIONAL,
       C.CONS_FECHA_CUPO,
       C.CONS_CUPO_AFIANZADO,   
       A.FECHA_REGISTRO,      
       A.ESTADO,
       A.START_ESTADO,
       A.END_ESTADO,
       A.FECHA_CONTROL,
       A.FECHA_INICIAL,
       A.FECHA_FIN 
       FROM
(SELECT  A.CAGENTE, P.SPERSON,PR.SPERSON_REL PERSONA_REL, ' 'CONS_CODIGO,
         AC.CTIPINT INTERMEDIARIO_TID,
         P.NNUMIDE,
         f_desagente_t(A.CAGENTE)INTERMEDIARIO_NOM,
         ' 'INTERMEDIARIO_TAMAÑO,
         NVL(PAC_ISQLFOR.F_DIRECCION(A.SPERSON, 1), ' ') DIRECC_OFICINA,
         NVL(PAC_ISQLFOR.F_POBLACION(A.SPERSON, 1), ' ') CIUDAD,
         NVL(PAC_ISQLFOR.F_PROVINCIA(A.SPERSON, 1), ' ') DEPARTAMENTO,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 3), ' ') EMAIL,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 6), ' ') TELEFONO_CELULAR,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 1), ' ') TELEFONO_OFICINA, 
         ' 'NUM_EXTENSION,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 2), ' ') NUM_FAX,
         FIN.CCIIU,
         FIN.TATRIBU CCIIU_DESC,
            pac_agentes.f_get_cageliq(24, 2, p.cagente) SUCURSAL,
          PAC_ISQLFOR_CONF.F_PER_RELACIONADAS(1,1,P.CAGENTE) REPRESENT_LEGAL,
        F_SYSDATE FECHA_REGISTRO,
        'ACTIVO' ESTADO,
         TO_DATE('01/01/1986') START_ESTADO,
         ' ' END_ESTADO,
         F_SYSDATE FECHA_CONTROL,
         TRUNC(F_SYSDATE, 'month') FECHA_INICIAL,
         TRUNC(LAST_DAY(F_SYSDATE)) FECHA_FIN 
        FROM PER_PERSONAS_REL PR,
             AGENTES A,
             AGENTES_COMP AC, 
             PER_PERSONAS P,              
            (SELECT FIN.SPERSON, FIN.CCIIU, DV.TATRIBU
              FROM FIN_GENERAL FIN,
                   DETVALORES DV
              WHERE DV.CVALOR= 8001072 
                 AND DV.CIDIOMA=8
                 AND FIN.CCIIU=DV.CATRIBU) FIN
      WHERE A.SPERSON       =   P.SPERSON(+)
        AND A.CAGENTE       =   AC.CAGENTE(+)
        AND P.SPERSON       =   PR.SPERSON(+)
        AND FIN.SPERSON(+)  =   P.SPERSON)A,

        (SELECT   PR.CAGENTE , PR.SPERSON, PR.SPERSON_REL CONS_ID,
         P.NNUMIDE CONS_NIT, 
         D.TNOMBRE||' '||D.TAPELLI1||' '||D.TAPELLI2 CONS_NOMBRE,
         NVL(PAC_ISQLFOR.F_DIRECCION(PR.SPERSON_REL, 1), ' ') CONS_DIRECC_OFICINA,
         NVL(PAC_ISQLFOR.F_POBLACION(PR.SPERSON_REL, 1), ' ') CONS_CIUDAD,
         NVL(PAC_ISQLFOR.F_PROVINCIA(PR.SPERSON_REL, 1), ' ') CONS_DEPARTAMENTO,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 3), ' ') CONS_EMAIL,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 1), ' ') CONS_TELEFONO_CELULAR,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 2), ' ') CONS_TELEFONO_OFICINA, ''CONS_NUM_EXTENSION,
         NVL(PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 2), ' ') CONS_NUM_FAX,
         FIN.CCIIU CONS_CIIU,
         FIN.TATRIBU CONS_CIIU_DESC,
         pac_agentes.f_get_cageliq(24, 2, p.cagente) CONS_SUCURSAL,
         PAC_ISQLFOR_CONF.F_PER_RELACIONADAS(1,1,PR.CAGENTE) CONS_REPRESENTE_LEGAL,
        NVL(PARP.NVALPAR,0)CONS_EXENTO_CONTRAGARANTIA,
        NVL(FE.ICUPOS,0)CONS_CUPO_PROVISIONAL,
        FE.FCUPO CONS_FECHA_CUPO,
        NVL(FE.ICUPOG,0)CONS_CUPO_AFIANZADO
        FROM PER_PERSONAS P, 
              PER_DETPER D,
             (SELECT FIN.SPERSON, FIN.CCIIU, DV.TATRIBU
              FROM FIN_GENERAL FIN,
                   DETVALORES DV
              WHERE DV.CVALOR= 8001072 
                 AND DV.CIDIOMA=8
                 AND FIN.CCIIU=DV.CATRIBU) FIN,
              (SELECT PARP.NVALPAR,PARP.SPERSON FROM PER_PARPERSONAS PARP
                 WHERE PARP.CPARAM='PER_EXCENTO_CONTGAR' )PARP,
              (SELECT FE.*,FG.SPERSON
                FROM FIN_ENDEUDAMIENTO FE, FIN_GENERAL FG 
               WHERE FE.SFINANCI=FG.SFINANCI )FE,
               (SELECT * FROM PER_PERSONAS_REL 
                WHERE CTIPPER_REL=0)PR

          WHERE PR.SPERSON_REL  =   P.SPERSON
            AND D.SPERSON       =   PR.SPERSON_REL
            AND FIN.SPERSON(+)  =   PR.SPERSON_REL
            AND PARP.SPERSON(+) =   PR.SPERSON_REL
            AND FE.SPERSON(+)   =   PR.SPERSON_REL)C

            WHERE A.SPERSON     =   C.SPERSON(+)
              AND A.PERSONA_REL =   C.CONS_ID(+);

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."VDIM_CONSORCIO"  IS 'snapshot table for snapshot CONF_DWH.VDIM_CONSORCIO';
