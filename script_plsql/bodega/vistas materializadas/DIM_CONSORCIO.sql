----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('DIM_CONSORCIO','MATERIALIZED VIEW');  
END;
/

----- CREATE VISTA ----------
  CREATE MATERIALIZED VIEW "CONF_DWH"."DIM_CONSORCIO" ("CONS_ID", "CONS_CODIGO", "CONS_NIT", "CONS_NOMBRE", "CONS_DIRECC_OFICINA", "CONS_CIUDAD", 
  "CONS_DEPARTAMENTO", "CONS_EMAIL", "CONS_TELEFONO_CELULAR", "CONS_TELEFONO_OFICINA", "CONS_NUM_EXTENSION", "CONS_NUM_FAX", 
  "CONS_CIIU", "CONS_CIIU_DESC", "CONS_SUCURSAL", "CONS_REPRESENTE_LEGAL", "CONS_CLAVE", "CONS_EXENTO_CONTRAGARANTIA", "CONS_CUPO_PROVISIONAL", "CONS_FECHA_CUPO", "CONS_CUPO_AFIANZADO", 
  "FECHA_REGISTRO", "ESTADO", "START_ESTADO", "END_ESTADO", "FECHA_CONTROL", "FECHA_INICIAL", "FECHA_FIN")
  ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH sysdate+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
  AS SELECT CONS_ID.NEXTVAL@BODEGA CONS_ID,
	A.CONS_CODIGO, 
	A.NNUMIDE CONS_NIT,
	A.INTERMEDIARIO_NOM CONS_NOMBRE,		
    A.DIRECC_OFICINA CONS_DIRECC_OFICINA,
	A.CIUDAD CONS_CIUDAD,
	A.DEPARTAMENTO CONS_DEPARTAMENTO,
	A.EMAIL CONS_EMAIL,
	A.TELEFONO_CELULAR CONS_TELEFONO_CELULAR,
	A.TELEFONO_OFICINA CONS_TELEFONO_OFICINA,
	cast(A.NUM_EXTENSION as number)CONS_NUM_EXTENSION,
	A.NUM_FAX CONS_NUM_FAX,
	A.CCIIU CONS_CIIU,    
	A.CCIIU_DESC CONS_CIIU_DESC,
	A.SUCURSAL CONS_SUCURSAL,
	A.REPRESENT_LEGAL CONS_REPRESENTE_LEGAL,
	' ' CONS_CLAVE,
	C.CONS_EXENTO_CONTRAGARANTIA,
	C.CONS_CUPO_PROVISIONAL,
	C.CONS_FECHA_CUPO,
	C.CONS_CUPO_AFIANZADO,   
	A.FECHA_REGISTRO,      
	A.ESTADO,
	A.START_ESTADO,
	A.END_ESTADO,
	A.FECHA_CONTROL,
	A.FECHA_INICIAL,
	A.FECHA_FIN 
       FROM
(SELECT  A.CAGENTE, P.SPERSON,PR.SPERSON_REL CONS_CODIGO,
         AC.CTIPINT INTERMEDIARIO_TID,
         P.NNUMIDE,
         AXIS.F_DESAGENTE_T(A.CAGENTE)INTERMEDIARIO_NOM,
         ' 'INTERMEDIARIO_TAMAÃ‘O,
         NVL(AXIS.PAC_ISQLFOR.F_DIRECCION(A.SPERSON, 1), ' ') DIRECC_OFICINA,
         NVL(AXIS.PAC_ISQLFOR.F_POBLACION(A.SPERSON, 1), ' ') CIUDAD,
         NVL(AXIS.PAC_ISQLFOR.F_PROVINCIA(A.SPERSON, 1), ' ') DEPARTAMENTO,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 3), ' ') EMAIL,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 6), ' ') TELEFONO_CELULAR,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 1), ' ') TELEFONO_OFICINA, 
         '' NUM_EXTENSION,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(A.SPERSON, 2), ' ') NUM_FAX,
         FIN.CCIIU,
         FIN.TATRIBU CCIIU_DESC,
            AXIS.PAC_AGENTES.f_get_cageliq(24, 2, p.cagente) SUCURSAL,
          AXIS.PAC_ISQLFOR_CONF.F_PER_RELACIONADAS(1,1,P.CAGENTE) REPRESENT_LEGAL,
        AXIS.F_SYSDATE FECHA_REGISTRO,
        'ACTIVO' ESTADO,
         TO_DATE('01/01/1986') START_ESTADO,
         AXIS.F_SYSDATE END_ESTADO,
         AXIS.F_SYSDATE FECHA_CONTROL,
         TRUNC(AXIS.F_SYSDATE, 'month') FECHA_INICIAL,
         TRUNC(LAST_DAY(AXIS.F_SYSDATE)) FECHA_FIN 
        FROM AXIS.PER_PERSONAS_REL PR,
             AXIS.AGENTES A,
             AXIS.AGENTES_COMP AC, 
             AXIS.PER_PERSONAS P,              
            (SELECT FIN.SPERSON, FIN.CCIIU, DV.TATRIBU
              FROM AXIS.FIN_GENERAL FIN,
                   AXIS.DETVALORES DV
              WHERE DV.CVALOR= 8001072 
                 AND DV.CIDIOMA=8
                 AND FIN.CCIIU=DV.CATRIBU) FIN
      WHERE A.SPERSON       =   P.SPERSON(+)
        AND A.CAGENTE       =   AC.CAGENTE(+)
        AND P.SPERSON       =   PR.SPERSON(+)
        AND FIN.SPERSON(+)  =   P.SPERSON)A,

        (SELECT   PR.CAGENTE , PR.SPERSON, PR.SPERSON_REL SPERSON_REL,
         P.NNUMIDE CONS_NIT, 
         D.TNOMBRE||' '||D.TAPELLI1||' '||D.TAPELLI2 CONS_NOMBRE,
         NVL(AXIS.PAC_ISQLFOR.F_DIRECCION(PR.SPERSON_REL, 1), ' ') CONS_DIRECC_OFICINA,
         NVL(AXIS.PAC_ISQLFOR.F_POBLACION(PR.SPERSON_REL, 1), ' ') CONS_CIUDAD,
         NVL(AXIS.PAC_ISQLFOR.F_PROVINCIA(PR.SPERSON_REL, 1), ' ') CONS_DEPARTAMENTO,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 3), ' ') CONS_EMAIL,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 1), ' ') CONS_TELEFONO_CELULAR,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 2), ' ') CONS_TELEFONO_OFICINA, 
		 '' CONS_NUM_EXTENSION,
         NVL(AXIS.PAC_ISQLFOR.F_PER_CONTACTOS(PR.SPERSON_REL, 2), ' ') CONS_NUM_FAX,
         FIN.CCIIU CONS_CIIU,
         FIN.TATRIBU CONS_CIIU_DESC,
         AXIS.PAC_AGENTES.f_get_cageliq(24, 2, p.cagente) CONS_SUCURSAL,
         AXIS.PAC_ISQLFOR_CONF.F_PER_RELACIONADAS(1,1,PR.CAGENTE) CONS_REPRESENTE_LEGAL,
        NVL(PARP.NVALPAR,0)CONS_EXENTO_CONTRAGARANTIA,
        NVL(FE.ICUPOS,0)CONS_CUPO_PROVISIONAL,
        FE.FCUPO CONS_FECHA_CUPO,
        NVL(FE.ICUPOG,0)CONS_CUPO_AFIANZADO
        FROM AXIS.PER_PERSONAS P, 
              AXIS.PER_DETPER D,
             (SELECT FIN.SPERSON, FIN.CCIIU, DV.TATRIBU
              FROM AXIS.FIN_GENERAL FIN,
                   AXIS.DETVALORES DV
              WHERE DV.CVALOR= 8001072 
                 AND DV.CIDIOMA=8
                 AND FIN.CCIIU=DV.CATRIBU) FIN,
              (SELECT PARP.NVALPAR,PARP.SPERSON FROM AXIS.PER_PARPERSONAS PARP
                 WHERE PARP.CPARAM='PER_EXCENTO_CONTGAR' )PARP,
              (SELECT FE.*,FG.SPERSON
                FROM AXIS.FIN_ENDEUDAMIENTO FE, AXIS.FIN_GENERAL FG 
               WHERE FE.SFINANCI=FG.SFINANCI )FE,
               (SELECT * FROM AXIS.PER_PERSONAS_REL 
                WHERE CTIPPER_REL=0)PR

          WHERE PR.SPERSON_REL  =   P.SPERSON
            AND D.SPERSON       =   PR.SPERSON_REL
            AND FIN.SPERSON(+)  =   PR.SPERSON_REL
            AND PARP.SPERSON(+) =   PR.SPERSON_REL
            AND FE.SPERSON(+)   =   PR.SPERSON_REL)C

            WHERE A.SPERSON     =   C.SPERSON(+)
              AND A.CONS_CODIGO =   C.SPERSON_REL(+);

   COMMENT ON MATERIALIZED VIEW "CONF_DWH"."DIM_CONSORCIO"  IS 'snapshot table for snapshot DWH_CONF.DIM_CONSORCIO';
