----- DELETE VISTA ----------
BEGIN
    PAC_SKIP_ORA.p_comprovadrop('FACT_CONTRAGARAN','MATERIALIZED VIEW');  
END;
/
----- CREATE VISTA ----------
CREATE MATERIALIZED VIEW "CONF_DWH"."FACT_CONTRAGARAN" ("SUCUR", "NIT", "PERSONA", "NOMBRE_CLIENTE", "NUMRADICACION", "FECHARADICADA", "GEO_ID", "TIE_ID", "FECHA_CONTROL", "FECHA_REGISTRO", "DESCRIPCION", "USU_ID", "TIPODOCUMENTO" )
ORGANIZATION HEAP PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "CONF_DWH"   NO INMEMORY 
BUILD IMMEDIATE
USING INDEX 
REFRESH COMPLETE ON DEMAND START WITH SYSDATE+0 NEXT SYSDATE + 1
USING DEFAULT LOCAL ROLLBACK SEGMENT
USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
AS SELECT TO_NUMBER(SUBSTR(axis.PAC_AGENTES.F_GET_CAGELIQ(24, AC.CTIPAGE, S.CAGENTE), 3,5)) SUCUR,
P.NNUMIDE NIT, 
P.SPERSON PERSONA, 
PD.TNOMBRE1 || ' ' || PD.TNOMBRE2 ||  ' ' || PD.TAPELLI1 || ' ' || PD.TAPELLI2 NOMBRE_CLIENTE, 
CG.SCONTGAR NUMRADICACION, 
CN.FCREA FECHARADICADA, 
DG.GEO_ID GEO_ID, 
TIE_ID TIE_ID, 
axis.F_SYSDATE FECHA_CONTROL,
axis.F_SYSDATE FECHA_REGISTRO, 
CN.TDESCRIPCION DESCRIPCION, 
P.SPERSON USU_ID, 
P.CTIPIDE TIPODOCUMENTO
FROM axis.PER_CONTRAGARANTIA CG, axis.CTGAR_CONTRAGARANTIA CN, axis.PER_DETPER PD,  axis.PER_PERSONAS P,  axis.CTGAR_SEGURO CS, 
axis.SEGUROS S, axis.AGEREDCOM AC, DIM_GEOGRAFICA@BODEGA DG, DIM_TIEMPO@BODEGA DTM
WHERE CG.SPERSON = P.SPERSON
AND PD.SPERSON = P.SPERSON
AND CG.SPERSON = PD.SPERSON 
AND CN.SCONTGAR = CG.SCONTGAR
AND CN.NMOVIMI = (SELECT MAX(CGN.NMOVIMI) FROM axis.CTGAR_CONTRAGARANTIA CGN WHERE CGN.SCONTGAR = CN.SCONTGAR)
AND CS.SSEGURO = S.SSEGURO
AND CS.SCONTGAR = CN.SCONTGAR
AND DG.GEO_SUCURSAL= SUBSTR(axis.PAC_AGENTES.F_GET_CAGELIQ(24, AC.CTIPAGE, S.CAGENTE), 3,5)
AND AC.CAGENTE = S.CAGENTE
AND AC.CTIPAGE IN (2,3)
AND CN.FCREA = DTM.TIE_FECHA
;

COMMENT ON MATERIALIZED VIEW "CONF_DWH"."FACT_CONTRAGARAN"  IS 'SNAPSHOT TABLE FOR SNAPSHOT DWH_CONF.FACT_CONTRAGARAN';



