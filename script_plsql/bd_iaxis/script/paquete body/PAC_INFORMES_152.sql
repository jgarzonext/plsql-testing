--------------------------------------------------------
--  DDL for Package Body PAC_INFORMES_152
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "AXIS"."PAC_INFORMES_152" IS
/******************************************************************************
   NOMBRE:      PAC_INFORMES_152
   REVISIONES:
   Ver        Fecha        Autor             Descripción
   ---------  ----------  ---------------  ------------------------------------
   1.0        25/03/2013   NSS              1. 0025887: RSA003 - Implementar provisión IBNR
   2.0        06/05/2013   JMF              0026721: RSA - Libros oficiales
   3.0        13/05/2013   JMF              0026800 RSA701-Informes reaseguro
   4.0        13/06/2013   FAL              0026430: RSA701-Informes FECU para SVS y listados auxiliares contabilidad
   5.0        17/06/2013   JMF              0026430/0146888: RSA701-Informes FECU para SVS y listados auxiliares contabilidad
   6.0        18/03/2013   JMF              bug 26430/146998 - 18/06/2013 - JMF
   7.0        27/06/2013   FAL              bug 26430/0147498
   8.0        03/09/2013   AFM              bug 26422/151994 quitar resta del IVA en RRC Directa, Provisión la calcula sin IVA.
   9.0        20/09/2013   JMF              0026430 RSA701-Informes FECU para SVS y listados auxiliares contabilidad
  10.0        25/092013   JMF              0026430 Rendimiento
  11.0        31/10/2013   JMF              0026430 pagos cuenta cliente
  12.0        25/11/2013   JMF              0026430 recaudacion
  13.0        23/01/2014   AQ               0026430 modfcadas funciones  f_get_var_ressiniestros,f_get_sini_pagados y f_get_linea_prima_cedida
  14.0        31/03/2014   FAL              0035387: Libros legales no funcionan
  15.0        23/06/2009   DCG              0036502: COLM006-Calculo de la RRC
  16.0		  22/01/2016   AAC			    0039077: Añado el filtro CSUBTIPREC a los listados 890,888,908
  17.0        15/02/2016   JMT              0039207: diferencias proceso de reservas
******************************************************************************/
   v_emp          empresas.cempres%TYPE := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));

   -- BUG 0035387 - FAL - 31/03/2015
   FUNCTION f_busca_plan(
      pseg IN NUMBER,
      prie IN NUMBER DEFAULT NULL,
      pmov IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_busca_plan';
      v_tparam       VARCHAR2(100) := 's=' || pseg || ' r=' || prie || ' m=' || pmov;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      --
      v_sproduc      seguros.sproduc%TYPE;
      v_plan         VARCHAR2(300);
      v_rie          riesgos.nriesgo%TYPE;
      v_mov          movseguro.nmovimi%TYPE;
      v_pol          seguros.npoliza%TYPE;
   BEGIN
      v_ntraza := 100;

      SELECT MAX(sproduc), MAX(npoliza)
        INTO v_sproduc, v_pol
        FROM seguros
       WHERE sseguro = pseg;

      v_ntraza := 110;

      IF v_sproduc = 4007 THEN
         -- igual que condicionados, idconsulta = 1416
         v_ntraza := 120;
         v_rie := NULL;
         v_mov := NULL;

         SELECT MAX(tnatrie)
           INTO v_plan
           FROM riesgos
          WHERE sseguro IN(SELECT sseguro
                             FROM seguros
                            WHERE npoliza = v_pol
                              AND ncertif = 0)
            AND nriesgo = (SELECT crespue
                             FROM pregunpolseg x0
                            WHERE sseguro = pseg
                              AND nmovimi = (SELECT MAX(nmovimi)
                                               FROM pregunpolseg x1
                                              WHERE x1.sseguro = x0.sseguro
                                                AND x1.cpregun = x0.cpregun)
                              AND cpregun = 4089);
      ELSIF v_sproduc IN(4005, 4008) THEN
         -- igual que condicionados, idconsulta = 1411
         v_ntraza := 130;

         IF prie IS NOT NULL THEN
            v_rie := prie;
         ELSE
            v_ntraza := 140;

            SELECT MIN(nriesgo)
              INTO v_rie
              FROM riesgos
             WHERE fanulac IS NULL
               AND sseguro = pseg;
         END IF;

         IF pmov IS NOT NULL THEN
            v_mov := pmov;
         ELSE
            v_ntraza := 150;
            v_mov := pac_isqlfor.f_max_nmovimi(pseg);
         END IF;

         v_ntraza := 160;

         SELECT pac_isqlfor.f_resp_rie(pseg, 429, v_rie, v_mov, 3)
                || DECODE(pac_isqlfor.f_respuesta(pseg, v_mov, 430, 3),
                          '0', NULL,
                          LOWER(' + ') || pac_isqlfor.f_respuesta(pseg, v_mov, 430, 3)
                          || DECODE(pac_isqlfor.f_respuesta(pseg, v_mov, 430, 3),
                                    '1', LOWER(' Adicional'),
                                    LOWER(' Adicionales')))
           INTO v_plan
           FROM DUAL;
      ELSE
         IF prie IS NOT NULL THEN
            v_rie := prie;
         ELSE
            v_ntraza := 170;

            SELECT MIN(nriesgo)
              INTO v_rie
              FROM riesgos
             WHERE fanulac IS NULL
               AND sseguro = pseg;
         END IF;

         v_mov := NULL;
         v_ntraza := 180;
         v_plan := pac_isqlfor.f_lee_pregunta(pseg, v_rie, NULL, NULL, NULL, NULL, 407, 3);
      END IF;

      v_ntraza := 190;
      RETURN v_plan;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_busca_plan;

   -- bug 26430 - 31/10/2013 - JMF
   -- Cedida toda lo cobrado: viene de f_get_linea_prima_cedida sin ramo solo cobro
   FUNCTION f_get_linea_prima_cedida_tc(pdesde IN DATE, phasta IN DATE, pcidioma IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_cedida_tc';
      v_tparam       VARCHAR2(100) := 'pdesde: ' || pdesde || ' phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      -- BUG 26430 - FAL - 14/06/2013
      d_ini          DATE;
      d_fin          DATE;
      vcedida        NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
   -- FI BUG 26430
   BEGIN
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      -- emision +2A
      -- cobro   -2A
      -- reaseguro +2B
      SELECT SUM(cedida)
        INTO vcedida
        FROM (
------------------------------------------------------------------
-- cuadroces emision y cobros
              SELECT SUM
                        (NVL
                            (((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pctcomis,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                              * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                              * DECODE(m.cestrec, 0, 1, -1)),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                     ** 30-12-2013 jmf */
                     pargaranpro xp
               WHERE cc.ctramo = tr.ctramo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND m.nrecibo = r.nrecibo
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND(
                     -- emision +2A
                     (m.cestrec = 0
                      AND m.cestant = 1
                      AND rs.cmotces = 1)
                     OR
                       -- cobro -2A
                     (  m.cestrec = 1
                        AND rs.cmotces = 1))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cactivi = s.cactivi
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND pg2.cgarant = ce.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND m.fmovdia BETWEEN pdesde AND phasta
------------------------------------------------------------------
-- facultativo emision y cobros
              UNION
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pcomisi,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec,
                                                                            0, 1,
                                                                            -1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                     ** 30-12-2013 jmf */
                     pargaranpro xp
               WHERE m.nrecibo = r.nrecibo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 AND cc.sfacult = ce.sfacult
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND(
                     -- emision +2A
                     (m.cestrec = 0
                      AND m.cestant = 1
                      AND rs.cmotces = 1)
                     OR
                       -- cobro -2A
                     (  m.cestrec = 1
                        AND rs.cmotces = 1))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND ce.cgarant = pg2.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND m.fmovdia BETWEEN pdesde AND phasta
              UNION
------------------------------------------------------------------
-- parcial emision y cobros
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pctcomis,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                     ** 30-12-2013 jmf */
                     pargaranpro xp
               WHERE dv.nrecibo = r.nrecibo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 AND dv.norden = 1
                 AND cc.ctramo = tr.ctramo
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.cmotces = 1
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND ce.cgarant = pg2.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND dv.fmovimi BETWEEN pdesde AND phasta
              UNION
------------------------------------------------------------------
-- parcial emision y cobros, facultativo
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pcomisi,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                     ** 30-12-2013 jmf */
                     pargaranpro xp
               WHERE dv.nrecibo = r.nrecibo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 AND dv.norden = 1
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.cmotces = 1
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND cc.sfacult = ce.sfacult
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND ce.cgarant = pg2.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND dv.fmovimi BETWEEN pdesde AND phasta
              UNION
------------------------------------------------------------------
-- Reaseguro
              SELECT SUM(NVL(r.importe, 0)) cedida
                FROM (SELECT icesion_moncon importe, r.fcalcul, r.nsinies, r.sseguro,
                             cc.ccorred, r.cgarant
                        FROM reaseguro r, cuadroces cc
                       WHERE r.cgenera <> 2
                         AND r.ccompani = cc.ccompani
                         AND r.scontra = cc.scontra
                         AND r.nversio = cc.nversio
                         AND r.ctramo = cc.ctramo
                         AND preserv IS NOT NULL) r,
                     seguros s
               /* 30-12-2013 jmf
               companias c,
               productos pr,
               pargaranpro pg,
               detparam dp,
               pargaranpro pg2,
               detparam dp2,
               pargaranpro xp
               ** 30-12-2013 jmf */
              WHERE  s.sseguro = r.sseguro
                 AND r.nsinies IS NULL
                 AND NVL(r.importe, 0) <> 0
                 AND r.fcalcul BETWEEN pdesde AND phasta
                                                        /* 30-12-2013 jmf
                                                        AND c.ccompani = r.ccorred
                                                        AND s.sproduc = pr.sproduc
                                                        AND xp.cpargar = 'RAMOFECU'
                                                        AND xp.sproduc = s.sproduc
                                                        AND s.cramo = xp.cramo
                                                        AND s.cmodali = xp.cmodali
                                                        AND s.ctipseg = xp.ctipseg
                                                        AND s.ccolect = xp.ccolect
                                                        AND pg.cramo = s.cramo
                                                        AND pg.cmodali = s.cmodali
                                                        AND pg.ctipseg = s.ctipseg
                                                        AND pg.ccolect = s.ccolect
                                                        AND pg.cactivi = s.cactivi
                                                        AND pg.cpargar = 'SUBCLAKEIRA'
                                                        AND dp.cidioma = pcidioma
                                                        AND dp.cparam = pg.cpargar
                                                        AND dp.cvalpar = pg.cvalpar
                                                        AND pg2.cramo = s.cramo
                                                        AND pg2.cmodali = s.cmodali
                                                        AND pg2.ctipseg = s.ctipseg
                                                        AND pg2.ccolect = s.ccolect
                                                        AND pg2.cpargar = 'CLAKEIRARAMO'
                                                        AND dp2.cparam = pg2.cpargar
                                                        AND dp2.cidioma = pcidioma
                                                        AND dp2.cvalpar = pg2.cvalpar
                                                        AND xp.cgarant = r.cgarant
                                                        AND pg.cgarant = r.cgarant
                                                        AND pg2.cgarant = r.cgarant
                                                        ** 30-12-2013 jmf */
             );

      RETURN vcedida;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_cedida_tc;

   -- bug 26430 - 31/10/2013 - JMF
   -- Cedida toda la emision: viene de f_get_linea_prima_cedida sin ramo solo emision
   FUNCTION f_get_linea_prima_cedida_te(pdesde IN DATE, phasta IN DATE, pcidioma IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_cedida_te';
      v_tparam       VARCHAR2(100)
                          := 'pdesde: ' || pdesde || ' phasta:' || phasta || ' i=' || pcidioma;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcedida        NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
   -- FI BUG 26430
   BEGIN
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      -- emision +2A
      SELECT SUM(cedida)
        INTO vcedida
        FROM (
------------------------------------------------------------------
-- cuadroces emision
              SELECT SUM
                        (NVL
                            (((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pctcomis,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                              * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                              * DECODE(m.cestrec, 0, 1, -1)),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                     ** 30-12-2013 jmf */
                     pargaranpro xp
               WHERE cc.ctramo = tr.ctramo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND m.nrecibo = r.nrecibo
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND(
                     -- emision +2A
                     (m.cestrec = 0
                      AND m.cestant = 0
                      AND rs.cmotces = 1)
                     OR
                       -- cobro -2A
                     (  m.cestrec = 2
                        AND m.cestant = 0
                        AND rs.cmotces = 2))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cactivi = s.cactivi
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND pg2.cgarant = ce.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND m.fmovdia BETWEEN pdesde AND phasta
------------------------------------------------------------------
-- facultativo emision y cobros
              UNION
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                           ((SELECT cmonint
                                               FROM monedas
                                              WHERE cidioma = pcidioma
                                                AND cmoneda = pr.cdivisa),
                                            v_monedacontab, r.femisio,
                                            NVL((ce.icesion
                                                 * DECODE(tr.ctramo,
                                                          1, DECODE(SIGN((ce.icapces
                                                                          * tr.plocal / 100)
                                                                         - NVL(tr.imaxplo, 0)),
                                                                    -1,(cc.pcesion
                                                                        *(100
                                                                          -((tr.plocal
                                                                             * tr.imaxplo)
                                                                            /((ce.icapces
                                                                               * tr.plocal)
                                                                              / 100))))
                                                                     /(100 - tr.plocal),
                                                                    cc.pcesion),
                                                          cc.pcesion)
                                                 / 100)
                                                * rs.nfactor,
                                                0)
                                            + NVL((ce.icesion
                                                   * DECODE(tr.ctramo,
                                                            1, DECODE(SIGN((ce.icapces
                                                                            * tr.plocal / 100)
                                                                           - NVL(tr.imaxplo, 0)),
                                                                      -1,(cc.pcesion
                                                                          *(100
                                                                            -((tr.plocal
                                                                               * tr.imaxplo)
                                                                              /((ce.icapces
                                                                                 * tr.plocal)
                                                                                / 100))))
                                                                       /(100 - tr.plocal),
                                                                      cc.pcesion),
                                                            cc.pcesion)
                                                   * pac_propio.f_comi_ces(cc.ccomrea,
                                                                           s.sseguro,
                                                                           ce.cgarant,
                                                                           cc.pcomisi,
                                                                           r.femisio)
                                                   / 10000)
                                                  * rs.nfactor,
                                                  0),
                                            1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec,
                                                                            0, 1,
                                                                            -1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     /* 30-12-2013 jmf
                     companias c,
                     pregunpolseg ps,
                     pargaranpro pg,
                     detparam dp,
                     pargaranpro pg2,
                     detparam dp2,
                     titulopro t,
                     per_personas pp,
                     per_personas pe,
                     companias br,
                      30-12-2013 jmf */
                     pargaranpro xp
               WHERE m.nrecibo = r.nrecibo
                 AND xp.cpargar = 'RAMOFECU'
                 AND xp.cgarant = ce.cgarant
                 AND xp.sproduc = s.sproduc
                 AND s.cramo = xp.cramo
                 AND s.cmodali = xp.cmodali
                 AND s.ctipseg = xp.ctipseg
                 AND s.ccolect = xp.ccolect
                 AND cc.sfacult = ce.sfacult
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 /* 30-12-2013 jmf
                 AND t.cramo = s.cramo
                 AND t.cmodali = s.cmodali
                 AND t.ctipseg = s.ctipseg
                 AND t.ccolect = s.ccolect
                 AND t.cidioma = pcidioma
                 AND c.sperson = pp.sperson
                 AND br.ccompani = cc.ccorred
                 AND br.sperson = pe.sperson
                 ** 30-12-2013 jmf */
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND(
                     -- emision +2A
                     (m.cestrec = 0
                      AND m.cestant = 0
                      AND rs.cmotces = 1)
                     OR
                       -- cobro -2A
                     (  m.cestrec = 2
                        AND m.cestant = 0
                        AND rs.cmotces = 2))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 /* 30-12-2013 jmf
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
                 AND s.cramo = pg.cramo
                 AND s.cmodali = pg.cmodali
                 AND s.ctipseg = pg.ctipseg
                 AND s.ccolect = pg.ccolect
                 AND s.cactivi = pg.cactivi
                 AND s.sproduc = pg.sproduc
                 AND pg.cramo = s.cramo
                 AND pg.cmodali = s.cmodali
                 AND pg.ctipseg = s.ctipseg
                 AND pg.ccolect = s.ccolect
                 AND pg.cpargar = 'SUBCLAKEIRA'
                 AND ce.cgarant = pg.cgarant
                 AND pg.cpargar = dp.cparam
                 AND dp.cidioma = pcidioma
                 AND pg.cvalpar = dp.cvalpar
                 AND s.cmodali = pg2.cmodali
                 AND s.ctipseg = pg2.ctipseg
                 AND s.ccolect = pg2.ccolect
                 AND s.cactivi = pg2.cactivi
                 AND s.sproduc = pg2.sproduc
                 AND pg2.cramo = s.cramo
                 AND pg2.cmodali = s.cmodali
                 AND pg2.ctipseg = s.ctipseg
                 AND pg2.ccolect = s.ccolect
                 AND pg2.cpargar = 'CLAKEIRARAMO'
                 AND ce.cgarant = pg2.cgarant
                 AND pg2.cpargar = dp2.cparam
                 AND dp2.cidioma = pcidioma
                 AND pg2.cvalpar = dp2.cvalpar
                 ** 30-12-2013 jmf */
                 AND m.fmovdia BETWEEN pdesde AND phasta);

      RETURN vcedida;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_cedida_te;

   -- bug 0026881 29-10-2013 JMF
   -- Para listado DWH 3.2.5 Affinity fin vigencia
   -- Calcular fecha final de un seguro, a partir de un rango de fechas.
   FUNCTION f_aff_vigenciafin(par_seg IN NUMBER, par_fecini IN DATE, par_fecfin IN DATE)
      RETURN DATE IS
      vobject        VARCHAR2(500) := 'PAC_INFORMES_152.f_aff_vigenciafin';
      vparam         VARCHAR2(500)
         := 's=' || par_seg || ' i=' || TO_CHAR(par_fecini, 'dd-mm-yyyy') || ' f='
            || TO_CHAR(par_fecfin, 'dd-mm-yyyy');
      vpasexec       NUMBER(5) := 1;
      d_cal          DATE;
   BEGIN
      SELECT MAX(fecfin)
        INTO d_cal
        FROM (SELECT sseguro, a.fcaranu fecfin
                FROM seguros a
               WHERE a.fcaranu BETWEEN par_fecini AND par_fecfin
                 AND sseguro = par_seg
              UNION
              SELECT sseguro, a.fefecto fecfin
                FROM movseguro a
               WHERE a.fefecto BETWEEN par_fecini AND par_fecfin
                 AND cmotmov IN(404, 406)
                 AND sseguro = par_seg);

      RETURN d_cal;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobject, vpasexec, vparam, SQLCODE || ' ' || SQLERRM);
         RETURN NULL;
   END;

   -- bug 0026881 29-10-2013 JMF
   -- Para listado DWH 3.2.5 Affinity fin vigencia
   -- Calcular fecha inicial de un seguro, a partir de la fecha final calculada
   FUNCTION f_aff_vigenciaini(par_seg IN NUMBER, par_fecfin IN DATE)
      RETURN DATE IS
      vobject        VARCHAR2(500) := 'PAC_INFORMES_152.f_aff_vigenciaini';
      vparam         VARCHAR2(500)
                              := 's=' || par_seg || ' f=' || TO_CHAR(par_fecfin, 'dd-mm-yyyy');
      vpasexec       NUMBER(5) := 1;
      d_cal          DATE;
   BEGIN
      SELECT MAX(m1.fefecto)
        INTO d_cal
        FROM movseguro m1
       WHERE m1.cmotmov IN(100, 404, 406)
         AND m1.fefecto < par_fecfin
         AND m1.sseguro = par_seg;

      RETURN d_cal;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobject, vpasexec, vparam, SQLCODE || ' ' || SQLERRM);
         RETURN NULL;
   END;

   --
   -- Calculo cesion
   FUNCTION f_icesioncp(par_seg IN NUMBER, par_rie IN NUMBER, par_gar IN NUMBER)
      RETURN NUMBER IS
      --
      vobject        VARCHAR2(500) := 'PAC_INFORMES_152.f_icesioncp';
      vparam         VARCHAR2(500)
                              := 'seg=' || par_seg || ' rie=' || par_rie || ' gar=' || par_gar;
      vpasexec       NUMBER(5) := 1;
      v_total        NUMBER;
   BEGIN
      SELECT SUM(DECODE(t.ctramo, 1,(100 - t.plocal) * c.icesion / 100, c.icesion)) icesion_cp
        INTO v_total
        FROM cesionesrea c, seguros s, riesgos a, contratos ct, sin_tramita_pago_gar pa,
             tramos t
       WHERE c.sseguro = s.sseguro
         AND s.sseguro = par_seg
         AND(par_rie IS NULL
             OR a.nriesgo = par_rie)
         AND(par_gar IS NULL
             OR c.cgarant = par_gar)
         AND s.sseguro = a.sseguro
         AND c.nriesgo = a.nriesgo
         AND c.scontra = ct.scontra(+)
         AND c.nversio = ct.nversio(+)
         AND c.scontra = t.scontra(+)
         AND c.nversio = t.nversio(+)
         AND c.ctramo = t.ctramo(+)
         AND(a.fanulac >= c.fefecto
             OR a.fanulac IS NULL)
         AND(c.sidepag = pa.sidepag(+)
             AND c.cgarant = pa.cgarant(+));

      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobject, vpasexec, vparam, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_icesioncp;

   --
   -- Primas por pagar a Reaseguradores Proyectada
   FUNCTION f_proyectada(
      par_sproduc IN NUMBER,
      par_cactivi IN NUMBER,
      par_cgarant IN NUMBER,
      par_fecini IN DATE,
      par_fecfin IN DATE)
      RETURN NUMBER IS
      --
      vobject        VARCHAR2(500) := 'PAC_INFORMES_152.f_proyectada';
      vparam         VARCHAR2(500)
         := 'pro=' || par_sproduc || ' act=' || par_cactivi || ' gar=' || par_cgarant
            || ' ini=' || par_fecini || 'fin=' || par_fecfin;
      vpasexec       NUMBER(5) := 1;
      v_mondes       monedas.cmonint%TYPE;
      v_total        NUMBER;
   --v_emp          empresas.cempres%TYPE;
   BEGIN
      vpasexec := 10;
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      vpasexec := 20;
      v_mondes := pac_monedas.f_cmoneda_t(pac_parametros.f_parempresa_n(v_emp, 'MONEDACONTAB'));
      vpasexec := 30;

      SELECT NVL(SUM(importe), 0)
        INTO v_total
        FROM (
-- 232020101 / linea 1  +
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE cc.ctramo = tr.ctramo
                 AND m.nrecibo = r.nrecibo
                 AND s.sseguro = r.sseguro
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND rs.cmotces = 1
                 AND((m.cestrec = 0
                      AND m.cestant = 0)
                     OR(m.cestrec = 0
                        AND m.cestant = 1
                        AND NOT EXISTS(SELECT '1'
                                         FROM detmovrecibo dm
                                        WHERE dm.nrecibo = r.nrecibo)))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND m.fmovini BETWEEN par_fecini AND par_fecfin
              UNION ALL
-- 232020101 / linea 10
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE cc.sfacult = ce.sfacult
                 AND m.nrecibo = r.nrecibo
                 AND s.sseguro = r.sseguro
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND rs.cmotces = 1
                 AND((m.cestrec = 0
                      AND m.cestant = 0)
                     OR(m.cestrec = 0
                        AND m.cestant = 1
                        AND NOT EXISTS(SELECT '1'
                                         FROM detmovrecibo dm
                                        WHERE dm.nrecibo = r.nrecibo)))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND m.fmovini BETWEEN par_fecini AND par_fecfin
              UNION ALL
-- 232020101 / linea 50
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE cc.ctramo = tr.ctramo
                 AND m.nrecibo = rs.nrecibo
                 AND s.sseguro = r.sseguro
                 AND m.nrecibo = r.nrecibo
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND((m.cestrec = 2
                      AND m.cestant = 0
                      AND rs.cmotces = 2)
                     OR(m.cestrec = 1
                        AND rs.cmotces = 1
                        AND NOT EXISTS(SELECT '1'
                                         FROM detmovrecibo dm
                                        WHERE dm.nrecibo = r.nrecibo)))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND m.fmovini BETWEEN par_fecini AND par_fecfin
              UNION ALL
-- 232020101 / linea 60
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE dv.nrecibo = r.nrecibo
                 AND dv.norden = 1
                 AND cc.ctramo = tr.ctramo
                 AND dv.nrecibo = rs.nrecibo
                 AND s.sseguro = r.sseguro
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND rs.cmotces = 1
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND dv.fmovimi BETWEEN par_fecini AND par_fecfin
              UNION ALL
-- 232020101 / linea 69
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE cc.sfacult = ce.sfacult
                 AND dv.nrecibo = r.nrecibo
                 AND dv.norden = 1
                 AND dv.nrecibo = rs.nrecibo
                 AND s.sseguro = r.sseguro
                 AND rs.cmotces = 1
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND dv.fmovimi BETWEEN par_fecini AND par_fecfin
              UNION ALL
-- 232020101 / linea 59
              SELECT pac_eco_tipocambio.f_importe_cambio
                                   ((SELECT cmonint
                                       FROM monedas
                                      WHERE cidioma = 3
                                        AND cmoneda = pr.cdivisa), v_mondes, r.femisio,
                                    NVL((ce.icesion
                                         * DECODE(tr.ctramo,
                                                  1, DECODE(SIGN((ce.icapces * tr.plocal / 100)
                                                                 - NVL(tr.imaxplo, 0)),
                                                            -1,(cc.pcesion
                                                                *(100
                                                                  -((tr.plocal * tr.imaxplo)
                                                                    /((ce.icapces * tr.plocal)
                                                                      / 100))))
                                                             /(100 - tr.plocal),
                                                            cc.pcesion),
                                                  cc.pcesion)
                                         / 100)
                                        * rs.nfactor,
                                        0),
                                    1)
                     * DECODE(r.ctiprec, 9, -1, 13, -1, 1) importe
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c
               WHERE cc.sfacult = ce.sfacult
                 AND m.nrecibo = rs.nrecibo
                 AND m.nrecibo = r.nrecibo
                 AND s.sseguro = r.sseguro
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND((m.cestrec = 2
                      AND m.cestant = 0
                      AND rs.cmotces = 2)
                     OR(m.cestrec = 1
                        AND rs.cmotces = 1
                        AND NOT EXISTS(SELECT '1'
                                         FROM detmovrecibo dm
                                        WHERE dm.nrecibo = r.nrecibo)))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccorred
                 AND s.sproduc = par_sproduc
                 AND s.cactivi = par_cactivi
                 AND ce.cgarant = par_cgarant
                 AND m.fmovini BETWEEN par_fecini AND par_fecfin);

      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobject, vpasexec, vparam, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END;

   /*
   f_caliva : para quitar el iva, igual que PAC_PROVTEC_SAM.f_commit_calcul_rrcsam
   */
   FUNCTION f_caliva(p_rec IN NUMBER, p_gar IN NUMBER, p_rie IN NUMBER)
      RETURN NUMBER IS
      wprimrrc_gar   NUMBER;
   BEGIN
      SELECT SUM(NVL(iconcep, 0))
        INTO wprimrrc_gar
        FROM detrecibos
       WHERE nrecibo = p_rec
         AND cgarant = p_gar
         AND nriesgo = p_rie
         AND cconcep = 4;

      RETURN NVL(wprimrrc_gar, 0);
   END;

   /************************************************************************************
       FF_BUSCAPREGUNSEG: Busca respuesta de una pregunta de póliza
       Primero por fecha, sino por movimiento, sino busca el último mov.
   *************************************************************************************/
   FUNCTION ff_buscapregunseg(
      p_seg IN NUMBER,
      p_rie IN NUMBER,
      p_pre IN NUMBER,
      p_mov IN NUMBER,
      p_fec IN DATE DEFAULT NULL)
      RETURN VARCHAR2 IS
      vobject        VARCHAR2(500) := 'PAC_INFORMES_152.ff_buscapregunseg';
      vparam         VARCHAR2(500)
         := 'parámetros - s=' || p_seg || ' r=' || p_rie || ' p=' || p_pre || ' m=' || p_mov
            || 'f=' || p_fec;
      vpasexec       NUMBER(5);
      v_tiptexto     NUMBER(1);
      --v_ret          FLOAT;
      v_ret          pregunseg.trespue%TYPE;
   BEGIN
      vpasexec := 1;

      SELECT DECODE(ctippre, 4, 1, 5, 1, 0)
        INTO v_tiptexto
        FROM codipregun
       WHERE cpregun = p_pre;

      IF p_fec IS NOT NULL THEN
         vpasexec := 2;

         SELECT DECODE(v_tiptexto, 1, MAX(trespue), MAX(crespue))
           INTO v_ret
           FROM pregunseg a
          WHERE sseguro = p_seg
            AND nriesgo = p_rie
            AND cpregun = p_pre
            AND nmovimi = (SELECT MAX(c11.nmovimi)
                             FROM pregunseg c11
                            WHERE c11.sseguro = p_seg
                              AND c11.nriesgo = p_rie
                              AND c11.cpregun = p_pre
                              AND c11.nmovimi <= (SELECT MAX(b11.nmovimi)
                                                    FROM movseguro b11
                                                   WHERE b11.sseguro = p_seg
                                                     AND GREATEST(b11.fefecto, b11.femisio) <=
                                                                                          p_fec));
      ELSIF p_mov IS NOT NULL THEN
         vpasexec := 3;

         SELECT DECODE(v_tiptexto, 1, MAX(trespue), MAX(crespue))
           INTO v_ret
           FROM pregunseg a
          WHERE sseguro = p_seg
            AND nriesgo = p_rie
            AND cpregun = p_pre
            AND nmovimi = p_mov;
      ELSE
         vpasexec := 4;

         SELECT DECODE(v_tiptexto, 1, MAX(trespue), MAX(crespue))
           INTO v_ret
           FROM pregunseg a
          WHERE sseguro = p_seg
            AND nriesgo = p_rie
            AND cpregun = p_pre
            AND nmovimi = (SELECT MAX(b.nmovimi)
                             FROM pregunseg b
                            WHERE b.sseguro = p_seg
                              AND b.nriesgo = p_rie
                              AND b.cpregun = p_pre);
      END IF;

      vpasexec := 4;
      RETURN v_ret;
   EXCEPTION
      WHEN OTHERS THEN
         -- No informar tab error ya que se utiliza en dwh
         RETURN NULL;
   END ff_buscapregunseg;

   -- Calcular fecha provision
   FUNCTION f_fecprov(
      p_pro IN NUMBER,
      p_seg IN NUMBER,
      p_mov IN NUMBER,
      p_efe IN DATE,
      p_act IN DATE)
      RETURN DATE IS
      v_ret          DATE;
      diasgracia     NUMBER;
      diaspartner    NUMBER;
   BEGIN
      IF NVL(f_parproductos_v(p_pro, 'GRACIA_PPPC'), 0) = 1 THEN
         BEGIN
            SELECT crespue
              INTO diasgracia
              FROM pregunpolseg
             WHERE cpregun = 9015
               AND sseguro = p_seg
               AND nmovimi = p_mov;
         EXCEPTION
            WHEN OTHERS THEN
               diasgracia := 0;
         END;

         BEGIN
            SELECT crespue
              INTO diaspartner
              FROM pregunpolseg
             WHERE cpregun = 427
               AND sseguro = p_seg
               AND nmovimi = p_mov;
         EXCEPTION
            WHEN OTHERS THEN
               diaspartner := 0;
         END;

         IF p_efe IS NULL THEN
            v_ret := NULL;
         ELSE
            -- 10/03/2014 sumar 30 dias
            v_ret := p_efe + diasgracia + diaspartner + 30;
         END IF;
      --IF v_ret >= p_act THEN
         -- Si supera fecha actual no mostramos fecha.
      --  v_ret := NULL;
      --END IF;
      ELSE
         v_ret := NULL;
      END IF;

      RETURN v_ret;
   END;

   -- Calcular descripcion estado recibo a mostrar en listados
   FUNCTION f_desrec(
      p_idi IN NUMBER,
      p_cestant IN NUMBER,
      p_cestact IN NUMBER,
      p_ctiprec IN NUMBER,
      p_parcial IN NUMBER DEFAULT 0)
      RETURN VARCHAR2 IS
      v_ret          VARCHAR2(200);
      v_idi          NUMBER;
   BEGIN
      v_ret := NULL;
      v_idi := NVL(NVL(p_idi, f_usu_idioma), 3);

      IF p_parcial = 1 THEN
         v_ret := f_axis_literales(111136, v_idi);   -- Cobro
      ELSE
         IF p_cestant = 0
            AND p_cestact = 0 THEN
            v_ret := f_axis_literales(9903940, v_idi);   -- Emitido
         ELSIF p_cestant = 0
               AND p_cestact = 1 THEN
            v_ret := f_axis_literales(111136, v_idi);   -- Cobro
         ELSIF p_cestant = 0
               AND p_cestact = 2 THEN
            v_ret := f_axis_literales(104838, v_idi);   -- Anulacion
         ELSIF p_cestant = 1
               AND p_cestact = 0 THEN
            v_ret := f_axis_literales(104838, v_idi) || ' ' || f_axis_literales(111136, v_idi);   -- Anulacion Cobro
         ELSIF p_cestant = 2
               AND p_cestact = 0 THEN
            v_ret := f_axis_literales(9905692, v_idi);   -- Reactivacion
         END IF;
      END IF;

      IF p_ctiprec IN(9, 13) THEN
         v_ret := v_ret || ' ' || f_axis_literales(109474, v_idi);
      -- Extorno
      END IF;

      RETURN v_ret;
   END;

   FUNCTION f_parcialsiniva(p_rec IN NUMBER)
      RETURN NUMBER IS
      v_ret          NUMBER;
   BEGIN
      -- Calcular el total del recibo parcial
      -- Bug 26430 - 18/10/2013 - JMF
      SELECT SUM(NVL(pac_propio.f_imp_cobpar(a.nrecibo, 999999, c.iimporte_moncon, b.itotimp,
                                             b.itotalr),
                     0))
        INTO v_ret
        FROM recibos a, vdetrecibos_monpol b, detmovrecibo c
       WHERE b.nrecibo = a.nrecibo
         AND c.nrecibo = a.nrecibo
         AND a.nrecibo = p_rec;

      RETURN v_ret;
   END;

   /******************************************************************************************
     Descripció: Funció busca rut de una persona
     return:     codigo rut
     -- bug 0025887 29-05-2013 JMF
   ******************************************************************************************/
   FUNCTION f_rut(p_sperson IN NUMBER)
      RETURN VARCHAR2 IS
      v_ret          VARCHAR2(200);
   BEGIN
      SELECT MAX(a.nnumide || DECODE(a.tdigitoide, NULL, NULL, '-' || a.tdigitoide))
        --SELECT MAX(a.nnumide)
      INTO   v_ret
        FROM per_personas a
       WHERE a.sperson = p_sperson;

      RETURN v_ret;
   END;

   /******************************************************************************************
     Descripció: Funció busca browker correspondiente
     return:     codigo browker
     -- bug 26430/145282 - 28/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_busca_browker(
      p_ccompani IN NUMBER,
      p_nversio IN NUMBER,
      p_scontra IN NUMBER,
      p_ctramo IN NUMBER)
      RETURN NUMBER IS
      v_ret          cuadroces.ccorred%TYPE;
   BEGIN
      IF p_ctramo = 5 THEN
         SELECT MAX(y.ccorred)
           INTO v_ret
           FROM reaseguro z, cuacesfac y
          WHERE z.ccompani = p_ccompani
            AND z.nversio = p_nversio
            AND z.scontra = p_scontra
            AND z.ctramo = p_ctramo
            AND y.sfacult = z.sfacult
            AND y.ccompani = z.ccompani;
      ELSE
         SELECT MAX(ccorred)
           INTO v_ret
           FROM cuadroces x
          WHERE x.ccompani = p_ccompani
            AND x.nversio = p_nversio
            AND x.scontra = p_scontra
            AND x.ctramo = p_ctramo;
      END IF;

      RETURN v_ret;
   END;

   /******************************************************************************************
     Descripció: Busca porcentaje comision
     return:     porcentaje
     -- bug 26721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_porcomis(
      p_sseguro IN NUMBER,
      p_sproduc IN NUMBER,
      p_act IN NUMBER,
      p_gar IN NUMBER,
      p_ccomisi_indirect IN NUMBER,
      p_cconcepto IN NUMBER DEFAULT NULL)
      RETURN NUMBER IS
      n_val          NUMBER;
      n_tot          NUMBER;
   BEGIN
      IF p_cconcepto IS NULL THEN
         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisiongar cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cactivi = p_act
              AND cp.cgarant = p_gar
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
         GROUP BY cp.pcomisi;

         IF n_tot > 0 THEN
            RETURN n_val;
         END IF;

         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisionacti cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cactivi = p_act
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
         GROUP BY cp.pcomisi;

         IF n_tot > 0 THEN
            RETURN n_val;
         END IF;

         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisionprod cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
         GROUP BY cp.pcomisi;
      ELSE
         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisiongar_concep cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cactivi = p_act
              AND cp.cgarant = p_gar
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
              AND cp.cconcepto = p_cconcepto
         GROUP BY cp.pcomisi;

         IF n_tot > 0 THEN
            RETURN n_val;
         END IF;

         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisionacti_concep cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cactivi = p_act
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
              AND cp.cconcepto = p_cconcepto
         GROUP BY cp.pcomisi;

         IF n_tot > 0 THEN
            RETURN n_val;
         END IF;

         SELECT   cp.pcomisi, COUNT(1)
             INTO n_val, n_tot
             FROM comisionprod_concep cp
            WHERE cp.sproduc = p_sproduc
              AND cp.cmodcom = DECODE(f_es_renovacion(p_sseguro),
                                      0, 2,
                                      f_es_renovacion(p_sseguro))
              AND cp.ccomisi = p_ccomisi_indirect
              AND cp.finivig = (SELECT MAX(finivig)
                                  FROM comisionprod
                                 WHERE sproduc = p_sproduc
                                   AND ccomisi = p_ccomisi_indirect
                                   AND cmodcom = cp.cmodcom)
              AND cp.cconcepto = p_cconcepto
         GROUP BY cp.pcomisi;
      END IF;

      RETURN f_round(n_val);
   END f_porcomis;

   /******************************************************************************************
     Descripció: Busca porcentaje comision total, sin tener en cuenta garantias
     return:     porcentaje
   ******************************************************************************************/
   FUNCTION f_porcomis_total(
      p_sseguro IN NUMBER,
      p_sproduc IN NUMBER,
      p_act IN NUMBER,
      p_ccomisi IN NUMBER,
      p_cmodcom IN NUMBER)
      RETURN NUMBER IS
      n_val          NUMBER;
      n_tot          NUMBER;
   BEGIN
      SELECT SUM(cp.pcomisi) / COUNT(1), COUNT(1)
        INTO n_val, n_tot
        FROM comisiongar cp
       WHERE cp.sproduc = p_sproduc
         AND cp.cactivi = p_act
         AND cp.cmodcom = p_cmodcom
         AND cp.ccomisi = p_ccomisi
         AND(cp.cgarant, cp.finivig) = (SELECT   cgarant, MAX(finivig)
                                            FROM comisionprod
                                           WHERE sproduc = p_sproduc
                                             AND ccomisi = p_ccomisi
                                             AND cmodcom = cp.cmodcom
                                        GROUP BY cgarant);

      IF n_tot > 0 THEN
         RETURN n_val;
      END IF;

      SELECT   cp.pcomisi, COUNT(1)
          INTO n_val, n_tot
          FROM comisionacti cp
         WHERE cp.sproduc = p_sproduc
           AND cp.cactivi = p_act
           AND cp.cmodcom = p_cmodcom
           AND cp.ccomisi = p_ccomisi
           AND cp.finivig = (SELECT MAX(finivig)
                               FROM comisionprod
                              WHERE sproduc = p_sproduc
                                AND ccomisi = p_ccomisi
                                AND cmodcom = cp.cmodcom)
      GROUP BY cp.pcomisi;

      IF n_tot > 0 THEN
         RETURN n_val;
      END IF;

      SELECT   cp.pcomisi, COUNT(1)
          INTO n_val, n_tot
          FROM comisionprod cp
         WHERE cp.sproduc = p_sproduc
           AND cp.cmodcom = p_cmodcom
           AND cp.ccomisi = p_ccomisi
           AND cp.finivig = (SELECT MAX(finivig)
                               FROM comisionprod
                              WHERE sproduc = p_sproduc
                                AND ccomisi = p_ccomisi
                                AND cmodcom = cp.cmodcom)
      GROUP BY cp.pcomisi;

      RETURN f_round(n_val);
   END f_porcomis_total;

   -- P_SPR sproces
   FUNCTION f_provsinpag(
      p_seg IN NUMBER,
      p_fec IN DATE,
      p_tip IN NUMBER,
      p_spr IN NUMBER DEFAULT NULL,
      p_sin IN NUMBER DEFAULT NULL)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_provsinpag';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_directa      NUMBER;
      v_cedida       NUMBER;
      v_total        NUMBER;
   BEGIN
      SELECT SUM(directa), SUM(cedida), SUM(directa) - SUM(cedida)
        INTO v_directa, v_cedida, v_total
        FROM (SELECT ipplpsd directa, ipplprc cedida
                FROM ptpplp p1, sin_siniestro ss
               WHERE ss.sseguro = p1.sseguro
                 AND ss.nsinies = p1.nsinies
                 AND p1.sseguro = p_seg
                 AND p1.fcalcul = p_fec
                 AND NVL(p_spr, p1.sproces) = p1.sproces
                 AND NVL(p_sin, p1.nsinies) = p1.nsinies
              UNION
              SELECT ipplpsd directa, ipplprc cedida
                FROM ptpplp_previo p1, sin_siniestro ss
               WHERE ss.sseguro = p1.sseguro
                 AND ss.nsinies = p1.nsinies
                 AND p1.sseguro = p_seg
                 AND p1.fcalcul = p_fec
                 AND NVL(p_sin, p1.nsinies) = p1.nsinies
                 AND(p_spr IS NOT NULL
                     AND p1.sproces = p_spr));

      IF p_tip = 1 THEN
         RETURN v_directa;
      ELSIF p_tip = 2 THEN
         RETURN v_cedida;
      ELSIF p_tip = 3 THEN
         RETURN v_total;
      ELSE
         RETURN '';
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- bug 0026430 - 01/04/2014 - JMF
   FUNCTION f_impuestopag(p_sidepag IN NUMBER, p_nmovpag IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_impuestopag';
      v_tparam       VARCHAR2(1000) := 'i=' || p_sidepag || ' m=' || p_nmovpag;
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
   BEGIN
      -- cuenta 242010105
      SELECT SUM(NVL(stpg.iivapag, stpg.iiva)) importe
        INTO v_total
        FROM sin_tramita_pago_gar stpg, sin_tramita_movpago stm
       WHERE stm.nmovpag = p_nmovpag
         AND stpg.sidepag = stm.sidepag
         AND stpg.sidepag = p_sidepag;

      -- cuenta 242010107
      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- bug 26430/146998 - 18/06/2013 - JMF
   -- bug 0026430 - 01/04/2014 - JMF
   FUNCTION f_retencionpag(p_sidepag IN NUMBER, p_nmovpag IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_retencionpag';
      v_tparam       VARCHAR2(1000) := 'i=' || p_sidepag || ' m=' || p_nmovpag;
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
   BEGIN
      -- cuenta 242010105
      SELECT SUM(NVL(stpg.iretencpag, stpg.iretenc)) importe
        INTO v_total
        FROM sin_tramita_pago_gar stpg, sin_tramita_movpago stm
       WHERE stm.nmovpag = p_nmovpag
         AND stpg.sidepag = stm.sidepag
         AND stpg.sidepag = p_sidepag;

      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- bug 0026430 - 01/04/2014 - JMF
   FUNCTION f_montoapagar(p_sidepag IN NUMBER, p_nmovpag IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_montoapagar';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
   BEGIN
      -- ccuenta 231060101
      SELECT SUM(NVL(stpg.isinretpag, stpg.isinret)
                 -(NVL(stpg.iivapag, stpg.iiva) + NVL(stpg.iretencpag, stpg.iretenc))) importe
        INTO v_total
        FROM sin_tramita_pago_gar stpg, sin_tramita_movpago stm, sin_tramita_pago stp
       WHERE stpg.sidepag = stm.sidepag
         AND stpg.sidepag = stp.sidepag
         AND stp.ctippag NOT IN(8, 9)
         AND stm.nmovpag = p_nmovpag
         AND stp.sidepag = p_sidepag;

      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- bug 0026430 - 01/04/2014 - JMF
   FUNCTION f_retencionmonto(p_sidepag IN NUMBER, p_nmovpag IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_retencionmonto';
      v_tparam       VARCHAR2(1000) := 'i=' || p_sidepag || ' m=' || p_nmovpag;
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
   BEGIN
      -- ccuenta 242010105
      SELECT SUM(NVL(stpg.iretencpag, stpg.iretenc)) importe
        INTO v_total
        FROM sin_tramita_pago_gar stpg, sin_tramita_movpago stm, sin_tramita_pago stp
       WHERE stpg.sidepag = stm.sidepag
         AND stpg.sidepag = stp.sidepag
         AND stp.ctippag NOT IN(8, 9)
         AND stm.nmovpag = p_nmovpag
         AND stp.sidepag = p_sidepag;

      -- ccuenta 242010107
      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_cesionsobremontototal(p_sidepag IN NUMBER, p_seg IN NUMBER)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_CesionSobreMontoTotal';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
   BEGIN
      -- ccuenta 141020101
      SELECT SUM(NVL(icesion_moncon, icesion)) icesion
        INTO v_total
        FROM sin_tramita_pago sp, reaseguro r
       WHERE 1 = 1
         AND sp.ctippag NOT IN(7, 8)   -- Recobros
         AND r.sidepag = sp.sidepag
         AND r.nsinies = sp.nsinies
         AND r.nsinies IS NOT NULL
         AND r.sidepag IS NOT NULL
         AND NVL(r.icesion, 0) <> 0
         AND sp.sidepag = p_sidepag
         AND r.sseguro = p_seg;

      RETURN v_total;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;
--AAC_20151203_BUG_0039083: Error al generar libro de producción (bug hermano interno)  recuperamos versión del patch AXIS10449
   FUNCTION f_888_cab(p_idioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_888_CAB';
      v_tparam       VARCHAR2(1000)
                     := 'idi=' || p_idioma || ' des=' || fecha_desde || ' has=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_mo           VARCHAR2(100) := '||' || CHR(39) || ' MO' || CHR(39);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(p_idioma, NVL(f_usu_idioma, 3));
      v_ntraza := 110;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      -- bug 26430 - 31/10/2013 - JMF: Comisiones indirectas
      v_ntraza := 130;
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905156, ' || v_idi || ') || CHR(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39) || ' ||CHR(10)||'
                  -- espacios
                  || ' f_axis_literales(9905200, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9903357, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9905425, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9907580, ' || v_idi || ')' || v_sep   -- Nombre Productor
                  || ' f_axis_literales(9905201, ' || v_idi || ')' || v_sep   -- Rut contratante
                  || ' f_axis_literales(9902210, ' || v_idi || ')'
                  || v_sep   -- Nombre Contratante
                          || ' f_axis_literales(9905422, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(800242, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9903499, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(101168, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(100784, ' || v_idi || ')' || v_sep   -- Ramo
                  || ' f_axis_literales(100895, ' || v_idi || ')' || v_sep   -- Recibo
                  || ' f_axis_literales(9903499, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905423, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(105387, ' || v_idi || ') ' || v_sep   -- Coaseguro
                  || ' f_axis_literales(9905427, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9905428, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9905430, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9001993, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905444, ' || v_idi || ')'
                  || v_sep   -- Vigencia inicial
                          || ' f_axis_literales(9001993, ' || v_idi
                  || ') || '' '' || f_axis_literales(151287, ' || v_idi   -- Vigencia final
                  || ')' || v_sep || ' f_axis_literales(152604, ' || v_idi || ')'
                  || v_sep   -- F. Efecto Recibo
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905431, ' || v_idi || ')'
                  || v_sep   -- Valor Prima Afecta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905431, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima Afecta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905433, ' || v_idi || ')'
                  || v_sep   -- Valor Prima Exenta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905433, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima Exenta
                          || ' f_axis_literales(9905434, ' || v_idi || ') ' || v_sep   -- Iva
                  || ' f_axis_literales(9905434, ' || v_idi || ') ' || v_mo || v_sep   -- Iva
                  || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902594, ' || v_idi || ')'
                  || v_sep   -- Valor Prima bruta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902594, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima bruta
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905211, ' || v_idi || ')'
                  || v_sep   -- Comisión Directa
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905211, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión Directa
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902363, ' || v_idi || ')'
                  || v_sep   -- Comision Intermediario
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902363, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comision Intermediario
                          || ' f_axis_literales(9905320, ' || v_idi || ')'
                  || v_sep   -- Comision por recaudacion
                          || ' f_axis_literales(9905320, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comision por recaudacion
                          || ' f_axis_literales(9905321, ' || v_idi || ')'
                  || v_sep   -- Comisión por Acceso Preferente
                          || ' f_axis_literales(9905321, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión por Acceso Preferente
                          || ' f_axis_literales(9905322, ' || v_idi || ')'
                  || v_sep   -- Comisión Uso Canal
                          || ' f_axis_literales(9905322, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión Uso Canal
                          || ' f_axis_literales(9902599, ' || v_idi || ')'
                  || v_sep   -- Comisiones indirectas
                          || ' f_axis_literales(9902599, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisiones indirectas
                          || ' f_axis_literales(9905559, ' || v_idi || ')'
                  || v_sep   -- % comisión intermediación
                          || ' f_axis_literales(9903977, ' || v_idi || ')'
                  || v_sep   -- Porcentaje Comisión Indirecta
                          || ' f_axis_literales(9905561, ' || v_idi || ')'
                  || v_sep   -- Total % otras comisiones
                          || ' f_axis_literales(9002233, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905436, ' || v_idi || ') '
                  || v_sep   -- Valor comisión
                          || ' f_axis_literales(9002233, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905436, ' || v_idi || ') ' || v_mo
                  || v_sep   -- Valor comisión
                          || ' f_axis_literales(100956, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905437, ' || v_idi || ')'
                  || v_sep   -- Reaseguro % cedido
                          || ' f_axis_literales(100956, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905438, ' || v_idi || ')'
                  || v_sep   -- Reaseguro % retenido
                          || CHR(39) || CHR(39) || ' linea FROM DUAL';
      v_ntraza := 150;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END;

   FUNCTION f_888_det(p_idioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_888_DET';
      v_tparam       VARCHAR2(1000)
                     := 'idi=' || p_idioma || ' des=' || fecha_desde || ' has=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_subtiprec_err NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(p_idioma, NVL(f_usu_idioma, 3));
      v_ntraza := 110;
      v_emp := f_empres;
      v_ntraza := 120;
      v_subtiprec_err:= NVL(pac_parametros.f_parempresa_n(v_emp, 'SUBTIPREC_ERRONEO'),0);


      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'ddmmyyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'ddmmyyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ttexto :=
         'SELECT b.rutasegurado ' || v_sep || ' b.nomasegurado ' || v_sep || ' b.rutproductor '
         || v_sep || ' b.nomproductor ' || v_sep || ' b.rutcontratante ' || v_sep
         || ' b.nomcontratante ' || v_sep || ' b.td ' || '' || v_sep || ' b.npoliza ' || v_sep
         || ' b.ncertif ' || v_sep || ' b.ramofecu ' || v_sep || ' b.nrecibo ' || v_sep
         || ' b.nroendoso ' || v_sep || ' b.coat ' || '' || v_sep || ' b.coaporc ' || v_sep
         || ' b.coaprimamo ' || v_sep || ' b.coacomismo ' || v_sep || '  ' || 'b.fvigini '
         || v_sep || ' b.fvigfin ' || v_sep || ' b.fefrec ' || v_sep || ' b.montoafecto '
         || v_sep || ' b.montoafectomo ' || v_sep || ' b.montoexcento ' || v_sep
         || ' b.montoexcentomo ' || v_sep || '  ' || 'b.montoiva ' || v_sep || ' b.montoivamo '
         || v_sep || ' b.valprimabruta ' || v_sep || ' b.valprimabrutamo ' || v_sep
         || ' b.comisdirecta ' || v_sep || ' b.comisdirectamo ' || v_sep || ' '
         || ' b.comisinterme ' || v_sep || ' b.comisintermemo ' || v_sep || ' b.comisrecauda '
         || v_sep || ' b.comisrecaudamo ' || v_sep || ' b.comisaccpref ' || v_sep
         || ' b.comisaccprefmo ' || v_sep || ' b.comisusocana ' || v_sep
         || ' b.comisusocanamo ' || v_sep || ' b.comisindirecto ' || v_sep
         || ' b.comisindirectomo ' || v_sep
         || ' DECODE(b.nccorredor, 0, 0, ROUND(b.pccorredor / b.nccorredor, 2)) ' || v_sep
         || ' DECODE(b.ncpartner, 0, 0, ROUND(b.pcpartner / b.ncpartner, 2)) ' || v_sep
         || ' 0 ' || '' || v_sep || ' b.totalcomis ' || v_sep || ' b.totalcomismo ' || v_sep
         || '(ROUND((DECODE(b.montorea, ' || '   0, 0, ' || '   (SELECT SUM(icesion) '
         || 'FROM cesionesrea ' || 'WHERE sseguro = b.sseguro ' || ' AND((b.td = ''P'' '
         || 'AND cgenera = 3) ' || 'OR(b.td = ''A'' ' || ' AND cgenera = 6) '
         || 'OR(b.td = ''E'' ' || ' AND cgenera IN(4, 7)))) ' || '   / b.montorea)), '
         || '  2)) ' || v_sep || '(100 ' || '   -(ROUND((DECODE(b.montorea, ' || '0, 0, '
         || '(SELECT SUM(icesion) ' || '  FROM cesionesrea ' || ' WHERE sseguro = b.sseguro '
         || '   AND((b.td = ''P'' ' || ' AND cgenera = 3) ' || 'OR(b.td = ''A'' '
         || '   AND cgenera = 6) ' || 'OR(b.td = ''E'' ' || '   AND cgenera IN(4, 7)))) '
         || '/ b.montorea)), ' || '2))) ' || v_sep || ' '''' linea '
         || '  FROM (SELECT   a.tnombre || '' '' || a.tapelli nomasegurado,  a.tnombreage || '' '' || a.tapelliage nomproductor,  a.tnombrecontra || '' '' || a.tapellicontra nomcontratante, a.sseguro, '
         || '   a.nnumidease rutasegurado, a.nnumideage rutproductor, a.nnumidecontra rutcontratante, a.td td, a.npoliza, '
         || '   a.ncertif, a.nmovimi nroendoso, NULL coat, NULL coaporc, NULL coaprimamo, '
         || '   NULL coacomismo, a.fefecto fvigini, a.fcaranu fvigfin, a.fefrec fefrec, '
         || '   SUM(DECODE(a.tasaimp, 0, 0, a.monto)) montoafecto, '
         || '   SUM(DECODE(a.tasaimp, 0, 0, a.montomo)) montoafectomo, '
         || '   SUM(DECODE(a.tasaimp, 0, a.monto, 0)) montoexcento, '
         || '   SUM(DECODE(a.tasaimp, 0, a.montomo, 0)) montoexcentomo, SUM ' || '   (a.iva) '
         || 'montoiva, ' || '   SUM(a.ivamo) montoivamo, SUM(a.montorea) montorea, '
         || '   SUM(a.monto + a.iva) valprimabruta, SUM(a.montomo + a.ivamo) valprimabrutamo, '
         || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || ' 0, a.comisc, '
         || ' 0)) comisdirecta, ' || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
         || ' 0, a.comiscmo, ' || ' 0)) comisdirectamo, '
         || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || ' 1, a.comisc, '
         || ' 0)) comisinterme, ' || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
         || ' 1, a.comiscmo, ' || ' 0)) comisintermemo, '
         || '   SUM(a.comisrecaudo) comisrecauda, SUM(a.comisrecaudomo) comisrecaudamo, '
         || '   SUM(a.comisacpref) comisaccpref, SUM(a.comisacprefmo) comisaccprefmo, '
         || '   SUM(a.comiscanal) comisusocana, SUM(a.comiscanalmo) comisusocanamo, '
         || '   SUM(a.pcomiscorredor) pccorredor, SUM(a.numcomiscorredor) nccorredor, '
         || '   SUM(a.pcomispartner) pcpartner, SUM(a.numcomisparner) ncpartner, '
         || '   SUM(a.comisp) comisindirecto, SUM(a.comispmo) comisindirectomo, '
         || '   SUM(a.comisp + a.comisc) totalcomis, SUM(a.comispmo + a.comiscmo) totalcomismo, a.nrecibo, a.Ramofecu '
         || 'FROM (SELECT   s.npoliza, s.ncertif, s.sseguro, s.fefecto, r.fefecto fefrec, s.fcaranu, '
         || 'DECODE(mv.cmovseg, 0, ''P'', 3, ''A'', ''E'') td, mv.nmovimi, d.nrecibo, '
         || 'd.cconcep, s.cagente, ' || 'nvl(nvl((SELECT nvalcon * nvl(g.cimpips, 0) '
         || '   FROM imprec i, garanpro g ' || '  WHERE i.cconcep = 4 '
         || '   AND i.cramo = s.cramo ' || '   AND i.cmodali = s.cmodali '
         || '   AND i.ctipseg = s.ctipseg ' || '   AND i.ccolect = s.ccolect '
         || '   AND i.cactivi = s.cactivi ' || '   AND i.cgarant = d.cgarant '
         || '   AND s.sproduc = g.sproduc ' || '   AND d.cgarant = g.cgarant), '
         || '   (SELECT nvalcon * nvl(g.cimpips, 0) ' || '   FROM imprec i, garanpro g '
         || '  WHERE i.cconcep = 4 ' || '   AND i.cramo = s.cramo '
         || '   AND i.cmodali = s.cmodali ' || '   AND i.ctipseg = s.ctipseg '
         || '   AND i.ccolect = s.ccolect ' || '   AND i.cactivi = s.cactivi '
         || '   AND i.cgarant is null ' || '   AND s.sproduc = g.sproduc '
         || '   AND d.cgarant = g.cgarant)),0) tasaimp, ' || 'd.cgarant, ' || 'per.nnumide '
         || '|| DECODE(per.tdigitoide, ' || '   NULL, NULL, '
         || '   ''-'' || per.tdigitoide) nnumidease, '
         || 'p.tnombre1 || '' '' || p.tnombre2 tnombre, '
         || 'p.tapelli1 || '' '' || p.tapelli2 tapelli, '
         || 'p2.tnombre1 || '' '' || p2.tnombre2 tnombreage, '
         || 'p2.tapelli1 || '' '' || p2.tapelli2 tapelliage, ' || 'per2.nnumide '
         || '|| DECODE(per2.tdigitoide, ' || '   NULL, NULL, '
         || '   ''-'' || per2.tdigitoide) nnumideage, '
         || 'p3.tnombre1 || '' '' || p3.tnombre2 tnombrecontra, '
         || 'p3.tapelli1 || '' '' || p3.tapelli2 tapellicontra, ' || 'per3.nnumide '
         || '|| DECODE(per3.tdigitoide, ' || '   NULL, NULL, '
         || '   ''-'' || per3.tdigitoide) nnumidecontra,'
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* (DECODE(d.cconcep, '
         || '  0, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) + '
         || '  DECODE(d.cconcep, ' || '  8, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, '
         || '  0)) montomo, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || '* (DECODE(d.cconcep, ' || '  0, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, '
         || '  0)+ ' || '  DECODE(d.cconcep, '
         || '  8, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0)) monto, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* (DECODE(d.cconcep, '
         || '  0, DECODE(m.cestrec, ' || '0, NVL(d.iconcep_monpol, d.iconcep), '
         || 'NVL(-d.iconcep_monpol, -d.iconcep)), ' || '  0+DECODE(d.cconcep, '
         || '  8, DECODE(m.cestrec, ' || '0, NVL(d.iconcep_monpol, d.iconcep), '
         || 'NVL(-d.iconcep_monpol, -d.iconcep)), ' || '  0))) montorea, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  4, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0) iva, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  4, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) ivamo, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  11, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0) comisc, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  11, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) comiscmo, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  17, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0) comisp, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  17, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) comispmo, '
         || 'DECODE(d.cconcep, ' || '47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comisrecaudo, '
         || 'DECODE(d.cconcep, ' || '47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comisrecaudomo, '
         || 'DECODE(d.cconcep, ' || '48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comiscanal, '
         || 'DECODE(d.cconcep, ' || '48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comiscanalmo, '
         || 'DECODE(d.cconcep, ' || '49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comisacpref, '
         || 'DECODE(d.cconcep, ' || '49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comisacprefmo, '
         || 'DECODE(d.cconcep, 11, 1, 0) numcomiscorredor, ' || 'DECODE(d.cconcep, '
         || '11, NVL((SELECT pcomisi ' || 'FROM comisiongar g1 '
         || '   WHERE g1.sproduc = s.sproduc ' || 'AND g1.cgarant = d.cgarant '
         || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) ' || 'AND g1.ccomisi = a.ccomisi '
         || 'AND g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
         || 'AND g1.finivig = ' || '(SELECT MAX(g11.finivig) ' || 'FROM comisiongar g11 '
         || ' WHERE g11.ccomisi = g1.ccomisi ' || ' AND g11.cgarant = g1.cgarant '
         || ' AND g11.cmodcom = g1.cmodcom ' || ' AND g11.cactivi = g1.cactivi '
         || ' AND g11.sproduc = g1.sproduc ' || ' AND g11.finivig <= s.fefecto)), ' || ' 0), '
         || '0) pcomiscorredor, ' || 'DECODE(d.cconcep, 17, 1, 0) numcomisparner, '
         || 'DECODE(d.cconcep, ' || '17, NVL((SELECT pcomisi ' || 'FROM comisiongar g1 '
         || '   WHERE g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
         || 'AND g1.cgarant = d.cgarant ' || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) '
         || 'AND g1.ccomisi = z.ccomisi_indirect ' || 'AND g1.sproduc = s.sproduc '
         || 'AND g1.finivig = ' || '(SELECT MAX(g11.finivig) ' || 'FROM comisiongar g11 '
         || ' WHERE g11.ccomisi = g1.ccomisi ' || ' AND g11.cgarant = g1.cgarant '
         || ' AND g11.cmodcom = g1.cmodcom ' || ' AND g11.cactivi = g1.cactivi '
         || ' AND g11.sproduc = g1.sproduc ' || ' AND g11.finivig <= s.fefecto)), ' || ' 0), '
         || '0) pcomispartnermo, ' || 'DECODE(d.cconcep, ' || '17, NVL((SELECT pcomisi '
         || 'FROM comisiongar g1 ' || '   WHERE g1.sproduc = s.sproduc '
         || 'AND g1.cactivi = s.cactivi ' || 'AND g1.cgarant = d.cgarant '
         || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) '
         || 'AND g1.ccomisi = z.ccomisi_indirect ' || 'AND g1.sproduc = s.sproduc '
         || 'AND g1.finivig = ' || '(SELECT MAX(g11.finivig) ' || 'FROM comisiongar g11 '
         || ' WHERE g11.ccomisi = g1.ccomisi ' || ' AND g11.cgarant = g1.cgarant '
         || ' AND g11.cmodcom = g1.cmodcom ' || ' AND g11.cactivi = g1.cactivi '
         || ' AND g11.sproduc = g1.sproduc ' || ' AND g11.finivig <= s.fefecto)), ' || ' 0), '
         || '0) pcomispartner, ' || 'ac.ctipint, ' || 'xp.cvalpar Ramofecu '
         || '  FROM seguros s, detrecibos d, movrecibo m, recibos r, per_detper p,  per_detper p2, '
         || 'per_personas per, riesgos ri, movseguro mv, agentes a, agentes z, garanpro gp, pargaranpro xp, '
         || 'per_personas per2, agentes_comp ac, tomadores t, per_personas per3, per_detper p3 '
         || ' WHERE r.ctiprec IN(0, 1, 3, 9)  AND ('||v_subtiprec_err||' =0 OR ('||v_subtiprec_err||'=1 AND NVL(r.csubtiprec,-1) <> 21))'
         || 'AND z.cagente = pac_redcomercial.f_busca_padre(s.cempres, s.cagente, '
         || '  NULL, f_sysdate) ' || 'AND s.cagente = a.cagente '
         || 'AND ri.sseguro = s.sseguro ' || 'AND mv.sseguro = s.sseguro '
         || 'AND mv.nmovimi = r.nmovimi ' || 'AND ri.sperson = p.sperson '
         || 'AND ri.nriesgo = d.nriesgo ' || 'AND ri.sperson = per.sperson '
         || 'AND a.sperson = per2.sperson ' || 'AND a.sperson = p2.sperson '
         || 'AND s.sseguro = r.sseguro ' || 'AND r.nrecibo = d.nrecibo '
         || 'AND r.nrecibo = m.nrecibo ' || 'AND d.cconcep IN(0, 8, 4, 11, 17, 47, 48, 49) '
         || 'AND d.nrecibo = m.nrecibo ' || 'AND s.cempres = 21 '
         || 'AND TRUNC(m.fmovdia) BETWEEN TO_DATE(''' || v_ini || ''', ''ddmmyyyy'') '
         || 'AND TO_DATE(''' || v_fin || ''', ''ddmmyyyy'')' || 'AND m.cestrec IN(0) '
         || 'AND m.cestant = 0 ' || 'AND s.cmodali = gp.cmodali '
         || 'AND s.ccolect = gp.ccolect ' || 'AND s.cramo =  gp.cramo  '
         || 'AND s.ctipseg = gp.ctipseg ' || 'AND s.cactivi = gp.cactivi '
         || 'AND ctipgar = 2 ' || 'AND xp.cpargar = ''RAMOFECU'' '
         || 'AND xp.cgarant = gp.cgarant ' || 'AND xp.sproduc = s.sproduc '
         || 'AND s.cramo = xp.cramo ' || 'AND s.cmodali = xp.cmodali '
         || 'AND s.ctipseg = xp.ctipseg ' || 'AND s.ccolect = xp.ccolect '
         || 'AND ac.cagente = a.cagente '
         || 'AND t.sseguro = (select sseguro from seguros where npoliza = s.npoliza and ncertif = 0) '
         || 'AND t.sperson = per3.sperson ' || 'AND t.sperson = p3.sperson '
         || 'ORDER BY s.npoliza, d.cgarant) a '
         || ' GROUP BY a.tnombre, a.tapelli, a.tnombreage, a.tapelliage, a.tnombrecontra, a.tapellicontra, a.nnumidease, a.nnumideage, a.nnumidecontra, a.td, a.sseguro, a.npoliza, '
         || '   a.ncertif, a.nmovimi, a.fefecto, a.fefrec, a.fcaranu, a.nrecibo, a.Ramofecu) b '
         || 'UNION ' || 'SELECT b.rutasegurado ' || v_sep || ' b.nomasegurado ' || v_sep
         || ' b.rutproductor ' || v_sep || ' b.nomproductor ' || v_sep || ' b.rutcontratante '
         || v_sep || ' b.nomcontratante ' || v_sep || ' b.td ' || '' || v_sep || ' b.npoliza '
         || v_sep || ' b.ncertif ' || v_sep || ' b.ramofecu ' || v_sep || ' b.nrecibo '
         || v_sep || ' b.nroendoso ' || v_sep || ' b.coat ' || '' || v_sep || ' b.coaporc '
         || v_sep || ' b.coaprimamo ' || v_sep || ' b.coacomismo ' || v_sep || ' b.fvigini '
         || v_sep || ' b.fvigfin ' || v_sep || ' b.fefrec ' || v_sep || ' b.montoafecto '
         || v_sep || ' b.montoafectomo ' || v_sep || ' b.montoexcento ' || v_sep
         || ' b.montoexcentomo ' || v_sep || ' b.montoiva ' || v_sep || ' b.montoivamo '
         || v_sep || ' b.valprimabruta ' || v_sep || ' b.valprimabrutamo ' || v_sep
         || ' b.comisdirecta ' || v_sep || ' b.comisdirectamo ' || v_sep || ' b.comisinterme '
         || v_sep || ' b.comisintermemo ' || v_sep || ' b.comisrecauda ' || v_sep
         || ' b.comisrecaudamo ' || v_sep || ' b.comisaccpref ' || v_sep
         || ' b.comisaccprefmo ' || v_sep || ' b.comisusocana ' || v_sep
         || ' b.comisusocanamo ' || v_sep || ' b.comisindirecto ' || v_sep
         || ' b.comisindirectomo ' || v_sep
         || ' DECODE(b.nccorredor, 0, 0, ROUND(b.pccorredor / b.nccorredor, 2)) ' || v_sep
         || ' DECODE(b.ncpartner, 0, 0, ROUND(b.pcpartner / b.ncpartner, 2)) ' || v_sep
         || ' 0 ' || '' || v_sep || ' b.totalcomis ' || v_sep || ' b.totalcomismo ' || v_sep
         || '(ROUND((DECODE(b.montorea, ' || '   0, 0, ' || '   (SELECT SUM(icesion) '
         || 'FROM cesionesrea ' || 'WHERE sseguro = b.sseguro ' || ' AND((b.td = ''P'' '
         || 'AND cgenera = 3) ' || 'OR(b.td = ''A'' ' || ' AND cgenera = 6) '
         || 'OR(b.td = ''E'' ' || ' AND cgenera IN(4, 7)))) ' || '   / b.montorea)), '
         || '  2)) ' || v_sep || '(100 ' || '   -(ROUND((DECODE(b.montorea, ' || '0, 0, '
         || '(SELECT SUM(icesion) ' || '  FROM cesionesrea ' || ' WHERE sseguro = b.sseguro '
         || '   AND((b.td = ''P'' ' || ' AND cgenera = 3) ' || 'OR(b.td = ''A'' '
         || '   AND cgenera = 6) ' || 'OR(b.td = ''E'' ' || '   AND cgenera IN(4, 7)))) '
         || '/ b.montorea)), ' || '2))) ' || v_sep || ' '''' linea '
         || '  FROM (SELECT   a.tnombre || '' '' || a.tapelli nomasegurado,  a.tnombreage || '' '' || a.tapelliage nomproductor, a.tnombrecontra || '' '' || a.tapellicontra nomcontratante, a.sseguro, '
         || '   a.nnumidease rutasegurado, a.nnumideage rutproductor, a.nnumidecontra rutcontratante, a.td td, a.npoliza, '
         || '   a.ncertif, a.nmovimi nroendoso, NULL coat, NULL coaporc, NULL coaprimamo, '
         || '   NULL coacomismo, a.fefecto fvigini, a.fcaranu fvigfin, a.fefrec fefrec, '
         || '   SUM(DECODE(a.tasaimp, 0, 0, a.monto)) montoafecto, '
         || '   SUM(DECODE(a.tasaimp, 0, 0, a.montomo)) montoafectomo, '
         || '   SUM(DECODE(a.tasaimp, 0, a.monto, 0)) montoexcento, '
         || '   SUM(DECODE(a.tasaimp, 0, a.montomo, 0)) montoexcentomo, SUM ' || '   (a.iva) '
         || 'montoiva, ' || '   SUM(a.ivamo) montoivamo, SUM(a.montorea) montorea, '
         || '   SUM(a.monto + a.iva) valprimabruta, SUM(a.montomo + a.ivamo) valprimabrutamo, '
         || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || ' 0, a.comisc, '
         || ' 0)) comisdirecta, ' || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
         || ' 0, a.comiscmo, ' || ' 0)) comisdirectamo, '
         || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || ' 1, a.comisc, '
         || ' 0)) comisinterme, ' || '   SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
         || ' 1, a.comiscmo, ' || ' 0)) comisintermemo, '
         || '   SUM(a.comisrecaudo) comisrecauda, SUM(a.comisrecaudomo) comisrecaudamo, '
         || '   SUM(a.comisacpref) comisaccpref, SUM(a.comisacprefmo) comisaccprefmo, '
         || '   SUM(a.comiscanal) comisusocana, SUM(a.comiscanalmo) comisusocanamo, '
         || '   SUM(a.pcomiscorredor) pccorredor, SUM(a.numcomiscorredor) nccorredor, '
         || '   SUM(a.pcomispartner) pcpartner, SUM(a.numcomisparner) ncpartner, '
         || '   SUM(a.comisp) comisindirecto, SUM(a.comispmo) comisindirectomo, '
         || '   SUM(a.comisp + a.comisc) totalcomis, SUM(a.comispmo + a.comiscmo) '
         || ' totalcomismo, ' || ' a.nrecibo, a.Ramofecu '
         || 'FROM (SELECT   s.npoliza, s.ncertif, s.sseguro, s.fefecto, r.fefecto fefrec, s.fcaranu, ''A'' td, '
         || 'mv.nmovimi, d.nrecibo, d.cconcep, s.cagente, '
         || 'nvl(nvl((SELECT nvalcon * nvl(g.cimpips, 0) ' || '   FROM imprec i, garanpro g '
         || '  WHERE i.cconcep = 4 ' || '   AND i.cramo = s.cramo '
         || '   AND i.cmodali = s.cmodali ' || '   AND i.ctipseg = s.ctipseg '
         || '   AND i.ccolect = s.ccolect ' || '   AND i.cactivi = s.cactivi '
         || '   AND i.cgarant = d.cgarant ' || '   AND s.sproduc = g.sproduc '
         || '   AND d.cgarant = g.cgarant), ' || '   (SELECT nvalcon * nvl(g.cimpips, 0) '
         || '   FROM imprec i, garanpro g ' || '  WHERE i.cconcep = 4 '
         || '   AND i.cramo = s.cramo ' || '   AND i.cmodali = s.cmodali '
         || '   AND i.ctipseg = s.ctipseg ' || '   AND i.ccolect = s.ccolect '
         || '   AND i.cactivi = s.cactivi ' || '   AND i.cgarant is null '
         || '   AND s.sproduc = g.sproduc ' || '   AND d.cgarant = g.cgarant)),0) tasaimp, '
         || 'd.cgarant, ' || 'per.nnumide ' || '|| DECODE(per.tdigitoide, '
         || '   NULL, NULL, ' || '   ''-'' || per.tdigitoide) nnumidease, '
         || 'p.tnombre1 || '' '' || p.tnombre2 tnombre, '
         || 'p.tapelli1 || '' '' || p.tapelli2 tapelli, '
         || 'p2.tnombre1 || '' '' || p2.tnombre2 tnombreage, '
         || 'p2.tapelli1 || '' '' || p2.tapelli2 tapelliage, ' || 'per2.nnumide '
         || '|| DECODE(per2.tdigitoide, ' || '   NULL, NULL, '
         || '   ''-'' || per2.tdigitoide) nnumideage, '
         || 'p3.tnombre1 || '' '' || p3.tnombre2 tnombrecontra, '
         || 'p3.tapelli1 || '' '' || p3.tapelli2 tapellicontra, ' || 'per3.nnumide '
         || '|| DECODE(per3.tdigitoide, ' || '   NULL, NULL, '
         || '   ''-'' || per3.tdigitoide) nnumidecontra, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* (DECODE(d.cconcep, '
         || '  0, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, '
         || '  0)+DECODE(d.cconcep, '
         || '  8, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0)) monto, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* (DECODE(d.cconcep, '
         || '  0, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0)+ '
         || '  DECODE(d.cconcep, ' || '  8, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, '
         || '  0)) montomo, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || '* (DECODE(d.cconcep, ' || '  0, DECODE(m.cestrec, '
         || '0, NVL(d.iconcep_monpol, d.iconcep), ' || 'NVL(-d.iconcep_monpol, -d.iconcep)), '
         || '  0)+ DECODE(d.cconcep, ' || '  8, DECODE(m.cestrec, '
         || '0, NVL(d.iconcep_monpol, d.iconcep), ' || 'NVL(-d.iconcep_monpol, -d.iconcep)), '
         || '  0)) montorea, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || '* DECODE(d.cconcep, ' || '  4, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, '
         || '  0) iva, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  4, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) ivamo, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  11, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0) comisc, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  11, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) comiscmo, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  17, DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '  0) comisp, '
         || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
         || '  17, DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '  0) comispmo, '
         || 'DECODE(d.cconcep, ' || '47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comisrecaudo, '
         || 'DECODE(d.cconcep, ' || '47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comisrecaudomo, '
         || 'DECODE(d.cconcep, ' || '48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comiscanal, '
         || 'DECODE(d.cconcep, ' || '48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comiscanalmo, '
         || 'DECODE(d.cconcep, ' || '49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol, ' || '0) comisacpref, '
         || 'DECODE(d.cconcep, ' || '49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
         || ' * DECODE(m.cestrec, 0, 1, -1) * d.iconcep, ' || '0) comisacprefmo, '
         || 'DECODE(d.cconcep, 11, 1, 0) numcomiscorredor, ' || 'DECODE(d.cconcep, '
         || '11, NVL((SELECT pcomisi ' || 'FROM comisiongar g1 '
         || '   WHERE g1.sproduc = s.sproduc ' || 'AND g1.cgarant = d.cgarant '
         || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) ' || 'AND g1.ccomisi = a.ccomisi '
         || 'AND g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
         || 'AND g1.finivig = ' || '(SELECT MAX(g11.finivig) ' || 'FROM comisiongar g11 '
         || ' WHERE g11.ccomisi = g1.ccomisi ' || ' AND g11.cgarant = g1.cgarant '
         || ' AND g11.cmodcom = g1.cmodcom ' || ' AND g11.cactivi = g1.cactivi '
         || ' AND g11.sproduc = g1.sproduc ' || ' AND g11.finivig <= s.fefecto)), ' || ' 0), '
         || '0) pcomiscorredor, ' || 'DECODE(d.cconcep, 17, 1, 0) numcomisparner, '
         || 'DECODE(d.cconcep, ' || '17, NVL((SELECT pcomisi ' || 'FROM comisiongar g1 '
         || '   WHERE g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
         || 'AND g1.cgarant = d.cgarant ' || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) '
         || 'AND g1.ccomisi = z.ccomisi_indirect ' || 'AND g1.sproduc = s.sproduc '
         || 'AND g1.finivig = ' || '(SELECT MAX(g11.finivig) ' || 'FROM comisiongar g11 '
         || ' WHERE g11.ccomisi = g1.ccomisi ' || ' AND g11.cgarant = g1.cgarant '
         || ' AND g11.cmodcom = g1.cmodcom ' || ' AND g11.cactivi = g1.cactivi '
         || ' AND g11.sproduc = g1.sproduc ' || ' AND g11.finivig <= s.fefecto)), ' || ' 0), '
         || '0) pcomispartner, ' || 'ac.ctipint, ' || 'xp.cvalpar Ramofecu '
         || '  FROM seguros s, detrecibos d, movrecibo m, recibos r, per_detper p, per_detper p2, '
         || 'per_personas per, riesgos ri, movseguro mv, agentes a, agentes z,garanpro gp, pargaranpro xp, '
         || 'per_personas per2, agentes_comp ac, tomadores t, per_personas per3, per_detper p3 '
         || ' WHERE r.ctiprec IN(0, 1, 3, 9)  AND ('||v_subtiprec_err||' =0 OR ('||v_subtiprec_err||'=1 AND NVL(r.csubtiprec,-1) <> 21)) '
         || 'AND z.cagente = pac_redcomercial.f_busca_padre(s.cempres, s.cagente, '
         || '  NULL, f_sysdate) ' || 'AND s.cagente = a.cagente '
         || 'AND ri.sseguro = s.sseguro ' || 'AND mv.sseguro = s.sseguro '
         || 'AND mv.nmovimi = r.nmovimi ' || 'AND ri.sperson = p.sperson '
         || 'AND ri.nriesgo = d.nriesgo ' || 'AND ri.sperson = per.sperson '
         || 'AND a.sperson = per2.sperson ' || 'AND a.sperson = p2.sperson '
         || 'AND s.sseguro = r.sseguro ' || 'AND r.nrecibo = d.nrecibo '
         || 'AND r.nrecibo = m.nrecibo ' || 'AND d.cconcep IN(0, 8, 4, 11, 17, 47, 48, 49) '
         || 'AND d.nrecibo = m.nrecibo ' || 'AND s.cempres = 21 '
         || 'AND TRUNC(m.fmovdia) BETWEEN TO_DATE(''' || v_ini || ''', ''ddmmyyyy'') '
         || 'AND TO_DATE(''' || v_fin || ''', ''ddmmyyyy'') ' || 'AND m.cestrec IN(2) '
         || 'AND m.cestant = 0 ' || 'AND s.cmodali = gp.cmodali '
         || 'AND s.ccolect = gp.ccolect ' || 'AND s.cramo =  gp.cramo  '
         || 'AND s.ctipseg = gp.ctipseg ' || 'AND s.cactivi = gp.cactivi '
         || 'AND ctipgar = 2 ' || 'AND xp.cpargar = ''RAMOFECU'' '
         || 'AND xp.cgarant = gp.cgarant ' || 'AND xp.sproduc = s.sproduc '
         || 'AND s.cramo = xp.cramo ' || 'AND s.cmodali = xp.cmodali '
         || 'AND s.ctipseg = xp.ctipseg ' || 'AND s.ccolect = xp.ccolect '
         || 'AND ac.cagente = a.cagente '
         || 'AND t.sseguro = (select sseguro from seguros where npoliza = s.npoliza and ncertif = 0) '
         || 'AND t.sperson = per3.sperson ' || 'AND t.sperson = p3.sperson '
         || 'ORDER BY s.npoliza, d.cgarant) a '
         || ' GROUP BY a.tnombre, a.tapelli, a.tnombreage, a.tapelliage, a.tnombrecontra, a.tapellicontra,  a.nnumidease, a.nnumideage, a.nnumidecontra, a.td, a.sseguro, a.npoliza, '
         || '   a.ncertif, a.nmovimi, a.fefecto, a.fefrec, a.fcaranu, a.nrecibo, a.Ramofecu) b ';
      v_ntraza := 130;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END;

   /******************************************************************************************
     Descripció: f_722_cab Cabecera del map 722
     return:     texto cabecera
     -- bug 0025887 jmf 29-05-2013
   ******************************************************************************************/
   FUNCTION f_722_cab
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_722_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      v_ttexto :=
         'SELECT
                f_axis_literales(9902917 ,x.idi) || '';'' ||
                f_axis_literales(9905621 ,x.idi) || '';'' ||
                f_axis_literales(9905622 ,x.idi) || '';'' ||
                f_axis_literales(9905176 ,x.idi) || '';'' ||
                f_axis_literales(9905177 ,x.idi) || '';'' ||
                f_axis_literales(100784  ,x.idi) || '';'' ||
                f_axis_literales(9905562 ,x.idi) || '';'' || /* nombre_ramo */
                f_axis_literales(9905178 ,x.idi) || '';'' ||
                f_axis_literales(9905179 ,x.idi) || '';'' ||
                f_axis_literales(9905180 ,x.idi) || '';'' ||
                f_axis_literales(9905181 ,x.idi) || '';'' ||
                f_axis_literales(9905182 ,x.idi) || '';'' || /* subramo_keira */
                f_axis_literales(110278  ,x.idi) || '';'' ||
                f_axis_literales(9001909 ,x.idi) || '';'' ||
                f_axis_literales(9001326 ,x.idi) || '';'' ||
                f_axis_literales(9902929 ,x.idi) || '';'' ||
                f_axis_literales(101573  ,x.idi) || '';'' ||
                f_axis_literales(9905184 ,x.idi) || '';'' ||
                f_axis_literales(108645  ,x.idi) || '';'' ||
                f_axis_literales(9905185 ,x.idi) || '';'' || /* tipo_cambio */
                f_axis_literales(9000939 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* importe_bruto_mo */
                f_axis_literales(9905187 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* Importe cedido a Treaty M.O.*/
                f_axis_literales(9905188 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* Importe cedido a reasegurador externo M.O. */
                f_axis_literales(9000939 ,x.idi) || '';'' || /* importe_bruto */
                f_axis_literales(9905187 ,x.idi) || '';'' || /* Importe cedido a Treaty */
                f_axis_literales(9905188 ,x.idi) || '';'' || /* Importe cedido a reasegurador externo */
                f_axis_literales(9905192 ,x.idi) || '';'' ||
                f_axis_literales(9905193 ,x.idi) || '';'' ||
                f_axis_literales(9905194 ,x.idi) || '';'' ||
                f_axis_literales(9905195 ,x.idi) || '';'' ||
                f_axis_literales(9905196 ,x.idi) || '';'' ||
                f_axis_literales(9905197 ,x.idi) || '';'' ||
                f_axis_literales(9905198 ,x.idi) || '';'' ||
                f_axis_literales(9905199 ,x.idi) || '';'' ||
                f_axis_literales(9905200 ,x.idi) || '';'' ||
                f_axis_literales(9905201 ,x.idi) || '';'' ||
                f_axis_literales(9905202 ,x.idi) || '';'' ||
                f_axis_literales(9905203 ,x.idi) || '';'' ||
                f_axis_literales(9903362 ,x.idi) || '';'' ||
                f_axis_literales(101040 ,x.idi)  || '';'' ||
                f_axis_literales(9905204 ,x.idi) || '';'' ||
                f_axis_literales(9905625 ,x.idi) || '';'' || /* total_cobertura */
                f_axis_literales(9905206 ,x.idi) || '';'' ||
                f_axis_literales(9901176 ,x.idi) || '';'' ||
                '' '' linea
                FROM (SELECT NVL(f_usu_idioma, 1) idi FROM DUAL) x, DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END;

   -- bug 0025887 jmf 29-05-2013
   FUNCTION f_722_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_722_DET';
      v_tparam       VARCHAR2(1000)
                            := 'fecha_desde=' || fecha_desde || ' fecha_hasta=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(200);
      v_fin          VARCHAR2(200);
      v_idi          NUMBER;
      v_mondes       VARCHAR2(50);
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;

      SELECT MAX(nvalpar)
        INTO v_idi
        FROM parinstalacion
       WHERE cparame = 'IDIOMARTF';

      v_ntraza := 110;
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      -- Moneda destino del cambio
      v_ntraza := 120;
      v_mondes := pac_monedas.f_cmoneda_t(pac_parametros.f_parempresa_n(v_emp, 'MONEDACONTAB'));

      -- Calcular las fechas : La fecha hasta debe ajustarse al cierre anterior.
      DECLARE
         d_calini       DATE;
         d_calfin       DATE;
      BEGIN
         v_ntraza := 130;
         d_calini := TO_DATE(LPAD(fecha_desde, 8, '0'), 'ddmmyyyy');
         v_ntraza := 140;
         d_calfin := TO_DATE(LPAD(fecha_hasta, 8, '0'), 'ddmmyyyy');
         v_ntraza := 150;

         SELECT MAX(fcierre)
           INTO d_calfin
           FROM cierres
          WHERE cempres = v_emp
            AND ctipo = 2
            AND cestado = 1
            AND fcierre <= d_calfin;

         IF d_calini > d_calfin THEN
            v_ntraza := 160;
            d_calini := ADD_MONTHS(d_calfin, -1);
         END IF;

         v_ntraza := 170;
         v_ini := 'to_date(' || CHR(39) || TO_CHAR(d_calini, 'ddmmyyyy') || CHR(39)
                  || ',''ddmmyyyy'')';
         v_ntraza := 180;
         v_fin := 'to_date(' || CHR(39) || TO_CHAR(d_calfin, 'ddmmyyyy') || CHR(39)
                  || ',''ddmmyyyy'')';
      END;

      v_ntraza := 200;
      v_ttexto :=
         'SELECT' || ' si.ccompani' || v_sep || ' si.nsinies' || v_sep || ' se.NPOLIZA'
         || v_sep || ' se.NCERTIF' || v_sep
         || ' PAC_INFORMES_152.f_GET_RUT_INTERME(si.cagente)' || v_sep   -- rut_intermediario
         || ' se.cramo ' || v_sep || ' FF_DESRAMO(se.cramo,' || v_idi || ')'
         || v_sep   -- nombre ramo
                 || ' PAC_INFORMES_152.f_get_cober_afect(pg.cgarant,' || v_idi || ') ' || v_sep
         || ' se.sproduc ' || v_sep || ' PAC_INFORMES_152.f_get_linea_negocio(se.sseguro,'
         || v_idi || ') ' || v_sep
         || ' PAC_INFORMES_152.f_get_desramokeira(se.sproduc, se.cactivi, pg.cgarant, '
         || v_idi || ') ' || v_sep
         || ' PAC_INFORMES_152.f_get_dessubramokeira(se.sproduc, se.cactivi, pg.cgarant, '
         || v_idi || ') ' || v_sep || ' si.fsinies ' || v_sep || ' p.sidepag  ' || v_sep
         || ' ff_desvalorfijo(3, ' || v_idi || ', m.cestpag) ' || v_sep
         || ' '' ''||to_char(m.fcontab,''mm/yyyy'')' || v_sep || ' p.FORDPAG ' || v_sep
         || ' CASE WHEN si.cevento IS NOT NULL THEN 1 ELSE 0 END ' || v_sep || ' p.cmonres '
         || v_sep || ' pac_eco_tipocambio.f_cambio(p.cmonres,' || CHR(39) || v_mondes
         || CHR(39) || ',p.fcambio)' || v_sep   -- witasa_pag
         || ' decode(m.cestpag,8,-1,1)*p.ISINRET ' || v_sep
         || ' PAC_INFORMES_152.f_get_cedido_treaty ' || v_sep
         || ' PAC_INFORMES_152.f_get_cesiones(si.nsinies, ' || v_ini || ',' || v_fin || ')'
         || v_sep || ' decode(m.cestpag,8,-1,1)*p.ISINRETPAG ' || v_sep
         || ' PAC_INFORMES_152.f_get_cedido_treaty_pesos ' || v_sep
         || ' PAC_INFORMES_152.f_get_cesiones_pesos(si.nsinies,' || v_ini || ', ' || v_fin
         || ') ' || v_sep
         || ' decode(rank() OVER (PARTITION BY si.nsinies ORDER BY nvl(pg.cgarant, 0) DESC), 1, 1, 0) '
         || v_sep || ' PAC_INFORMES_152.f_get_nombre_corredor(si.cagente) ' || v_sep
         || ' si.cevento ' || v_sep || ' PAC_INFORMES_152.f_get_desc_sini_weather(si.cevento,'
         || v_idi || ') ' || v_sep || ' si.fnotifi ' || v_sep
         || ' PAC_INFORMES_152.f_get_nom_affinity(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_tipo_negocio(se.sseguro) ' || v_sep || ' p.nfacref '
         || v_sep || ' PAC_INFORMES_152.f_get_rut_asegurado(se.sseguro, si.nriesgo) ' || v_sep
         || ' PAC_INFORMES_152.f_get_rut_contratante(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_nom_contratante(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_rut_benefi(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_nom_benefi(se.sseguro) ' || v_sep || ' si.ccausin '
         || v_sep || ' si.cmotsin ' || v_sep
         || ' PAC_INFORMES_152.f_get_total_cobertura(se.sseguro, si.nriesgo, pg.cgarant,'
         || v_fin || ') ' || v_sep || ' PAC_INFORMES_152.f_get_invalidez ' || v_sep
         || ' PAC_INFORMES_152.f_get_canal(se.sseguro)' || ' linea'
         || ' FROM sin_siniestro si, sin_tramita_pago p, sin_tramita_movpago m, seguros se, sin_tramita_pago_gar pg'
         || ' WHERE  to_date(m.fcontab) between ' || v_ini || ' and ' || v_fin
         || ' AND    p.nsinies = si.nsinies' || ' AND    m.sidepag = p.sidepag'
         || ' AND    se.sseguro = si.sseguro' || ' AND    pg.sidepag = p.sidepag'
         || ' AND    m.cestpag IN (2,8)' || ' AND    se.cempres = ' || v_emp;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END;

   FUNCTION f_get_rut_interme(pcagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_RUT_INTERME';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      -- No mostrar el tipo identificador.
      SELECT MAX(b.nnumide)
        INTO v_ttexto
        FROM agentes a, per_personas b
       WHERE a.cagente = pcagente
         AND b.sperson = a.sperson;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cober_afect(pcgarant IN NUMBER, pidioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_COBER_AFECT';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      SELECT MAX(g.trotgar)
        INTO v_ttexto
        FROM garangen g
       WHERE g.cidioma = v_idi
         AND g.cgarant = pcgarant;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_contador_casos
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_CONTADOR_CASOS';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_linea_negocio(psseguro IN NUMBER, pidioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(800) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_LINEA_NEGOCIO';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      SELECT MAX(REPLACE(r.trespue, CHR(39), CHR(39) || CHR(39)))
        INTO v_ttexto
        FROM pregunpolseg pr, respuestas r
       WHERE pr.cpregun = 414
         AND pr.cpregun = r.cpregun
         AND pr.crespue = r.crespue
         AND r.cidioma = v_idi
         AND pr.sseguro = psseguro;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   /* f_get_desramokeira = descripcion para listados */
   FUNCTION f_get_desramokeira(
      psproduc IN NUMBER,
      pcactivi IN NUMBER,
      pcgarant IN NUMBER,
      pidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_desramokeira';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
      v_cod          detparam.cvalpar%TYPE;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      IF pcgarant = 0 THEN
         RETURN v_ttexto;
      ELSE
         SELECT MAX(c.cvalpar)
           INTO v_cod
           FROM productos a, pargaranpro b, detparam c
          WHERE a.sproduc = psproduc
            AND b.cramo = a.cramo
            AND b.cmodali = a.cmodali
            AND b.ctipseg = a.ctipseg
            AND b.ccolect = a.ccolect
            AND b.cactivi = pcactivi
            AND b.cgarant = pcgarant
            AND b.cpargar = 'CLAKEIRARAMO'
            AND c.cparam = b.cpargar
            AND c.cvalpar = b.cvalpar;

         v_ttexto := ff_desvalorfijo(1134, v_idi, v_cod);
         RETURN v_ttexto;
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_desramokeira;

   /* f_get_dessubramokeira = descripcion para listados */
   FUNCTION f_get_dessubramokeira(
      psproduc IN NUMBER,
      pcactivi IN NUMBER,
      pcgarant IN NUMBER,
      pidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_dessubramokeira';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
      v_cod          detparam.cvalpar%TYPE;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      IF pcgarant = 0 THEN
         RETURN v_ttexto;
      ELSE
         SELECT MAX(c.tvalpar)
           INTO v_cod
           FROM productos a, pargaranpro b, detparam c
          WHERE a.sproduc = psproduc
            AND b.cramo = a.cramo
            AND b.cmodali = a.cmodali
            AND b.ctipseg = a.ctipseg
            AND b.ccolect = a.ccolect
            AND b.cactivi = pcactivi
            AND b.cgarant = pcgarant
            AND b.cpargar = 'SUBCLAKEIRA'
            AND c.cparam = b.cpargar
            AND c.cvalpar = b.cvalpar;

         v_ttexto := ff_desvalorfijo(1135, v_idi, v_cod);
         RETURN v_ttexto;
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_dessubramokeira;

   /* f_get_ramo_keira = descripcion para contabilidad */
   FUNCTION f_get_ramo_keira(
      psproduc IN NUMBER,
      pcactivi IN NUMBER,
      pcgarant IN NUMBER,
      pidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_RAMO_KEIRA';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      IF pcgarant = 0 THEN
         RETURN v_ttexto;
      ELSE
         SELECT MAX(c.tvalpar)
           INTO v_ttexto
           FROM productos a, pargaranpro b, detparam c
          WHERE a.sproduc = psproduc
            AND b.cramo = a.cramo
            AND b.cmodali = a.cmodali
            AND b.ctipseg = a.ctipseg
            AND b.ccolect = a.ccolect
            AND b.cactivi = pcactivi
            AND b.cgarant = pcgarant
            AND b.cpargar = 'CLAKEIRARAMO'
            AND c.cparam = b.cpargar
            AND c.cidioma = v_idi
            AND c.cvalpar = b.cvalpar;

         RETURN v_ttexto;
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   /* f_get_subramo_keira = descripcion para contabilidad */
   FUNCTION f_get_subramo_keira(
      psproduc IN NUMBER,
      pcactivi IN NUMBER,
      pcgarant IN NUMBER,
      pidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_SUBRAMO_KEIRA';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      IF pcgarant = 0 THEN
         RETURN v_ttexto;
      ELSE
         SELECT MAX(c.tvalpar)
           INTO v_ttexto
           FROM productos a, pargaranpro b, detparam c
          WHERE a.sproduc = psproduc
            AND b.cramo = a.cramo
            AND b.cmodali = a.cmodali
            AND b.ctipseg = a.ctipseg
            AND b.ccolect = a.ccolect
            AND b.cactivi = pcactivi
            AND b.cgarant = pcgarant
            AND b.cpargar = 'SUBCLAKEIRA'
            AND c.cparam = b.cpargar
            AND c.cidioma = pidioma
            AND c.cvalpar = b.cvalpar;

         RETURN v_ttexto;
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_nombre_corredor(pcagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_NOMBRE_CORREDOR';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT MAX(REPLACE(pd.tnombre || ' ' || pd.tapelli1 || ' ' || pd.tapelli2, CHR(39),
                         CHR(39) || CHR(39)))
        INTO v_ttexto
        FROM agentes a, per_detper pd
       WHERE a.cagente = pcagente
         AND pd.sperson = a.sperson
         AND pd.fmovimi = (SELECT MAX(p1.fmovimi)
                             FROM per_detper p1
                            WHERE p1.sperson = pd.sperson);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_desc_sini_weather(pcevento IN VARCHAR2, p_idioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_DESC_SINI_WEATHER';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF p_idioma IS NOT NULL THEN
         v_idi := p_idioma;
      ELSE
         v_idi := f_usu_idioma;

         IF v_idi IS NULL THEN
            SELECT MAX(nvalpar)
              INTO v_idi
              FROM parinstalacion
             WHERE cparame = 'IDIOMARTF';
         END IF;
      END IF;

      SELECT MAX(s.ttiteve)
        INTO v_ttexto
        FROM sin_desevento s
       WHERE s.cevento = pcevento
         AND s.cidioma = v_idi;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_nom_affinity(psseguro IN NUMBER, pidioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(800) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_NOM_AFFINITY';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      SELECT MAX(REPLACE(r.trespue, CHR(39), CHR(39) || CHR(39)))
        INTO v_ttexto
        FROM pregunpolseg pr, respuestas r
       WHERE pr.cpregun = 423
         AND pr.cpregun = r.cpregun
         AND pr.crespue = r.crespue
         AND r.cidioma = v_idi
         AND pr.sseguro = psseguro;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- Bug 0026430 - 20/09/2013 - JMF
   FUNCTION f_get_tipo_negocio(psseguro IN NUMBER, pidioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_TIPO_NEGOCIO';
      v_tparam       VARCHAR2(1000) := 's=' || psseguro || ' i=' || pidioma;
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      v_ntraza := 1;

      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      v_ntraza := 2;

      SELECT MAX(REPLACE(r.trespue, CHR(39), CHR(39) || CHR(39)))
        INTO v_ttexto
        FROM pregunpolseg pr, respuestas r
       WHERE pr.cpregun = 415
         AND pr.cpregun = r.cpregun
         AND pr.crespue = r.crespue
         AND r.cidioma = v_idi
         AND pr.sseguro = psseguro;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_rut_asegurado(psseguro IN NUMBER, pnriesgo IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(200) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_RUT_aSEGURADO';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT MAX(pac_informes_152.f_rut(a.sperson))
        INTO v_ttexto
        FROM asegurados a
       WHERE a.sseguro = psseguro
         AND a.nriesgo = pnriesgo
         AND a.norden = (SELECT MIN(b.norden)
                           FROM asegurados b
                          WHERE b.sseguro = psseguro
                            AND b.nriesgo = pnriesgo);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_rut_contratante(psseguro IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_RUT_CONTRATANTE';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT MAX(pac_informes_152.f_rut(a.sperson))
        INTO v_ttexto
        FROM tomadores a
       WHERE a.sseguro = psseguro
         AND a.nordtom = (SELECT MIN(b.nordtom)
                            FROM tomadores b
                           WHERE b.sseguro = psseguro);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_nom_contratante(psseguro IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(800) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_NOM_CONTRATANTE';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT MAX(REPLACE(pd.tnombre || ' ' || pd.tapelli1 || ' ' || pd.tapelli2, CHR(39),
                         CHR(39) || CHR(39)))
        INTO v_ttexto
        FROM tomadores a, per_detper pd
       WHERE a.sseguro = psseguro
         AND a.nordtom = (SELECT MIN(b.nordtom)
                            FROM tomadores b
                           WHERE b.sseguro = psseguro)
         AND pd.sperson = a.sperson
         AND pd.fmovimi = (SELECT MAX(p1.fmovimi)
                             FROM per_detper p1
                            WHERE p1.sperson = pd.sperson);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_rut_benefi(psseguro IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_RUT_BENEFI';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT MAX(pac_informes_152.f_rut(b.sperson))
        INTO v_ttexto
        FROM beneficiarios b
       WHERE b.sseguro = psseguro
         AND ROWNUM = 1;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_nom_benefi(psseguro IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_NOM_BENEFI';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sperson      per_personas.sperson%TYPE;
   BEGIN
      SELECT MAX(b.sperson)
        INTO v_sperson
        FROM beneficiarios b
       WHERE b.sseguro = psseguro
         AND ROWNUM = 1;

      IF v_sperson IS NULL THEN
         v_ttexto := NULL;
      ELSE
         SELECT MAX(REPLACE(pd.tnombre || ' ' || pd.tapelli1 || ' ' || pd.tapelli2, CHR(39),
                            CHR(39) || CHR(39)))
           INTO v_ttexto
           FROM per_detper pd
          WHERE pd.sperson = v_sperson
            AND pd.fmovimi = (SELECT MAX(p1.fmovimi)
                                FROM per_detper p1
                               WHERE p1.sperson = v_sperson);
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_total_cobertura(
      psseguro IN NUMBER,
      pnriesgo IN NUMBER,
      pcgarant IN NUMBER,
      pfdesde IN DATE)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_TOTAL_COBERTURA';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      IF pcgarant IS NULL THEN
         v_ttexto := '0';
      ELSE
         SELECT SUM(icapital)
           INTO v_ttexto
           FROM garanseg g
          WHERE (sseguro, nriesgo) IN(SELECT sseguro, norden
                                        FROM asegurados r
                                       WHERE r.sperson =
                                                (SELECT sperson
                                                   FROM asegurados
                                                  WHERE sseguro = psseguro
                                                    AND norden = pnriesgo))
            AND cgarant = pcgarant
            AND nmovimi = (SELECT MAX(nmovimi)
                             FROM garanseg g1
                            WHERE g1.sseguro = psseguro
                              AND g1.nriesgo = pnriesgo
                              AND cgarant = pcgarant)
            AND f_vigente(sseguro, NULL, pfdesde) = 0;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_invalidez
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_INVALIDEZ';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_canal(psseguro IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_CANAL';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      BEGIN
         SELECT 'AFFINITY'
           INTO v_ttexto
           FROM pregunpolseg pr, respuestas r
          WHERE pr.cpregun = 423
            AND pr.cpregun = r.cpregun
            AND pr.crespue = r.crespue
            AND r.cidioma = f_usu_idioma
            AND pr.sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND THEN
            v_ttexto := 'TRADICIONAL';
      END;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cesiones(pnsinies IN VARCHAR2, pfdesde IN DATE, pfhasta IN DATE)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_cesiones';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      vsum           NUMBER := 0;
      vtotal         NUMBER := 0;
   BEGIN
      DECLARE
         CURSOR c1 IS
            SELECT c.fperfin, c.cestado
              FROM cierres c
             WHERE c.fperini >= pfdesde
               AND c.fperfin <= pfhasta
               AND c.ctipo = 4;
      BEGIN
         FOR f1 IN c1 LOOP
            IF f1.cestado = 22 THEN
               SELECT SUM(icesion)
                 INTO vsum
                 FROM reaseguroaux
                WHERE nsinies = pnsinies
                  AND fcierre = f1.fperfin
                  AND cgenera = 2;

               vtotal := vtotal + vsum;
            END IF;
         END LOOP;
      END;

      SELECT SUM(icesion)
        INTO vsum
        FROM reaseguro
       WHERE nsinies = pnsinies
         AND fcierre BETWEEN pfdesde AND pfhasta
         AND cgenera = 2;

      vtotal := vtotal + vsum;
      v_ttexto := vtotal;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cedido_treaty
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_cedido_treaty';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cedido_treaty_pesos
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_cedido_treaty_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cesiones_pesos(pnsinies IN VARCHAR2, pfdesde IN DATE, pfhasta IN DATE)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_cesiones_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      vsum           NUMBER := 0;
      vtotal         NUMBER := 0;
   BEGIN
      SELECT SUM(icesion_moncon)
        INTO vsum
        FROM reaseguro
       WHERE nsinies = pnsinies
         AND fcierre BETWEEN pfdesde AND pfhasta
         AND cgenera = 2;

      vtotal := vtotal + vsum;
      v_ttexto := vtotal;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_723_cab
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_723_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      v_ttexto :=
         'SELECT
                f_axis_literales(9902917 ,x.idi) || '';'' ||
                f_axis_literales(9905621 ,x.idi) || '';'' || /* Número de siniestro */
                f_axis_literales(9905622 ,x.idi) || '';'' || /* Número de Póliza */
                f_axis_literales(9905176 ,x.idi) || '';'' ||
                f_axis_literales(9905177 ,x.idi) || '';'' ||
                f_axis_literales(100784  ,x.idi) || '';'' || /* Ramo */
                f_axis_literales(9905562 ,x.idi) || '';'' || /* Ramo_Reserva */
                f_axis_literales(9905178 ,x.idi) || '';'' ||
                f_axis_literales(9905179 ,x.idi) || '';'' ||
                f_axis_literales(9905180 ,x.idi) || '';'' ||
                f_axis_literales(9905181 ,x.idi) || '';'' ||
                f_axis_literales(9905182 ,x.idi) || '';'' || /* subramo_keira */
                f_axis_literales(110278  ,x.idi) || '';'' ||
                f_axis_literales(9905227 ,x.idi) || '';'' ||
                f_axis_literales(9905184 ,x.idi) || '';'' ||
                f_axis_literales(108645  ,x.idi) || '';'' || /* Moneda */
                f_axis_literales(9905185 ,x.idi) || '';'' || /* Tipo_cambio */
                f_axis_literales(9000939 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* importe_bruto_mo */
                f_axis_literales(9905187 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* Importe cedido a Treaty M.O.*/
                f_axis_literales(9905188 ,x.idi) || '' '' || f_axis_literales(9905603 ,x.idi) || '';'' || /* Importe cedido a reasegurador externo M.O. */
                f_axis_literales(9000939 ,x.idi) || '';'' || /* importe_bruto */
                f_axis_literales(9905187 ,x.idi) || '';'' || /* Importe cedido a Treaty */
                f_axis_literales(9905188 ,x.idi) || '';'' || /* Importe cedido a reasegurador externo */
                f_axis_literales(9905192 ,x.idi) || '';'' || /* Contador_casos */
                f_axis_literales(9905193 ,x.idi) || '';'' ||
                f_axis_literales(9905194 ,x.idi) || '';'' ||
                f_axis_literales(9905195 ,x.idi) || '';'' ||
                f_axis_literales(9905196 ,x.idi) || '';'' ||
                f_axis_literales(9905197 ,x.idi) || '';'' ||
                f_axis_literales(9905198 ,x.idi) || '';'' ||
                f_axis_literales(9905199 ,x.idi) || '';'' ||
                f_axis_literales(9905200 ,x.idi) || '';'' ||
                f_axis_literales(9905201 ,x.idi) || '';'' ||
                f_axis_literales(9905202 ,x.idi) || '';'' ||
                f_axis_literales(9905203 ,x.idi) || '';'' ||
                f_axis_literales(9903362 ,x.idi) || '';'' ||
                f_axis_literales(101040  ,x.idi) || '';'' || /* Causa */
                f_axis_literales(9905204 ,x.idi) || '';'' || /* Subcausa */
                f_axis_literales(9905625 ,x.idi) || '';'' || /* Total_Cobertura */
                f_axis_literales(9905206 ,x.idi) || '';'' ||
                f_axis_literales(9901176 ,x.idi) || '';'' ||
                f_axis_literales(112259 ,x.idi)  || '';'' ||
                '' '' linea
                FROM (SELECT NVL(f_usu_idioma, 1) idi FROM DUAL) x, DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END;

   FUNCTION f_723_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_723_DET';
      v_tparam       VARCHAR2(1000)
                            := 'fecha_desde=' || fecha_desde || ' fecha_hasta=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_mondes       VARCHAR2(50);
      --v_emp          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;

      SELECT MAX(nvalpar)
        INTO v_idi
        FROM parinstalacion
       WHERE cparame = 'IDIOMARTF';

      v_ntraza := 110;

      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));

      -- Calcular las fechas : La fecha hasta debe ajustarse al cierre anterior.
      DECLARE
         d_calini       DATE;
         d_calfin       DATE;
      BEGIN
         v_ntraza := 130;
         d_calini := TO_DATE(LPAD(fecha_desde, 8, '0'), 'ddmmyyyy');
         v_ntraza := 140;
         d_calfin := TO_DATE(LPAD(fecha_hasta, 8, '0'), 'ddmmyyyy');
         v_ntraza := 150;

         SELECT MAX(fcierre)
           INTO d_calfin
           FROM cierres
          WHERE cempres = v_emp
            AND ctipo = 2
            AND cestado = 1
            AND fcierre <= d_calfin;

         IF d_calini > d_calfin THEN
            v_ntraza := 160;
            d_calini := ADD_MONTHS(d_calfin, -1);
         END IF;

         v_ntraza := 170;
         v_ini := 'to_date(' || CHR(39) || TO_CHAR(d_calini, 'ddmmyyyy') || CHR(39)
                  || ',''ddmmyyyy'')';
         v_ntraza := 180;
         v_fin := 'to_date(' || CHR(39) || TO_CHAR(d_calfin, 'ddmmyyyy') || CHR(39)
                  || ',''ddmmyyyy'')';
      END;

      -- Moneda destino del cambio
      v_ntraza := 120;
      v_mondes := pac_monedas.f_cmoneda_t(pac_parametros.f_parempresa_n(v_emp, 'MONEDACONTAB'));
      v_ntraza := 200;
      v_ttexto :=
         'SELECT' || ' si.ccompani ' || v_sep || ' si.nsinies ' || v_sep || ' se.NPOLIZA '
         || v_sep || ' se.NCERTIF ' || v_sep
         || ' PAC_INFORMES_152.f_GET_RUT_INTERME(si.cagente)' || v_sep   -- rut_intermediario
         || ' se.cramo ' || v_sep || ' FF_DESRAMO(se.cramo,' || v_idi || ')'
         || v_sep   -- nombre ramo
                 || ' PAC_INFORMES_152.f_get_cober_afect_r(r.cgarant,' || v_idi || ') '
         || v_sep || ' se.sproduc ' || v_sep
         || ' PAC_INFORMES_152.f_get_linea_negocio(se.sseguro,' || v_idi || ') ' || v_sep
         || ' PAC_INFORMES_152.f_get_desramokeira(se.sproduc, se.cactivi, NVL(r.cgarant, 0),'
         || v_idi || ') ' || v_sep
         || ' PAC_INFORMES_152.f_get_dessubramokeira(se.sproduc,se.cactivi,NVL(r.cgarant, 0),'
         || v_idi || ') ' || v_sep || ' si.fsinies ' || v_sep
         || ' '' ''||to_char(r.fcontab,''mm/yyyy'') ' || v_sep
         || ' CASE WHEN si.cevento IS NOT NULL THEN 1 ELSE 0 END ' || v_sep || ' r.CMONRES '
         || v_sep || ' pac_eco_tipocambio.f_cambio(r.CMONRES,' || CHR(39) || v_mondes
         || CHR(39) || ',r.fcambio)' || v_sep   -- witasa_pag
                                             || ' r.ireserva ' || v_sep
         || ' PAC_INFORMES_152.f_get_cedido_treaty ' || v_sep
         || ' PAC_INFORMES_152.f_get_reserva_rea(si.nsinies,r.cgarant,' || v_ini || ','
         || v_fin || ')' || v_sep || ' r.ireserva_moncia ' || v_sep
         || ' PAC_INFORMES_152.f_get_cedido_treaty_pesos ' || v_sep
         || ' PAC_INFORMES_152.f_get_cesiones_pesos_r(si.nsinies,r.cgarant,' || v_ini || ','
         || v_fin || ')' || v_sep || ' 1' || v_sep   -- Contador casos
         || ' PAC_INFORMES_152.f_get_nombre_corredor(si.cagente) ' || v_sep || ' si.cevento '
         || v_sep || ' PAC_INFORMES_152.f_get_desc_sini_weather(si.cevento) ' || v_sep
         || ' si.fnotifi ' || v_sep || ' PAC_INFORMES_152.f_get_nom_affinity(se.sseguro) '
         || v_sep || ' PAC_INFORMES_152.f_get_tipo_negocio(se.sseguro) ' || v_sep || ' NULL '
         || v_sep || ' PAC_INFORMES_152.f_get_rut_asegurado(se.sseguro, si.nriesgo) ' || v_sep
         || ' PAC_INFORMES_152.f_get_rut_contratante(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_nom_contratante(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_rut_benefi(se.sseguro) ' || v_sep
         || ' PAC_INFORMES_152.f_get_nom_benefi(se.sseguro) ' || v_sep
         || ' (select max(tcausin) from sin_descausa where cidioma=' || v_idi
         || ' and ccausin=si.CCAUSIN)' || v_sep   -- causa
         || ' (select max(tmotsin) from sin_desmotcau where cidioma=' || v_idi
         || ' and ccausin=si.ccausin and cmotsin=si.CMOTSIN)' || v_sep   -- subcausa
         || ' PAC_INFORMES_152.f_get_total_cobertura(se.sseguro, si.nriesgo, r.cgarant,'
         || v_fin || ')' || v_sep || ' PAC_INFORMES_152.f_get_invalidez ' || v_sep
         || ' PAC_INFORMES_152.f_get_canal(se.sseguro) ' || v_sep || ' ff_desvalorfijo(6, '
         || v_idi || ', ms.cestsin) ' || ' linea'
         || ' FROM sin_siniestro si, sin_movsiniestro ms, seguros se, sin_tramita_reserva r'
         || ' WHERE (ms.nsinies, ms.nmovsin) in (select nsinies, max(nmovsin) from sin_movsiniestro group by nsinies)'
         || ' AND   ms.nsinies = si.nsinies' || ' AND   to_date(fmovres) between ' || v_ini
         || ' and ' || v_fin || ' AND   se.sseguro = si.sseguro' || ' and   r.IRESERVA <> 0'
         || ' AND   r.nsinies = si.nsinies' || ' AND se.cempres = ' || v_emp
         || ' AND   r.nmovres = (SELECT MAX(nmovres)' || '       FROM sin_tramita_reserva r1'
         || '       WHERE r1.nsinies = r.nsinies' || '       AND r1.ntramit = r.ntramit'
         || '       AND r1.ctipres = r.ctipres)';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_723_det;

   FUNCTION f_get_cober_afect_r(pcgarant IN NUMBER, pidioma IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_GET_COBER_AFECT_R';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_idi          NUMBER;
   BEGIN
      IF pidioma IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_idi := pidioma;
      END IF;

      IF pcgarant IS NULL THEN
         RETURN v_ttexto;
      ELSE
         SELECT g.trotgar
           INTO v_ttexto
           FROM garangen g
          WHERE g.cidioma = v_idi
            AND g.cgarant = pcgarant;

         RETURN v_ttexto;
      END IF;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_reserva_rea(
      pnsinies IN VARCHAR2,
      pcgarant IN NUMBER,
      pfdesde IN DATE,
      pfhasta IN DATE)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_reserva_rea';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(icompan), 0)
        INTO v_ttexto
        FROM liqresreaaux lq
       WHERE nsinies = pnsinies
         AND cgarant = pcgarant
         AND fcierre = (SELECT MAX(fcierre)
                          FROM liqresreaaux lq1
                         WHERE lq1.nsinies = lq.nsinies
                           AND lq1.cgarant = lq.cgarant
                           AND lq1.fcierre BETWEEN pfdesde AND pfhasta);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   FUNCTION f_get_cesiones_pesos_r(
      pnsinies IN VARCHAR2,
      pcgarant IN NUMBER,
      pfdesde IN DATE,
      pfhasta IN DATE)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_cesiones_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      vsum           NUMBER := 0;
      vtotal         NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(icompan_moncon), 0)
        INTO v_ttexto
        FROM liqresreaaux lq
       WHERE nsinies = pnsinies
         AND cgarant = pcgarant
         AND fcierre = (SELECT MAX(fcierre)
                          FROM liqresreaaux lq1
                         WHERE nsinies = lq1.nsinies
                           AND cgarant = lq1.cgarant
                           AND fcierre BETWEEN pfdesde AND pfhasta);

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END;

   -- Bug 26430/140998 - 09/04/2013 - AMC
   FUNCTION f_get_titulos_map710(pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(1000) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_cesiones_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := f_axis_literales(9905272, pcidioma) || ';'
                  || f_axis_literales(9905273, pcidioma);

      FOR cur IN (SELECT DISTINCT (cvalpar)
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || cur.cvalpar;
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_titulos_map710;

   -- Bug 26430/140998 - 09/04/2013 - AMC
   -- Bug 26430 - 14/06/2013 - JMF: pprod 1=nueva produccion, 0=renovaciones, vacio=totdos
   -- Bug 26430 - 14/01/2014 - JMF: pconcep puede ser 0, 11, 47, 4849=48 y 49.
   FUNCTION f_get_prima_directa(
      phasta IN DATE,
      pcidioma IN NUMBER,
      pprod IN NUMBER DEFAULT NULL,
      ptipint IN NUMBER DEFAULT NULL,
      pconcep IN NUMBER DEFAULT 0)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_directa';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
      vdirecta3      NUMBER := 0;
      -- Bug 26430 - 14/06/2013 - JMF
      d_ini          DATE;
      d_fin          DATE;
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(LAST_DAY(phasta), 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      IF pcidioma IS NOT NULL THEN
         v_idi := pcidioma;
      ELSE
         v_idi := f_usu_idioma;

         IF v_idi IS NULL THEN
            SELECT MAX(nvalpar)
              INTO v_idi
              FROM parinstalacion
             WHERE cparame = 'IDIOMARTF';
         END IF;
      END IF;

      -- bug 26430 - 31/10/2013 - JMF
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_tmoneda
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT SUM(linea)
           INTO vdirecta
           FROM (SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol) linea
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        pargaranpro xp,
                        monedas mon,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE xp.cpargar = 'RAMOFECU'
                    AND xp.cvalpar = cur.cvalpar
                    AND xp.cgarant = d.cgarant
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND s.cactivi = xp.cactivi
                    AND s.sproduc = xp.sproduc
                    AND p.sproduc = s.sproduc
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND d.nrecibo = r.nrecibo
                    AND cal.cagente = s.cagente
                    AND(ptipint IS NULL
                        OR cal.tipint = ptipint)
                    AND((pconcep = 4849
                         AND d.cconcep IN(48, 49))
                        OR d.cconcep = pconcep)
                    AND m.nrecibo = r.nrecibo
                    AND((m.cestant = 0
                         AND m.cestrec IN(0, 2))
                        OR((m.cestrec = 1
                            AND NOT EXISTS(SELECT 1
                                             FROM detmovrecibo d1
                                            WHERE d1.nrecibo = r.nrecibo))
                           OR(m.cestrec = 0
                              AND m.cestant = 1)))
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND m.fcontab BETWEEN d_ini AND d_fin
                    -- ini bug 26430 - 31/10/2013 - JMF
                    AND mon.cidioma = v_idi
                    AND mon.cmoneda = p.cdivisa
                 -- fin bug 26430 - 31/10/2013 - JMF
                 UNION ALL
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * pac_eco_tipocambio.f_importe_cambio(mon.cmonint,
                                                                  v_tmoneda, cc.fcambio,
                                                                  d.iconcep, 1)
                            * DECODE(m.cestrec, 1, 1, -1)) linea
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        pargaranpro xp,
                        ctacliente cc,
                        monedas mon,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE 1 = 1
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.cvalpar = cur.cvalpar
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND m.fmovdia BETWEEN d_ini AND d_fin
                    AND xp.cgarant = d.cgarant
                    AND xp.sproduc = s.sproduc
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND s.cactivi = xp.cactivi
                    AND s.sproduc = p.sproduc
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND s.sseguro = r.sseguro
                    AND r.nrecibo = d.nrecibo
                    AND m.nrecibo = r.nrecibo
                    AND((m.cestrec = 1)
                        OR(m.cestrec = 0
                           AND m.cestant = 1))
                    AND r.cestaux = 0
                    AND cal.cagente = s.cagente
                    AND(ptipint IS NULL
                        OR cal.tipint = ptipint)
                    AND((pconcep = 4849
                         AND d.cconcep IN(48, 49))
                        OR d.cconcep = pconcep)
                    AND d.nrecibo = m.nrecibo
                    AND NOT EXISTS(SELECT 1
                                     FROM detmovrecibo d1
                                    WHERE d1.nrecibo = r.nrecibo)
                    -- ini bug 26430 - 31/10/2013 - JMF
                    AND p.sproduc = s.sproduc
                    AND mon.cidioma = v_idi
                    AND mon.cmoneda = p.cdivisa
                    AND cc.nrecibo = m.nrecibo
                    AND cc.ffecmov = TRUNC(m.fmovdia)
                    AND cc.cmovimi IN(2, 5)
                 -- fin bug 26430 - 31/10/2013 - JMF
                 UNION ALL
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1) * dmp.iconcep_monpol) linea
                   FROM pargaranpro xp,
                        seguros s,
                        recibos r,
                        productos p,
                        movrecibo mr,
                        detmovrecibo_parcial dmp,
                        detmovrecibo dm,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE xp.cpargar = 'RAMOFECU'
                    AND xp.cvalpar = cur.cvalpar
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND s.cactivi = xp.cactivi
                    AND s.sproduc = xp.sproduc
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND p.sproduc = s.sproduc
                    AND mr.nrecibo = r.nrecibo
                    AND dm.fmovimi BETWEEN d_ini AND d_fin
                    AND dm.nrecibo = dmp.nrecibo
                    AND dm.norden = dmp.norden
                    AND dmp.smovrec = mr.smovrec
                    AND cal.cagente = s.cagente
                    AND(ptipint IS NULL
                        OR cal.tipint = ptipint)
                    AND((pconcep = 4849
                         AND dmp.cconcep IN(48, 49))
                        OR dmp.cconcep = pconcep)
                    AND dmp.cgarant = xp.cgarant
                 -- fin bug 26430 - 31/10/2013 - JMF
                 UNION ALL
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, -1, 1) * d.iconcep_monpol) linea
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        pargaranpro xp,
                        detmovrecibo dm,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE xp.cpargar = 'RAMOFECU'
                    AND xp.cvalpar = cur.cvalpar
                    AND xp.cgarant = d.cgarant
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND s.cactivi = xp.cactivi
                    AND s.sproduc = xp.sproduc
                    AND p.sproduc = s.sproduc
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND d.nrecibo = r.nrecibo
                    AND cal.cagente = s.cagente
                    AND(ptipint IS NULL
                        OR cal.tipint = ptipint)
                    AND((pconcep = 4849
                         AND d.cconcep IN(48, 49))
                        OR d.cconcep = pconcep)
                    AND m.nrecibo = r.nrecibo
                    AND(m.cestant = 0
                        AND m.cestrec IN(0))
                    AND dm.fmovimi BETWEEN d_ini AND d_fin
                    AND dm.norden = 1
                    AND dm.smovrec = m.smovrec
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                                                                -- ini bug 26430 - 31/10/2013 - JMF
                );

         v_ttexto := v_ttexto || NVL(vdirecta, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_directa;

   -- Bug 26430/140998 - 09/04/2013 - AMC
   -- Bug 26430 - 14/06/2013 - JMF: pprod 1=nueva produccion, 0=renovaciones, vacio=totdos
   FUNCTION f_get_linea_prima_cedida(
      phasta IN DATE,
      pcidioma IN NUMBER,
      pprod IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_cedida';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      -- BUG 26430 - FAL - 14/06/2013
      d_ini          DATE;
      d_fin          DATE;
      vcedida        NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
   -- FI BUG 26430
   BEGIN
      -- BUG 26430 - FAL - 14/06/2013
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(LAST_DAY(phasta), 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = v_emp   --16   -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      -- FI BUG 26430
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- BUG 26430 - FAL - 14/06/2013

         -- emision +2A
         -- cobro   -2A
         -- reaseguro +2B
         SELECT SUM(cedida)
           INTO vcedida
           FROM (
------------------------------------------------------------------
-- cuadroces emision y cobros
                 SELECT SUM
                           (NVL
                               (((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = pcidioma
                                                 AND cmoneda = pr.cdivisa),
                                             v_monedacontab, r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /*  + NVL((ce.icesion
                                                      * DECODE(tr.ctramo,
                                                               1, DECODE(SIGN((ce.icapces
                                                                               * tr.plocal / 100)
                                                                              - NVL(tr.imaxplo, 0)),
                                                                         -1,(cc.pcesion
                                                                             *(100
                                                                               -((tr.plocal
                                                                                  * tr.imaxplo)
                                                                                 /((ce.icapces
                                                                                    * tr.plocal)
                                                                                   / 100))))
                                                                          /(100 - tr.plocal),
                                                                         cc.pcesion),
                                                               cc.pcesion)
                                                      * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                  s.sseguro,
                                                                                  ce.cgarant,
                                                                                  cc.pctcomis,
                                                                                  r.femisio)
                                                      / 10000)
                                                     * rs.nfactor,
                                                     0),*/
                                             1))
                                 * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                 * DECODE(m.cestrec, 0, 1, -1)),
                                0)) cedida
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuadroces cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        movrecibo m,
                        reasegemi rs,
                        -- Bug 26430 - 28/10/2013 - JMF
                        detreasegemi drs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro xp
                  WHERE cc.ctramo = tr.ctramo
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.cgarant = ce.cgarant
                    AND xp.sproduc = s.sproduc
                    AND xp.cvalpar = cur.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND t.cidioma = pcidioma
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND m.nrecibo = r.nrecibo
                    AND cc.scontra = tr.scontra
                    AND cc.nversio = tr.nversio
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND m.nrecibo = rs.nrecibo
                    -- Bug 26430 - 28/10/2013 - JMF
                    AND rs.sreaemi = drs.sreaemi
                    AND drs.scesrea = ce.scesrea
                    AND drs.cgarant = ce.cgarant
                    AND(
                        -- emision +2A
                        (rs.cmotces = 1
                         AND(m.cestrec = 0
                             AND m.cestant = 0)
                         OR (m.cestrec = 0
                             AND m.cestant = 1)
                            AND NOT EXISTS(SELECT '1'
                                             FROM detmovrecibo dm
                                            WHERE dm.nrecibo = r.nrecibo))
                        OR
                          -- anulación -2A
                        (  (m.cestrec = 2
                            AND m.cestant = 0
                            AND rs.cmotces = 2)
                           -- cobro -2A
                           OR(m.cestrec = 1
                              AND rs.cmotces = 1
                              AND NOT EXISTS(SELECT '1'
                                               FROM detmovrecibo dm
                                              WHERE dm.nrecibo = r.nrecibo))))
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
                    -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = pcidioma
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
                    -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cactivi = s.cactivi
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND pg2.cgarant = ce.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = pcidioma
                    AND pg2.cvalpar = dp2.cvalpar
                    AND m.fmovdia BETWEEN d_ini AND d_fin
------------------------------------------------------------------
-- facultativo emision y cobros
                 UNION ALL
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = pcidioma
                                                 AND cmoneda = pr.cdivisa),
                                             v_monedacontab, r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /*   + NVL((ce.icesion
                                                       * DECODE(tr.ctramo,
                                                                1, DECODE(SIGN((ce.icapces
                                                                                * tr.plocal / 100)
                                                                               - NVL(tr.imaxplo, 0)),
                                                                          -1,(cc.pcesion
                                                                              *(100
                                                                                -((tr.plocal
                                                                                   * tr.imaxplo)
                                                                                  /((ce.icapces
                                                                                     * tr.plocal)
                                                                                    / 100))))
                                                                           /(100 - tr.plocal),
                                                                          cc.pcesion),
                                                                cc.pcesion)
                                                       * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                   s.sseguro,
                                                                                   ce.cgarant,
                                                                                   cc.pcomisi,
                                                                                   r.femisio)
                                                       / 10000)
                                                      * rs.nfactor,
                                                      0),*/
                                             1))
                                * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * DECODE(m.cestrec, 0, 1, -1),
                                0)) cedida
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuacesfac cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        movrecibo m,
                        reasegemi rs,
                        -- Bug 26430 - 28/10/2013 - JMF
                        detreasegemi drs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro xp
                  WHERE m.nrecibo = r.nrecibo
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.cgarant = ce.cgarant
                    AND xp.sproduc = s.sproduc
                    AND xp.cvalpar = cur.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND cc.sfacult = ce.sfacult
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND t.cidioma = pcidioma
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND m.nrecibo = rs.nrecibo
                    -- Bug 26430 - 28/10/2013 - JMF
                    AND rs.sreaemi = drs.sreaemi
                    AND drs.scesrea = ce.scesrea
                    AND drs.cgarant = ce.cgarant
                    AND(
                        -- emision +2A
                        (rs.cmotces = 1
                         AND(m.cestrec = 0
                             AND m.cestant = 0)
                         OR (m.cestrec = 0
                             AND m.cestant = 1)
                            AND NOT EXISTS(SELECT '1'
                                             FROM detmovrecibo dm
                                            WHERE dm.nrecibo = r.nrecibo))
                        OR
                          -- anulación -2A
                        (  (m.cestrec = 2
                            AND m.cestant = 0
                            AND rs.cmotces = 2)
                           -- cobro -2A
                           OR(m.cestrec = 1
                              AND rs.cmotces = 1
                              AND NOT EXISTS(SELECT '1'
                                               FROM detmovrecibo dm
                                              WHERE dm.nrecibo = r.nrecibo))))
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
                    -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = pcidioma
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
                    -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = pcidioma
                    AND pg2.cvalpar = dp2.cvalpar
                    AND m.fmovdia BETWEEN d_ini AND d_fin
                 UNION ALL
------------------------------------------------------------------
-- parcial emision y cobros
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = pcidioma
                                                 AND cmoneda = pr.cdivisa),
                                             v_monedacontab, r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /*     + NVL((ce.icesion
                                                         * DECODE(tr.ctramo,
                                                                  1, DECODE(SIGN((ce.icapces
                                                                                  * tr.plocal / 100)
                                                                                 - NVL(tr.imaxplo, 0)),
                                                                            -1,(cc.pcesion
                                                                                *(100
                                                                                  -((tr.plocal
                                                                                     * tr.imaxplo)
                                                                                    /((ce.icapces
                                                                                       * tr.plocal)
                                                                                      / 100))))
                                                                             /(100 - tr.plocal),
                                                                            cc.pcesion),
                                                                  cc.pcesion)
                                                         * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                     s.sseguro,
                                                                                     ce.cgarant,
                                                                                     cc.pctcomis,
                                                                                     r.femisio)
                                                         / 10000)
                                                        * rs.nfactor,
                                                        0),*/
                                             1))
                                *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                                0)) cedida
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuadroces cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        detmovrecibo dv,
                        reasegemi rs,
                        -- Bug 26430 - 28/10/2013 - JMF
                        detreasegemi drs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro xp
                  WHERE dv.nrecibo = r.nrecibo
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.cgarant = ce.cgarant
                    AND xp.sproduc = s.sproduc
                    AND xp.cvalpar = cur.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND dv.norden = 1
                    AND cc.ctramo = tr.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND t.cidioma = pcidioma
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND dv.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    -- Bug 26430 - 28/10/2013 - JMF
                    AND rs.sreaemi = drs.sreaemi
                    AND drs.scesrea = ce.scesrea
                    AND drs.cgarant = ce.cgarant
                    --
                    AND cc.scontra = tr.scontra
                    AND cc.nversio = tr.nversio
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = pcidioma
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = pcidioma
                    AND pg2.cvalpar = dp2.cvalpar
                    AND dv.fmovimi BETWEEN d_ini AND d_fin
                 UNION ALL
------------------------------------------------------------------
-- parcial emision y cobros, facultativo
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = pcidioma
                                                 AND cmoneda = pr.cdivisa),
                                             v_monedacontab, r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /*   + NVL((ce.icesion
                                                       * DECODE(tr.ctramo,
                                                                1, DECODE(SIGN((ce.icapces
                                                                                * tr.plocal / 100)
                                                                               - NVL(tr.imaxplo, 0)),
                                                                          -1,(cc.pcesion
                                                                              *(100
                                                                                -((tr.plocal
                                                                                   * tr.imaxplo)
                                                                                  /((ce.icapces
                                                                                     * tr.plocal)
                                                                                    / 100))))
                                                                           /(100 - tr.plocal),
                                                                          cc.pcesion),
                                                                cc.pcesion)
                                                       * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                   s.sseguro,
                                                                                   ce.cgarant,
                                                                                   cc.pcomisi,
                                                                                   r.femisio)
                                                       / 10000)
                                                      * rs.nfactor,
                                                      0),*/
                                             1))
                                *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                                0)) cedida
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuacesfac cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        detmovrecibo dv,
                        reasegemi rs,
                        -- Bug 26430 - 28/10/2013 - JMF
                        detreasegemi drs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro xp
                  WHERE dv.nrecibo = r.nrecibo
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.cgarant = ce.cgarant
                    AND xp.sproduc = s.sproduc
                    AND xp.cvalpar = cur.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND dv.norden = 1
                    AND dv.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    -- Bug 26430 - 28/10/2013 - JMF
                    AND rs.sreaemi = drs.sreaemi
                    AND drs.scesrea = ce.scesrea
                    AND drs.cgarant = ce.cgarant
                    --
                    AND cc.sfacult = ce.sfacult
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND t.cidioma = pcidioma
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = pcidioma
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = pcidioma
                    AND pg2.cvalpar = dp2.cvalpar
                    AND dv.fmovimi BETWEEN d_ini AND d_fin
                 UNION ALL
------------------------------------------------------------------
-- Reaseguro
                 SELECT SUM(NVL(r.importe, 0)) cedida
                   FROM (SELECT icesion_moncon importe, r.fcalcul, r.nsinies, r.sseguro,
                                cc.ccorred, r.cgarant
                           FROM reaseguro r, cuadroces cc
                          WHERE r.cgenera <> 2
                            AND r.ccompani = cc.ccompani
                            AND r.scontra = cc.scontra
                            AND r.nversio = cc.nversio
                            AND r.ctramo = cc.ctramo
                            AND preserv IS NOT NULL) r,
                        seguros s,
                        companias c,
                        productos pr,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        pargaranpro xp
                  WHERE s.sseguro = r.sseguro
                    AND(pprod IS NULL
                        OR(pprod = 1
                           AND f_es_renovacion(s.sseguro) = 1)
                        OR(pprod = 0
                           AND f_es_renovacion(s.sseguro) <> 1))
                    AND r.nsinies IS NULL
                    AND c.ccompani = r.ccorred
                    AND s.sproduc = pr.sproduc
                    AND NVL(r.importe, 0) <> 0
                    AND r.fcalcul BETWEEN d_ini AND d_fin
                    AND xp.cpargar = 'RAMOFECU'
                    AND xp.sproduc = s.sproduc
                    AND s.cramo = xp.cramo
                    AND s.cmodali = xp.cmodali
                    AND s.ctipseg = xp.ctipseg
                    AND s.ccolect = xp.ccolect
                    AND xp.cvalpar = cur.cvalpar
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cactivi = s.cactivi
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND dp.cidioma = pcidioma
                    AND dp.cparam = pg.cpargar
                    AND dp.cvalpar = pg.cvalpar
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND dp2.cparam = pg2.cpargar
                    AND dp2.cidioma = pcidioma
                    AND dp2.cvalpar = pg2.cvalpar
                    AND xp.cgarant = r.cgarant
                    AND pg.cgarant = r.cgarant
                    AND pg2.cgarant = r.cgarant);

         v_ttexto := v_ttexto || NVL(vcedida, 0) || ';';
      -- FI BUG 26430
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_cedida;

   -- Bug 26430/140998 - 09/04/2013 - AMC
   FUNCTION f_get_prima_cedida(pcramofecu IN NUMBER, phasta IN DATE)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_cedida';
      v_tparam       VARCHAR2(100) := 'pcramofecu:' || pcramofecu || ' phasta:' || phasta;
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuadroces cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.scontra = cc.scontra
                 AND r.nversio = cc.nversio
                 AND r.ctramo = cc.ctramo
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo <> 5   --Facultativos
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta2
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuacesfac cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.sfacult = cc.sfacult
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo = 5   --Facultativos
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      RETURN(NVL(vdirecta, 0) + NVL(vdirecta2, 0));
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_cedida;

   -- Bug 26430/140998 - 09/04/2013 - AMC
   FUNCTION f_get_linea_prima_aceptada(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_aceptada';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := f_axis_literales(9905276, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_aceptada;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_resriesgo_curso(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_resriesgo_curso';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimpore        NUMBER := 0;
      vimpore2       NUMBER := 0;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
   BEGIN
      SELECT TO_NUMBER(TO_CHAR(phasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(phasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(phasta)
           INTO vhasta
           FROM DUAL;
      ELSE
         vhasta := phasta;
      END IF;

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 26430 - 05/05/2014 : Anadir recibos para calcular fecha emision
         SELECT SUM(NVL(iprirrc_moncon, 0)) iprirrc_moncon
           INTO vimpore
           FROM rrc_sam p, procesoscab s1, procesoscab s2, pargaranpro pa, recibos r
          WHERE p.sproces = s1.sproces
            AND s2.sproces = (SELECT MAX(sproces)
                                FROM rrc_sam p2
                               WHERE p2.fcalcul = p.fcalcul)
            AND p.fcalcul = vhasta
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc
            AND p.nrecibo = r.nrecibo
            AND TRUNC(TO_DATE(r.femisio)) >= TO_DATE('0101' || TO_CHAR(phasta, 'yyyy'),
                                                     'ddmmyyyy');

         -- Bug 26430 - 05/05/2014 : Anadir recibos para calcular fecha emision
         SELECT SUM(NVL(iprrcrc_moncon, 0)) iprrcrc_moncon
           INTO vimpore2
           FROM rrc_rea_sam p, procesoscab s1, procesoscab s2, pargaranpro pa, recibos r
          WHERE p.sproces = s1.sproces
            AND s2.sproces = (SELECT MAX(sproces)
                                FROM rrc_rea_sam p2
                               WHERE p2.fcalcul = p.fcalcul)
            AND p.fcalcul = vhasta
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc
            AND p.nrecibo = r.nrecibo
            AND TRUNC(TO_DATE(r.femisio)) >= TO_DATE('0101' || TO_CHAR(phasta, 'yyyy'),
                                                     'ddmmyyyy');

         v_ttexto := v_ttexto ||(NVL(vimpore, 0) - NVL(vimpore2, 0)) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_resriesgo_curso;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_varresinsufi_prima(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_varresinsufi_prima';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.12.40' || ';' || f_axis_literales(9905281, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_varresinsufi_prima;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_varotrasrestec(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_varotrasrestec';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.12.50' || ';' || f_axis_literales(9905282, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_varotrasrestec;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_costo_sinidirectos(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_costo_sinidirectos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      -- BUG 26430 - FAL - 14/06/2013
      vmonto_total   NUMBER;
      d_ini          DATE;
      v_fin_ant      DATE;
      v_ini_ant      DATE;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      v_fin          DATE;
      v_provi_direct NUMBER;
      v_provi_direct_ant NUMBER;
      v_hasta_ant    DATE;
   -- FI BUG 26430
   BEGIN
      v_ttexto := '6.31.13.10' || ';' || f_axis_literales(9905259, pcidioma);
      -- BUG 26430 - FAL - 14/06/2013
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      v_fin_ant := TO_DATE('3112' || TO_CHAR(phasta, 'yyyy') - 1 || '000000',
                           'ddmmyyyyhh24miss');
      v_ini_ant := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') - 1 || '000000',
                           'ddmmyyyyhh24miss');
      v_hasta_ant := TO_DATE('3112' || TO_NUMBER(TO_CHAR(phasta, 'yyyy') - 1), 'ddmmyyyy');

      SELECT TO_NUMBER(TO_CHAR(phasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(phasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(phasta)
           INTO vhasta
           FROM DUAL;
      END IF;

      v_fin := vhasta;

      -- FI BUG 26430
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         BEGIN
            SELECT SUM(NVL(stpg.isinretpag, stpg.isinret)
                       -(NVL(stpg.iivapag, stpg.iiva) + NVL(stpg.iretencpag, stpg.iretenc)))
                                                                                         total
              INTO vmonto_total
              FROM seguros s, ramos ra, productos p, titulopro t, sin_siniestro si,
                   sin_tramita_pago stp, sin_tramita_pago_gar stpg, sin_tramita_movpago stm,
                   pargaranpro par
             WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
               AND par.cpargar = 'RAMOFECU'
               AND par.cvalpar = cur.cvalpar
               AND par.cgarant = stpg.cgarant
               AND par.sproduc = s.sproduc
               AND ra.cramo = s.cramo
               AND ra.cidioma = pcidioma
               AND p.sproduc = s.sproduc
               AND t.cramo = p.cramo
               AND t.cmodali = p.cmodali
               AND t.ctipseg = p.ctipseg
               AND t.ccolect = p.ccolect
               AND t.cidioma = pcidioma
               AND si.sseguro = s.sseguro
               AND stp.nsinies = si.nsinies
               AND stp.fordpag BETWEEN d_ini AND phasta
               AND stpg.sidepag = stp.sidepag
               AND stm.sidepag = stpg.sidepag
               AND stm.cestpag IN(2)
               AND stm.nmovpag = (SELECT MAX(stm2.nmovpag)
                                    FROM sin_tramita_movpago stm2
                                   WHERE stm2.sidepag = stpg.sidepag);
         EXCEPTION
            WHEN NO_DATA_FOUND THEN
               vmonto_total := 0;
         END;

         SELECT NVL(SUM(pac_informes_152.f_provsinpag(s.sseguro, phasta, 1)), 0)
           INTO v_provi_direct
           FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                sin_siniestro si, pargaranpro pa
          WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
            AND str.fcontab BETWEEN d_ini AND v_fin
            AND si.sseguro = s.sseguro
            AND str.nsinies = si.nsinies
            AND t.cramo = s.cramo
            AND t.cmodali = s.cmodali
            AND t.ctipseg = s.ctipseg
            AND t.ccolect = s.ccolect
            AND t.cidioma = 3
            AND p.sproduc = s.sproduc
            AND ps.sseguro = s.sseguro
            AND ps.nmovimi = (SELECT MAX(nmovimi)
                                FROM pregunpolseg
                               WHERE sseguro = ps.sseguro
                                 AND cpregun = 414
                                 AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                   FROM movseguro z
                                                  WHERE z.sseguro = ps.sseguro))
            AND ps.cpregun = 414
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cactivi = s.cactivi
            AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg.cramo = s.cramo
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cpargar = 'SUBCLAKEIRA'
            AND dp.cparam = pg.cpargar
            AND dp.cidioma = 3
            AND dp.cvalpar = pg.cvalpar
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cactivi = s.cactivi
            AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg2.cramo = s.cramo
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cpargar = 'CLAKEIRARAMO'
            AND dp2.cparam = pg2.cpargar
            AND dp2.cidioma = 3
            AND dp2.cvalpar = pg2.cvalpar
            AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                               FROM sin_tramita_reserva z_str
                                              WHERE z_str.nsinies = str.nsinies)
            AND str.cgarant = pg.cgarant
            AND str.cgarant = pg2.cgarant
            AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                 FROM garanseg gar
                                WHERE gar.sseguro = s.sseguro)
            AND pg.cgarant = pg2.cgarant
            -- Bug 26430 - 18/10/2013 - JMF
            AND s.cramo = pa.cramo
            AND s.cmodali = pa.cmodali
            AND s.ctipseg = pa.ctipseg
            AND s.ccolect = pa.ccolect
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND pa.cgarant = str.cgarant
            AND pa.sproduc = s.sproduc;

         SELECT NVL(SUM(pac_informes_152.f_provsinpag(s.sseguro, v_hasta_ant, 1)), 0)
           INTO v_provi_direct_ant
           FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                sin_siniestro si, pargaranpro pa
          WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
            AND str.fcontab BETWEEN v_ini_ant AND v_fin_ant
            AND si.sseguro = s.sseguro
            AND str.nsinies = si.nsinies
            AND t.cramo = s.cramo
            AND t.cmodali = s.cmodali
            AND t.ctipseg = s.ctipseg
            AND t.ccolect = s.ccolect
            AND t.cidioma = 3
            AND p.sproduc = s.sproduc
            AND ps.sseguro = s.sseguro
            AND ps.nmovimi = (SELECT MAX(nmovimi)
                                FROM pregunpolseg
                               WHERE sseguro = ps.sseguro
                                 AND cpregun = 414
                                 AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                   FROM movseguro z
                                                  WHERE z.sseguro = ps.sseguro))
            AND ps.cpregun = 414
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cactivi = s.cactivi
            AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg.cramo = s.cramo
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cpargar = 'SUBCLAKEIRA'
            AND dp.cparam = pg.cpargar
            AND dp.cidioma = 3
            AND dp.cvalpar = pg.cvalpar
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cactivi = s.cactivi
            AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg2.cramo = s.cramo
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cpargar = 'CLAKEIRARAMO'
            AND dp2.cparam = pg2.cpargar
            AND dp2.cidioma = 3
            AND dp2.cvalpar = pg2.cvalpar
            AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                               FROM sin_tramita_reserva z_str
                                              WHERE z_str.nsinies = str.nsinies)
            AND str.cgarant = pg.cgarant
            AND str.cgarant = pg2.cgarant
            AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                 FROM garanseg gar
                                WHERE gar.sseguro = s.sseguro)
            AND pg.cgarant = pg2.cgarant
            -- Bug 26430 - 18/10/2013 - JMF
            AND s.cramo = pa.cramo
            AND s.cmodali = pa.cmodali
            AND s.ctipseg = pa.ctipseg
            AND s.ccolect = pa.ccolect
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND pa.cgarant = str.cgarant
            AND pa.sproduc = s.sproduc;

         v_ttexto := v_ttexto || ';'
                     ||(NVL(vmonto_total, 0) + NVL(v_provi_direct, 0)
                        - NVL(v_provi_direct_ant, 0));
      -- FI BUG 26430
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_costo_sinidirectos;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_costo_sinicedidos(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_costo_sinicedidos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      -- BUG 26430 - FAL - 14/06/2013
      vcesion_total  NUMBER;
      d_ini          DATE;
      v_fin_ant      DATE;
      v_ini_ant      DATE;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      v_fin          DATE;
      v_provi_cedi   NUMBER;
      v_provi_cedi_ant NUMBER;
      v_hasta_ant    DATE;
   -- FI BUG 26430
   BEGIN
      v_ttexto := '6.31.13.20' || ';' || f_axis_literales(9905260, pcidioma);
      -- BUG 26430 - FAL - 14/06/2013
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      v_fin_ant := TO_DATE('3112' || TO_CHAR(phasta, 'yyyy') - 1 || '000000',
                           'ddmmyyyyhh24miss');
      v_ini_ant := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') - 1 || '000000',
                           'ddmmyyyyhh24miss');
      v_hasta_ant := TO_DATE('3112' || TO_NUMBER(TO_CHAR(phasta, 'yyyy') - 1), 'ddmmyyyy');

      SELECT TO_NUMBER(TO_CHAR(phasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(phasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(phasta)
           INTO vhasta
           FROM DUAL;
      END IF;

      v_fin := vhasta;

      -- FI BUG 26430
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- BUG 26430 - FAL - 14/06/2013
         -- v_ttexto := v_ttexto || ';' || '0';
         BEGIN
            SELECT SUM(NVL(pac_informes_152.f_cesionsobremontototal(stp.sidepag, s.sseguro), 0))
                                                                                         total
              INTO vcesion_total
              FROM seguros s, ramos ra, productos p, titulopro t, sin_siniestro si,
                   sin_tramita_pago stp, sin_tramita_pago_gar stpg, sin_tramita_movpago stm,
                   pargaranpro par
             WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
               AND par.cpargar = 'RAMOFECU'
               AND par.cvalpar = cur.cvalpar
               AND par.cgarant = stpg.cgarant
               AND par.sproduc = s.sproduc
               AND ra.cramo = s.cramo
               AND ra.cidioma = pcidioma
               AND p.sproduc = s.sproduc
               AND t.cramo = p.cramo
               AND t.cmodali = p.cmodali
               AND t.ctipseg = p.ctipseg
               AND t.ccolect = p.ccolect
               AND t.cidioma = pcidioma
               AND si.sseguro = s.sseguro
               AND stp.nsinies = si.nsinies
               AND stp.fordpag BETWEEN d_ini AND phasta
               AND stpg.sidepag = stp.sidepag
               AND stm.sidepag = stpg.sidepag
               AND stm.cestpag = 2
               AND stm.nmovpag = (SELECT MAX(stm2.nmovpag)
                                    FROM sin_tramita_movpago stm2
                                   WHERE stm2.sidepag = stpg.sidepag);
         EXCEPTION
            WHEN NO_DATA_FOUND THEN
               vcesion_total := 0;
         END;

         SELECT NVL(SUM(pac_informes_152.f_provsinpag(s.sseguro, phasta, 2)), 0)
           INTO v_provi_cedi
           FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                sin_siniestro si, pargaranpro pa
          WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
            AND str.fcontab BETWEEN d_ini AND v_fin
            AND si.sseguro = s.sseguro
            AND str.nsinies = si.nsinies
            AND t.cramo = s.cramo
            AND t.cmodali = s.cmodali
            AND t.ctipseg = s.ctipseg
            AND t.ccolect = s.ccolect
            AND t.cidioma = 3
            AND p.sproduc = s.sproduc
            AND ps.sseguro = s.sseguro
            AND ps.nmovimi = (SELECT MAX(nmovimi)
                                FROM pregunpolseg
                               WHERE sseguro = ps.sseguro
                                 AND cpregun = 414
                                 AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                   FROM movseguro z
                                                  WHERE z.sseguro = ps.sseguro))
            AND ps.cpregun = 414
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cactivi = s.cactivi
            AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg.cramo = s.cramo
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cpargar = 'SUBCLAKEIRA'
            AND dp.cparam = pg.cpargar
            AND dp.cidioma = 3
            AND dp.cvalpar = pg.cvalpar
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cactivi = s.cactivi
            AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg2.cramo = s.cramo
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cpargar = 'CLAKEIRARAMO'
            AND dp2.cparam = pg2.cpargar
            AND dp2.cidioma = 3
            AND dp2.cvalpar = pg2.cvalpar
            AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                               FROM sin_tramita_reserva z_str
                                              WHERE z_str.nsinies = str.nsinies)
            AND str.cgarant = pg.cgarant
            AND str.cgarant = pg2.cgarant
            AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                 FROM garanseg gar
                                WHERE gar.sseguro = s.sseguro)
            AND pg.cgarant = pg2.cgarant
            -- Bug 26430 - 18/10/2013 - JMF
            AND s.cramo = pa.cramo
            AND s.cmodali = pa.cmodali
            AND s.ctipseg = pa.ctipseg
            AND s.ccolect = pa.ccolect
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND pa.cgarant = str.cgarant
            AND pa.sproduc = s.sproduc;

         SELECT NVL(SUM(pac_informes_152.f_provsinpag(s.sseguro, v_hasta_ant, 2)), 0)
           INTO v_provi_cedi_ant
           FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                sin_siniestro si, pargaranpro pa
          WHERE s.cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
            AND str.fcontab BETWEEN v_ini_ant AND v_fin_ant
            AND si.sseguro = s.sseguro
            AND str.nsinies = si.nsinies
            AND t.cramo = s.cramo
            AND t.cmodali = s.cmodali
            AND t.ctipseg = s.ctipseg
            AND t.ccolect = s.ccolect
            AND t.cidioma = 3
            AND p.sproduc = s.sproduc
            AND ps.sseguro = s.sseguro
            AND ps.nmovimi = (SELECT MAX(nmovimi)
                                FROM pregunpolseg
                               WHERE sseguro = ps.sseguro
                                 AND cpregun = 414
                                 AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                   FROM movseguro z
                                                  WHERE z.sseguro = ps.sseguro))
            AND ps.cpregun = 414
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cactivi = s.cactivi
            AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg.cramo = s.cramo
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cpargar = 'SUBCLAKEIRA'
            AND dp.cparam = pg.cpargar
            AND dp.cidioma = 3
            AND dp.cvalpar = pg.cvalpar
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cactivi = s.cactivi
            AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg2.cramo = s.cramo
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cpargar = 'CLAKEIRARAMO'
            AND dp2.cparam = pg2.cpargar
            AND dp2.cidioma = 3
            AND dp2.cvalpar = pg2.cvalpar
            AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                               FROM sin_tramita_reserva z_str
                                              WHERE z_str.nsinies = str.nsinies)
            AND str.cgarant = pg.cgarant
            AND str.cgarant = pg2.cgarant
            AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                 FROM garanseg gar
                                WHERE gar.sseguro = s.sseguro)
            AND pg.cgarant = pg2.cgarant
            -- Bug 26430 - 18/10/2013 - JMF
            AND s.cramo = pa.cramo
            AND s.cmodali = pa.cmodali
            AND s.ctipseg = pa.ctipseg
            AND s.ccolect = pa.ccolect
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND pa.cgarant = str.cgarant
            AND pa.sproduc = s.sproduc;

         v_ttexto := v_ttexto || ';'
                     ||(NVL(vcesion_total, 0) + NVL(v_provi_cedi, 0) - NVL(v_provi_cedi_ant, 0));
      -- FI BUG 26430
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_costo_sinicedidos;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_costo_siniaceptados(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_costo_siniaceptados';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.13.30' || ';' || f_axis_literales(9905261, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_costo_siniaceptados;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_comiage_directos(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_comiage_directos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      vimporte2      NUMBER := 0;
      v_comi_dir     NUMBER;   -- BUG 26430 - FAL - 17/06/2013
      d_ini          DATE;
      d_fin          DATE;
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_ttexto := '6.31.15.10' || ';' || f_axis_literales(9905288, pcidioma);
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'YYYY') || '000000', 'DDMMYYYYhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'DDMMYYYY') || '235959', 'DDMMYYYYhh24miss');
      -- bug 26430 - 31/10/2013 - JMF
      v_idi := f_usu_idioma;

      IF v_idi IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      END IF;

      -- Bug 26430 - 14/01/2014 - JMF
      v_ttexto := v_ttexto || ';'
                  || pac_informes_152.f_get_prima_directa(d_fin, v_idi, NULL, 0, 11);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_comiage_directos;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_comi_corredores(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_comi_corredores';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      vimporte2      NUMBER := 0;
      vimporte3      NUMBER := 0;
      vimporte4      NUMBER := 0;
      vimporte5      NUMBER := 0;
      vimporte6      NUMBER := 0;
      vimporte7      NUMBER := 0;
      vimporte8      NUMBER := 0;
      v_comi_inter   NUMBER;   -- BUG 26430 - FAL - 17/06/2013
      d_ini          DATE;
      d_fin          DATE;
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_idi := NVL(pcidioma, f_usu_idioma);

      IF v_idi IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      END IF;

      v_ttexto := '6.31.15.20' || ';' || f_axis_literales(9905289, v_idi);
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'YYYY') || '000000', 'DDMMYYYYhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'DDMMYYYY') || '235959', 'DDMMYYYYhh24miss');
      -- Bug 26430 - 14/01/2014 - JMF
      v_ttexto := v_ttexto || ';'
                  || pac_informes_152.f_get_prima_directa(d_fin, v_idi, NULL, 1, 11);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_comi_corredores;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_comi_rea_aceptado(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_comi_rea_aceptado';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.13.30' || ';' || f_axis_literales(9905290, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_comi_rea_aceptado;

   -- Bug 26430/140998 - 10/04/2013 - AMC
   FUNCTION f_get_comi_cedido(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_comi_cedido';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      vimporte2      NUMBER := 0;
      v_comi_rea_cedid NUMBER;   -- BUG 26430 - FAL - 17/06/2013
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      v_ttexto := '6.31.15.40' || ';' || f_axis_literales(9905291, pcidioma);
      -- Bug 26430 - 18/10/2013 - JMF
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'YYYY') || '000000', 'DDMMYYYYhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'DDMMYYYY') || '235959', 'DDMMYYYYhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT SUM(cesion)
           INTO v_comi_rea_cedid
           FROM (SELECT SUM
                           (NVL
                               (((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa),
                                             (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                FROM parempresas
                                               WHERE cempres = v_emp
                                                 -- 16 -- BUG 0035387 - FAL - 31/03/2015
                                                 AND cparam = 'MONEDACONTAB'),
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  * pac_propio.f_comi_ces(cc.ccomrea,
                                                                          s.sseguro,
                                                                          ce.cgarant,
                                                                          cc.pctcomis,
                                                                          r.femisio)
                                                  / 10000)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                                 * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                 * DECODE(m.cestrec, 0, 1, -1)),
                                0)) cesion
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuadroces cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        movrecibo m,
                        reasegemi rs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro pa
                  WHERE cc.ctramo = tr.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND m.nrecibo = r.nrecibo
                    AND cc.scontra = tr.scontra
                    AND cc.nversio = tr.nversio
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND m.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    AND(((m.cestrec = 0
                          AND m.cestant = 0)
                         OR(m.cestrec = 2
                            AND m.cestant = 0
                            AND rs.cmotces = 2))
                        OR(((m.cestrec = 0
                             AND m.cestant = 1)
                            OR(m.cestrec = 1
                               AND rs.cmotces = 1))
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo)))
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = 3
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = 3
                    AND pg2.cvalpar = dp2.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND r.femisio BETWEEN d_ini AND d_fin
                    AND s.cramo = pa.cramo
                    AND s.cmodali = pa.cmodali
                    AND s.ctipseg = pa.ctipseg
                    AND s.ccolect = pa.ccolect
                    AND pa.cpargar = 'RAMOFECU'
                    AND pa.cvalpar = cur.cvalpar
                    AND pa.cgarant = ce.cgarant
                    AND pa.sproduc = s.sproduc
                 UNION
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa),
                                             (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                FROM parempresas
                                               WHERE cempres = v_emp
                                                 -- 16 -- BUG 0035387 - FAL - 31/03/2015
                                                 AND cparam = 'MONEDACONTAB'),
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  * pac_propio.f_comi_ces(cc.ccomrea,
                                                                          s.sseguro,
                                                                          ce.cgarant,
                                                                          cc.pcomisi,
                                                                          r.femisio)
                                                  / 10000)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                                * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * DECODE(m.cestrec, 0, 1, -1),
                                0)) cesion
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuacesfac cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        movrecibo m,
                        reasegemi rs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro pa
                  WHERE m.nrecibo = r.nrecibo
                    AND cc.sfacult = ce.sfacult
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND m.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    AND(((m.cestrec = 0
                          AND m.cestant = 0)
                         OR(m.cestrec = 2
                            AND m.cestant = 0
                            AND rs.cmotces = 2))
                        OR(((m.cestrec = 0
                             AND m.cestant = 1)
                            OR(m.cestrec = 1
                               AND rs.cmotces = 1))
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo)))
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = 3
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = 3
                    AND pg2.cvalpar = dp2.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND r.femisio BETWEEN d_ini AND d_fin
                    AND s.cramo = pa.cramo
                    AND s.cmodali = pa.cmodali
                    AND s.ctipseg = pa.ctipseg
                    AND s.ccolect = pa.ccolect
                    AND pa.cpargar = 'RAMOFECU'
                    AND pa.cvalpar = cur.cvalpar
                    AND pa.cgarant = ce.cgarant
                    AND pa.sproduc = s.sproduc
                 UNION
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa),
                                             (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                FROM parempresas
                                               WHERE cempres = v_emp
                                                 -- 16 -- BUG 0035387 - FAL - 31/03/2015
                                                 AND cparam = 'MONEDACONTAB'),
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  * pac_propio.f_comi_ces(cc.ccomrea,
                                                                          s.sseguro,
                                                                          ce.cgarant,
                                                                          cc.pctcomis,
                                                                          r.femisio)
                                                  / 10000)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                                * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                                0)) cesion
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuadroces cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        detmovrecibo dv,
                        reasegemi rs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro pa
                  WHERE dv.nrecibo = r.nrecibo
                    AND dv.norden = 1
                    AND cc.ctramo = tr.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND dv.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    AND cc.scontra = tr.scontra
                    AND cc.nversio = tr.nversio
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = 3
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = 3
                    AND pg2.cvalpar = dp2.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND r.femisio BETWEEN d_ini AND d_fin
                    AND s.cramo = pa.cramo
                    AND s.cmodali = pa.cmodali
                    AND s.ctipseg = pa.ctipseg
                    AND s.ccolect = pa.ccolect
                    AND pa.cpargar = 'RAMOFECU'
                    AND pa.cvalpar = cur.cvalpar
                    AND pa.cgarant = ce.cgarant
                    AND pa.sproduc = s.sproduc
                 UNION
                 SELECT SUM
                           (NVL
                               ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa),
                                             (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                FROM parempresas
                                               WHERE cempres = v_emp
                                                 -- 16 -- BUG 0035387 - FAL - 31/03/2015
                                                 AND cparam = 'MONEDACONTAB'),
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  * pac_propio.f_comi_ces(cc.ccomrea,
                                                                          s.sseguro,
                                                                          ce.cgarant,
                                                                          cc.pcomisi,
                                                                          r.femisio)
                                                  / 10000)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                                * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                                0)) cesion
                   FROM seguros s,
                        tramos tr,
                        recibos r,
                        cuacesfac cc,
                        (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo,
                                ce.scontra, ce.cgarant, ce.sfacult, ce.nmovimi
                           FROM cesionesrea ce, tramos tr
                          WHERE tr.scontra = ce.scontra
                            AND tr.nversio = ce.nversio
                            AND tr.ctramo = ce.ctramo
                            AND ce.fefecto <> ce.fvencim) ce,
                        detmovrecibo dv,
                        reasegemi rs,
                        productos pr,
                        companias c,
                        pregunpolseg ps,
                        pargaranpro pg,
                        detparam dp,
                        pargaranpro pg2,
                        detparam dp2,
                        titulopro t,
                        per_personas pp,
                        per_personas pe,
                        companias br,
                        pargaranpro pa
                  WHERE dv.nrecibo = r.nrecibo
                    AND dv.norden = 1
                    AND dv.nrecibo = rs.nrecibo
                    AND rs.cmotces = 1
                    AND cc.sfacult = ce.sfacult
                    AND tr.scontra = ce.scontra
                    AND tr.nversio = ce.nversio
                    AND tr.ctramo = ce.ctramo
                    AND t.cramo = s.cramo
                    AND t.cmodali = s.cmodali
                    AND t.ctipseg = s.ctipseg
                    AND t.ccolect = s.ccolect
                    AND c.sperson = pp.sperson
                    AND br.ccompani = cc.ccorred
                    AND br.sperson = pe.sperson
                    AND s.sseguro = ce.sseguro
                    AND s.sseguro = rs.sseguro
                    AND s.cramo = pr.cramo
                    AND s.cmodali = pr.cmodali
                    AND s.ctipseg = pr.ctipseg
                    AND s.ccolect = pr.ccolect
                    AND c.ccompani = cc.ccompani
                    AND ps.sseguro = s.sseguro
                    AND ps.nmovimi = (SELECT MAX(nmovimi)
                                        FROM pregunpolseg
                                       WHERE sseguro = s.sseguro
                                         AND cpregun = 414
                                         AND nmovimi <= ce.nmovimi)
                    AND ps.cpregun = 414
                    AND s.cramo = pg.cramo
                    AND s.cmodali = pg.cmodali
                    AND s.ctipseg = pg.ctipseg
                    AND s.ccolect = pg.ccolect
                    AND s.cactivi = pg.cactivi
                    AND s.sproduc = pg.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg.cramo = s.cramo
                    AND pg.cmodali = s.cmodali
                    AND pg.ctipseg = s.ctipseg
                    AND pg.ccolect = s.ccolect
                    AND pg.cpargar = 'SUBCLAKEIRA'
                    AND ce.cgarant = pg.cgarant
                    AND pg.cpargar = dp.cparam
                    AND dp.cidioma = 3
                    AND pg.cvalpar = dp.cvalpar
                    AND s.cmodali = pg2.cmodali
                    AND s.ctipseg = pg2.ctipseg
                    AND s.ccolect = pg2.ccolect
                    AND s.cactivi = pg2.cactivi
                    AND s.sproduc = pg2.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
                    AND pg2.cramo = s.cramo
                    AND pg2.cmodali = s.cmodali
                    AND pg2.ctipseg = s.ctipseg
                    AND pg2.ccolect = s.ccolect
                    AND pg2.cpargar = 'CLAKEIRARAMO'
                    AND ce.cgarant = pg2.cgarant
                    AND pg2.cpargar = dp2.cparam
                    AND dp2.cidioma = 3
                    AND pg2.cvalpar = dp2.cvalpar
                    -- Bug 26430 - 18/10/2013 - JMF
                    AND r.femisio BETWEEN d_ini AND d_fin
                    AND s.cramo = pa.cramo
                    AND s.cmodali = pa.cmodali
                    AND s.ctipseg = pa.ctipseg
                    AND s.ccolect = pa.ccolect
                    AND pa.cpargar = 'RAMOFECU'
                    AND pa.cvalpar = cur.cvalpar
                    AND pa.cgarant = ce.cgarant
                    AND pa.sproduc = s.sproduc);

         v_ttexto := v_ttexto || ';' || NVL(v_comi_rea_cedid, 0);
      -- FI BUG 26430 - FAL - 17/06/2013
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_comi_cedido;

   -- Bug 26430/140998 - 11/04/2013 - AMC
   FUNCTION f_get_dire_gastos(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_dire_gastos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_gastos       NUMBER;   -- BUG 26430 - FAL - 17/06/2013
      d_fecini       DATE;
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      IF pcidioma IS NOT NULL THEN
         v_idi := pcidioma;
      ELSE
         v_idi := f_usu_idioma;

         IF v_idi IS NULL THEN
            SELECT MAX(nvalpar)
              INTO v_idi
              FROM parinstalacion
             WHERE cparame = 'IDIOMARTF';
         END IF;
      END IF;

      SELECT TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
        INTO d_fecini
        FROM DUAL;

      -- Bug 26430 - 14/01/2014 - JMF
      v_ttexto := '6.31.21.20' || ';' || f_axis_literales(9905295, v_idi) || ';'
                  || pac_informes_152.f_get_prima_directa(phasta, v_idi, NULL, NULL, 4849);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_dire_gastos;

   -- Bug 26430/140998 - 11/04/2013 - AMC
   FUNCTION f_get_dire_otros(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_dire_otros';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_gastos       NUMBER;   -- BUG 26430 - FAL - 17/06/2013
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
      d_fecini       DATE;
   BEGIN
      IF pcidioma IS NOT NULL THEN
         v_idi := pcidioma;
      ELSE
         v_idi := f_usu_idioma;

         IF v_idi IS NULL THEN
            SELECT MAX(nvalpar)
              INTO v_idi
              FROM parinstalacion
             WHERE cparame = 'IDIOMARTF';
         END IF;
      END IF;

      -- Bug 26430 - 14/01/2014 - JMF
      v_ttexto := '6.31.21.30' || ';' || f_axis_literales(110031, v_idi) || ';'
                  || pac_informes_152.f_get_prima_directa(phasta, v_idi, NULL, NULL, 47);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_dire_otros;

   -- Bug 26430/140998 - 11/04/2013 - AMC
   FUNCTION f_get_indire_gastos(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_indire_gastos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      vimporte2      NUMBER := 0;
      vimporte3      NUMBER := 0;
      vimporte4      NUMBER := 0;
      vimporte5      NUMBER := 0;
      vimporte6      NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.22.20' || ';' || f_axis_literales(9905295, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_indire_gastos;

   -- Bug 26430/140998 - 11/04/2013 - AMC
   FUNCTION f_get_indire_otros(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_indire_otros';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      vimporte2      NUMBER := 0;
      vimporte3      NUMBER := 0;
      vimporte4      NUMBER := 0;
      vimporte5      NUMBER := 0;
      vimporte6      NUMBER := 0;
   BEGIN
      v_ttexto := '6.31.22.30' || ';' || f_axis_literales(110031, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_indire_otros;

   -- Bug 26430/140998 - 12/04/2013 - AMC
   FUNCTION f_get_ajuste_contrato(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_ajuste_contrato';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      v_ttexto := '6.20.11.20' || ';' || f_axis_literales(9905317, pcidioma);

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || ';' || '0';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_ajuste_contrato;

   /******************************************************************************************
       Descripció: Cabecera del map 724 Listado de Venta proyectada Vigente
       return:     texto cabecera
       -- bug 26430/141410 - 12/04/2013 - JMF
       -- bug 26430/144927 - 23/05/2013 - JMF
     ******************************************************************************************/
   FUNCTION f_862_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_724_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_aux          VARCHAR2(32000);
      v_idioma       NUMBER;
      v_mo           VARCHAR2(100) := ' MO';
   BEGIN
      SELECT NVL(NVL(MAX(nvalpar), f_usu_idioma), 3)
        INTO v_idioma
        FROM parinstalacion
       WHERE cparame = 'IDIOMARTF';

      v_ttexto := 'SELECT ' || CHR(39);
      v_aux := CHR(10) || f_axis_literales(9905297, v_idioma) || v_sep
               || TO_CHAR(TO_DATE(LPAD(fecha_desde, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy')
               || ' - '
               || TO_CHAR(TO_DATE(LPAD(fecha_hasta, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy');
      v_ttexto := v_ttexto || v_aux;
      v_aux := CHR(10) || CHR(10) || f_axis_literales(100829, v_idioma) || v_sep
               || f_axis_literales(1000307, v_idioma) || v_sep
               || f_axis_literales(9903067, v_idioma) || ' '
               || f_axis_literales(9905070, v_idioma) || v_sep
               || f_axis_literales(9905070, v_idioma) || v_sep
               || f_axis_literales(9903067, v_idioma) || ' '
               || f_axis_literales(9905313, v_idioma) || v_sep
               || f_axis_literales(9905313, v_idioma) || v_sep
               || f_axis_literales(9903067, v_idioma) || ' '
               || f_axis_literales(9905315, v_idioma) || v_sep
               || f_axis_literales(101027, v_idioma) || v_sep   -- contratante
               || f_axis_literales(9001639, v_idioma) || v_sep   -- Nº póliza
               || f_axis_literales(104595, v_idioma) || v_sep   -- Item
               || f_axis_literales(800636, v_idioma) || v_sep   -- Recibo
               || f_axis_literales(9905523, v_idioma) || v_sep   -- Estado
               || f_axis_literales(9905275, v_idioma) || v_sep   -- prima directa
               || f_axis_literales(9905275, v_idioma) || v_mo || v_sep   -- prima directa MO
               || f_axis_literales(9905318, v_idioma) || v_sep   -- Prima Intermediada
               || f_axis_literales(9905318, v_idioma) || v_mo || v_sep   -- Prima Intermediada MO
               || f_axis_literales(107586, v_idioma) || v_sep   -- Comis. Agentes
               || f_axis_literales(107586, v_idioma) || v_mo || v_sep   -- Comis. Agentes MO
               || f_axis_literales(9905319, v_idioma) || v_sep   -- Costo de Intermediación
               || f_axis_literales(9905319, v_idioma) || v_mo
               || v_sep   -- Costo de Intermediación MO
                       || f_axis_literales(9905320, v_idioma)
               || v_sep   -- Comisión por Recaudación
                       || f_axis_literales(9905320, v_idioma) || v_mo
               || v_sep   -- Comisión por Recaudación MO
                       || f_axis_literales(9905321, v_idioma)
               || v_sep   -- Comisión acceso preferente
                       || f_axis_literales(9905321, v_idioma) || v_mo
               || v_sep   -- Comisión acceso preferente MO
               || f_axis_literales(9905322, v_idioma) || v_sep   -- Comisión uso de canal
               || f_axis_literales(9905322, v_idioma) || v_mo
               || v_sep   -- Comisión uso de canal MO
                       || f_axis_literales(9905323, v_idioma) || v_sep   -- Keira Línea Negocio
               || f_axis_literales(9905324, v_idioma) || v_sep   -- Keira
               || f_axis_literales(9905325, v_idioma) || v_sep   -- Sub_Keira
               || f_axis_literales(108645, v_idioma) || v_sep   -- Moneda
               || f_axis_literales(1000562, v_idioma) || v_sep   -- Fecha emisión
               || f_axis_literales(1000575, v_idioma) || v_sep   -- Fecha contable
                                                              || '';
      v_ttexto := v_ttexto || v_aux || CHR(39) || ' linea from dual';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_862_cab;

   /******************************************************************************************
     Descripció: Detalle del map 724 Listado de Venta proyectada Vigente
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/144927 - 23/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_862_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_724_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || '000000' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_idi := f_usu_idioma;
      v_emp := f_empres;
      v_ttexto :=
         ' select linea' || ' from  (' || ' SELECT '
         || ' p.cdivisa||trunc(r.FEMISIO)||s.npoliza||s.ncertif orden,' || ' s.sproduc'
         || v_sep || 't.ttitulo' || v_sep || 'max(pp.NNUMIDE||''-''||pp.TDIGITOIDE)' || v_sep
         || 'max(pp2.TAPELLI1||''-''||pp2.TAPELLI2)' || v_sep
         || 'max(pc.NNUMIDE||''-''||pc.TDIGITOIDE)' || v_sep
         || 'max(pc2.TAPELLI1||''-''||pc2.TAPELLI2)' || v_sep
         || 'max(pt.NNUMIDE||''-''||pt.TDIGITOIDE)' || v_sep
         || 'max(pt2.tnombre||'' ''||pt2.TAPELLI1||''-''||pt2.TAPELLI2)' || v_sep
         || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'r.nrecibo' || v_sep
         || 'PAC_INFORMES_152.f_desrec (' || v_idi || ',m.cestant,m.CESTREC,r.ctiprec)'
         || v_sep   -- descripcion estado recibo
         -- bug 26430/144927 - 23/05/2013 - JMF
         --|| '0' || v_sep -- prima directa
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0)),0)'
         || v_sep   -- Prima directa
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0)),0)'
         || v_sep   -- Prima directa MO
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0)),0)'
         || v_sep   -- PrimaIntermediada,
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0)),0)'
         || v_sep   -- PrimaIntermediada MO,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0),0))'
         || v_sep   -- ComisionesAgentes,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep,0),0))'
         || v_sep   -- ComisionesAgentes MO
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0), 0))'
         || v_sep   -- CostoIntermediacionDirecta,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep,0), 0))'
         || v_sep   -- CostoIntermediacionDirecta MO
         || 'sum(decode(d.cconcep, 47, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisRecaudo,
         || 'sum(decode(d.cconcep, 47, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisRecaudo MO
         || 'sum(decode(d.cconcep, 49, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisAccPreferente,
         || 'sum(decode(d.cconcep, 49, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisAccPreferente MO
         || 'sum(decode(d.cconcep, 48, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisUsoCanal,
         || 'sum(decode(d.cconcep, 48, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisUsoCanal MO
                 || 'ps.crespue' || v_sep   -- KeiraLinNegocio,
                                         || 'dp.tvalpar' || v_sep   -- Keira,
                                                                 || 'dp2.tvalpar'
         || v_sep   -- SubKeira,
                 -- bug 26430/144927 - 23/05/2013 - JMF
                 --|| 'p.cdivisa' || v_sep
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep || 'trunc(r.FEMISIO)' || v_sep   -- fecha emision
         || 'm.fcontab' || v_sep   -- fechaContable
                                || CHR(39) || CHR(39) || ' linea'
         || ' FROM SEGUROS s, TITULOPRO t, DETRECIBOS d, MOVRECIBO m, RECIBOS r, PRODUCTOS p, PREGUNPOLSEG ps, PARGARANPRO pg,'
         || ' DETPARAM dp, PARGARANPRO pg2, DETPARAM dp2, AGENTES a,'
         || ' per_personas pc, per_detper pc2,' || ' per_personas pp, per_detper pp2,'
         || ' per_personas pt, per_detper pt2,' || ' AGENTES a2, TOMADORES tom,'
         || ' AGENTES_COMP ac' || ' WHERE m.FMOVDIA between ' || v_ini || ' and ' || v_fin
         || ' AND m.cestrec in (0,2)' || ' AND m.cestant in (0)'
         || ' AND r.nrecibo = m.nrecibo' || ' AND r.cestaux = 0'
         || ' AND r.ctiprec in (0, 1, 3, 9, 13, 15)' || ' AND s.sseguro = r.sseguro'
         || ' AND tom.sseguro = s.sseguro' || ' AND pc.sperson = a.sperson'
         || ' and pc2.sperson=a.sperson'
         || ' and pc2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=a.sperson)'
         || ' AND pp.sperson = a2.sperson' || ' AND pp2.sperson = a2.sperson'
         || ' and pp2.FMOVIMI=(select max(pp22.FMOVIMI) from per_detper pp22 where pp22.sperson=a2.sperson)'
         || ' AND pt.sperson = tom.sperson' || ' AND pt2.sperson = tom.sperson'
         || ' and pt2.FMOVIMI=(select max(pt22.FMOVIMI) from per_detper pt22 where pt22.sperson=tom.sperson)'
         || ' AND p.sproduc = s.sproduc' || ' AND a.cagente = s.cagente'
         || ' AND ac.cagente = s.cagente'
         || ' AND t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect'
         || ' AND t.cidioma = ' || v_idi
         -- bug 26422 dcg 7-5-2013
         || ' AND ps.nmovimi = (select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=r.nmovimi)'
         || ' AND ps.cpregun = 414 AND ps.SSEGURO=s.sseguro '
                                                             -- bug 26430/144927 - 23/05/2013 - JMF
         || ' AND d.nrecibo = r.nrecibo' || ' AND d.cconcep in (0,11,47,48,49)'
         || ' AND pg.sproduc = s.sproduc' || ' and pg.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi || ' AND pg.cvalpar = dp.cvalpar' || ' AND s.sproduc = pg2.sproduc'
         || ' AND pg2.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam AND dp2.cidioma = '
         || v_idi || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' AND a2.cagente =  pac_redcomercial.f_busca_padre(' || v_emp
         || ',s.cagente,null,r.fefecto)' || ' group by s.sproduc, t.ttitulo,'
         || ' s.npoliza, s.ncertif,'
         || ' ps.crespue, dp.tvalpar, dp2.tvalpar,  p.cdivisa, trunc(r.FEMISIO), ac.CTIPINT, m.fcontab,'
         || ' r.nrecibo, PAC_INFORMES_152.f_desrec (' || v_idi
         || ',m.cestant,m.CESTREC,r.ctiprec)'
---------------------------
         || ' UNION '
---------------------------
         || ' SELECT ' || ' p.cdivisa||trunc(r.FEMISIO)||s.npoliza||s.ncertif orden,'
         || 's.sproduc' || v_sep || 't.ttitulo' || v_sep
         || 'max(pp.NNUMIDE||''-''||pp.TDIGITOIDE)' || v_sep
         || 'max(pp2.TAPELLI1||''-''||pp2.TAPELLI2)' || v_sep
         || 'max(pc.NNUMIDE||''-''||pc.TDIGITOIDE)' || v_sep
         || 'max(pc2.TAPELLI1||''-''||pc2.TAPELLI2)' || v_sep
         || 'max(pt.NNUMIDE||''-''||pt.TDIGITOIDE)' || v_sep
         || 'max(pt2.tnombre||'' ''||pt2.TAPELLI1||''-''||pc2.TAPELLI2)' || v_sep
         || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'r.nrecibo' || v_sep
         || 'PAC_INFORMES_152.f_desrec (' || v_idi || ',m.cestant,m.cestrec,r.ctiprec)'
         || v_sep   -- descripcion estado recibo
         -- bug 26430/144927 - 23/05/2013 - JMF
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0)),0)'
         || v_sep   -- Prima directa
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0)),0)'
         || v_sep   -- Prima directaMO
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0)),0)'
         || v_sep   -- PrimaIntermediada,
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0,decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0)),0)'
         || v_sep   -- PrimaIntermediadaMO
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0), 0))'
         || v_sep   -- ComisionesAgentes,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep,0), 0))'
         || v_sep   -- ComisionesAgentesMO
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0), 0))'
         || v_sep   -- CostoIntermediacionDirecta,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(r.ctiprec,9,-1,13,-1,1)*decode(d.cconcep, 11, decode(m.cestrec,0,1,-1)*d.iconcep,0), 0))'
         || v_sep   -- CostoIntermediacionDirectaMO
         || 'sum(decode(d.cconcep, 47, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisRecaudo,
         || 'sum(decode(d.cconcep, 47, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisRecaudoMO
         || 'sum(decode(d.cconcep, 49, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisAccPreferente,
         || 'sum(decode(d.cconcep, 49, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisAccPreferenteMO
         || 'sum(decode(d.cconcep, 48, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisUsoCanal,
         || 'sum(decode(d.cconcep, 48, decode(r.ctiprec,9,-1,13,-1,1)*decode(m.cestrec,0,1,-1)*d.iconcep,0))'
         || v_sep   -- ComisUsoCanalMO
                 || 'ps.crespue' || v_sep   -- KeiraLinNegocio,
                                         || 'dp.tvalpar' || v_sep   -- Keira,
                                                                 || 'dp2.tvalpar'
         || v_sep   -- SubKeira,
                 -- bug 26430/144927 - 23/05/2013 - JMF
                 --|| 'p.cdivisa' || v_sep
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep || 'trunc(r.FEMISIO)' || v_sep   -- fecha emision
         || ' m.fcontab' || v_sep   -- fechaContable
                                 || CHR(39) || CHR(39) || ' linea'
         || ' FROM SEGUROS s, TITULOPRO t, DETRECIBOS d, MOVRECIBO m, RECIBOS r, PRODUCTOS p, PREGUNPOLSEG ps, PARGARANPRO pg,'
         || ' DETPARAM dp, PARGARANPRO pg2, DETPARAM dp2, AGENTES a,'
         || ' per_personas pc, per_detper pc2,' || ' per_personas pp, per_detper pp2,'
         || ' per_personas pt, per_detper pt2,'
         || ' AGENTES a2, TOMADORES tom, AGENTES_COMP ac' || ' WHERE m.FMOVDIA between '
         || v_ini || ' and ' || v_fin
         || ' AND ( (m.cestrec = 1 ) OR (m.cestrec = 0 AND m.cestant = 1))'
         || ' AND r.nrecibo = m.nrecibo' || ' AND r.cestaux = 0'
         || ' AND r.ctiprec in (0, 1, 3, 9, 13, 15)' || ' AND s.sseguro = r.sseguro'
         || ' AND p.sproduc = s.sproduc' || ' AND a.cagente = s.cagente'
         || ' AND ac.cagente = s.cagente'
         || ' AND not exists (select 1 from detmovrecibo z1 where z1.nrecibo=r.nrecibo)'
         || ' AND t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect'
         || ' AND t.cidioma = ' || v_idi || ' AND tom.sseguro = s.sseguro'
         || ' AND pc.sperson = a.sperson' || ' and pc2.sperson=a.sperson'
         || ' and pc2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=a.sperson)'
         || ' AND pt.sperson = tom.sperson' || ' and pt2.sperson=tom.sperson'
         || ' and pt2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=tom.sperson)'
         || ' AND pp.sperson = a2.sperson' || ' and pp2.sperson=a2.sperson'
         || ' and pp2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=a2.sperson)'
         -- bug 26422 dcg 7-5-2013
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=r.nmovimi)'
         || ' AND ps.cpregun = 414 AND ps.SSEGURO=s.sseguro '
                                                             -- bug 26430/144927 - 23/05/2013 - JMF
         || ' AND d.nrecibo = r.nrecibo' || ' AND d.cconcep in (0,11,47,48,49)'
         || ' AND s.sproduc = pg.sproduc' || ' and pg.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi || ' AND pg.cvalpar = dp.cvalpar' || ' AND s.sproduc = pg2.sproduc'
         || ' and pg2.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam AND dp2.cidioma = '
         || v_idi || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' AND a2.cagente =  pac_redcomercial.f_busca_padre(' || v_emp
         || ',s.cagente,null,r.fefecto)' || ' group by s.sproduc, t.ttitulo, '
         || ' s.npoliza, s.ncertif, '
         || ' ps.crespue, dp.tvalpar, dp2.tvalpar,  p.cdivisa, trunc(r.FEMISIO), ac.CTIPINT, m.fcontab,'
         || ' r.nrecibo, PAC_INFORMES_152.f_desrec (' || v_idi
         || ',m.cestant,m.CESTREC,r.ctiprec)'
-------------------------
         || ' UNION '
-------------------------
         || ' SELECT ' || ' p.cdivisa||trunc(r.FEMISIO)||s.npoliza||s.ncertif orden,'
         || 's.sproduc' || v_sep || 't.ttitulo' || v_sep
         || 'max(pp.NNUMIDE||''-''||pp.TDIGITOIDE)' || v_sep
         || 'max(pp2.TAPELLI1||''-''||pp2.TAPELLI2)' || v_sep
         || 'max(pc.NNUMIDE||''-''||pc.TDIGITOIDE)' || v_sep
         || 'max(pc2.TAPELLI1||''-''||pc2.TAPELLI2)' || v_sep
         || 'max(pt.NNUMIDE||''-''||pt.TDIGITOIDE)' || v_sep
         || 'max(pt2.tnombre||'' ''||pt2.TAPELLI1||''-''||pt2.TAPELLI2)' || v_sep
         || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'r.nrecibo' || v_sep
         || 'PAC_INFORMES_152.f_desrec (' || v_idi || ',mr.cestant,mr.cestrec,r.ctiprec,1)'
         || v_sep   -- descripcion estado recibo
         -- bug 26430/144927 - 23/05/2013 - JMF
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0, -d.iconcep_monpol,0)),0)'
         || v_sep   -- Prima directa
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),0,sum(decode(d.cconcep, 0, -d.iconcep,0)),0)'
         || v_sep   -- Prima directaMO
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0, -d.iconcep_monpol,0)),0)'
         || v_sep   -- PrimaIntermediada,
         || 'decode(pac_propio.f_agentecorredor(ac.ctipint),1,sum(decode(d.cconcep, 0, -d.iconcep,0)),0)'
         || v_sep   -- PrimaIntermediadaMO
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(d.cconcep, 11, -d.iconcep_monpol,0), 0))'
         || v_sep   -- ComisionesAgentes,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(d.cconcep, 11, -d.iconcep,0), 0))'
         || v_sep   -- ComisionesAgentesMO
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(d.cconcep, 11, -d.iconcep_monpol,0), 0))'
         || v_sep   -- CostoIntermediacionDirecta,
         || 'sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(d.cconcep, 11, -d.iconcep,0), 0))'
         || v_sep   -- CostoIntermediacionDirectaMO
         || 'sum(decode(d.cconcep, 47, (-1)*d.iconcep_monpol,0))' || v_sep   -- ComisRecaudo,
         || 'sum(decode(d.cconcep, 47, (-1)*d.iconcep,0))' || v_sep   -- ComisRecaudoMO
         || 'sum(decode(d.cconcep, 49, (-1)*d.iconcep_monpol,0))'
         || v_sep   -- ComisAccPreferente,
                 || 'sum(decode(d.cconcep, 49, (-1)*d.iconcep,0))'
         || v_sep   -- ComisAccPreferenteMO
         || 'sum(decode(d.cconcep, 48, (-1)*d.iconcep_monpol,0))' || v_sep   -- ComisUsoCanal,
         || 'sum(decode(d.cconcep, 48, (-1)*d.iconcep,0))' || v_sep   -- ComisUsoCanalMO
         || 'ps.crespue' || v_sep   -- KeiraLinNegocio,
                                 || 'dp.tvalpar' || v_sep   -- Keira,
                                                         || 'dp2.tvalpar' || v_sep   -- SubKeira,
         -- bug 26430/144927 - 23/05/2013 - JMF
         --|| 'p.cdivisa' || v_sep
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep || 'trunc(r.FEMISIO)' || v_sep   -- fecha emision
         || ' m.fcontab' || v_sep   -- fechaContable
                                 || CHR(39) || CHR(39) || ' linea'
         || ' FROM SEGUROS s, TITULOPRO t, DETRECIBOS d, DETMOVRECIBO m, RECIBOS r, PRODUCTOS p, PREGUNPOLSEG ps, PARGARANPRO pg,'
         || ' DETPARAM dp, PARGARANPRO pg2, DETPARAM dp2, AGENTES a,'
         || ' per_personas pc, per_detper pc2,' || ' per_personas pp, per_detper pp2,'
         || ' per_personas pt, per_detper pt2,'
         || ' AGENTES a2, TOMADORES tom, AGENTES_COMP ac, movrecibo mr' || ' WHERE 1=1'
         --|| ' and mr.FMOVDIA between ' || v_ini || ' and ' || v_fin
         || ' and trunc(m.FMOVIMI) between ' || v_ini || ' and ' || v_fin
         || ' AND r.nrecibo = mr.nrecibo' || ' AND r.cestaux = 0'
         || ' AND r.ctiprec in (0, 1, 3, 9, 13, 15)' || ' AND s.sseguro = r.sseguro'
         || ' AND p.sproduc = s.sproduc' || ' AND a.cagente = s.cagente'
         || ' AND ac.cagente= s.cagente' || ' AND m.nrecibo = r.nrecibo'
         || ' AND m.norden = 1' || ' AND tom.sseguro = s.sseguro'
         || ' and mr.smovrec=m.smovrec'
         || ' AND t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect'
         || ' AND t.cidioma = ' || v_idi
         -- bug 26422 dcg 7-5-2013
         -- || ' AND ps.nmovimi = r.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=r.nmovimi)'
         || ' AND ps.cpregun = 414 AND ps.SSEGURO=s.sseguro '
                                                             -- bug 26430/144927 - 23/05/2013 - JMF
         || ' AND d.nrecibo = r.nrecibo' || ' AND d.cconcep in (0,11,47,48,49)'
         || ' AND pg.sproduc = s.sproduc' || ' AND pg.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi || ' AND pg.cvalpar = dp.cvalpar' || ' AND s.sproduc = pg2.sproduc'
         || ' AND pg2.CACTIVI = s.cactivi'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam AND dp2.cidioma = '
         || v_idi || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' AND a2.cagente =  pac_redcomercial.f_busca_padre(' || v_emp
         || ',s.cagente,null,r.fefecto)' || ' AND pc.sperson = a.sperson'
         || ' and pc2.sperson=a.sperson'
         || ' and pc2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=a.sperson)'
         || ' AND pt.sperson = tom.sperson' || ' and pt2.sperson=tom.sperson'
         || ' and pt2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=tom.sperson)'
         || ' AND pp.sperson = a2.sperson' || ' and pp2.sperson=a2.sperson'
         || ' and pp2.FMOVIMI=(select max(pc22.FMOVIMI) from per_detper pc22 where pc22.sperson=a2.sperson)'
         || ' group by s.sproduc, t.ttitulo, s.npoliza, s.ncertif, '
         || ' ps.crespue, dp.tvalpar, dp2.tvalpar,  p.cdivisa, trunc(r.FEMISIO), ac.CTIPINT, m.fcontab,'
         || ' r.nrecibo, PAC_INFORMES_152.f_desrec (' || v_idi
         || ',mr.cestant,mr.CESTREC,r.ctiprec,1)' || ' order by 1' || ')';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_862_det;

   /******************************************************************************************
     Descripció: Cabecera del map 863 Listado de Reaseguro
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/144927 - 23/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_863_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_863_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_aux          VARCHAR2(32000);
      v_idioma       NUMBER;
   BEGIN
      SELECT NVL(NVL(MAX(nvalpar), f_usu_idioma), 3)
        INTO v_idioma
        FROM parinstalacion
       WHERE cparame = 'IDIOMARTF';

      v_ttexto := 'SELECT ' || CHR(39);
      v_aux := CHR(10) || f_axis_literales(9905298, v_idioma) || v_sep
               || TO_CHAR(TO_DATE(LPAD(fecha_desde, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy')
               || ' - '
               || TO_CHAR(TO_DATE(LPAD(fecha_hasta, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy');
      v_ttexto := v_ttexto || v_aux;
      v_aux := CHR(10) || CHR(10) || f_axis_literales(100829, v_idioma) || v_sep
               || f_axis_literales(1000307, v_idioma) || v_sep
               || f_axis_literales(9903067, v_idioma) || ' '
               || f_axis_literales(9905326, v_idioma) || v_sep
               || f_axis_literales(9905326, v_idioma) || v_sep
               || f_axis_literales(9903067, v_idioma) || ' '
               || f_axis_literales(9000752, v_idioma) || v_sep
               || f_axis_literales(9000752, v_idioma) || v_sep
               || f_axis_literales(9001639, v_idioma) || v_sep
               || f_axis_literales(104595, v_idioma) || v_sep
               -- BUG 26430/147498 - FAL - 27/6/2013
               || f_axis_literales(800636, v_idioma) || v_sep
               || f_axis_literales(100587, v_idioma) || v_sep
               -- FI BUG 26430/147498
               || f_axis_literales(104820, v_idioma) || v_sep   -- Prima cedida
               || f_axis_literales(9905327, v_idioma) || v_sep   -- Descuento Cesión
               || f_axis_literales(9905328, v_idioma) || v_sep   -- Prima Proyectada por Pagar
               || f_axis_literales(9905323, v_idioma) || v_sep
               || f_axis_literales(9905324, v_idioma) || v_sep
               || f_axis_literales(9905325, v_idioma) || v_sep
               || f_axis_literales(108645, v_idioma) || v_sep
               || f_axis_literales(1000562, v_idioma) || v_sep   -- Fecha emisión
               || f_axis_literales(1000575, v_idioma) || v_sep
               || f_axis_literales(104820, v_idioma) || ' MO' || v_sep   -- Prima cedida MO
               || f_axis_literales(9905327, v_idioma) || ' MO' || v_sep   -- Descuento Cesión MO
               || f_axis_literales(9905328, v_idioma) || ' MO'
               || v_sep   -- Prima Proyectada por Pagar MO
                       || '';
      v_ttexto := v_ttexto || v_aux || CHR(39) || ' linea from dual';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_863_cab;

   /******************************************************************************************
     Descripció: Detalle del map 863 Listado de Reaseguro
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/144927 - 23/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_863_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_863_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   BEGIN
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY'')';
      v_idi := f_usu_idioma;
      v_ttexto :=
         ' SELECT   producto' || v_sep || ' nombre ' || v_sep
         || ' idereasegura || ''-'' || rutreasegura' || v_sep || ' reasegura ' || v_sep
         || ' idebroker || ''-'' || rutbroker ' || v_sep || ' broker ' || v_sep || ' poliza '
         || v_sep || ' certificado ' || v_sep || ' nrecibo ' || v_sep || ' estadorec '
         || v_sep || ' cedida ' || v_sep || ' cesion ' || v_sep || ' proyectada' || v_sep
         || ' klineanegocio ' || v_sep || ' keira ' || v_sep || ' subkeira ' || v_sep
         || ' moneda ' || v_sep || ' fecemi ' || v_sep || ' fecha ' || v_sep || ' cedidaMO '
         || v_sep || ' cesionMO ' || v_sep || ' proyectadaMO' || v_sep || CHR(39) || CHR(39)
         || ' linea' || ' from('
         -- 1 de 4
         || 'select s.sproduc producto,t.ttitulo nombre,pp.NNUMIDE idereasegura,pp.TDIGITOIDE rutreasegura,'
         || ' c.tcompani reasegura,pe.NNUMIDE idebroker,pe.TDIGITOIDE rutbroker,br.tcompani broker,'
         || ' s.npoliza poliza,s.ncertif certificado,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec) estadorec,'
         || ' '
         || ' sum(nvl(((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres= 16 and cparam=''MONEDACONTAB'')'
         || ' ,r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)), -1,'
         || ' (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)* rs.nfactor,0),1)'
         || ' + (pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),r.femisio,'
         || ' NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),-1,'
         || ' (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)'
         || ' * pac_propio.f_comi_ces(cc.ccomrea, s.sseguro, ce.cgarant,cc.pctcomis, r.femisio)/10000)* rs.nfactor,0),1)))*'
         || ' DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1) ),0)) cedida,'
         || ' '
         || ' sum(nvl(((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),r.femisio,'
         || ' NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),-1,'
         || ' (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)'
         || ' *pac_propio.f_comi_ces(cc.ccomrea, s.sseguro, ce.cgarant,cc.pctcomis, r.femisio)/10000)* rs.nfactor,0),1))*'
         || ' DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1)),0)) cesion,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB'')'
         || ' ,r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1, (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/100)* rs.nfactor,0),1)*DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1)),0)) proyectada,'
         || ' ' || ' ps.crespue klineanegocio,dp.tvalpar keira,dp2.tvalpar subkeira,'
         --|| ' pr.cdivisa moneda,'
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=pr.cdivisa) moneda,' || ' trunc(r.FEMISIO) fecemi,'
         || ' trunc(m.fcontab) fecha,' || ' '
         || ' f_round(SUM((NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),'
         || ' cc.pcesion),cc.pcesion)/ 100)* rs.nfactor,0)'
         || ' + NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),'
         || ' cc.pcesion),cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,'
         || ' r.femisio)/ 10000)* rs.nfactor,0))* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1) ), pr.cdivisa) CEDIDAMO,'
         || ' '
         || ' f_round(sum(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,r.femisio)/ 10000)* rs.nfactor,'
         || ' 0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1)), pr.cdivisa) CESIONMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1)), pr.cdivisa) PROYECTADAMO'
         || ' ' || ' from  seguros s, tramos tr, recibos r, cuadroces cc,'
         || ' (select icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra, ce.cgarant,'
         || ' ce.sfacult, ce.nmovimi, ce.scesrea from cesionesrea ce, tramos tr where tr.scontra=ce.scontra'
         || ' and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo and ce.fefecto <> ce.fvencim) ce,'
         || ' movrecibo m, reasegemi rs, detreasegemi drs, productos pr, companias c,'
         || ' pregunpolseg ps, pargaranpro pg, detparam dp,pargaranpro pg2,detparam dp2,'
         || ' titulopro t, per_personas pp, per_personas pe, companias br'
         || ' where cc.ctramo=tr.ctramo'
                                        -- ini jmf 2-10-2013
         || ' and rs.sreaemi = drs.sreaemi' || ' and drs.scesrea = ce.scesrea'
         || ' and drs.cgarant = ce.cgarant' || ' and s.sseguro=r.sseguro'
         -- fin jmf 2-10-2013
         || ' and t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect and t.cidioma ='
         || v_idi
         || ' and c.sperson = pp.SPERSON and br.ccompani = cc.CCORRED and br.sperson = pe.sperson'
         || ' and m.nrecibo=r.nrecibo and cc.scontra=tr.scontra and cc.nversio=tr.nversio and tr.scontra=ce.scontra'
         || ' and tr.nversio = ce.nversio and tr.ctramo=ce.ctramo and s.sseguro=ce.sseguro'
         || ' and s.sseguro = rs.sseguro and m.nrecibo=rs.nrecibo'
         || ' and (((m.cestrec = 0 and rs.cmotces = 1) or (m.cestrec = 2 and m.cestant = 0 and rs.cmotces = 2))'
         || ' or (((m.cestrec = 0 and m.cestant = 1  and rs.cmotces = 2) or (m.cestrec = 1 and rs.cmotces = 1))'
         || ' and not exists (select ''1'' from detmovrecibo dm where dm.nrecibo = r.nrecibo)))'
         || ' and s.cramo = pr.cramo and s.cmodali = pr.cmodali and s.ctipseg = pr.ctipseg and s.ccolect = pr.ccolect'
         || ' and c.ccompani = cc.ccompani and ps.sseguro = s.sseguro'
         -- bug 26422 dcg 7-5-2013
         --|| ' and ps.nmovimi = ce.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=ce.nmovimi)'
         || ' and ps.cpregun = 414'
         || ' and s.cramo = pg.cramo and s.cmodali = pg.cmodali and s.ctipseg = pg.ctipseg and s.ccolect = pg.ccolect'
         || ' and s.cactivi = pg.cactivi and s.sproduc = pg.sproduc and pg.cpargar = ''SUBCLAKEIRA'' and ce.cgarant = pg.cgarant'
         || ' and pg.cpargar = dp.cparam and dp.cidioma = ' || v_idi
         || ' and pg.cvalpar = dp.cvalpar and s.cmodali = pg2.cmodali and s.ctipseg = pg2.ctipseg'
         || ' and s.ccolect = pg2.ccolect and s.cactivi = pg2.cactivi and s.sproduc = pg2.sproduc'
         || ' and pg2.cpargar = ''CLAKEIRARAMO'' and ce.cgarant = pg2.cgarant and pg2.cpargar = dp2.cparam'
         || ' and dp2.cidioma = ' || v_idi || ' and pg2.cvalpar = dp2.cvalpar'
         -- bug 26430/144927 - 23/05/2013 - JMF
         --|| ' and m.fcontab between ' || v_ini || ' and ' || v_fin
         -- jmf 27-09-2013
         || ' and trunc(m.fmovdia) between ' || v_ini || ' and ' || v_fin
         || ' group by s.sproduc,t.ttitulo,pp.NNUMIDE,pp.TDIGITOIDE,c.tcompani,'
         || ' pe.NNUMIDE,pe.TDIGITOIDE,br.tcompani, s.npoliza,s.ncertif,r.nrecibo,PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec),ps.crespue,dp.tvalpar,'
         || ' dp2.tvalpar,pr.cdivisa,trunc(r.FEMISIO),trunc(m.fcontab)'
--------------------------------------------
         || ' UNION '   -- 2 de 4
--------------------------------------------
         || ' select s.sproduc producto,t.ttitulo nombre,pp.NNUMIDE idereasegura,pp.TDIGITOIDE rutreasegura,'
         || ' c.tcompani reasegura,pe.NNUMIDE idebroker,pe.TDIGITOIDE rutbroker,br.tcompani broker,'
         || ' s.npoliza poliza,s.ncertif certificado,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec) estadorec,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1, (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)* rs.nfactor,0),1)'
         || ' + (pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi || ' and cmoneda = pr.cdivisa)'
         || ' ,(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),r.femisio,'
         || ' NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1, (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)'
         || ' *pac_propio.f_comi_ces(cc.ccomrea, s.sseguro, ce.cgarant,cc.pcomisi, r.femisio)/10000)* rs.nfactor,0),1)))*'
         || ' DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1) ,0)) cedida,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)'
         || ' *pac_propio.f_comi_ces(cc.ccomrea, s.sseguro, ce.cgarant,cc.pcomisi, r.femisio)/10000)* rs.nfactor,0),1))'
         || ' * DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1),0)) cesion,'
         || ' '
         || ' sum(nvl(pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)*'
         || ' rs.nfactor,0),1)* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec,0,1,-1),0)) proyectada,'
         || ' ps.crespue klineanegocio,dp.tvalpar keira,dp2.tvalpar subkeira,'
         --|| ' pr.cdivisa moneda,'
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=pr.cdivisa) moneda,' || ' trunc(r.FEMISIO) fecemi,'
         || ' trunc(m.fcontab) fecha,' || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),'
         || ' cc.pcesion),cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi,r.femisio)'
         || ' / 10000)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1)), pr.cdivisa) CEDIDAMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi,r.femisio)'
         || ' / 10000)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1)), pr.cdivisa) CESIONMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces * tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal * tr.imaxplo)/((ce.icapces * tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 0, 1, -1)), pr.cdivisa) PROYECTADAMO'
         || ' ' || ' from  seguros s, tramos tr, recibos r, cuacesfac cc,'
         || ' (select icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
         || ' ce.nmovimi, ce.scesrea from cesionesrea ce, tramos tr where tr.scontra=ce.scontra'
         || ' and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo and ce.fefecto <> ce.fvencim) ce,'
         || ' movrecibo m, reasegemi rs, detreasegemi drs, productos pr,  companias c, pregunpolseg ps, pargaranpro pg,'
         || ' detparam dp,pargaranpro pg2,detparam dp2, titulopro t, per_personas pp, per_personas pe, companias br'
         || ' where m.nrecibo=r.nrecibo and cc.sfacult = ce.sfacult and tr.scontra=ce.scontra'
         || ' and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo'
         -- jmf 2-10-2013
         || ' and rs.sreaemi = drs.sreaemi' || ' and drs.scesrea = ce.scesrea'
         || ' and drs.cgarant = ce.cgarant' || ' and s.sseguro=r.sseguro'
         -- fin jmf 2-10-2013
         || ' and t.cramo = s.cramo  and t.cmodali = s.cmodali and t.ctipseg = s.ctipseg  and t.ccolect = s.ccolect and t.cidioma ='
         || v_idi
         || ' and c.sperson = pp.SPERSON and br.ccompani = cc.CCORRED and br.sperson = pe.sperson'
         || ' and s.sseguro=ce.sseguro and s.sseguro = rs.sseguro and m.nrecibo=rs.nrecibo'
         || ' and (((m.cestrec = 0 and rs.cmotces = 1) or (m.cestrec = 2 and m.cestant = 0 and rs.cmotces = 2))'
         || ' or (((m.cestrec = 0 and m.cestant = 1  and rs.cmotces = 2) or (m.cestrec = 1 and rs.cmotces = 1))'
         || ' and not exists (select ''1'' from detmovrecibo dm where dm.nrecibo = r.nrecibo)))'
         || ' and s.cramo = pr.cramo and s.cmodali = pr.cmodali and s.ctipseg = pr.ctipseg'
         || ' and s.ccolect = pr.ccolect and c.ccompani = cc.ccompani and ps.sseguro = s.sseguro'
         -- bug 26422 dcg 7-5-2013
         -- || ' and ps.nmovimi = ce.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=ce.nmovimi)'
         || ' and ps.cpregun = 414' || ' and s.cramo = pg.cramo and s.cmodali = pg.cmodali'
         || ' and s.ctipseg = pg.ctipseg and s.ccolect = pg.ccolect and s.cactivi = pg.cactivi'
         || ' and s.sproduc = pg.sproduc and pg.cpargar = ''SUBCLAKEIRA'' and ce.cgarant = pg.cgarant'
         || ' and pg.cpargar = dp.cparam and dp.cidioma =' || v_idi
         || ' and pg.cvalpar = dp.cvalpar and s.cmodali = pg2.cmodali and s.ctipseg = pg2.ctipseg'
         || ' and s.ccolect = pg2.ccolect and s.cactivi = pg2.cactivi and s.sproduc = pg2.sproduc'
         || ' and pg2.cpargar = ''CLAKEIRARAMO'' and ce.cgarant = pg2.cgarant and pg2.cpargar = dp2.cparam'
         || ' and dp2.cidioma =' || v_idi || ' and pg2.cvalpar = dp2.cvalpar'
         -- bug 26430/144927 - 23/05/2013 - JMF
         --|| ' and m.fcontab between ' || v_ini || ' and ' || v_fin
         -- jmf 27-09-2013
         || ' and trunc(m.fmovdia) between ' || v_ini || ' and ' || v_fin
         || ' group by s.sproduc,t.ttitulo,pp.NNUMIDE,pp.TDIGITOIDE,c.tcompani, pe.NNUMIDE,pe.TDIGITOIDE,'
         || ' br.tcompani, s.npoliza,s.ncertif,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec),ps.crespue,dp.tvalpar,dp2.tvalpar,pr.cdivisa,trunc(r.FEMISIO),trunc(m.fcontab)'
--------------------------------------------
         || ' UNION '   -- 3 de 4
--------------------------------------------
         || ' select s.sproduc producto,t.ttitulo nombre,pp.NNUMIDE idereasegura,pp.TDIGITOIDE rutreasegura,'
         || ' c.tcompani reasegura,pe.NNUMIDE idebroker,pe.TDIGITOIDE rutbroker,br.tcompani broker,'
         || ' s.npoliza poliza,s.ncertif certificado,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec) estadorec,'
         || ' '
         || ' sum( nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)* rs.nfactor,0),1)'
         || ' + (pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres = '
         || v_emp
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)*'
         || ' pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,r.femisio)/10000)* rs.nfactor,0),1)))* DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) cedida,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = 3 and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),r.femisio,'
         || ' NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)*'
         || ' pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,r.femisio)/10000)* rs.nfactor,0),1))* DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) cesion,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),r.femisio,'
         || ' NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)* rs.nfactor,0),1))*'
         || ' DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) proyectada,' || ' '
         || ' ps.crespue klineanegocio,dp.tvalpar keira,dp2.tvalpar subkeira,'
         --|| ' pr.cdivisa moneda,'
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=pr.cdivisa) moneda,' || ' trunc(r.FEMISIO) fecemi,'
         || ' trunc(dv.fcontab) fecha,' || ' '
         || ' f_round(SUM((NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)' || ' +'
         || ' NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,r.femisio)'
         || ' / 10000)* rs.nfactor,0))* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) CEDIDAMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pctcomis,r.femisio)'
         || ' / 10000)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) CESIONMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) PROYECTADAMO'
         || ' ' || ' from  seguros s, tramos tr, recibos r, cuadroces cc,'
         || ' (select icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra, ce.cgarant,'
         || ' ce.sfacult, ce.nmovimi, ce.scesrea from cesionesrea ce, tramos tr where tr.scontra=ce.scontra'
         || ' and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo and ce.fefecto <> ce.fvencim) ce,'
         || ' detmovrecibo dv, reasegemi rs, detreasegemi drs, productos pr,  companias c, pregunpolseg ps, pargaranpro pg,'
         || ' detparam dp,pargaranpro pg2,detparam dp2, titulopro t, per_personas pp, per_personas pe, companias br, movrecibo m'
         || ' where dv.nrecibo = r.nrecibo and m.nrecibo = r.nrecibo and m.smovrec = dv.smovrec and dv.norden = 1 and cc.ctramo=tr.ctramo'
         || ' and t.cramo = s.cramo  and t.cmodali = s.cmodali and t.ctipseg = s.ctipseg  and t.ccolect = s.ccolect and t.cidioma ='
         || v_idi
         || ' and c.sperson = pp.SPERSON and br.ccompani = cc.CCORRED and br.sperson = pe.sperson'
         || ' and dv.nrecibo=rs.nrecibo and rs.cmotces = 1 and cc.scontra=tr.scontra'
         || ' and cc.nversio=tr.nversio and tr.scontra=ce.scontra and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo'
         || ' and s.sseguro=ce.sseguro and s.sseguro = rs.sseguro and s.cramo = pr.cramo and s.cmodali = pr.cmodali'
         || ' and s.ctipseg = pr.ctipseg and s.ccolect = pr.ccolect and c.ccompani = cc.ccompani'
         || ' and ps.sseguro = s.sseguro'
                                         -- jmf 2-10-2013
         || ' and rs.sreaemi = drs.sreaemi' || ' and drs.scesrea = ce.scesrea'
         || ' and drs.cgarant = ce.cgarant' || ' and s.sseguro=r.sseguro'
         -- fin jmf 2-10-2013
         -- bug 26422 dcg 7-5-2013
         --|| ' and ps.nmovimi = ce.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=ce.nmovimi)'
         || ' and ps.cpregun = 414' || ' and s.cramo = pg.cramo'
         || ' and s.cmodali = pg.cmodali and s.ctipseg = pg.ctipseg and s.ccolect = pg.ccolect'
         || ' and s.cactivi = pg.cactivi and s.sproduc = pg.sproduc and pg.cpargar = ''SUBCLAKEIRA'' and ce.cgarant = pg.cgarant'
         || ' and pg.cpargar = dp.cparam and dp.cidioma = ' || v_idi
         || ' and pg.cvalpar = dp.cvalpar and s.cmodali = pg2.cmodali and s.ctipseg = pg2.ctipseg'
         || ' and s.ccolect = pg2.ccolect and s.cactivi = pg2.cactivi and s.sproduc = pg2.sproduc'
         || ' and pg2.cpargar = ''CLAKEIRARAMO'' and ce.cgarant = pg2.cgarant and pg2.cpargar = dp2.cparam'
         || ' and dp2.cidioma = ' || v_idi || ' and pg2.cvalpar = dp2.cvalpar'
         -- bug 26430/144927 - 23/05/2013 - JMF
           --|| ' and dv.fcontab between ' || v_ini || ' and ' || v_fin
         -- jmf 27-09-2013
         --|| ' and trunc(m.fmovdia) between ' || v_ini || ' and ' || v_fin
         || ' and trunc(dv.FMOVIMI) between ' || v_ini || ' and ' || v_fin
         || ' group by s.sproduc,t.ttitulo,pp.NNUMIDE,pp.TDIGITOIDE,c.tcompani,'
         || ' pe.NNUMIDE,pe.TDIGITOIDE,br.tcompani, s.npoliza,s.ncertif,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec),ps.crespue,dp.tvalpar,'
         || ' dp2.tvalpar,pr.cdivisa,trunc(r.FEMISIO),trunc(dv.fcontab)'
--------------------------------------------
         || ' UNION'   -- 4 de 4
--------------------------------------------
         || ' select s.sproduc producto,t.ttitulo nombre,pp.NNUMIDE idereasegura,pp.TDIGITOIDE rutreasegura,'
         || ' c.tcompani reasegura,pe.NNUMIDE idebroker,pe.TDIGITOIDE rutbroker,br.tcompani broker,'
         || ' s.npoliza poliza,s.ncertif certificado,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec) estadorec,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma ='
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion),cc.pcesion)/100)* rs.nfactor,0),1)'
         || ' + (pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB'')'
         || ' ,r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1, (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)*'
         || ' pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi, r.femisio)/10000)* rs.nfactor,0),1)))* DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) cedida,'
         || ' '
         || ' sum(nvl((pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi || ' and cmoneda = pr.cdivisa),'
         || ' (select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16 and cparam=''MONEDACONTAB''),'
         || ' r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)*'
         || ' pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi,r.femisio)/10000)* rs.nfactor,0),1))* DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) cesion,'
         || ' '
         || ' sum(nvl(pac_eco_tipocambio.f_importe_cambio((select cmonint from monedas where cidioma = '
         || v_idi
         || ' and cmoneda = pr.cdivisa),(select pac_monedas.f_cmoneda_t(nvalpar) from parempresas where cempres=16'
         || ' and cparam=''MONEDACONTAB''),r.femisio,NVL((ce.icesion*DECODE (tr.ctramo,1,DECODE(SIGN((ce.icapces*tr.plocal/100)-NVL(tr.imaxplo,0)),'
         || ' -1, (cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces*tr.plocal)/100))))/(100-tr.plocal),cc.pcesion), cc.pcesion)/100)*'
         || ' rs.nfactor,0),1)* DECODE(r.ctiprec, 9, -1, 13, -1, 1),0)) * (-1) proyectada,'
         || ' ' || ' ps.crespue klineanegocio,dp.tvalpar keira,dp2.tvalpar subkeira,'
         --||  ' pr.cdivisa moneda,'
         || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=pr.cdivisa) moneda,' || ' trunc(r.FEMISIO) fecemi,'
         || ' trunc(dv.fcontab) fecha,' || ' '
         || ' f_round(SUM((NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)' || ' +'
         || ' NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi,r.femisio)'
         || ' / 10000)* rs.nfactor,0))* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) CEDIDAMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces* tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal* tr.imaxplo)/((ce.icapces* tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)* pac_propio.f_comi_ces(cc.ccomrea,s.sseguro,ce.cgarant,cc.pcomisi,r.femisio)'
         || ' / 10000)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) CESIONMO,'
         || ' '
         || ' f_round(SUM(NVL((ce.icesion* DECODE(tr.ctramo,1, DECODE(SIGN((ce.icapces * tr.plocal / 100)- NVL(tr.imaxplo, 0)),'
         || ' -1,(cc.pcesion*(100-((tr.plocal * tr.imaxplo)/((ce.icapces * tr.plocal)/ 100))))/(100 - tr.plocal),cc.pcesion),'
         || ' cc.pcesion)/ 100)* rs.nfactor,0)* DECODE(r.ctiprec, 9, -1, 13, -1, 1)*(-1) ), pr.cdivisa) proyectadaMO'
         || ' ' || ' from  seguros s, tramos tr, recibos r, cuacesfac cc,'
         || ' (select icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
         || ' ce.nmovimi, ce.scesrea from cesionesrea ce, tramos tr where tr.scontra=ce.scontra'
         || ' and tr.nversio=ce.nversio and tr.ctramo=ce.ctramo and ce.fefecto <> ce.fvencim) ce,'
         || ' detmovrecibo dv, reasegemi rs, detreasegemi drs, productos pr,  companias c, pregunpolseg ps, pargaranpro pg,'
         || ' detparam dp,pargaranpro pg2,detparam dp2, TITULOPRO t, per_personas pp, per_personas pe, companias br, movrecibo m'
         || ' where dv.nrecibo = r.nrecibo and m.nrecibo = r.nrecibo and m.smovrec = dv.smovrec and dv.norden = 1 and dv.nrecibo=rs.nrecibo and rs.cmotces = 1'
         || ' and cc.sfacult = ce.sfacult and tr.scontra=ce.scontra and tr.nversio=ce.nversio'
         || ' and tr.ctramo=ce.ctramo and t.cramo = s.cramo  and t.cmodali = s.cmodali and t.ctipseg = s.ctipseg and t.cidioma ='
         || v_idi
         || ' and t.ccolect = s.ccolect and c.sperson = pp.SPERSON and br.ccompani = cc.CCORRED'
         || ' and br.sperson = pe.sperson and s.sseguro=ce.sseguro and s.sseguro = rs.sseguro and s.cramo = pr.cramo'
         || ' and s.cmodali = pr.cmodali and s.ctipseg = pr.ctipseg and s.ccolect = pr.ccolect'
         || ' and c.ccompani = cc.ccompani and ps.sseguro = s.sseguro'
         -- bug 26422 dcg 7-5-2013
         -- || ' and ps.nmovimi = ce.nmovimi'
         -- jmf 2-10-2013
         || ' and rs.sreaemi = drs.sreaemi' || ' and drs.scesrea = ce.scesrea'
         || ' and drs.cgarant = ce.cgarant' || ' and s.sseguro=r.sseguro'
         -- fin jmf 2-10-2013
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=ce.nmovimi)'
         || ' and ps.cpregun = 414'
         || ' and s.cramo = pg.cramo and s.cmodali = pg.cmodali and s.ctipseg = pg.ctipseg'
         || ' and s.ccolect = pg.ccolect and s.cactivi = pg.cactivi and s.sproduc = pg.sproduc'
         || ' and pg.cpargar = ''SUBCLAKEIRA'' and ce.cgarant = pg.cgarant and pg.cpargar = dp.cparam'
         || ' and dp.cidioma = ' || v_idi
         || ' and pg.cvalpar = dp.cvalpar and s.cmodali = pg2.cmodali'
         || ' and s.ctipseg = pg2.ctipseg and s.ccolect = pg2.ccolect and s.cactivi = pg2.cactivi'
         || ' and s.sproduc = pg2.sproduc and pg2.cpargar = ''CLAKEIRARAMO'' and ce.cgarant = pg2.cgarant'
         || ' and pg2.cpargar = dp2.cparam and dp2.cidioma = ' || v_idi
         || ' and pg2.cvalpar = dp2.cvalpar'
                                                                               -- bug 26430/144927 - 23/05/2013 - JMF
                                                                               --|| ' and dv.fcontab between ' || v_ini || ' and '|| v_fin
                                                                               -- jmf 27-09-2013
                                            --|| ' and trunc(m.fmovdia) between ' || v_ini || ' and ' || v_fin
         || ' and trunc(dv.FMOVIMI) between ' || v_ini || ' and ' || v_fin
         || ' group by s.sproduc,t.ttitulo,pp.NNUMIDE,pp.TDIGITOIDE,c.tcompani,'
         || ' pe.NNUMIDE,pe.TDIGITOIDE,br.tcompani, s.npoliza,s.ncertif,r.nrecibo, PAC_INFORMES_152.f_desrec(3, m.cestant, m.cestrec, r.ctiprec),ps.crespue,'
         || ' dp.tvalpar,dp2.tvalpar,pr.cdivisa,trunc(r.FEMISIO),trunc(dv.fcontab))'
         || ' order by moneda, fecemi, poliza, certificado ';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_863_det;

-- FI BUG 26430/147498 - FAL - 26/6/2013

   /******************************************************************************************
     Descripció: Cabece    ra del map 864 Listado de Producción por Póliza RRC Directa
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_864_cab(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_864_CAB';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' p=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      --BUG36502:DCG:13/07/2015:Inici Se incluyen literales 9908059 y 9906747
      --BUG39207:JMT:15/02/2016: Se incluyen literales 100649 y 140424
      v_ttexto :=
         'SELECT
                f_axis_literales(100829  ,x.idi) || '';'' ||
                f_axis_literales(1000307 ,x.idi) || '';'' ||
                f_axis_literales(9001639 ,x.idi) || '';'' ||
                f_axis_literales(104595  ,x.idi) || '';'' ||
                f_axis_literales(9908059  ,x.idi) || '';'' ||
                f_axis_literales(111838  ,x.idi) || '';'' ||
                f_axis_literales(100649  ,x.idi) || '';'' ||
                f_axis_literales(140424  ,x.idi) || '';'' ||
                f_axis_literales(9906747  ,x.idi) || '';'' ||
                f_axis_literales(9907579  ,x.idi) || '';'' ||
                f_axis_literales(9905121 ,x.idi) || '';'' ||
                f_axis_literales(100587  ,x.idi) || '';'' ||
                f_axis_literales(108645  ,x.idi) || '';'' ||
                f_axis_literales(152604  ,x.idi) || '';'' ||
                f_axis_literales(1000575  ,x.idi) || '';'' ||
                f_axis_literales(9903427  ,x.idi) || '';'' ||
                f_axis_literales(9903429  ,x.idi) || '';'' ||
                f_axis_literales(100712  ,x.idi) || '';'' ||
                f_axis_literales(9903879  ,x.idi) || '';'' ||
                '' '' linea
                FROM (SELECT NVL(f_usu_idioma, 1) idi FROM DUAL) x, DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_864_cab;

   /******************************************************************************************
     Descripció: Detalle del map 864 Listado de Producción por Póliza RRC Directa
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_864_det(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_864_DET';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' p=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      d_hasta        DATE;
      v_cal          VARCHAR2(100);   -- Fecha calculo rrc
      v_est          VARCHAR2(100);   -- Estado Vigente
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_proces       NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      --v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      -- Buscar fecha calculo, ultimo dia del mes que se quiere obtener
      v_ntraza := 150;
      v_cal := 'TO_DATE(' || CHR(39)
               || TO_CHAR(LAST_DAY(TO_DATE(p_fecha, 'DDMMYYYY')), 'ddmmyyyy') || CHR(39)
               || ', ''DDMMYYYY'')';

      IF p_sproces IS NULL THEN
         -- Venimos de la pantalla de listados, buscamos ultimo proceso de real
         SELECT NVL(MAX(sproces), -1)
           INTO v_proces
           FROM rrc_sam
          WHERE fcalcul = LAST_DAY(TO_DATE(p_fecha, 'DDMMYYYY'));

         -- ini bug: 26422/151994
         -- Si no encuentra en REAL buscamos en el PREVIO
         IF v_proces IS NULL THEN
            SELECT NVL(MAX(sproces), -1)
              INTO v_proces
              FROM rrc_sam_previo
             WHERE fcalcul = LAST_DAY(TO_DATE(p_fecha, 'DDMMYYYY'));
         END IF;
      -- Fin bug: 26422/151994
      ELSE
         v_proces := p_sproces;
      END IF;

      v_ntraza := 170;
      v_ttexto :=
         'SELECT ' || 'sproduc' || v_sep || 'ttitulo' || v_sep || 'npoliza' || v_sep
         || 'ncertif' || v_sep || 'estpol' || v_sep || 'nrecibo' || v_sep
         || 'nriesgo' || v_sep || 'plan' || v_sep --BUG39207:JMT:15/02/2016
         || 'tgarant' || v_sep
         || 'iconcep' || v_sep || 'importe' || v_sep || 'estado' || v_sep || 'moneda' || v_sep
         || 'to_char(fefecto,''DD/MM/RRRR'')' || v_sep || 'to_char(fprofin,''DD/MM/RRRR'')'
         || v_sep || 'to_char(fefectopol,''DD/MM/RRRR'')' || v_sep
         || 'to_char(ffinvig,''DD/MM/RRRR'') ' || v_sep || 'forpag ' || v_sep || 'diasgracia'
         || ' linea' || ' FROM ('
-------------------------------------------------------------------
         || ' select s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo,'
         || ' sum(f_round(nvl(p.iprirrc, 0),p.cmoneda)) importe,'
                                                                 --|| ' sum(f_round(nvl(p.iprirrc,0)-PAC_INFORMES_152.f_caliva (p.nrecibo,p.CGARANT, p.NRIESGO) ,p.cmoneda)) importe,' --bug: 26422/151994
         || ' ff_desvalorfijo(383,' || v_idi || ',f_cestrec_mv(p.nrecibo,' || v_idi
         || ')) estado,' || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cmoneda) moneda,' || ' r.fefecto fefecto,' || ' s1.fprofin,'
         || ' s.fefecto fefectopol,' || 'nvl(s.fvencim, s.fcaranu-1) ffinvig,'
         || ' (SELECT TATRIBU FROM DETVALORES WHERE CVALOR = 17 AND CIDIOMA =' || v_idi
         || ' AND CATRIBU = s.cforpag) forpag,'
         || ' pac_propio_colm.f_numdias_periodo_gracia(s.sseguro) diasgracia,'
         || 'sum(v.iconcep) iconcep,' || 'pac_seguros.ff_situacion_poliza(s.sseguro, ' || v_idi
         || ', 2, NULL, NULL, p.fcalcul) estpol, tgarant'
         || ', p.nriesgo, (SELECT TNATRIE FROM riesgos  WHERE sseguro = s.sseguro AND nriesgo   = p.nriesgo) plan'  --BUG39207:JMT:15/02/2016
         || ' FROM seguros s, titulopro t, rrc_sam p, recibos r, procesoscab s1,'
         || '(select sum(iconcep) iconcep, nrecibo, nriesgo, cgarant from detrecibos where cconcep IN(0, 8) group by nrecibo, nriesgo, cgarant) v, garangen g'
         || ' WHERE t.cramo = s.cramo' || ' and s.cempres = ' || v_emp || ' and p.sproces='
         || v_proces || ' AND t.cmodali = s.cmodali' || ' AND t.ctipseg = s.ctipseg'
         || ' AND t.ccolect = s.ccolect' || ' AND t.cidioma = ' || v_idi
         || ' AND s.sseguro = p.sseguro' || ' and p.fcalcul = ' || v_cal
         || ' AND p.nrecibo = r.nrecibo' || ' AND p.sproces = s1.sproces'
         || ' AND p.nrecibo = v.nrecibo' || ' AND p.nriesgo = v.nriesgo'
         || ' AND p.cgarant = v.cgarant' || ' AND p.cgarant = g.cgarant' || ' AND g.cidioma = '
         || v_idi
         || ' GROUP BY s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo, p.cmoneda, r.fefecto, s1.fprofin,'
         || ' s1.fprofin, s.fvencim,s.fefecto, s.fcaranu, s.cforpag, s.sseguro, tgarant,p.fcalcul '
          || ', p.nriesgo' --BUG39207:JMT:15/02/2016
         || ' UNION '
-------------------------------------------------------------------
         || ' select s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo,'
         || ' sum(f_round(nvl(p.iprirrc, 0),p.cmoneda)) importe,'
                                                                 --|| ' sum(f_round(nvl(p.iprirrc,0)-PAC_INFORMES_152.f_caliva (p.nrecibo,p.CGARANT, p.NRIESGO) ,p.cmoneda)) importe,' --bug: 26422/151994
         || ' ff_desvalorfijo(383,' || v_idi || ',f_cestrec_mv(p.nrecibo,' || v_idi
         || ')) estado,' || ' (select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cmoneda) moneda,' || ' r.fefecto fefecto,' || ' s1.fprofin,'
         || ' s.fefecto fefectopol,' || 'nvl(s.fvencim, s.fcaranu -1) ffinvig,'
         || ' (select tatribu from detvalores where cvalor = 17 and cidioma =' || v_idi
         || ' and catribu = s.cforpag) forpag,'
         || ' pac_propio_colm.f_numdias_periodo_gracia(s.sseguro) diasgracia,'
         || ' sum(v.iconcep) iconcep, ' || 'pac_seguros.ff_situacion_poliza(s.sseguro, '
         || v_idi || ', 2, NULL, NULL, p.fcalcul) estpol, tgarant'
         || ', p.nriesgo, (SELECT TNATRIE FROM riesgos  WHERE sseguro = s.sseguro AND nriesgo   = p.nriesgo) plan'  --BUG39207:JMT:15/02/2016
         || ' FROM seguros s, titulopro t, rrc_sam_previo p, recibos r, procesoscab s1,'
         || '(select sum(iconcep) iconcep, nrecibo, nriesgo, cgarant from detrecibos where cconcep IN(0, 8) group by nrecibo, nriesgo, cgarant) v, garangen g'
         || ' WHERE t.cramo = s.cramo' || ' and s.cempres = ' || v_emp || ' and p.sproces='
         || v_proces || ' AND t.cmodali = s.cmodali' || ' AND t.ctipseg = s.ctipseg'
         || ' AND t.ccolect = s.ccolect' || ' AND t.cidioma = ' || v_idi
         || ' AND s.sseguro = p.sseguro' || ' and p.fcalcul = ' || v_cal
         || ' AND p.nrecibo = r.nrecibo' || ' AND p.sproces = s1.sproces'
         || ' AND p.nrecibo = v.nrecibo' || ' AND p.nriesgo = v.nriesgo'
         || ' AND p.cgarant = v.cgarant' || ' AND p.cgarant = g.cgarant' || ' AND g.cidioma = '
         || v_idi
         || ' GROUP BY s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo, p.cmoneda, r.fefecto, s1.fprofin,'
         || ' s.fvencim, s.fefecto, s.fcaranu, s.cforpag, s.sseguro, tgarant, p.fcalcul'
         || ', p.nriesgo' --BUG39207:JMT:15/02/2016
-------------------------------------------------------------------
         || ')';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_864_det;

   /******************************************************************************************
     Descripció: Cabecera del map 865 Listado de Producción por Póliza RRC Cedida
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_865_cab(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_865_CAB';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' p=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      v_ttexto :=
         'SELECT
                f_axis_literales(100829  ,x.idi) || '';'' ||
                f_axis_literales(1000307 ,x.idi) || '';'' ||
                f_axis_literales(9001639 ,x.idi) || '';'' ||
                f_axis_literales(104595  ,x.idi) || '';'' ||
                f_axis_literales(111838  ,x.idi) || '';'' ||
                f_axis_literales(9905330 ,x.idi) || '';'' ||
                f_axis_literales(9905331 ,x.idi) || '';'' ||
                f_axis_literales(100587  ,x.idi) || '';'' ||
                f_axis_literales(108645  ,x.idi) || '';'' ||
                f_axis_literales(100883  ,x.idi) || '';'' ||
                f_axis_literales(1000575  ,x.idi) || '';'' ||
                f_axis_literales(9903067  ,x.idi) || '';'' ||
                f_axis_literales(9902917  ,x.idi) || '';'' ||
                '' '' linea
                FROM (SELECT NVL(f_usu_idioma, 1) idi FROM DUAL) x, DUAL';
      -- bug 28963/0169440 - 12/03/2014 - JMF : compania
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_865_cab;

   /******************************************************************************************
     Descripció: Detalle del map 865 Listado de Producción por Póliza RRC Cedida
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_865_det(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_865_DET';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' p=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_cal          VARCHAR2(100);   -- Fecha calculo rrc
      d_hasta        DATE;
      v_proces       NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      --v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      -- Buscar fecha calculo, ultimo dia del mes que se quiere obtener
      v_ntraza := 150;
      v_cal := 'TO_DATE(' || CHR(39)
               || TO_CHAR(LAST_DAY(TO_DATE(p_fecha, 'DDMMYYYY')), 'ddmmyyyy') || CHR(39)
               || ', ''DDMMYYYY'')';

      IF p_sproces IS NULL THEN
         -- Venimos de la pantalla de listados, buscamos ultimo proceso de real
         SELECT NVL(MAX(sproces), -1)
           INTO v_proces
           FROM rrc_sam
          WHERE fcalcul = LAST_DAY(TO_DATE(p_fecha, 'DDMMYYYY'));
      ELSE
         v_proces := p_sproces;
      END IF;

      -- bug 28963/0169440 - 12/03/2014 - JMF : compania
      v_ntraza := 150;
      v_ttexto :=
         'SELECT ' || 'sproduc' || v_sep || 'ttitulo' || v_sep || 'npoliza' || v_sep
         || 'ncertif' || v_sep || 'nrecibo' || v_sep || 'prima' || v_sep || 'descuento'
         || v_sep || 'estado' || v_sep || 'moneda' || v_sep || 'fefecto' || v_sep || 'fprofin'
         || v_sep
         || '(SELECT MAX(p1.nnumide|| Decode(P1.Tdigitoide, Null, Null, ''-'' || P1.Tdigitoide))'
         || v_sep || 'Max(tcompani)' || v_sep || CHR(39) || CHR(39)
         || ' From Companias C,  Per_Personas P1' || ' WHERE  C.Ccompani = compania'
         || ' AND p1.sperson = c.sperson)' || ' linea' || ' FROM ('
-------------------------------------------------------------------
         || ' SELECT ' || 's.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo,'
         || 'sum(f_round(nvl(p.iprrcrc, 0),p.cmoneda)) prima,'
         || 'sum(nvl(p.icrrcrc, 0)) descuento, p.ccompani compania,' || 'ff_desvalorfijo(383,'
         || v_idi || ',f_cestrec_mv(p.nrecibo,' || v_idi || ')) estado,'
         || '(select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cmoneda) moneda,' || 'r.fefecto, s1.fprofin'
         || ' FROM seguros s, titulopro t, rrc_rea_sam p, recibos r, procesoscab s1'
         || ' WHERE t.cramo = s.cramo' || ' and s.cempres = ' || v_emp || ' and p.sproces='
         || v_proces || ' AND t.cmodali = s.cmodali' || ' AND t.ctipseg = s.ctipseg'
         || ' AND t.ccolect = s.ccolect' || ' AND t.cidioma = ' || v_idi
         || ' AND s.sseguro = p.sseguro' || ' and p.fcalcul = ' || v_cal
         || ' AND p.nrecibo = r.nrecibo' || ' AND p.sproces = s1.sproces'
         || ' GROUP BY s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo, p.cmoneda, r.fefecto, s1.fprofin,p.ccompani'
-------------------------------------------------------------------
         || ' UNION' || ' SELECT ' || 's.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo,'
         || 'sum(f_round(nvl(p.iprrcrc, 0),p.cmoneda)) prima,'
         || 'sum(nvl(p.icrrcrc, 0)) descuento, p.ccompani compania,' || 'ff_desvalorfijo(383,'
         || v_idi || ',f_cestrec_mv(p.nrecibo,' || v_idi || ')) estado,'
         || '(select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cmoneda) moneda,' || 'r.fefecto, s1.fprofin'
         || ' FROM seguros s, titulopro t, rrc_rea_sam_previo p, recibos r, procesoscab s1'
         || ' WHERE t.cramo = s.cramo' || ' and s.cempres = ' || v_emp || ' and p.sproces='
         || v_proces || ' AND t.cmodali = s.cmodali' || ' AND t.ctipseg = s.ctipseg'
         || ' AND t.ccolect = s.ccolect' || ' AND t.cidioma = ' || v_idi
         || ' AND s.sseguro = p.sseguro' || ' and p.fcalcul = ' || v_cal
         || ' AND p.nrecibo = r.nrecibo' || ' AND p.sproces = s1.sproces'
         || ' GROUP BY s.sproduc, t.ttitulo, s.npoliza, s.ncertif, p.nrecibo, p.cmoneda, r.fefecto, s1.fprofin,p.ccompani'
-------------------------------------------------------------------
         || ')';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_865_det;

   /******************************************************************************************
     Descripció: Cabecera del map 866 Listado Siniestros
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_866_cab(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_866_CAB';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' s=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
   BEGIN
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      vhasta := TO_DATE(p_fecha, 'ddmmyyyy');

      SELECT TO_NUMBER(TO_CHAR(vhasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(vhasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(ADD_MONTHS(vhasta, -1))
           INTO vhasta
           FROM DUAL;
      END IF;

      v_fin := TO_CHAR(vhasta, 'dd/mm/yyyy');
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905301, ' || v_idi || ') || CHR(10)||'
                  || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep || CHR(39) || v_fin
                  || CHR(39)
                            -- espacios
                  || ' ||CHR(10)||' || 'f_axis_literales(100829  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001639 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(104595  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(800279  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(110278  ,' || v_idi || ')' || v_sep   -- Fecha siniestro
                  || 'f_axis_literales(9906139 ,' || v_idi || ')' || v_sep   -- Controvertido
                  || 'f_axis_literales(9905323 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905324 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905325 ,' || v_idi || ')' || v_sep   -- Sub_Keira
                  || 'f_axis_literales(9905697 ,' || v_idi || ')' || v_sep   -- Provision retenida
                  || 'f_axis_literales(9905332 ,' || v_idi || ')' || v_sep   -- Provisión Directa
                  || 'f_axis_literales(9905333 ,' || v_idi || ')' || v_sep   -- Provisión Cedida
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9905326 ,' || v_idi || ')'
                  || v_sep   -- Rut Reasegurador
                          || 'f_axis_literales(9905326 ,' || v_idi || ')'
                  || v_sep   -- Reasegurador
                          || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9000752, ' || v_idi || ')'
                  || v_sep   -- Rut Broker
                          || 'f_axis_literales(9000752 ,' || v_idi || ')' || v_sep   -- Broker
                  || 'f_axis_literales(108645  ,' || v_idi || ')' || v_sep   -- Moneda
                  || 'f_axis_literales(9905196 ,' || v_idi || ')' || v_sep   -- Fecha denuncia
                  || 'f_axis_literales(1000575 ,' || v_idi || ')' || v_sep   -- Fecha contable
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      -- bug 28963/0169440 - 12/03/2014 - JMF
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_866_cab;

   /******************************************************************************************
     Descripció: Detalle del map 866 Listado Siniestros
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_866_det(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_866_DET';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' s=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      v_emp          NUMBER;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      vrea           VARCHAR2(100);   -- Nombre tabla reaseguro
   BEGIN
      v_ntraza := 100;
      vhasta := TO_DATE(p_fecha, 'ddmmyyyy');
      v_ntraza := 110;

      SELECT TO_NUMBER(TO_CHAR(vhasta, 'DD'))
        INTO vdia
        FROM DUAL;

      v_ntraza := 120;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(vhasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      v_ntraza := 130;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(ADD_MONTHS(vhasta, -1))
           INTO vhasta
           FROM DUAL;
      END IF;

      v_ntraza := 140;
      v_fin := 'TO_DATE(' || CHR(39) || TO_CHAR(vhasta, 'ddmmyyyy') || CHR(39)
               || ', ''DDMMYYYY'')';
      v_ntraza := 150;

      IF p_sproces IS NULL THEN
         -- Venimos de la pantalla de listados, buscamos real
         vrea := 'reaseguro';
      ELSE
         -- Venimos de impresion provisiones, buscamos primero en real y despues en previo
         v_ntraza := 160;

         SELECT NVL(MAX('reaseguro'), 'reaseguroaux')
           INTO vrea
           FROM DUAL
          WHERE EXISTS(SELECT 1
                         FROM reaseguro
                        WHERE fcierre = vhasta
                          AND sproces = p_sproces);
      END IF;

      v_ntraza := 170;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_ntraza := 180;
      v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      v_ntraza := 190;
      -- bug 28963/0169440 - 12/03/2014 - JMF : reasegurador
      v_ttexto :=
         'SELECT DISTINCT ' || 's.sproduc' || v_sep || 't.ttitulo' || v_sep || 's.npoliza'
         || v_sep || 's.ncertif' || v_sep || 'str.nsinies' || v_sep
                                                                   -- Bug 0026430 - 11/03/2014 - JMF
         || 'si.FSINIES' || v_sep || 'DECODE('
         || 'pac_siniestros_colm.f_controvertidos(si.nsinies, ' || v_fin
         || '), 1, ''S'', NULL) ' || v_sep || 'ps.crespue' || v_sep   -- KeiraLinNegocio,
         || 'dp.tvalpar' || v_sep   -- Keira,
                                 || 'dp2.tvalpar' || v_sep   -- SubKeira,
         || 'PAC_INFORMES_152.f_provsinpag(s.sseguro, ' || v_fin || ', 3,'
         || NVL(p_sproces || '', 'null') || ', si.nsinies)' || v_sep   -- provision_total,
         || 'PAC_INFORMES_152.f_provsinpag(s.sseguro, ' || v_fin || ', 1,'
         || NVL(p_sproces || '', 'null') || ', si.nsinies)' || v_sep   -- provision_directa
         || 'PAC_INFORMES_152.f_provsinpag(s.sseguro, ' || v_fin || ', 2,'
         || NVL(p_sproces || '', 'null') || ', si.nsinies)' || v_sep   -- provision_cedida
         || '('
         || ' SELECT MAX(p1.nnumide||Decode(P1.Tdigitoide, Null, Null, ''-'' || P1.Tdigitoide))'
         || v_sep || ' Max(tcompani) ' || v_sep || CHR(39) || CHR(39)
         || ' FROM companias c, liqresreaaux r, per_personas p1'
         || ' WHERE r.sseguro = si.sseguro' || ' AND r.nsinies = si.nsinies'
         || ' And C.Ccompani = R.Ccompani' || ' AND p1.sperson = c.sperson'
         || ')||'   -- reasegurador,
                 || '('
         || ' select max(p3.NNUMIDE||decode(p3.TDIGITOIDE,null,null,''-''||p3.TDIGITOIDE))'
         || v_sep || 'max(p4.TAPELLI1||'' ''||p4.TAPELLI2)' || v_sep || CHR(39) || CHR(39)
         || ' from  ctatecnica c1, companias c2, per_personas p3, per_detper p4, ' || vrea
         || ' r' || ' where r.sseguro=si.sseguro and r.nsinies=si.nsinies'
         || ' and   c1.ccompani=r.ccompani' || ' and   c1.nversio=r.nversio'
         || ' and   c1.scontra=r.SCONTRA' || ' and   c1.CTRAMO=r.CTRAMO'
         || ' and   c1.sproduc=s.sproduc' || ' and   c2.ccompani=c1.ccorred'
         || ' and   p3.sperson=c2.sperson' || ' and   p4.sperson=p3.sperson'
         || ' and   p4.FMOVIMI=(select max(p44.fmovimi) from per_detper p44 where p44.sperson=p4.sperson)'
         || ')||'   -- broker,
                 || '(select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep   -- divisa
                                              || 'si.FNOTIFI' || v_sep || 'str.fcontab'
         || v_sep   -- contable
                 || CHR(39) || CHR(39) || ' linea'
         || ' from seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,detparam dp,pargaranpro pg2,detparam dp2'
         || '      , sin_tramita_reserva str, sin_siniestro si, sin_movsiniestro m where  s.cempres='
         || v_emp || ' AND    si.FSINIES <= ' || v_fin || ' AND(m.cestsin in (0, 4) '
         || '      AND si.nsinies = m.nsinies '
         || '      AND m.nmovsin = (SELECT MAX(nmovsin) '
         || '                  FROM sin_movsiniestro '
         || '                 WHERE nsinies = m.nsinies '
         || '                   AND festsin <= ' || v_fin || '   )) '
         || ' and    si.sseguro=s.sseguro and str.nsinies=si.nsinies'
         || ' AND    t.cramo=s.cramo  AND t.cmodali=s.cmodali AND t.ctipseg=s.ctipseg  AND t.ccolect=s.ccolect'
         || ' and    t.cidioma=' || v_idi || ' and p.sproduc = s.sproduc'
         || ' and ps.sseguro = s.sseguro'
         -- bug 26422 dcg 7-5-2013
         --|| ' and ps.nmovimi = (select max(z.nmovimi) from pregunpolseg z where z.sseguro=ps.sseguro and z.cpregun=ps.cpregun)'
         --bug 26422 jmf 10-5-2013 || ' and ps.nmovimi = (select max(nmovimi) from pregunpolseg where sseguro=ps.sseguro and cpregun=414 and nmovimi <= (select max(z.nmovimi) from movseguro z where z.sseguro=ps.sseguro and z.cpregun=ps.cpregun))'
         || ' and ps.nmovimi = (select max(nmovimi) from pregunpolseg where sseguro=ps.sseguro and cpregun=414 and nmovimi <= (select max(z.nmovimi) from movseguro z where z.sseguro=ps.sseguro))'
         || ' and ps.cpregun = 414' || ' and pg.cmodali = s.cmodali'
         || ' and pg.ctipseg = s.ctipseg' || ' and pg.ccolect = s.ccolect'
         || ' and pg.cactivi = s.cactivi' || ' and pg.sproduc = s.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' and pg.cpargar = ''SUBCLAKEIRA'' and dp.cparam = pg.cpargar'
         || ' and dp.cidioma =' || v_idi || ' and dp.cvalpar = pg.cvalpar'
         || ' and pg2.cmodali = s.cmodali' || ' and pg2.ctipseg = s.ctipseg'
         || ' and pg2.ccolect = s.ccolect' || ' and pg2.cactivi =  s.cactivi'
         || ' and pg2.sproduc = s.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' and pg2.cpargar = ''CLAKEIRARAMO'' and dp2.cparam = pg2.cpargar'
         || ' and dp2.cidioma = ' || v_idi || ' and dp2.cvalpar = pg2.cvalpar'
         || ' and (str.ntramit,str.nmovres) = (select min(z_str.ntramit),min(z_str.nmovres) from sin_tramita_reserva z_str where z_str.nsinies = str.nsinies)'
         || ' and str.cgarant = pg.cgarant' || ' and str.cgarant = pg2.cgarant'
         || ' and pg2.cgarant = (select nvl(str.cgarant,min(gar.cgarant)) from garanseg gar where gar.sseguro = s.sseguro)'
         || ' and pg.cgarant  = pg2.cgarant';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_866_det;

   /******************************************************************************************
     Descripció: Cabecera del map 729 Listado Pago Siniestros
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_867_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_867_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_idi := NVL(f_usu_idioma, 3);

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ttexto := 'select'
                                          -- nombre listado
                          -- BUG 26430/147498 - FAL - 26/6/2013 - Añadir trunc
                                  --|| ' f_axis_literales(9905301, ' || v_idi || ') || CHR(10)||'
                  || ' f_axis_literales(9905722, ' || v_idi || ') || CHR(10)||'
                  -- FI BUG 26430/147498 - FAL - 26/6/2013 - Añadir trunc
                  -- desde hasta
                  || ' f_axis_literales(101836, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39)
                                                -- espacios
                  || ' ||CHR(10)||'
                                   --||'f_axis_literales(9905334 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(111471  ,' || v_idi || ')' || v_sep   -- Agrupacion
                  || 'f_axis_literales(100784  ,' || v_idi || ')' || v_sep   -- ramo
                  || 'f_axis_literales(9905562 ,' || v_idi || ')' || v_sep   -- nombre ramo
                  || 'f_axis_literales(100829  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9002202 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001639 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(104595  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(800279  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(110521  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100852  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(109651  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000112 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(110994  ,' || v_idi || ')' || v_sep   -- Cobertura
                  || 'f_axis_literales(9905323 ,' || v_idi || ')'
                  || v_sep   -- Keira Línea Negocio
                          || 'f_axis_literales(9905324 ,' || v_idi || ')' || v_sep   -- keira
                  || 'f_axis_literales(9905325 ,' || v_idi || ')' || v_sep   -- Sub_Keira
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9000909 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000909 ,' || v_idi || ')' || v_sep   -- Destinatario
                  || 'f_axis_literales(9902257 ,' || v_idi || ')' || v_sep   -- Régimen Fiscal
                  || 'f_axis_literales(9905335 ,' || v_idi || ')' || v_sep   -- Monto Total
                  || 'f_axis_literales(800422  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905705 ,' || v_idi || ')' || v_sep   -- Retenció Honoraris
                  || 'f_axis_literales(9905336 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905337 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001870 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9000752 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000752 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9905326 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905326 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(108645  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001946 ,' || v_idi || ')' || v_sep   -- F. pago
                  || 'f_axis_literales(1000575 ,' || v_idi || ')' || v_sep   -- Fecha contable
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_867_cab;

   /******************************************************************************************
     Descripció: Detalle del map 867 Listado Pago Siniestros
     return:     texto detalle
   ******************************************************************************************/
   FUNCTION f_867_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_867_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY'')';
      v_idi := f_usu_idioma;
      v_emp := f_empres;
      v_ttexto :=
         'SELECT '
                  --|| 'null ' || v_sep   -- nAgrupa,
         || '(select max(trespue) from pregunseg x1'
         || ' where x1.SSEGURO=si.sseguro and x1.NRIESGO=si.nriesgo and x1.CPREGUN=428'
         || ' and x1.NMOVIMI=(select max(x2.NMOVIMI) from pregunseg x2 where x2.SSEGURO=si.sseguro'
         || '  and x2.NRIESGO=si.nriesgo and x2.CPREGUN=428 and x2.NMOVIMI<=si.nmovimi))'
         || v_sep   -- Agrupacion,
                 || 's.cramo' || v_sep || 'ra.TRAMO' || v_sep || 's.sproduc' || v_sep
         || 't.TTITULO' || v_sep || '(' || 'select max(p2.TAPELLI1||'' ''||p2.TAPELLI2)'
         || v_sep || CHR(39) || CHR(39) || ' from agentes a, per_personas p, per_detper p2'
         || ' where  a.cagente=pac_redcomercial.f_busca_padre(s.cempres,s.cagente,3,F_SYSDATE)'
         || ' and    p.sperson=a.sperson' || ' and    p2.sperson=p.sperson'
         || ' and    p2.FMOVIMI=(select max(p22.fmovimi) from per_detper p22 where p22.SPERSON=p.sperson)'
         || ')||'   --  sucursal,
                 || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'si.NSINIES' || v_sep
         || 'si.FSINIES' || v_sep || ' (select max(tcausin) from sin_descausa where cidioma='
         || v_idi || ' and ccausin=si.ccausin)' || v_sep   -- causa
         || ' (select max(tmotsin) from sin_desmotcau where cidioma=' || v_idi
         || ' and ccausin=si.ccausin and cmotsin=si.cmotsin)' || v_sep   -- subcausa
         || 'replace(substr(si.tsinies,1,100),chr(39),'' '')' || v_sep   --Descripcion_Sini
         || 'stpg.CGARANT' || v_sep   -- Cobertura,
         || 'PAC_INFORMES_152.f_get_linea_negocio(s.sseguro,' || v_idi || ')'
         || v_sep   -- negocio,
         || 'PAC_INFORMES_152.f_get_ramo_keira(s.sproduc,s.cactivi,stpg.cgarant,' || v_idi
         || ')' || v_sep   -- keira,
         || 'PAC_INFORMES_152.f_get_subramo_keira(s.sproduc,s.cactivi,stpg.cgarant,' || v_idi
         || ')' || v_sep   -- subkeira,
                        || '('
         || 'select max(p1.NNUMIDE||decode(p1.TDIGITOIDE,null,null,''-''||p1.TDIGITOIDE))'
         || v_sep || 'max(p2.TAPELLI1||'' ''||p2.TAPELLI2)' || v_sep || CHR(39) || CHR(39)
         || ' from  per_personas p1, per_detper p2' || ' where p1.sperson=stp.sperson'
         || ' and   p2.sperson=p1.sperson'
         || ' and   p2.FMOVIMI=(select max(p22.fmovimi) from per_detper p22 where p22.sperson=p2.sperson)'
         || ')||'   -- Destinatario,
                 || '(' || 'select ff_desvalorfijo(1045,' || v_idi || ',max(f.CREGFISCAL))'
         || v_sep || CHR(39) || CHR(39) || ' from  per_regimenfiscal f'
         || ' where f.sperson=stp.sperson'
         || ' and   f.fefecto=(select max(f1.fefecto) from per_regimenfiscal f1 where f1.sperson=f.sperson)'
         || ')||'   -- RegimenFiscal,
         || '(PAC_INFORMES_152.f_impuestopag (stp.sidepag, stm.nmovpag)'
         || ' + PAC_INFORMES_152.f_montoapagar (stp.sidepag, stm.nmovpag) )'
         || v_sep   -- MontoTotal,
         || 'PAC_INFORMES_152.f_impuestopag (stp.sidepag, stm.nmovpag)' || v_sep   -- Impuesto,
         || 'PAC_INFORMES_152.f_retencionpag(stp.sidepag, stm.nmovpag)'
         || v_sep   -- Retención Honorarios
         || '(nvl(PAC_INFORMES_152.f_montoapagar (stp.sidepag, stm.nmovpag),0)'
         || '-nvl(PAC_INFORMES_152.f_retencionpag(stp.sidepag, stm.nmovpag),0))'
         || v_sep   -- MontoaPagar,
         || 'PAC_INFORMES_152.f_RetencionMonto (stp.sidepag, stm.nmovpag)'
         || v_sep   -- RetencionMonto,
         || 'PAC_INFORMES_152.f_CesionSobreMontoTotal (stp.sidepag, s.sseguro)'
         || v_sep   -- CesionMonto,
                 || '('
         || ' select max(p3.NNUMIDE||decode(p3.TDIGITOIDE,null,null,''-''||p3.TDIGITOIDE))'
         || v_sep || 'max(p4.TAPELLI1||'' ''||p4.TAPELLI2)' || v_sep || CHR(39) || CHR(39)
         || ' from  ctatecnica c1, companias c2, per_personas p3, per_detper p4, reaseguro r'
         || ' where r.sseguro=si.sseguro and r.nsinies=si.nsinies'
         || ' and   c1.ccompani=r.ccompani' || ' and   c1.nversio=r.nversio'
         || ' and   c1.scontra=r.SCONTRA' || ' and   c1.CTRAMO=r.CTRAMO'
         || ' and   c1.sproduc=s.sproduc' || ' and   c2.ccompani=c1.ccorred'
         || ' and   p3.sperson=c2.sperson' || ' and   p4.sperson=p3.sperson'
         || ' and   p4.FMOVIMI=(select max(p44.fmovimi) from per_detper p44 where p44.sperson=p4.sperson)'
         || ')||'   -- broker,
                 || '('
         || 'select max(p1.NNUMIDE||decode(p1.TDIGITOIDE,null,null,''-''||p1.TDIGITOIDE))'
         || v_sep || 'max(p2.TAPELLI1||'' ''||p2.TAPELLI2)' || v_sep || CHR(39) || CHR(39)
         || ' from  per_personas p1, per_detper p2, companias c, reaseguro r'
         || ' where r.sseguro=si.sseguro and r.nsinies=si.nsinies'
         || ' and   c.ccompani=r.ccompani' || ' and   p1.sperson=c.sperson'
         || ' and   p2.sperson=p1.sperson'
         || ' and   p2.FMOVIMI=(select max(p22.fmovimi) from per_detper p22 where p22.sperson=p2.sperson)'
         || ')||'   -- reasegurador,
                 --|| 'lpad(p.cdivisa,3,''0'')' || v_sep   -- divisa
         || '(select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep   -- divisa
                                              || 'stp.FORDPAG' || v_sep || 'stm.FCONTAB'
         || v_sep || CHR(39) || CHR(39) || ' linea'
         || ' from  seguros s, ramos ra, productos p, titulopro t'
         || ' , sin_siniestro si, sin_tramita_pago stp, sin_tramita_pago_gar stpg, sin_tramita_movpago stm'
         || ' where s.cempres=' || v_emp || ' and   ra.cramo=s.cramo and ra.CIDIOMA=' || v_idi
         || ' and   p.sproduc=s.sproduc'
         || ' and   t.CRAMO=p.cramo and t.CMODALI=p.cmodali and t.CTIPSEG=p.ctipseg and t.CCOLECT=p.ccolect'
         || ' and   t.CIDIOMA=' || v_idi || ' and   si.sseguro=s.sseguro'
         || ' and   stp.nsinies = si.nsinies'
                                             -- 04/04/2014 jmf
         || ' and   trunc(stm.fefepag) between ' || v_ini || ' and ' || v_fin
         || ' and   stpg.sidepag = stp.sidepag' || ' and   stm.sidepag = stpg.sidepag'
         || ' and   stm.cestpag in (1,2)'
         || ' and   stm.NMOVPAG = (select max(stm2.nmovpag) from sin_tramita_movpago stm2 where stm2.SIDEPAG=stpg.sidepag)';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_867_det;

   /******************************************************************************************
     Descripció: Cabecera del map 868 Listado de Recaudación
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_868_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_868_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_idi := NVL(f_usu_idioma, 3);

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ttexto :=
                  -- nombre listado
                  f_axis_literales(9905303, v_idi) || CHR(10)
                  -- desde hasta
                  || f_axis_literales(101836, v_idi) || v_sep || v_ini || v_sep
                  || f_axis_literales(101837, v_idi) || v_sep || v_fin
                                                                      -- espacios
                  || CHR(10);
      -- v_ttexto := v_ttexto || f_axis_literales(9905334, v_idi) || v_sep   BUG 26430/0146998 - FAL - 18/06/2013
      v_ttexto := v_ttexto || f_axis_literales(111471, v_idi) || v_sep
                  || f_axis_literales(100784, v_idi) || v_sep
                  ||   -- Ramo
                    f_axis_literales(9905562, v_idi) || v_sep
                  ||   -- Nombre ramo
                    f_axis_literales(100829, v_idi) || v_sep
                  || f_axis_literales(1000307, v_idi) || v_sep
                  || f_axis_literales(9903067, v_idi) || ' '
                  || f_axis_literales(9905070, v_idi) || v_sep
                  || f_axis_literales(9905070, v_idi) || v_sep
                  ||   -- Partner
                    f_axis_literales(9903067, v_idi) || ' ' || f_axis_literales(9905313, v_idi)
                  || v_sep || f_axis_literales(9905313, v_idi) || v_sep
                  ||   -- Corredor
                    f_axis_literales(9903067, v_idi) || ' ' || f_axis_literales(9905315, v_idi)
                  || v_sep || f_axis_literales(9905315, v_idi) || v_sep
                  ||   -- Contratante
                    f_axis_literales(9001639, v_idi) || v_sep
                  || f_axis_literales(104595, v_idi) || v_sep
                  || f_axis_literales(9905275, v_idi) || v_sep
                  ||   -- Prima Directa
                    f_axis_literales(9905318, v_idi) || v_sep
                  ||   -- Prima Intermediada
                    -- BUG 26430/0146998 - FAL - 18/06/2013
                    f_axis_literales(101340, v_idi) || v_sep
                  ||   -- IVA
                    f_axis_literales(9905708, v_idi) || v_sep
                  ||   -- Comissió Directa
                    -- FI BUG 26430/0146998 - FAL - 18/06/2013
                    f_axis_literales(9905319, v_idi) || v_sep
                  ||   -- Costo de Intermediación Directo
--                    f_axis_literales(107586, v_idi) || v_sep ||      BUG 26430/0146998 - FAL - 18/06/2013
                    f_axis_literales(9905320, v_idi) || v_sep
                  || f_axis_literales(9905321, v_idi) || v_sep
                  || f_axis_literales(9905322, v_idi) || v_sep
                  || f_axis_literales(9905323, v_idi) || v_sep
                  || f_axis_literales(9905324, v_idi) || v_sep
                  || f_axis_literales(9905325, v_idi) || v_sep
                  || f_axis_literales(108645, v_idi) || v_sep
                  ||   -- Moneda
                    f_axis_literales(9000805, v_idi) || v_sep
                  ||   -- Fecha cobro
                    f_axis_literales(1000575, v_idi) || v_sep ||   -- Fecha contable
                                                                ' ';
      v_ttexto := 'SELECT ' || CHR(39) || v_ttexto || CHR(39) || ' linea from dual';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_868_cab;

   /******************************************************************************************
     Descripció: Detalle del map 868 Listado de Recaudación
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_868_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_868_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      verr           NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || '000000' || CHR(39)
               || ', ''DDMMYYYYhh24miss'')';
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYhh24miss'')';
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));

      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));

      -- bug 26430 - 31/10/2013 - JMF
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_tmoneda
        FROM parempresas
       WHERE cempres = v_emp
         AND cparam = 'MONEDACONTAB';

      -- BUG 26430/0146998 - FAL - 18/06/2013
      -- bug 26430 - 04/12/2013 - JMF: treure csituac 0
      v_ttexto :=
         'SELECT (select max(trespue) from pregunseg where sseguro = s.sseguro and nriesgo = NVL(r.nriesgo, 1) and cpregun = 428 and nmovimi = r.nmovimi)'
         || v_sep || 's.cramo' || v_sep || 'ra.tramo' || v_sep || 's.sproduc' || v_sep
         || 't.ttitulo' || v_sep
         || 'DECODE(pp.tdigitoide, NULL, pp.nnumide, pp.nnumide || ''-'' || pp.tdigitoide)'
         || v_sep || 'pp.tapelli' || v_sep
         || 'DECODE(pc.tdigitoide, NULL, pc.nnumide, pc.nnumide || ''-'' || pc.tdigitoide)'
         || v_sep || 'pc.tapelli' || v_sep
         || 'DECODE(pt.tdigitoide, NULL, pt.nnumide, pt.nnumide || ''-'' || pt.tdigitoide)'
         || v_sep || 'pt.tnombre||'' ''||pt.TAPELLI' || v_sep || 's.npoliza' || v_sep
         || 's.ncertif' || v_sep || '0' || v_sep
         || 'SUM(DECODE(d.cconcep, 0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)*DECODE(m.cestrec, 1, 1, -1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0))' || v_sep
         || 'SUM(DECODE(d.cconcep, 4, DECODE(r.ctiprec, 9, -1, 13, -1, 1)* DECODE(m.cestrec,1,1,-1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0))' || v_sep
         || 'SUM(DECODE(pac_propio.f_agentecorredor(ac.ctipint),0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '* DECODE(d.cconcep, 11, DECODE(m.cestrec,1,1,-1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0)' || ',0))' || v_sep
         || 'SUM(DECODE(pac_propio.f_agentecorredor(ac.ctipint), 1, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '* DECODE(d.cconcep, 11, DECODE(m.cestrec, 1, 1,-1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0),0))' || v_sep
         || 'SUM(DECODE(d.cconcep, 47, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '* DECODE(m.cestrec,1,1, -1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0))' || v_sep
         || 'SUM(DECODE(d.cconcep, 49, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '* DECODE(m.cestrec, 1,1,-1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0))' || v_sep
         || 'SUM(DECODE(d.cconcep, 48, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '* DECODE(m.cestrec,1,1,-1)'
         || '* pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ',0))' || v_sep
                                                                    -- fin bug 26430 - 31/10/2013 - JMF
         || 'ps.crespue' || v_sep || 'dp.tvalpar' || v_sep || 'dp2.tvalpar' || v_sep
         --|| '(select max(tdescri) from monedas where cidioma = ' || v_idi|| ' and cmoneda = p.cdivisa)' || v_sep
         || ' (mon.tdescri)' || v_sep || 'm.fmovini' || v_sep || 'm.fcontab' || v_sep
         || CHR(39) || CHR(39) || 'linea'
         || ' FROM seguros s, ramos ra, titulopro t, detrecibos d, movrecibo m, recibos r, productos p,'
         || ' pregunpolseg ps, pargaranpro pg, detparam dp, pargaranpro pg2, detparam dp2,'
         || ' agentes a, personas pc, personas pp, agentes a2, tomadores tom, personas pt, agentes_comp ac'
         || ' , ctacliente cc, monedas mon'
         || ' WHERE s.sproduc = p.sproduc AND ra.cramo = s.cramo AND ra.cidioma = ' || v_idi
         -- ini bug 26430 - 31/10/2013 - JMF
         || ' and mon.CIDIOMA=' || v_idi || ' and mon.CMONEDA=p.cdivisa'
         || ' and cc.nrecibo = m.nrecibo' || ' and cc.ffecmov = trunc(m.FMOVDIA)'
         || ' and cc.cmovimi in (2,5) '   -- cuotas, anulaciones
         -- fin bug 26430 - 31/10/2013 - JMF
         || ' AND s.cagente = ac.cagente'
         || ' AND t.cramo = s.cramo AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg AND t.ccolect = s.ccolect'
         || ' AND ps.nmovimi = (SELECT MAX(nmovimi) FROM pregunpolseg WHERE sseguro = s.sseguro AND cpregun = 414 AND nmovimi <= r.nmovimi)'
         || ' AND ps.cpregun = 414 and ps.sseguro = s.sseguro AND r.ctiprec IN(0, 1, 3, 9, 13, 15) AND t.cidioma = '
         || v_idi || ' AND m.fmovdia BETWEEN ' || v_ini || ' AND ' || v_fin
         || ' AND s.sseguro = r.sseguro AND r.nrecibo = d.nrecibo'
         || ' AND r.nrecibo = m.nrecibo AND r.cestaux = 0 AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49) AND d.nrecibo = m.nrecibo'
         || ' AND((m.cestrec = 1 ) OR(m.cestrec = 0 AND m.cestant = 1)) AND m.nrecibo NOT IN(SELECT nrecibo'
         || ' FROM detmovrecibo) AND a.cagente = s.cagente AND a.sperson = pc.sperson AND s.sproduc = pg.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma ='
         || v_idi
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg.cvalpar = dp.cvalpar AND s.sproduc = pg2.sproduc AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant'
         || ' AND pg2.cpargar = dp2.cparam AND dp2.cidioma = ' || v_idi
         || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' AND a2.cagente = pac_redcomercial.f_busca_padre(' || v_emp
         || ', s.cagente, null, r.fefecto) AND a2.sperson = pp.sperson'
         || ' AND tom.sseguro = s.sseguro AND tom.sperson = pt.sperson'
         || ' GROUP BY s.sseguro, r.nriesgo,r.nmovimi,'
         || ' s.cramo, ra.tramo, s.sproduc, t.ttitulo, DECODE(pp.tdigitoide, NULL, pp.nnumide, pp.nnumide || ''-'' || pp.tdigitoide),'
         || ' pc.nnumide, pc.tdigitoide, pt.nnumide, pt.tdigitoide, pt.tnombre, pt.tapelli,'
         || ' s.npoliza, s.ncertif, pp.nnumide || '' '' || pp.tdigitoide, pp.tapelli,'
         || ' DECODE(pc.tdigitoide, NULL, pc.nnumide, pc.nnumide || ''-'' || pc.tdigitoide),pc.tapelli,'
         || ' DECODE(pt.tdigitoide, NULL, pt.nnumide, pt.nnumide || ''-'' || pt.tdigitoide),'
         || ' pt.tnombre || '' '' || pt.tapelli, ps.crespue, dp.tvalpar, dp2.tvalpar, p.cdivisa, m.fmovini, m.fcontab, mon.tdescri'
---------------------------
         || ' UNION '
---------------------------
         || ' SELECT (select max(trespue) from pregunseg where sseguro = s.sseguro and nriesgo = NVL(r.nriesgo, 1) and cpregun = 428 and nmovimi = r.nmovimi)'
         || v_sep || 's.cramo' || v_sep || 'ra.tramo' || v_sep || 's.sproduc' || v_sep
         || 't.ttitulo' || v_sep
         || ' DECODE(pp.tdigitoide, NULL, pp.nnumide, pp.nnumide || ''-'' || pp.tdigitoide)'
         || v_sep || 'pp.tapelli' || v_sep
         || 'DECODE(pc.tdigitoide, NULL, pc.nnumide, pc.nnumide || ''-'' || pc.tdigitoide)'
         || v_sep || 'pc.tapelli' || v_sep
         || 'DECODE(pt.tdigitoide, NULL, pt.nnumide, pt.nnumide || ''-'' || pt.tdigitoide)'
         || v_sep || 'pt.tnombre||'' ''||pt.TAPELLI' || v_sep || 's.npoliza' || v_sep
         || 's.ncertif' || v_sep || '0' || v_sep
         -- ini bug 26430 - 31/10/2013 - JMF
         -- bug 26430 - 25/11/2013 - JMF: Canvi imports
         || 'SUM(DECODE(d.cconcep,0,  d.ICONCEP_MONPOL ,0))' || v_sep
         || 'SUM(DECODE(d.cconcep,4,  d.ICONCEP_MONPOL ,0))' || v_sep
         || 'SUM(DECODE(d.cconcep,11, d.ICONCEP_MONPOL ,0)'
         || '* DECODE(pac_propio.f_agentecorredor(ac.ctipint), 0, 1, 0))' || v_sep
         || 'SUM(DECODE(d.cconcep,11, d.ICONCEP_MONPOL ,0)'
         || '* DECODE(pac_propio.f_agentecorredor(ac.ctipint), 1, 1, 0))' || v_sep
         || 'SUM(DECODE(d.cconcep,47, d.ICONCEP_MONPOL ,0))' || v_sep
         || 'SUM(DECODE(d.cconcep,49, d.ICONCEP_MONPOL ,0))' || v_sep
         || 'SUM(DECODE(d.cconcep,48, d.ICONCEP_MONPOL ,0))' || v_sep
                                                                     -- fin bug 26430 - 31/10/2013 - JMF
         || 'ps.crespue' || v_sep || 'dp.tvalpar' || v_sep || 'dp2.tvalpar' || v_sep
         --|| '(select max(tdescri) from monedas where cidioma = ' || v_idi|| ' and cmoneda = p.cdivisa)' || v_sep
         || ' (mon.tdescri)' || v_sep || 'trunc(m.fmovimi)' || v_sep || 'trunc(m.fefeadm)'
         || v_sep || CHR(39) || CHR(39) || 'linea'
         || ' FROM seguros s, ramos ra, titulopro t, detmovrecibo_parcial d, detmovrecibo m, recibos r,'
         || ' productos p, pregunpolseg ps, pargaranpro pg, detparam dp, pargaranpro pg2,'
         || ' detparam dp2, agentes a, personas pc, personas pp, agentes a2, tomadores tom, personas pt, agentes_comp ac'
         || ' , monedas mon'
         || ' WHERE s.sproduc = p.sproduc AND s.cagente = ac.cagente AND ra.cramo = s.cramo'
         || ' and mon.CIDIOMA=' || v_idi || ' and mon.CMONEDA=p.cdivisa'
         || ' AND ra.cidioma = ' || v_idi
         || ' AND t.cramo = s.cramo AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg'
         || ' AND t.ccolect = s.ccolect AND ps.nmovimi = (SELECT MAX(nmovimi) FROM pregunpolseg WHERE sseguro = s.sseguro AND cpregun = 414'
         || ' AND nmovimi <= r.nmovimi) AND ps.cpregun = 414 and ps.sseguro = s.sseguro AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || ' AND t.cidioma = ' || v_idi || ' AND m.FMOVIMI BETWEEN ' || v_ini || ' AND '
         || v_fin || ' AND s.sseguro = r.sseguro'
         || ' AND r.nrecibo = d.nrecibo AND r.nrecibo = m.nrecibo AND r.cestaux = 0 AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49)'
         || ' AND d.nrecibo = m.nrecibo AND d.norden = m.norden AND d.smovrec = m.smovrec AND a.cagente = s.cagente'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND a.sperson = pc.sperson AND s.sproduc = pg.sproduc AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant'
         || ' AND pg.cpargar = dp.cparam AND dp.cidioma = ' || v_idi
         || ' AND pg.cvalpar = dp.cvalpar AND s.sproduc = pg2.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam'
         || ' AND dp2.cidioma = ' || v_idi
         || ' AND pg2.cvalpar = dp2.cvalpar AND a2.cagente = pac_redcomercial.f_busca_padre('
         || v_emp || ', s.cagente, null, r.fefecto)'
         || ' AND a2.sperson = pp.sperson AND tom.sseguro = s.sseguro AND tom.sperson = pt.sperson'
         || ' GROUP BY s.sseguro , r.nriesgo, r.nmovimi, s.cramo , ra.tramo , s.sproduc , t.ttitulo ,'
         || ' DECODE(pp.tdigitoide, NULL, pp.nnumide, pp.nnumide || ''-'' || pp.tdigitoide), pp.tapelli ,'
         || ' DECODE(pc.tdigitoide, NULL, pc.nnumide, pc.nnumide || ''-'' || pc.tdigitoide), pc.tapelli ,'
         || ' DECODE(pt.tdigitoide, NULL, pt.nnumide, pt.nnumide || ''-'' || pt.tdigitoide), pt.tnombre , pt.tapelli , s.npoliza, s.ncertif , 0,'
         || ' ps.crespue, dp.tvalpar, dp2.tvalpar, p.cdivisa, trunc(m.fmovimi), trunc(m.fefeadm),mon.tdescri';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_868_det;

   /******************************************************************************************
     Descripció: Cabecera del map 869 Listado de Reaseguro cesion de primas normal proporcionales
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_869_cab(
      p_fdesde IN VARCHAR2,
      p_fhasta IN VARCHAR2,
      p_cempres IN NUMBER,
      p_previo IN NUMBER DEFAULT 0)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_869_CAB';
      v_tparam       VARCHAR2(1000)
           := 'd=' || p_fdesde || ' h=' || p_fhasta || ' e=' || p_cempres || ' p=' || p_previo;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      v_ttexto :=
         'SELECT
                f_axis_literales(100829  ,x.idi) || '';'' ||
                f_axis_literales(1000307 ,x.idi) || '';'' ||
                f_axis_literales(9903067 ,x.idi) ||'' ''|| f_axis_literales(9905326 ,x.idi)|| '';'' ||
                f_axis_literales(9905326 ,x.idi) || '';'' ||
                f_axis_literales(9903067 ,x.idi) ||'' ''|| f_axis_literales(9000752 ,x.idi)|| '';'' ||
                f_axis_literales(9000752 ,x.idi) || '';'' ||
                f_axis_literales(9001639 ,x.idi) || '';'' ||
                f_axis_literales(104595  ,x.idi) || '';'' ||
                f_axis_literales(104820  ,x.idi) || '';'' ||
                f_axis_literales(9905327 ,x.idi) || '';'' ||
                f_axis_literales(9905328 ,x.idi) || '';'' ||
                f_axis_literales(9905323 ,x.idi) || '';'' ||
                f_axis_literales(9905324 ,x.idi) || '';'' ||
                f_axis_literales(9905325 ,x.idi) || '';'' ||
                f_axis_literales(108645  ,x.idi) || '';'' ||
                f_axis_literales(101573  ,x.idi) || '';'' ||
                f_axis_literales(1000575 ,x.idi) || '';'' ||
                '' '' linea
                FROM (SELECT NVL(f_usu_idioma, 3) idi FROM DUAL) x, DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_869_cab;

   /******************************************************************************************
     Descripció: Detalle del map 869 Listado de Reaseguro cesion de primas normal proporcionales
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_869_det(
      p_fdesde IN VARCHAR2,
      p_fhasta IN VARCHAR2,
      p_cempres IN NUMBER,
      p_previo IN NUMBER DEFAULT 0)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_869_DET';
      v_tparam       VARCHAR2(1000)
           := 'd=' || p_fdesde || ' h=' || p_fhasta || ' e=' || p_cempres || ' p=' || p_previo;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_ini := 'TO_DATE(' || CHR(39) || p_fdesde || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 110;
      v_fin := 'TO_DATE(' || CHR(39) || p_fhasta || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 120;
      v_idi := NVL(f_usu_idioma, 3);
      --v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      v_ntraza := 130;
      v_ttexto :=
         'SELECT s.sproduc' || v_sep || 't.ttitulo' || v_sep
         || '(SELECT decode(MAX(p1.tdigitoide),null,max(p1.nnumide),MAX(p1.nnumide || ''-'' || p1.tdigitoide))'
         || v_sep || 'MAX(p2.tapelli1 || '' '' || p2.tapelli2)' || v_sep || CHR(39) || CHR(39)
         || ' FROM per_personas p1, per_detper p2 WHERE p1.sperson = c.sperson AND p2.sperson = p1.sperson'
         || ' AND p2.fmovimi = (SELECT MAX(p22.fmovimi) FROM per_detper p22 WHERE p22.sperson = p2.sperson)'
         || ')||' || '('
         || ' SELECT decode(MAX(p3.tdigitoide),null,max(p3.nnumide),MAX(p3.nnumide || ''-'' || p3.tdigitoide))'
         || v_sep || 'MAX(p4.tapelli1 || '' '' || p4.tapelli2)' || v_sep || CHR(39) || CHR(39)
         || ' FROM ctatecnica c1, companias c2, per_personas p3, per_detper p4 '
         || ' WHERE c1.ccompani = r.ccompani AND c1.nversio = r.nversio AND c1.scontra = r.scontra AND c1.ctramo = r.ctramo'
         || ' AND c1.sproduc = s.sproduc AND c2.ccompani = c1.ccorred AND p3.sperson = c2.sperson AND p4.sperson = p3.sperson'
         || ' AND p4.fmovimi = (SELECT MAX(p44.fmovimi) FROM per_detper p44 WHERE p44.sperson = p4.sperson)'
         || ')||' || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'NVL(r.importe, 0)'
         || v_sep || 'NVL(r.import2, 0)' || v_sep || 'NVL(r.import3, 0)' || v_sep
         || 'ps.crespue' || v_sep || 'dp.tvalpar' || v_sep || 'dp2.tvalpar' || v_sep
         || '(select max(tdescri) from monedas where cidioma = ' || v_idi
         || ' and cmoneda = pr.cdivisa)' || v_sep
         || '(select m.fmovini from movrecibo m where m.nrecibo = r.nrecibo and m.cestrec = 1 and m.nrecibo NOT IN(SELECT nrecibo FROM detmovrecibo)'
         || 'union select k.fmovimi from detmovrecibo k where k.nrecibo = r.nrecibo and k.norden = 1)'
         || v_sep || 'r.fefecto' || v_sep || CHR(39) || CHR(39) || ' linea ' || ' FROM';

      IF p_previo = 1 THEN
         -- PREVIO
         v_ttexto :=
            v_ttexto || '     (SELECT  SUM(icesion) importe,'
            || '              SUM(icomisi) import2,'
            || '              SUM(icesion-icomisi) import3, fcierre,'
            || '              DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)) fcontab,'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '        FROM  reaseguroaux r, cuacesfac cc WHERE r.cgenera <> 2'
            || '        AND   r.FCIERRE BETWEEN ' || v_ini || ' and ' || v_fin
            || ' AND r.cempres = ' || v_emp || '        AND   r.ccompani = cc.ccompani'
            || '        AND   r.sfacult = cc.sfacult AND preserv IS NOT NULL'
            || '        GROUP BY fcierre, DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)),'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '     ) r,';
      ELSE
         -- REAL
         v_ttexto :=
            v_ttexto || '     (SELECT  SUM(NVL(icesion_moncon, icesion)) importe,'
            || '              SUM(NVL(icomisi_moncon, icomisi)) import2,'
            || '              SUM(NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi)) import3, fcierre,'
            || '              DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)) fcontab,'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '        FROM  reaseguro r, cuacesfac cc WHERE r.cgenera <> 2'
            || '        AND   r.FCIERRE BETWEEN ' || v_ini || ' and ' || v_fin
            || ' AND r.cempres = ' || v_emp || '        AND   r.ccompani = cc.ccompani'
            || '        AND   r.sfacult = cc.sfacult AND preserv IS NOT NULL'
            || '        GROUP BY fcierre, DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)),'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '     ) r,';
      END IF;

      v_ttexto :=
         v_ttexto
         || '     seguros s, companias c, productos pr, pregunpolseg ps, pargaranpro pg, detparam dp, pargaranpro pg2, detparam dp2, titulopro t'
         || ' WHERE t.cramo = r.cramo AND t.cmodali = r.cmodali AND t.ctipseg = r.ctipseg AND t.ccolect = r.ccolect AND t.cidioma = '
         || v_idi
         || ' AND s.sseguro = r.sseguro AND r.nsinies IS NULL AND c.ccompani = r.ccompani AND s.sproduc = pr.sproduc AND NVL(r.importe, 0) <> 0'
         || ' AND ps.sseguro = s.sseguro AND ps.nmovimi = (SELECT MAX(nmovimi) FROM pregunpolseg WHERE sseguro = s.sseguro'
         || ' AND cpregun = 414 AND nmovimi <= r.nmovimi) AND ps.cpregun = 414 AND s.cramo = pg.cramo AND s.cmodali = pg.cmodali'
         || ' AND s.ctipseg = pg.ctipseg AND s.ccolect = pg.ccolect AND s.cactivi = pg.cactivi AND s.sproduc = pg.sproduc'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND r.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg.cvalpar = dp.cvalpar AND s.cmodali = pg2.cmodali AND s.ctipseg = pg2.ctipseg AND s.ccolect = pg2.ccolect'
         || ' AND s.cactivi = pg2.cactivi AND s.sproduc = pg2.sproduc AND pg2.cpargar = ''CLAKEIRARAMO'' AND r.cgarant = pg2.cgarant'
         || ' AND pg2.cpargar = dp2.cparam AND dp2.cidioma = ' || v_idi
         || ' AND pg2.cvalpar = dp2.cvalpar'
--------------------------------------------------------------
         -- Bug 26430 - 05/05/2014 - JMF
         || ' UNION ALL ' || ' SELECT s.sproduc' || v_sep || 't.ttitulo' || v_sep
         || '(SELECT decode(MAX(p1.tdigitoide),null,max(p1.nnumide),MAX(p1.nnumide || ''-'' || p1.tdigitoide))'
         || v_sep || 'MAX(p2.tapelli1 || '' '' || p2.tapelli2)' || v_sep || CHR(39) || CHR(39)
         || ' FROM per_personas p1, per_detper p2 WHERE p1.sperson = c.sperson AND p2.sperson = p1.sperson AND p2.fmovimi = (SELECT MAX(p22.fmovimi)'
         || ' FROM per_detper p22 WHERE p22.sperson = p2.sperson)' || ')||' || '('
         || 'SELECT decode(MAX(p3.tdigitoide),null,max(p3.nnumide),MAX(p3.nnumide || ''-'' || p3.tdigitoide))'
         || v_sep || 'MAX(p4.tapelli1 || '' '' || p4.tapelli2)' || v_sep || CHR(39) || CHR(39)
         || ' FROM ctatecnica c1, companias c2, per_personas p3, per_detper p4 WHERE c1.ccompani = r.ccompani AND c1.nversio = r.nversio'
         || ' AND c1.scontra = r.scontra AND c1.ctramo = r.ctramo AND c1.sproduc = s.sproduc AND c2.ccompani = c1.ccorred AND p3.sperson = c2.sperson'
         || ' AND p4.sperson = p3.sperson AND p4.fmovimi = (SELECT MAX(p44.fmovimi) FROM per_detper p44 WHERE p44.sperson = p4.sperson)'
         || ')||' || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'NVL(r.importe, 0)'
         || v_sep || 'NVL(r.import2, 0)' || v_sep || 'NVL(r.import3, 0)' || v_sep
         || 'ps.crespue' || v_sep || 'dp.tvalpar' || v_sep || 'dp2.tvalpar' || v_sep
         || '(select max(tdescri) from monedas where cidioma = ' || v_idi
         || ' and cmoneda = pr.cdivisa)' || v_sep
         || '(select m.fmovini from movrecibo m where m.nrecibo = r.nrecibo and m.cestrec = 1 and m.nrecibo NOT IN(SELECT nrecibo FROM detmovrecibo)'
         || ' union select k.fmovimi from detmovrecibo k where k.nrecibo = r.nrecibo and k.norden = 1)'
         || v_sep || ' r.fefecto' || v_sep || CHR(39) || CHR(39) || ' linea' || ' FROM';

      IF p_previo = 1 THEN
         -- PREVIO
         v_ttexto :=
            v_ttexto || '      (SELECT SUM(icesion) importe, SUM(icomisi) import2,'
            || '              SUM(icesion-icomisi) import3, fcierre,'
            || '              DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)) fcontab,'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '         FROM reaseguroaux r, cuadroces cc'
            || '         WHERE r.cgenera <> 2 AND r.FCIERRE BETWEEN ' || v_ini || ' and '
            || v_fin || ' AND r.cempres = ' || v_emp
            || '         AND   r.ccompani = cc.ccompani AND r.scontra = cc.scontra AND r.nversio = cc.nversio AND r.ctramo = cc.ctramo'
            || '         AND   preserv IS NOT NULL'
            || '         GROUP BY fcierre, DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)),'
            || '               r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '               r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '       ) r,';
      ELSE
         -- REAL
         v_ttexto :=
            v_ttexto
            || '      (SELECT SUM(NVL(icesion_moncon, icesion)) importe, SUM(NVL(icomisi_moncon, icomisi)) import2,'
            || '              SUM(NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi)) import3, fcierre,'
            || '              DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)) fcontab,'
            || '              r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '              r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '         FROM reaseguro r, cuadroces cc'
            || '         WHERE r.cgenera <> 2 AND r.FCIERRE BETWEEN ' || v_ini || ' and '
            || v_fin || ' AND r.cempres = ' || v_emp
            || '         AND   r.ccompani = cc.ccompani AND r.scontra = cc.scontra AND r.nversio = cc.nversio AND r.ctramo = cc.ctramo'
            || '         AND   preserv IS NOT NULL'
            || '         GROUP BY fcierre, DECODE(TRUNC(fcalcul), TRUNC(f_sysdate), TO_DATE(NULL), TRUNC(fcalcul)),'
            || '               r.ccompani, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto, r.scontra,'
            || '               r.nmovimi, r.cgarant, r.cramo, r.cmodali, r.ctipseg, r.ccolect, r.nversio, r.nrecibo'
            || '       ) r,';
      END IF;

      v_ttexto :=
         v_ttexto
         || '       seguros s, companias c, productos pr, pregunpolseg ps, pargaranpro pg, detparam dp, pargaranpro pg2, detparam dp2, titulopro t'
         || ' WHERE t.cramo = r.cramo AND t.cmodali = r.cmodali AND t.ctipseg = r.ctipseg AND t.ccolect = r.ccolect AND t.cidioma = '
         || v_idi
         || ' AND s.sseguro = r.sseguro AND r.nsinies IS NULL AND c.ccompani = r.ccompani AND s.sproduc = pr.sproduc AND NVL(r.importe, 0) <> 0'
         || ' AND ps.sseguro = s.sseguro AND ps.nmovimi = (SELECT MAX(nmovimi) FROM pregunpolseg WHERE sseguro = s.sseguro'
         || ' AND cpregun = 414 AND nmovimi <= r.nmovimi) AND ps.cpregun = 414 AND s.cramo = pg.cramo AND s.cmodali = pg.cmodali'
         || ' AND s.ctipseg = pg.ctipseg AND s.ccolect = pg.ccolect AND s.cactivi = pg.cactivi AND s.sproduc = pg.sproduc'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND r.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi
         || ' AND pg.cvalpar = dp.cvalpar AND s.cmodali = pg2.cmodali AND s.ctipseg = pg2.ctipseg AND s.ccolect = pg2.ccolect'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND s.cactivi = pg2.cactivi AND s.sproduc = pg2.sproduc AND pg2.cpargar = ''CLAKEIRARAMO'' AND r.cgarant = pg2.cgarant'
         || ' AND pg2.cpargar = dp2.cparam AND dp2.cidioma = ' || v_idi
         || ' AND pg2.cvalpar = dp2.cvalpar';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_869_det;

   /******************************************************************************************
     Descripció: Cabecera del map 870 Previo de liquidación de comisiones
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_870_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_870_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_idi := NVL(f_usu_idioma, 3);

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905305, ' || v_idi || ') || CHR(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39)
                                                -- espacios
                  || ' ||CHR(10)||'
                                   --|| 'f_axis_literales(9905334 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(111471  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9002109 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905562 ,' || v_idi || ')' || v_sep   -- Nombre ramo
                  || 'f_axis_literales(100829  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9000909 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000909 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001213 ,' || v_idi || ')' || v_sep   -- Tipo destinatario
                  || 'f_axis_literales(9001639 ,' || v_idi || ')' || v_sep   -- Nº póliza
                  || 'f_axis_literales(104595  ,' || v_idi || ')' || v_sep   -- Item
                  || 'f_axis_literales(800636  ,' || v_idi || ')' || v_sep   -- Nº recibo
                  || 'f_axis_literales(9905708 ,' || v_idi || ')' || v_sep   -- Comision Directa
                  || 'f_axis_literales(9905338 ,' || v_idi || ')'
                  || v_sep   -- Comisiones Intermediación
                          || 'f_axis_literales(9905322 ,' || v_idi || ')'
                  || v_sep   -- Comisión uso de canal
                          || 'f_axis_literales(9905321 ,' || v_idi || ')'
                  || v_sep   -- Comisión acceso preferente
                          || 'f_axis_literales(9905320 ,' || v_idi || ')'
                  || v_sep   -- Comisión por Recaudación
                          || 'f_axis_literales(108645  ,' || v_idi || ')' || v_sep   -- Moneda
                  || 'f_axis_literales(101573  ,' || v_idi || ')' || v_sep   -- Fecha pago
                  || 'f_axis_literales(1000575 ,' || v_idi || ')' || v_sep   -- Fecha contable
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_870_cab;

   /******************************************************************************************
     Descripció: Detalle del map 870 Previo de liquidación de comisiones
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_870_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_870_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY'')';
      v_idi := f_usu_idioma;

      IF v_idi IS NULL THEN
         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      END IF;

      v_emp := f_empres;

      IF v_emp IS NULL THEN
         v_emp := f_parinstalacion_n('EMPRESADEF');
      END IF;

      -- bug 26430 - 31/10/2013 - JMF
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_tmoneda
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      -- bug 26430 - 17/06/2014 - JMF
      v_ttexto :=
         ' SELECT '
                   --|| ' null ' || v_sep   -- nAgrupa,
         || '(select max(trespue) from pregunseg x1'
         || ' where x1.SSEGURO=s.sseguro and x1.NRIESGO=d.nriesgo and x1.CPREGUN=428'
         || ' and x1.NMOVIMI=(select max(x2.NMOVIMI) from pregunseg x2 where x2.SSEGURO=s.sseguro'
         || '  and x2.NRIESGO=d.nriesgo and x2.CPREGUN=428 and x2.NMOVIMI<=r.nmovimi))'
         || v_sep   -- Agrupacion,
                 || ' s.cramo' || v_sep || 'ra.TRAMO' || v_sep || 's.sproduc' || v_sep
         || 't.ttitulo' || v_sep || CHR(39) || CHR(39) || v_sep   -- Rut Destinatario
         || CHR(39) || CHR(39) || v_sep   -- Destinatario
                                       || 'ff_desvalorfijo(371,' || v_idi || ',ac.ctipint)'
         || v_sep || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'r.nrecibo' || v_sep
         || '(sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,'
         || ' decode(r.ctiprec,9,-1,13,-1,1)'
         || ' *decode(d.cconcep,11,pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ','
         || CHR(39) || v_tmoneda || CHR(39) || ',cc.fcambio,d.iconcep,1)'
         || ' *decode(m.cestrec,1,1,-1),0), 0)))' || v_sep   -- comision directa
         || '(sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,'
         || ' decode(r.ctiprec,9,-1,13,-1,1)'
         || ' *decode(d.cconcep,11,pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ','
         || CHR(39) || v_tmoneda || CHR(39) || ',cc.fcambio,d.iconcep,1)'
         || ' *decode(m.cestrec,1,1,-1),0), 0)))' || v_sep   -- Comisiones Intermediación,
         || 'sum(decode(d.cconcep, 48,' || ' decode(r.ctiprec,9,-1,13,-1,1)'
         || ' *pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ' ,0))' || v_sep   -- Comis canal
         || 'sum(decode(d.cconcep, 49,' || ' decode(r.ctiprec,9,-1,13,-1,1)'
         || ' *pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ' ,0))'
         || v_sep   -- Comisión acceso preferente
                 || 'sum(decode(d.cconcep, 47,' || ' decode(r.ctiprec,9,-1,13,-1,1)'
         || ' *pac_eco_tipocambio.f_importe_cambio( mon.cmonint' || ',' || CHR(39) || v_tmoneda
         || CHR(39) || ',cc.fcambio,d.iconcep,1)' || ' ,0))'
         || v_sep   -- Comisión por Recaudación
                 -- bug 26430/146998 - 18/06/2013 - JMF
         || ' mon.tdescri' || v_sep   -- divisa
                                   || ' max(m.FMOVINI)' || v_sep   -- Fecha pago
         || ' max(m.FCONTAB)' || v_sep   -- Fecha contable
                                      || CHR(39) || CHR(39) || ' linea'
         || ' FROM SEGUROS s,ramos ra, TITULOPRO t, DETRECIBOS d, MOVRECIBO m, RECIBOS r, PRODUCTOS p, PREGUNPOLSEG ps, PARGARANPRO pg,'
         || ' DETPARAM dp, PARGARANPRO pg2, DETPARAM dp2,' || ' AGENTES_COMP ac'
         || ' , ctacliente cc, monedas mon' || ' WHERE s.sproduc = p.sproduc'
         || ' AND s.cagente = ac.cagente' || ' AND ra.cramo = s.cramo and ra.CIDIOMA=' || v_idi
         -- ini bug 26430 - 31/10/2013 - JMF
         || ' and mon.CIDIOMA=' || v_idi || ' and mon.CMONEDA=p.cdivisa'
         || ' and cc.nrecibo = m.nrecibo' || ' and cc.ffecmov = trunc(m.FMOVDIA)'
         || ' and cc.cmovimi in (2,5) '   -- cuotas, anulaciones
         -- fin bug 26430 - 31/10/2013 - JMF
         || ' AND t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect'
         -- bug 26422 dcg 7-5-2013
         -- || ' AND ps.nmovimi = r.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro=s.sseguro and cpregun=414 and nmovimi<=r.nmovimi)'
         || ' AND ps.cpregun = 414' || ' AND r.ctiprec in (0, 1, 3, 9, 13, 15)'
         || ' AND ps.sseguro=s.sseguro' || ' AND t.cidioma = ' || v_idi
         || ' and M.Fcontab between ' || v_ini || ' and ' || v_fin
         || ' AND s.sseguro = r.sseguro' || ' AND r.nrecibo = d.nrecibo'
         || ' AND r.nrecibo = m.nrecibo' || ' AND r.cestaux = 0'
         || ' AND d.cconcep in (0,11,47,48,49)' || ' AND d.nrecibo = m.nrecibo'
         || ' AND ( (m.cestrec = 1 ) OR (m.cestrec = 0 AND m.cestant = 1))'
         || ' AND NOT EXISTS (Select ''1'' From Detmovrecibo Dm Where Dm.Nrecibo = M.Nrecibo)'
         || ' AND s.sproduc = pg.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi || ' AND pg.cvalpar = dp.cvalpar' || ' AND s.sproduc = pg2.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam AND dp2.cidioma = '
         || v_idi || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' group by null,null,s.cramo, ra.tramo,s.sproduc, t.ttitulo, '
         || ' ff_desvalorfijo(371,' || v_idi || ',ac.ctipint),' || ' s.npoliza, s.ncertif, '
         || ' s.sseguro, d.nriesgo, r.nmovimi, r.nrecibo, p.cdivisa, mon.tdescri'
-----------------------
         || ' UNION '
-----------------------
         || ' SELECT '
                      --|| ' null ' || v_sep   -- nAgrupa,
         || '(select max(trespue) from pregunseg x1'
         || ' where x1.SSEGURO=s.sseguro and x1.NRIESGO=d.nriesgo and x1.CPREGUN=428'
         || ' and x1.NMOVIMI=(select max(x2.NMOVIMI) from pregunseg x2 where x2.SSEGURO=s.sseguro'
         || '  and x2.NRIESGO=d.nriesgo and x2.CPREGUN=428 and x2.NMOVIMI<=r.nmovimi))'
         || v_sep   -- Agrupacion,
                 || ' s.cramo' || v_sep || 'ra.TRAMO' || v_sep || 's.sproduc' || v_sep
         || 't.ttitulo' || v_sep || CHR(39) || CHR(39) || v_sep   -- Rut Destinatario
         || CHR(39) || CHR(39) || v_sep   -- Destinatario
                                       || 'ff_desvalorfijo(371,' || v_idi || ',ac.ctipint)'
         || v_sep || 's.npoliza' || v_sep || 's.ncertif' || v_sep || 'r.nrecibo' || v_sep
         -- ini bug 26430 - 31/10/2013 - JMF
         || '(sum(decode(pac_propio.f_agentecorredor(ac.ctipint),0,decode(d.cconcep,11,'
         || ' d.iconcep_monpol' || ',0),0)))' || v_sep   -- comision directa
         || '(sum(decode(pac_propio.f_agentecorredor(ac.ctipint),1,decode(d.cconcep,11,'
         || ' d.iconcep_monpol' || ',0),0)))' || v_sep   -- comision Intermediación
         || '(sum(decode(d.cconcep,48,' || ' d.iconcep_monpol' || ',0)))'
         || v_sep   -- Comision uso canal
                 || '(sum(decode(d.cconcep,49,' || ' d.iconcep_monpol' || ',0)))'
         || v_sep   -- ComisAccPreferente,
                 || '(sum(decode(d.cconcep,47,' || ' d.iconcep_monpol' || ',0)))'
         || v_sep   -- ComisAccPreferente,
                 -- fin bug 26430 - 31/10/2013 - JMF
                 -- bug 26430/146998 - 18/06/2013 - JMF
                 --|| '(select max(tdescri) from monedas where cidioma=' || v_idi|| ' and cmoneda=p.cdivisa)' || v_sep   -- divisa
         || 'mon.tdescri' || v_sep   -- divisa
                                  || ' max(m.FMOVIMI)' || v_sep   -- Fecha pago
         || ' max(m.FCONTAB)' || v_sep   -- Fecha contable
                                      || CHR(39) || CHR(39) || ' linea'
         || ' FROM SEGUROS s,ramos ra, TITULOPRO t, Detmovrecibo_parcial d, DETMOVRECIBO m, RECIBOS r, PRODUCTOS p, PREGUNPOLSEG ps, PARGARANPRO pg,'
         || ' DETPARAM dp, PARGARANPRO pg2, DETPARAM dp2, '
         || ' AGENTES_COMP ac, vdetrecibos vd, vdetrecibos_monpol vm ' || ' , monedas mon'
         || ' WHERE s.sproduc = p.sproduc'
                                          -- ini bug 26430 - 31/10/2013 - JMF
         || ' and mon.CIDIOMA=' || v_idi || ' and mon.CMONEDA=p.cdivisa'
         -- fin bug 26430 - 31/10/2013 - JMF
         || ' AND s.cagente = ac.cagente' || ' AND ra.cramo = s.cramo and ra.CIDIOMA=' || v_idi
         || ' AND t.cramo = s.cramo  AND t.cmodali = s.cmodali AND t.ctipseg = s.ctipseg  AND t.ccolect = s.ccolect'
         -- bug 26422 dcg 7-5-2013
         -- || ' AND ps.nmovimi = r.nmovimi'
         || ' AND ps.nmovimi=(select max(nmovimi) from pregunpolseg where sseguro = s.sseguro and cpregun = 414 and nmovimi <= r.nmovimi)'
         || ' AND ps.cpregun = 414' || ' AND r.ctiprec in (0, 1, 3, 9, 13, 15)'
         || ' AND ps.sseguro=s.sseguro' || ' AND t.cidioma = ' || v_idi
         || ' and M.Fcontab between ' || v_ini || ' and ' || v_fin
         || ' AND s.sseguro = r.sseguro' || ' AND r.nrecibo = d.nrecibo'
         || ' AND r.nrecibo = m.nrecibo' || ' AND r.cestaux = 0'
         || ' AND d.cconcep in (0,11,47,48,49)' || ' AND d.nrecibo = m.nrecibo'
         || ' AND m.norden = D.Norden' || ' AND s.sproduc = pg.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' AND pg.cpargar = ''SUBCLAKEIRA'' AND d.cgarant = pg.cgarant AND pg.cpargar = dp.cparam AND dp.cidioma = '
         || v_idi || ' AND pg.cvalpar = dp.cvalpar' || ' AND s.sproduc = pg2.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' AND pg2.cpargar = ''CLAKEIRARAMO'' AND d.cgarant = pg2.cgarant AND pg2.cpargar = dp2.cparam AND dp2.cidioma = '
         || v_idi || ' AND pg2.cvalpar = dp2.cvalpar'
         || ' and vd.nrecibo = r.nrecibo and vm.nrecibo = r.nrecibo'
         || ' group by NULL, NULL, s.cramo, ra.tramo,s.sproduc, t.ttitulo, '
         || ' ff_desvalorfijo(371,' || v_idi || ',ac.ctipint),' || ' s.npoliza, s.ncertif, '
         || ' s.sseguro, d.nriesgo, r.nmovimi, r.nrecibo, p.cdivisa, mon.tdescri';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_870_det;

   /******************************************************************************************
     Descripció: Cabecera del map 738 Listado de Facturación
     return:     texto cabecera
     -- bug 26721/142621 - 18/04/2013 - MGM
   ******************************************************************************************/
   FUNCTION f_889_cab(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_889_CAB';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_vcidioma     NUMBER;
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_idi := NVL(NVL(v_vcidioma, f_usu_idioma), 3);

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ttexto := 'SELECT'
                          -- nombre listado
                  || '  f_axis_literales(9905414 ,' || v_idi || ') ||chr(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836 ,' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || 'f_axis_literales(101837 ,' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39) || '||chr(10)||'
                  || ' f_axis_literales(103465 ,' || v_idi || ')   ' || v_sep
                  || ' f_axis_literales(150996  ,' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9000445 ,' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(800636 ,' || v_idi || ')  ' || v_sep
                  || ' f_axis_literales(9905175 ,' || v_idi || ')  ' || v_sep
                  || ' f_axis_literales(9902911 ,' || v_idi || ')   ' || v_sep
                  || ' f_axis_literales(9905200 ,' || v_idi || ')  ' || v_sep
                  || ' f_axis_literales(9903357 ,' || v_idi || ')  ' || v_sep
                  || ' f_axis_literales(9000805 ,' || v_idi || ')   ' || v_sep
                  || ' f_axis_literales(9001320 ,' || v_idi || ')  ' || v_sep
                  || ' f_axis_literales(9905412  ,' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9905413  ,' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(101340  ,' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(1000529  ,' || v_idi || ') ' || v_sep || CHR(39)
                  || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_889_cab;

   /******************************************************************************************
     Descripció: Detalle del map 738 Listado de Facturación
     return:     texto detalle
     -- bug 26721/142621 - 18/04/2013 - MGM
   ******************************************************************************************/
   FUNCTION f_889_det(fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_889_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      w_cmoncon      parempresas.nvalpar%TYPE;
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_ntraza := 100;
      -- w_cmoncon := pac_parametros.f_parempresa_n(16, 'MONEDACONTAB');
      w_cmoncon := pac_parametros.f_parempresa_n(v_emp, 'MONEDACONTAB');

      -- bug 26430 - 31/10/2013 - JMF
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_tmoneda
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      v_ntraza := 105;
      v_ini := 'TRUNC(TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY''))';
      -- BUG 26430/147498 - FAL - 26/6/2013 - Añadir trunc
      v_ntraza := 110;
      v_fin := 'TRUNC(TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY''))';
      -- BUG 26430/147498 - FAL - 26/6/2013 - Añadir trunc
      -- bug 26430 - 04/12/2013 - JMF: max per_detper
      v_ntraza := 120;
      v_ttexto :=
         'SELECT DECODE(EXTORNO,1,''NC'', DECODE(NVL(tasaimp, 0), 0, ''FX'', ''FA'')) '
         || v_sep
         || '    DECODE(EXTORNO,1,''Nota Crédito'', DECODE(NVL(tasaimp, 0), 0, ''Factura Excenta'', ''Factura Afecta'')) '
         || v_sep || '    NFACT' || v_sep   -- columna nº factura
                                         || '    NDOCUMENTO' || v_sep || '  NPOLIZA  ' || v_sep
         || ' NCERTIF  ' || v_sep || '    per.nnumide  || '' - '' ||   per.tdigitoide '
         || v_sep
         || '    p.tnombre1 || '' '' ||    p.tnombre2 || '' '' || p.tapelli1  || '' '' ||    p.tapelli2 '
         || v_sep || '    FDOCUMENTO' || v_sep || '    TASAIMP' || v_sep
         || ' f_round(MONTOAFECTO,' || w_cmoncon || ')' || v_sep || ' f_round(MONTOEXCENTO,'
         || w_cmoncon || ')' || v_sep || ' f_round(IVA,' || w_cmoncon || ')' || v_sep
         || ' f_round(TOTAL,' || w_cmoncon || ')' || v_sep || CHR(39) || CHR(39) || ' linea'
         || '  FROM (SELECT   B.NPOLIZA, B.NCERTIF, B.NDOCUMENTO, B.FDOCUMENTO, EXTORNO, SUM(B.TASAIMP) TASAIMP, B.SPERSON,'
         || '                 SUM(B.MONTOAFECTO) MONTOAFECTO, SUM(B.MONTOEXCENTO) MONTOEXCENTO, SUM(B.IVA) IVA, SUM(B.TOTAL) TOTAL, max(nfact) NFACT, cobjase '
         || '          FROM (SELECT   A.NPOLIZA, A.NCERTIF, A.NDOCUMENTO, A.FDOCUMENTO, a.EXTORNO,'
         || '                         NVL(A.TASAIMP, 0) TASAIMP, A.SPERSON,'
         || '                         SUM(DECODE(A.TASAIMP, NULL, 0, A.MONTO)) MONTOAFECTO,'
         || '                         SUM(DECODE(A.TASAIMP, NULL, A.MONTO, 0)) MONTOEXCENTO,'
         || '                         SUM(A.IVA) IVA, SUM(A.MONTO + A.IVA) TOTAL, max(nfact) NFACT, cobjase'
         || '                  FROM (SELECT   R.NRECIBO NDOCUMENTO, TRUNC(M.FMOVDIA) FDOCUMENTO, DECODE(CTIPREC,9,1,0) EXTORNO, '
         || '                                 (SELECT NVALCON FROM IMPREC WHERE CCONCEP = 4'
         || '                                    AND CRAMO = S.CRAMO AND CMODALI = S.CMODALI AND CTIPSEG = S.CTIPSEG AND CCOLECT = S.CCOLECT'
         || '                                    AND CACTIVI = S.CACTIVI AND CGARANT = D.CGARANT) TASAIMP,'
         || '                                  S.NPOLIZA, S.NCERTIF, D.CGARANT, RI.SPERSON,'
         -- bug 26430 - 25/11/2013 - JMF: Canvi imports
         || '                                  DECODE(d.cconcep,0, DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 1, 1, -1)'
         || '                                  * pac_eco_tipocambio.f_importe_cambio(mon.cmonint,'
         || CHR(39) || v_tmoneda || CHR(39) || ',cc.fcambio,d.iconcep, 1)'
         || '                                  ,0) MONTO,'
         || '                                  DECODE(d.cconcep,4, DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec, 1, 1, -1)'
         || '                                  * pac_eco_tipocambio.f_importe_cambio(mon.cmonint,'
         || CHR(39) || v_tmoneda || CHR(39) || ',cc.fcambio,d.iconcep, 1)'
         || '                                  ,0) IVA,'
         || '                                  (select max(nfact) from detfactura where nrecibo=r.nrecibo) nfact, pr.cobjase '
         || '                             FROM SEGUROS S, DETRECIBOS D, MOVRECIBO M, RECIBOS R, RIESGOS RI, ctacliente cc, productos pr, monedas mon'
         || '                            WHERE R.CTIPREC IN(0, 1, 3, 9)'
         -- 04/04/2014 jmf
         || '                              and cc.cmovimi in (2,5)'
         || '                              AND RI.SSEGURO = S.SSEGURO AND S.SSEGURO = R.SSEGURO'
         || '                              AND R.NRECIBO = D.NRECIBO  AND R.NRECIBO = M.NRECIBO'
         || '                              AND R.CESTAUX = 0          AND D.CCONCEP IN(0, 4)'
         || '                              and cc.nrecibo = m.nrecibo'
         || '                              and cc.ffecmov = trunc(m.FMOVDIA)'
         || '                              and pr.sproduc = s.sproduc and mon.cmoneda=pr.cdivisa and mon.cidioma=3'
--         || '                              AND ri.nriesgo = r.nriesgo AND M.CESTREC = 1'
         || '                              AND ri.nriesgo = d.nriesgo AND M.CESTREC = 1'
         -- BUG 0035387 - FAL - 31/03/2015
         || '                              AND trunc(M.FMOVDIA) BETWEEN ' || v_ini || ' AND '
         || v_fin
         || '                              AND not exists (select ''1'' from detmovrecibo dm where dm.nrecibo = r.nrecibo)'
         || 'UNION ALL'
         || ' SELECT r.nrecibo ndocumento, TRUNC(dm.fmovimi) fdocumento, 0 extorno,'
         || '        (SELECT nvalcon FROM imprec WHERE cconcep=4 AND cramo=s.cramo AND cmodali=s.cmodali'
         || '            AND ctipseg = s.ctipseg AND ccolect = s.ccolect And Cactivi = S.Cactivi And Cgarant = Dp.Cgarant) Tasaimp,'
         || '            S.Npoliza, S.Ncertif, Dp.Cgarant, Ri.Sperson,'
         || '            Decode(Dp.Cconcep, 0, Decode(M.Cestrec, 2, NVL(-dp.iconcep_monpol, 0), NVL(dp.iconcep_monpol, 0)),0)Monto,'
         || '            DECODE(dp.cconcep, 4, Decode(M.Cestrec, 2, NVL(-dp.iconcep_monpol, 0), NVL(dp.iconcep_monpol, 0)),0) iva,'
         || '            (SELECT MAX(nfact) From Detfactura Where Nrecibo = R.Nrecibo) Nfact, p.cobjase '
         || '              FROM detmovrecibo dm, detmovrecibo_parcial dp, movrecibo m, Seguros S, Recibos R, Riesgos Ri, Productos p'
         || '              Where R.Ctiprec In (0, 1, 3, 9)'
         || '              and TRUNC(dm.fmovimi) Between ' || v_ini || ' AND ' || v_fin
         || '              And Dp.Smovrec = Dm.Smovrec'
         || '              And Dp.Norden = Dm.Norden'
         || '              And Dp.Cconcep In(0, 4)'
         || '                      AND ri.sseguro = s.sseguro'
         || '                      AND p.sproduc = s.sproduc'
         || '                      And S.Sseguro = R.Sseguro'
         || '                      And R.Nrecibo = Dp.Nrecibo'
--         || '                      AND ri.nriesgo = r.nriesgo'
         || '                      AND ri.nriesgo = dp.nriesgo'
         -- BUG 0035387 - FAL - 31/03/2015
         || '                      And R.Nrecibo = M.Nrecibo'
         || '                      And R.Cestaux = 0'
         || '                      AND m.cestrec NOT IN(2)'
         || '                      And M.Fmovfin Is Null'
         || '                      And M.Cestant = 0' || ' ) A'
         || '              GROUP BY A.NPOLIZA, A.NCERTIF, A.NDOCUMENTO, A.FDOCUMENTO, A.EXTORNO, A.TASAIMP,  A.SPERSON, a.cobjase'
         || '              having (sum(monto) <> 0 or sum(iva)<>0) ) B'
         || '    GROUP BY B.NPOLIZA, B.NCERTIF, B.NDOCUMENTO, B.EXTORNO, B.FDOCUMENTO, B.SPERSON, b.cobjase) C,'
         || '          per_detper p, per_personas per'
--         || '     WHERE TRUNC(p.fmovimi) = (SELECT TRUNC(MAX(fmovimi)) FROM per_detper WHERE sperson = C.sperson)'                -- BUG 0035387 - FAL - 31/03/2015
--         || '     AND C.sperson = p.sperson AND C.sperson = per.sperson';
         || '     WHERE ((TRUNC(p.fmovimi) = (SELECT TRUNC(MAX(fmovimi)) FROM per_detper WHERE sperson = c.sperson) ) OR c.cobjase = 3 ) '
         || '     AND C.sperson = p.sperson (+) AND C.sperson = per.sperson (+)';
      v_ntraza := 130;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_889_det;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   FUNCTION f_get_var_ressiniestros(pdesde IN DATE, phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_var_ressiniestros';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      linea_ini      VARCHAR2(4000);
      i              NUMBER := 0;
      v_linea        VARCHAR2(4000);
      to_add         NUMBER;
      tmp_linea      VARCHAR2(4000);
      linea_ini2     VARCHAR2(4000);
      i2             NUMBER := 0;
      v_linea2       VARCHAR2(4000);
      to_add2        NUMBER;
      linea_final2   VARCHAR2(4000);
      tmp_linea2     VARCHAR2(4000);
      tmp_linea_final VARCHAR2(4000);
      linea_final    VARCHAR2(4000);
   BEGIN
      SELECT imp1.imp
        INTO linea_ini
        FROM (SELECT pac_informes_152.f_get_sinporpagar_emprodliquid(pdesde, phasta,
                                                                     pcidioma, 1) imp
                FROM DUAL) imp1;   --23

      SELECT imp2.imp
        INTO linea_ini2
        FROM (SELECT pac_informes_152.f_get_sinporpagar_emprodliquid(pdesde, phasta,
                                                                     pcidioma, 2) imp
                FROM DUAL) imp2;   --24

      tmp_linea := linea_ini;
      tmp_linea2 := linea_ini2;
      i := LENGTH(linea_ini);
      i2 := LENGTH(linea_ini2);

      WHILE i >= 0
        OR i2 >= 0 LOOP
         to_add := INSTR(tmp_linea, ';');
         v_linea := SUBSTR(tmp_linea, 0,(to_add - 1));
         tmp_linea := SUBSTR(tmp_linea, to_add + 1, LENGTH(tmp_linea));
         to_add2 := INSTR(tmp_linea2, ';');
         v_linea2 := SUBSTR(tmp_linea2, 0,(to_add2 - 1));
         tmp_linea2 := SUBSTR(tmp_linea2, to_add2 + 1, LENGTH(tmp_linea2));
         tmp_linea_final := TO_NUMBER(NVL(v_linea, 0) - NVL(v_linea2, 0));
         linea_final := linea_final || tmp_linea_final || ';';
         i := to_add;
         i2 := to_add2;
      END LOOP;

      v_ttexto := linea_final;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_var_ressiniestros;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   FUNCTION f_get_sini_pagados(pdesde IN DATE, phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sini_pagados';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimporte       NUMBER := 0;
      linea_ini      VARCHAR2(4000);
      i              NUMBER := 0;
      v_linea        VARCHAR2(4000);
      to_add         NUMBER;
      tmp_linea      VARCHAR2(4000);
      linea_ini2     VARCHAR2(4000);
      i2             NUMBER := 0;
      v_linea2       VARCHAR2(4000);
      to_add2        NUMBER;
      linea_final2   VARCHAR2(4000);
      tmp_linea2     VARCHAR2(4000);
      tmp_linea_final VARCHAR2(4000);
      linea_final    VARCHAR2(4000);
   BEGIN
      SELECT imp1.imp
        INTO linea_ini
        FROM (SELECT pac_informes_152.f_get_sinpagados_direc(pdesde, phasta, pcidioma, 1) imp
                FROM DUAL) imp1;   --10

      SELECT imp2.imp
        INTO linea_ini2
        FROM (SELECT pac_informes_152.f_get_sinpagados_reacedido(pdesde, phasta, pcidioma,
                                                                 1) imp
                FROM DUAL) imp2;   --14

      tmp_linea := linea_ini;
      tmp_linea2 := linea_ini2;
      i := LENGTH(linea_ini);
      i2 := LENGTH(linea_ini2);

      WHILE i >= 0
        OR i2 >= 0 LOOP
         to_add := INSTR(tmp_linea, ';');
         v_linea := SUBSTR(tmp_linea, 0,(to_add - 1));
         tmp_linea := SUBSTR(tmp_linea, to_add + 1, LENGTH(tmp_linea));
         to_add2 := INSTR(tmp_linea2, ';');
         v_linea2 := SUBSTR(tmp_linea2, 0,(to_add2 - 1));
         tmp_linea2 := SUBSTR(tmp_linea2, to_add2 + 1, LENGTH(tmp_linea2));
         tmp_linea_final := TO_NUMBER(NVL(v_linea, 0) - NVL(v_linea2, 0));
         linea_final := linea_final || tmp_linea_final || ';';
         i := to_add;
         i2 := to_add2;
      END LOOP;

      v_ttexto := linea_final;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sini_pagados;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   FUNCTION f_get_sinpagados_direc(
      pdesde IN DATE,
      phasta IN DATE,
      pcidioma IN NUMBER,
      pselect IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sinpagados_direc';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta || ' pselect:' || pselect;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      -- Con el pselect seleccionaremos si queremos
      -- 1 siniestros del plan: (el resto de coberturas)
      -- 2 indemnización por invalidez accidental (405-Invalidez Accidental)
      -- 3 indemnizacion por muerte accidental (402-Muerte Accidental)
      v_idi := NVL(NVL(pcidioma, f_usu_idioma), 3);

      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 0026430/0146888 - 17/06/2013 - JMF : calculo de 867 - SC Pago Siniestros, Monto total
         SELECT SUM(NVL(stpg.isinretpag, stpg.isinret)
                    -(NVL(stpg.iivapag, stpg.iiva) + NVL(stpg.iretencpag, stpg.iretenc)))
                                                                                         total
           INTO v_total
           FROM seguros s, ramos ra, productos p, titulopro t, sin_siniestro si,
                sin_tramita_pago stp, sin_tramita_pago_gar stpg, sin_tramita_movpago stm,
                pargaranpro par
          WHERE s.cempres = v_emp
            AND par.cpargar = 'RAMOFECU'
            AND par.cvalpar = cur.cvalpar
            AND par.cgarant = stpg.cgarant
            AND par.sproduc = s.sproduc
            AND ra.cramo = s.cramo
            AND ra.cidioma = v_idi
            AND p.sproduc = s.sproduc
            AND t.cramo = p.cramo
            AND t.cmodali = p.cmodali
            AND t.ctipseg = p.ctipseg
            AND t.ccolect = p.ccolect
            AND t.cidioma = v_idi
            AND((pselect = 1
                 AND stpg.cgarant NOT IN(405, 402))
                OR(pselect = 2
                   AND stpg.cgarant = 405)
                OR(pselect = 3
                   AND stpg.cgarant = 402))
            AND si.sseguro = s.sseguro
            AND stp.nsinies = si.nsinies
            AND stm.falta BETWEEN pdesde AND phasta
            AND stpg.sidepag = stp.sidepag
            AND stm.sidepag = stpg.sidepag
            AND stm.cestpag = 1;

         v_ttexto := v_ttexto || NVL(v_total, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sinpagados_direc;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   -- Bug 0026430/0146888 - 17/06/2013 - JMF : pdesde
   FUNCTION f_get_sinpagados_reacedido(
      pdesde IN DATE,
      phasta IN DATE,
      pcidioma IN NUMBER,
      pselect IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sinpagados_reacedido';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta || ' pselect:' || pselect;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      -- 1 siniestros del plan: (el resto de coberturas)
      -- 2 indemnización por invalidez accidental (405-Invalidez Accidental)
      -- 3 indemnizacion por muerte accidental (402-Muerte Accidental)
      v_idi := NVL(NVL(pcidioma, f_usu_idioma), 3);

      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 0026430/0146888 - 17/06/2013 - JMF : calculo de 867 - SC Pago Siniestros, Cesion
         SELECT SUM(NVL(pac_informes_152.f_cesionsobremontototal(stp.sidepag, s.sseguro), 0))
                                                                                         total
           INTO v_total
           FROM seguros s, ramos ra, productos p, titulopro t, sin_siniestro si,
                sin_tramita_pago stp, sin_tramita_pago_gar stpg, sin_tramita_movpago stm,
                pargaranpro par
          WHERE s.cempres = v_emp
            AND par.cpargar = 'RAMOFECU'
            AND par.cvalpar = cur.cvalpar
            AND par.cgarant = stpg.cgarant
            AND par.sproduc = s.sproduc
            AND ra.cramo = s.cramo
            AND ra.cidioma = v_idi
            AND p.sproduc = s.sproduc
            AND t.cramo = p.cramo
            AND t.cmodali = p.cmodali
            AND t.ctipseg = p.ctipseg
            AND t.ccolect = p.ccolect
            AND t.cidioma = v_idi
            AND((pselect = 1
                 AND stpg.cgarant NOT IN(405, 402))
                OR(pselect = 2
                   AND stpg.cgarant = 405)
                OR(pselect = 3
                   AND stpg.cgarant = 402))
            AND si.sseguro = s.sseguro
            AND stp.nsinies = si.nsinies
            AND stm.falta BETWEEN pdesde AND phasta
            AND stpg.sidepag = stp.sidepag
            AND stm.sidepag = stpg.sidepag
            AND stm.cestpag = 1;

         v_ttexto := v_ttexto || NVL(v_total, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sinpagados_reacedido;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   FUNCTION f_get_sinporpagar_liquidados(phasta IN DATE, pcidioma IN NUMBER, pselect IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sinporpagar_liquidados';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta || ' pselect:' || pselect;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      -- Con el pselect seleccionaremos si queremos 1-directos, 2-cedidos 3- aceptados
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || '0' || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sinporpagar_liquidados;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   -- Bug 0026430/0146888 - 17/06/2013 - JMF : pdesde
   FUNCTION f_get_sinporpagar_emprodliquid(
      pdesde IN DATE,
      phasta IN DATE,
      pcidioma IN NUMBER,
      pselect IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sinporpagar_emprodliquid';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta || ' pselect:' || pselect;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      -- Con el pselect seleccionaremos si queremos 1-directos, 2-cedidos 3- aceptados
      v_idi := NVL(NVL(pcidioma, f_usu_idioma), 3);

      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 0026430/0146888 - 17/06/2013 - JMF : calculo de 866 - SC - Provisiones siniestros pendientes de pago, provision directa, cedida
         IF pselect = 1 THEN
            SELECT SUM(NVL(pac_informes_152.f_provsinpag(s.sseguro, phasta, 1), 0))
                                                                                  prov_directa
              INTO v_total
              FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                   detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                   sin_siniestro si, pargaranpro par
             WHERE s.cempres = v_emp
               AND par.cpargar = 'RAMOFECU'
               AND par.cvalpar = cur.cvalpar
               AND par.cgarant = str.cgarant
               AND par.sproduc = s.sproduc
               AND str.fcontab <= phasta
               AND si.sseguro = s.sseguro
               AND str.nsinies = si.nsinies
               AND t.cramo = s.cramo
               AND t.cmodali = s.cmodali
               AND t.ctipseg = s.ctipseg
               AND t.ccolect = s.ccolect
               AND t.cidioma = v_idi
               AND p.sproduc = s.sproduc
               AND ps.sseguro = s.sseguro
               AND ps.nmovimi = (SELECT MAX(nmovimi)
                                   FROM pregunpolseg
                                  WHERE sseguro = ps.sseguro
                                    AND cpregun = 414
                                    AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                      FROM movseguro z
                                                     WHERE z.sseguro = ps.sseguro))
               AND ps.cpregun = 414
               AND pg.cmodali = s.cmodali
               AND pg.ctipseg = s.ctipseg
               AND pg.ccolect = s.ccolect
               AND pg.cactivi = s.cactivi
               AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
               AND pg.cramo = s.cramo
               AND pg.cpargar = 'SUBCLAKEIRA'
               AND dp.cparam = pg.cpargar
               AND dp.cidioma = v_idi
               AND dp.cvalpar = pg.cvalpar
               AND pg2.cmodali = s.cmodali
               AND pg2.ctipseg = s.ctipseg
               AND pg2.ccolect = s.ccolect
               AND pg2.cactivi = s.cactivi
               AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
               AND pg2.cramo = s.cramo
               AND pg2.cpargar = 'CLAKEIRARAMO'
               AND dp2.cparam = pg2.cpargar
               AND dp2.cidioma = v_idi
               AND dp2.cvalpar = pg2.cvalpar
               AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                                  FROM sin_tramita_reserva z_str
                                                 WHERE z_str.nsinies = str.nsinies)
               AND str.cgarant = pg.cgarant
               AND str.cgarant = pg2.cgarant
               AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                    FROM garanseg gar
                                   WHERE gar.sseguro = s.sseguro)
               AND pg.cgarant = pg2.cgarant;
         ELSIF pselect = 2 THEN
            SELECT SUM(NVL(pac_informes_152.f_provsinpag(s.sseguro, phasta, 2), 0))
                                                                                   prov_cedida
              INTO v_total
              FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                   detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                   sin_siniestro si, pargaranpro par
             WHERE s.cempres = v_emp
               AND par.cpargar = 'RAMOFECU'
               AND par.cvalpar = cur.cvalpar
               AND par.cgarant = str.cgarant
               AND par.sproduc = s.sproduc
               AND str.fcontab <= phasta
               AND si.sseguro = s.sseguro
               AND str.nsinies = si.nsinies
               AND t.cramo = s.cramo
               AND t.cmodali = s.cmodali
               AND t.ctipseg = s.ctipseg
               AND t.ccolect = s.ccolect
               AND t.cidioma = v_idi
               AND p.sproduc = s.sproduc
               AND ps.sseguro = s.sseguro
               AND ps.nmovimi = (SELECT MAX(nmovimi)
                                   FROM pregunpolseg
                                  WHERE sseguro = ps.sseguro
                                    AND cpregun = 414
                                    AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                      FROM movseguro z
                                                     WHERE z.sseguro = ps.sseguro))
               AND ps.cpregun = 414
               AND pg.cmodali = s.cmodali
               AND pg.ctipseg = s.ctipseg
               AND pg.ccolect = s.ccolect
               AND pg.cactivi = s.cactivi
               AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
               AND pg.cramo = s.cramo
               AND pg.cpargar = 'SUBCLAKEIRA'
               AND dp.cparam = pg.cpargar
               AND dp.cidioma = v_idi
               AND dp.cvalpar = pg.cvalpar
               AND pg2.cmodali = s.cmodali
               AND pg2.ctipseg = s.ctipseg
               AND pg2.ccolect = s.ccolect
               AND pg2.cactivi = s.cactivi
               AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
               AND pg2.cramo = s.cramo
               AND pg2.cpargar = 'CLAKEIRARAMO'
               AND dp2.cparam = pg2.cpargar
               AND dp2.cidioma = v_idi
               AND dp2.cvalpar = pg2.cvalpar
               AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                                  FROM sin_tramita_reserva z_str
                                                 WHERE z_str.nsinies = str.nsinies)
               AND str.cgarant = pg.cgarant
               AND str.cgarant = pg2.cgarant
               AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                    FROM garanseg gar
                                   WHERE gar.sseguro = s.sseguro)
               AND pg.cgarant = pg2.cgarant;
         ELSIF pselect = 3 THEN
            v_total := 0;
         END IF;

         v_ttexto := v_ttexto || NVL(v_total, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sinporpagar_emprodliquid;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   FUNCTION f_get_sinporpagar_ocunoreport(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sinporpagar_ocunoreport';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         v_ttexto := v_ttexto || '0' || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sinporpagar_ocunoreport;

   -- Bug 26430/140998 - 15/04/2013 - AMC
   -- Bug 0026430/0146888 - 17/06/2013 - JMF : pdesde
   FUNCTION f_get_sin_porpagar_peranterior(pdesde IN DATE, phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_sin_porpagar_peranterior';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      v_total        NUMBER;
      v_idi          NUMBER;
      --v_emp          NUMBER;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      v_idi := NVL(NVL(pcidioma, f_usu_idioma), 3);
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      d_ini := TO_DATE('0101' || TO_NUMBER(TO_CHAR(phasta, 'yyyy') - 1), 'ddmmyyyy');
      d_fin := TO_DATE('3112' || TO_NUMBER(TO_CHAR(phasta, 'yyyy') - 1), 'ddmmyyyy');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT SUM(NVL(pac_informes_152.f_provsinpag(s.sseguro, d_fin, 1), 0))   -- prov_directa
                - SUM(NVL(pac_informes_152.f_provsinpag(s.sseguro, phasta, 2), 0))   -- prov_cedida
           INTO v_total
           FROM seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,
                detparam dp, pargaranpro pg2, detparam dp2, sin_tramita_reserva str,
                sin_siniestro si, pargaranpro par
          WHERE s.cempres = v_emp
            AND par.cpargar = 'RAMOFECU'
            AND par.cvalpar = cur.cvalpar
            AND par.cgarant = str.cgarant
            AND par.sproduc = s.sproduc
            AND str.fcontab BETWEEN d_ini AND d_fin
            AND si.sseguro = s.sseguro
            AND str.nsinies = si.nsinies
            AND t.cramo = s.cramo
            AND t.cmodali = s.cmodali
            AND t.ctipseg = s.ctipseg
            AND t.ccolect = s.ccolect
            AND t.cidioma = v_idi
            AND p.sproduc = s.sproduc
            AND ps.sseguro = s.sseguro
            AND ps.nmovimi = (SELECT MAX(nmovimi)
                                FROM pregunpolseg
                               WHERE sseguro = ps.sseguro
                                 AND cpregun = 414
                                 AND nmovimi <= (SELECT MAX(z.nmovimi)
                                                   FROM movseguro z
                                                  WHERE z.sseguro = ps.sseguro))
            AND ps.cpregun = 414
            AND pg.cmodali = s.cmodali
            AND pg.ctipseg = s.ctipseg
            AND pg.ccolect = s.ccolect
            AND pg.cactivi = s.cactivi
            AND pg.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg.cramo = s.cramo
            AND pg.cpargar = 'SUBCLAKEIRA'
            AND dp.cparam = pg.cpargar
            AND dp.cidioma = v_idi
            AND dp.cvalpar = pg.cvalpar
            AND pg2.cmodali = s.cmodali
            AND pg2.ctipseg = s.ctipseg
            AND pg2.ccolect = s.ccolect
            AND pg2.cactivi = s.cactivi
            AND pg2.sproduc = s.sproduc
-- Bug 26430 - 25/09/2013 - JMF: Rendimiento
            AND pg2.cramo = s.cramo
            AND pg2.cpargar = 'CLAKEIRARAMO'
            AND dp2.cparam = pg2.cpargar
            AND dp2.cidioma = v_idi
            AND dp2.cvalpar = pg2.cvalpar
            AND(str.ntramit, str.nmovres) = (SELECT MIN(z_str.ntramit), MIN(z_str.nmovres)
                                               FROM sin_tramita_reserva z_str
                                              WHERE z_str.nsinies = str.nsinies)
            AND str.cgarant = pg.cgarant
            AND str.cgarant = pg2.cgarant
            AND pg2.cgarant = (SELECT NVL(str.cgarant, MIN(gar.cgarant))
                                 FROM garanseg gar
                                WHERE gar.sseguro = s.sseguro)
            AND pg.cgarant = pg2.cgarant;

         v_ttexto := v_ttexto || NVL(v_total, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_sin_porpagar_peranterior;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_resriesgo_curso_ant(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_resriesgo_curso_ant';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimpore        NUMBER := 0;
      vimpore2       NUMBER := 0;   -- BUG 26430 - FAL - 12/06/2013
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- BUG 26430 - FAL - 12/06/2013
         -- SELECT SUM(NVL(iprincs, 0)) iprincs

         -- Bug 26430 - 05/05/2014 : Anadir recibos para calcular fecha emision
         SELECT SUM(NVL(iprirrc_moncon, 0)) iprirrc_moncon
           -- FI BUG 26430
         INTO   vimpore
           -- BUG 26430 - FAL - 12/06/2013
           -- FROM ppnc p, procesoscab s1, procesoscab s2, pargaranpro pa
         FROM   rrc_sam p, procesoscab s1, procesoscab s2, pargaranpro pa, recibos r
          -- FI BUG 26430
         WHERE  p.sproces = s1.sproces
            AND s2.sproces = (SELECT MAX(sproces)
                                -- BUG 26430 - FAL - 12/06/2013
                                -- FROM ppnc p2
                              FROM   rrc_sam p2
                               -- FI BUG 26430
                              WHERE  p2.fcalcul = p.fcalcul)
            AND p.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY')
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc
            AND p.nrecibo = r.nrecibo
            AND TRUNC(TO_DATE(r.femisio)) < TO_DATE('0101' || TO_CHAR(phasta, 'yyyy'),
                                                    'ddmmyyyy');

          -- BUG 26430 - FAL - 12/06/2013
         -- Bug 26430 - 05/05/2014 : Anadir recibos para calcular fecha emision
         SELECT SUM(NVL(iprrcrc_moncon, 0)) iprrcrc_moncon
           INTO vimpore2
           FROM rrc_rea_sam p, procesoscab s1, procesoscab s2, pargaranpro pa, recibos r
          WHERE p.sproces = s1.sproces
            AND s2.sproces = (SELECT MAX(sproces)
                                FROM rrc_rea_sam p2
                               WHERE p2.fcalcul = p.fcalcul)
            AND p.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY')
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc
            AND p.nrecibo = r.nrecibo
            AND TRUNC(TO_DATE(r.femisio)) < TO_DATE('0101' || TO_CHAR(phasta, 'yyyy'),
                                                    'ddmmyyyy');

         -- FI BUG 26430

         -- BUG 26430 - FAL - 12/06/2013
         -- v_ttexto := v_ttexto || NVL(vimpore, 0) || ';';
         v_ttexto := v_ttexto ||(NVL(vimpore, 0) - NVL(vimpore2, 0)) || ';';
      -- FI BUG 26430
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_resriesgo_curso_ant;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_prima_directa_1ano(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_directa_1ano';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
      vdirecta3      NUMBER := 0;
   BEGIN
      -- Bug 26430 - 14/06/2013 - JMF: intermediaria + directa nueva produccion
      v_ttexto := pac_informes_152.f_get_prima_directa(phasta, pcidioma, 1);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_directa_1ano;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_prima_cedida_1ano(pcramofecu IN NUMBER, phasta IN DATE)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_cedida_1ano';
      v_tparam       VARCHAR2(100) := 'pcramofecu:' || pcramofecu || ' phasta:' || phasta;
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuadroces cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.scontra = cc.scontra
                 AND r.nversio = cc.nversio
                 AND r.ctramo = cc.ctramo
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND f_es_renovacion(s.sseguro) = 1
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo <> 5
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta2
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuacesfac cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.sfacult = cc.sfacult
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND f_es_renovacion(s.sseguro) = 1
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo = 5   --Facultativos
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      RETURN(NVL(vdirecta, 0) + NVL(vdirecta2, 0));
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_cedida_1ano;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_linea_prima_cedida_1ano(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_cedida_1ano';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      -- Bug 26430 - 14/06/2013 - JMF: nueva produccion
      v_ttexto := pac_informes_152.f_get_linea_prima_cedida(phasta, pcidioma, 1);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_cedida_1ano;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_prima_directa_reno(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_directa_reno';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
      vdirecta3      NUMBER := 0;
   BEGIN
      -- Bug 26430 - 14/06/2013 - JMF: intermediaria + directa renovaciones
      v_ttexto := pac_informes_152.f_get_prima_directa(phasta, pcidioma, 0);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_directa_reno;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_prima_cedida_reno(pcramofecu IN NUMBER, phasta IN DATE)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_prima_cedida_reno';
      v_tparam       VARCHAR2(100) := 'pcramofecu:' || pcramofecu || ' phasta:' || phasta;
      v_ntraza       NUMBER := 0;
      vdirecta       NUMBER := 0;
      vdirecta2      NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuadroces cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.scontra = cc.scontra
                 AND r.nversio = cc.nversio
                 AND r.ctramo = cc.ctramo
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND f_es_renovacion(s.sseguro) <> 1
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo <> 5
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      SELECT NVL(SUM(NVL(r.importe, 0)), 0)
        INTO vdirecta2
        FROM (SELECT NVL(icesion_moncon, icesion) - NVL(icomisi_moncon, icomisi) importe,
                     fcierre,
                     DECODE(TRUNC(fcalcul),
                            TRUNC(f_sysdate), TO_DATE(NULL),
                            TRUNC(fcalcul)) fcontab,
                     cc.ccorred, r.nsinies, r.sseguro, r.ctramo, r.cgenera, r.fefecto,
                     r.scontra, r.cgarant
                FROM reaseguro r, cuacesfac cc
               WHERE r.cgenera <> 2
                 AND r.ccompani = cc.ccompani
                 AND r.sfacult = cc.sfacult
                 AND preserv IS NOT NULL) r,
             seguros s,
             companias c,
             productos pr,
             pargaranpro p
       WHERE s.sseguro = r.sseguro
         AND f_es_renovacion(s.sseguro) <> 1
         AND r.nsinies IS NULL
         AND c.ccompani = r.ccorred
         AND r.ctramo = 5   --Facultativos
         AND s.sproduc = pr.sproduc
         AND NVL(r.importe, 0) <> 0
         AND p.cpargar = 'RAMOFECU'
         AND r.cgarant = p.cgarant
         AND s.sproduc = p.sproduc
         AND p.cvalpar = pcramofecu
         AND r.fcontab >= TO_DATE('01/01/' || TO_CHAR(phasta, 'YYYY'), 'DD/MM/YYYY')
         AND r.fcontab <= phasta;

      RETURN(NVL(vdirecta, 0) + NVL(vdirecta2, 0));
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_prima_cedida_reno;

   -- Bug 26430/140998 - 16/04/2013 - AMC
   FUNCTION f_get_linea_prima_cedida_reno(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_linea_prima_cedida_reno';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
   BEGIN
      -- Bug 26430 - 14/06/2013 - JMF: renovacion
      v_ttexto := pac_informes_152.f_get_linea_prima_cedida(phasta, pcidioma, 0);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_linea_prima_cedida_reno;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_numsiniestros(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_numsiniestros';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(si.nsinies)
           INTO vcuantos
           FROM sin_siniestro si, seguros se, sin_movsiniestro sm, pargaranpro p,
                sin_tramita_reserva str
          WHERE si.sseguro = se.sseguro
            AND sm.nsinies = si.nsinies
            AND sm.nmovsin = (SELECT MAX(nmovsin)
                                FROM sin_movsiniestro sm2
                               WHERE sm2.nsinies = sm.nsinies
                                 AND sm2.festsin >= pdesde
                                 AND sm2.festsin <= phasta)
            AND sm.cestsin IN(0, 1, 4)
            AND si.falta BETWEEN pdesde AND phasta
            AND str.nsinies = si.nsinies
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND str.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND str.cgarant NOT IN(405, 402)
            AND str.nmovres = (SELECT MAX(nmovres)
                                 FROM sin_tramita_reserva str2
                                WHERE str2.nsinies = str.nsinies)
            AND ccausin IN(2688, 2689);

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_numsiniestros;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_num_indem_inval(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_num_indem_inval';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(si.nsinies)
           INTO vcuantos
           FROM sin_siniestro si, seguros se, sin_movsiniestro sm, pargaranpro p,
                sin_tramita_reserva str
          WHERE si.sseguro = se.sseguro
            AND sm.nsinies = si.nsinies
            AND sm.nmovsin = (SELECT MAX(nmovsin)
                                FROM sin_movsiniestro sm2
                               WHERE sm2.nsinies = sm.nsinies
                                 AND sm2.festsin >= pdesde
                                 AND sm2.festsin <= phasta)
            AND sm.cestsin IN(0, 1, 4)
            AND si.falta BETWEEN pdesde AND phasta
            AND str.nsinies = si.nsinies
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND str.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND str.cgarant IN(405)
            AND str.nmovres = (SELECT MAX(nmovres)
                                 FROM sin_tramita_reserva str2
                                WHERE str2.nsinies = str.nsinies);

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_num_indem_inval;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_num_indem_muerte(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_num_indem_muerte';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(si.nsinies)
           INTO vcuantos
           FROM sin_siniestro si, seguros se, sin_movsiniestro sm, pargaranpro p,
                sin_tramita_reserva str
          WHERE si.sseguro = se.sseguro
            AND sm.nsinies = si.nsinies
            AND sm.nmovsin = (SELECT MAX(nmovsin)
                                FROM sin_movsiniestro sm2
                               WHERE sm2.nsinies = sm.nsinies
                                 AND sm2.festsin >= pdesde
                                 AND sm2.festsin <= phasta)
            AND sm.cestsin IN(0, 1, 4)
            AND si.falta BETWEEN pdesde AND phasta
            AND str.nsinies = si.nsinies
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND str.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND str.cgarant IN(402)
            AND str.nmovres = (SELECT MAX(nmovres)
                                 FROM sin_tramita_reserva str2
                                WHERE str2.nsinies = str.nsinies);

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_num_indem_muerte;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_num_polcontradadas(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_num_polcontradadas';
      v_tparam       VARCHAR2(100) := 'pdesde:' || pdesde || ' phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_ini := TO_DATE(TO_CHAR(pdesde, 'ddmmyyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT se.sseguro)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, movseguro m
          WHERE se.sseguro = g.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND NVL(se.ncertif, 0) = 0
            AND m.sseguro = se.sseguro
            AND m.cmotmov = 100
            AND m.cmovseg + 0 = 0
            AND m.femisio BETWEEN d_ini AND d_fin;

         -- Bug 0026430/0146888 - 17/06/2013 - JMF :
         --AND f_es_renovacion(se.sseguro) = 1

         --AND m.cmovseg + 0 = 2
         -- movimiento de cartera (se pone el + 0 para romper
         --AND m.cmotmov IN(404)   --20149 carteras de renovación
         --AND m.femisio BETWEEN d_ini AND d_fin;
         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_num_polcontradadas;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_num_itemcontradados(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_num_itemcontradados';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_ini := TO_DATE(TO_CHAR('01') || TO_CHAR('01') || TO_CHAR(phasta, 'yyyy') || '000000',
                       'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT se.sseguro)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, movseguro m
          WHERE se.sseguro = g.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            -- Bug 35495/0204120 - 11/05/2015 - FRC
            -- Se borra condicion.
            --AND se.fefecto BETWEEN d_ini AND d_fin
            AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                 AND NVL(se.ncertif, 0) <> 0)
                OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                   AND NVL(se.ncertif, 0) = 0))
            AND f_situacion_v(se.sseguro, d_fin) = 1
            -- Bug 35495/0204120 - 11/05/2015 - FRC:
            --AND NVL(se.ncertif, 0) <> 0
            -- Bug 0026430/0146888 - 17/06/2013 - JMF :
            --AND f_es_renovacion(se.sseguro) = 1
            AND m.sseguro = se.sseguro
            AND m.femisio BETWEEN d_ini AND d_fin
            -- Bug 26430 - 25/09/2013 - JMF : Número de item contratados en el periodo Nuevos items
            --AND m.cmovseg + 0 = 2
            -- movimiento de cartera (se pone el + 0 para romper
            --AND m.cmotmov IN(404)   --20149 carteras de renovación
            AND m.cmovseg + 0 = 0
            AND m.cmotmov = 100;

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_num_itemcontradados;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_polizasvig(phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_polizasvig';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT se.sseguro)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, movseguro m
          WHERE se.sseguro = g.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND NVL(se.ncertif, 0) = 0
            AND f_situacion_v(se.sseguro, d_fin) = 1
            AND m.sseguro = se.sseguro
            -- Bug 35495/0204120 - 11/05/2015 - FRC:
            -- Se cambia condicion hasta fecha fin
            --AND m.femisio BETWEEN d_ini AND d_fin
            AND m.femisio <= d_fin
            AND m.cmotmov = 100;

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_polizasvig;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_itemsvig(phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_itemsvig';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_fin          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT se.sseguro)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, riesgos ri, movseguro m
          WHERE se.sseguro = g.sseguro
            AND ri.sseguro = se.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            -- Bug 35495/0204120 - 11/05/2015 - FRC:
            --AND NVL(se.ncertif, 0) <> 0
            AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                 AND NVL(se.ncertif, 0) <> 0)
                OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                   AND NVL(se.ncertif, 0) = 0))
            AND f_situacion_v(se.sseguro, d_fin) = 1
            AND m.sseguro = se.sseguro
            AND m.femisio <= d_fin
            AND m.cmotmov = 100;

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_itemsvig;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_polizasnovig(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_polizasnovig';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(LAST_DAY(phasta), 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT se.sseguro)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p
          WHERE se.sseguro = g.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND NVL(se.ncertif, 0) = 0
            --AND se.fanulac BETWEEN d_ini AND d_fin
            AND f_situacion_v(se.sseguro, d_fin) = 2;

         --AND se.fefecto >= pdesde
         --AND f_situacion_v(se.sseguro, d_fin) = 0;
         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_polizasnovig;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_numperase_per(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_numperase_per';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_ini := TO_DATE(TO_CHAR(pdesde, 'ddmmyyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT ri.sperson)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, riesgos ri, movseguro m
          WHERE se.sseguro = g.sseguro
            AND ri.sseguro = se.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                 AND NVL(se.ncertif, 0) <> 0)
                OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                   AND NVL(se.ncertif, 0) = 0))
            -- Bug 0026430/0146888 - 17/06/2013 - JMF :
            --AND f_situacion_v(se.sseguro, d_fin) = 1;
            AND m.sseguro = se.sseguro
            AND m.femisio BETWEEN d_ini AND d_fin
            AND m.cmotmov = 100
            -- Bug 35495/0204120 - 11/05/2015 - FRC:
            AND m.cmovseg + 0 = 0;

         -- Bug 0026430 - 25/09/2013 - JMF :
         -- AND m.cmovseg + 0 = 2
         -- movimiento de cartera (se pone el + 0 para romper
         --AND m.cmotmov IN(404)   --20149 carteras de renovación
         --AND m.cmovseg + 0 = 0
         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_numperase_per;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_numperase(phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_numperase';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_fin          DATE;
      d_ini          DATE;
   BEGIN
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(DISTINCT ri.sperson)
           INTO vcuantos
           FROM seguros se, garanseg g, pargaranpro p, riesgos ri, movseguro m
          WHERE se.sseguro = g.sseguro
            AND ri.sseguro = se.sseguro
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND g.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            -- AND(se.fanulac IS NULL
            --     OR se.fanulac <= d_fin)
            AND f_situacion_v(se.sseguro, d_fin) = 1
            AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                 AND NVL(se.ncertif, 0) <> 0)
                OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                   AND NVL(se.ncertif, 0) = 0))
            AND m.sseguro = se.sseguro
            AND m.cmotmov = 100
            -- Bug 35495/204120  FRC.
            --AND m.femisio BETWEEN d_ini AND d_fin
            AND m.femisio <= d_fin;

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_numperase;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_capase_per(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_capase_per';
      v_tparam       VARCHAR2(100) := 'pdesde:' || pdesde || ' phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_ini          DATE;
      d_fin          DATE;
   BEGIN
      v_ntraza := 1;
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_ini := TO_DATE(TO_CHAR(pdesde, 'ddmmyyyy') || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');
      v_ntraza := 2;

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 35495/204120 FRC
         -- Se modifica consulta.
         SELECT   NVL
                     (SUM
                         (NVL
                             (SUM
                                 (pac_eco_tipocambio.f_importe_cambio
                                                    ((SELECT cmonint
                                                        FROM monedas
                                                       WHERE cidioma = 3
                                                         AND cmoneda = pr.cdivisa),
                                                     (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                        FROM parempresas
                                                       WHERE cempres = v_emp
                                                         AND cparam = 'MONEDACONTAB'),
                                                     phasta, NVL(g.icapital, 0), 1)),
                              0)),
                      0)
             INTO vcuantos
             FROM seguros se, garanseg g, pargaranpro p, movseguro m, productos pr
            WHERE se.sseguro = g.sseguro
              AND p.cpargar = 'RAMOFECU'
              AND p.cvalpar = cur.cvalpar
              AND g.cgarant = p.cgarant
              AND se.sproduc = p.sproduc
              AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                   AND NVL(se.ncertif, 0) <> 0)
                  OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                     AND NVL(se.ncertif, 0) = 0))
              AND m.sseguro = se.sseguro
              AND m.cmovseg + 0 = 0
              AND m.cmotmov = 100
              AND g.nmovimi = ((SELECT MAX(nmovimi)
                                  FROM garanseg
                                 WHERE sseguro = g.sseguro
                                   AND nmovimi <=
                                               (SELECT MAX(nmovimi)
                                                  FROM movseguro
                                                 WHERE sseguro = m.sseguro
                                                   AND femisio <= d_fin)))
              AND m.femisio BETWEEN d_ini AND d_fin
              AND g.nmovimi = (SELECT MAX(nmovimi)
                                 FROM movseguro
                                WHERE sseguro = m.sseguro
                                  AND m.femisio <= d_fin)
              AND se.sproduc = pr.sproduc
         GROUP BY p.cvalpar;

         v_ttexto := v_ttexto || NVL(TRUNC(vcuantos / 1000000), 0) || ';';
      END LOOP;

      v_ntraza := 3;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_capase_per;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_total_capase(phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_total_capase';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
      d_fin          DATE;
      d_ini          DATE;
   BEGIN
      v_ntraza := 1;
      -- Bug 0026430/0146888 - 17/06/2013 - JMF :
      d_fin := TO_DATE(TO_CHAR(phasta, 'ddmmyyyy') || '235959', 'ddmmyyyyhh24miss');
      d_ini := TO_DATE('0101' || TO_CHAR(phasta, 'yyyy') || '000000', 'ddmmyyyyhh24miss');
      v_ntraza := 2;

      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         -- Bug 0026430/0146888 - 17/06/2013 - JMF :
         -- Bug 35495/204120 - 11/05/2015 - FRC:
         -- Se modifica la consulta.
         SELECT   NVL
                     (SUM
                         (NVL
                             (SUM
                                 (pac_eco_tipocambio.f_importe_cambio
                                                    ((SELECT cmonint
                                                        FROM monedas
                                                       WHERE cidioma = 3
                                                         AND cmoneda = pr.cdivisa),
                                                     (SELECT pac_monedas.f_cmoneda_t(nvalpar)
                                                        FROM parempresas
                                                       WHERE cempres = v_emp
                                                         -- 16 -- BUG 0035387 - FAL - 31/03/2015
                                                         AND cparam = 'MONEDACONTAB'),
                                                     phasta, NVL(g.icapital, 0), 1)),
                              0)),
                      0)
             INTO vcuantos
             FROM seguros se, garanseg g, pargaranpro p, movseguro m, productos pr
            WHERE se.sseguro = g.sseguro
              AND p.cpargar = 'RAMOFECU'
              AND p.cvalpar = cur.cvalpar
              AND g.cgarant = p.cgarant
              AND se.sproduc = p.sproduc
              AND((NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
                   AND NVL(se.ncertif, 0) <> 0)
                  OR(NVL(f_parproductos_v(se.sproduc, 'ADMITE_CERTIFICADOS'), 0) = 0
                     AND NVL(se.ncertif, 0) = 0))
              AND m.sseguro = se.sseguro
              AND m.cmovseg + 0 = 0
              AND m.cmotmov = 100
              AND g.nmovimi = ((SELECT MAX(nmovimi)
                                  FROM garanseg
                                 WHERE sseguro = g.sseguro
                                   AND nmovimi <=
                                               (SELECT MAX(nmovimi)
                                                  FROM movseguro
                                                 WHERE sseguro = m.sseguro
                                                   AND femisio <= d_fin)))
              AND m.femisio <= d_fin
              AND g.nmovimi = (SELECT MAX(nmovimi)
                                 FROM movseguro
                                WHERE sseguro = m.sseguro
                                  AND m.femisio <= d_fin)
              AND f_situacion_v(se.sseguro, d_fin) = 1
              AND se.sproduc = pr.sproduc
         GROUP BY p.cvalpar;

         v_ttexto := v_ttexto || NVL(TRUNC(vcuantos / 1000000), 0) || ';';
      END LOOP;

      v_ntraza := 3;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_total_capase;

   -- Bug 26430/140998 - 17/04/2013 - AMC
   FUNCTION f_get_num_fallecimientos(pdesde IN DATE, phasta IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_num_fallecimientos';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vcuantos       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT COUNT(si.nsinies)
           INTO vcuantos
           FROM sin_siniestro si, seguros se, sin_movsiniestro sm, pargaranpro p,
                sin_tramita_reserva str
          WHERE si.sseguro = se.sseguro
            AND sm.nsinies = si.nsinies
            AND sm.nmovsin = (SELECT MAX(nmovsin)
                                FROM sin_movsiniestro sm2
                               WHERE sm2.nsinies = sm.nsinies
                                 AND sm2.festsin >= pdesde
                                 AND sm2.festsin <= phasta)
            AND sm.cestsin IN(0, 1, 4)
            AND si.falta BETWEEN pdesde AND phasta
            AND str.nsinies = si.nsinies
            AND p.cpargar = 'RAMOFECU'
            AND p.cvalpar = cur.cvalpar
            AND str.cgarant = p.cgarant
            AND se.sproduc = p.sproduc
            AND str.cgarant NOT IN(405, 402)
            AND str.nmovres = (SELECT MAX(nmovres)
                                 FROM sin_tramita_reserva str2
                                WHERE str2.nsinies = str.nsinies)
            AND ccausin IN(2688, 2689);

         v_ttexto := v_ttexto || NVL(vcuantos, 0) || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_num_fallecimientos;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_737_det(pcusuari IN VARCHAR2, pfecha IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_737_DET';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(1) := ';';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
   BEGIN
      v_ttexto :=
         'SELECT f_axis_literales(9901972,NVL(f_usu_idioma, 2)) || '' '' || PAC_INFORMES_152.f_get_desc_moneda(c.CMONEOP) || '';'' || CHR(10) ||
                  '';'' || f_axis_literales(9905365,NVL(f_usu_idioma, 2)) || '';'' || f_axis_literales(9905366,NVL(f_usu_idioma, 2)) || '';'' || '';''||
                  f_axis_literales(9902938,NVL(f_usu_idioma, 2)) || '';'' || f_axis_literales(9905365,NVL(f_usu_idioma, 2)) || '';'' ||
                  f_axis_literales(9905366,NVL(f_usu_idioma, 2)) || '';'' || CHR(10) ||
                  f_axis_literales(9905367,NVL(f_usu_idioma, 2)) || '';'' || PAC_INFORMES_152.f_get_recibido_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) || '';'' ||
                  PAC_INFORMES_152.f_get_recibido_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) ||
                  '';''|| '';''|| f_axis_literales(9905368,NVL(f_usu_idioma, 2)) || '';''|| PAC_INFORMES_152.f_get_medio_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 0)
                  || '';''||
                  PAC_INFORMES_152.f_get_medio_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 0) ||'';''|| CHR(10) ||
                  f_axis_literales(9901193,NVL(f_usu_idioma, 2)) || '';'' || PAC_INFORMES_152.f_get_pagado_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) || '';'' ||
                  PAC_INFORMES_152.f_get_pagado_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) ||
                  '';''|| '';''|| f_axis_literales(9905071,NVL(f_usu_idioma, 2)) || '';''|| PAC_INFORMES_152.f_get_medio_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 1)
                  ||'';''||
                  PAC_INFORMES_152.f_get_medio_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 1) ||'';''|| CHR(10) ||
                  '';'' || '';'' || '';'' || '';'' ||
                  f_axis_literales(9905369,NVL(f_usu_idioma, 2)) || '';''|| PAC_INFORMES_152.f_get_medio_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 3) ||'';''||
                  PAC_INFORMES_152.f_get_medio_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 3) ||'';''|| CHR(10) ||
                  '';'' || '';'' || '';'' || '';'' ||
                  f_axis_literales(104384,NVL(f_usu_idioma, 2)) || '';''|| PAC_INFORMES_152.f_get_medio_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 4) ||'';''||
                  PAC_INFORMES_152.f_get_medio_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 4) ||'';''|| CHR(10) ||
                  '';'' || '';'' || '';'' || '';'' ||
                  PAC_INFORMES_152.f_get_medio_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP, 2) ||'';''||'';''|| CHR(10) ||
                  f_axis_literales(101093,NVL(f_usu_idioma, 2)) || '';'' || PAC_INFORMES_152.f_get_total_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) || '';'' ||
                  PAC_INFORMES_152.f_get_total_pesos('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) ||
                  '';''|| '';''|| '';''|| PAC_INFORMES_152.f_get_total_origen('''
         || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) ||'';''||
                  PAC_INFORMES_152.f_get_total_pesos(''' || pcusuari || ''', ''' || pfecha
         || ''', c.CMONEOP) ||'';''|| CHR(10) || CHR(10) linea
                  FROM cajamov c
                  WHERE c.cmoneop in (
                                        SELECT DISTINCT c1.cmoneop
                                        FROM cajamov c1
                                        WHERE c1.cusuari = '''
         || pcusuari
         || '''
                                        AND   TRUNC(c1.ffecmov) = TO_DATE(''' || pfecha
         || ''',''ddmmyyyy'')
                                     )
                  AND  c.cusuari = '''
         || pcusuari || '''
                  AND  TRUNC(c.ffecmov) = TO_DATE(''' || pfecha
         || ''',''ddmmyyyy'')
                  GROUP BY cmoneop';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_737_det;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_recibido_origen(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_recibido_origen';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(c.imovimi), 0)
        INTO v_ttexto
        FROM cajamov c
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 0
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY');

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_recibido_origen;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_recibido_pesos(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_recibido_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(c.iimpins), 0)
        INTO v_ttexto
        FROM cajamov c
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 0
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY');

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_recibido_pesos;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_medio_origen(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      pcmedmov IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(4000) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_medio_origen';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_recibido     NUMBER := 0;
      v_recibido_o   NUMBER := 0;
      v_recibido_i   NUMBER := 0;
      v_pagado       NUMBER := 0;
      v_total        NUMBER := 0;
      v_total_o      NUMBER := 0;
      v_total_i      NUMBER := 0;
      v_ctipmov      NUMBER;
      v_tbanco       VARCHAR2(400);
      v_tbanco_ant   VARCHAR2(400);
      v_cont         NUMBER := 1;
   BEGIN
      IF pcmedmov <> 2 THEN
         SELECT NVL(SUM(cd.imovimi), 0)
           INTO v_recibido
           FROM cajamov c, caja_datmedio cd
          WHERE c.cmoneop = pcmoneop
            AND c.ctipmov = 0
            AND c.cusuari = pcusuari
            AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
            AND c.seqcaja = cd.seqcaja
            AND cd.cmedmov = pcmedmov;

         SELECT NVL(SUM(cd.imovimi), 0)
           INTO v_pagado
           FROM cajamov c, caja_datmedio cd
          WHERE c.cmoneop = pcmoneop
            AND c.ctipmov = 1
            AND c.cusuari = pcusuari
            AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
            AND c.seqcaja = cd.seqcaja
            AND cd.cmedmov = pcmedmov;

         v_total := v_recibido - v_pagado;
         v_ttexto := v_total;
      ELSE
         DECLARE
            CURSOR c1 IS
               SELECT   b.tbanco, NVL(SUM(m.imovimi), 0) imovimi,
                        NVL(SUM(m.iimpins), 0) iimpins, c.ctipmov
                   FROM cajamov c, caja_datmedio m, bancos b
                  WHERE c.cmoneop = pcmoneop
                    AND c.cusuari = pcusuari
                    AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
                    AND c.seqcaja = m.seqcaja
                    AND m.cmedmov = pcmedmov
                    AND b.cbanco = m.cbanco
               GROUP BY m.cbanco, b.tbanco, c.ctipmov
               ORDER BY b.tbanco, c.ctipmov;
         BEGIN
            FOR f1 IN c1 LOOP
               v_ctipmov := f1.ctipmov;
               v_tbanco := f1.tbanco;

               IF v_tbanco <> v_tbanco_ant
                  AND v_cont > 1 THEN
                  v_ttexto := v_ttexto || f_axis_literales(105488, NVL(f_usu_idioma, 2))
                              || ' ' || v_tbanco_ant || ';' || v_total_o || ';' || v_total_i
                              || CHR(10) || ';' || ';' || ';' || ';';
               END IF;

               IF f1.ctipmov = 0 THEN
                  v_recibido_o := f1.imovimi;
                  v_recibido_i := f1.iimpins;
                  v_total_o := f1.imovimi;
                  v_total_i := f1.iimpins;
               ELSIF f1.ctipmov = 1 THEN
                  v_total_o := v_recibido_o - f1.imovimi;
                  v_total_i := v_recibido_i - f1.iimpins;
               END IF;

               v_tbanco_ant := v_tbanco;
               v_cont := v_cont + 1;
            END LOOP;

            v_ttexto := v_ttexto || f_axis_literales(105488, NVL(f_usu_idioma, 2)) || ' '
                        || v_tbanco_ant || ';' || v_total_o || ';' || v_total_i || CHR(10)
                        || ';' || ';' || ';' || ';';
         END;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_medio_origen;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_medio_pesos(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      pcmedmov IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_medio_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_recibido     NUMBER := 0;
      v_pagado       NUMBER := 0;
      v_total        NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(cd.iimpins), 0)
        INTO v_recibido
        FROM cajamov c, caja_datmedio cd
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 0
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
         AND c.seqcaja = cd.seqcaja
         AND cd.cmedmov = pcmedmov;

      SELECT NVL(SUM(cd.iimpins), 0)
        INTO v_pagado
        FROM cajamov c, caja_datmedio cd
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 1
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
         AND c.seqcaja = cd.seqcaja
         AND cd.cmedmov = pcmedmov;

      v_total := v_recibido - v_pagado;
      v_ttexto := v_total;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_medio_pesos;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_pagado_origen(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_pagado_origen';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(c.imovimi), 0)
        INTO v_ttexto
        FROM cajamov c
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 1
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY');

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_pagado_origen;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_pagado_pesos(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_pagado_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
   BEGIN
      SELECT NVL(SUM(c.iimpins), 0)
        INTO v_ttexto
        FROM cajamov c
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 1
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY');

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_pagado_pesos;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_total_origen(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_total_origen';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_total        NUMBER := 0;
   BEGIN
      v_total := f_get_recibido_origen(pcusuari, pfecha, pcmoneop)
                 - f_get_pagado_origen(pcusuari, pfecha, pcmoneop);
      v_ttexto := v_total;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_total_origen;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_total_pesos(pcusuari IN VARCHAR2, pfecha IN VARCHAR2, pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_total_pesos';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_total        NUMBER := 0;
   BEGIN
      v_total := f_get_recibido_pesos(pcusuari, pfecha, pcmoneop)
                 - f_get_pagado_pesos(pcusuari, pfecha, pcmoneop);
      v_ttexto := v_total;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_total_pesos;

   -- Bug 26295/139618 - 16/04/2013 - NSS
   FUNCTION f_get_desc_moneda(pcmoneop IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_desc_moneda';
      v_tparam       VARCHAR2(1000);
      v_ntraza       NUMBER := 0;
      v_numerr       NUMBER;
   BEGIN
      v_numerr := f_desmoneda(pcmoneop, NVL(f_usu_idioma, 2), v_ttexto);
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_desc_moneda;

   FUNCTION f_871_cab(
      p_fhasta IN VARCHAR2,
      p_sproces IN NUMBER,
      p_cempres IN NUMBER,
      p_fdesde IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_871_CAB';
      v_tparam       VARCHAR2(1000)
          := 'h=' || p_fhasta || ' s=' || p_sproces || ' e=' || p_cempres || ' d=' || p_fdesde;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      d_desde        DATE;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;

      IF p_fdesde IS NOT NULL THEN
         d_desde := TO_DATE(p_fdesde, 'DDMMYYYY');
      ELSE
         -- si no esta informada, asignamos el primer dia del mes
         d_desde := TO_DATE('01' || TO_CHAR(TO_DATE(p_fhasta, 'DDMMYYYY'), 'mmyyyy'),
                            'ddmmyyyy');
      END IF;

      v_ntraza := 110;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_ntraza := 120;
      v_ini := TO_CHAR(d_desde, 'dd/mm/yyyy');
      v_fin := TO_CHAR(TO_DATE(p_fhasta, 'DDMMYYYY'), 'dd/mm/yyyy');
      v_ntraza := 130;
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905472, ' || v_idi || ') || CHR(10)||'
                  || ' f_axis_literales(9902360, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(9902361, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39) || ' ||CHR(10)||'
                  -- espacios
                  || 'f_axis_literales(9000531 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100584  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903912 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903913 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905200 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903357 ,' || v_idi || ')' || v_sep
                  --|| 'f_axis_literales(108243  ,' || v_idi || ')' || v_sep
                  --|| 'f_axis_literales(108246  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905474 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000992 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(109792  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905201 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905202 ,' || v_idi || ')' || v_sep
                  --|| 'f_axis_literales(108243  ,' || v_idi || ')' || v_sep
                  --|| 'f_axis_literales(108246  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905475 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(151463  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101300  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9906264 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100784  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905562 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000716 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000717 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905478 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903835 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9901533 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9906866 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(111838  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000553 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101573  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902938 ,' || v_idi || ')' || v_sep
                  -- Importes
                  || 'f_axis_literales(9905684 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' MO'
                  || CHR(39) || v_sep || 'f_axis_literales(9906867 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000530 ,' || v_idi || ')||' || CHR(39) || ' MO'
                  || CHR(39) || v_sep || 'f_axis_literales(1000530 ,' || v_idi || ')||'
                  || CHR(39) || ' ' || CHR(39) || '||' || 'f_axis_literales(9905434 ,' || v_idi
                  || ')||' || CHR(39) || ' MO' || CHR(39) || v_sep
                  || 'f_axis_literales(9906868 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905685 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' Pesos'
                  || CHR(39) || v_sep || 'f_axis_literales(9906870 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000530 ,' || v_idi || ')||' || CHR(39) || ' Pesos'
                  || CHR(39) || v_sep || 'f_axis_literales(1000530 ,' || v_idi || ')||'
                  || CHR(39) || ' ' || CHR(39) || '||f_axis_literales(9905434 ,' || v_idi
                  || ')||' || CHR(39) || ' Pesos' || CHR(39) || v_sep
                  || 'f_axis_literales(9906871 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9906872 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9906873 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903879 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9908334 ,' || v_idi || ')' || v_sep || CHR(39)
                  || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_871_cab;

    /******************************************************************************************
     Descripció: Detalle del map 871 Deudores primas pendientes
     return:     texto detalle
     -- bug 26430/143328 - 26/04/2013 - AMC
   ******************************************************************************************/
   FUNCTION f_871_det(
      p_fhasta IN VARCHAR2,
      p_sproces IN NUMBER,
      p_cempres IN NUMBER,
      p_fdesde IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_871_DET';
      v_tparam       VARCHAR2(1000)
          := 'h=' || p_fhasta || ' p=' || p_sproces || ' e=' || p_cempres || ' d=' || p_fdesde;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_inihms       VARCHAR2(100);
      v_finhms       VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      v_emp          NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
      f_cambio       VARCHAR2(8)
                               := TO_CHAR(LAST_DAY(TO_DATE(p_fhasta, 'ddmmyyyy')), 'ddmmyyyy');
   BEGIN
      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = 21
         AND cparam = 'MONEDACONTAB';

      v_ntraza := 1;

      IF p_fdesde IS NOT NULL THEN
         v_inihms := 'TO_DATE(' || CHR(39) || p_fdesde || '000000' || CHR(39)
                     || ', ''DDMMYYYYHH24MISS'')';
      ELSE
         -- si no esta informada, asignamos el primer dia del mes
         v_inihms := 'TO_DATE(' || CHR(39) || '01'
                     || TO_CHAR(TO_DATE(p_fhasta, 'ddmmyyyy'), 'mmyyyy') || '235959'
                     || CHR(39) || ', ''DDMMYYYYHH24MISS'')';
      END IF;

      -- Bug 26430 - 18/10/2013 - JMF: filtro en femisio en lugar de fvencim
      v_fin := 'TO_DATE(' || CHR(39) || p_fhasta || CHR(39) || ', ''DDMMYYYY'')';
      v_finhms := 'TO_DATE(' || CHR(39) || p_fhasta || '235959' || CHR(39)
                  || ', ''DDMMYYYYHH24MISS'')';
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      v_ttexto :=
         ' select  agente' || v_sep || 'tnomcom' || v_sep || 'comercial' || v_sep
         || 'nomcomercial' || v_sep || 'rutase' || v_sep || 'nomase' || v_sep || 'relacion'
         || v_sep || 'tel' || v_sep || 'mail' || v_sep || 'rutcontra' || v_sep || 'nomcontra'
         || v_sep || 'asistente' || v_sep || 'npoliza' || v_sep || 'ncertif' || v_sep
         || 'cpolcia' || v_sep || 'ramo' || v_sep || 'desramo' || v_sep || 'vigenciaini'
         || v_sep || 'vigenciafin' || v_sep || 'secuencia' || v_sep || 'estado' || v_sep
         || 'fvencin' || v_sep || 'fecprov' || v_sep || 'fecprov2' || v_sep || 'numrecibo'
         || v_sep || 'estdorec' || v_sep || 'fpagorec' || v_sep || 'formapag' || v_sep
         || ' sum(recibo_importe)' || v_sep || ' sum(recibo_iva)' || v_sep
         || 'sum(totalrecibmo)' || v_sep || ' sum(NVL(parcial_importe,0))' || v_sep
         || ' sum(NVL(parcial_iva,0))' || v_sep || 'sum(NVL(abonorecibmo,0))' || v_sep
         || ' sum(recibo_importe_mon)' || v_sep || ' sum(recibo_iva_mon)' || v_sep
         || 'sum(totrecibospesos)' || v_sep || ' sum(NVL(parcial_importe_mon,0))' || v_sep
         || ' sum(NVL(parcial_iva_mon,0))' || v_sep || 'sum(NVL(abonrecibpesos,0))' || v_sep
         || 'sum(diferencialmo)' || v_sep || 'sum(diferencialpesos)' || v_sep
         || 'periodogracia' || v_sep || 'periodopartner' || ' linea'
-------------------------------------------------
         || ' from('
         || ' SELECT h.cagente agente, k.talias tnomcom, FF_BUSCAPADRE2(16,h.cagente,6,null) comercial,'
         || ' decode(FF_BUSCAPADRE2(16,h.cagente,6,null),null,null,ff_desagente(FF_BUSCAPADRE2(16,h.cagente,6,null))) nomcomercial,'
         || ' p.nnumide || ''-'' || p.tdigitoide rutase, f_nombre(f.sperson, 1, ff_agente_cpervisio(H.cagente)) nomase, decode(p.nnumide || ''-'' || p.tdigitoide,pe.nnumide || ''-'' || pe.tdigitoide,''El mismo'',''Otro'') relacion,'
         || ' (SELECT tvalcon FROM per_contactos WHERE sperson = p.sperson AND cagente = h.cagente AND ctipcon = 1 AND ROWNUM = 1) tel,'
         || ' (SELECT tvalcon FROM per_contactos WHERE sperson = p.sperson AND cagente = h.cagente AND ctipcon = 3 AND ROWNUM = 1) mail,'
         || ' pe.nnumide || ''-'' || pe.tdigitoide rutcontra, f_nombre(g.sperson, 1, ff_agente_cpervisio(H.cagente)) nomcontra, NULL asistente, h.npoliza, h.ncertif, h.cpolcia cpolcia,h.cramo ramo, ff_desramo(h.cramo, 3) desramo,'
         || ' NULL materiase, h.fefecto vigenciaini, h.fcaranu vigenciafin, NULL secuencia,'
         || ' l.tatribu estado, e.fvencim fvencin, e.nrecibo numrecibo, '
         || ' decode(b.cestrec'
         || '       ,0,decode((SELECT count(1) FROM detmovrecibo dm WHERE dm.nrecibo=e.nrecibo),0,ff_desvalorfijo(1,3,b.cestrec),''Abonado'')'
         || '      ,ff_desvalorfijo(1,3,b.cestrec)) estdorec,'   -- estados
         || ' TO_CHAR(b.fmovdia, ''DD/MM/YYYY'') fpagorec, ff_desvalorfijo(17, 3, h.cforpag) formapag,'
         || ' NULL rutaceptane, NULL nomaceptante, NULL apelli1aceptante, NULL apelli2aceptnte,'
         || ' PAC_INFORMES_152.f_fecprov (h.sproduc, e.sseguro, e.NMOVIMI, e.fefecto, '
         || v_fin || ') fecprov,'
         || ' TO_CHAR(PAC_INFORMES_152.f_fecprov (h.sproduc, e.sseguro, e.NMOVIMI, e.fefecto, '
         || v_fin || '), ''mon-yy'') fecprov2,'   -- Fecha mes año
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotpri recibo_importe,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotimp recibo_iva,'
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotpri)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotimp) totalrecibmo,'
         -- Total recibo MO
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.imp parcial_importe,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.iva parcial_iva,'
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.imp)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.iva) abonorecibmo,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * (pac_eco_tipocambio.f_importe_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab
         || ''', (pac_eco_tipocambio.f_fecha_max_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab || ''', to_date(''' || f_cambio
         || ''', ''DDMMYYYY''))), c.itotpri)) recibo_importe_mon,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * (pac_eco_tipocambio.f_importe_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab
         || ''', (pac_eco_tipocambio.f_fecha_max_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab || ''', to_date(''' || f_cambio
         || ''', ''DDMMYYYY''))), c.itotimp)) recibo_iva_mon,'
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * (pac_eco_tipocambio.f_importe_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab
         || ''', (pac_eco_tipocambio.f_fecha_max_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab || ''', to_date(''' || f_cambio
         || ''', ''DDMMYYYY''))), c.itotpri)))'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * (pac_eco_tipocambio.f_importe_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab
         || ''', (pac_eco_tipocambio.f_fecha_max_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab || ''', to_date(''' || f_cambio
         || ''', ''DDMMYYYY''))), c.itotimp))) totrecibospesos,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.impcon parcial_importe_mon,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.ivacon parcial_iva_mon,'
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.impcon) + (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.ivacon) abonrecibpesos,'
         --abonrecibpesos
         || ' NVL((DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotpri)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotimp)' || '-('
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.imp)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.iva)'
         || '),0) diferencialmo,'   -- diferencialmo
         || ' NVL((pac_eco_tipocambio.f_importe_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab
         || ''', (pac_eco_tipocambio.f_fecha_max_cambio((SELECT cmonint FROM monedas WHERE cidioma = 3 AND cmoneda = pr.cdivisa), '''
         || v_monedacontab || ''', to_date(''' || f_cambio || ''', ''DDMMYYYY''))), '
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotpri)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotimp)' || '-('
         || ' (DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.imp)'
         || ' +(DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.iva)'
         || '))),0) diferencialpesos,'   --diferencialpesos
         || '(SELECT crespue FROM pregunpolseg ps WHERE ps.sseguro = h.sseguro AND cpregun = 9015 AND ps.nmovimi = (SELECT MAX (nmovimi) FROM pregunpolseg '
         || 'WHERE sseguro = ps.sseguro AND cpregun = ps.cpregun)) periodogracia,'
         || '(SELECT crespue FROM pregunpolseg ps WHERE ps.sseguro = h.sseguro AND cpregun = 427 AND ps.nmovimi = (SELECT MAX (nmovimi) FROM pregunpolseg '
         || 'WHERE sseguro = ps.sseguro AND cpregun = ps.cpregun)) periodopartner'
         || ' FROM movrecibo b, vdetrecibos c, recibos e, riesgos f, tomadores g,'
         || ' seguros h, agentes k, detvalores l, per_personas p, per_personas pe, productos pr,'
         || '  (Select   dp.Nrecibo, Sum(Decode(Cconcep, 0, dp.Iconcep, 0)) Imp, '
         || '                  Sum(Decode(Cconcep, 4, Dp.Iconcep, 0)) Iva, '
         || '                 Sum(Decode(Cconcep, 0, Dp.Iconcep_Monpol, 0)) Impcon, '
         || '                Sum(Decode(Cconcep, 4, dp.Iconcep_Monpol, 0)) Ivacon  '
         || '             FROM detmovrecibo_parcial dp, detmovrecibo d '
         || '           Where Cconcep In(0, 4) ' || '           And D.Nrecibo = Dp.Nrecibo '
         || '          And D.Norden = Dp.Norden ' || '          and fcontab < ' || v_finhms
         || '        GROUP BY dp.nrecibo) des ' || ' WHERE c.nrecibo = b.nrecibo'
         || ' and des.nrecibo(+)=e.nrecibo'
         || ' and b.smovrec = (select max(smovrec) from movrecibo where nrecibo = c.nrecibo and FMOVDIA < '
         || v_finhms || ')' || ' and b.cestrec in (0,3,4)'
         || ' AND e.nrecibo = c.nrecibo AND f.sseguro = h.sseguro'
         || ' AND f.nriesgo = NVL(e.nriesgo,1) AND h.sseguro = e.sseguro AND g.sseguro = h.sseguro'
         || ' AND k.cagente = h.cagente AND l.cvalor = 61 AND l.cidioma = 3 AND l.catribu = h.csituac'
         || ' AND p.sperson (+) = f.sperson AND pe.sperson = g.sperson'
         || ' AND h.sproduc = pr.sproduc'
-------------------------------------------------
         || ' )GROUP BY agente,tnomcom,comercial,nomcomercial,rutase,nomase,relacion,tel,mail,rutcontra,nomcontra,'
         || ' asistente,npoliza,ncertif,cpolcia,ramo,desramo,vigenciaini,vigenciafin,secuencia,estado,fvencin,numrecibo,estdorec,fpagorec,formapag,fecprov,fecprov2,'
         || 'periodogracia,periodopartner';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_871_det;

   /******************************************************************************************
     Descripció: Obtiene matriz o sucursal, en funcion del recaudo masivo o no
     return:     texto sucursal
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_sucursal_recaudo(p_seq NUMBER, p_emp NUMBER, p_age IN NUMBER, p_fec IN DATE)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_sucursal_recaudo';
      v_tparam       VARCHAR2(1000)
                        := 's=' || p_seq || ' e=' || p_emp || ' a=' || p_age || ' f=' || p_fec;
      v_ntraza       NUMBER := 0;
      v_masivo       NUMBER(1);
      v_suc          VARCHAR2(500);
   BEGIN
      v_ntraza := 10;

      SELECT NVL(MAX(1), 0)
        INTO v_masivo
        FROM DUAL
       WHERE EXISTS(SELECT 1
                      FROM pagos_masivos f
                     WHERE f.seqcaja = p_seq);

      v_ntraza := 12;

      IF v_masivo = 1 THEN
         v_ntraza := 14;

         SELECT MAX(m3.tapelli1 || ' ' || m3.tapelli2)
           INTO v_suc
           FROM redcomercial m1, agentes m2, per_detper m3
          WHERE m1.cempres = p_emp
            AND m1.cpadre IS NULL
            AND m2.cagente = m1.cagente
            AND m3.sperson = m2.sperson
            AND m3.fmovimi = (SELECT MAX(p22.fmovimi)
                                FROM per_detper p22
                               WHERE p22.sperson = m3.sperson);
      ELSE
         v_ntraza := 16;

         SELECT MAX(s2.tapelli1 || ' ' || s2.tapelli2)
           INTO v_suc
           FROM agentes s1, per_detper s2
          WHERE s1.cagente = pac_redcomercial.f_busca_padre(p_emp, p_age, NULL, p_fec)
            AND s2.sperson = s1.sperson
            AND s2.fmovimi = (SELECT MAX(p22.fmovimi)
                                FROM per_detper p22
                               WHERE p22.sperson = s2.sperson);
      END IF;

      v_ntraza := 18;
      RETURN v_suc;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_sucursal_recaudo;

   /******************************************************************************************
     Descripció: Cabecera del map 746 Libro de recaudación
     return:     texto cabecera
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_890_cab(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_890__CAB';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_mo           VARCHAR2(100) := '||' || CHR(39) || ' MO' || CHR(39);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ntraza := 130;
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905512, ' || v_idi || ') || CHR(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39) || ' ||CHR(10)||'
                  -- espacios
                  || ' f_axis_literales(9905200, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9903357, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9905425, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9907580, ' || v_idi || ')' || v_sep   -- Nombre Productor
                  || ' f_axis_literales(9905201, ' || v_idi || ')' || v_sep   -- Rut contratante
                  || ' f_axis_literales(9902210, ' || v_idi || ')'
                  || v_sep   -- Nombre Contratante
                          || ' f_axis_literales(9905422, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(800242, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(9903499, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(101168, ' || v_idi || ')' || v_sep
                  || ' f_axis_literales(100784, ' || v_idi || ')' || v_sep   -- Ramo
                  || ' f_axis_literales(100895, ' || v_idi || ')' || v_sep   -- Recibo
                  || ' f_axis_literales(100712, ' || v_idi || ')' || v_sep   -- Forma de pago
                  || ' f_axis_literales(105387, ' || v_idi || ') ' || v_sep   -- Coaseguro
                  || ' f_axis_literales(9905427, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9905428, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9905430, ' || v_idi || ') ' || v_sep
                  || ' f_axis_literales(9001993, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905444, ' || v_idi || ')'
                  || v_sep   -- Vigencia inicial
                          || ' f_axis_literales(9001993, ' || v_idi
                  || ') || '' '' || f_axis_literales(151287, ' || v_idi   -- Vigencia final
                  || ')' || v_sep || 'f_axis_literales(152604, ' || v_idi || ')'
                  || v_sep   -- F. Efecto Recibo
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905431, ' || v_idi || ')'
                  || v_sep   -- Valor Prima Afecta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905431, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima Afecta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905433, ' || v_idi || ')'
                  || v_sep   -- Valor Prima Exenta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905433, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima Exenta
                          || ' f_axis_literales(9905434, ' || v_idi || ') ' || v_sep   -- Iva
                  || ' f_axis_literales(9905434, ' || v_idi || ') ' || v_mo || v_sep   -- Iva
                  || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902594, ' || v_idi || ')'
                  || v_sep   -- Valor Prima bruta
                          || ' f_axis_literales(101159, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902594, ' || v_idi || ')' || v_mo
                  || v_sep   -- Valor Prima bruta
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905211, ' || v_idi || ')'
                  || v_sep   -- Comisión Directa
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905211, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión Directa
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902363, ' || v_idi || ')'
                  || v_sep   -- Comision Intermediario
                          || ' f_axis_literales(101509, ' || v_idi
                  || ') || '' '' || f_axis_literales(9902363, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comision Intermediario
                          || ' f_axis_literales(9905320, ' || v_idi || ')'
                  || v_sep   -- Comision por recaudacion
                          || ' f_axis_literales(9905320, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comision por recaudacion
                          || ' f_axis_literales(9905321, ' || v_idi || ')'
                  || v_sep   -- Comisión por Acceso Preferente
                          || ' f_axis_literales(9905321, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión por Acceso Preferente
                          || ' f_axis_literales(9905322, ' || v_idi || ')'
                  || v_sep   -- Comisión Uso Canal
                          || ' f_axis_literales(9905322, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisión Uso Canal
                          || ' f_axis_literales(9902599, ' || v_idi || ')'
                  || v_sep   -- Comisiones indirectas
                          || ' f_axis_literales(9902599, ' || v_idi || ')' || v_mo
                  || v_sep   -- Comisiones indirectas
                          || ' f_axis_literales(9905559, ' || v_idi || ')'
                  || v_sep   -- % comisión intermediación
                          || ' f_axis_literales(9903977, ' || v_idi || ')'
                  || v_sep   -- Porcentaje Comisión Indirecta
                          || ' f_axis_literales(9905561, ' || v_idi || ')'
                  || v_sep   -- Total % otras comisiones
                          || ' f_axis_literales(9002233, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905436, ' || v_idi || ') '
                  || v_sep   -- Valor comisión
                          || ' f_axis_literales(9002233, ' || v_idi
                  || ') || '' ''|| f_axis_literales(9905436, ' || v_idi || ') ' || v_mo
                  || v_sep   -- Valor comisión
                          || ' f_axis_literales(100956, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905437, ' || v_idi || ')'
                  || v_sep   -- Reaseguro % cedido
                          || ' f_axis_literales(100956, ' || v_idi
                  || ') || '' '' || f_axis_literales(9905438, ' || v_idi || ')'
                  || v_sep   -- Reaseguro % retenido
                          || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_890_cab;

   /******************************************************************************************
     Descripci?: Detalle del map 746 Libro de recaudaci?n
     return:     texto detalle
   -- bug 0026721/143522 - 06/05/2013 - JMF
   -- bug 26430 - 20/06/2013 - JMF: a?adir cobros iaxis a la recaudaci?n
   ******************************************************************************************/
FUNCTION f_890_det(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
   RETURN VARCHAR2 IS
   v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_890__DET';
   v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
   v_ntraza       NUMBER := 0;
   v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
   v_ret          VARCHAR2(1) := CHR(10);
   v_init         VARCHAR2(32000);
   v_ttexto       VARCHAR2(32000);
   v_ini          VARCHAR2(20) := TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'ddmmyyyy');
   v_fin          VARCHAR2(20) := TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'ddmmyyyy');
   v_idi          NUMBER;
   v_aux          VARCHAR2(200);
   v_tmoneda      VARCHAR2(10);
   v_subtiprec_err NUMBER;
BEGIN
   v_ntraza := 100;
   v_ntraza := 110;
   v_emp := f_empres;
   v_ntraza := 120;
   v_ntraza := 130;
   v_ntraza := 120;
   v_idi := NVL(pidioma, f_usu_idioma);
   v_subtiprec_err:= NVL(pac_parametros.f_parempresa_n(v_emp, 'SUBTIPREC_ERRONEO'),0);

   IF v_idi IS NULL THEN
      SELECT MAX(nvalpar)
        INTO v_idi
        FROM parinstalacion
       WHERE cparame = 'IDIOMARTF';
   END IF;

   v_emp := f_empres;
   v_aux := CHR(39) || f_axis_literales(101368, v_idi) || CHR(39);

   BEGIN
      SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'ddmmyyyy')
        INTO v_ini
        FROM DUAL;
   EXCEPTION
      WHEN OTHERS THEN
         v_ini := fecha_desde;
   END;

   BEGIN
      SELECT TO_CHAR(TO_DATE(fecha_hasta, 'DDMMYYYY'), 'ddmmyyyy')
        INTO v_fin
        FROM DUAL;
   EXCEPTION
      WHEN OTHERS THEN
         v_fin := fecha_hasta;
   END;

   -- Prima
   v_ntraza := 140;
   v_ttexto :=
      'SELECT b.rutasegurado ' || v_sep || ' b.nomasegurado ' || v_sep || ' b.rutproductor '
      || v_sep || ' b.nomproductor ' || v_sep || ' b.rutcontratante ' || v_sep
      || ' b.nomcontratante ' || v_sep || ' b.td2 ' || v_sep || ' b.npoliza ' || v_sep
      || ' b.ncertif ' || v_sep || ' b.ramofecu ' || v_sep || ' b.nrecibo ' || v_sep
      || ' b.tpago ' || v_sep || ' b.coat ' || v_sep || ' b.coaporc ' || v_sep
      || ' b.coaprimamo ' || v_sep || ' b.coacomismo ' || v_sep || ' b.fvigini ' || v_sep
      || ' b.fvigfin ' || '' || v_sep || ' b.fefrec ' || v_sep || ' b.montoafecto ' || v_sep
      || ' b.montoafectomo ' || v_sep || ' b.montoexcento ' || v_sep || ' b.montoexcentomo '
      || v_sep || ' b.montoiva ' || v_sep || ' b.montoivamo ' || v_sep || ' b.valprimabruta '
      || v_sep || ' b.valprimabrutamo ' || v_sep || ' b.comisdirecta ' || v_sep
      || ' b.comisdirectamo ' || v_sep || ' b.comisinterme ' || v_sep || ' b.comisintermemo '
      || v_sep || ' b.comisrecauda ' || v_sep || ' b.comisrecaudamo ' || v_sep
      || ' b.comisaccpref ' || v_sep || ' b.comisaccprefmo ' || v_sep || ' b.comisusocana '
      || v_sep || ' b.comisusocanamo ' || v_sep || ' b.comisindirecto ' || v_sep
      || ' b.comisindirectomo ' || '' || v_sep
      || ' DECODE(b.nccorredor, 0, 0, ROUND(b.pccorredor / b.nccorredor, 2)) ' || '' || v_sep
      || ' DECODE(b.ncpartner, 0, 0, ROUND(b.pcpartner / b.ncpartner, 2)) ' || v_sep || ' 0 '
      || v_sep || ' b.totalcomis ' || v_sep || ' b.totalcomismo ' || v_sep
      || '(ROUND((DECODE(b.montorea, ' || ' 0, 0, ' || ' (SELECT SUM(icesion) '
      || 'FROM cesionesrea ' || ' WHERE sseguro = b.sseguro ' || 'AND((b.td = ''P'' '
      || 'AND cgenera = 3) ' || ' OR(b.td = ''A'' ' || 'AND cgenera = 6) '
      || ' OR(b.td = ''E'' ' || 'AND cgenera IN(4, 7)))) ' || ' / b.montorea)), ' || ' 2)) '
      || v_sep || '(100 ' || '-(ROUND((DECODE(b.montorea, ' || ' 0, 0, '
      || ' (SELECT SUM(icesion) ' || ' FROM cesionesrea ' || 'WHERE sseguro = b.sseguro '
      || 'AND((b.td = ''P'' ' || 'AND cgenera = 3) ' || ' OR(b.td = ''A'' '
      || ' AND cgenera = 6) ' || ' OR(b.td = ''E'' ' || ' AND cgenera IN(4, 7)))) '
      || ' / b.montorea)), ' || '2))) ' || '' || v_sep || ' '''' linea '
      || 'FROM (SELECT   a.tnombre || '' '' || a.tapelli nomasegurado, '
      || ' a.tnombreage || '' '' || a.tapelliage nomproductor, '
      || ' a.tnombrecontra || '' '' || a.tapellicontra nomcontratante, a.sseguro, '
      || ' a.nnumidease rutasegurado, a.nnumideage rutproductor, '
      || ' a.nnumidecontra rutcontratante, a.td td, decode(a.cestrec,1,''P'',''A'') td2, a.npoliza, a.ncertif, '
      || ' a.nmovimi nroendoso, tpago, NULL coat, NULL coaporc, NULL coaprimamo, '
      || ' NULL coacomismo, a.fefecto fvigini, a.fcaranu fvigfin, a.fefrec fefrec, '
      || ' SUM(DECODE(a.tasaimp, 0, 0, a.monto)) montoafecto, '
      || ' SUM(DECODE(a.tasaimp, 0, 0, a.montomo)) montoafectomo, '
      || ' SUM(DECODE(a.tasaimp, 0, a.monto, 0)) montoexcento, '
      || ' SUM(DECODE(a.tasaimp, 0, a.montomo, 0)) montoexcentomo, SUM(a.iva) montoiva, '
      || ' SUM(a.ivamo) montoivamo, SUM(a.montorea) montorea, '
      || ' SUM(a.monto + a.iva) valprimabruta, SUM(a.montomo + a.ivamo) valprimabrutamo, '
      || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || '0, a.comisc, '
      || '0)) comisdirecta, ' || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
      || '0, a.comiscmo, ' || '0)) comisdirectamo, '
      || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || '1, a.comisc, '
      || '0)) comisinterme, ' || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
      || '1, a.comiscmo, ' || '0)) comisintermemo, '
      || ' SUM(a.comisrecaudo) comisrecauda, SUM(a.comisrecaudomo) comisrecaudamo, '
      || ' SUM(a.comisacpref) comisaccpref, SUM(a.comisacprefmo) comisaccprefmo, '
      || ' SUM(a.comiscanal) comisusocana, SUM(a.comiscanalmo) comisusocanamo, '
      || ' SUM(a.pcomiscorredor) pccorredor, SUM(a.numcomiscorredor) nccorredor, '
      || ' SUM(a.pcomispartner) pcpartner, SUM(a.numcomisparner) ncpartner, '
      || ' SUM(a.comisp) comisindirecto, SUM(a.comispmo) comisindirectomo, '
      || ' SUM(a.comisp + a.comisc) totalcomis, SUM(a.comispmo + a.comiscmo) '
      || 'totalcomismo, ' || ' a.nrecibo, a.ramofecu '
      || 'FROM (SELECT   s.npoliza, s.ncertif, s.sseguro, s.fefecto, r.fefecto fefrec, '
      || 's.fcaranu, decode(m.cestant,1,''A'',DECODE(mv.cmovseg, 0, ''P'', 3, ''A'', ''E'')) td, mv.nmovimi, '
      || 'DECODE(m.ctipcob, ' || ' 3, ''EFECTIVO'', ' || ' DECODE((SELECT ''APORT INI'' '
      || 'FROM ctacliente ' || ' WHERE cmovimi = 0 ' || ' AND nrecibo = m.nrecibo '
      || ' AND nnumlin = ' || ' (SELECT MAX(nnumlin) ' || ' FROM ctacliente '
      || 'WHERE cmovimi = 0 ' || 'AND nrecibo = m.nrecibo)), ' || 'NULL, DECODE(m.ccobban, '
      || '1, ''PAT Transbank'', ' || '2, ''PAC Santander'', ' || '3, ''PAC Banco de Chile'', '
      || '''PAT BCI''), ' || '''APORT INI'')) tpago, ' || 'd.nrecibo, d.cconcep, s.cagente, '
      || 'NVL(NVL((SELECT nvalcon * NVL(g.cimpips, 0) ' || 'FROM imprec i, garanpro g '
      || ' WHERE i.cconcep = 4 ' || ' AND i.cramo = s.cramo ' || ' AND i.cmodali = s.cmodali '
      || ' AND i.ctipseg = s.ctipseg ' || ' AND i.ccolect = s.ccolect '
      || ' AND i.cactivi = s.cactivi ' || ' AND i.cgarant = d.cgarant '
      || ' AND s.sproduc = g.sproduc ' || ' AND d.cgarant = g.cgarant), '
      || '(SELECT nvalcon * NVL(g.cimpips, 0) ' || 'FROM imprec i, garanpro g '
      || ' WHERE i.cconcep = 4 ' || ' AND i.cramo = s.cramo ' || ' AND i.cmodali = s.cmodali '
      || ' AND i.ctipseg = s.ctipseg ' || ' AND i.ccolect = s.ccolect '
      || ' AND i.cactivi = s.cactivi ' || ' AND i.cgarant IS NULL '
      || ' AND s.sproduc = g.sproduc ' || ' AND d.cgarant = g.cgarant)), ' || '0) tasaimp, '
      || 'd.cgarant, ' || 'per.nnumide ' || '|| DECODE(per.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per.tdigitoide) nnumidease, '
      || 'p.tnombre1 || '' '' || p.tnombre2 tnombre, '
      || 'p.tapelli1 || '' '' || p.tapelli2 tapelli, '
      || 'p2.tnombre1 || '' '' || p2.tnombre2 tnombreage, '
      || 'p2.tapelli1 || '' '' || p2.tapelli2 tapelliage, ' || 'per2.nnumide '
      || '|| DECODE(per2.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per2.tdigitoide) nnumideage, '
      || 'p3.tnombre1 || '' '' || p3.tnombre2 tnombrecontra, '
      || 'p3.tapelli1 || '' '' || p3.tapelli2 tapellicontra, ' || 'per3.nnumide '
      || '|| DECODE(per3.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per3.tdigitoide) nnumidecontra, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '*(DECODE(d.cconcep, 0, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, 0) '
      || ' + DECODE(d.cconcep, 8, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, 0)) ' || 'montomo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '*(DECODE(d.cconcep, '
      || '0, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) '
      || ' + DECODE(d.cconcep, ' || '8, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, '
      || '0)) monto, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '*(DECODE(d.cconcep, '
      || '0, DECODE(m.cestrec, ' || '1, NVL(d.iconcep_monpol, d.iconcep), '
      || 'NVL(-d.iconcep_monpol, -d.iconcep)), ' || '0) ' || '+ DECODE(d.cconcep, '
      || ' 8, DECODE(m.cestrec, ' || ' 1, NVL(d.iconcep_monpol, d.iconcep), '
      || ' NVL(-d.iconcep_monpol, -d.iconcep)), ' || ' 0)) montorea, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '4, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) iva, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '4, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) ivamo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '11, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) comisc, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '11, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) comiscmo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '17, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) comisp, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '17, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) comispmo, '
      || 'DECODE(d.cconcep, ' || ' 47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comisrecaudo, '
      || 'DECODE(d.cconcep, ' || ' 47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comisrecaudomo, '
      || 'DECODE(d.cconcep, ' || ' 48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comiscanal, '
      || 'DECODE(d.cconcep, ' || ' 48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comiscanalmo, '
      || 'DECODE(d.cconcep, ' || ' 49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comisacpref, '
      || 'DECODE(d.cconcep, ' || ' 49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comisacprefmo, '
      || 'DECODE(d.cconcep, 11, 1, 0) numcomiscorredor, ' || 'DECODE(d.cconcep, '
      || ' 11, NVL((SELECT pcomisi ' || ' FROM comisiongar g1 '
      || 'WHERE g1.sproduc = s.sproduc ' || 'AND g1.cgarant = d.cgarant '
      || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) ' || 'AND g1.ccomisi = a.ccomisi '
      || 'AND g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi ' || 'AND g1.finivig = '
      || ' (SELECT MAX(g11.finivig) ' || ' FROM comisiongar g11 '
      || 'WHERE g11.ccomisi = g1.ccomisi ' || 'AND g11.cgarant = g1.cgarant '
      || 'AND g11.cmodcom = g1.cmodcom ' || 'AND g11.cactivi = g1.cactivi '
      || 'AND g11.sproduc = g1.sproduc ' || 'AND g11.finivig <= s.fefecto)), ' || '0), '
      || ' 0) pcomiscorredor, ' || 'DECODE(d.cconcep, 17, 1, 0) numcomisparner, '
      || 'DECODE(d.cconcep, ' || ' 17, NVL((SELECT pcomisi ' || ' FROM comisiongar g1 '
      || 'WHERE g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
      || 'AND g1.cgarant = d.cgarant ' || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) '
      || 'AND g1.ccomisi = z.ccomisi_indirect ' || 'AND g1.sproduc = s.sproduc '
      || 'AND g1.finivig = ' || ' (SELECT MAX(g11.finivig) ' || ' FROM comisiongar g11 '
      || 'WHERE g11.ccomisi = g1.ccomisi ' || 'AND g11.cgarant = g1.cgarant '
      || 'AND g11.cmodcom = g1.cmodcom ' || 'AND g11.cactivi = g1.cactivi '
      || 'AND g11.sproduc = g1.sproduc ' || 'AND g11.finivig <= s.fefecto)), ' || '0), '
      || ' 0) pcomispartner, ' || 'ac.ctipint, xp.cvalpar ramofecu, m.cestrec '
      || ' FROM seguros s, detrecibos d, movrecibo m, recibos r, per_detper p, '
      || 'per_detper p2, per_personas per, riesgos ri, movseguro mv, '
      || 'agentes a, agentes z, garanpro gp, pargaranpro xp, '
      || 'per_personas per2, agentes_comp ac, tomadores t, per_personas per3, '
      || 'per_detper p3 ' || 'WHERE r.ctiprec IN(0, 1, 3, 9) AND ('||v_subtiprec_err||' =0 OR ('||v_subtiprec_err||'=1 AND NVL(r.csubtiprec,-1) <> 21))'
      || 'AND z.cagente = pac_redcomercial.f_busca_padre(s.cempres, s.cagente, '
      || 'NULL, f_sysdate) ' || 'AND s.cagente = a.cagente ' || 'AND ri.sseguro = s.sseguro '
      || 'AND mv.sseguro = s.sseguro ' || 'AND mv.nmovimi = r.nmovimi '
      || 'AND ri.sperson = p.sperson '
      || '                       AND p.fmovimi = (SELECT MAX(pdpaux.fmovimi)
                                          FROM per_detper pdpaux
                                         WHERE p.sperson = pdpaux.sperson)'
      || 'AND ri.nriesgo = d.nriesgo ' || 'AND ri.sperson = per.sperson '
      || 'AND a.sperson = per2.sperson ' || 'AND a.sperson = p2.sperson '
      || 'AND p2.fmovimi = (SELECT MAX(pdpaux2.fmovimi)
                                          FROM per_detper pdpaux2
                                         WHERE p2.sperson = pdpaux2.sperson)'
      || 'AND s.sseguro = r.sseguro ' || 'AND r.nrecibo = d.nrecibo '
      || 'AND r.nrecibo = m.nrecibo ' || 'AND NOT EXISTS(SELECT ''1'' '
      || ' FROM detmovrecibo dm ' || ' WHERE dm.nrecibo = r.nrecibo) '
      || 'AND d.cconcep IN(0, 8, 4, 11, 17, 47, 48, 49) ' || 'AND d.nrecibo = m.nrecibo '
      || 'AND s.cempres = 21 ' || 'AND TRUNC(m.fmovdia) BETWEEN TO_DATE(''' || v_ini
      || ''', ''ddmmyyyy'') ' || 'AND TO_DATE(''' || v_fin || ''', ''ddmmyyyy'') '
      || 'AND (m.cestrec = 1 or m.cestant = 1) ' || 'AND s.cmodali = gp.cmodali '
      || 'AND s.ccolect = gp.ccolect ' || 'AND s.cramo = gp.cramo '
      || 'AND s.ctipseg = gp.ctipseg ' || 'AND s.cactivi = gp.cactivi ' || 'AND ctipgar = 2 '
      || 'AND xp.cpargar = ''RAMOFECU'' ' || 'AND xp.cgarant = gp.cgarant '
      || 'AND xp.sproduc = s.sproduc ' || 'AND s.cramo = xp.cramo '
      || 'AND s.cmodali = xp.cmodali ' || 'AND s.ctipseg = xp.ctipseg '
      || 'AND s.ccolect = xp.ccolect ' || 'AND ac.cagente = a.cagente '
      || 'AND t.sseguro = (SELECT sseguro ' || 'FROM seguros ' || 'WHERE npoliza = s.npoliza '
      || ' AND ncertif = 0) ' || 'AND t.sperson = per3.sperson '
      || 'AND t.sperson = p3.sperson '
      || 'AND p3.fmovimi = (SELECT MAX(pdpaux3.fmovimi)
                                          FROM per_detper pdpaux3
                                         WHERE p3.sperson = pdpaux3.sperson)'
      || 'ORDER BY s.npoliza, d.cgarant) a '
      || 'GROUP BY a.tnombre, a.tapelli, a.tnombreage, a.tapelliage, a.tnombrecontra, '
      || ' a.tapellicontra, a.nnumidease, a.nnumideage, a.nnumidecontra, a.td, a.sseguro, '
      || ' a.npoliza, a.ncertif, a.nmovimi, a.tpago, a.fefecto, a.fefrec, a.fcaranu, '
      || ' a.nrecibo, a.ramofecu, a.cestrec) b ' || 'union ' || 'SELECT b.rutasegurado '
      || v_sep || ' b.nomasegurado ' || v_sep || ' b.rutproductor ' || v_sep
      || ' b.nomproductor ' || v_sep || ' b.rutcontratante ' || v_sep || ' b.nomcontratante '
      || v_sep || ' b.td2 ' || v_sep || ' b.npoliza ' || v_sep || ' b.ncertif ' || v_sep
      || ' b.ramofecu ' || v_sep || ' b.nrecibo ' || v_sep || ' b.tpago ' || v_sep
      || ' b.coat ' || v_sep || ' b.coaporc ' || v_sep || ' b.coaprimamo ' || v_sep
      || ' b.coacomismo ' || v_sep || ' b.fvigini ' || v_sep || ' b.fvigfin ' || '' || v_sep
      || ' b.fefrec ' || v_sep || ' b.montoafecto ' || v_sep || ' b.montoafectomo ' || v_sep
      || ' b.montoexcento ' || v_sep || ' b.montoexcentomo ' || v_sep || ' b.montoiva '
      || v_sep || ' b.montoivamo ' || v_sep || ' b.valprimabruta ' || v_sep
      || ' b.valprimabrutamo ' || v_sep || ' b.comisdirecta ' || v_sep || ' b.comisdirectamo '
      || v_sep || ' b.comisinterme ' || v_sep || ' b.comisintermemo ' || v_sep
      || ' b.comisrecauda ' || v_sep || ' b.comisrecaudamo ' || v_sep || ' b.comisaccpref '
      || v_sep || ' b.comisaccprefmo ' || v_sep || ' b.comisusocana ' || v_sep
      || ' b.comisusocanamo ' || v_sep || ' b.comisindirecto ' || v_sep
      || ' b.comisindirectomo ' || '' || v_sep
      || ' DECODE(b.nccorredor, 0, 0, ROUND(b.pccorredor / b.nccorredor, 2)) ' || '' || v_sep
      || ' DECODE(b.ncpartner, 0, 0, ROUND(b.pcpartner / b.ncpartner, 2)) ' || v_sep || ' 0 '
      || v_sep || ' b.totalcomis ' || v_sep || ' b.totalcomismo ' || v_sep
      || '(ROUND((DECODE(b.montorea, ' || ' 0, 0, ' || ' (SELECT SUM(icesion) '
      || 'FROM cesionesrea ' || ' WHERE sseguro = b.sseguro ' || 'AND((b.td = ''P'' '
      || 'AND cgenera = 3) ' || ' OR(b.td = ''A'' ' || 'AND cgenera = 6) '
      || ' OR(b.td = ''E'' ' || 'AND cgenera IN(4, 7)))) ' || ' / b.montorea)), ' || ' 2)) '
      || v_sep || '(100 ' || '-(ROUND((DECODE(b.montorea, ' || ' 0, 0, '
      || ' (SELECT SUM(icesion) ' || ' FROM cesionesrea ' || 'WHERE sseguro = b.sseguro '
      || 'AND((b.td = ''P'' ' || 'AND cgenera = 3) ' || ' OR(b.td = ''A'' '
      || ' AND cgenera = 6) ' || ' OR(b.td = ''E'' ' || ' AND cgenera IN(4, 7)))) '
      || ' / b.montorea)), ' || '2))) ' || v_sep || ' '''' linea '
      || 'FROM (SELECT   a.tnombre || '' '' || a.tapelli nomasegurado, '
      || ' a.tnombreage || '' '' || a.tapelliage nomproductor, '
      || ' a.tnombrecontra || '' '' || a.tapellicontra nomcontratante, a.sseguro, '
      || ' a.nnumidease rutasegurado, a.nnumideage rutproductor, '
      || ' a.nnumidecontra rutcontratante, a.td td, decode(a.cestrec,1,''P'',''A'') td2, a.npoliza, a.ncertif, '
      || ' a.nmovimi nroendoso, tpago, NULL coat, NULL coaporc, NULL coaprimamo, '
      || ' NULL coacomismo, a.fefecto fvigini, a.fcaranu fvigfin, a.fefrec fefrec, '
      || ' SUM(DECODE(a.tasaimp, 0, 0, a.monto)) montoafecto, '
      || ' SUM(DECODE(a.tasaimp, 0, 0, a.montomo)) montoafectomo, '
      || ' SUM(DECODE(a.tasaimp, 0, a.monto, 0)) montoexcento, '
      || ' SUM(DECODE(a.tasaimp, 0, a.montomo, 0)) montoexcentomo, SUM(a.iva) montoiva, '
      || ' SUM(a.ivamo) montoivamo, SUM(a.montorea) montorea, '
      || ' SUM(a.monto + a.iva) valprimabruta, SUM(a.montomo + a.ivamo) valprimabrutamo, '
      || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || '0, a.comisc, '
      || '0)) comisdirecta, ' || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
      || '0, a.comiscmo, ' || '0)) comisdirectamo, '
      || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), ' || '1, a.comisc, '
      || '0)) comisinterme, ' || ' SUM(DECODE(pac_propio.f_agentecorredor(a.ctipint), '
      || '1, a.comiscmo, ' || '0)) comisintermemo, '
      || ' SUM(a.comisrecaudo) comisrecauda, SUM(a.comisrecaudomo) comisrecaudamo, '
      || ' SUM(a.comisacpref) comisaccpref, SUM(a.comisacprefmo) comisaccprefmo, '
      || ' SUM(a.comiscanal) comisusocana, SUM(a.comiscanalmo) comisusocanamo, '
      || ' SUM(a.pcomiscorredor) pccorredor, SUM(a.numcomiscorredor) nccorredor, '
      || ' SUM(a.pcomispartner) pcpartner, SUM(a.numcomisparner) ncpartner, '
      || ' SUM(a.comisp) comisindirecto, SUM(a.comispmo) comisindirectomo, '
      || ' SUM(a.comisp + a.comisc) totalcomis, SUM(a.comispmo + a.comiscmo) '
      || 'totalcomismo, ' || ' a.nrecibo, a.ramofecu '
      || 'FROM (SELECT   s.npoliza, s.ncertif, s.sseguro, s.fefecto, r.fefecto fefrec, '
      || 's.fcaranu, decode(m.cestant,1,''A'',DECODE(mv.cmovseg, 0, ''P'', 3, ''A'', ''E'')) td, mv.nmovimi, '
      || 'DECODE(m.ctipcob, ' || ' 3, ''EFECTIVO'', ' || ' DECODE((SELECT ''APORT INI'' '
      || 'FROM ctacliente ' || ' WHERE cmovimi = 0 ' || ' AND nrecibo = m.nrecibo '
      || ' AND nnumlin = ' || ' (SELECT MAX(nnumlin) ' || ' FROM ctacliente '
      || 'WHERE cmovimi = 0 ' || 'AND nrecibo = m.nrecibo)), ' || 'NULL, DECODE(m.ccobban, '
      || '1, ''PAT Transbank'', ' || '2, ''PAC Santander'', ' || '3, ''PAC Banco de Chile'', '
      || '''PAT BCI''), ' || '''APORT INI'')) tpago, ' || 'd.nrecibo, d.cconcep, s.cagente, '
      || 'NVL(NVL((SELECT nvalcon * NVL(g.cimpips, 0) ' || 'FROM imprec i, garanpro g '
      || ' WHERE i.cconcep = 4 ' || ' AND i.cramo = s.cramo ' || ' AND i.cmodali = s.cmodali '
      || ' AND i.ctipseg = s.ctipseg ' || ' AND i.ccolect = s.ccolect '
      || ' AND i.cactivi = s.cactivi ' || ' AND i.cgarant = d.cgarant '
      || ' AND s.sproduc = g.sproduc ' || ' AND d.cgarant = g.cgarant), '
      || '(SELECT nvalcon * NVL(g.cimpips, 0) ' || 'FROM imprec i, garanpro g '
      || ' WHERE i.cconcep = 4 ' || ' AND i.cramo = s.cramo ' || ' AND i.cmodali = s.cmodali '
      || ' AND i.ctipseg = s.ctipseg ' || ' AND i.ccolect = s.ccolect '
      || ' AND i.cactivi = s.cactivi ' || ' AND i.cgarant IS NULL '
      || ' AND s.sproduc = g.sproduc ' || ' AND d.cgarant = g.cgarant)), ' || '0) tasaimp, '
      || 'd.cgarant, ' || 'per.nnumide ' || '|| DECODE(per.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per.tdigitoide) nnumidease, '
      || 'p.tnombre1 || '' '' || p.tnombre2 tnombre, '
      || 'p.tapelli1 || '' '' || p.tapelli2 tapelli, '
      || 'p2.tnombre1 || '' '' || p2.tnombre2 tnombreage, '
      || 'p2.tapelli1 || '' '' || p2.tapelli2 tapelliage, ' || 'per2.nnumide '
      || '|| DECODE(per2.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per2.tdigitoide) nnumideage, '
      || 'p3.tnombre1 || '' '' || p3.tnombre2 tnombrecontra, '
      || 'p3.tapelli1 || '' '' || p3.tapelli2 tapellicontra, ' || 'per3.nnumide '
      || '|| DECODE(per3.tdigitoide, ' || ' NULL, NULL, '
      || ' ''-'' || per3.tdigitoide) nnumidecontra, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '*(DECODE(d.cconcep, 0, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, 0) '
      || ' + DECODE(d.cconcep, 8, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, 0)) ' || 'montomo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '*(DECODE(d.cconcep, '
      || '0, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) '
      || ' + DECODE(d.cconcep, ' || '8, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, '
      || '0)) monto, ' || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '*(DECODE(d.cconcep, '
      || '0, DECODE(m.cestrec, ' || '1, NVL(d.iconcep_monpol, d.iconcep), '
      || 'NVL(-d.iconcep_monpol, -d.iconcep)), ' || '0) ' || '+ DECODE(d.cconcep, '
      || ' 8, DECODE(m.cestrec, ' || ' 1, NVL(d.iconcep_monpol, d.iconcep), '
      || ' NVL(-d.iconcep_monpol, -d.iconcep)), ' || ' 0)) montorea, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '4, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) iva, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '4, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) ivamo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '11, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) comisc, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '11, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) comiscmo, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '17, DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || '0) comisp, '
      || 'DECODE(r.ctiprec, 9, -1, 13, -1, 1) ' || '* DECODE(d.cconcep, '
      || '17, DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || '0) comispmo, '
      || 'DECODE(d.cconcep, ' || ' 47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comisrecaudo, '
      || 'DECODE(d.cconcep, ' || ' 47, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comisrecaudomo, '
      || 'DECODE(d.cconcep, ' || ' 48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comiscanal, '
      || 'DECODE(d.cconcep, ' || ' 48, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comiscanalmo, '
      || 'DECODE(d.cconcep, ' || ' 49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep_monpol, ' || ' 0) comisacpref, '
      || 'DECODE(d.cconcep, ' || ' 49, DECODE(r.ctiprec, 9, -1, 13, -1, 1) '
      || '* DECODE(m.cestrec, 1, 1, -1) * d.iconcep, ' || ' 0) comisacprefmo, '
      || 'DECODE(d.cconcep, 11, 1, 0) numcomiscorredor, ' || 'DECODE(d.cconcep, '
      || ' 11, NVL((SELECT pcomisi ' || ' FROM comisiongar g1 '
      || 'WHERE g1.sproduc = s.sproduc ' || 'AND g1.cgarant = d.cgarant '
      || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) ' || 'AND g1.ccomisi = a.ccomisi '
      || 'AND g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi ' || 'AND g1.finivig = '
      || ' (SELECT MAX(g11.finivig) ' || ' FROM comisiongar g11 '
      || 'WHERE g11.ccomisi = g1.ccomisi ' || 'AND g11.cgarant = g1.cgarant '
      || 'AND g11.cmodcom = g1.cmodcom ' || 'AND g11.cactivi = g1.cactivi '
      || 'AND g11.sproduc = g1.sproduc ' || 'AND g11.finivig <= s.fefecto)), ' || '0), '
      || ' 0) pcomiscorredor, ' || 'DECODE(d.cconcep, 17, 1, 0) numcomisparner, '
      || 'DECODE(d.cconcep, ' || ' 17, NVL((SELECT pcomisi ' || ' FROM comisiongar g1 '
      || 'WHERE g1.sproduc = s.sproduc ' || 'AND g1.cactivi = s.cactivi '
      || 'AND g1.cgarant = d.cgarant ' || 'AND g1.cmodcom = DECODE(mv.cmovseg, 0, 1, 2) '
      || 'AND g1.ccomisi = z.ccomisi_indirect ' || 'AND g1.sproduc = s.sproduc '
      || 'AND g1.finivig = ' || ' (SELECT MAX(g11.finivig) ' || ' FROM comisiongar g11 '
      || 'WHERE g11.ccomisi = g1.ccomisi ' || 'AND g11.cgarant = g1.cgarant '
      || 'AND g11.cmodcom = g1.cmodcom ' || 'AND g11.cactivi = g1.cactivi '
      || 'AND g11.sproduc = g1.sproduc ' || 'AND g11.finivig <= s.fefecto)), ' || '0), '
      || ' 0) pcomispartner, ' || 'ac.ctipint, xp.cvalpar ramofecu, m.cestrec '
      || ' FROM seguros s, detmovrecibo_parcial d, detmovrecibo dm, movrecibo m, '
      || 'recibos r, per_detper p, per_detper p2, per_personas per, '
      || 'riesgos ri, movseguro mv, agentes a, agentes z, garanpro gp, '
      || 'pargaranpro xp, per_personas per2, agentes_comp ac, tomadores t, '
      || 'per_personas per3, per_detper p3 ' || 'WHERE r.ctiprec IN(0, 1, 3, 9) AND ('||v_subtiprec_err||' =0 OR ('||v_subtiprec_err||'=1 AND NVL(r.csubtiprec,-1) <> 21))'
      || 'AND z.cagente = pac_redcomercial.f_busca_padre(s.cempres, s.cagente, '
      || 'NULL, f_sysdate) ' || 'AND s.cagente = a.cagente ' || 'AND ri.sseguro = s.sseguro '
      || 'AND mv.sseguro = s.sseguro ' || 'AND mv.nmovimi = r.nmovimi '
      || 'AND ri.sperson = p.sperson '
      || 'AND p.fmovimi = (SELECT MAX(pdpaux.fmovimi)
                                          FROM per_detper pdpaux
                                         WHERE p3.sperson = pdpaux.sperson)'
      || 'AND ri.nriesgo = d.nriesgo ' || 'AND ri.sperson = per.sperson '
      || 'AND a.sperson = per2.sperson ' || 'AND a.sperson = p2.sperson '
      || 'AND p2.fmovimi = (SELECT MAX(pdpaux2.fmovimi)
                                          FROM per_detper pdpaux2
                                         WHERE p2.sperson = pdpaux2.sperson)'
      || 'AND s.sseguro = r.sseguro ' || 'AND r.nrecibo = d.nrecibo '
      || 'AND r.nrecibo = m.nrecibo ' || 'AND r.cestaux = 0 ' || 'AND EXISTS(SELECT ''1'' '
      || 'FROM detmovrecibo dm ' || 'WHERE dm.nrecibo = r.nrecibo) '
      || 'AND d.cconcep IN(0, 8, 4, 11, 17, 47, 48, 49) ' || 'AND d.nrecibo = m.nrecibo '
      || 'AND s.cempres = 21 ' || 'AND TRUNC(m.fmovdia) BETWEEN TO_DATE(''' || v_ini
      || ''', ''ddmmyyyy'') ' || 'AND TO_DATE(''' || v_fin || ''', ''ddmmyyyy'') '
      || 'AND d.nrecibo = dm.nrecibo ' || 'AND d.norden = dm.norden '
      || 'AND TRUNC(m.fmovdia) = TRUNC(dm.fmovimi) ' || 'AND (m.cestrec = 1 or m.cestant = 1) '
      || 'AND s.cmodali = gp.cmodali ' || 'AND s.ccolect = gp.ccolect '
      || 'AND s.cramo = gp.cramo ' || 'AND s.ctipseg = gp.ctipseg '
      || 'AND s.cactivi = gp.cactivi ' || 'AND ctipgar = 2 '
      || 'AND xp.cpargar = ''RAMOFECU'' ' || 'AND xp.cgarant = gp.cgarant '
      || 'AND xp.sproduc = s.sproduc ' || 'AND s.cramo = xp.cramo '
      || 'AND s.cmodali = xp.cmodali ' || 'AND s.ctipseg = xp.ctipseg '
      || 'AND s.ccolect = xp.ccolect ' || 'AND ac.cagente = a.cagente '
      || 'AND t.sseguro = (SELECT sseguro ' || 'FROM seguros ' || 'WHERE npoliza = s.npoliza '
      || ' AND ncertif = 0) ' || 'AND t.sperson = per3.sperson '
      || 'AND t.sperson = p3.sperson '
      || 'AND p3.fmovimi = (SELECT MAX(pdpaux3.fmovimi)
                                          FROM per_detper pdpaux3
                                         WHERE p3.sperson = pdpaux3.sperson)'
      || 'ORDER BY s.npoliza, d.cgarant) a '
      || 'GROUP BY a.tnombre, a.tapelli, a.tnombreage, a.tapelliage, a.tnombrecontra, '
      || ' a.tapellicontra, a.nnumidease, a.nnumideage, a.nnumidecontra, a.td, a.sseguro, '
      || ' a.npoliza, a.ncertif, a.nmovimi, a.tpago, a.fefecto, a.fefrec, a.fcaranu, '
      || ' a.nrecibo, a.ramofecu, a.cestrec) b';
   RETURN v_ttexto;
EXCEPTION
   WHEN OTHERS THEN
      p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                  SQLERRM);
      RETURN 'select 1 linea from dual';
END f_890_det;

   /******************************************************************************************
     Descripció: Cabecera del map 736 RSA-Nomina de primas individual
     return:     texto cabecera
   -- bug 26800/143704 - 13/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_736_cab(
      pcia IN VARCHAR2,
      pdes IN VARCHAR2,
      phas IN VARCHAR2,
      pidi IN NUMBER,
      ppre IN VARCHAR2,
      p_broker IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_736_CAB';
      v_tparam       VARCHAR2(1000)
           := 'c=' || pcia || ' d=' || pdes || ' h=' || phas || ' i=' || pidi || ' p=' || ppre;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   --
   BEGIN
      v_idi := NVL(pidi, f_usu_idioma);

--------------
      BEGIN
         SELECT TO_CHAR(TO_DATE(pdes, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := pdes;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(TO_DATE(phas, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := phas;
      END;

      v_ntraza := 130;
      v_ttexto := 'SELECT'
                          -- nombre listado
                  || ' f_axis_literales(9902060, ' || v_idi || ') || CHR(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836,  ' || v_idi || ') ' || v_sep || CHR(39)
                  || v_ini || CHR(39) || v_sep || ' f_axis_literales(101837,  ' || v_idi
                  || ') ' || v_sep || CHR(39) || v_fin || CHR(39) || '|| CHR(10)||'
                  || ' f_axis_literales(9000752 ,' || v_idi || ')' || v_sep   -- Broker
                  || ' f_axis_literales(9905694 ,' || v_idi || ')' || v_sep   -- security
                  || ' f_axis_literales(9901646 ,' || v_idi || ')' || v_sep   -- Negocio
                  || ' f_axis_literales(9905198 ,' || v_idi || ')' || v_sep   -- Tipo negocio
                  || ' f_axis_literales(108645,' || v_idi || ')' || v_sep   -- Moneda
                  || ' f_axis_literales(9905695 ,' || v_idi || ')'
                  || v_sep   -- Contrato de reaseguro
                          || ' f_axis_literales(9001875 ,' || v_idi || ')' || v_sep   -- Poliza
                  || ' f_axis_literales(9904824 ,' || v_idi || ')' || v_sep   -- Asegurado
                  || ' f_axis_literales(100962  ,' || v_idi || ')' || v_sep   -- sexo
                  || ' f_axis_literales(1000064 ,' || v_idi || ')' || v_sep   -- fecha nacimiento
                  || ' f_axis_literales(9000572 ,' || v_idi || ')'
                  || v_sep   -- Fecha inicio vigencia
                          || ' f_axis_literales(9903427 ,' || v_idi || ')'
                  || v_sep   -- Fecha inicio vigencia póliza
                          || ' f_axis_literales(9903429 ,' || v_idi || ')'
                  || v_sep   -- Fecha fin vigencia póliza
                          || ' f_axis_literales(111796  ,' || v_idi || ')' || v_sep   -- Cobertura
                  || ' f_axis_literales(9903121 ,' || v_idi || ')' || v_sep   -- Capital inicial
                  || ' f_axis_literales(9905484 ,' || v_idi || ')'
                  || v_sep   -- Reserva matemática
                          || ' f_axis_literales(9001157 ,' || v_idi || ')'
                  || v_sep   -- Capital en Riesgo
                          || ' f_axis_literales(9000613 ,' || v_idi || ')' || v_sep   -- % Cesión
                  || ' f_axis_literales(101714  ,' || v_idi || ')' || v_sep   -- Retención
                  || ' f_axis_literales(9001870 ,' || v_idi || ')' || v_sep   -- Cesión
                  || ' f_axis_literales(9905545 ,' || v_idi || ')' || v_sep   -- Tipo cesión prima
                  || ' f_axis_literales(9905546 ,' || v_idi || ')' || v_sep   -- Tasa reaseguro
                  || ' f_axis_literales(9905547 ,' || v_idi || ')' || v_sep   -- Tasa descuento
                  || ' f_axis_literales(104820  ,' || v_idi || ')' || v_sep   -- Prima cedida
                  || ' f_axis_literales(101671  ,' || v_idi || ')' || v_sep   -- Sobreprima
                  || ' f_axis_literales(140531  ,' || v_idi || ')' || v_sep   -- Prima total
                  || ' f_axis_literales(9905548 ,' || v_idi || ')'
                  || v_sep   -- % Participación MR
                          || ' f_axis_literales(9905549 ,' || v_idi || ')'
                  || v_sep   -- Participación MR
                          || ' f_axis_literales(9905550 ,' || v_idi || ')'
                  || v_sep   -- Tasa impuesto
                          || ' f_axis_literales(9905551 ,' || v_idi || ')'
                  || v_sep   -- Monto impuesto
                          || ' f_axis_literales(1000591 ,' || v_idi || ')'
                  || v_sep   -- Tipo movimiento
                          || ' f_axis_literales(9905552 ,' || v_idi || ')'
                  || v_sep   -- Monto descuento
                          || ' f_axis_literales(9905336 ,' || v_idi || ')'
                  || v_sep   -- Monto total Pagar
                          || ' f_axis_literales(9902913 ,' || v_idi || ')'
                  || v_sep   -- numero recibo
                          || ' f_axis_literales(152604 ,' || v_idi || ')'
                  || v_sep   -- F. Efecto Recibo
                          || ' f_axis_literales(9903835 ,' || v_idi || ')'
                  || v_sep   -- F. Vencimiento Recibo
                          || CHR(39) || CHR(39) || ' linea' || ' FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_736_cab;

   /******************************************************************************************
     Descripció: Detalle del map 736 RSA-Nomina de primas individual
     return:     texto detalle
   -- bug 26800/143704 - 13/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_736_det(
      pcia IN VARCHAR2,
      pdes IN VARCHAR2,
      phas IN VARCHAR2,
      pidi IN NUMBER,
      ppre IN VARCHAR2,
      p_broker IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_736_DET';
      v_tparam       VARCHAR2(1000)
           := 'c=' || pcia || ' d=' || pdes || ' h=' || phas || ' i=' || pidi || ' p=' || ppre;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_aux          VARCHAR2(200);
      --
      d_inicio       DATE;
      d_calfin       DATE;
      d_calini       DATE;
   BEGIN
      v_ntraza := 100;
      v_ntraza := 105;
      v_ini := 'TO_DATE(' || CHR(39) || pdes || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 110;
      v_fin := 'TO_DATE(' || CHR(39) || phas || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 120;
      v_idi := NVL(pidi, f_usu_idioma);
      v_emp := f_empres;
      v_aux := CHR(39) || f_axis_literales(101368, v_idi) || CHR(39);
      -- Prima
      v_ntraza := 140;
      v_ttexto :=
         'SELECT '
         || ' (SELECT tcompani  FROM companias WHERE ccompani =
                (SELECT ccorred FROM cuadroces cc
                WHERE cc.scontra = r.scontra
                AND cc.nversio = r.nversio
                AND cc.ctramo = r.ctramo
                AND cc.ccompani = r.ccompani
                AND r.ctramo<> 5
             UNION
             SELECT ccorred
               FROM cuacesfac cc, cuafacul c
              WHERE c.sseguro = s.sseguro
                AND c.scontra = r.scontra
                AND c.nversio = r.nversio
                AND cc.sfacult = c.sfacult
                AND r.ctramo = 5)  )'
         || v_sep   -- broker
         || ' (SELECT tcompani FROM companias WHERE ccompani = r.ccompani)'
         || v_sep   -- security
                 || ''' '' ' || v_sep   -- compania
         || ' DECODE(r.ctramo,5, f_axis_literales(105051, ' || v_idi
         || '),f_axis_literales(9905581, ' || v_idi || '))' || v_sep   -- tipo de negocio
         || ' (SELECT cmoneda FROM codicontratos  WHERE scontra = co.scontra) '
         || v_sep   -- moneda
         || ' (SELECT  ct.scontra || '' '' || ct.tcontra || '' '' || DECODE(r.ctramo, 1, '
         || CHR(39) || CHR(39) || ', ff_desvalorfijo(105, ' || v_idi
         || ' ,r.ctramo))  FROM  contratos ct       WHERE r.scontra = ct.scontra AND r.nversio = ct.nversio) '
         || v_sep   -- contrato
                 || ' s.npoliza||''-''||r.nmovimi||''-''||s.ncertif' || v_sep   -- poliza
         || ' (select p2.TAPELLI1||'' ''||p2.TAPELLI2||'' ''||p2.TNOMBRE' || v_sep
         || 'FF_DESVALORFIJO(11,x.idi,p1.csexper)' || v_sep || 'p1.FNACIMI'
         || ' from   per_personas p1, per_detper p2' || ' where  p1.sperson=ri.sperson'
         || ' and    p2.sperson=p1.sperson and p2.fmovimi=(select max(p22.fmovimi) from per_detper p22 where p22.sperson=p2.sperson)'
         || ')' || v_sep   -- Asegurado,
                        || ' r.fefecto' || v_sep   -- VigenciaOriginalPartner,
                                                || ' s.fefecto' || v_sep   -- VigenciaPoliza,
         || ' s.fcaranu' || v_sep   --  FinVigencia,
         || '(SELECT DISTINCT TROTGAR FROM garangen g WHERE g.cgarant = r.cgarant AND g.cidioma = x.idi)'
         || v_sep   -- Cobertura,
                 || ' g.ICAPITAL' || v_sep   -- AseguradoInicial,
                                          || ' 0' || v_sep   -- ReservaMatematica,
         || ' (g.ICAPITAL - 0)' || v_sep   -- CapitalRiesgo,
         || '   (SELECT pcesion
               FROM cuadroces cc
              WHERE cc.scontra = r.scontra
                AND cc.nversio = r.nversio
                AND cc.ctramo = r.ctramo
                AND cc.ccompani = r.ccompani
                AND r.ctramo<> 5
             UNION
             SELECT pcesion
               FROM cuacesfac cc, cuafacul c
              WHERE c.sseguro = s.sseguro
                AND c.scontra = r.scontra
                AND c.nversio = r.nversio
                AND cc.sfacult = c.sfacult
                AND r.ctramo = 5)'
         || v_sep   -- PorCesion,
         || ' ((g.ICAPITAL)-(g.ICAPITAL * (SELECT pcesion
               FROM cuadroces cc
              WHERE cc.scontra = r.scontra
                AND cc.nversio = r.nversio
                AND cc.ctramo = r.ctramo
                AND cc.ccompani = r.ccompani
                AND r.ctramo<> 5
             UNION
             SELECT pcesion
               FROM cuacesfac cc, cuafacul c
              WHERE c.sseguro = s.sseguro
                AND c.scontra = r.scontra
                AND c.nversio = r.nversio
                AND cc.sfacult = c.sfacult
                AND r.ctramo = 5))/100)'
         || v_sep   -- Retencion,
         || ' (g.ICAPITAL * (SELECT pcesion
               FROM cuadroces cc
              WHERE cc.scontra = r.scontra
                AND cc.nversio = r.nversio
                AND cc.ctramo = r.ctramo
                AND cc.ccompani = r.ccompani
                AND r.ctramo<> 5
             UNION
             SELECT pcesion
               FROM cuacesfac cc, cuafacul c
              WHERE c.sseguro = s.sseguro
                AND c.scontra = r.scontra
                AND c.nversio = r.nversio
                AND cc.sfacult = c.sfacult
                AND r.ctramo = 5) /100)'
         || v_sep   -- Cesion,
                 || ' ff_desvalorfijo(17,x.idi,s.CFORPAG)' || v_sep   -- TipoCesionPrima,
         -- 28-01-2014 || ' (r.icesion/r.icapces)' || v_sep   -- TasaReaseguro,
         || ' (select max(b.valor)/12'
         || ' from  sgt_formulas a, SGT_PARM_FORMULAS b, reaformula c'
         || ' where a.formula like ' || CHR(39) || '%REA%' || CHR(39)
         || ' and   b.codigo = substr( formula,instr(formula,''REA_TASA''),'
         || '                  instr(formula,'')'',instr(formula,''REA_TASA''))-instr(formula,''REA_TASA''))'
         || ' and   c.cgarant=r.cgarant and c.scontra=r.scontra'
         || ' and   a.CLAVE = c.clave)' || v_sep   -- TasaReaseguro,
         || ' nvl(co.pdescuento,0)' || v_sep   -- TasaDescuento,
                                            -- 28-01-2014 || ' r.ICESION' || v_sep   -- PrimaCedida,
         || ' round(r.ICESION,4)' || v_sep   -- PrimaCedida,
         || ' round((r.ICESION * nvl(PSOBREPRIMA,0) / 100),4)' || v_sep   -- PrimaSobreprima,
         || ' round((r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100)),4)'
         || v_sep   -- PrimaTotal,
                 || ' 100' || v_sep   -- ParticipacionMR,
         || ' round((r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100)),4)'
         || v_sep   -- ParticipacionMR,
                 || ' 2' || v_sep   -- TasaImpuesto,
         || ' (r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100))*(2/100)'
         || v_sep   -- MontoImpuesto,
         || ' (select max(ff_desvalorfijo(16, x.idi, m1.cmovseg)) from movseguro m1 where m1.sseguro=r.sseguro and m1.nmovimi=r.NMOVIMI)'
         || v_sep   -- TipoMovimiento,
         || ' (r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100)) * nvl(co.pdescuento,0)'
         || v_sep   -- MontoDescuento,
                 || ' (' || '    (r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100))'
         || '    -' || '    (r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100))*(2/100)'
         || '    -'
         || '    (r.ICESION + (r.ICESION * nvl(PSOBREPRIMA,0) / 100)) * nvl(co.pdescuento,0)'
         || ' )' || v_sep   -- TotalaPagar
                         || ' re.nrecibo' || v_sep   --  Numero recibo
                                                  || ' re.fefecto' || v_sep   --  Numero recibo
         || ' re.fvencim' || v_sep   --  Numero recibo
                                  || CHR(39) || CHR(39) || ' linea'
         || ' FROM  seguros s, riesgos ri, garanseg g, reaseguro r, cuadroces cc, contratos co, recibos re,'
         || '       (select ' || v_idi || ' idi from dual) x'
         || ' WHERE r.sseguro = s.sseguro'
         || ' and   ri.sseguro=r.sseguro and ri.nriesgo=r.nriesgo'
         || ' and   (SELECT ccorred FROM cuadroces cc
                WHERE cc.scontra = r.scontra
                AND cc.nversio = r.nversio
                AND cc.ctramo = r.ctramo
                AND cc.ccompani = r.ccompani
                AND r.ctramo<> 5
             UNION
             SELECT ccorred
               FROM cuacesfac cc, cuafacul c
              WHERE c.sseguro = s.sseguro
                AND c.scontra = r.scontra
                AND c.nversio = r.nversio
                AND cc.sfacult = c.sfacult
                AND r.ctramo = 5) ='
         || p_broker   --Filtro broker
         || ' AND   r.sseguro = g.sseguro AND r.nriesgo=g.nriesgo and r.nmovimi = g.nmovimi AND r.cgarant = g.cgarant';

      IF pcia IS NOT NULL THEN
         v_ttexto := v_ttexto || ' AND   r.ccompani = ' || pcia;
      END IF;

      v_ttexto := v_ttexto || ' AND   r.cempres = ' || v_emp || ' AND   r.fcierre between '
                  || v_ini || ' and ' || v_fin || ' AND   r.cgenera <> 2'
                  || ' and cc.CCOMPANI=r.CCOMPANI' || ' and cc.NVERSIO=r.NVERSIO'
                  || ' and cc.SCONTRA=r.SCONTRA' || ' and cc.CTRAMO=r.CTRAMO'
                  || ' and co.SCONTRA=r.SCONTRA and co.NVERSIO=r.NVERSIO'
                  || ' and re.nrecibo(+)=r.nrecibo';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_736_det;

   /******************************************************************************************
     Descripció: Funció que genera texte capçelera per llistat dinamic Cuenta técnica
     Paràmetres entrada: - p_compani     -> Companyia
                         - p_cempres     -> Empresa
                         - p_finiefe     -> Fecha_Inicio(DDMMAAAA)
                         - p_ffinefe     -> Fecha_Fin(DDMMAAAA)
                         - p_cinttec     -> interes tecnico
                         - p_ctiprea     -> tipo reaseguro valor.106
                         - p_cidioma     -> Idioma
                         - p_cprevio     -> (0-Real, 1-Previo).
                         - p_broker      -> broker
     return:             texte capçelera
   ******************************************************************************************/
   FUNCTION f_747_cab(
      p_compani IN NUMBER DEFAULT NULL,
      p_cempres IN NUMBER DEFAULT NULL,
      p_finiefe IN VARCHAR2 DEFAULT NULL,
      p_ffinefe IN VARCHAR2 DEFAULT NULL,
      p_cinttec IN NUMBER DEFAULT NULL,
      p_ctiprea IN NUMBER DEFAULT NULL,
      p_cidioma IN NUMBER DEFAULT NULL,
      p_cprevio IN NUMBER DEFAULT NULL,
      p_broker IN NUMBER DEFAULT NULL,
      p_cmoneda IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_747_CAB';
      v_tparam       VARCHAR2(1000)
         := ' c=' || p_compani || ' e=' || p_cempres || ' i=' || p_finiefe || ' f='
            || p_ffinefe || ' i=' || p_cinttec || ' t=' || p_ctiprea || ' i=' || p_cidioma
            || ' p=' || p_cprevio || ' b=' || p_broker || ' m=' || p_cmoneda;
      v_ntraza       NUMBER := 0;
      v_idioma       NUMBER;
      v_sep          VARCHAR2(1) := ';';
      v_aux          VARCHAR2(500);
      v_txt          VARCHAR2(32000);
   --v_emp          empresas.cempres%TYPE;
   BEGIN
      v_ntraza := 1000;
      v_txt := NULL;

      IF p_cidioma IS NULL THEN
         v_ntraza := 1010;

         SELECT MAX(nvalpar)
           INTO v_idioma
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_ntraza := 1020;
         v_idioma := p_cidioma;
      END IF;

      IF p_cempres IS NULL THEN
         v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      ELSE
         v_emp := p_cempres;
      END IF;

      v_ntraza := 1030;
      v_txt := 'SELECT ' || CHR(39);

      IF p_compani IS NULL THEN
         v_aux := CHR(10);
      ELSE
         v_ntraza := 1040;

         SELECT MAX(DECODE(p.tnombre, NULL, NULL, p.tnombre || ' ')
                    || DECODE(p.tapelli1, NULL, NULL, p.tapelli1 || ' ')
                    || DECODE(p.tapelli2, NULL, NULL, p.tapelli2))
           INTO v_aux
           FROM companias c, per_detper p
          WHERE c.ccompani = p_compani
            AND c.sperson = p.sperson
            AND p.fmovimi = (SELECT MAX(p1.fmovimi)
                               FROM per_detper p1
                              WHERE p1.sperson = p.sperson);

         IF v_aux IS NULL THEN
            SELECT MAX(c.tcompani)
              INTO v_aux
              FROM companias c
             WHERE c.ccompani = p_compani;
         END IF;

         v_aux := f_axis_literales(9900914, v_idioma) || v_sep || v_aux;
      END IF;

      v_txt := v_txt || v_aux;

      IF p_broker IS NULL THEN
         v_aux := CHR(10);
      ELSE
         v_ntraza := 1040;

         SELECT MAX(DECODE(p.tnombre, NULL, NULL, p.tnombre || ' ')
                    || DECODE(p.tapelli1, NULL, NULL, p.tapelli1 || ' ')
                    || DECODE(p.tapelli2, NULL, NULL, p.tapelli2))
           INTO v_aux
           FROM companias c, per_detper p
          WHERE c.ccompani = p_broker
            AND c.sperson = p.sperson
            AND p.fmovimi = (SELECT MAX(p1.fmovimi)
                               FROM per_detper p1
                              WHERE p1.sperson = p.sperson);

         IF v_aux IS NULL THEN
            v_ntraza := 1050;

            SELECT MAX(c.tcompani)
              INTO v_aux
              FROM companias c
             WHERE c.ccompani = p_broker;
         END IF;

         v_aux := CHR(10) || f_axis_literales(9000752, v_idioma) || v_sep || v_aux;
      END IF;

      v_ntraza := 1060;
      v_txt := v_txt || v_aux;
      v_aux := CHR(10) || f_axis_literales(105280, v_idioma) || v_sep
               || TO_CHAR(TO_DATE(LPAD(p_finiefe, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy') || ' - '
               || TO_CHAR(TO_DATE(LPAD(p_ffinefe, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy');
      v_txt := v_txt || v_aux;

      SELECT d.tmoneda
        INTO v_aux
        FROM eco_codmonedas m, eco_desmonedas d
       WHERE m.cmoneda = d.cmoneda
         AND cidioma = v_idioma
         AND m.cmoneda = p_cmoneda;

      v_aux := CHR(10) || f_axis_literales(108645, v_idioma) || v_sep || v_aux;
      v_txt := v_txt || v_aux;
      v_aux := CHR(10) || CHR(10) || f_axis_literales(104813, v_idioma) || v_sep
               ||   -- Contrato
                 f_axis_literales(9905198, v_idioma) || v_sep
               ||   -- Tipo negocio
                 f_axis_literales(9905581, v_idioma) || v_sep
               ||   -- Automatico
                 f_axis_literales(105051, v_idioma) || v_sep
               ||   -- facultativo
                 f_axis_literales(108502, v_idioma) || v_sep ||   -- resumen
                                                               '';
      v_txt := v_txt || v_aux || CHR(39) || ' linea from dual';
      v_ntraza := 1070;
      RETURN v_txt;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_747_cab;

   FUNCTION f_747_det(
      p_compani IN NUMBER DEFAULT NULL,
      p_cempres IN NUMBER DEFAULT NULL,
      p_finiefe IN VARCHAR2 DEFAULT NULL,
      p_ffinefe IN VARCHAR2 DEFAULT NULL,
      p_cinttec IN NUMBER DEFAULT NULL,
      p_ctiprea IN NUMBER DEFAULT NULL,
      p_cidioma IN NUMBER DEFAULT NULL,
      p_cprevio IN NUMBER DEFAULT NULL,
      p_broker IN NUMBER DEFAULT NULL,
      p_cmoneda IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_txt          VARCHAR2(32000);
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_REA.f_747_det';
      v_tparam       VARCHAR2(1000)
         := ' c=' || p_compani || ' e=' || p_cempres || ' i=' || p_finiefe || ' f='
            || p_ffinefe || ' i=' || p_cinttec || ' t=' || p_ctiprea || ' i=' || p_cidioma
            || ' p=' || p_cprevio || ' b=' || p_broker || ' m=' || p_cmoneda;
      v_ntraza       NUMBER := 0;
      d_finiefe      DATE;
      d_ffinefe      DATE;
      v_sep          VARCHAR2(1) := ';';
      v_idioma       NUMBER;
      n_primera      NUMBER(1);
      n_segunda      NUMBER(1);
      n_fet          NUMBER(1);
      n_toting_automa NUMBER;
      n_toting_facult NUMBER;
      n_toting_trimes NUMBER;
      n_totpag_automa NUMBER;
      n_totpag_facult NUMBER;
      n_totpag_trimes NUMBER;
      p_cesion       NUMBER;

      -- Conceptos a mostrar ( INGRESOS )
      -- El concepto 11 descuento, lo tratan como Comisión
      CURSOR c0_ing IS
         SELECT catribu cod,
                DECODE(catribu, 11, f_axis_literales(101509, v_idioma), tatribu) des,
                DECODE(catribu, 1, 3, 17, 4, 5, 11, 11, 12, 27, 13, 12, 14, 80) orden
           FROM detvalores
          WHERE cvalor = 124
            AND cidioma = v_idioma
            AND catribu IN(1, 17);

      -- Conceptos a mostrar ( PAGOS )
      -- El concepto 11 descuento, lo tratan como Comisión
      CURSOR c0_pag IS
         SELECT catribu cod,
                DECODE(catribu, 11, f_axis_literales(101509, v_idioma), tatribu) des,
                DECODE(catribu, 1, 1, 17, 2, 5, 11, 11, 12, 27, 13, 12, 14, 80) orden
           FROM detvalores
          WHERE cvalor = 124
            AND cidioma = v_idioma
            AND catribu IN(5, 11, 27, 12);

      -- Buscar los posibles contratos que se mostraran
      CURSOR ci IS
         SELECT DISTINCT m.scontra, m.nversio,
                         m.scontra || '-' || m.nversio || ' ' || c.tcontra tcontra
                    FROM movctatecnica m, contratos c, codicontratos s
                   WHERE m.scontra = c.scontra
                     AND m.nversio = c.nversio
                     AND m.fmovimi >= d_finiefe
                     AND m.fmovimi <= d_ffinefe
                     AND m.ccompani = p_compani
                     AND(p_broker IS NULL
                         OR f_busca_browker(m.ccompani, m.nversio, m.scontra, m.ctramo) =
                                                                                       p_broker)
                     AND m.cconcep IN(1, 17, 5, 11, 27, 12)
                     AND m.scontra = s.scontra
                     AND m.cempres = s.cempres
                     AND s.cempres = p_cempres
                ORDER BY 1, 2;

      -- Cursor per el no previ
      CURSOR c1(pc_cod IN NUMBER, pc_scontra IN NUMBER, pc_nversio IN NUMBER) IS
         SELECT NVL(SUM(automa), 0) automa, NVL(SUM(facult), 0) facult,
                NVL(SUM(automa), 0) + NVL(SUM(facult), 0) trimes
           FROM (SELECT DECODE(m.ctramo, 5, 0, m.iimport) automa,
                        DECODE(m.ctramo, 5, m.iimport, 0) facult
                   FROM movctatecnica m, contratos c, codicontratos s
                  WHERE m.scontra = c.scontra
                    AND m.nversio = c.nversio
                    AND m.fmovimi >= d_finiefe
                    AND m.fmovimi <= d_ffinefe
                    AND m.ccompani = p_compani
                    AND(p_broker IS NULL
                        OR f_busca_browker(m.ccompani, m.nversio, m.scontra, m.ctramo) =
                                                                                       p_broker)
                    AND m.cconcep = pc_cod
                    AND c.scontra = pc_scontra
                    AND c.nversio = pc_nversio
                    AND m.scontra = s.scontra
                    AND m.cempres = s.cempres
                    AND s.cempres = p_cempres
                    AND s.cmoneda = p_cmoneda)
          WHERE automa <> 0
             OR facult <> 0;

      -- Cursor per el previ
      CURSOR c2(pc_cod IN NUMBER, pc_scontra IN NUMBER, pc_nversio IN NUMBER) IS
         SELECT NVL(SUM(automa), 0) automa, NVL(SUM(facult), 0) facult,
                NVL(SUM(automa), 0) + NVL(SUM(facult), 0) trimes
           FROM (SELECT DECODE(m.ctramo, 5, 0, m.iimport) automa,
                        DECODE(m.ctramo, 5, m.iimport, 0) facult
                   FROM movctaaux m, contratos c, codicontratos s
                  WHERE m.scontra = c.scontra
                    AND m.nversio = c.nversio
                    AND m.fmovimi >= d_finiefe
                    AND m.fmovimi <= d_ffinefe
                    AND m.ccompani = p_compani
                    AND m.cconcep = pc_cod
                    AND(p_broker IS NULL
                        OR f_busca_browker(m.ccompani, m.nversio, m.scontra, m.ctramo) =
                                                                                       p_broker)
                    AND c.scontra = pc_scontra
                    AND c.nversio = pc_nversio
                    AND m.scontra = s.scontra
                    AND m.cempres = s.cempres
                    AND s.cempres = p_cempres
                    AND s.cmoneda = p_cmoneda)
          WHERE automa <> 0
             OR facult <> 0;

      PROCEDURE l_monta_sel(
         pcamp1 IN VARCHAR2,
         pcamp2 IN VARCHAR2,
         pcamp3 IN VARCHAR2,
         pcamp4 IN VARCHAR2,
         pcamp5 IN VARCHAR2,
         pcamp6 IN VARCHAR2) IS
      BEGIN
         v_txt := v_txt || ' select ' || pcamp1 || ', ' || CHR(39) || pcamp2 || CHR(39)
                  || '||' || CHR(39) || v_sep || CHR(39) || '||' || CHR(39) || pcamp3
                  || CHR(39) || '||' || CHR(39) || v_sep || CHR(39) || '||' || CHR(39)
                  || pcamp4 || CHR(39) || '||' || CHR(39) || v_sep || CHR(39) || '||'
                  || CHR(39) || pcamp5 || CHR(39) || '||' || CHR(39) || v_sep || CHR(39)
                  || '||' || CHR(39) || pcamp6 || CHR(39) || '||' || CHR(39) || v_sep
                  || CHR(39) || ' linea from dual';
      END;
   BEGIN
--------------------------------------------------------------------------
--------------------------------------------------------------------------
-- INFORME .- Cuenta técnica reaseguro
--------------------------------------------------------------------------
--------------------------------------------------------------------------
      v_ntraza := 1040;
      v_txt := NULL;

      IF p_compani IS NULL THEN
         RAISE NO_DATA_FOUND;
      END IF;

      IF p_cidioma IS NULL THEN
         v_ntraza := 1010;

         SELECT MAX(nvalpar)
           INTO v_idioma
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_ntraza := 1020;
         v_idioma := p_cidioma;
      END IF;

      v_ntraza := 1047;
      d_finiefe := TO_DATE(LPAD(p_finiefe, 8, '0'), 'ddmmyyyy');
      v_ntraza := 1053;
      d_ffinefe := TO_DATE(LPAD(p_ffinefe, 8, '0'), 'ddmmyyyy');
      v_txt := NULL;
      n_primera := 0;
      n_segunda := 0;
      n_toting_automa := 0;
      n_toting_facult := 0;
      n_toting_trimes := 0;
      n_totpag_automa := 0;
      n_totpag_facult := 0;
      n_totpag_trimes := 0;

      IF NVL(p_cprevio, 0) = 0 THEN
         --
         -- INGRESOS
         --
         FOR f0 IN c0_ing LOOP
            FOR fi IN ci LOOP
               n_fet := 0;

               IF n_primera = 0 THEN
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
                  v_txt := v_txt || ' union';
               ELSE
                  v_txt := v_txt || ' union';
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
               END IF;

               FOR f1 IN c1(f0.cod, fi.scontra, fi.nversio) LOOP
                  IF n_primera = 0 THEN
                     -- Ingresos
                     l_monta_sel(2, NULL, f_axis_literales(801512, v_idioma), NULL, NULL,
                                 NULL);
                     v_txt := v_txt || ' union';
                  ELSE
                     v_txt := v_txt || ' union';
                  END IF;

                  n_primera := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, f1.automa, f1.facult, f1.trimes);
                  n_toting_automa := n_toting_automa + f1.automa;
                  n_toting_facult := n_toting_facult + f1.facult;
                  n_toting_trimes := n_toting_trimes + f1.trimes;
                  n_fet := 1;
               END LOOP;

               -- Para mostrar conceptos aunque sean valor cero
               IF n_fet = 0 THEN
                  IF n_primera = 1 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  n_primera := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, 0, 0, 0);
               END IF;
            END LOOP;
         END LOOP;

         --
         -- PAGOS
         --
         FOR f0 IN c0_pag LOOP
            FOR fi IN ci LOOP
               n_fet := 0;

               IF n_primera = 0 THEN
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
                  v_txt := v_txt || ' union';
               ELSE
                  v_txt := v_txt || ' union';
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
               END IF;

               FOR f1 IN c1(f0.cod, fi.scontra, fi.nversio) LOOP
                  IF n_primera = 1
                     AND n_segunda = 0 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  IF n_segunda = 0 THEN
                     -- Egresos
                     l_monta_sel(10, NULL, f_axis_literales(9905615, v_idioma), NULL, NULL,
                                 NULL);
                     v_txt := v_txt || ' union';
                  ELSE
                     v_txt := v_txt || ' union';
                  END IF;

                  n_segunda := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, f1.automa, f1.facult, f1.trimes);
                  n_totpag_automa := n_totpag_automa + f1.automa;
                  n_totpag_facult := n_totpag_facult + f1.facult;
                  n_totpag_trimes := n_totpag_trimes + f1.trimes;
                  n_fet := 1;
               END LOOP;

               -- Para mostrar conceptos aunque sean valor cero
               IF n_fet = 0 THEN
                  IF n_segunda = 1 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  n_segunda := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, 0, 0, 0);
               END IF;
            END LOOP;
         END LOOP;
      ELSE
         --
         -- INGRESOS
         --
         FOR f0 IN c0_ing LOOP
            FOR fi IN ci LOOP
               n_fet := 0;

               IF n_primera = 0 THEN
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
                  v_txt := v_txt || ' union';
               ELSE
                  v_txt := v_txt || ' union';
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
               END IF;

               FOR f2 IN c2(f0.cod, fi.scontra, fi.nversio) LOOP
                  IF n_primera = 0 THEN
                     -- Ingresos
                     l_monta_sel(2, NULL, f_axis_literales(801512, v_idioma), NULL, NULL,
                                 NULL);
                     v_txt := v_txt || ' union';
                  ELSE
                     v_txt := v_txt || ' union';
                  END IF;

                  n_primera := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, f2.automa, f2.facult, f2.trimes);
                  n_toting_automa := n_toting_automa + f2.automa;
                  n_toting_facult := n_toting_facult + f2.facult;
                  n_toting_trimes := n_toting_trimes + f2.trimes;
                  n_fet := 1;
               END LOOP;

               -- Para mostrar conceptos aunque sean valor cero
               IF n_fet = 0 THEN
                  IF n_primera = 1 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  n_primera := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, 0, 0, 0);
               END IF;
            END LOOP;
         END LOOP;

         --
         -- PAGOS
         --
         FOR f0 IN c0_pag LOOP
            FOR fi IN ci LOOP
               n_fet := 0;

               IF n_primera = 0 THEN
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
                  v_txt := v_txt || ' union';
               ELSE
                  v_txt := v_txt || ' union';
                  --% Participación
                  l_monta_sel(0, fi.tcontra, f_axis_literales(9905548, v_idioma), 100, 0,
                              NULL);
                  v_txt := v_txt || ' union';

                  --% cesión
                  BEGIN
                     SELECT pcesion
                       INTO p_cesion
                       FROM cuadroces cc
                      WHERE cc.scontra = fi.scontra
                        AND cc.nversio = fi.nversio
                        AND cc.ctramo <> 5
                        AND cc.ccompani = p_compani;
                  EXCEPTION
                     WHEN OTHERS THEN
                        p_cesion := 0;
                  END;

                  l_monta_sel(1, fi.tcontra, f_axis_literales(9000613, v_idioma), p_cesion, 0,
                              NULL);
               END IF;

               FOR f2 IN c2(f0.cod, fi.scontra, fi.nversio) LOOP
                  IF n_primera = 1
                     AND n_segunda = 0 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  IF n_segunda = 0 THEN
                     -- Egresos
                     l_monta_sel(10, NULL, f_axis_literales(9905615, v_idioma), NULL, NULL,
                                 NULL);
                     v_txt := v_txt || ' union';
                  ELSE
                     v_txt := v_txt || ' union';
                  END IF;

                  n_segunda := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, f2.automa, f2.facult, f2.trimes);
                  n_totpag_automa := n_totpag_automa + f2.automa;
                  n_totpag_facult := n_totpag_facult + f2.facult;
                  n_totpag_trimes := n_totpag_trimes + f2.trimes;
                  n_fet := 1;
               END LOOP;

               -- Para mostrar conceptos aunque sean valor cero
               IF n_fet = 0 THEN
                  IF n_segunda = 1 THEN
                     v_txt := v_txt || ' union';
                  END IF;

                  n_segunda := 1;
                  l_monta_sel(f0.orden, fi.tcontra, f0.des, 0, 0, 0);
               END IF;
            END LOOP;
         END LOOP;
      END IF;

      IF n_primera = 0
         AND n_segunda = 0 THEN
         v_txt := 'select 0, null linea from dual ';
      END IF;

      -- Total Ingresos
      v_txt := v_txt || ' union ';
      l_monta_sel(09, NULL, f_axis_literales(9905617, v_idioma), n_toting_automa,
                  n_toting_facult, n_toting_trimes);
      -- Total Egresos
      v_txt := v_txt || ' union ';
      l_monta_sel(98, NULL, f_axis_literales(9905616, v_idioma), n_totpag_automa,
                  n_totpag_facult, n_totpag_trimes);
      -- Saldo (ingresos - egresos )
      v_txt := v_txt || ' union ';
      l_monta_sel(99, NULL, f_axis_literales(9001942, v_idioma),
                  (n_toting_automa - n_totpag_automa),(n_toting_facult - n_totpag_facult),
                  (n_toting_trimes - n_totpag_trimes));
      v_txt := 'select linea from (' || v_txt || ')';
      v_ntraza := 9999;
      RETURN v_txt;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_747_det;

   /******************************************************************************************
      Descripció: Funció que genera texte capçelera per llistat bordero siniestros
      Paràmetres entrada: - p_cempres     -> Empresa
                        - p_compani     -> Cia propia
                        - p_finiefe     -> Fecha_Inicio(DDMMAAAA)
                        - p_ffinefe     -> Fecha_Fin(DDMMAAAA)
                        - p_estsini     -> estado siniestro (1- Pagados, 0-Pendientes)
                        - p_tipctr      -> tipus contracte (1- Ctr. aut. Proporcional, 2- Cuenta de Facultativo, 3- Ctr.aut. NO Proporcional (XL))
                        - p_tipcta      -> Tipo Cuenta (1- Reasegurador, 2-Tipo Cuenta Broker, 3-Tipo Cuenta Reasegurador / Bróker, 4-Tipo Cuenta Total)
                        - p_detall      -> Detall per companyia (si tipcta = 2, 3 i p_detall = 1- Detall per companyies, 2 - Agrupat per broker
                        - p_ciarea      -> reaseguradora/Broker
                        - p_cidioma     -> Idioma
                        - p_cprevio     -> (0-Real, 1-Previo).
                        - p_broker      -> broker
      return:             texte capçelera
    ******************************************************************************************/
   FUNCTION f_748_cab(
      p_cempres IN NUMBER DEFAULT NULL,
      p_compani IN NUMBER DEFAULT NULL,
      p_finiefe IN VARCHAR2 DEFAULT NULL,
      p_ffinefe IN VARCHAR2 DEFAULT NULL,
      p_estsini IN NUMBER DEFAULT 1,
      p_tipctr IN NUMBER DEFAULT NULL,
      p_tipcta IN NUMBER DEFAULT NULL,
      p_detall IN NUMBER DEFAULT 0,
      p_ciarea IN NUMBER DEFAULT NULL,
      p_cidioma IN NUMBER DEFAULT NULL,
      p_cprevio IN NUMBER DEFAULT 0,
      p_broker IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_748_CAB';
      v_tparam       VARCHAR2(1000)
         := ' c=' || p_compani || ' e=' || p_cempres || ' i=' || p_finiefe || ' f='
            || p_ffinefe || ' es=' || p_estsini || ' ct=' || p_tipctr || ' cta=' || p_tipcta
            || 'detall = ' || p_detall || ' cia=' || p_ciarea || ' i=' || p_cidioma || ' p='
            || p_cprevio || ' b=' || p_broker;
      v_ntraza       NUMBER := 0;
      v_txt          VARCHAR2(32000);
      v_idioma       NUMBER;
      v_sep          VARCHAR2(1) := ';';
      v_aux          VARCHAR2(500);
   BEGIN
      v_ntraza := 1000;
      v_txt := NULL;

      IF p_cidioma IS NULL THEN
         v_ntraza := 1010;

         SELECT MAX(nvalpar)
           INTO v_idioma
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_ntraza := 1020;
         v_idioma := p_cidioma;
      END IF;

      v_ntraza := 1030;
      v_txt := 'SELECT ' || CHR(39);

      IF p_compani IS NULL THEN
         v_aux := CHR(10);
      ELSE
         v_ntraza := 1040;

         SELECT MAX(DECODE(p.tnombre, NULL, NULL, p.tnombre || ' ')
                    || DECODE(p.tapelli1, NULL, NULL, p.tapelli1 || ' ')
                    || DECODE(p.tapelli2, NULL, NULL, p.tapelli2))
           INTO v_aux
           FROM companias c, per_detper p
          WHERE c.ccompani = p_compani
            AND c.sperson = p.sperson
            AND p.fmovimi = (SELECT MAX(p1.fmovimi)
                               FROM per_detper p1
                              WHERE p1.sperson = p.sperson);

         IF v_aux IS NULL THEN
            SELECT MAX(c.tcompani)
              INTO v_aux
              FROM companias c
             WHERE c.ccompani = p_compani;
         END IF;

         v_aux := f_axis_literales(9900914, v_idioma) || v_sep || v_aux;
      END IF;

      v_txt := v_txt || v_aux;
      v_aux := CHR(10) || f_axis_literales(9905584, v_idioma) || v_sep
               || TO_CHAR(TO_DATE(LPAD(p_finiefe, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy') || v_sep
               || TO_CHAR(TO_DATE(LPAD(p_ffinefe, 8, '0'), 'ddmmyyyy'), 'dd-mm-yyyy');
      v_txt := v_txt || v_aux;
      v_aux := CHR(10) || CHR(10) || f_axis_literales(112259, v_idioma) || v_sep
               --  Estado siniestro
               || f_axis_literales(9000752, v_idioma) || v_sep
               --  Broker   Broker
               || f_axis_literales(9905694, v_idioma) || v_sep
               --  security
               || f_axis_literales(9901646, v_idioma) || v_sep
               -- Negocio
               || f_axis_literales(9905198, v_idioma) || v_sep
               --  Tipo negocio
               || f_axis_literales(108645, v_idioma) || v_sep
               --  Moneda
               || f_axis_literales(9905695, v_idioma) || v_sep
               --  Contrato de reaseguro
               || f_axis_literales(9001875, v_idioma) || v_sep
               ||   -- poliza
                 f_axis_literales(9903357, v_idioma) || v_sep
               ||   -- nombre asegurado
                 f_axis_literales(100962, v_idioma) || v_sep
               ||   -- sexo
                 f_axis_literales(1000064, v_idioma) || v_sep
               ||   -- fecha nacimiento
                 f_axis_literales(9905585, v_idioma) || v_sep
               ||   -- fecha inicio vigencia original
                 f_axis_literales(9903427, v_idioma) || v_sep
               ||   -- Fecha inicio vigencia póliza
                 f_axis_literales(9903429, v_idioma) || v_sep
               ||   -- Fecha fin vigencia póliza
                 f_axis_literales(9901035, v_idioma) || v_sep
               ||   -- Fecha ultimo pago
                 f_axis_literales(111796, v_idioma) || v_sep
               ||   -- cobertura
                 f_axis_literales(101040, v_idioma) || v_sep
               ||   -- causa
                 f_axis_literales(800279, v_idioma) || v_sep
               ||   -- Num.Siniestro
                 f_axis_literales(1000112, v_idioma) || v_sep
               ||   -- Descripción Siniestro
                 f_axis_literales(1000510, v_idioma) || v_sep
               ||   -- fecha ocurrencia
                 f_axis_literales(101573, v_idioma) || v_sep
               ||   -- fecha pago
                 f_axis_literales(9905586, v_idioma) || v_sep
               ||   -- Monto siniestro
                 f_axis_literales(9905484, v_idioma) || v_sep
               ||   -- reserva matematica
                 f_axis_literales(9001157, v_idioma) || v_sep
               ||   -- capital en riesgo
                 f_axis_literales(9000613, v_idioma) || v_sep
               ||   -- porcentaje cesion
                 f_axis_literales(101714, v_idioma) || v_sep
               ||   -- retencion
                 f_axis_literales(9001870, v_idioma) || v_sep
               ||   -- cesion
                 f_axis_literales(9905548, v_idioma) || v_sep
               ||   -- porcentaje participacion MR
                 f_axis_literales(9905549, v_idioma) || v_sep
               ||   -- participacion MR
                 f_axis_literales(9903843, v_idioma) || v_sep ||   -- total cobro
                                                                '';
      v_txt := v_txt || v_aux || CHR(39) || ' linea from dual';
      RETURN v_txt;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_748_cab;

    /******************************************************************************************
     Descripció: Funció que genera texte detalle per llistat bordero siniestros
     Paràmetres entrada: - p_cempres     -> Empresa
                       - p_compani     -> Cia propia
                       - p_finiefe     -> Fecha_Inicio(DDMMAAAA)
                       - p_ffinefe     -> Fecha_Fin(DDMMAAAA)
                       - p_estsini     -> estado siniestro (1- Pagados, 0-Pendientes)
                       - p_tipctr      -> tipus contracte (1- Ctr. aut. Proporcional, 2- Cuenta de Facultativo, 3- Ctr.aut. NO Proporcional (XL))
                       - p_tipcta      -> Tipo Cuenta (1- Reasegurador, 2-Tipo Cuenta Broker, 3-Tipo Cuenta Reasegurador / Bróker, 4-Tipo Cuenta Total)
                       - p_detall      -> Detall per companyia (si tipcta = 2, 3 i p_detall = 1- Detall per companyies, 2 - Agrupat per broker
                       - p_ciarea      -> reaseguradora/Broker
                       - p_cidioma     -> Idioma
                       - p_cprevio     -> (0-Real, 1-Previo).
                       - p_broker      -> broker
     return:             texte capçelera
   ******************************************************************************************/
   FUNCTION f_748_det(
      p_cempres IN NUMBER DEFAULT NULL,
      p_compani IN NUMBER DEFAULT NULL,
      p_finiefe IN VARCHAR2 DEFAULT NULL,
      p_ffinefe IN VARCHAR2 DEFAULT NULL,
      p_estsini IN NUMBER DEFAULT 1,
      p_tipctr IN NUMBER DEFAULT NULL,
      p_tipcta IN NUMBER DEFAULT NULL,
      p_detall IN NUMBER DEFAULT 0,
      p_ciarea IN NUMBER DEFAULT NULL,
      p_cidioma IN NUMBER DEFAULT NULL,
      p_cprevio IN NUMBER DEFAULT 0,
      p_broker IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_748_DET';
      v_tparam       VARCHAR2(1000)
         := ' c=' || p_compani || ' e=' || p_cempres || ' i=' || p_finiefe || ' f='
            || p_ffinefe || ' es=' || p_estsini || ' ct=' || p_tipctr || ' cta=' || p_tipcta
            || 'detall = ' || p_detall || ' cia=' || p_ciarea || ' i=' || p_cidioma || ' p='
            || p_cprevio || ' b=' || p_broker;
      v_ntraza       NUMBER := 0;
      v_finiefe      VARCHAR2(100);
      v_ffinefe      VARCHAR2(100);
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      -- Bug 0022794 - 12/07/2012 - DCG - Ini
      v_aux_naci     VARCHAR2(500);
      v_aux_sexo     VARCHAR2(500);
      -- Bug 0022794 - 12/07/2012 - DCG - Fi
      v_txt          VARCHAR2(32000);
      --v_emp          NUMBER;
      v_idi          NUMBER;
   BEGIN
--------------------------------------------------------------------------
--------------------------------------------------------------------------
-- INFORME .-  Bordero Siniestros
--------------------------------------------------------------------------
--------------------------------------------------------------------------
      v_ntraza := 1040;
      v_emp := NVL(p_cempres, f_empres);

      IF p_cidioma IS NULL THEN
         v_ntraza := 1010;

         SELECT MAX(nvalpar)
           INTO v_idi
           FROM parinstalacion
          WHERE cparame = 'IDIOMARTF';
      ELSE
         v_ntraza := 1020;
         v_idi := p_cidioma;
      END IF;

      v_finiefe := LPAD(p_finiefe, 8, '0');
      v_finiefe := 'to_date(' || CHR(39) || v_finiefe || CHR(39) || ',''ddmmyyyy'')';
      v_ffinefe := LPAD(p_ffinefe, 8, '0');
      v_ffinefe := 'to_date(' || CHR(39) || v_ffinefe || CHR(39) || ',''ddmmyyyy'')';
      v_ntraza := 1040;
      -- bug 0028963 - 28/03/2014 - JMF: Afegir nsinies i tsinies
      v_txt :=
         'SELECT ' || ' DECODE(' || NVL(p_estsini, 1) || ', 1, f_axis_literales(9901193, '
         || v_idi || '), 0, f_axis_literales(9901194, ' || v_idi || ')) ' || v_sep   -- estado
         || ' (SELECT tcompani FROM companias WHERE ccompani = c.ccorred)' || v_sep   -- broker
         || ' (SELECT tcompani FROM companias WHERE ccompani = c.ccompani)' || v_sep   -- security
         || ''' '' ' || v_sep   -- compania
                             || ' DECODE(r.ctramo,5, f_axis_literales(105051, ' || v_idi
         || '),f_axis_literales(9905581, ' || v_idi || '))' || v_sep   -- tipo de negocio
         || ' (SELECT cmoneda FROM codicontratos  WHERE scontra = c.scontra) '
         || v_sep   -- moneda
         || ' (SELECT  ct.scontra || '' '' || ct.tcontra || '' '' || DECODE(r.ctramo, 1, '
         || CHR(39) || CHR(39) || ', ff_desvalorfijo(105, ' || v_idi
         || ' ,r.ctramo))  FROM  contratos ct       WHERE r.scontra = ct.scontra AND r.nversio = ct.nversio) '
         || v_sep   -- contrato
                 || ' s.npoliza||''-''||ss.nmovimi||''-''||s.ncertif' || v_sep   -- poliza
         || ' (select max(p2.TAPELLI1||'' ''||p2.TAPELLI2||'' ''||p2.TNOMBRE)' || v_sep
         || '         max(ff_desvalorfijo(11,' || v_idi || ',p1.CSEXPER)) ' || v_sep
         || '         max(p1.FNACIMI)' || '    from  per_personas p1, per_detper p2'
         || '    where p1.sperson=ri.sperson' || '    and   p2.sperson=p1.sperson'
         || '    and   p2.FMOVIMI=(select max(p22.FMOVIMI) from per_detper p22 where p22.sperson=p2.sperson)'
         || ' )' || v_sep   -- Asegurado
                         || ' r.FEFECTO' || v_sep   -- Fecha_Inicio_Vigencia_Original
         || ' s.FEFECTO' || v_sep   -- Inicio Vigencia poliza
                                 || ' s.FCARANU' || v_sep   -- Fin vigencia poliza
         || ' p.FULTPAG' || v_sep   -- Ultimo pago
         || ' (SELECT DISTINCT tgarant FROM garangen g WHERE g.cgarant=p.cgarant AND g.cidioma='
         || v_idi || ')' || v_sep   -- Cobertura
                                 || ' pac_siniestros.ff_descausa(ss.CCAUSIN,' || v_idi || ')'
         || v_sep   -- Causa,
                 || ' ss.nsinies' || v_sep   -- Num.Siniestro
         || ' replace(replace(replace(ss.tsinies,chr(39),null),chr(10),null),chr(13),null)'
         || v_sep   -- Descripción Siniestro
                 || ' ss.fsinies' || v_sep   -- Fecha ocurrencia
                                          || ' p.FCONTAB' || v_sep || ' p.IPAGO'
         || v_sep   -- monto siniestro
                 || ' p.IRESERVA' || v_sep   -- reserva
                                          || ' p.ICAPRIE' || v_sep   -- capital en riesgo
         || ' (SELECT pcesion' || '    FROM cuadroces cc' || '   WHERE cc.scontra = r.scontra'
         || '     AND cc.nversio = r.nversio' || '     AND cc.ctramo = r.ctramo'
         || '     AND cc.ccompani = r.ccompani' || '   UNION' || '  SELECT pcesion'
         || '    FROM cuacesfac cc, cuafacul c' || '   WHERE c.sseguro = s.sseguro'
         || '     AND c.scontra = r.scontra' || '     AND c.nversio = r.nversio'
         || '     AND cc.sfacult = c.sfacult' || '     AND r.ctramo = 5' || ' )'
         || v_sep   -- Por_Cesion
                 || ' (p.ICAPRIE - r.iimport)' || v_sep   -- Retencion
                                                       || ' r.iimport' || v_sep   -- Cesion
         || ' 100' || v_sep   --  Porcentaje_Participacion_MR,
                           || ' (r.iimport * 100 / 100 )' || v_sep   -- Participacion_MR ,
         || ' (r.iimport * 100 / 100 )' || v_sep   -- Total
                                                || CHR(39) || CHR(39) || ' linea'
         || ' FROM ctatecnica c, seguros s, sin_siniestro ss, sin_tramita_reserva p, riesgos ri,';

      IF NVL(p_cprevio, 0) = 1 THEN
         v_txt := v_txt || ' movctaaux r ';
      ELSE
         v_txt := v_txt || ' movctatecnica r ';
      END IF;

      v_txt :=
         v_txt || ' WHERE s.sseguro=ss.sseguro' || ' AND r.scontra=c.scontra'
         || ' and ri.sseguro=ss.sseguro and ri.nriesgo=ss.nriesgo'
         || ' AND r.nversio=c.nversio' || ' AND r.ctramo=c.ctramo'
         || ' AND r.ccompani=c.ccompani' || ' AND r.nsinies=ss.nsinies'
         || ' AND r.nsinies=p.nsinies'
         || ' AND p.nmovres=(SELECT MAX(pp.nmovres) FROM sin_tramita_reserva pp WHERE pp.nsinies=p.nsinies)'
         || ' AND r.cempres=' || v_emp || '  AND c.ccorred=' || p_broker   --filtro broker
         || ' AND NVL(r.sproduc,0)=c.sproduc(+)';

      IF p_compani IS NOT NULL THEN
         v_txt := v_txt || ' AND c.ccompani = ' || p_compani;
      END IF;

      IF NVL(p_estsini, 1) = 1 THEN   -- pagados
         v_txt := v_txt || ' AND p.fcontab between ' || v_finiefe || ' and ' || v_ffinefe
                  || ' AND r.fmovimi between ' || v_finiefe || ' and ' || v_ffinefe
                  || ' AND r.cconcep = 5';
      ELSIF NVL(p_estsini, 1) = 0 THEN   --pendientes
         v_txt := v_txt || ' AND p.fmovres <= ' || v_ffinefe || ' AND r.fmovimi = '
                  || v_ffinefe || ' AND r.cconcep = 25';
      END IF;

      v_txt := v_txt
               || ' ORDER BY s.npoliza,r.nsinies,r.ccompani, r.scontra, r.nversio, r.ctramo';
      RETURN v_txt;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_748_det;

   /******************************************************************************************
     Descripció: Obtenemos la RRC liberada de las pólizas emitidas el año anterior y no tengan provisión en la fecha hasta
    */
   FUNCTION f_get_rrc_lib_anoant(phasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_rrc_lib_anoant';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_importe      NUMBER := 0;
      wcalcul        NUMBER := 0;
      v_ntraza       NUMBER := 0;
   BEGIN
      -- Bug 26430 - 05/05/2014 - JMF
      /*
      FOR cur IN
            (SELECT DISTINCT (rs.nrecibo) nrecibo, MAX(sproces) sproces
                        FROM rrc_sam rs, recibos r
                       WHERE rs.nrecibo = r.nrecibo
                         AND TRUNC(TO_DATE(r.femisio)) <
                               TO_DATE('01/01/' || TO_CHAR(TO_DATE(phasta, 'DDMMYYYY'), 'YYYY'))   -- Fecha inicio de año
                         AND rs.nrecibo NOT IN(SELECT nrecibo
                                                 FROM rrc_sam
                                                WHERE fcalcul =
                                                         (SELECT MAX(fcalcul)
                                                            FROM rrc_sam
                                                           WHERE fcalcul <=
                                                                    LAST_DAY(TO_DATE(phasta,
                                                                                     'DDMMYYYY'))))   --Fecha de fin
                    GROUP BY rs.nrecibo) LOOP
            SELECT SUM(NVL(iprirrc_moncon, 0))
              INTO wcalcul
              FROM rrc_sam
             WHERE nrecibo = cur.nrecibo
               AND sproces = (SELECT MAX(sproces)
                                FROM rrc_sam
                               WHERE fcalcul = TO_DATE('31/12/'
                                                       ||(TO_CHAR(TO_DATE(phasta, 'DDMMYYYY'),
                                                                  'YYYY')
                                                          - 1),
                                                       'DD/MM/YYYY'));   --Fecha de fin de año anterior;

            v_importe := v_importe + wcalcul;
         END LOOP;
         */
      SELECT SUM(NVL(iprirrc_moncon, 0))
        INTO v_importe
        FROM rrc_sam
       WHERE nrecibo NOT IN(SELECT nrecibo
                              FROM rrc_sam
                             WHERE fcalcul = TO_DATE(phasta, 'DDMMYYYY'))
         AND sproces = (SELECT MAX(sproces)
                          FROM rrc_sam
                         WHERE fcalcul = TO_DATE('31/12/'
                                                 ||(TO_CHAR(TO_DATE(phasta, 'DDMMYYYY'),
                                                            'YYYY')
                                                    - 1),
                                                 'DD/MM/YYYY'));

      RETURN v_importe;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_rrc_lib_anoant;

   /******************************************************************************************
    Descripció: Obtenemos la RRC constituida para recibos emitidos el año de la fecha informada
   */
   FUNCTION f_get_rrc_cons_anoact(phasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_rrc_cons_anoact';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_importe      NUMBER := 0;
      wcalcul        NUMBER := 0;
      v_ntraza       NUMBER := 0;
   BEGIN
      FOR cur IN (SELECT DISTINCT (rs.nrecibo) nrecibo, MAX(sproces) sproces
                             FROM rrc_sam rs, recibos r
                            WHERE rs.nrecibo = r.nrecibo
                              AND TRUNC(TO_DATE(r.femisio)) >=
                                    TO_DATE
                                           ('01/01/'
                                            || TO_CHAR(TO_DATE(phasta, 'DDMMYYYY'), 'YYYY'))   -- Fecha inicio de año
                         GROUP BY rs.nrecibo) LOOP
         SELECT SUM(NVL(iprirrc_moncon, 0))
           INTO wcalcul
           FROM rrc_sam
          WHERE nrecibo = cur.nrecibo
            AND sproces = cur.sproces;

         v_importe := v_importe + wcalcul;
      END LOOP;

      RETURN v_importe;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_rrc_cons_anoact;

   /******************************************************************************************
     Descripció: Obtenemos la RRC liberada de las pólizas emitidas el año actual y no tengan provisión en la fecha hasta
    */
   FUNCTION f_get_rrc_lib_anoact(phasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_rrc_lib_anoact';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_importe      NUMBER := 0;
      wcalcul        NUMBER := 0;
      v_ntraza       NUMBER := 0;
   BEGIN
      FOR cur IN
         (SELECT DISTINCT (rs.nrecibo) nrecibo, MAX(sproces) sproces
                     FROM rrc_sam rs, recibos r
                    WHERE rs.nrecibo = r.nrecibo
                      AND TRUNC(TO_DATE(r.femisio)) >=
                            TO_DATE('01/01/' || TO_CHAR(TO_DATE(phasta, 'DDMMYYYY'), 'YYYY'))   -- Fecha inicio de año
                      AND rs.nrecibo NOT IN(SELECT nrecibo
                                              FROM rrc_sam
                                             WHERE fcalcul =
                                                      (SELECT MAX(fcalcul)
                                                         FROM rrc_sam
                                                        WHERE fcalcul <=
                                                                 LAST_DAY(TO_DATE(phasta,
                                                                                  'DDMMYYYY'))))   --Fecha de fin
                 GROUP BY rs.nrecibo) LOOP
         SELECT SUM(NVL(iprirrc_moncon, 0))
           INTO wcalcul
           FROM rrc_sam
          WHERE nrecibo = cur.nrecibo
            AND sproces = cur.sproces;

         v_importe := v_importe + wcalcul;
      END LOOP;

      RETURN v_importe;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_rrc_lib_anoact;

   /******************************************************************************************
     Descripció: Cabecera del map 872 AC - Intermediario
     return:     texto cabecera
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_872_cab(
      pidioma IN NUMBER,
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_cagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_872_CAB';
      v_tparam       VARCHAR2(1000)
         := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta || ' a='
            || p_cagente;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(LAST_DAY(TO_DATE(fecha_hasta, 'DDMMYYYY')), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ntraza := 130;

      IF p_cagente IS NULL THEN
         v_aux := NULL;
      ELSE
         SELECT MAX(c.nnumide || DECODE(c.tdigitoide, NULL, NULL, '-' || c.tdigitoide) || ' '
                    || b.tnombre || ' ' || b.tapelli1 || ' ' || b.tapelli2)
           INTO v_aux
           FROM agentes a, per_detper b, per_personas c
          WHERE a.cagente = p_cagente
            AND c.sperson = a.sperson
            AND b.sperson = a.sperson
            AND b.fmovimi = (SELECT MAX(b1.fmovimi)
                               FROM per_detper b1
                              WHERE b1.sperson = b.sperson);
      END IF;

      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905597, ' || v_idi || ') || CHR(10)||'
                  -- Intermediario
                  || ' f_axis_literales(9902363, ' || v_idi || ') ' || v_sep || CHR(39)
                  || v_aux || CHR(39) || '|| CHR(10)||'
                                                       -- desde hasta
                  || ' f_axis_literales(101836,  ' || v_idi || ') ' || v_sep || CHR(39)
                  || v_ini || CHR(39) || v_sep || ' f_axis_literales(101837,  ' || v_idi
                  || ') ' || v_sep || CHR(39) || v_fin || CHR(39) || '|| CHR(10)||'
----------------------------------------------------------
                  || ' f_axis_literales(9903067, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9902363, ' || v_idi || ') '
                  || v_sep   -- Rut intemediario
                          || ' f_axis_literales(9902363, ' || v_idi || ') '
                  || v_sep   -- intemediario
                          || ' f_axis_literales(1000562, ' || v_idi || ') '
                  || v_sep   -- Fecha emisión
                          || ' f_axis_literales(800242,  ' || v_idi || ')' || v_sep   -- poliza
                  || ' f_axis_literales(9903499, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(101168, ' || v_idi || ') '
                  || v_sep   -- Num item
                          || ' f_axis_literales(9903499, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905423,' || v_idi || ') '
                  || v_sep   -- Num endoso
                          || ' f_axis_literales(100784,  ' || v_idi || ') ' || v_sep   -- ramo
                  || ' f_axis_literales(9905562, ' || v_idi || ') ' || v_sep   -- nombre ramo
                  || ' f_axis_literales(100829,  ' || v_idi || ') ' || v_sep   -- producto
                  || ' f_axis_literales(1000307, ' || v_idi || ') ' || v_sep   -- nombre producto
                  || ' f_axis_literales(101028,  ' || v_idi || ') ' || v_sep   -- asegurado
                  || ' f_axis_literales(9903067, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(101028, ' || v_idi || ') '
                  || v_sep   -- Rut asegurado
                          || ' f_axis_literales(9905602, ' || v_idi || ') '
                  || v_sep   -- Vig. inicial
                          || ' f_axis_literales(9001868, ' || v_idi || ') '
                  || v_sep   -- Momivimiento
                          || ' f_axis_literales(9002202, ' || v_idi || ') ' || v_sep   -- sucursal
                  || ' f_axis_literales(9905603, ' || v_idi || ') ' || v_sep   -- M.O.
                  || ' f_axis_literales(102995,  ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905603, ' || v_idi || ') '
                  || v_sep   -- prima neta mo
                          || ' f_axis_literales(9001923, ' || v_idi || ') '
                  || v_sep   -- porcen comision
                          || ' f_axis_literales(101509,  ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905603, ' || v_idi || ') '
                  || v_sep   -- comision mo
                          || ' f_axis_literales(9903807, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905603, ' || v_idi || ') '
                  || v_sep   -- descuento mo
                          || ' f_axis_literales(9905604, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9905603, ' || v_idi || ') '
                  || v_sep   -- saldo a pagar mo
                          || ' f_axis_literales(9905605, ' || v_idi || ') '
                  || v_sep   -- Monto M.N.
                          || ' f_axis_literales(9905606, ' || v_idi || ') '
                  || v_sep   -- Saldo en M.N.
                          || ' f_axis_literales(9905607, ' || v_idi || ') '
                  || v_sep   -- Origen Cbte
                          || ' f_axis_literales(9000519, ' || v_idi || ') '
                  || v_sep   -- Tipo agente
                          || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_872_cab;

   /******************************************************************************************
     Descripció: Detalle del map 872 AC - Intermediario
     return:     texto detalle
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_872_det(
      pidioma IN NUMBER,
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_cagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_872_DET';
      v_tparam       VARCHAR2(1000)
         := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta || ' a='
            || p_cagente;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_auxage       VARCHAR2(200);
      v_litcom       VARCHAR2(200);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 120;
      v_fin := 'last_day(TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY''))';
      v_ntraza := 130;
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 140;
      v_litcom := f_axis_literales(105048, v_idi);   -- Comisiones

      IF p_cagente IS NULL THEN
         v_auxage := NULL;
      ELSE
         v_auxage := ' and r.cagente=' || p_cagente;
      END IF;

      v_ttexto :=
         'select' || ' rut_intermediario' || v_sep || ' nombre_intermediario' || v_sep
         || ' fecEmision' || v_sep || ' npoliza' || v_sep || ' ncertif' || v_sep || ' endoso'
         || v_sep || ' cramo' || v_sep || ' desram' || v_sep || ' sproduc' || v_sep
         || ' despro' || v_sep || ' ase' || v_sep || ' rutase' || v_sep || ' vInicial' || v_sep
         || ' Movimiento' || v_sep || ' suc' || v_sep || ' mo' || v_sep || ' PrimaNeta'
         || v_sep || ' por_comis' || v_sep || ' Comis_MO' || v_sep || ' Descuen_MO' || v_sep
         || ' Saldo_MO' || v_sep || ' Monto_MN' || v_sep || ' Saldo_MN' || v_sep || ' Origen'
         || v_sep || 'TipoAgente' || v_sep || CHR(39) || CHR(39) || ' linea' || ' from  ('
         || ' SELECT   (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM agentes a1, per_personas p1 '
         || '                    WHERE a1.cagente = ll.cagente '
         || '                      AND p1.sperson = a1.sperson) rut_intermediario, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' '
         || '                              || p2.tapelli2) '
         || '                     FROM agentes a2, per_detper p2 '
         || '                    WHERE a2.cagente = ll.cagente '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = a2.sperson) nombre_intermediario, '
         || '                  TRUNC(r.femisio) fecemision, s.npoliza, s.ncertif, r.nmovimi endoso, s.cramo, '
         || '                  ff_desramo(s.cramo, ' || v_idi || ') desram, s.sproduc, '
         || '                  f_desproducto_t(s.cramo, s.cmodali, s.ctipseg, s.ccolect, 1, '
         || v_idi || ') despro, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' || p2.tapelli2) '
         || '                     FROM riesgos ri, per_detper p2 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = ri.sperson) ase, '
         || '                  (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM riesgos ri, per_personas p1 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p1.sperson = ri.sperson) rutase, '
         || '                  s.fefecto vinicial, ' || CHR(39) || v_litcom || CHR(39)
         || '  movimiento, '
         || '                  (SELECT MAX(p3.tnombre || '' '' || p3.tapelli1 || '' '' || p3.tapelli2) '
         || '                     FROM agentes a1, per_detper p3 '
         || '                    WHERE a1.cagente = pac_redcomercial.f_busca_padre(s.cempres, '
         || '                                                                      ll.cagente, 3, '
         || '                                                                      f_sysdate) '
         || '                      AND p3.fmovimi = (SELECT MAX(p33.fmovimi) '
         || '                                          FROM per_detper p33 '
         || '                                         WHERE p33.sperson = p3.sperson) '
         || '                      AND p3.sperson = a1.sperson) suc, '
         || '                  (SELECT MAX(tdescri) ' || '                     FROM monedas '
         || '                    WHERE cidioma = ' || v_idi
         || '                      AND cmoneda = p.cdivisa) mo, v.iprinet primaneta, '
         || '                  PAC_INFORMES_152.f_porcomis(s.sseguro, s.sproduc, s.cactivi, NULL, '
         || '                                              a.ccomisi_indirect) por_comis, '
         || '                  NVL(ll.icomisi, 0) comis_mo, 0 descuen_mo, NVL(ll.icomisi, 0) - 0 saldo_mo, '
         || '                  NVL(ll.icomisi_moncia, 0) monto_mn, NVL(ll.icomisi_moncia, 0) - 0 saldo_mn, '
         || '                  ff_desvalorfijo(8, ' || v_idi || ', r.ctiprec) origen, '
         || '                  ff_desvalorfijo(30, ' || v_idi || ', '
         || '                                  (SELECT MAX(r1.ctipage) '
         || '                                     FROM redcomercial r1 '
         || '                                    WHERE r1.cempres =' || v_emp
         || '                                      AND r1.cagente = ll.cagente '
         || '                                      AND r1.fmovini = '
         || '                                             (SELECT MAX(r2.fmovini) '
         || '                                                FROM redcomercial r2 '
         || '                                               WHERE r2.cempres = ' || v_emp
         || '                                                 AND r2.cagente = ll.cagente))) tipoagente '
         || '             FROM recibos r, seguros s, productos p, agentes_comp ac, vdetrecibos v, agentes a, '
         || '                  liquidacab lc, liquidalin ll '
         || '            WHERE lc.cempres = ' || v_emp
         || '              AND lc.fliquid BETWEEN ' || v_ini
         || '                                 AND ' || v_fin
         || '              AND lc.sproliq = (SELECT MAX(l2.sproliq) '
         || '                                  FROM liquidacab l2 '
         || '                                 WHERE l2.cempres = lc.cempres '
         || '                                   AND l2.fliquid = lc.fliquid) '
         || '              AND lc.ctipoliq = 0 '
         || '              AND ll.cagente = lc.cagente '
         || '              AND ll.cempres = lc.cempres '
         || '              AND ll.nliqmen = lc.nliqmen '
         || '              AND r.nrecibo(+) = ll.nrecibo ' || v_auxage
         || '              AND v.nrecibo = r.nrecibo '
         || '              AND a.cagente = ll.cagente '
         || '              AND s.sseguro = r.sseguro '
         || '              AND p.sproduc = s.sproduc '
         || '              AND ac.cagente = r.cagente ' || '              AND a.ctipage = 8 '
         || '         ORDER BY rut_intermediario, npoliza, ncertif) ' || '  ' || ' UNION ALL '
         || '  ' || ' select' || ' rut_intermediario' || v_sep || ' nombre_intermediario'
         || v_sep || ' fecEmision' || v_sep || ' npoliza' || v_sep || ' ncertif' || v_sep
         || ' endoso' || v_sep || ' cramo' || v_sep || ' desram' || v_sep || ' sproduc'
         || v_sep || ' despro' || v_sep || ' ase' || v_sep || ' rutase' || v_sep || ' vInicial'
         || v_sep || ' Movimiento' || v_sep || ' suc' || v_sep || ' mo' || v_sep
         || ' PrimaNeta' || v_sep || ' por_comis' || v_sep || ' Comis_MO' || v_sep
         || ' Descuen_MO' || v_sep || ' Saldo_MO' || v_sep || ' Monto_MN' || v_sep
         || ' Saldo_MN' || v_sep || ' Origen' || v_sep || 'TipoAgente' || v_sep || CHR(39)
         || CHR(39) || ' linea' || ' from  (' || '  SELECT   (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM agentes a1, per_personas p1 '
         || '                    WHERE a1.cagente = r.cagente '
         || '                      AND p1.sperson = a1.sperson) rut_intermediario, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' '
         || '                              || p2.tapelli2) '
         || '                     FROM agentes a2, per_detper p2 '
         || '                    WHERE a2.cagente = r.cagente '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = a2.sperson) nombre_intermediario, '
         || '                  TRUNC(r.femisio) fecemision, s.npoliza, s.ncertif, r.nmovimi endoso, s.cramo, '
         || '                  FF_DESRAMO(s.cramo,' || v_idi || ') desram, s.sproduc, '
         || '                  f_desproducto_t(s.cramo, s.cmodali, s.ctipseg, s.ccolect, 1, '
         || v_idi || ') despro, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' || p2.tapelli2) '
         || '                     FROM riesgos ri, per_detper p2 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = ri.sperson) ase, '
         || '                  (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM riesgos ri, per_personas p1 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p1.sperson = ri.sperson) rutase, '
         || '                  s.fefecto vinicial, ' || CHR(39) || v_litcom || CHR(39)
         || ' movimiento, '
         || '                  (SELECT MAX(p3.tnombre || '' '' || p3.tapelli1 || '' '' || p3.tapelli2) '
         || '                     FROM agentes a1, per_detper p3 '
         || '                    WHERE a1.cagente = pac_redcomercial.f_busca_padre(s.cempres, r.cagente, '
         || '                                                                      3, f_sysdate) '
         || '                      AND p3.fmovimi = (SELECT MAX(p33.fmovimi) '
         || '                                          FROM per_detper p33 '
         || '                                         WHERE p33.sperson = p3.sperson) '
         || '                      AND p3.sperson = a1.sperson) suc, '
         || '                  (SELECT MAX(tdescri) ' || '                     FROM monedas '
         || '                    WHERE cidioma = ' || v_idi
         || '                      AND cmoneda = p.cdivisa) mo, v.iprinet primaneta, '
         || '                  PAC_INFORMES_152.f_porcomis(s.sseguro, s.sproduc, s.cactivi, NULL, '
         || '                                              a.ccomisi_indirect) por_comis, '
         || '                  NVL(d.iconcep, 0) '
         || '                  - NVL((SELECT SUM(iconcep) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 11), '
         || '                        0) comis_mo, ' || '                  0 descuen_mo, '
         || '                  NVL(d.iconcep, 0) '
         || '                  - NVL((SELECT SUM(iconcep) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 11), '
         || '                        0) saldo_mo, '
         || '                  NVL(d.iconcep_monpol, 0) '
         || '                  - NVL((SELECT SUM(iconcep_monpol) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 11), '
         || '                        0) monto_mn, '
         || '                  NVL(d.iconcep_monpol, 0) '
         || '                  - NVL((SELECT SUM(iconcep_monpol) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 11), '
         || '                        0) saldo_mn, ' || '                  ff_desvalorfijo(8, '
         || v_idi || ', r.ctiprec) origen, ' || '                  ff_desvalorfijo(30, '
         || v_idi || ', ' || '                                  (SELECT MAX(r1.ctipage) '
         || '                                     FROM redcomercial r1 '
         || '                                    WHERE r1.cempres = ' || v_emp
         || '                                      AND r1.cagente = r.cagente '
         || '                                      AND r1.fmovini = '
         || '                                              (SELECT MAX(r2.fmovini) '
         || '                                                 FROM redcomercial r2 '
         || '                                                WHERE r2.cempres = ' || v_emp
         || '                                                  AND r2.cagente = r.cagente))) tipoagente '
         || '             FROM recibos r, seguros s, productos p, agentes_comp ac, vdetrecibos v, agentes a, '
         || '                  movrecibo m, detrecibos d '
         || '            WHERE m.fcontab BETWEEN ' || v_ini
         || '                                AND ' || v_fin
         || '              AND cestrec IN(0, 3, 4) '
         || '              AND m.smovrec = (SELECT MAX(smovrec) '
         || '                                 FROM movrecibo '
         || '                                WHERE m.nrecibo = nrecibo '
         || '                                  AND fcontab < ' || v_fin || ') '
         || '              AND d.nrecibo = r.nrecibo ' || '              AND d.cconcep IN(11) '
         || '              AND d.nrecibo = m.nrecibo '
         || '              AND v.nrecibo = r.nrecibo '
         || '              AND a.cagente = r.cagente ' || v_auxage
         || '              AND s.sseguro = r.sseguro '
         || '              AND p.sproduc = s.sproduc '
         || '              AND ac.cagente = r.cagente ' || '              AND a.ctipage = 8 '
         || '         ORDER BY rut_intermediario, npoliza, ncertif) ' || ' UNION ALL '
         || ' select' || ' rut_intermediario' || v_sep || ' nombre_intermediario' || v_sep
         || ' fecEmision' || v_sep || ' npoliza' || v_sep || ' ncertif' || v_sep || ' endoso'
         || v_sep || ' cramo' || v_sep || ' desram' || v_sep || ' sproduc' || v_sep
         || ' despro' || v_sep || ' ase' || v_sep || ' rutase' || v_sep || ' vInicial' || v_sep
         || ' Movimiento' || v_sep || ' suc' || v_sep || ' mo' || v_sep || ' PrimaNeta'
         || v_sep || ' por_comis' || v_sep || ' Comis_MO' || v_sep || ' Descuen_MO' || v_sep
         || ' Saldo_MO' || v_sep || ' Monto_MN' || v_sep || ' Saldo_MN' || v_sep || ' Origen'
         || v_sep || 'TipoAgente' || v_sep || CHR(39) || CHR(39) || ' linea' || ' from  ('
         || '   SELECT   (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM agentes a1, per_personas p1 '
         || '                    WHERE a1.cagente = pac_redcomercial.f_busca_padre(' || v_emp
         || ', r.cagente, null, '
         || '                                                                      r.fefecto) '
         || '                      AND p1.sperson = a1.sperson) rut_intermediario, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' '
         || '                              || p2.tapelli2) '
         || '                     FROM agentes a2, per_detper p2 '
         || '                    WHERE a2.cagente = '
         || '                             pac_redcomercial.f_busca_padre(' || v_emp
         || ', r.cagente, '
         || '                                                            null, r.fefecto) '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = a2.sperson) nombre_intermediario, '
         || '                  TRUNC(r.femisio) fecemision, s.npoliza, s.ncertif, r.nmovimi endoso, s.cramo, '
         || '                  ff_desramo(s.cramo, ' || v_idi || ') desram, s.sproduc, '
         || '                  f_desproducto_t(s.cramo, s.cmodali, s.ctipseg, s.ccolect, 1, '
         || v_idi || ') despro, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' || p2.tapelli2) '
         || '                     FROM riesgos ri, per_detper p2 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = ri.sperson) ase, '
         || '                  (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM riesgos ri, per_personas p1 '
         || '                    WHERE ri.sseguro = s.sseguro '
         || '                      AND ri.nriesgo = NVL(r.nriesgo, (SELECT MAX(nriesgo) '
         || '                                                         FROM riesgos '
         || '                                                        WHERE sseguro = s.sseguro)) '
         || '                      AND p1.sperson = ri.sperson) rutase, '
         || '                  s.fefecto vinicial, ''Comisiones Pend.'' movimiento, '
         || '                  (SELECT MAX(p3.tnombre || '' '' || p3.tapelli1 || '' '' || p3.tapelli2) '
         || '                     FROM agentes a1, per_detper p3 '
         || '                    WHERE a1.cagente = '
         || '                             pac_redcomercial.f_busca_padre '
         || '                                               (s.cempres, '
         || '                                                pac_redcomercial.f_busca_padre('
         || v_emp || ', '
         || '                                                                               r.cagente, '
         || '                                                                               null, '
         || '                                                                               r.fefecto), '
         || '                                                3, f_sysdate) '
         || '                      AND p3.fmovimi = (SELECT MAX(p33.fmovimi) '
         || '                                          FROM per_detper p33 '
         || '                                         WHERE p33.sperson = p3.sperson) '
         || '                      AND p3.sperson = a1.sperson) suc, '
         || '                  (SELECT MAX(tdescri) ' || '                     FROM monedas '
         || '                    WHERE cidioma = ' || v_idi
         || '                      AND cmoneda = p.cdivisa) mo, v.iprinet primaneta, '
         || '                  PAC_INFORMES_152.f_porcomis(s.sseguro, s.sproduc, s.cactivi, NULL, '
         || '                                              a.ccomisi_indirect) por_comis, '
         || '                  NVL(d.iconcep, 0) '
         || '                  - NVL((SELECT SUM(iconcep) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 47), '
         || '                        0) comis_mo, ' || '                  0 descuen_mo, '
         || '                  NVL(d.iconcep, 0) '
         || '                  - NVL((SELECT SUM(iconcep) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 47), '
         || '                        0) saldo_mo, '
         || '                  NVL(d.iconcep_monpol, 0) '
         || '                  - NVL((SELECT SUM(iconcep_monpol) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 47), '
         || '                        0) monto_mn, '
         || '                  NVL(d.iconcep_monpol, 0) '
         || '                  - NVL((SELECT SUM(iconcep_monpol) '
         || '                           FROM detmovrecibo_parcial dp, detmovrecibo dm '
         || '                          WHERE dp.nrecibo = d.nrecibo '
         || '                            AND dp.cgarant = d.cgarant '
         || '                            AND dp.nrecibo = dm.nrecibo '
         || '                            AND dp.smovrec = dm.smovrec '
         || '                            AND dp.norden = dm.norden '
         || '                            AND dm.fcontab < ' || v_fin
         || '                            AND cconcep = 47), '
         || '                        0) saldo_mn, '
         || '                  ff_desvalorfijo(8, 3, r.ctiprec) origen, '
         || '                  ff_desvalorfijo ' || '                          (30, 3, '
         || '                           (SELECT MAX(r1.ctipage) '
         || '                              FROM redcomercial r1 '
         || '                             WHERE r1.cempres = ' || v_emp
         || '                               AND r1.cagente = pac_redcomercial.f_busca_padre('
         || v_emp || ', r.cagente, null, '
         || '                                                                               r.fefecto) '
         || '                               AND r1.fmovini = '
         || '                                     (SELECT MAX(r2.fmovini) '
         || '                                        FROM redcomercial r2 '
         || '                                       WHERE r2.cempres = ' || v_emp
         || '                                         AND r2.cagente = '
         || '                                               pac_redcomercial.f_busca_padre('
         || v_emp || ', r.cagente, null, '
         || '                                                                              r.fefecto)))) '
         || '                                                                                     tipoagente '
         || '             FROM recibos r, seguros s, productos p, agentes_comp ac, vdetrecibos v, agentes a, '
         || '                  movrecibo m, detrecibos d '
         || '            WHERE m.fcontab BETWEEN ' || v_ini
         || '                                AND ' || v_fin
         || '              AND cestrec IN(0, 3, 4) '
         || '              AND m.smovrec = (SELECT MAX(smovrec) '
         || '                                 FROM movrecibo '
         || '                                WHERE m.nrecibo = nrecibo '
         || '                                  AND fcontab < ' || v_fin || ') '
         || '              AND d.nrecibo = r.nrecibo ' || '              AND d.cconcep IN(47) '
         || '              AND d.nrecibo = m.nrecibo '
         || '              AND v.nrecibo = r.nrecibo '
         || '              AND a.cagente = pac_redcomercial.f_busca_padre(' || v_emp
         || ', r.cagente, null, r.fefecto) ' || '              AND s.sseguro = r.sseguro '
         || '              AND p.sproduc = s.sproduc ' || v_auxage
         || '              AND ac.cagente = pac_redcomercial.f_busca_padre(' || v_emp
         || ', r.cagente, null, r.fefecto) ' || '              AND a.ctipage = 8 '
         || '         ORDER BY rut_intermediario, npoliza, ncertif) ' || ' UNION ALL '
         || ' select' || ' rut_intermediario' || v_sep || ' nombre_intermediario' || v_sep
         || ' fecEmision' || v_sep || ' npoliza' || v_sep || ' ncertif' || v_sep || ' endoso'
         || v_sep || ' cramo' || v_sep || ' desram' || v_sep || ' sproduc' || v_sep
         || ' despro' || v_sep || ' ase' || v_sep || ' rutase' || v_sep || ' vInicial' || v_sep
         || ' Movimiento' || v_sep || ' suc' || v_sep || ' mo' || v_sep || ' PrimaNeta'
         || v_sep || ' por_comis' || v_sep || ' Comis_MO' || v_sep || ' Descuen_MO' || v_sep
         || ' Saldo_MO' || v_sep || ' Monto_MN' || v_sep || ' Saldo_MN' || v_sep || ' Origen'
         || v_sep || 'TipoAgente' || v_sep || CHR(39) || CHR(39) || ' linea' || ' from  ('
         || '   SELECT   (SELECT MAX(p1.nnumide '
         || '                              || DECODE(p1.tdigitoide, '
         || '                                        NULL, NULL, '
         || '                                        ''-'' || p1.tdigitoide)) '
         || '                     FROM agentes a1, per_personas p1 '
         || '                    WHERE a1.cagente = ll.cagente '
         || '                      AND p1.sperson = a1.sperson) rut_intermediario, '
         || '                  (SELECT MAX(p2.tnombre || '' '' || p2.tapelli1 || '' '' '
         || '                              || p2.tapelli2) '
         || '                     FROM agentes a2, per_detper p2 '
         || '                    WHERE a2.cagente = ll.cagente '
         || '                      AND p2.fmovimi = (SELECT MAX(p22.fmovimi) '
         || '                                          FROM per_detper p22 '
         || '                                         WHERE p22.sperson = p2.sperson) '
         || '                      AND p2.sperson = a2.sperson) nombre_intermediario, '
         || '                  TRUNC(ll.ffecmov) fecemision, NULL npoliza, NULL ncertif, NULL endoso, '
         || '                  p.cramo, ff_desramo(p.cramo, ' || v_idi
         || ') desram, p.sproduc, '
         || '                  f_desproducto_t(p.cramo, p.cmodali, p.ctipseg, p.ccolect, 1, '
         || v_idi || ') despro, ' || '                  NULL ase, NULL rutase, NULL vinicial, '
         || CHR(39) || v_litcom || CHR(39) || ' movimiento, '
         || '                  (SELECT MAX(p3.tnombre || '' '' || p3.tapelli1 || '' '' || p3.tapelli2) '
         || '                     FROM agentes a1, per_detper p3 '
         || '                    WHERE a1.cagente = pac_redcomercial.f_busca_padre(ll.cempres, '
         || '                                                                      ll.cagente, 3, '
         || '                                                                      f_sysdate) '
         || '                      AND p3.fmovimi = (SELECT MAX(p33.fmovimi) '
         || '                                          FROM per_detper p33 '
         || '                                         WHERE p33.sperson = p3.sperson) '
         || '                      AND p3.sperson = a1.sperson) suc, '
         || '                  (SELECT MAX(tdescri) ' || '                     FROM monedas '
         || '                    WHERE cidioma = ' || v_idi
         || '                      AND cmoneda = 11) mo, 0 primaneta, 0 por_comis, '
         || '                  NVL(-ll.iimport, 0) comis_mo, 0 descuen_mo, NVL(-ll.iimport, 0) - 0 saldo_mo, '
         || '                  NVL(-ll.iimport, 0) monto_mn, NVL(-ll.iimport, 0) - 0 saldo_mn, '
         || '                  ''AUTOLIQUIDACIÓN'' origen, '
         || '                  ff_desvalorfijo(30, 3, '
         || '                                  (SELECT MAX(r1.ctipage) '
         || '                                     FROM redcomercial r1 '
         || '                                    WHERE r1.cempres = ' || v_emp
         || '                                      AND r1.cagente = ll.cagente '
         || '                                      AND r1.fmovini = '
         || '                                             (SELECT MAX(r2.fmovini) '
         || '                                                FROM redcomercial r2 '
         || '                                               WHERE r2.cempres = ' || v_emp
         || '                                                 AND r2.cagente = ll.cagente))) tipoagente '
         || '             FROM productos p, agentes_comp ac, agentes a, ctactes ll '
         || '            WHERE ll.cempres = ' || v_emp || '              AND ll.cconcta = 10 '
         || '              AND ll.ffecmov BETWEEN ' || v_ini
         || '                                 AND ' || v_fin
         || '              AND a.cagente = ll.cagente '
         || '              AND p.sproduc = ll.sproduc '
         || '              AND ac.cagente = ll.cagente ' || '              AND a.ctipage = 8 '
         || '         ORDER BY rut_intermediario, npoliza, ncertif) ';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_872_det;

   /******************************************************************************************
     Descripció: Cabecera 2 del map 872 AC - Intermediario
     return:     texto cabecera
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_872_cab2(
      pidioma IN NUMBER,
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_cagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_872_CAB2';
      v_tparam       VARCHAR2(1000)
         := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta || ' a='
            || p_cagente;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 130;
      v_ttexto := 'select' || ' chr(10)||chr(10)||chr(10)||' || ' f_axis_literales(9903067, '
                  || v_idi || ') ||'' ''|| f_axis_literales(9902363, ' || v_idi || ') '
                  || v_sep   -- Rut intemediario
                          || ' f_axis_literales(9902363, ' || v_idi || ') '
                  || v_sep   -- intemediario
                          || ' f_axis_literales(9902071, ' || v_idi || ') '
                  || v_sep   -- Liquidado
                          || ' f_axis_literales(9905074, ' || v_idi || ') '
                  || v_sep   -- Autoliquidacion
                          || ' f_axis_literales(9905283, ' || v_idi || ') '
                  || v_sep   -- Importe a pagar
                          || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_872_cab2;

   /******************************************************************************************
     Descripció: Detalle 2 del map 872 AC - Intermediario
     return:     texto detalle
   -- bug 0026721/143522 - 06/05/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_872_det2(
      pidioma IN NUMBER,
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_cagente IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_872_DET2';
      v_tparam       VARCHAR2(1000)
         := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta || ' a='
            || p_cagente;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_fin2         VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_auxage       VARCHAR2(200);
      v_litcom       VARCHAR2(200);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_ntraza := 120;
      v_fin := 'last_day(TO_DATE(' || CHR(39) || fecha_hasta || CHR(39) || ', ''DDMMYYYY''))';
      v_ntraza := 130;
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 140;
      v_litcom := f_axis_literales(105048, v_idi);   -- Comisiones

      IF p_cagente IS NULL THEN
         v_auxage := NULL;
      ELSE
         v_auxage := ' and r.cagente=' || p_cagente;
      END IF;

      SELECT TO_CHAR(LAST_DAY(TO_DATE(fecha_hasta, 'DDMMYYYY')), 'yyyymm')
        INTO v_fin2
        FROM DUAL;

      v_ttexto :=
         'select' || ' rut_intermediario' || v_sep || ' nombre_intermediario' || v_sep
         || ' sum(liquidado)' || v_sep || ' sum(autoliq)' || v_sep
         || ' (sum(liquidado)-sum(autoliq))' || v_sep || CHR(39) || CHR(39) || ' linea'
         || ' from  (' || '   SELECT'
         || '          (select max(p1.NNUMIDE||decode(p1.TDIGITOIDE,null,null,''-''||p1.TDIGITOIDE) )'
         || '            from  agentes a1, per_personas p1'
         || '            where a1.cagente=r.cagente'
         || '            and   p1.sperson=a1.sperson' || '          )  rut_intermediario,'
         || '          (select max(p2.TNOMBRE||'' ''||p2.TAPELLI1||'' ''||p2.TAPELLI2)'
         || '            from  agentes a2, per_detper p2'
         || '            where a2.cagente=r.cagente'
         || '            and   p2.FMOVIMI=(select max(p22.fmovimi) from per_detper p22 where p22.sperson=p2.sperson)'
         || '            and   p2.sperson=a2.sperson' || '          )  nombre_intermediario ,'
         || '          nvl(ll.icomisi_moncia,0) liquidado,'
         || '          (select nvl(SUM(nvl(DECODE(c.cdebhab, 1, c.iimport *(-1), 2, c.iimport),0)),0) iimport'
         || '          from  ctactes c' || '          where c.cconcta = 8 and c.cempres='
         || v_emp || '          and   c.cagente = r.cagente'
         || '          and   to_char(fvalor,''yyyymm'')=' || CHR(39) || v_fin2 || CHR(39)
         || '          ) autoliq'
         || '     FROM recibos r, seguros s, productos p, agentes_comp ac, vdetrecibos v, agentes a, liquidacab lc, liquidalin ll'
         || '    WHERE lc.cempres=' || v_emp || '    and lc.fliquid between ' || v_ini
         || ' and ' || v_fin
         || '    AND lc.sproliq=(select max(l2.sproliq) from liquidacab l2 where l2.cempres=lc.cempres and l2.fliquid=lc.fliquid)'
         || '    AND lc.ctipoliq = 0' || '    AND ll.cagente = lc.cagente'
         || '    AND ll.cempres = lc.cempres' || '    AND ll.nliqmen = lc.nliqmen'
         || '    AND r.nrecibo(+) = ll.nrecibo' || v_auxage || '    and v.nrecibo=r.nrecibo'
         || '    and a.CAGENTE=r.cagente' || '    AND s.sseguro = r.sseguro'
         || '    AND p.sproduc = s.sproduc' || '    AND ac.cagente = r.cagente'
-----------------------------------------------------------------------------------
         || '   )' || '   group by rut_intermediario, nombre_intermediario';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_872_det2;

   /******************************************************************************************
     Descripció: Cabecera del map 709 - Margen solvencia
     return:     texto cabecera
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_709_cab(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_709_CAB';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;

      BEGIN
         SELECT TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'dd/mm/yyyy')
           INTO v_ini
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_ini := fecha_desde;
      END;

      v_ntraza := 120;

      BEGIN
         SELECT TO_CHAR(LAST_DAY(TO_DATE(fecha_hasta, 'DDMMYYYY')), 'dd/mm/yyyy')
           INTO v_fin
           FROM DUAL;
      EXCEPTION
         WHEN OTHERS THEN
            v_fin := fecha_hasta;
      END;

      v_ntraza := 130;
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905140, ' || v_idi || ') || CHR(10)||'
                  -- desde hasta
                  || ' f_axis_literales(101836,  ' || v_idi || ') ' || v_sep || CHR(39)
                  || v_ini || CHR(39) || v_sep || ' f_axis_literales(101837,  ' || v_idi
                  || ') ' || v_sep || CHR(39) || v_fin || CHR(39) || '|| CHR(10)||'
----------------------------------------------------------
                  || CHR(39) || CHR(39) || v_sep || ' f_axis_literales(101368, ' || v_idi
                  || ') ' || v_sep   -- Prima
                                  || CHR(39) || CHR(39) || v_sep
                  || ' f_axis_literales(9905096, ' || v_idi
                  || ') ||'' ''|| f_axis_literales(9904824, ' || v_idi || ') '
                  || v_sep   -- Monto Asegurado
                          || CHR(39) || CHR(39) || v_sep || ' f_axis_literales(9001408, '
                  || v_idi || ') ' || v_sep   -- Reserva
                                           || CHR(39) || CHR(39) || '|| CHR(10)||' || CHR(39)
                  || CHR(39) || v_sep || ' f_axis_literales(9905211, ' || v_idi || ') '
                  || v_sep   -- Directa
                          || ' f_axis_literales(9905212, ' || v_idi || ') ' || v_sep   -- Cedida
                  || ' f_axis_literales(9905211, ' || v_idi || ') ' || v_sep   -- Directa
                  || ' f_axis_literales(9905212, ' || v_idi || ') ' || v_sep   -- Cedida
                  || ' f_axis_literales(9905211, ' || v_idi || ') ' || v_sep   -- Directa
                  || ' f_axis_literales(9905212, ' || v_idi || ') ' || v_sep   -- Cedida
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_709_cab;

   /******************************************************************************************
     Descripció: Detalle del map 709 - Margen solvencia
     return:     texto detalle
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_709_det(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_709_DET';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_initrunc     VARCHAR2(100);
      v_fintrunc     VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_auxage       VARCHAR2(200);
      v_litcom       VARCHAR2(200);
      v_tmoneda      VARCHAR2(10);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || '000000' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 120;
      v_fin := 'last_day(TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYHH24MISS''))';
      v_ntraza := 125;
      v_initrunc := 'TO_DATE(' || CHR(39) || fecha_desde || CHR(39) || ', ''DDMMYYYY'')';
      v_fintrunc := 'last_day(TO_DATE(' || CHR(39) || fecha_hasta || CHR(39)
                    || ', ''DDMMYYYY''))';
      v_ntraza := 130;
      --v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 140;
      v_litcom := f_axis_literales(105048, v_idi);   -- Comisiones
      -- bug 26430 - 31/10/2013 - JMF
      v_ntraza := 142;

      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_tmoneda
        FROM parempresas
       WHERE cempres = v_emp
         AND cparam = 'MONEDACONTAB';

----------------------------------------------------------------
----------------------------------------------------------------
-- CUIDADO es facil superar los 32000 caracteres de la variable
-- se quitan espacios en blanco
-- montar select de prueba antes de pasar
----------------------------------------------------------------
----------------------------------------------------------------
      v_ntraza := 144;
      v_ttexto :=
         REPLACE
            ('SELECT NVL(pac_parametros.f_descdetparam(''COBERAMO'', agrupacion, 3),'
             || '       f_axis_literales(110031, 3)),'
             || '       SUM(pdirecta), SUM(pcedida), SUM(mdirecta), SUM(mcedida), SUM(rdirecta),'
             || '       SUM(rcedida) linea'
             || ' FROM (SELECT 0 pdirecta, 0 pcedida, SUM(NVL(mdirecta, 0)) mdirecta,'
             || '              SUM(NVL(mcedida, 0)) mcedida, 0 rdirecta, 0 rcedida, agrupacion'
             || '         FROM (SELECT pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                      g.cgarant, ''COBERAMO'') agrupacion,'
             || '                      pac_eco_tipocambio.f_importe_cambio'
             || '                      (pac_eco_monedas.f_obtener_cmonint(p.cdivisa),'
             || '                      ' || CHR(39) || v_tmoneda || CHR(39) || ', '
             || v_fintrunc || ', g.icapital, 1) mdirecta,'
             || '                      pac_eco_tipocambio.f_importe_cambio'
             || '                      (pac_eco_monedas.f_obtener_cmonint(p.cdivisa),'
             || '                     ' || CHR(39) || v_tmoneda || CHR(39) || ', '
             || v_fintrunc || ','
             || '                      PAC_INFORMES_152.f_icesioncp(g.sseguro,'
             || '                      g.nriesgo,' || '                      g.cgarant),'
             || '                      1) mcedida '
             || '                FROM garanseg g, seguros s, productos p'
             || '               WHERE g.sseguro = s.sseguro'
             || '                 AND p.sproduc = s.sproduc'
             || '                 AND EXISTS(SELECT 1'
             || '                             FROM recibos rr'
             || '                             WHERE rr.sseguro = s.sseguro)'
             || '                 AND f_vigente(s.sseguro, NULL, ' || v_fintrunc || ') = 0'
             || '                 AND g.finiefe >= ' || v_ini
             || '                 AND g.finiefe <= ' || v_fin
             || '                 AND g.nmovimi = (SELECT MAX(nmovimi)'
             || '                                   FROM garanseg'
             || '                                  WHERE sseguro = g.sseguro '
             || '                                    AND finiefe >=' || v_ini
             || '                                    AND finiefe <=' || v_fin
             || '                                ))' || '               GROUP BY agrupacion'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT 0 pdirecta, 0 pcedida, 0 mdirecta, 0 mcedida, SUM(iprincs) rdirecta,'
             || '                      0 rcedida, agrupacion'
             || '                 FROM (SELECT NVL(p.iprirrc_moncon, 0) iprincs, 0,'
             || '                              pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                              p.cgarant, ''COBERAMO'') agrupacion'
             || '                         FROM rrc_sam p, seguros s'
             || '                        WHERE p.sseguro = s.sseguro'
             || '                          AND p.fcalcul = ' || v_fintrunc
             || '                       )' || '                       GROUP BY agrupacion'
-------------------------
             || '                      UNION'
-------------------------
             || '                      SELECT 0 pdirecta, 0 pcedida, 0 mdirecta, 0 mcedida, 0 rdirecta,'
             || '                             SUM(iprincs) rcedida, agrupacion'
             || '                        FROM (SELECT NVL(p.iprrcrc_moncon, 0) iprincs, 0,'
             || '                                     pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                                     p.cgarant, ''COBERAMO'') agrupacion'
             || '                                FROM rrc_rea_sam p, seguros s'
             || '                               WHERE p.sseguro = s.sseguro'
             || '                               AND p.fcalcul = ' || v_fintrunc
             || '                               )'
             || '                       GROUP BY agrupacion'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT SUM(imp0) pdirecta, 0 pcedida, 0 mdirecta, 0 mcedida, 0 rdirecta, 0 rcedida,'
             || '                      agrupacion'
             || '               FROM (SELECT SUM(DECODE(d.cconcep,'
             || '                            0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
             || '                            * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol,'
             || '                            0)) imp0,'
             || '                            pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                            d.cgarant, ''COBERAMO'') agrupacion'
             || '                        FROM seguros s, detrecibos d, movrecibo m, recibos r, agentes_comp ac'
             || '                       WHERE m.fmovdia BETWEEN ' || v_ini
             || '                       AND ' || v_fin
             || '                       AND m.cestrec IN(0, 2)'
             || '                       AND m.cestant IN(0)'
             || '                       AND r.nrecibo = m.nrecibo'
             || '                       AND r.cestaux = 0'
             || '                       AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
             || '                       AND s.sseguro = r.sseguro'
             || '                       AND ac.cagente = s.cagente'
             || '                       AND d.nrecibo = r.nrecibo'
             || '                       AND d.cconcep IN(0)'
             || '                       GROUP BY ac.ctipint,'
             || '                       pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,'
             || '                       ''COBERAMO'')'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT SUM(DECODE(d.cconcep,'
             || '                        0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
             || '                        * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol,'
             || '                        0)) imp0,'
             || '                        pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                        d.cgarant, ''COBERAMO'') agrupacion'
             || '                FROM seguros s, detrecibos d, movrecibo m, recibos r, agentes_comp ac'
             || '               WHERE m.fmovdia BETWEEN ' || v_ini || '               AND '
             || v_fin || '               AND((m.cestrec = 1)'
             || '               OR(m.cestrec = 0' || '               AND m.cestant = 1))'
             || '               AND r.nrecibo = m.nrecibo'
             || '               AND r.cestaux = 0'
             || '               AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
             || '               AND s.sseguro = r.sseguro'
             || '               AND ac.cagente = s.cagente'
             || '               AND NOT EXISTS(SELECT 1'
             || '                             FROM detmovrecibo z1'
             || '                             WHERE z1.nrecibo = r.nrecibo)'
             || '               AND d.nrecibo = r.nrecibo'
             || '               AND d.cconcep IN(0)' || '               GROUP BY ac.ctipint,'
             || '               pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,'
             || '               ''COBERAMO'')'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT SUM(DECODE(d.cconcep, 0, -d.iconcep_monpol, 0)) imp0,'
             || '                        pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                        d.cgarant, ''COBERAMO'') agrupacion'
             || '                FROM seguros s, detrecibos d, detmovrecibo m, recibos r, productos p,'
             || '                     agentes_comp ac, movrecibo mr'
             || '                WHERE TRUNC(m.fmovimi) BETWEEN ' || v_ini
             || '               AND ' || v_fin || '               AND r.nrecibo = mr.nrecibo'
             || '               AND r.cestaux = 0'
             || '               AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
             || '               AND s.sseguro = r.sseguro'
             || '               AND p.sproduc = s.sproduc'
             || '               AND ac.cagente = s.cagente'
             || '               AND m.nrecibo = r.nrecibo' || '               AND m.norden = 1'
             || '               AND mr.smovrec = m.smovrec'
             || '               AND d.nrecibo = r.nrecibo'
             || '               AND d.cconcep IN(0)' || '               GROUP BY ac.ctipint,'
             || '               pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,'
             || '               ''COBERAMO'')'
-------------------------
             || '               UNION'   ---DC01
-------------------------
             || '               SELECT SUM' || '                             (DECODE'
             || '                             (d.cconcep,'
             || '                             0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
             || '                             * DECODE(m.cestrec, 1, 1, -1)'
             || '                             * pac_eco_tipocambio.f_importe_cambio(mon.cmonint,'
             || '                             ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                             cc.fcambio,'
             || '                             d.iconcep, 1),'
             || '                             0)) imp0,'
             || '                             pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                             d.cgarant, ''COBERAMO'') agrupacion'
             || '               FROM seguros s, detrecibos d, movrecibo m, recibos r, ctacliente cc,'
             || '                    monedas mon, productos p'
             || '               WHERE s.sproduc = p.sproduc'
             || '               AND mon.cidioma = ' || v_idi
             || '               AND mon.cmoneda = p.cdivisa'
             || '               AND cc.nrecibo = m.nrecibo'
             || '               AND cc.ffecmov = TRUNC(m.fmovdia)'
             || '               AND cc.cmovimi IN(2, 5)'
             || '               AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
             || '               AND m.fmovdia BETWEEN ' || v_ini || '               AND '
             || v_fin || '               AND s.sseguro = r.sseguro'
             || '               AND r.nrecibo = d.nrecibo'
             || '               AND r.nrecibo = m.nrecibo'
             || '               AND r.cestaux = 0'
             || '               AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49)'
             || '               AND d.nrecibo = m.nrecibo'
             || '               AND((m.cestrec = 1)' || '               OR(m.cestrec = 0'
             || '               AND m.cestant = 1))'
             || '               AND m.nrecibo NOT IN(SELECT nrecibo'
             || '                             FROM detmovrecibo)'
             || '               GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,'
             || '               ''COBERAMO'')'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT SUM(DECODE(d.cconcep, 0, d.iconcep_monpol, 0)) imp0,'
             || '                      pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                      d.cgarant, ''COBERAMO'') agrupacion'
             || '               FROM seguros s, detmovrecibo_parcial d, detmovrecibo m, recibos r'
             || '               WHERE r.ctiprec IN(0, 1, 3, 9, 13, 15)'
             || '               AND m.fmovimi BETWEEN ' || v_ini || '               AND '
             || v_fin || '               AND s.sseguro = r.sseguro'
             || '               AND r.nrecibo = d.nrecibo'
             || '               AND r.nrecibo = m.nrecibo'
             || '               AND r.cestaux = 0'
             || '               AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49)'
             || '               AND d.nrecibo = m.nrecibo'
             || '               AND d.norden = m.norden'
             || '               AND d.smovrec = m.smovrec'
             || '               GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,'
             || '               ''COBERAMO''))' || '               GROUP BY agrupacion'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT 0 pdirecta, SUM(NVL(cedida, 0)) pcedida, 0 mdirecta, 0 mcedida, 0 rdirecta,'
             || '                      0 rcedida, agrupacion'
             || '               FROM (SELECT   SUM(NVL(icesion_moncon, icesion)) cedida,'
             || '                              pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                              g.cgarant, ''COBERAMO'') agrupacion'
             || '                    FROM reaseguro r, cuacesfac cc, garanseg g, seguros s, productos p'
             || '                    WHERE r.cgenera <> 2'
             || '                    AND r.fcierre BETWEEN ' || v_initrunc
             || '                    AND ' || v_fintrunc
             || '                    AND r.cempres = ' || v_emp
             || '                    AND r.ccompani = cc.ccompani'
             || '                    AND r.sfacult = cc.sfacult'
             || '                    AND preserv IS NOT NULL'
             || '                    AND g.cgarant = r.cgarant(+)'
             || '                    AND g.sseguro = r.sseguro(+)'
             || '                    AND g.sseguro = s.sseguro'
             || '                    AND p.sproduc = s.sproduc'
             || '                    AND g.nmovimi = r.nmovimi(+)'
             || '                    GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, g.cgarant,'
             || '                    ''COBERAMO'')'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT SUM(NVL(icesion_moncon, icesion)) cedida,'
             || '                      pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                      g.cgarant, ''COBERAMO'') agrupacion'
             || '               FROM reaseguro r, cuadroces cc, garanseg g, seguros s, productos p'
             || '               WHERE r.cgenera <> 2'
             || '               AND r.fcierre BETWEEN ' || v_initrunc || '               AND '
             || v_fintrunc || '               AND r.cempres = ' || v_emp
             || '               AND r.ccompani = cc.ccompani'
             || '               AND r.scontra = cc.scontra'
             || '               AND r.nversio = cc.nversio'
             || '               AND r.ctramo = cc.ctramo'
             || '               AND preserv IS NOT NULL'
             || '               AND g.cgarant = r.cgarant(+)'
             || '               AND g.sseguro = r.sseguro(+)'
             || '               AND g.sseguro = s.sseguro'
             || '               AND p.sproduc = s.sproduc'
             || '               AND g.nmovimi = r.nmovimi(+)'
             || '               GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, g.cgarant,'
             || '               ''COBERAMO'')'
-------------------------
             || '               UNION'
-------------------------
             || '               SELECT   cedida, agrupacion'
             || '               FROM (SELECT SUM' || '                            (NVL'
             || '                             (((pac_eco_tipocambio.f_importe_cambio'
             || '                             ((SELECT cmonint'
             || '                               FROM monedas'
             || '                              WHERE cidioma = ' || v_idi
             || '                             AND cmoneda = pr.cdivisa),'
             || '                             ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                             r.femisio,' || '                             NVL'
             || '                             ((ce.icesion'
             || '                             * DECODE'
             || '                             (tr.ctramo,'
             || '                             1, DECODE'
             || '                             (SIGN((ce.icapces'
             || '                             * tr.plocal / 100)'
             || '                             - NVL(tr.imaxplo,'
             || '                             0)),'
             || '                             -1,(cc.pcesion'
             || '                             *(100'
             || '                             -((tr.plocal'
             || '                             * tr.imaxplo)'
             || '                             /((ce.icapces'
             || '                             * tr.plocal)'
             || '                             / 100))))'
             || '                             /(100 - tr.plocal),'
             || '                             cc.pcesion),'
             || '                             cc.pcesion)'
             || '                             / 100)'
             || '                             * rs.nfactor,'
             || '                             0),' || '                             1)'
             || '                             +(pac_eco_tipocambio.f_importe_cambio'
             || '                             ((SELECT cmonint'
             || '                               FROM monedas'
             || '                               WHERE cidioma = ' || v_idi
             || '                               AND cmoneda = pr.cdivisa),'
             || '                             ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                             r.femisio,' || '                             NVL'
             || '                             ((ce.icesion'
             || '                             * DECODE'
             || '                             (tr.ctramo,'
             || '                             1, DECODE'
             || '                             (SIGN((ce.icapces'
             || '                             * tr.plocal / 100)'
             || '                             - NVL(tr.imaxplo,'
             || '                             0)),'
             || '                             -1,(cc.pcesion'
             || '                             *(100'
             || '                             -((tr.plocal'
             || '                             * tr.imaxplo)'
             || '                             /((ce.icapces'
             || '                             * tr.plocal)'
             || '                             / 100))))'
             || '                             /(100 - tr.plocal),'
             || '                             cc.pcesion),'
             || '                             cc.pcesion)'
             || '                             * pac_propio.f_comi_ces'
             || '                             (cc.ccomrea,'
             || '                             s.sseguro,'
             || '                             ce.cgarant,'
             || '                             cc.pctcomis,'
             || '                             r.femisio)'
             || '                             / 10000)'
             || '                             * rs.nfactor,'
             || '                             0),' || '                             1)))'
             || '                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
             || '                             * DECODE(m.cestrec, 0, 1, -1)),'
             || '                             0)) cedida,'
             || '                             pac_parametros.f_pargaranpro_n(s.sproduc,'
             || '                             s.cactivi,'
             || '                             ce.cgarant,'
             || '                             ''COBERAMO'') agrupacion'
             || '                        FROM seguros s,'
             || '                             tramos tr,'
             || '                             recibos r,'
             || '                             cuadroces cc,'
             || '                             (SELECT icesion, icapces, ce.sseguro, ce.nversio,'
             || '                                     ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
             || '                                     ce.nmovimi, ce.scesrea'
             || '                                FROM cesionesrea ce, tramos tr'
             || '                               WHERE tr.scontra = ce.scontra'
             || '                               AND tr.nversio = ce.nversio'
             || '                               AND tr.ctramo = ce.ctramo'
             || '                               AND ce.fefecto <> ce.fvencim) ce,'
             || '                             movrecibo m,'
             || '                             reasegemi rs,'
             || '                             detreasegemi drs,'
             || '                             productos pr'
             || '                       WHERE cc.ctramo = tr.ctramo'
             || '                       AND rs.sreaemi = drs.sreaemi'
             || '                       AND drs.scesrea = ce.scesrea'
             || '                       AND drs.cgarant = ce.cgarant'
             || '                       AND s.sseguro = r.sseguro'
             || '                       AND m.nrecibo = r.nrecibo'
             || '                       AND cc.scontra = tr.scontra'
             || '                       AND cc.nversio = tr.nversio'
             || '                       AND tr.scontra = ce.scontra'
             || '                       AND tr.nversio = ce.nversio'
             || '                       AND tr.ctramo = ce.ctramo'
             || '                       AND s.sseguro = ce.sseguro'
             || '                       AND s.sseguro = rs.sseguro'
             || '                       AND m.nrecibo = rs.nrecibo'
             || '                       AND(((m.cestrec = 0'
             || '                       AND rs.cmotces = 1)'
             || '                       OR(m.cestrec = 2'
             || '                       AND m.cestant = 0'
             || '                       AND rs.cmotces = 2))'
             || '                       OR(((m.cestrec = 0'
             || '                       AND m.cestant = 1'
             || '                       AND rs.cmotces = 2)'
             || '                       OR(m.cestrec = 1'
             || '                       AND rs.cmotces = 1))'
             || '                       AND NOT EXISTS(SELECT 1'
             || '                                      FROM detmovrecibo dm'
             || '                                      WHERE dm.nrecibo = r.nrecibo)))'
             || '                       AND s.cramo = pr.cramo'
             || '                       AND s.cmodali = pr.cmodali'
             || '                       AND s.ctipseg = pr.ctipseg'
             || '                       AND s.ccolect = pr.ccolect'
             || '                       AND TRUNC(m.fmovdia) BETWEEN ' || v_ini
             || '                       AND ' || v_fin
             || '                       GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                       ce.cgarant, ''COBERAMO'')'
-------------------------
             || '                  UNION'
-------------------------
             || '                  SELECT SUM' || '                         (NVL'
             || '                         ((pac_eco_tipocambio.f_importe_cambio'
             || '                         ((SELECT cmonint'
             || '                           FROM monedas'
             || '                           WHERE cidioma = ' || v_idi
             || '                           AND cmoneda = pr.cdivisa),'
             || '                           ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                          r.femisio,' || '                          NVL'
             || '                          ((ce.icesion'
             || '                          * DECODE' || '                          (tr.ctramo,'
             || '                          1, DECODE'
             || '                          (SIGN((ce.icapces'
             || '                          * tr.plocal / 100)'
             || '                          - NVL(tr.imaxplo,'
             || '                          0)),' || '                          -1,(cc.pcesion'
             || '                          *(100' || '                          -((tr.plocal'
             || '                          * tr.imaxplo)'
             || '                          /((ce.icapces'
             || '                          * tr.plocal)'
             || '                          / 100))))'
             || '                          /(100 - tr.plocal),'
             || '                          cc.pcesion),'
             || '                          cc.pcesion)' || '                          / 100)'
             || '                          * rs.nfactor,' || '                          0),'
             || '                          1)'
             || '                          +(pac_eco_tipocambio.f_importe_cambio'
             || '                          ((SELECT cmonint'
             || '                            FROM monedas'
             || '                            WHERE cidioma = ' || v_idi
             || '                            AND cmoneda = pr.cdivisa),'
             || '                          ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                          r.femisio,' || '                          NVL'
             || '                          ((ce.icesion'
             || '                          * DECODE' || '                          (tr.ctramo,'
             || '                          1, DECODE'
             || '                          (SIGN((ce.icapces'
             || '                          * tr.plocal / 100)'
             || '                          - NVL(tr.imaxplo,'
             || '                          0)),' || '                          -1,(cc.pcesion'
             || '                          *(100' || '                          -((tr.plocal'
             || '                          * tr.imaxplo)'
             || '                          /((ce.icapces'
             || '                          * tr.plocal)'
             || '                          / 100))))'
             || '                          /(100 - tr.plocal),'
             || '                          cc.pcesion),'
             || '                          cc.pcesion)'
             || '                          * pac_propio.f_comi_ces'
             || '                          (cc.ccomrea,'
             || '                          s.sseguro,'
             || '                          ce.cgarant,'
             || '                          cc.pcomisi,'
             || '                          r.femisio)' || '                          / 10000)'
             || '                          * rs.nfactor,' || '                          0),'
             || '                          1)))'
             || '                          * DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
             || '                          * DECODE(m.cestrec, 0, 1, -1),'
             || '                          0)) cedida,'
             || '                          pac_parametros.f_pargaranpro_n(s.sproduc,'
             || '                          s.cactivi,'
             || '                          ce.cgarant,'
             || '                          ''COBERAMO'') agrupacion'
             || '                  FROM seguros s,' || '                       tramos tr,'
             || '                       recibos r,' || '                       cuacesfac cc,'
             || '                       (SELECT icesion, icapces, ce.sseguro, ce.nversio,'
             || '                               ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
             || '                               ce.nmovimi, ce.scesrea'
             || '                        FROM cesionesrea ce, tramos tr'
             || '                        WHERE tr.scontra = ce.scontra'
             || '                        AND tr.nversio = ce.nversio'
             || '                        AND tr.ctramo = ce.ctramo'
             || '                        AND ce.fefecto <> ce.fvencim) ce,'
             || '                        movrecibo m,'
             || '                        reasegemi rs,'
             || '                        detreasegemi drs,'
             || '                        productos pr'
             || '                  WHERE m.nrecibo = r.nrecibo'
             || '                  AND cc.sfacult = ce.sfacult'
             || '                  AND tr.scontra = ce.scontra'
             || '                  AND tr.nversio = ce.nversio'
             || '                  AND tr.ctramo = ce.ctramo'
             || '                  AND rs.sreaemi = drs.sreaemi'
             || '                  AND drs.scesrea = ce.scesrea'
             || '                  AND drs.cgarant = ce.cgarant'
             || '                  AND s.sseguro = r.sseguro'
             || '                  AND s.sseguro = ce.sseguro'
             || '                  AND s.sseguro = rs.sseguro'
             || '                  AND m.nrecibo = rs.nrecibo'
             || '                  AND(((m.cestrec = 0'
             || '                  AND rs.cmotces = 1)' || '                  OR(m.cestrec = 2'
             || '                  AND m.cestant = 0'
             || '                  AND rs.cmotces = 2))'
             || '                  OR(((m.cestrec = 0' || '                  AND m.cestant = 1'
             || '                  AND rs.cmotces = 2)' || '                  OR(m.cestrec = 1'
             || '                  AND rs.cmotces = 1))'
             || '                  AND NOT EXISTS(SELECT 1'
             || '                                 FROM detmovrecibo dm'
             || '                                 WHERE dm.nrecibo = r.nrecibo)))'
             || '                  AND s.cramo = pr.cramo'
             || '                  AND s.cmodali = pr.cmodali'
             || '                  AND s.ctipseg = pr.ctipseg'
             || '                  AND s.ccolect = pr.ccolect'
             || '                  AND TRUNC(m.fmovdia) BETWEEN ' || v_ini
             || '                  AND ' || v_fin
             || '                 GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                  ce.cgarant, ''COBERAMO'')'
-------------------------
             || '                  UNION'
-------------------------
             || '                  SELECT SUM' || '                         (NVL'
             || '                         ((pac_eco_tipocambio.f_importe_cambio'
             || '                         ((SELECT cmonint'
             || '                            FROM monedas'
             || '                            WHERE cidioma = ' || v_idi
             || '                            AND cmoneda = pr.cdivisa),'
             || '                          ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                          r.femisio,' || '                          NVL'
             || '                          ((ce.icesion'
             || '                          * DECODE' || '                          (tr.ctramo,'
             || '                          1, DECODE'
             || '                          (SIGN((ce.icapces'
             || '                          * tr.plocal / 100)'
             || '                          - NVL(tr.imaxplo,'
             || '                          0)),' || '                          -1,(cc.pcesion'
             || '                          *(100' || '                          -((tr.plocal'
             || '                          * tr.imaxplo)'
             || '                          /((ce.icapces'
             || '                          * tr.plocal)'
             || '                          / 100))))'
             || '                          /(100 - tr.plocal),'
             || '                          cc.pcesion),'
             || '                          cc.pcesion)' || '                          / 100)'
             || '                          * rs.nfactor,' || '                          0),'
             || '                          1)'
             || '                          +(pac_eco_tipocambio.f_importe_cambio'
             || '                          ((SELECT cmonint'
             || '                             FROM monedas'
             || '                             WHERE cidioma = ' || v_idi
             || '                             AND cmoneda = pr.cdivisa),'
             || '                          ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                           r.femisio,' || '                           NVL'
             || '                           ((ce.icesion'
             || '                           * DECODE'
             || '                           (tr.ctramo,'
             || '                            1, DECODE'
             || '                          (SIGN((ce.icapces'
             || '                          * tr.plocal / 100)'
             || '                          - NVL(tr.imaxplo,'
             || '                          0)),' || '                          -1,(cc.pcesion'
             || '                          *(100' || '                          -((tr.plocal'
             || '                          * tr.imaxplo)'
             || '                          /((ce.icapces'
             || '                          * tr.plocal)'
             || '                          / 100))))'
             || '                          /(100 - tr.plocal),'
             || '                          cc.pcesion),'
             || '                          cc.pcesion)'
             || '                          * pac_propio.f_comi_ces'
             || '                          (cc.ccomrea,'
             || '                          s.sseguro,'
             || '                          ce.cgarant,'
             || '                          cc.pctcomis,'
             || '                          r.femisio)' || '                          / 10000)'
             || '                          * rs.nfactor,' || '                          0),'
             || '                          1)))'
             || '                          * DECODE(r.ctiprec, 9, -1, 13, -1, 1),'
             || '                          0))' || '                          *(-1) cedida,'
             || '                          pac_parametros.f_pargaranpro_n(s.sproduc,'
             || '                          s.cactivi,'
             || '                          ce.cgarant,'
             || '                          ''COBERAMO'') agrupacion'
             || '                  FROM seguros s,' || '                       tramos tr,'
             || '                       recibos r,' || '                       cuadroces cc,'
             || '                       (SELECT icesion, icapces, ce.sseguro, ce.nversio,'
             || '                               ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
             || '                               ce.nmovimi, ce.scesrea'
             || '                         FROM cesionesrea ce, tramos tr'
             || '                         WHERE tr.scontra = ce.scontra'
             || '                         AND tr.nversio = ce.nversio'
             || '                         AND tr.ctramo = ce.ctramo'
             || '                         AND ce.fefecto <> ce.fvencim) ce,'
             || '                        detmovrecibo dv,'
             || '                        reasegemi rs,'
             || '                        detreasegemi drs,'
             || '                        productos pr,'
             || '                        movrecibo m'
             || '                  WHERE dv.nrecibo = r.nrecibo'
             || '                  AND m.nrecibo = r.nrecibo'
             || '                  AND m.smovrec = dv.smovrec'
             || '                   AND dv.norden = 1'
             || '                   AND cc.ctramo = tr.ctramo'
             || '                   AND dv.nrecibo = rs.nrecibo'
             || '                   AND rs.cmotces = 1'
             || '                   AND cc.scontra = tr.scontra'
             || '                   AND cc.nversio = tr.nversio'
             || '                   AND tr.scontra = ce.scontra'
             || '                   AND tr.nversio = ce.nversio'
             || '                   AND tr.ctramo = ce.ctramo'
             || '                   AND s.sseguro = ce.sseguro'
             || '                   AND s.sseguro = rs.sseguro'
             || '                   AND s.cramo = pr.cramo'
             || '                   AND s.cmodali = pr.cmodali'
             || '                   AND s.ctipseg = pr.ctipseg'
             || '                   AND s.ccolect = pr.ccolect'
             || '                   AND rs.sreaemi = drs.sreaemi'
             || '                   AND drs.scesrea = ce.scesrea'
             || '                   AND drs.cgarant = ce.cgarant'
             || '                   AND s.sseguro = r.sseguro'
             || '                   AND TRUNC(dv.fmovimi) BETWEEN ' || v_ini
             || '                   AND ' || v_fin
             || '                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                   ce.cgarant, ''COBERAMO'')'
-------------------------
             || '                  UNION'
-------------------------
             || '                  SELECT SUM' || '                        (NVL'
             || '                        ((pac_eco_tipocambio.f_importe_cambio'
             || '                        ((SELECT cmonint'
             || '                           FROM monedas'
             || '                           WHERE cidioma = ' || v_idi
             || '                           AND cmoneda = pr.cdivisa),'
             || '                         ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                         r.femisio,' || '                         NVL'
             || '                         ((ce.icesion' || '                         * DECODE'
             || '                         (tr.ctramo,' || '                         1, DECODE'
             || '                         (SIGN((ce.icapces'
             || '                         * tr.plocal / 100)'
             || '                         - NVL(tr.imaxplo,' || '                         0)),'
             || '                         -1,(cc.pcesion' || '                         *(100'
             || '                         -((tr.plocal'
             || '                         * tr.imaxplo)'
             || '                         /((ce.icapces'
             || '                         * tr.plocal)' || '                         / 100))))'
             || '                         /(100 - tr.plocal),'
             || '                         cc.pcesion),'
             || '                         cc.pcesion)' || '                         / 100)'
             || '                         * rs.nfactor,' || '                         0),'
             || '                         1)'
             || '                         +(pac_eco_tipocambio.f_importe_cambio'
             || '                         ((SELECT cmonint'
             || '                           FROM monedas'
             || '                           WHERE cidioma = ' || v_idi
             || '                           AND cmoneda = pr.cdivisa),'
             || '                         ' || CHR(39) || v_tmoneda || CHR(39) || ','
             || '                         r.femisio,' || '                         NVL'
             || '                         ((ce.icesion' || '                         * DECODE'
             || '                         (tr.ctramo,' || '                         1, DECODE'
             || '                         (SIGN((ce.icapces'
             || '                         * tr.plocal / 100)'
             || '                         - NVL(tr.imaxplo,' || '                         0)),'
             || '                         -1,(cc.pcesion' || '                         *(100'
             || '                         -((tr.plocal'
             || '                         * tr.imaxplo)'
             || '                         /((ce.icapces'
             || '                         * tr.plocal)' || '                         / 100))))'
             || '                         /(100 - tr.plocal),'
             || '                         cc.pcesion),'
             || '                         cc.pcesion)'
             || '                         * pac_propio.f_comi_ces'
             || '                         (cc.ccomrea,'
             || '                         s.sseguro,' || '                         ce.cgarant,'
             || '                         cc.pcomisi,' || '                         r.femisio)'
             || '                         / 10000)' || '                         * rs.nfactor,'
             || '                         0),' || '                         1)))'
             || '                         * DECODE(r.ctiprec, 9, -1, 13, -1, 1),'
             || '                         0))' || '                         *(-1) cedida,'
             || '                         pac_parametros.f_pargaranpro_n(s.sproduc,'
             || '                         s.cactivi,' || '                         ce.cgarant,'
             || '                         ''COBERAMO'') agrupacion'
             || '                    FROM seguros s,' || '                         tramos tr,'
             || '                         recibos r,'
             || '                         cuacesfac cc,'
             || '                         (SELECT icesion, icapces, ce.sseguro, ce.nversio,'
             || '                                 ce.ctramo, ce.scontra, ce.cgarant, ce.sfacult,'
             || '                                 ce.nmovimi, ce.scesrea'
             || '                          FROM cesionesrea ce, tramos tr'
             || '                         WHERE tr.scontra = ce.scontra'
             || '                         AND tr.nversio = ce.nversio'
             || '                         AND tr.ctramo = ce.ctramo'
             || '                         AND ce.fefecto <> ce.fvencim) ce,'
             || '                         detmovrecibo dv,'
             || '                         reasegemi rs,'
             || '                         detreasegemi drs,'
             || '                         productos pr,'
             || '                         movrecibo m'
             || '                   WHERE dv.nrecibo = r.nrecibo'
             || '                   AND m.nrecibo = r.nrecibo'
             || '                   AND m.smovrec = dv.smovrec'
             || '                   AND dv.norden = 1'
             || '                   AND dv.nrecibo = rs.nrecibo'
             || '                   AND rs.cmotces = 1'
             || '                   AND cc.sfacult = ce.sfacult'
             || '                   AND tr.scontra = ce.scontra'
             || '                   AND tr.nversio = ce.nversio'
             || '                   AND tr.ctramo = ce.ctramo'
             || '                   AND s.sseguro = ce.sseguro'
             || '                   AND s.sseguro = rs.sseguro'
             || '                   AND s.cramo = pr.cramo'
             || '                   AND s.cmodali = pr.cmodali'
             || '                   AND s.ctipseg = pr.ctipseg'
             || '                   AND s.ccolect = pr.ccolect'
             || '                   AND rs.sreaemi = drs.sreaemi'
             || '                   AND drs.scesrea = ce.scesrea'
             || '                   AND drs.cgarant = ce.cgarant'
             || '                   AND s.sseguro = r.sseguro'
             || '                   AND TRUNC(dv.fmovimi) BETWEEN ' || v_ini
             || '                   AND ' || v_fin
             || '                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,'
             || '                   ce.cgarant, ''COBERAMO''))'
             || '                   ORDER BY agrupacion)' || '           GROUP BY agrupacion)'
             || '           GROUP BY NVL(pac_parametros.f_descdetparam(''COBERAMO'', agrupacion, 3),'
             || '           f_axis_literales(110031, 3))',
             '       ', ' ');
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_709_det;

   -- BUG 26430 - FAL - 17/06/2013
   FUNCTION f_get_dif_resriesgo_curso(phasta IN DATE, pcidioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_resriesgo_curso';
      v_tparam       VARCHAR2(100) := 'phasta:' || phasta;
      v_ttexto       VARCHAR2(5000) := '';
      v_ntraza       NUMBER := 0;
      vimpore        NUMBER := 0;
      vimpore2       NUMBER := 0;
      vimpore_ant    NUMBER := 0;
      vimpore2_ant   NUMBER := 0;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      vmaxrrc        rrc_sam.sproces%TYPE;
      vmaxrrcrea     rrc_sam.sproces%TYPE;
      vmaxrrcant     rrc_sam.sproces%TYPE;
      vmaxrrcreaant  rrc_sam.sproces%TYPE;
   BEGIN
      SELECT TO_NUMBER(TO_CHAR(phasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(phasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(phasta)
           INTO vhasta
           FROM DUAL;
      ELSE
         vhasta := phasta;
      END IF;

      -- Bug 26430 - 18/10/2013 - JMF
      SELECT MAX(sproces)
        INTO vmaxrrc
        FROM rrc_sam p2
       WHERE p2.fcalcul = vhasta;

      SELECT MAX(sproces)
        INTO vmaxrrcrea
        FROM rrc_rea_sam p2
       WHERE p2.fcalcul = vhasta;

      SELECT MAX(sproces)
        INTO vmaxrrcant
        FROM rrc_sam p2
       WHERE p2.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY');

      SELECT MAX(sproces)
        INTO vmaxrrcreaant
        FROM rrc_rea_sam p2
       WHERE p2.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY');

      -- Bug 26430 - 18/10/2013 - JMF
      FOR cur IN (SELECT DISTINCT (p.cvalpar) cvalpar
                             FROM pargaranpro p
                            WHERE p.cpargar = 'RAMOFECU'
                         ORDER BY cvalpar) LOOP
         SELECT SUM(NVL(iprirrc_moncon, 0)) iprirrc_moncon
           INTO vimpore
           FROM rrc_sam p, procesoscab s1, procesoscab s2, pargaranpro pa
          WHERE p.sproces = s1.sproces
            AND s2.sproces = vmaxrrc
            AND p.sproces = vmaxrrc
            AND p.fcalcul = vhasta
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc;

         SELECT SUM(NVL(iprrcrc_moncon, 0)) iprrcrc_moncon
           INTO vimpore2
           FROM rrc_rea_sam p, procesoscab s1, procesoscab s2, pargaranpro pa
          WHERE p.sproces = s1.sproces
            AND s2.sproces = vmaxrrcrea
            AND p.sproces = vmaxrrcrea
            AND p.fcalcul = vhasta
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc;

         SELECT SUM(NVL(iprirrc_moncon, 0)) iprirrc_moncon
           INTO vimpore_ant
           FROM rrc_sam p, procesoscab s1, procesoscab s2, pargaranpro pa
          WHERE p.sproces = s1.sproces
            AND s2.sproces = vmaxrrcant
            AND p.sproces = vmaxrrcant
            AND p.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY')
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc;

         SELECT SUM(NVL(iprrcrc_moncon, 0)) iprrcrc_moncon
           INTO vimpore2_ant
           FROM rrc_rea_sam p, procesoscab s1, procesoscab s2, pargaranpro pa
          WHERE p.sproces = s1.sproces
            AND s2.sproces = vmaxrrcreaant
            AND p.sproces = vmaxrrcreaant
            AND p.fcalcul = TO_DATE('31/12/' ||(TO_CHAR(phasta, 'YYYY') - 1), 'DD/MM/YYYY')
            AND pa.cpargar = 'RAMOFECU'
            AND pa.cvalpar = cur.cvalpar
            AND p.cgarant = pa.cgarant
            AND p.sproduc = pa.sproduc;

         v_ttexto := v_ttexto
                     ||((NVL(vimpore, 0) - NVL(vimpore_ant, 0))
                        -(NVL(vimpore2, 0) - NVL(vimpore2_ant, 0)))
                     || ';';
      END LOOP;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_get_dif_resriesgo_curso;

-- FI BUG 26430 - FAL - 17/06/2013
   FUNCTION f_caracter(p_txt IN VARCHAR2)
      RETURN VARCHAR2 IS
      -- Solo para generar ficheros superintendencia FECU
      v_txt          VARCHAR2(2000);
      v_car          VARCHAR2(1);
   BEGIN
      v_txt := NVL(p_txt, ' ');
      v_txt := REPLACE(v_txt, 'á', 'a');
      v_txt := REPLACE(v_txt, 'Á', 'A');
      v_txt := REPLACE(v_txt, 'é', 'e');
      v_txt := REPLACE(v_txt, 'É', 'E');
      v_txt := REPLACE(v_txt, 'í', 'i');
      v_txt := REPLACE(v_txt, 'Í', 'I');
      v_txt := REPLACE(v_txt, 'ó', 'o');
      v_txt := REPLACE(v_txt, 'Ó', 'O');
      v_txt := REPLACE(v_txt, 'ú', 'u');
      v_txt := REPLACE(v_txt, 'Ú', 'U');

      FOR i IN 1 .. LENGTH(v_txt) LOOP
         v_car := SUBSTR(v_txt, i, 1);

         IF ASCII(v_car) IN(209, 241, 32) THEN
            NULL;   -- son ñ y N y espacio blanco
         ELSIF ASCII(v_car) >= 48
               AND ASCII(v_car) <= 57 THEN
            NULL;   -- numeros
         ELSIF ASCII(v_car) >= 97
               AND ASCII(v_car) <= 122 THEN
            NULL;   -- minusculas
         ELSIF ASCII(v_car) >= 65
               AND ASCII(v_car) <= 90 THEN
            NULL;   -- mayusculas
         ELSE
            v_txt := REPLACE(v_txt, v_car, '');
         END IF;
      END LOOP;

      v_txt := REPLACE(v_txt, 'ñ', '#');
      v_txt := REPLACE(v_txt, 'Ñ', '#');
      RETURN v_txt;
   END;

   FUNCTION f_numero(p_txt IN VARCHAR2)
      RETURN VARCHAR2 IS
      -- Solo para generar ficheros superintendencia FECU
      v_txt          VARCHAR2(2000);
   BEGIN
      SELECT TRUNC(TO_NUMBER(p_txt))
        INTO v_txt
        FROM DUAL;

      RETURN v_txt;
   END;

   FUNCTION p_format(p_txt IN VARCHAR2, p_lon IN NUMBER, p_tip IN NUMBER)
      RETURN VARCHAR2 IS
   -- Solo para generar ficheros superintendencia FECU
   BEGIN
      IF p_tip = 0 THEN
         -- filler
         RETURN REPLACE(LPAD('.', p_lon, ' '), '.', ' ');
      ELSIF p_tip = 1 THEN
         -- Numerico
         IF INSTR(p_txt, '-') > 0 THEN
            -- negativo
            RETURN '-'
                   || SUBSTR(LPAD(NVL(REPLACE(f_numero(p_txt), '-', ''), '0'), p_lon, '0'), 1,
                             p_lon);
         ELSE
            -- positivo
            RETURN ' ' || SUBSTR(LPAD(NVL(f_numero(p_txt), '0'), p_lon, '0'), 1, p_lon);
         END IF;
      ELSIF p_tip = 3 THEN
         -- Numerico sin signo
         RETURN SUBSTR(LPAD(NVL(f_numero(p_txt), '0'), p_lon, '0'), 1, p_lon);
      ELSE
         -- Caracter
         RETURN SUBSTR(RPAD(NVL(f_caracter(p_txt), ' '), p_lon, ' '), 1, p_lon);
      END IF;
   END;

   PROCEDURE p_751_produccion(
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_desfic IN OUT VARCHAR2) IS
      --
      vsfile3        UTL_FILE.file_type;
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.p_751_produccion';
      v_tparam       VARCHAR2(100)
                            := 'fecha_desde=' || fecha_desde || ' fecha_hasta=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_erride       VARCHAR2(100);   -- Para identifciar clave si tenemos error
      lpath          VARCHAR2(999);
      d_ini          DATE;
      d_fin          DATE;
      v_fin2         VARCHAR2(10);
      v_fin4         VARCHAR2(10);
      --v_emp          NUMBER;
      v_rut          VARCHAR2(100);
      v_ver          VARCHAR2(100);
      v_nom          VARCHAR2(500);
      v_tip          VARCHAR2(10);
      v_totase       NUMBER;
      v_totnet       NUMBER;
      v_totcom       NUMBER;
      v_totreg       NUMBER;
      v_net_ram      NUMBER;

      CURSOR c1 IS
         SELECT   a.cagente, COUNT(DISTINCT ri.sperson) numase, MAX(c.sperson) sperson,
                  COUNT(DISTINCT(TO_CHAR(m.femisio, 'mm'))) mesprod
             FROM seguros a, asegurados b, agentes c, agentes_comp d, riesgos ri, movseguro m
            WHERE a.cempres = v_emp
              AND b.sseguro = a.sseguro
              AND c.cagente = a.cagente
              AND d.cagente = c.cagente
              AND pac_propio.f_agentecorredor(d.ctipint) = 1
              AND ri.sseguro = a.sseguro
              AND m.sseguro = a.sseguro
              AND m.femisio BETWEEN d_ini AND d_fin
              AND m.cmotmov = 100
              AND EXISTS(SELECT 1
                           FROM recibos
                          WHERE sseguro = a.sseguro)
         GROUP BY a.cagente;

      CURSOR c2(pc_age IN NUMBER) IS
         SELECT ROUND(SUM(net)) net, ROUND(SUM(com)) com
           FROM (SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, 1, -1)
                            * DECODE(d.cconcep, 0, d.iconcep_monpol, 0))
                        / 1000 net,
                        SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, 1, -1)
                            * DECODE(d.cconcep, 11, d.iconcep_monpol, 0))
                        / 1000 com
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        monedas mon,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE r.cempres = v_emp
                    AND r.cagente = pc_age
                    AND p.sproduc = s.sproduc
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND d.nrecibo = r.nrecibo
                    AND cal.cagente = s.cagente
                    AND d.cconcep IN(0, 11)
                    AND m.nrecibo = r.nrecibo
                    AND((m.cestant = 0
                         AND m.cestrec IN(0, 2))
                        OR((m.cestrec = 1)
                           OR(m.cestrec = 0
                              AND m.cestant = 1)))
                    AND m.fmovdia BETWEEN d_ini AND d_fin
                    AND mon.cidioma = 3
                    AND mon.cmoneda = p.cdivisa
                 UNION
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * pac_eco_tipocambio.f_importe_cambio(mon.cmonint, 'CLP',
                                                                  cc.fcambio,
                                                                  DECODE(d.cconcep,
                                                                         0, d.iconcep,
                                                                         0),
                                                                  1)
                            * DECODE(m.cestrec, 1, 1, -1))
                        / 1000 net,
                        SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * pac_eco_tipocambio.f_importe_cambio(mon.cmonint, 'CLP',
                                                                  cc.fcambio,
                                                                  DECODE(d.cconcep,
                                                                         11, d.iconcep,
                                                                         0),
                                                                  1)
                            * DECODE(m.cestrec, 1, 1, -1))
                        / 1000 com
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        ctacliente cc,
                        monedas mon,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE r.cempres = v_emp
                    AND r.cagente = pc_age
                    AND m.fmovdia BETWEEN d_ini AND d_fin
                    AND s.sproduc = p.sproduc
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND s.sseguro = r.sseguro
                    AND r.nrecibo = d.nrecibo
                    AND m.nrecibo = r.nrecibo
                    AND((m.cestrec = 1)
                        OR(m.cestrec = 0
                           AND m.cestant = 1))
                    AND r.cestaux = 0
                    AND cal.cagente = s.cagente
                    AND d.cconcep IN(0, 11)
                    AND d.nrecibo = m.nrecibo
                    AND NOT EXISTS(SELECT 1
                                     FROM detmovrecibo d1
                                    WHERE d1.nrecibo = r.nrecibo)
                    AND p.sproduc = s.sproduc
                    AND mon.cidioma = 3
                    AND mon.cmoneda = p.cdivisa
                    AND cc.nrecibo = m.nrecibo
                    AND cc.ffecmov = TRUNC(m.fmovdia)
                    AND cc.cmovimi IN(2, 5)
                 UNION
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(dmp.cconcep, 0, dmp.iconcep_monpol, 0))
                        / 1000 net,
                        SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(dmp.cconcep, 11, dmp.iconcep_monpol, 0))
                        / 1000 com
                   FROM seguros s,
                        recibos r,
                        productos p,
                        movrecibo mr,
                        detmovrecibo_parcial dmp,
                        detmovrecibo dm,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE r.cempres = v_emp
                    AND r.cagente = pc_age
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND p.sproduc = s.sproduc
                    AND mr.nrecibo = r.nrecibo
                    AND dm.fmovimi BETWEEN d_ini AND d_fin
                    AND dm.nrecibo = dmp.nrecibo
                    AND dm.norden = dmp.norden
                    AND dmp.smovrec = mr.smovrec
                    AND cal.cagente = s.cagente
                    AND dmp.cconcep IN(0, 11)
                 UNION
                 SELECT SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, -1, 1)
                            * DECODE(d.cconcep, 0, d.iconcep_monpol, 0))
                        / 1000 net,
                        SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                            * DECODE(m.cestrec, 0, -1, 1)
                            * DECODE(d.cconcep, 11, d.iconcep_monpol, 0))
                        / 1000 com
                   FROM seguros s,
                        detrecibos d,
                        movrecibo m,
                        recibos r,
                        productos p,
                        monedas mon,
                        detmovrecibo dm,
                        detmovrecibo_parcial dmp,
                        (SELECT   ac.cagente,
                                  pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                             FROM agentes_comp ac
                         GROUP BY ac.cagente) cal
                  WHERE r.cempres = v_emp
                    AND r.cagente = pc_age
                    AND p.sproduc = s.sproduc
                    AND r.sseguro = s.sseguro
                    AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                    AND r.cestaux = 0
                    AND d.nrecibo = r.nrecibo
                    AND cal.cagente = s.cagente
                    AND d.cconcep IN(0, 11)
                    AND m.nrecibo = r.nrecibo
                    AND(m.cestant = 0
                        AND m.cestrec IN(0))
                    AND dm.fmovimi BETWEEN d_ini AND d_fin
                    AND dm.nrecibo = dmp.nrecibo
                    AND dm.norden = 1
                    AND dm.norden = dmp.norden
                    AND dmp.smovrec = m.smovrec
                    AND dmp.cconcep = d.cconcep
                    AND dmp.cgarant = d.cgarant
                    AND mon.cidioma = 3
                    AND mon.cmoneda = p.cdivisa);

      CURSOR c3(pc_age IN NUMBER) IS
         SELECT   ROUND(SUM(net)) net, fecu, afec
             FROM (SELECT   SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * DECODE(m.cestrec, 0, 1, -1)
                                * DECODE(d.cconcep, 0, d.iconcep_monpol, 0))
                            / 1000 net,
                            pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,
                                                           d.cgarant, 'RAMOFECU') fecu,
                            k.afec afec
                       FROM seguros s,
                            (SELECT NVL(NVL((SELECT 3
                                               FROM mig_post m
                                              WHERE m.sproduc = s.sproduc),
                                            (SELECT 1
                                               FROM productos p
                                              WHERE p.sproduc = s.sproduc
                                                AND csubpro NOT IN(2, 3))),
                                        2) afec,
                                    s.sproduc
                               FROM productos s) k,
                            detrecibos d,
                            movrecibo m,
                            recibos r,
                            productos p,
                            monedas mon,
                            (SELECT   ac.cagente,
                                      pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                                 FROM agentes_comp ac
                             GROUP BY ac.cagente) cal
                      WHERE r.cempres = v_emp
                        AND r.cagente = pc_age
                        AND k.sproduc = s.sproduc
                        AND p.sproduc = s.sproduc
                        AND r.sseguro = s.sseguro
                        AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                        AND r.cestaux = 0
                        AND d.nrecibo = r.nrecibo
                        AND cal.cagente = s.cagente
                        AND d.cconcep IN(0, 11)
                        AND m.nrecibo = r.nrecibo
                        AND((m.cestant = 0
                             AND m.cestrec IN(0, 2))
                            OR((m.cestrec = 1)
                               OR(m.cestrec = 0
                                  AND m.cestant = 1)))
                        AND m.fmovdia BETWEEN d_ini AND d_fin
                        AND mon.cidioma = 3
                        AND mon.cmoneda = p.cdivisa
                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,
                                                           'RAMOFECU'),
                            k.afec
                   UNION
                   SELECT   SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * pac_eco_tipocambio.f_importe_cambio(mon.cmonint, 'CLP',
                                                                      cc.fcambio,
                                                                      DECODE(d.cconcep,
                                                                             0, d.iconcep,
                                                                             0),
                                                                      1)
                                * DECODE(m.cestrec, 1, 1, -1))
                            / 1000 net,
                            pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,
                                                           d.cgarant, 'RAMOFECU') fecu,
                            k.afec afec
                       FROM seguros s,
                            (SELECT NVL(NVL((SELECT 3
                                               FROM mig_post m
                                              WHERE m.sproduc = s.sproduc),
                                            (SELECT 1
                                               FROM productos p
                                              WHERE p.sproduc = s.sproduc
                                                AND csubpro NOT IN(2, 3))),
                                        2) afec,
                                    s.sproduc
                               FROM productos s) k,
                            detrecibos d,
                            movrecibo m,
                            recibos r,
                            productos p,
                            ctacliente cc,
                            monedas mon,
                            (SELECT   ac.cagente,
                                      pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                                 FROM agentes_comp ac
                             GROUP BY ac.cagente) cal
                      WHERE r.cempres = v_emp
                        AND r.cagente = pc_age
                        AND k.sproduc = s.sproduc
                        AND m.fmovdia BETWEEN d_ini AND d_fin
                        AND s.sproduc = p.sproduc
                        AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                        AND s.sseguro = r.sseguro
                        AND r.nrecibo = d.nrecibo
                        AND m.nrecibo = r.nrecibo
                        AND((m.cestrec = 1)
                            OR(m.cestrec = 0
                               AND m.cestant = 1))
                        AND r.cestaux = 0
                        AND cal.cagente = s.cagente
                        AND d.cconcep IN(0, 11)
                        AND d.nrecibo = m.nrecibo
                        AND NOT EXISTS(SELECT 1
                                         FROM detmovrecibo d1
                                        WHERE d1.nrecibo = r.nrecibo)
                        AND p.sproduc = s.sproduc
                        AND mon.cidioma = 3
                        AND mon.cmoneda = p.cdivisa
                        AND cc.nrecibo = m.nrecibo
                        AND cc.ffecmov = TRUNC(m.fmovdia)
                        AND cc.cmovimi IN(2, 5)
                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,
                                                           'RAMOFECU'),
                            k.afec
                   UNION
                   SELECT   SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * DECODE(dmp.cconcep, 0, dmp.iconcep_monpol, 0))
                            / 1000 net,
                            pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,
                                                           dmp.cgarant, 'RAMOFECU') fecu,
                            k.afec afec
                       FROM seguros s,
                            (SELECT NVL(NVL((SELECT 3
                                               FROM mig_post m
                                              WHERE m.sproduc = s.sproduc),
                                            (SELECT 1
                                               FROM productos p
                                              WHERE p.sproduc = s.sproduc
                                                AND csubpro NOT IN(2, 3))),
                                        2) afec,
                                    s.sproduc
                               FROM productos s) k,
                            recibos r,
                            productos p,
                            movrecibo mr,
                            detmovrecibo_parcial dmp,
                            detmovrecibo dm,
                            (SELECT   ac.cagente,
                                      pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                                 FROM agentes_comp ac
                             GROUP BY ac.cagente) cal
                      WHERE r.cempres = v_emp
                        AND r.cagente = pc_age
                        AND k.sproduc = s.sproduc
                        AND r.sseguro = s.sseguro
                        AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                        AND r.cestaux = 0
                        AND p.sproduc = s.sproduc
                        AND mr.nrecibo = r.nrecibo
                        AND dm.fmovimi BETWEEN d_ini AND d_fin
                        AND dm.nrecibo = dmp.nrecibo
                        AND dm.norden = dmp.norden
                        AND dmp.smovrec = mr.smovrec
                        AND cal.cagente = s.cagente
                        AND dmp.cconcep IN(0, 11)
                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, dmp.cgarant,
                                                           'RAMOFECU'),
                            k.afec
                   UNION
                   SELECT   SUM(DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                                * DECODE(m.cestrec, 0, -1, 1)
                                * DECODE(d.cconcep, 0, d.iconcep_monpol, 0))
                            / 1000 net,
                            pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi,
                                                           d.cgarant, 'RAMOFECU') fecu,
                            k.afec afec
                       FROM seguros s,
                            (SELECT NVL(NVL((SELECT 3
                                               FROM mig_post m
                                              WHERE m.sproduc = s.sproduc),
                                            (SELECT 1
                                               FROM productos p
                                              WHERE p.sproduc = s.sproduc
                                                AND csubpro NOT IN(2, 3))),
                                        2) afec,
                                    s.sproduc
                               FROM productos s) k,
                            detrecibos d,
                            movrecibo m,
                            recibos r,
                            productos p,
                            monedas mon,
                            detmovrecibo dm,
                            detmovrecibo_parcial dmp,
                            (SELECT   ac.cagente,
                                      pac_propio.f_agentecorredor(MAX(ac.ctipint)) tipint
                                 FROM agentes_comp ac
                             GROUP BY ac.cagente) cal
                      WHERE r.cempres = v_emp
                        AND r.cagente = pc_age
                        AND k.sproduc = s.sproduc
                        AND p.sproduc = s.sproduc
                        AND r.sseguro = s.sseguro
                        AND r.ctiprec IN(0, 1, 3, 9, 13, 15)
                        AND r.cestaux = 0
                        AND d.nrecibo = r.nrecibo
                        AND cal.cagente = s.cagente
                        AND d.cconcep IN(0, 11)
                        AND m.nrecibo = r.nrecibo
                        AND(m.cestant = 0
                            AND m.cestrec IN(0))
                        AND dm.fmovimi BETWEEN d_ini AND d_fin
                        AND dm.nrecibo = dmp.nrecibo
                        AND dm.norden = 1
                        AND dm.norden = dmp.norden
                        AND dmp.smovrec = m.smovrec
                        AND dmp.cconcep = d.cconcep
                        AND dmp.cgarant = d.cgarant
                        AND mon.cidioma = 3
                        AND mon.cmoneda = p.cdivisa
                   GROUP BY pac_parametros.f_pargaranpro_n(s.sproduc, s.cactivi, d.cgarant,
                                                           'RAMOFECU'),
                            k.afec)
         GROUP BY fecu, afec;

      PROCEDURE p_linea(p_txt IN VARCHAR2) IS
      BEGIN
         UTL_FILE.put_line(vsfile3, p_txt);
      END;
   BEGIN
      v_ntraza := 1000;
      v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 1010;
      d_ini := TO_DATE(fecha_desde || '000000', 'DDMMYYYYHH24MISS');
      d_fin := TO_DATE(fecha_hasta || '235959', 'DDMMYYYYHH24MISS');
      v_ntraza := 1020;
      v_fin2 := TO_CHAR(d_fin, 'yymm');
      v_fin4 := TO_CHAR(d_fin, 'yyyymm');
      v_ntraza := 1030;
      lpath := f_parinstalacion_t('INFORMES');
      v_ntraza := 1040;
      p_desfic := 'CS' || v_fin2 || 'sv' || '.txt';
      v_ntraza := 1050;
      vsfile3 := UTL_FILE.fopen(lpath, p_desfic, 'w');
      v_ntraza := 1060;
      v_totase := 0;
      v_totnet := 0;
      v_totcom := 0;
      v_totreg := 0;
-----------------------
--Tipo 1 identificacion
-----------------------
      v_ntraza := 1070;

      SELECT MAX(b.nnumide), NVL(MAX(b.tdigitoide), ' '),
             MAX(RTRIM(LTRIM(c.tnombre || ' ' || c.tapelli1 || ' ' || c.tapelli2)))
        INTO v_rut, v_ver,
             v_nom
        FROM empresas a, per_personas b, per_detper c
       WHERE a.cempres = v_emp
         AND b.sperson = a.sperson
         AND c.sperson = b.sperson
         AND c.fmovimi = (SELECT MAX(c1.fmovimi)
                            FROM per_detper c1
                           WHERE c1.sperson = a.sperson);

      v_ntraza := 1080;
      p_linea('1' || p_format(v_rut, 09, 2) || p_format(v_ver, 01, 2) || '2'   -- Grupo Seg. Vida
              || v_fin4 || p_format(v_nom, 60, 2) || p_format(' ', 37, 0));
      v_totreg := v_totreg + 1;
-----------------------
--Tipo 2 Detalle por corredor
-----------------------
      v_ntraza := 1090;

      FOR f1 IN c1 LOOP
         v_ntraza := 1100;
         v_erride := f1.cagente;

         SELECT   MAX(LPAD(SUBSTR(b.nnumide, 1, 9), 9, '0')), NVL(MAX(b.tdigitoide), ' '),
                  MAX(RTRIM(LTRIM(c.tnombre || ' ' || c.tapelli1 || ' ' || c.tapelli2))),
                  MAX(DECODE(b.ctipper, 2, 'J', 'N'))
             INTO v_rut, v_ver,
                  v_nom,
                  v_tip
             FROM per_personas b, per_detper c
            WHERE b.sperson = f1.sperson
              AND c.sperson = b.sperson
              AND c.fmovimi = (SELECT MAX(c1.fmovimi)
                                 FROM per_detper c1
                                WHERE c1.sperson = f1.sperson)
         GROUP BY b.nnumide;

         v_ntraza := 1110;

         FOR f2 IN c2(f1.cagente) LOOP
            -- Repito cursor para calcular totales
            v_ntraza := 1111;
            v_net_ram := 0;

            FOR f3 IN c3(f1.cagente) LOOP
               v_net_ram := v_net_ram + f3.net;
            END LOOP;

            v_ntraza := 1120;
            p_linea('2' || p_format(v_rut, 09, 2) || p_format(v_ver, 01, 2)
                    || p_format(v_tip, 01, 2) || p_format(v_nom, 60, 2)
                    || p_format(LPAD(f1.mesprod, 2, '0'), 2, 2)
                    || p_format(LPAD(f1.numase, 8, '0'), 08, 2) || p_format(v_net_ram, 10, 1)
                    || p_format(f2.com, 10, 1) || p_format('0', 10, 1));
            v_totase := v_totase + NVL(f1.numase, 0);
            v_totnet := v_totnet + NVL(f2.net, 0);
            v_totcom := v_totcom + NVL(f2.com, 0);
            v_totreg := v_totreg + 1;
-----------------------
--Tipo 3 Detalle ramos
-----------------------
            v_ntraza := 1140;
            v_net_ram := 0;

            FOR f3 IN c3(f1.cagente) LOOP
               v_ntraza := 1150;
               p_linea('3' || p_format(v_rut, 09, 2) || p_format(f3.fecu, 03, 2)
                       || p_format(f3.afec, 01, 2) || p_format(f3.net, 11, 1)
                       || p_format(' ', 89, 0));
               v_totreg := v_totreg + 1;
               v_net_ram := v_net_ram + f3.net;
            END LOOP;

            p_linea('3' || p_format(v_rut, 09, 2) || p_format(999, 03, 2) || p_format(0, 01, 2)
                    || p_format(v_net_ram, 11, 1) || p_format(' ', 89, 0));
            v_totreg := v_totreg + 1;
         END LOOP;
      END LOOP;

-----------------------
--Tipo 4 Totales
-----------------------
      v_ntraza := 1160;
      v_totreg := v_totreg + 1;
      p_linea('4' || p_format(v_totase, 10, 1) || p_format(v_totnet, 11, 1)
              || p_format(v_totcom, 11, 1) || p_format('0', 11, 1) || p_format(v_totreg, 05, 1)
              || p_format(' ', 61, 0));
      v_ntraza := 1170;
      UTL_FILE.fclose(vsfile3);
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza,
                     v_tparam || ' ' || v_erride || ': Error' || SQLCODE, SQLERRM);
   END p_751_produccion;

   PROCEDURE p_751_produccion_asesor(
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_desfic IN OUT VARCHAR2) IS
      vsfile3        UTL_FILE.file_type;
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.p_751_produccion_asesor';
      v_tparam       VARCHAR2(100)
                            := 'fecha_desde=' || fecha_desde || ' fecha_hasta=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_erride       VARCHAR2(100);   -- Para identifciar clave si tenemos error
      lpath          VARCHAR2(999);
      d_ini          DATE;
      d_fin          DATE;
      v_fin2         VARCHAR2(10);
      v_fin4         VARCHAR2(10);
      --v_emp          NUMBER;
      v_rut          VARCHAR2(100);
      v_ver          VARCHAR2(100);
      v_nom          VARCHAR2(500);
      v_tip          VARCHAR2(10);
      v_totreg       NUMBER;

      PROCEDURE p_linea(p_txt IN VARCHAR2) IS
      BEGIN
         UTL_FILE.put_line(vsfile3, p_txt);
      END;
   BEGIN
      v_ntraza := 1000;
      v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 1010;
      d_ini := TO_DATE(fecha_desde || '000000', 'DDMMYYYYHH24MISS');
      d_fin := TO_DATE(fecha_hasta || '235959', 'DDMMYYYYHH24MISS');
      v_ntraza := 1020;
      v_fin2 := TO_CHAR(d_fin, 'yymm');
      v_fin4 := TO_CHAR(d_fin, 'yyyymm');
      v_ntraza := 1030;
      lpath := f_parinstalacion_t('INFORMES');
      v_ntraza := 1040;
      p_desfic := 'AP' || v_fin2 || 'sv' || '.txt';
      v_ntraza := 1050;
      vsfile3 := UTL_FILE.fopen(lpath, p_desfic, 'w');
      v_ntraza := 1060;
      v_totreg := 0;
-----------------------
--Tipo 1 identificacion
-----------------------
      v_ntraza := 1070;

      SELECT MAX(b.nnumide), NVL(MAX(b.tdigitoide), ' '),
             MAX(RTRIM(LTRIM(c.tnombre || ' ' || c.tapelli1 || ' ' || c.tapelli2)))
        INTO v_rut, v_ver,
             v_nom
        FROM empresas a, per_personas b, per_detper c
       WHERE a.cempres = v_emp
         AND b.sperson = a.sperson
         AND c.sperson = b.sperson
         AND c.fmovimi = (SELECT MAX(c1.fmovimi)
                            FROM per_detper c1
                           WHERE c1.sperson = a.sperson);

      v_ntraza := 1080;
      p_linea('1' || p_format(v_rut, 09, 2) || p_format(v_ver, 01, 2) || '2'   -- Grupo Seg. Vida
              || v_fin4 || p_format(v_nom, 60, 2) || p_format(' ', 37, 0));
      v_totreg := v_totreg + 1;
-----------------------
--Tipo 4 Totales
-----------------------
      v_ntraza := 1160;
      v_totreg := v_totreg + 1;
      p_linea('4' || p_format('0', 10, 3) || p_format('0', 11, 3) || p_format('0', 11, 3)
              || p_format(v_totreg, 05, 3) || p_format(' ', 77, 0));
      v_ntraza := 1170;
      UTL_FILE.fclose(vsfile3);
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza,
                     v_tparam || ' ' || v_erride || ': Error' || SQLCODE, SQLERRM);
   END p_751_produccion_asesor;

   PROCEDURE p_751_agentes(
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      p_desfic IN OUT VARCHAR2) IS
      vsfile3        UTL_FILE.file_type;
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.p_751_agentes';
      v_tparam       VARCHAR2(100)
                            := 'fecha_desde=' || fecha_desde || ' fecha_hasta=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_erride       VARCHAR2(100);   -- Para identifciar clave si tenemos error
      lpath          VARCHAR2(999);
      d_ini          DATE;
      d_fin          DATE;
      v_fin2         VARCHAR2(10);
      v_fin4         VARCHAR2(10);
      --v_emp          NUMBER;
      v_rutcia       VARCHAR2(100);
      v_rut          VARCHAR2(100);
      v_ver          VARCHAR2(100);
      v_nom          VARCHAR2(500);
      v_tip          VARCHAR2(10);
      v_totase       NUMBER;
      v_totnet       NUMBER;
      v_totcom       NUMBER;
      v_totreg       NUMBER;

      CURSOR c1 IS
         SELECT   a.cagente, COUNT(DISTINCT b.sperson) numase, MAX(c.sperson) sperson,
                  TO_CHAR(MIN(fmovini), 'yyyymmdd') ageini,
                  NVL(TO_CHAR(MAX(fmovfin), 'yyyymmdd'), '00000000') agefin
             FROM seguros a, asegurados b, agentes c, agentes_comp d, redcomercial e
            WHERE 1 = 2
--<<<<<<<<<<<<<
              AND a.cempres = v_emp
              AND f_vigente(a.sseguro, NULL, d_fin) = 0
              AND b.sseguro = a.sseguro
              AND c.cagente = a.cagente
              AND d.cagente = c.cagente
              AND pac_propio.f_agentecorredor(d.ctipint) = 0
              -- Para asegurar que existen datos
              AND EXISTS(SELECT 1
                           FROM recibos a, movrecibo b, detrecibos c
                          WHERE a.cempres = a.cempres
                            AND a.cagente = a.cagente
                            AND b.nrecibo = a.nrecibo
                            AND b.smovrec = (SELECT MAX(b1.smovrec)
                                               FROM movrecibo b1
                                              WHERE b1.nrecibo = a.nrecibo
                                                AND d_fin < NVL(b1.fmovfin, d_fin + 1))
                            AND b.cestrec = 0
                            AND c.nrecibo = a.nrecibo
                            AND c.cconcep IN(0, 11))
              AND e.cempres = a.cempres
              AND e.cagente = a.cagente
         GROUP BY a.cagente;

      CURSOR c3(pc_age IN NUMBER) IS
         SELECT SUM(DECODE(c.cconcep, 00, NVL(c.iconcep, 0), 0)) / 1000 net,
                SUM(DECODE(c.cconcep, 11, NVL(c.iconcep, 0), 0)) / 1000 com
           FROM recibos a, movrecibo b, detrecibos c, seguros d
          WHERE a.cempres = v_emp
            AND a.cagente = pc_age
            AND b.nrecibo = a.nrecibo
            AND b.smovrec = (SELECT MAX(b1.smovrec)
                               FROM movrecibo b1
                              WHERE b1.nrecibo = a.nrecibo
                                AND d_fin < NVL(b1.fmovfin, d_fin + 1))
            AND b.cestrec = 0
            AND c.nrecibo = a.nrecibo
            AND c.cconcep IN(0, 11)
            AND d.sseguro = a.sseguro;

      PROCEDURE p_linea(p_txt IN VARCHAR2) IS
      BEGIN
         UTL_FILE.put_line(vsfile3, p_txt);
      END;
   BEGIN
      v_ntraza := 1000;
      v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 1010;
      d_ini := TO_DATE(fecha_desde || '000000', 'DDMMYYYYHH24MISS');
      d_fin := TO_DATE(fecha_hasta || '235959', 'DDMMYYYYHH24MISS');
      v_ntraza := 1020;
      v_fin2 := TO_CHAR(d_fin, 'yymm');
      v_fin4 := TO_CHAR(d_fin, 'yyyymm');
      v_ntraza := 1030;
      lpath := f_parinstalacion_t('INFORMES');
      v_ntraza := 1040;
      p_desfic := 'AG' || v_fin2 || 'sv' || '.txt';
      v_ntraza := 1050;
      vsfile3 := UTL_FILE.fopen(lpath, p_desfic, 'w');
      v_ntraza := 1060;
      v_totase := 0;
      v_totnet := 0;
      v_totcom := 0;
      v_totreg := 0;
-----------------------
--Tipo 1 identificacion
-----------------------
      v_ntraza := 1070;

      SELECT MAX(b.nnumide), NVL(MAX(b.tdigitoide), ' '),
             MAX(RTRIM(LTRIM(c.tnombre || ' ' || c.tapelli1 || ' ' || c.tapelli2)))
        INTO v_rut, v_ver,
             v_nom
        FROM empresas a, per_personas b, per_detper c
       WHERE a.cempres = v_emp
         AND b.sperson = a.sperson
         AND c.sperson = b.sperson
         AND c.fmovimi = (SELECT MAX(c1.fmovimi)
                            FROM per_detper c1
                           WHERE c1.sperson = a.sperson);

      v_rutcia := v_rut;
      v_ntraza := 1080;
      p_linea('1' || p_format(v_rut, 09, 2) || p_format(v_ver, 01, 2) || '2'   -- Grupo Seg. Vida
              || v_fin4 || p_format(v_nom, 60, 2) || p_format(' ', 10, 2));
      v_totreg := v_totreg + 1;
-----------------------
--Tipo 2 Agentes de venta
-----------------------
      v_ntraza := 1090;

      FOR f1 IN c1 LOOP
         v_ntraza := 1100;
         v_erride := f1.cagente;

         SELECT MAX(b.nnumide), NVL(MAX(b.tdigitoide), ' '),
                MAX(RTRIM(LTRIM(c.tnombre || ' ' || c.tapelli1 || ' ' || c.tapelli2))),
                MAX(DECODE(b.ctipper, 2, 'J', 'N'))
           INTO v_rut, v_ver,
                v_nom,
                v_tip
           FROM per_personas b, per_detper c
          WHERE b.sperson = f1.sperson
            AND c.sperson = b.sperson
            AND c.fmovimi = (SELECT MAX(c1.fmovimi)
                               FROM per_detper c1
                              WHERE c1.sperson = f1.sperson);

         v_ntraza := 1110;
         p_linea('2' || p_format(v_rut, 09, 2) || p_format(v_ver, 01, 2)
                 || p_format(v_tip, 01, 2) || p_format(v_nom, 60, 2)
                 || p_format(f1.ageini, 08, 1) || p_format(f1.agefin, 08, 1));
         v_totreg := v_totreg + 1;
-----------------------
--Tipo 3 Venta directa
-----------------------
         v_ntraza := 1140;

         FOR f3 IN c3(f1.cagente) LOOP
            IF v_rut = v_rutcia THEN
               v_ntraza := 1150;
               p_linea('3' || p_format(v_rutcia, 09, 2) || p_format('0', 10, 1)
                       || p_format(f3.net, 10, 1) || p_format('0', 10, 1)
                       || p_format('0', 10, 1) || p_format('0', 10, 1)
                       || p_format(f3.com, 10, 1) || p_format(' ', 12, 2));
               v_totreg := v_totreg + 1;
            ELSE
               v_ntraza := 1150;
               p_linea('3' || p_format(v_rutcia, 09, 2) || p_format(f3.net, 10, 1)
                       || p_format('0', 10, 1) || p_format('0', 10, 1) || p_format('0', 10, 1)
                       || p_format(f3.com, 10, 1) || p_format('0', 10, 1)
                       || p_format(' ', 12, 2));
               v_totreg := v_totreg + 1;
            END IF;
         END LOOP;
      END LOOP;

-----------------------
--Tipo 4 Totales
-----------------------
      v_ntraza := 1160;
      v_totreg := v_totreg + 1;
      p_linea('4' || p_format(v_totreg, 05, 3) || p_format(' ', 82, 2));
      v_ntraza := 1170;
      UTL_FILE.fclose(vsfile3);
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza,
                     v_tparam || ' ' || v_erride || ': Error' || SQLCODE, SQLERRM);
   END p_751_agentes;

   /******************************************************************************************
     Descripció: Ficheros de Superintendencia
     return:     texto detalle
     -- bug 0026721 - 20/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_751(
      pidioma IN NUMBER,
      fecha_desde IN VARCHAR2,
      fecha_hasta IN VARCHAR2,
      vimp OUT t_iax_impresion)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_751';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      v_desfic       VARCHAR2(900);
      vobimp         ob_iax_impresion := ob_iax_impresion();
      vpath_vis      VARCHAR2(900);
   BEGIN
      v_ntraza := 100;
      v_ini := '0101' || TO_CHAR(TO_DATE(fecha_desde, 'DDMMYYYY'), 'yyyy');
      v_fin := TO_CHAR(LAST_DAY(TO_DATE(NVL(fecha_hasta, fecha_desde), 'DDMMYYYY')),
                       'ddmmyyyy');
      v_ntraza := 110;
      vimp := t_iax_impresion();
      vpath_vis := f_parinstalacion_t('INFORMES_C') || '\';
      -- Produccion y comisiones por corredor : CSAAMMsv.txt
      v_ntraza := 120;
      p_751_produccion(v_ini, v_fin, v_desfic);
      vimp.EXTEND;
      vobimp.fichero := vpath_vis || v_desfic;
      vimp(vimp.LAST) := vobimp;
      -- Produccion y comisiones por asesor : APAAMMsv.txt
      v_ntraza := 130;
      p_751_produccion_asesor(v_ini, v_fin, v_desfic);
      vimp.EXTEND;
      vobimp.fichero := vpath_vis || v_desfic;
      vimp(vimp.LAST) := vobimp;
      -- Identificación y vigencia de los agentes de venta : AGAAMMsv.txt
      v_ntraza := 140;
      p_751_agentes(v_ini, v_fin, v_desfic);
      vimp.EXTEND;
      vobimp.fichero := vpath_vis || v_desfic;
      vimp(vimp.LAST) := vobimp;
      RETURN 0;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 1;
   END f_751;

   /*
       Se utiliza en 707 Ni Reaseguradores y corredores
   */
   FUNCTION f_cedida_reasegurador(
      preasegurador IN NUMBER,
      pdesde IN VARCHAR2,
      phasta IN VARCHAR2)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_cedida_reasegurador';
      v_tparam       VARCHAR2(100)
                                := 'c=' || preasegurador || ' d=' || pdesde || ' h=' || phasta;
      v_ntraza       NUMBER := 0;
      vcedida        NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
      d_ini          DATE;
      d_fin          DATE;
      v_pais         NUMBER;
   BEGIN
      d_ini := TO_DATE(pdesde || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(phasta || '235959', 'ddmmyyyyhh24miss');

      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      SELECT SUM(cedida)
        INTO vcedida
        FROM (
              -- cuadroces emision y cobros

              -- cuadroces emision y cobros
              SELECT SUM
                        (NVL
                            (((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0)
                                                   /*+ NVL((ce.icesion
                                                          * DECODE(tr.ctramo,
                                                                   1, DECODE(SIGN((ce.icapces
                                                                                   * tr.plocal / 100)
                                                                                  - NVL(tr.imaxplo, 0)),
                                                                             -1,(cc.pcesion
                                                                                 *(100
                                                                                   -((tr.plocal
                                                                                      * tr.imaxplo)
                                                                                     /((ce.icapces
                                                                                        * tr.plocal)
                                                                                       / 100))))
                                                                              /(100 - tr.plocal),
                                                                             cc.pcesion),
                                                                   cc.pcesion)
                                                          * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                      s.sseguro,
                                                                                      ce.cgarant,
                                                                                      cc.pctcomis,
                                                                                      r.femisio)
                                                          / 10000)
                                                         * rs.nfactor,
                                                         0),*/
                                             ,
                                             1))
                              * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                              * DECODE(m.cestrec, 0, 1, -1)),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE cc.ctramo = tr.ctramo
                 AND m.fmovdia BETWEEN d_ini AND d_fin
                 AND x.ccompani = preasegurador
                 AND x.ccompani = cc.ccompani
                 AND m.nrecibo = r.nrecibo
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 -- Bug 26430 - 28/10/2013 - JMF
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND(
                     -- emision +2A
                     (rs.cmotces = 1
                      AND(m.cestrec = 0
                          AND m.cestant = 0)
                      OR (m.cestrec = 0
                          AND m.cestant = 1)
                         AND NOT EXISTS(SELECT '1'
                                          FROM detmovrecibo dm
                                         WHERE dm.nrecibo = r.nrecibo))
                     OR
                       -- anulación -2A
                     (  (m.cestrec = 2
                         AND m.cestant = 0
                         AND rs.cmotces = 2)
                        -- cobro -2A
                        OR(m.cestrec = 1
                           AND rs.cmotces = 1
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo))))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- facultativo emision y cobros
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /* + NVL((ce.icesion
                                                     * DECODE(tr.ctramo,
                                                              1, DECODE(SIGN((ce.icapces
                                                                              * tr.plocal / 100)
                                                                             - NVL(tr.imaxplo, 0)),
                                                                        -1,(cc.pcesion
                                                                            *(100
                                                                              -((tr.plocal
                                                                                 * tr.imaxplo)
                                                                                /((ce.icapces
                                                                                   * tr.plocal)
                                                                                  / 100))))
                                                                         /(100 - tr.plocal),
                                                                        cc.pcesion),
                                                              cc.pcesion)
                                                     * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                 s.sseguro,
                                                                                 ce.cgarant,
                                                                                 cc.pcomisi,
                                                                                 r.femisio)
                                                     / 10000)
                                                    * rs.nfactor,
                                                    0),*/
                                             1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec,
                                                                            0, 1,
                                                                            -1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE m.nrecibo = r.nrecibo
                 AND m.fmovdia BETWEEN d_ini AND d_fin
                 AND x.ccompani = preasegurador
                 AND x.ccompani = cc.ccompani
                 AND cc.sfacult = ce.sfacult
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 -- Bug 26430 - 28/10/2013 - JMF
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND(
                     -- emision +2A
                     (rs.cmotces = 1
                      AND(m.cestrec = 0
                          AND m.cestant = 0)
                      OR (m.cestrec = 0
                          AND m.cestant = 1)
                         AND NOT EXISTS(SELECT '1'
                                          FROM detmovrecibo dm
                                         WHERE dm.nrecibo = r.nrecibo))
                     OR
                       -- anulación -2A
                     (  (m.cestrec = 2
                         AND m.cestant = 0
                         AND rs.cmotces = 2)
                        -- cobro -2A
                        OR(m.cestrec = 1
                           AND rs.cmotces = 1
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo))))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
--------------------------------------------------------------------------------------------------------------
              -- parcial emision y cobros
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                             *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     companias c,
                     pregunpolseg ps,
                     companias x
               WHERE dv.nrecibo = r.nrecibo
                 AND dv.fmovimi BETWEEN d_ini AND d_fin
                 AND x.ccompani = preasegurador
                 AND x.ccompani = cc.ccompani
                 AND dv.norden = 1
                 AND cc.ctramo = tr.ctramo
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.cmotces = 1
                 -- Bug 26430 - 28/10/2013 - JMF
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- parcial emision y cobros, facultativo
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                             *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     -- Bug 26430 - 28/10/2013 - JMF
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE dv.nrecibo = r.nrecibo
                 AND dv.fmovimi BETWEEN d_ini AND d_fin
                 AND x.ccompani = preasegurador
                 AND x.ccompani = cc.ccompani
                 AND dv.norden = 1
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.cmotces = 1
                 -- Bug 26430 - 28/10/2013 - JMF
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 --
                 AND cc.sfacult = ce.sfacult
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- Reaseguro
              SELECT SUM(NVL(r.importe, 0)) cedida
                FROM (SELECT icesion_moncon importe, r.fcalcul, r.nsinies, r.sseguro,
                             cc.ccompani codi, r.cgarant
                        FROM reaseguro r, cuadroces cc
                       WHERE r.cgenera <> 2
                         AND r.ccompani = cc.ccompani
                         AND r.scontra = cc.scontra
                         AND r.nversio = cc.nversio
                         AND r.ctramo = cc.ctramo
                         AND preserv IS NOT NULL) r,
                     seguros s,
                     companias c,
                     productos pr
               WHERE s.sseguro = r.sseguro
                 AND r.nsinies IS NULL
                 AND c.ccompani = r.codi
                 AND s.sproduc = pr.sproduc
                 AND NVL(r.importe, 0) <> 0
                 AND r.fcalcul BETWEEN d_ini AND d_fin
                 AND c.ccompani = preasegurador
                 AND c.ccompani = r.codi);

      RETURN vcedida;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_cedida_reasegurador;

   /*
       Se utiliza en 707 Ni Reaseguradores y corredores
   */
   FUNCTION f_cedida_corredor(pcorredor IN NUMBER, pdesde IN VARCHAR2, phasta IN VARCHAR2)
      RETURN NUMBER IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_cedida_corredor';
      v_tparam       VARCHAR2(100) := 'c=' || pcorredor || ' d=' || pdesde || ' h=' || phasta;
      v_ntraza       NUMBER := 0;
      vcedida        NUMBER;
      v_monedacontab monedas.cmonint%TYPE;
      d_ini          DATE;
      d_fin          DATE;
      v_pais         NUMBER;
   BEGIN
      d_ini := TO_DATE(pdesde || '000000', 'ddmmyyyyhh24miss');
      d_fin := TO_DATE(phasta || '235959', 'ddmmyyyyhh24miss');

      SELECT pac_monedas.f_cmoneda_t(nvalpar)
        INTO v_monedacontab
        FROM parempresas
       WHERE cempres = v_emp   -- 16 -- BUG 0035387 - FAL - 31/03/2015
         AND cparam = 'MONEDACONTAB';

      SELECT SUM(cedida)
        INTO vcedida
        FROM (
              -- cuadroces emision y cobros
              SELECT SUM
                        (NVL
                            (((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0)
                                                   /*+ NVL((ce.icesion
                                                          * DECODE(tr.ctramo,
                                                                   1, DECODE(SIGN((ce.icapces
                                                                                   * tr.plocal / 100)
                                                                                  - NVL(tr.imaxplo, 0)),
                                                                             -1,(cc.pcesion
                                                                                 *(100
                                                                                   -((tr.plocal
                                                                                      * tr.imaxplo)
                                                                                     /((ce.icapces
                                                                                        * tr.plocal)
                                                                                       / 100))))
                                                                              /(100 - tr.plocal),
                                                                             cc.pcesion),
                                                                   cc.pcesion)
                                                          * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                      s.sseguro,
                                                                                      ce.cgarant,
                                                                                      cc.pctcomis,
                                                                                      r.femisio)
                                                          / 10000)
                                                         * rs.nfactor,
                                                         0),*/
                                             ,
                                             1))
                              * DECODE(r.ctiprec, 9, -1, 13, -1, 1)
                              * DECODE(m.cestrec, 0, 1, -1)),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE cc.ctramo = tr.ctramo
                 AND m.fmovdia BETWEEN d_ini AND d_fin
                 AND x.ccompani = pcorredor
                 AND x.ccompani = cc.ccorred
                 AND m.nrecibo = r.nrecibo
                 AND s.sseguro = r.sseguro
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND(
                     -- emision +2A
                     (rs.cmotces = 1
                      AND(m.cestrec = 0
                          AND m.cestant = 0)
                      OR (m.cestrec = 0
                          AND m.cestant = 1)
                         AND NOT EXISTS(SELECT '1'
                                          FROM detmovrecibo dm
                                         WHERE dm.nrecibo = r.nrecibo))
                     OR
                       -- anulación -2A
                     (  (m.cestrec = 2
                         AND m.cestant = 0
                         AND rs.cmotces = 2)
                        -- cobro -2A
                        OR(m.cestrec = 1
                           AND rs.cmotces = 1
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo))))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- facultativo emision y cobros
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),

                                             /* + NVL((ce.icesion
                                                     * DECODE(tr.ctramo,
                                                              1, DECODE(SIGN((ce.icapces
                                                                              * tr.plocal / 100)
                                                                             - NVL(tr.imaxplo, 0)),
                                                                        -1,(cc.pcesion
                                                                            *(100
                                                                              -((tr.plocal
                                                                                 * tr.imaxplo)
                                                                                /((ce.icapces
                                                                                   * tr.plocal)
                                                                                  / 100))))
                                                                         /(100 - tr.plocal),
                                                                        cc.pcesion),
                                                              cc.pcesion)
                                                     * pac_propio.f_comi_ces(cc.ccomrea,
                                                                                 s.sseguro,
                                                                                 ce.cgarant,
                                                                                 cc.pcomisi,
                                                                                 r.femisio)
                                                     / 10000)
                                                    * rs.nfactor,
                                                    0),*/
                                             1))
                             * DECODE(r.ctiprec, 9, -1, 13, -1, 1) * DECODE(m.cestrec,
                                                                            0, 1,
                                                                            -1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     movrecibo m,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE m.nrecibo = r.nrecibo
                 AND m.fmovdia BETWEEN d_ini AND d_fin
                 AND x.ccompani = pcorredor
                 AND x.ccompani = cc.ccorred
                 AND cc.sfacult = ce.sfacult
                 AND s.sseguro = r.sseguro
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND m.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND(
                     -- emision +2A
                     (rs.cmotces = 1
                      AND(m.cestrec = 0
                          AND m.cestant = 0)
                      OR (m.cestrec = 0
                          AND m.cestant = 1)
                         AND NOT EXISTS(SELECT '1'
                                          FROM detmovrecibo dm
                                         WHERE dm.nrecibo = r.nrecibo))
                     OR
                       -- anulación -2A
                     (  (m.cestrec = 2
                         AND m.cestant = 0
                         AND rs.cmotces = 2)
                        -- cobro -2A
                        OR(m.cestrec = 1
                           AND rs.cmotces = 1
                           AND NOT EXISTS(SELECT '1'
                                            FROM detmovrecibo dm
                                           WHERE dm.nrecibo = r.nrecibo))))
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
--------------------------------------------------------------------------------------------------------------
              -- parcial emision y cobros
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                             *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuadroces cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     companias c,
                     pregunpolseg ps,
                     companias x
               WHERE dv.nrecibo = r.nrecibo
                 AND dv.fmovimi BETWEEN d_ini AND d_fin
                 AND x.ccompani = pcorredor
                 AND x.ccompani = cc.ccorred
                 AND dv.norden = 1
                 AND cc.ctramo = tr.ctramo
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND rs.cmotces = 1
                 AND cc.scontra = tr.scontra
                 AND cc.nversio = tr.nversio
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND tr.ctramo = ce.ctramo
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND c.ccompani = cc.ccompani
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- parcial emision y cobros, facultativo
              SELECT SUM
                        (NVL
                            ((pac_eco_tipocambio.f_importe_cambio
                                            ((SELECT cmonint
                                                FROM monedas
                                               WHERE cidioma = 3
                                                 AND cmoneda = pr.cdivisa), v_monedacontab,
                                             r.femisio,
                                             NVL((ce.icesion
                                                  * DECODE(tr.ctramo,
                                                           1, DECODE(SIGN((ce.icapces
                                                                           * tr.plocal / 100)
                                                                          - NVL(tr.imaxplo, 0)),
                                                                     -1,(cc.pcesion
                                                                         *(100
                                                                           -((tr.plocal
                                                                              * tr.imaxplo)
                                                                             /((ce.icapces
                                                                                * tr.plocal)
                                                                               / 100))))
                                                                      /(100 - tr.plocal),
                                                                     cc.pcesion),
                                                           cc.pcesion)
                                                  / 100)
                                                 * rs.nfactor,
                                                 0),
                                             1))
                             *(-1) * DECODE(r.ctiprec, 9, -1, 13, -1, 1),
                             0)) cedida
                FROM seguros s,
                     tramos tr,
                     recibos r,
                     cuacesfac cc,
                     (SELECT icesion, icapces, ce.sseguro, ce.nversio, ce.ctramo, ce.scontra,
                             ce.cgarant, ce.sfacult, ce.nmovimi, ce.scesrea
                        FROM cesionesrea ce, tramos tr
                       WHERE tr.scontra = ce.scontra
                         AND tr.nversio = ce.nversio
                         AND tr.ctramo = ce.ctramo
                         AND ce.fefecto <> ce.fvencim) ce,
                     detmovrecibo dv,
                     reasegemi rs,
                     detreasegemi drs,
                     productos pr,
                     pregunpolseg ps,
                     companias x
               WHERE dv.nrecibo = r.nrecibo
                 AND dv.fmovimi BETWEEN d_ini AND d_fin
                 AND x.ccompani = pcorredor
                 AND x.ccompani = cc.ccorred
                 AND dv.norden = 1
                 AND tr.ctramo = ce.ctramo
                 AND dv.nrecibo = rs.nrecibo
                 AND rs.cmotces = 1
                 AND cc.sfacult = ce.sfacult
                 AND rs.sreaemi = drs.sreaemi
                 AND drs.scesrea = ce.scesrea
                 AND drs.cgarant = ce.cgarant
                 AND tr.scontra = ce.scontra
                 AND tr.nversio = ce.nversio
                 AND s.sseguro = ce.sseguro
                 AND s.sseguro = rs.sseguro
                 AND s.cramo = pr.cramo
                 AND s.cmodali = pr.cmodali
                 AND s.ctipseg = pr.ctipseg
                 AND s.ccolect = pr.ccolect
                 AND ps.sseguro = s.sseguro
                 AND ps.nmovimi = (SELECT MAX(nmovimi)
                                     FROM pregunpolseg
                                    WHERE sseguro = s.sseguro
                                      AND cpregun = 414
                                      AND nmovimi <= ce.nmovimi)
                 AND ps.cpregun = 414
              UNION ALL
              -- Reaseguro
              SELECT SUM(NVL(r.importe, 0)) cedida
                FROM (SELECT icesion_moncon importe, r.fcalcul, r.nsinies, r.sseguro,
                             cc.ccorred codi, r.cgarant
                        FROM reaseguro r, cuadroces cc
                       WHERE r.cgenera <> 2
                         AND r.ccompani = cc.ccompani
                         AND r.scontra = cc.scontra
                         AND r.nversio = cc.nversio
                         AND r.ctramo = cc.ctramo
                         AND preserv IS NOT NULL) r,
                     seguros s,
                     companias c,
                     productos pr
               WHERE s.sseguro = r.sseguro
                 AND r.nsinies IS NULL
                 AND c.ccompani = r.codi
                 AND s.sproduc = pr.sproduc
                 AND NVL(r.importe, 0) <> 0
                 AND r.fcalcul BETWEEN d_ini AND d_fin
                 AND c.ccompani = pcorredor
                 AND c.ccompani = r.codi);

      RETURN vcedida;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN NULL;
   END f_cedida_corredor;

   /*************************************************************************
    Libro de compras, calculo monto afecto siniestros y facturas
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_calmontoafecto(
      psidepag IN NUMBER,
      pliq IN NUMBER,
      page IN NUMBER,
      pemp IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_calmontoafecto';
      vpar           VARCHAR2(1000)
                       := ' p=' || psidepag || ' l=' || pliq || ' a=' || page || ' e=' || pemp;
      v_lin          NUMBER := 0;
      --
      n_monto_afecto NUMBER;
   BEGIN
      v_lin := 100;
      n_monto_afecto := 0;

      IF psidepag IS NOT NULL THEN
         v_lin := 110;

         SELECT SUM(isinret)
           INTO n_monto_afecto
           FROM sin_tramita_pago_gar
          WHERE (ctipres, nmovres, norden) IN(SELECT ctipres, nmovres, norden
                                                FROM sin_tramita_pago_gar
                                               WHERE sidepag = psidepag
                                                 AND iiva <> 0)
            AND sidepag = psidepag;
      ELSE
         v_lin := 120;

         SELECT SUM(iconcep_monpol)
           INTO n_monto_afecto
           FROM detrecibos a
          WHERE nrecibo IN(SELECT nrecibo
                             FROM liquidalin
                            WHERE cempres = pemp
                              AND nliqmen = pliq
                              AND cagente = page)
            AND cconcep = 0
            AND cgarant IN(SELECT DISTINCT cgarant
                                      FROM detrecibos b
                                     WHERE b.nrecibo = a.nrecibo
                                       AND cconcep = 4);
      END IF;

      RETURN n_monto_afecto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_calmontoafecto;

   /*************************************************************************
    Libro de compras, calculo monto exento siniestros y facturas
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_calmontoexento(
      psidepag IN NUMBER,
      pliq IN NUMBER,
      page IN NUMBER,
      pemp IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_calmontoexento';
      vpar           VARCHAR2(1000)
                       := ' p=' || psidepag || ' l=' || pliq || ' a=' || page || ' e=' || pemp;
      v_lin          NUMBER := 0;
      --
      n_monto_exento NUMBER;
   BEGIN
      v_lin := 100;
      n_monto_exento := 0;

      IF psidepag IS NOT NULL THEN
         v_lin := 110;

         SELECT SUM(isinret)
           INTO n_monto_exento
           FROM sin_tramita_pago_gar
          WHERE (ctipres, nmovres, norden) IN(SELECT ctipres, nmovres, norden
                                                FROM sin_tramita_pago_gar
                                               WHERE sidepag = psidepag
                                                 AND iiva = 0)
            AND sidepag = psidepag;
      ELSE
         v_lin := 120;

         SELECT SUM(iconcep_monpol)
           INTO n_monto_exento
           FROM detrecibos a
          WHERE nrecibo IN(SELECT nrecibo
                             FROM liquidalin
                            WHERE cempres = pemp
                              AND nliqmen = pliq
                              AND cagente = page)
            AND cconcep = 0
            AND cgarant NOT IN(SELECT DISTINCT cgarant
                                          FROM detrecibos b
                                         WHERE b.nrecibo = a.nrecibo
                                           AND cconcep = 4);
      END IF;

      RETURN n_monto_exento;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_calmontoexento;

   /*************************************************************************
    Libro de compras, calculo codigo no recuperable
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_codnorecuperable(psidepag IN NUMBER, pnfact IN VARCHAR2, page IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_codnorecuperable';
      vpar           VARCHAR2(1000) := ' p=' || psidepag || ' f=' || pnfact || ' a=' || page;
      v_lin          NUMBER := 0;
      --
      v_recupera     NUMBER(1);
      d_fac          DATE;
      d_alt          DATE;
      n_iva          NUMBER;
   BEGIN
      v_lin := 100;

      IF psidepag IS NOT NULL THEN
         v_lin := 110;

         SELECT MAX(a.ffacref), MAX(a.falta), MAX(a.iiva)
           INTO d_fac, d_alt, n_iva
           FROM sin_tramita_pago a
          WHERE sidepag = psidepag;
      ELSE
         v_lin := 120;

         SELECT MAX(ffact), MAX(falta), MAX(DECODE(ctipdoc, 3, 0, 5, 0, 1))
           INTO d_fac, d_alt, n_iva
           FROM facturas
          WHERE nfact = pnfact
            AND cagente = page;
      END IF;

      v_recupera := NULL;
      v_lin := 130;

      IF d_fac IS NOT NULL
         AND d_alt IS NOT NULL THEN
         IF ABS(TRUNC(MONTHS_BETWEEN('01' || TO_CHAR(d_fac, 'mmyyyy'),
                                     '01' || TO_CHAR(d_alt, 'mmyyyy')))) > 1 THEN
            -- Facturas de proveedores fuera de plazo
            v_recupera := 2;
         END IF;
      END IF;

      v_lin := 140;

      IF v_recupera IS NULL
         AND NVL(n_iva, 0) = 0 THEN
         -- facturas exentas
         v_recupera := 1;
      END IF;

      RETURN v_recupera;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_codnorecuperable;

   /*************************************************************************
    Libro de compras, IVA uso comun
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_ivacomun(psidepag IN NUMBER, pliq IN NUMBER, page IN NUMBER, pemp IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_ivacomun';
      vpar           VARCHAR2(1000)
                       := ' p=' || psidepag || ' l=' || pliq || ' a=' || page || ' e=' || pemp;
      v_lin          NUMBER := 0;
      --
      v_iva_comun    NUMBER;
   BEGIN
      v_lin := 100;
      v_iva_comun := 0;

      IF psidepag IS NOT NULL THEN
         v_lin := 110;

         SELECT SUM(iiva)
           INTO v_iva_comun
           FROM sin_tramita_pago_gar
          WHERE (SELECT COUNT(DISTINCT ctipres || nmovres || norden)
                   FROM sin_tramita_pago_gar
                  WHERE sidepag = psidepag) <> (SELECT COUNT(DISTINCT ctipres || nmovres
                                                              || norden)
                                                  FROM sin_tramita_pago_gar
                                                 WHERE sidepag = psidepag
                                                   AND iiva = 0)
            AND sidepag = psidepag;
      ELSE
         -- iva comun
         v_lin := 120;

         SELECT SUM(iconcep_monpol)
           INTO v_iva_comun
           FROM detrecibos a
          WHERE nrecibo IN(SELECT nrecibo
                             FROM liquidalin
                            WHERE cempres = pemp
                              AND nliqmen = pliq
                              AND cagente = page)
            AND cconcep = 4
            AND (SELECT COUNT(DISTINCT cgarant)
                   FROM detrecibos b
                  WHERE b.nrecibo = a.nrecibo
                    AND cconcep = 4) <> (SELECT COUNT(DISTINCT cgarant)
                                           FROM detrecibos c
                                          WHERE c.nrecibo = a.nrecibo);
      END IF;

      RETURN v_iva_comun;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_ivacomun;

   /*************************************************************************
    Libro de compras, IVA no recuperable
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_ivanorecuperable(
      psidepag IN NUMBER,
      pnfact IN VARCHAR2,
      pliq IN NUMBER,
      page IN NUMBER,
      pemp IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_ivanorecuperable';
      vpar           VARCHAR2(1000)
         := ' p=' || psidepag || ' f=' || pnfact || ' l=' || pliq || ' a=' || page || ' e='
            || pemp;
      v_lin          NUMBER := 0;
      --
      v_iva_norecuperable NUMBER;
   BEGIN
      v_lin := 100;
      v_iva_norecuperable := 0;

      -- iva no recuperable
      IF psidepag IS NOT NULL THEN
         IF f_lc_codnorecuperable(psidepag, NULL, NULL) = 2 THEN
            v_lin := 110;

            SELECT SUM(iiva)
              INTO v_iva_norecuperable
              FROM sin_tramita_pago_gar
             WHERE (ctipres, nmovres, norden) IN(SELECT ctipres, nmovres, norden
                                                   FROM sin_tramita_pago_gar
                                                  WHERE sidepag = psidepag
                                                    AND iiva = 0)
               AND sidepag = psidepag;
         ELSE
            v_iva_norecuperable := 0;
         END IF;
      ELSE
         v_lin := 120;

         IF f_lc_codnorecuperable(NULL, pnfact, page) = 2 THEN
            v_lin := 130;

            SELECT SUM(iconcep_monpol)
              INTO v_iva_norecuperable
              FROM detrecibos
             WHERE nrecibo IN(SELECT nrecibo
                                FROM liquidalin
                               WHERE cempres = pemp
                                 AND nliqmen = pliq
                                 AND cagente = page)
               AND cconcep = 4;
         ELSE
            v_iva_norecuperable := 0;
         END IF;
      END IF;

      RETURN v_iva_norecuperable;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_ivanorecuperable;

   /*************************************************************************
    Libro de compras, IVA recuperable
   -- bug 0028554 - 06/02/2014 - JMF
   *************************************************************************/
   FUNCTION f_lc_ivarecuperable(
      psidepag IN NUMBER,
      pliq IN NUMBER,
      page IN NUMBER,
      pemp IN NUMBER)
      RETURN NUMBER IS
      --
      vobj           VARCHAR2(200) := 'PAC_INFORMES_152.f_lc_ivarecuperable';
      vpar           VARCHAR2(1000)
                       := ' p=' || psidepag || ' l=' || pliq || ' a=' || page || ' e=' || pemp;
      v_lin          NUMBER := 0;
      --
      v_iva_recuperable NUMBER;
   BEGIN
      v_lin := 100;
      v_iva_recuperable := 0;

      IF psidepag IS NOT NULL THEN
         v_lin := 110;

         SELECT SUM(iiva)
           INTO v_iva_recuperable
           FROM sin_tramita_pago_gar
          WHERE 0 < (SELECT COUNT(DISTINCT ctipres || nmovres || norden)
                       FROM sin_tramita_pago_gar
                      WHERE sidepag = psidepag
                        AND iiva <> 0)
            AND 1 = (SELECT DECODE(COUNT(DISTINCT ctipres || nmovres || norden),
                                   SUM(DECODE(iiva, 0, 0, 1)), 1,
                                   0)
                       FROM sin_tramita_pago_gar
                      WHERE sidepag = psidepag)
            AND sidepag = psidepag;
      ELSE
         -- iva recuperable
         v_lin := 120;

         SELECT SUM(iconcep_monpol)
           INTO v_iva_recuperable
           FROM detrecibos a
          WHERE nrecibo IN(SELECT nrecibo
                             FROM liquidalin
                            WHERE cempres = pemp
                              AND nliqmen = pliq
                              AND cagente = page)
            AND cconcep = 4
            AND 0 < (SELECT COUNT(1)
                       FROM detrecibos b
                      WHERE b.nrecibo = a.nrecibo
                        AND cconcep = 4)
            AND 1 = (SELECT DECODE(COUNT(DISTINCT cgarant),
                                   SUM(DECODE(cconcep, 4, 1, 0)), 1,
                                   0)
                       FROM detrecibos c
                      WHERE c.nrecibo = a.nrecibo);
      END IF;

      RETURN v_iva_recuperable;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, vobj, v_lin, vpar, SQLCODE || ' ' || SQLERRM);
         RETURN 0;
   END f_lc_ivarecuperable;

   /******************************************************************************************
     Descripció: Cabecera del map 757 - Libro de compras
     return:     texto cabecera
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_757_cab(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_757_CAB';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 130;
      v_ttexto := 'select' || ' f_axis_literales(9905416, ' || v_idi || ') '
                  || v_sep   -- Rut Proveedor
                          || ' f_axis_literales(9904620, ' || v_idi || ') ' || v_sep   -- DV
                  || ' f_axis_literales(9905439, ' || v_idi || ') ' || v_sep   -- Proveedor
                  || ' f_axis_literales(0150996, ' || v_idi || ') ' || v_sep   -- Tipo documento
                  || ' f_axis_literales(9905397, ' || v_idi || ') ' || v_sep   -- Núm. Documento
                  || ' f_axis_literales(1000562, ' || v_idi || ') ' || v_sep   -- Fecha emision
                  || ' f_axis_literales(9905550, ' || v_idi || ') ' || v_sep   -- Tasa impuesto
                  || ' f_axis_literales(9905417, ' || v_idi || ') '
                  || v_sep   -- Código no recuperable
                          || ' f_axis_literales(9905412, ' || v_idi || ') '
                  || v_sep   -- Monto afecto
                          || ' f_axis_literales(9905413, ' || v_idi || ') '
                  || v_sep   -- Monto exento
                          || ' f_axis_literales(9905445, ' || v_idi || ') '
                  || v_sep   -- IVA Recuperable
                          || ' f_axis_literales(9905447, ' || v_idi || ') '
                  || v_sep   -- IVA No Recup
                          || ' f_axis_literales(9905448, ' || v_idi || ') '
                  || v_sep   -- IVA Uso Común
                          || ' f_axis_literales(1000529, ' || v_idi || ') ' || v_sep   -- Total
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_757_cab;

   /******************************************************************************************
     Descripció: Detalle del map 757 - Libro de compras
     return:     texto detalle
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_757_det(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_757_DET';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || '000000' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 120;
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 130;
      v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 140;
      v_ttexto :=
         'select nnumide' || v_sep || ' TDIGITOIDE' || v_sep || ' Proveedor' || v_sep
         || ' TipoDocumento' || v_sep || ' NFACREF' || v_sep || ' FFACREF' || v_sep
         || ' TasaImpuesto' || v_sep || ' CodigoNorecuperable' || v_sep || ' MontoAfecto'
         || v_sep || ' MontoExento' || v_sep || ' IvaRecuperable' || v_sep
         || ' IvaNorecuperable' || v_sep || ' IvaComun' || v_sep || ' Total' || v_sep
         || CHR(39) || CHR(39) || ' linea' || ' from ('
                                                       -- Siniestros
         || ' select b.nnumide, b.TDIGITOIDE,'
         || ' c.tnombre||'' ''||c.tapelli1||'' ''||c.tapelli2 Proveedor,'
         || ' ff_desvalorfijo(1140,' || v_idi || ',decode(a.IIVA,0,3,1)) TipoDocumento,'
         || ' a.NFACREF,' || ' a.FFACREF,' || ' 19 TasaImpuesto,'
         || ' PAC_INFORMES_152.f_lc_codnorecuperable(a.sidepag,null,null) CodigoNorecuperable,'
         || ' PAC_INFORMES_152.f_lc_calmontoafecto (a.sidepag, null, null, null) MontoAfecto,'
         || ' PAC_INFORMES_152.f_lc_calmontoexento (a.sidepag, null, null, null) MontoExento,'
         || ' PAC_INFORMES_152.f_lc_ivarecuperable (a.sidepag, null, null, null) IvaRecuperable,'
         || ' PAC_INFORMES_152.f_lc_ivanorecuperable (a.sidepag, null, null, null, null) IvaNorecuperable,'
         || ' PAC_INFORMES_152.f_lc_ivacomun (a.sidepag, null, null, null) IvaComun,'
         || ' (nvl(PAC_INFORMES_152.f_lc_calmontoafecto (a.sidepag, null, null, null),0) +'
         || ' nvl(PAC_INFORMES_152.f_lc_calmontoexento (a.sidepag, null, null, null),0) +'
         || ' nvl(PAC_INFORMES_152.f_lc_ivarecuperable (a.sidepag, null, null, null),0) +'
         || ' nvl(PAC_INFORMES_152.f_lc_ivanorecuperable (a.sidepag, null, null, null, null),0) +'
         || ' nvl(PAC_INFORMES_152.f_lc_ivacomun (a.sidepag, null, null, null),0)'
         || ' ) total' || ' from  sin_tramita_pago a, per_personas b, per_detper c'
         || ' where b.sperson=a.sperson' || ' and   c.sperson=a.sperson'
         || ' and   c.cagente=(select max(c1.cagente) from per_detper c1'
         || '                  where c1.SPERSON=a.sperson'
         || '                  and   c1.FMOVIMI=(select max(c2.FMOVIMI) from per_detper c2'
         || '                                     where c2.sperson=a.sperson'
         || '                                   )' || '                 )'
         || ' and   a.NFACREF is not null' || ' and   a.FFACREF between ' || v_ini || ' and '
         || v_fin || ' UNION'
                             -- Liquidaciones
         || ' select b.nnumide, b.TDIGITOIDE,'
         || '        c.tnombre||'' ''||c.tapelli1||'' ''||c.tapelli2 Proveedor,'
         || '        ff_desvalorfijo(1140,3,f.ctipdoc) TipoDocumento,' || '        f.nfact,'
         || '        f.FFACT,' || '        19 TasaImpuesto,'
         || '        PAC_INFORMES_152.f_lc_codnorecuperable(null,f.nfact,f.cagente) CodigoNorecuperable,'
         || '        PAC_INFORMES_152.f_lc_calmontoafecto (null, f.NLIQMEN , f.cagente, f.cempres) MontoAfecto,'
         || '        PAC_INFORMES_152.f_lc_calmontoexento (null, f.NLIQMEN, f.cagente, f.cempres) MontoExento,'
         || '        PAC_INFORMES_152.f_lc_ivarecuperable (null, f.NLIQMEN, f.cagente, f.cempres) IvaRecuperable,'
         || '        PAC_INFORMES_152.f_lc_ivanorecuperable (null, f.nfact, f.NLIQMEN, f.cagente, f.cempres) IvaNorecuperable,'
         || '        PAC_INFORMES_152.f_lc_ivacomun (null, f.NLIQMEN, f.cagente, f.cempres) IvaComun,'
         || '        (nvl(PAC_INFORMES_152.f_lc_calmontoafecto (null, f.NLIQMEN , f.cagente, f.cempres),0) +'
         || '        nvl(PAC_INFORMES_152.f_lc_calmontoexento (null, f.NLIQMEN, f.cagente, f.cempres),0) +'
         || '        nvl(PAC_INFORMES_152.f_lc_ivarecuperable (null, f.NLIQMEN, f.cagente, f.cempres),0) +'
         || '        nvl(PAC_INFORMES_152.f_lc_ivanorecuperable (null, f.nfact, f.NLIQMEN, f.cagente, f.cempres),0) +'
         || '        nvl(PAC_INFORMES_152.f_lc_ivacomun (null, f.NLIQMEN, f.cagente, f.cempres),0)'
         || '        ) total' || ' from  facturas f, agentes a, per_personas b, per_detper c'
         || ' where f.CTIPFACT = 0' || ' and   a.CAGENTE=f.CAGENTE'
         || ' and   b.sperson=a.sperson' || ' and   c.sperson=a.sperson'
         || ' and   c.cagente=(select max(c1.cagente) from per_detper c1'
         || '                   where c1.SPERSON=a.sperson'
         || '                   and   c1.FMOVIMI=(select max(c2.FMOVIMI) from per_detper c2'
         || '                                     where c2.sperson=a.sperson'
         || '                                   )' || '                 )'
         || ' and   f.FFACT between ' || v_ini || ' and ' || v_fin
                                                                  --
         || ')';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_757_det;

   /******************************************************************************************
     Descripció: Cabecera del map 758 - Libro retencion de honorarios
     return:     texto cabecera
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_758_cab(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_758_CAB';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ttexto := 'select' || ' f_axis_literales(9905416, ' || v_idi || ') '
                  || v_sep   -- Rut Proveedor
                          || ' f_axis_literales(9904620, ' || v_idi || ') ' || v_sep   -- DV
                  || ' f_axis_literales(9906498, ' || v_idi || ') ' || v_sep   -- Prestador
                  || ' f_axis_literales(9906499, ' || v_idi || ') ' || v_sep   -- Número boleta
                  || ' f_axis_literales(9900821, ' || v_idi || ') ' || v_sep   -- Sistema
                  || ' f_axis_literales(9902824, ' || v_idi || ') ' || v_sep   -- Importe bruto
                  || ' f_axis_literales(9001030, ' || v_idi || ') '
                  || v_sep   -- Importe retención
                          || ' f_axis_literales(9904375, ' || v_idi || ') '
                  || v_sep   -- Importe líquido
                          || ' f_axis_literales(9906500, ' || v_idi || ') '
                  || v_sep   -- Fecha boleta
                          || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_758_cab;

   /******************************************************************************************
     Descripció: Detalle del map 758 - Libro retencion de honorarios
     return:     texto detalle
   -- bug 26430 - 11/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_758_det(pidioma IN NUMBER, fecha_desde IN VARCHAR2, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_758_DET';
      v_tparam       VARCHAR2(1000)
                            := 'i=' || pidioma || ' d=' || fecha_desde || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || fecha_desde || '000000' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 120;
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 130;
      v_emp := NVL(f_empres, f_parinstalacion_n('EMPRESADEF'));
      v_ntraza := 144;
      v_ttexto :=
         'select RUT' || v_sep || ' DV' || v_sep || ' Prestador' || v_sep || ' NumBoleta'
         || v_sep || ' Sistema' || v_sep || ' ImpBruto' || v_sep || ' ImpuestoRetencion'
         || v_sep || ' ImporteLiquido' || v_sep || ' FFACT' || v_sep || CHR(39) || CHR(39)
         || ' linea' || ' from ('
         -- Libro retencion de honorarios
         || ' select g.NNUMIDE RUT, g.TDIGITOIDE DV, h.tnombre||'' ''||h.tapelli1||'' ''||h.tapelli2 Prestador,'
         || '        f.NFACT NumBoleta, ''iAXIS'' Sistema, i.IIMPORTE ImpBruto,'
         || '        (i.IIMPORTE * 10 /100) ImpuestoRetencion,'
         || '        i.IIMPORTE - (i.IIMPORTE * 10 /100) ImporteLiquido, f.FFACT'
         || ' from  facturas f, agentes a, per_regimenfiscal b'
         || '       , per_personas g, per_detper h, detfactura i'
         || ' where a.cagente=f.cagente' || ' and   b.sperson=a.sperson and b.CREGFISCAL=1'
         || ' and   g.sperson=f.sperson' || ' and   h.sperson=f.sperson'
         || ' and   i.nfact = f.nfact(+) and i.cagente = f.cagente(+)'
         || ' and   f.FFACT between ' || v_ini || ' and ' || v_fin || ' )';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_758_det;

   /******************************************************************************************
     Descripció: Cabecera del map 859 - Oficio circular 383
     return:     texto cabecera
   -- bug 0029917 - 01/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_891_cab(pidioma IN NUMBER, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_891_CAB';
      v_tparam       VARCHAR2(1000) := 'i=' || pidioma || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_aux          VARCHAR2(500);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ttexto := 'select' || ' f_axis_literales(9905180,' || v_idi || ') '
                  || v_sep   -- Línea negocio
                          || ' f_axis_literales(1000111,' || v_idi || ') '
                  || v_sep   -- Descripción del producto
                          || ' ' || CHR(39) || 'POL' || CHR(39) || ' ' || v_sep   -- POL
                  || ' ' || CHR(39) || 'CAD' || CHR(39) || ' ' || v_sep   -- CAD
                  || ' f_axis_literales(100784, ' || v_idi || ') ||' || CHR(39) || ' FECU'
                  || CHR(39) || ' ' || v_sep   -- Ramo FECU
                                            || ' f_axis_literales(100784, ' || v_idi || ') ||'
                  || CHR(39) || ' CIA' || CHR(39) || ' ' || v_sep   -- Ramo CIA
                                                                 || ' ' || CHR(39)
                  || 'FORMA CONSTITUCIÓN' || CHR(39) || ' ' || v_sep   -- FORMA CONSTITUCIÓN
                  || ' f_axis_literales(9905275,' || v_idi || ') ' || v_sep   -- Prima Directa
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_891_cab;

   /******************************************************************************************
     Descripció: Detalle del map 859 - Oficio circular 383
     return:     texto detalle
   -- bug 0029917 - 01/04/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_891_det(pidioma IN NUMBER, fecha_hasta IN VARCHAR2)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_891_DET';
      v_tparam       VARCHAR2(1000) := 'i=' || pidioma || ' h=' || fecha_hasta;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(NVL(pidioma, f_usu_idioma), 3);
      v_ntraza := 110;
      v_ini := 'TO_DATE(' || CHR(39) || '0101' || SUBSTR(fecha_hasta, 5) || '000000'
               || CHR(39) || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 120;
      v_fin := 'TO_DATE(' || CHR(39) || fecha_hasta || '235959' || CHR(39)
               || ', ''DDMMYYYYHH24MISS'')';
      v_ntraza := 144;
      v_ttexto :=
         '' || ' SELECT   ''Masivo'' ' || v_sep   --lineanegocio
         || '           f_desproducto_t(cramo, cmodali, ctipseg, ccolect, 1, 3) '
         || v_sep   -- nombreproducto
                 || '           valpol ' || v_sep   -- pol
                                                 || '           valcad ' || v_sep   -- cad
         || '           ramofecu ' || v_sep   -- ramofecu
                                           || '           cramo ' || v_sep   -- ramocia
         || '           ''Reserva de riesgo en curso y reserva de ocurridos y no reportados'' '
         || v_sep   -- formaconstitución
                 || '           SUM(imp0) '   -- pdirecta
         || '      FROM (SELECT   s.cramo, s.cmodali, s.ctipseg, s.ccolect,'
         || '                     SUM(DECODE(d.cconcep,'
         || '                                0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '                                 * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol,'
         || '                                0)) imp0,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''POL%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valpol,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''CAD%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valcad,'
         || '                     (SELECT par.cvalpar'
         || '                        FROM pargaranpro par'
         || '                       WHERE par.cramo = s.cramo'
         || '                         AND par.cmodali = s.cmodali'
         || '                         AND par.ctipseg = s.ctipseg'
         || '                         AND par.ccolect = s.ccolect'
         || '                         AND par.cactivi = s.cactivi'
         || '                         AND par.cgarant = d.cgarant'
         || '                         AND par.cpargar = ''RAMOFECU'') ramofecu'
         || '                FROM seguros s, detrecibos d, movrecibo m, recibos r, agentes_comp ac'
         || '               WHERE m.fmovdia BETWEEN ' || v_ini || ' AND ' || v_fin
         || '                 AND m.cestrec IN(0, 2)'
         || '                 AND m.cestant IN(0)'
         || '                 AND r.nrecibo = m.nrecibo'
         || '                 AND r.cestaux = 0'
         || '                 AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || '                 AND s.sseguro = r.sseguro'
         || '                 AND ac.cagente = s.cagente'
         || '                 AND d.nrecibo = r.nrecibo'
         || '                 AND d.cconcep IN(0)'
         || '            GROUP BY s.sseguro, d.cgarant, s.cramo, s.cmodali, s.ctipseg, s.ccolect, s.cactivi'
------------------------------------------------------------------------
         || '            UNION ALL'
------------------------------------------------------------------------
         || '            SELECT   s.cramo, s.cmodali, s.ctipseg, s.ccolect,'
         || '                     SUM(DECODE(d.cconcep,'
         || '                                0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '                                 * DECODE(m.cestrec, 0, 1, -1) * d.iconcep_monpol,'
         || '                                0)) imp0,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''POL%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valpol,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''CAD%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valcad,'
         || '                     (SELECT par.cvalpar'
         || '                        FROM pargaranpro par'
         || '                       WHERE par.cramo = s.cramo'
         || '                         AND par.cmodali = s.cmodali'
         || '                         AND par.ctipseg = s.ctipseg'
         || '                         AND par.ccolect = s.ccolect'
         || '                         AND par.cactivi = s.cactivi'
         || '                         AND par.cgarant = d.cgarant'
         || '                         AND par.cpargar = ''RAMOFECU'') ramofecu'
         || '                FROM seguros s, detrecibos d, movrecibo m, recibos r, agentes_comp ac'
         || '               WHERE m.fmovdia BETWEEN ' || v_ini || ' AND ' || v_fin
         || '                 AND((m.cestrec = 1)' || '                     OR(m.cestrec = 0'
         || '                        AND m.cestant = 1))'
         || '                 AND r.nrecibo = m.nrecibo'
         || '                 AND r.cestaux = 0'
         || '                 AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || '                 AND s.sseguro = r.sseguro'
         || '                 AND ac.cagente = s.cagente'
         || '                 AND NOT EXISTS(SELECT 1'
         || '                                  FROM detmovrecibo z1'
         || '                                 WHERE z1.nrecibo = r.nrecibo)'
         || '                 AND d.nrecibo = r.nrecibo'
         || '                 AND d.cconcep IN(0)'
         || '            GROUP BY s.sseguro, d.cgarant, s.cramo, s.cmodali, s.ctipseg, s.ccolect, s.cactivi'
------------------------------------------------------------------------
         || '            UNION ALL'
------------------------------------------------------------------------
         || '            SELECT   s.cramo, s.cmodali, s.ctipseg, s.ccolect,'
         || '                     SUM(DECODE(d.cconcep, 0, -d.iconcep_monpol, 0)) imp0,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''POL%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valpol,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''CAD%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valcad,'
         || '                     (SELECT par.cvalpar'
         || '                        FROM pargaranpro par'
         || '                       WHERE par.cramo = s.cramo'
         || '                         AND par.cmodali = s.cmodali'
         || '                         AND par.ctipseg = s.ctipseg'
         || '                         AND par.ccolect = s.ccolect'
         || '                         AND par.cactivi = s.cactivi'
         || '                         AND par.cgarant = d.cgarant'
         || '                         AND par.cpargar = ''RAMOFECU'') ramofecu'
         || '                FROM seguros s, detrecibos d, detmovrecibo m, recibos r, productos p,'
         || '                     agentes_comp ac, movrecibo mr'
         || '               WHERE 1 = 1' || '                 AND TRUNC(m.fmovimi) BETWEEN '
         || v_ini || ' AND ' || v_fin || '                 AND r.nrecibo = mr.nrecibo'
         || '                 AND r.cestaux = 0'
         || '                 AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || '                 AND s.sseguro = r.sseguro'
         || '                 AND p.sproduc = s.sproduc'
         || '                 AND ac.cagente = s.cagente'
         || '                 AND m.nrecibo = r.nrecibo'
         || '                 AND m.norden = 1'
         || '                 AND mr.smovrec = m.smovrec'
         || '                 AND d.nrecibo = r.nrecibo'
         || '                 AND d.cconcep IN(0)'
         || '            GROUP BY s.sseguro, d.cgarant, s.cramo, s.cmodali, s.ctipseg, s.ccolect, s.cactivi'
------------------------------------------------------------------------
         || '           UNION ALL'   ---DC01
------------------------------------------------------------------------
         || '            SELECT   s.cramo, s.cmodali, s.ctipseg, s.ccolect,'
         || '                     SUM(DECODE(d.cconcep,'
         || '                                0, DECODE(r.ctiprec, 9, -1, 13, -1, 1)'
         || '                                 * DECODE(m.cestrec, 1, 1, -1)'
         || '                                 * pac_eco_tipocambio.f_importe_cambio(mon.cmonint, ''CLP'','
         || '                                                                       cc.fcambio, d.iconcep, 1),'
         || '                                0)) imp0,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''POL%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valpol,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''CAD%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valcad,'
         || '                     (SELECT par.cvalpar'
         || '                        FROM pargaranpro par'
         || '                       WHERE par.cramo = s.cramo'
         || '                         AND par.cmodali = s.cmodali'
         || '                         AND par.ctipseg = s.ctipseg'
         || '                         AND par.ccolect = s.ccolect'
         || '                         AND par.cactivi = s.cactivi'
         || '                         AND par.cgarant = d.cgarant'
         || '                         AND par.cpargar = ''RAMOFECU'') ramofecu'
         || '                FROM seguros s, detrecibos d, movrecibo m, recibos r, ctacliente cc, monedas mon,'
         || '                     productos p' || '               WHERE s.sproduc = p.sproduc'
         || '                 AND mon.cidioma = ' || v_idi
         || '                 AND mon.cmoneda = p.cdivisa'
         || '                 AND cc.nrecibo = m.nrecibo'
         || '                 AND cc.ffecmov = TRUNC(m.fmovdia)'
         || '                 AND cc.cmovimi IN(2, 5)'
         || '                 AND r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || '                 AND m.fmovdia BETWEEN ' || v_ini || ' AND ' || v_fin
         || '                 AND s.sseguro = r.sseguro'
         || '                 AND r.nrecibo = d.nrecibo'
         || '                 AND r.nrecibo = m.nrecibo'
         || '                 AND r.cestaux = 0'
         || '                 AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49)'
         || '                 AND d.nrecibo = m.nrecibo'
         || '                 AND((m.cestrec = 1)' || '                     OR(m.cestrec = 0'
         || '                        AND m.cestant = 1))'
         || '                 AND m.nrecibo NOT IN(SELECT nrecibo'
         || '                                        FROM detmovrecibo)'
         || '            GROUP BY s.sseguro, d.cgarant, s.cramo, s.cmodali, s.ctipseg, s.ccolect, s.cactivi'
------------------------------------------------------------------------
         || '            UNION ALL'
------------------------------------------------------------------------
         || '            SELECT   s.cramo, s.cmodali, s.ctipseg, s.ccolect,'
         || '                     SUM(DECODE(d.cconcep, 0, d.iconcep_monpol, 0)) imp0,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''POL%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valpol,'
         || '                     (SELECT res.trespue'
         || '                        FROM pregungaranseg p, respuestas res'
         || '                       WHERE p.sseguro = s.sseguro'
         || '                         AND res.cpregun = p.cpregun'
         || '                         AND res.crespue = p.crespue'
         || '                         AND res.cidioma = ' || v_idi
         || '                         AND p.cgarant = d.cgarant'
         || '                         AND p.cpregun = 413'
         || '                         AND res.trespue LIKE ''CAD%'' '
         || '                         AND p.nmovimi = (SELECT MAX(nmovimi)'
         || '                                            FROM pregungaranseg p1'
         || '                                           WHERE p1.sseguro = s.sseguro'
         || '                                             AND p1.cgarant = d.cgarant'
         || '                                             AND p1.finiefe <=' || v_fin
         || '                                             AND p1.cpregun = 413)) valcad,'
         || '                     (SELECT par.cvalpar'
         || '                        FROM pargaranpro par'
         || '                       WHERE par.cramo = s.cramo'
         || '                         AND par.cmodali = s.cmodali'
         || '                         AND par.ctipseg = s.ctipseg'
         || '                         AND par.ccolect = s.ccolect'
         || '                         AND par.cactivi = s.cactivi'
         || '                         AND par.cgarant = d.cgarant'
         || '                         AND par.cpargar = ''RAMOFECU'') ramofecu'
         || '                FROM seguros s, detmovrecibo_parcial d, detmovrecibo m, recibos r'
         || '               WHERE r.ctiprec IN(0, 1, 3, 9, 13, 15)'
         || '                 AND m.fmovimi BETWEEN ' || v_ini || ' AND ' || v_fin
         || '                 AND s.sseguro = r.sseguro'
         || '                 AND r.nrecibo = d.nrecibo'
         || '                 AND r.nrecibo = m.nrecibo'
         || '                 AND r.cestaux = 0'
         || '                 AND d.cconcep IN(0, 4, 11, 17, 47, 48, 49)'
         || '                 AND d.nrecibo = m.nrecibo'
         || '                 AND d.norden = m.norden'
         || '                 AND d.smovrec = m.smovrec'
         || '            GROUP BY s.sseguro, d.cgarant, s.cramo, s.cmodali, s.ctipseg, s.ccolect, s.cactivi)'
         || '  Group By F_Desproducto_T(Cramo, Cmodali, Ctipseg, Ccolect, 1, 3), Valpol, Valcad, Ramofecu,'
         || '           cramo';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_891_det;

   /******************************************************************************************
     Descripció: Cabecera del map 728 Listado Siniestros
     return:     texto cabecera
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_893_cab(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_COLM.f_728_CAB';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' s=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
   BEGIN
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      vhasta := TO_DATE(p_fecha, 'ddmmyyyy');

      SELECT TO_NUMBER(TO_CHAR(vhasta, 'DD'))
        INTO vdia
        FROM DUAL;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(vhasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(ADD_MONTHS(vhasta, -1))
           INTO vhasta
           FROM DUAL;
      END IF;

      v_fin := TO_CHAR(vhasta, 'dd/mm/yyyy');
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905301, ' || v_idi || ') || CHR(10)||'
                  || ' f_axis_literales(101837, ' || v_idi || ')' || v_sep || CHR(39) || v_fin
                  || CHR(39)
                            -- espacios
                  || ' ||CHR(10)||' || 'f_axis_literales(100829  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001639 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(104595  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(800279  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(110278  ,' || v_idi || ')' || v_sep   -- Fecha siniestro
                  || 'f_axis_literales(9905323 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905324 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905325 ,' || v_idi || ')' || v_sep   -- Sub_Keira
                  || 'f_axis_literales(9905697 ,' || v_idi || ')' || v_sep   -- Provision retenida
                  || 'f_axis_literales(9905332 ,' || v_idi || ')' || v_sep   -- Provisión Directa
                  || 'f_axis_literales(9905333 ,' || v_idi || ')' || v_sep   -- Provisión Cedida
                  || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9905326 ,' || v_idi || ')'
                  || v_sep   -- Rut Reasegurador
                          || 'f_axis_literales(9905326 ,' || v_idi || ')'
                  || v_sep   -- Reasegurador
                          || 'f_axis_literales(9903067 ,' || v_idi
                  || ')||'' ''||f_axis_literales(9000752, ' || v_idi || ')'
                  || v_sep   -- Rut Broker
                          || 'f_axis_literales(9000752 ,' || v_idi || ')' || v_sep   -- Broker
                  || 'f_axis_literales(108645  ,' || v_idi || ')' || v_sep   -- Moneda
                  || 'f_axis_literales(9905196 ,' || v_idi || ')' || v_sep   -- Fecha denuncia
                  || 'f_axis_literales(1000575 ,' || v_idi || ')' || v_sep   -- Fecha contable
                  || CHR(39) || CHR(39) || ' linea FROM DUAL';
      -- bug 28963/0169440 - 12/03/2014 - JMF
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_893_cab;

   /******************************************************************************************
     Descripció: Detalle del map 728 Listado Siniestros
     return:     texto detalle
     -- bug 26430/141410 - 12/04/2013 - JMF
     -- bug 26430/146998 - 18/06/2013 - JMF
   ******************************************************************************************/
   FUNCTION f_893_det(p_fecha IN VARCHAR2, p_sproces IN NUMBER, p_cempres IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_COLM.f_728_DET';
      v_tparam       VARCHAR2(1000)
                                := 'f=' || p_fecha || ' s=' || p_sproces || ' e=' || p_cempres;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
      --v_emp          NUMBER;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      vrea           VARCHAR2(100);   -- Nombre tabla reaseguro
   BEGIN
      v_ntraza := 100;
      vhasta := TO_DATE(p_fecha, 'ddmmyyyy');
      v_ntraza := 110;

      SELECT TO_NUMBER(TO_CHAR(vhasta, 'DD'))
        INTO vdia
        FROM DUAL;

      v_ntraza := 120;

      SELECT TO_NUMBER(TO_CHAR(LAST_DAY(vhasta), 'DD'))
        INTO vultimodia
        FROM DUAL;

      v_ntraza := 130;

      IF vdia < vultimodia THEN
         SELECT LAST_DAY(ADD_MONTHS(vhasta, -1))
           INTO vhasta
           FROM DUAL;
      END IF;

      v_ntraza := 140;
      v_fin := 'TO_DATE(' || CHR(39) || TO_CHAR(vhasta, 'ddmmyyyy') || CHR(39)
               || ', ''DDMMYYYY'')';
      v_ntraza := 150;

      IF p_sproces IS NULL THEN
         -- Venimos de la pantalla de listados, buscamos real
         vrea := 'reaseguro';
      ELSE
         -- Venimos de impresion provisiones, buscamos primero en real y despues en previo
         v_ntraza := 160;

         SELECT NVL(MAX('reaseguro'), 'reaseguroaux')
           INTO vrea
           FROM DUAL
          WHERE EXISTS(SELECT 1
                         FROM reaseguro
                        WHERE fcierre = vhasta
                          AND sproces = p_sproces);
      END IF;

      v_ntraza := 170;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_ntraza := 180;
      v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      v_ntraza := 190;
      -- bug 28963/0169440 - 12/03/2014 - JMF : reasegurador
      v_ttexto :=
         'SELECT ' || 's.sproduc' || v_sep || 't.ttitulo' || v_sep || 's.npoliza' || v_sep
         || 's.ncertif' || v_sep || 'str.nsinies' || v_sep
                                                          -- Bug 0026430 - 11/03/2014 - JMF
         || 'si.FSINIES' || v_sep || 'ps.crespue' || v_sep   -- KeiraLinNegocio,
         || 'dp.tvalpar' || v_sep   -- Keira,
                                 || 'dp2.tvalpar' || v_sep   -- SubKeira,
         || 'pac_informes_COLM.f_provsinpag(s.sseguro, ' || v_fin || ', 3,'
         || NVL(p_sproces || '', 'null') || ')' || v_sep   -- provision_total,
         || 'pac_informes_COLM.f_provsinpag(s.sseguro, ' || v_fin || ', 1,'
         || NVL(p_sproces || '', 'null') || ')' || v_sep   -- provision_directa
         || 'pac_informes_COLM.f_provsinpag(s.sseguro, ' || v_fin || ', 2,'
         || NVL(p_sproces || '', 'null') || ')' || v_sep   -- provision_cedida
                                                        || '('
         || ' SELECT MAX(p1.nnumide||Decode(P1.Tdigitoide, Null, Null, ''-'' || P1.Tdigitoide))'
         || v_sep || ' Max(tcompani) ' || v_sep || CHR(39) || CHR(39)
         || ' FROM companias c, liqresreaaux r, per_personas p1'
         || ' WHERE r.sseguro = si.sseguro' || ' AND r.nsinies = si.nsinies'
         || ' And C.Ccompani = R.Ccompani' || ' AND p1.sperson = c.sperson'
         || ')||'   -- reasegurador,
                 || '('
         || ' select max(p3.NNUMIDE||decode(p3.TDIGITOIDE,null,null,''-''||p3.TDIGITOIDE))'
         || v_sep || 'max(p4.TAPELLI1||'' ''||p4.TAPELLI2)' || v_sep || CHR(39) || CHR(39)
         || ' from  ctatecnica c1, companias c2, per_personas p3, per_detper p4, ' || vrea
         || ' r' || ' where r.sseguro=si.sseguro and r.nsinies=si.nsinies'
         || ' and   c1.ccompani=r.ccompani' || ' and   c1.nversio=r.nversio'
         || ' and   c1.scontra=r.SCONTRA' || ' and   c1.CTRAMO=r.CTRAMO'
         || ' and   c1.sproduc=s.sproduc' || ' and   c2.ccompani=c1.ccorred'
         || ' and   p3.sperson=c2.sperson' || ' and   p4.sperson=p3.sperson'
         || ' and   p4.FMOVIMI=(select max(p44.fmovimi) from per_detper p44 where p44.sperson=p4.sperson)'
         || ')||'   -- broker,
                 || '(select max(tdescri) from monedas where cidioma=' || v_idi
         || ' and cmoneda=p.cdivisa)' || v_sep   -- divisa
                                              || 'si.FSINIES' || v_sep || 'str.fcontab'
         || v_sep   -- contable
                 || CHR(39) || CHR(39) || ' linea'
         || ' from seguros s, titulopro t, productos p, pregunpolseg ps, pargaranpro pg,detparam dp,pargaranpro pg2,detparam dp2'
         || '      , sin_tramita_reserva str, sin_siniestro si' || ' where  s.cempres='
         || v_emp || ' AND    si.FSINIES <= ' || v_fin
         || ' and    si.sseguro=s.sseguro and str.nsinies=si.nsinies'
         || ' AND    t.cramo=s.cramo  AND t.cmodali=s.cmodali AND t.ctipseg=s.ctipseg  AND t.ccolect=s.ccolect'
         || ' and    t.cidioma=' || v_idi || ' and p.sproduc = s.sproduc'
         || ' and ps.sseguro = s.sseguro'
         -- bug 26422 dcg 7-5-2013
         --|| ' and ps.nmovimi = (select max(z.nmovimi) from pregunpolseg z where z.sseguro=ps.sseguro and z.cpregun=ps.cpregun)'
         --bug 26422 jmf 10-5-2013 || ' and ps.nmovimi = (select max(nmovimi) from pregunpolseg where sseguro=ps.sseguro and cpregun=414 and nmovimi <= (select max(z.nmovimi) from movseguro z where z.sseguro=ps.sseguro and z.cpregun=ps.cpregun))'
         || ' and ps.nmovimi = (select max(nmovimi) from pregunpolseg where sseguro=ps.sseguro and cpregun=414 and nmovimi <= (select max(z.nmovimi) from movseguro z where z.sseguro=ps.sseguro))'
         || ' and ps.cpregun = 414' || ' and pg.cmodali = s.cmodali'
         || ' and pg.ctipseg = s.ctipseg' || ' and pg.ccolect = s.ccolect'
         || ' and pg.cactivi = s.cactivi' || ' and pg.sproduc = s.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg.cramo=s.cramo and pg.cmodali=s.cmodali and pg.CTIPSEG=s.ctipseg and pg.CCOLECT=s.CCOLECT'
         || ' and pg.cpargar = ''SUBCLAKEIRA'' and dp.cparam = pg.cpargar'
         || ' and dp.cidioma =' || v_idi || ' and dp.cvalpar = pg.cvalpar'
         || ' and pg2.cmodali = s.cmodali' || ' and pg2.ctipseg = s.ctipseg'
         || ' and pg2.ccolect = s.ccolect' || ' and pg2.cactivi =  s.cactivi'
         || ' and pg2.sproduc = s.sproduc'
         -- Bug 26430 - 25/09/2013 - JMF: Rendimiento
         || ' and pg2.cramo=s.cramo and pg2.cmodali=s.cmodali and pg2.CTIPSEG=s.ctipseg and pg2.CCOLECT=s.CCOLECT'
         || ' and pg2.cpargar = ''CLAKEIRARAMO'' and dp2.cparam = pg2.cpargar'
         || ' and dp2.cidioma = ' || v_idi || ' and dp2.cvalpar = pg2.cvalpar'
         || ' and (str.ntramit,str.nmovres) = (select min(z_str.ntramit),min(z_str.nmovres) from sin_tramita_reserva z_str where z_str.nsinies = str.nsinies)'
         || ' and str.cgarant = pg.cgarant' || ' and str.cgarant = pg2.cgarant'
         || ' and pg2.cgarant = (select nvl(str.cgarant,min(gar.cgarant)) from garanseg gar where gar.sseguro = s.sseguro)'
         || ' and pg.cgarant  = pg2.cgarant';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_893_det;

   FUNCTION f_894_cab(
      p_fhasta IN VARCHAR2,
      p_sproces IN NUMBER,
      p_cempres IN NUMBER,
      p_fdesde IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_COLM.f_744_CAB';
      v_tparam       VARCHAR2(1000)
          := 'h=' || p_fhasta || ' s=' || p_sproces || ' e=' || p_cempres || ' d=' || p_fdesde;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      d_desde        DATE;
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      v_ntraza := 100;

      IF p_fdesde IS NOT NULL THEN
         d_desde := TO_DATE(p_fdesde, 'DDMMYYYY');
      ELSE
         -- si no esta informada, asignamos el primer dia del mes
         d_desde := TO_DATE('01' || TO_CHAR(TO_DATE(p_fhasta, 'DDMMYYYY'), 'mmyyyy'),
                            'ddmmyyyy');
      END IF;

      v_ntraza := 110;
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_ntraza := 120;
      v_ini := TO_CHAR(d_desde, 'dd/mm/yyyy');
      v_fin := TO_CHAR(TO_DATE(p_fhasta, 'DDMMYYYY'), 'dd/mm/yyyy');
      v_ntraza := 130;
      v_ttexto := 'select'
                          -- nombre listado
                  || ' f_axis_literales(9905472, ' || v_idi || ') || CHR(10)||'
                  || ' f_axis_literales(9902360, ' || v_idi || ')' || v_sep || CHR(39) || v_ini
                  || CHR(39) || v_sep || ' f_axis_literales(9902361, ' || v_idi || ')' || v_sep
                  || CHR(39) || v_fin || CHR(39) || ' ||CHR(10)||'
                  -- espacios
                  || 'f_axis_literales(9000531 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100584  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903912 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903913 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905200 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903357 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(108243  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(108246  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905474 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000992 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(109792  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905201 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905202 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(108243  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(108246  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905475 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(151463  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101300  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100784  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905562 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000716 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000717 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902307 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905478 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9903835 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9901533 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(111838  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000553 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101573  ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902938 ,' || v_idi || ')' || v_sep
                  -- Importes
                  || 'f_axis_literales(9905684 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' MO'
                  || CHR(39) || v_sep || 'f_axis_literales(1000530 ,' || v_idi || ')||'
                  || CHR(39) || ' MO' || CHR(39) || v_sep || 'f_axis_literales(1000530 ,'
                  || v_idi || ')||' || CHR(39) || ' ' || CHR(39)
                  || '||f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' MO'
                  || CHR(39) || v_sep || 'f_axis_literales(9905685 ,' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' Pesos'
                  || CHR(39) || v_sep || 'f_axis_literales(1000530 ,' || v_idi || ')||'
                  || CHR(39) || ' Pesos' || CHR(39) || v_sep || 'f_axis_literales(1000530 ,'
                  || v_idi || ')||' || CHR(39) || ' ' || CHR(39)
                  || '||f_axis_literales(9905434 ,' || v_idi || ')||' || CHR(39) || ' Pesos'
                  || CHR(39) || v_sep || CHR(39) || CHR(39) || ' linea FROM DUAL';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END f_894_cab;

    /******************************************************************************************
     Descripció: Detalle del map 744 Deudores primas pendientes
     return:     texto detalle
     -- bug 26430/143328 - 26/04/2013 - AMC
   ******************************************************************************************/
   FUNCTION f_894_det(
      p_fhasta IN VARCHAR2,
      p_sproces IN NUMBER,
      p_cempres IN NUMBER,
      p_fdesde IN VARCHAR2 DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_COLM.f_744_DET';
      v_tparam       VARCHAR2(1000)
          := 'h=' || p_fhasta || ' p=' || p_sproces || ' e=' || p_cempres || ' d=' || p_fdesde;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(30) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_inihms       VARCHAR2(100);
      v_finhms       VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_idi          NUMBER;
   --v_emp          NUMBER;
   BEGIN
      IF p_fdesde IS NOT NULL THEN
         v_inihms := 'TO_DATE(' || CHR(39) || p_fdesde || '000000' || CHR(39)
                     || ', ''DDMMYYYYHH24MISS'')';
      ELSE
         -- si no esta informada, asignamos el primer dia del mes
         v_inihms := 'TO_DATE(' || CHR(39) || '01'
                     || TO_CHAR(TO_DATE(p_fhasta, 'ddmmyyyy'), 'mmyyyy') || '235959'
                     || CHR(39) || ', ''DDMMYYYYHH24MISS'')';
      END IF;

      -- Bug 26430 - 18/10/2013 - JMF: filtro en femisio en lugar de fvencim
      v_fin := 'TO_DATE(' || CHR(39) || p_fhasta || CHR(39) || ', ''DDMMYYYY'')';
      v_finhms := 'TO_DATE(' || CHR(39) || p_fhasta || '235959' || CHR(39)
                  || ', ''DDMMYYYYHH24MISS'')';
      v_idi := NVL(f_usu_idioma, f_parinstalacion_n('IDIOMARTF'));
      v_emp := NVL(p_cempres, NVL(f_empres, f_parinstalacion_n('EMPRESADEF')));
      v_ttexto :=
         ' select  agente' || v_sep || 'tnomcom' || v_sep || 'comercial' || v_sep
         || 'nomcomercial' || v_sep || 'rutase' || v_sep || 'nomase' || v_sep || 'apelli1ase'
         || v_sep || 'apelli2ase' || v_sep || 'relacion' || v_sep || 'tel' || v_sep || 'mail'
         || v_sep || 'rutcontra' || v_sep || 'nomcontra' || v_sep || 'apelli1contra' || v_sep
         || 'apelli2contra' || v_sep || 'asistente' || v_sep || 'npoliza' || v_sep || 'ncertif'
         || v_sep || 'ramo' || v_sep || 'desramo' || v_sep || 'vigenciaini' || v_sep
         || 'vigenciafin' || v_sep || 'secuencia' || v_sep || 'estado' || v_sep || 'fvencin'
         || v_sep || 'fecprov' || v_sep || 'numrecibo' || v_sep || 'estdorec' || v_sep
         || 'fpagorec' || v_sep || 'formapag' || v_sep || ' sum(recibo_importe)' || v_sep
         || ' sum(recibo_iva)' || v_sep || ' sum(parcial_importe)' || v_sep
         || ' sum(parcial_iva)' || v_sep || ' sum(recibo_importe_mon)' || v_sep
         || ' sum(recibo_iva_mon)' || v_sep || ' sum(parcial_importe_mon)' || v_sep
         || ' sum(parcial_iva_mon)' || ' linea'
-------------------------------------------------
         || ' from('
         || ' SELECT h.cagente agente, k.talias tnomcom, FF_BUSCAPADRE2(16,h.cagente,6,null) comercial,'
         || ' decode(FF_BUSCAPADRE2(16,h.cagente,6,null),null,null,ff_desagente(FF_BUSCAPADRE2(16,h.cagente,6,null))) nomcomercial,'
         || ' p.nnumide || ''-'' || p.tdigitoide rutase, TRIM(i.tnombre1) || '' '' || TRIM(i.tnombre2) nomase, TRIM(i.tapelli1) apelli1ase,'
         || ' TRIM(i.tapelli2) apelli2ase, decode(p.nnumide || ''-'' || p.tdigitoide,pe.nnumide || ''-'' || pe.tdigitoide,''El mismo'',''Otro'') relacion,'
         || ' (SELECT tvalcon FROM per_contactos WHERE sperson = p.sperson AND cagente = i.cagente AND ctipcon = 1 AND ROWNUM = 1) tel,'
         || ' (SELECT tvalcon FROM per_contactos WHERE sperson = p.sperson AND cagente = i.cagente AND ctipcon = 3 AND ROWNUM = 1) mail,'
         || ' pe.nnumide || ''-'' || pe.tdigitoide rutcontra, TRIM(j.tnombre1) || '' '' || TRIM(j.tnombre2) nomcontra, TRIM(j.tapelli1) apelli1contra,'
         || ' TRIM(j.tapelli2) apelli2contra, NULL asistente, h.npoliza, h.ncertif, h.cramo ramo, ff_desramo(h.cramo, 3) desramo,'
         || ' NULL materiase, h.fefecto vigenciaini, h.fcaranu vigenciafin, NULL secuencia,'
         || ' l.tatribu estado, e.fvencim fvencin, e.nrecibo numrecibo, ff_desvalorfijo(1,3,b.cestrec) estdorec,'
         || ' TO_CHAR(b.fmovdia, ''DD/MM/YYYY'') fpagorec, ff_desvalorfijo(17, 3, h.cforpag) formapag,'
         || ' NULL rutaceptane, NULL nomaceptante, NULL apelli1aceptante, NULL apelli2aceptnte,'
         || ' pac_informes_COLM.f_fecprov (h.sproduc, e.sseguro, e.NMOVIMI, e.fefecto, '
         || v_fin || ') fecprov,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotpri recibo_importe,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * c.itotimp recibo_iva,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.imp parcial_importe,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.iva parcial_iva,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * d.itotpri recibo_importe_mon,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * d.itotimp recibo_iva_mon,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.impcon parcial_importe_mon,'
         || ' DECODE(e.ctiprec, 9, -1, 13, -1, 1) * des.ivacon parcial_iva_mon'
         || ' FROM movrecibo b, vdetrecibos c, vdetrecibos_monpol d, recibos e, riesgos f, tomadores g,'
         || ' seguros h, per_detper i, per_detper j, agentes k, detvalores l, per_personas p, per_personas pe,'
         || '  (Select   dp.Nrecibo, Sum(Decode(Cconcep, 0, dp.Iconcep, 0)) Imp, '
         || '                  Sum(Decode(Cconcep, 4, Dp.Iconcep, 0)) Iva, '
         || '                 Sum(Decode(Cconcep, 0, Dp.Iconcep_Monpol, 0)) Impcon, '
         || '                Sum(Decode(Cconcep, 4, dp.Iconcep_Monpol, 0)) Ivacon  '
         || '             FROM detmovrecibo_parcial dp, detmovrecibo d '
         || '           Where Cconcep In(0, 4) ' || '           And D.Nrecibo = Dp.Nrecibo '
         || '          And D.Norden = Dp.Norden ' || '          and fcontab < ' || v_finhms
         || '        GROUP BY dp.nrecibo) des ' || ' WHERE c.nrecibo = b.nrecibo'
         || ' and des.nrecibo(+)=e.nrecibo'
         || ' and b.smovrec = (select max(smovrec) from movrecibo where nrecibo = c.nrecibo and FMOVDIA < '
         || v_finhms || ')' || ' and b.cestrec in (0,3,4)'
         || ' AND d.nrecibo = c.nrecibo AND e.nrecibo = d.nrecibo AND f.sseguro = h.sseguro'
         || ' AND f.nriesgo = NVL(e.nriesgo,1) AND i.sperson = f.sperson AND h.sseguro = e.sseguro AND g.sseguro = h.sseguro'
         || ' AND j.sperson = g.sperson AND k.cagente = h.cagente AND l.cvalor = 61 AND l.cidioma = 3 AND l.catribu = h.csituac'
         || ' AND p.sperson = f.sperson AND pe.sperson = g.sperson'
-------------------------------------------------
         || ' )GROUP BY agente,tnomcom,comercial,nomcomercial,rutase,nomase,apelli1ase,apelli2ase,relacion,tel,mail,rutcontra,nomcontra,apelli1contra,apelli2contra,'
         || ' asistente,npoliza,ncertif,ramo,desramo,vigenciaini,vigenciafin,secuencia,estado,fvencin,numrecibo,estdorec,fpagorec,formapag,fecprov';
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_894_det;

   -- Bug 0032660/0190245 - 12/11/2014 - JMF
   -- Bug 32661/0189343 - 17/10/2014 - JMF
   -- Calcular importes medio pago efectivo del tipo saldo inicial
   FUNCTION f_get_saldocajamov(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      ptipmov IN NUMBER,
      pcmedmov IN NUMBER,
      ptipo IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_saldocajamov';
      v_tparam       VARCHAR2(1000)
         := 'u=' || pcusuari || ' f=' || pfecha || ' m=' || pcmoneop || ' t=' || ptipmov
            || ' c=' || pcmedmov || ' t=' || ptipo;
      v_ntraza       NUMBER := 0;
      v_origen       NUMBER;
      v_pesos        NUMBER;
      v_ultsec       cajamov.seqcaja%TYPE;
   BEGIN
      v_ntraza := 1;

      SELECT NVL(SUM(m.imovimi), 0), NVL(SUM(m.iimpins), 0)
        INTO v_origen, v_pesos
        FROM cajamov c, caja_datmedio m
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = ptipmov
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
         AND m.seqcaja = c.seqcaja
         AND m.cmedmov = pcmedmov;

      v_ntraza := 3;

      IF ptipo = 1 THEN
         v_ttexto := v_origen;
      ELSIF ptipo = 2 THEN
         v_ttexto := v_pesos;
      ELSE
         v_ttexto := NULL;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_saldocajamov;

   -- Bug 0032660/0190245 - 12/11/2014 - JMF
   -- Bug 32661/0189343 - 17/10/2014 - JMF
   -- Calcular importes del tipo apunte manual
   FUNCTION f_get_apuntemanual(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      ptipo IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_apuntemanual';
      v_tparam       VARCHAR2(1000)
                 := 'u=' || pcusuari || ' f=' || pfecha || ' m=' || pcmoneop || ' t=' || ptipo;
      v_ntraza       NUMBER := 0;
      v_origen       NUMBER;
      v_pesos        NUMBER;
   BEGIN
      v_ntraza := 1;

      SELECT NVL(SUM(c.imovimi), 0), NVL(SUM(c.iimpins), 0)
        INTO v_origen, v_pesos
        FROM cajamov c
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 2
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY');

      v_ntraza := 2;

      IF ptipo = 1 THEN
         v_ttexto := v_origen;
      ELSIF ptipo = 2 THEN
         v_ttexto := v_pesos;
      ELSE
         v_ttexto := NULL;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_apuntemanual;

   -- Bug 0032660/0190245 - 12/11/2014 - JMF
   -- Bug 32661/0189343 - 17/10/2014 - JMF
   -- Calcular importes medio pago efectivo o cheque, del tipo confirmacion deposito
   FUNCTION f_get_depositocajamov(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      ptipo IN NUMBER,
      pmedio IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_depositocajamov';
      v_tparam       VARCHAR2(1000)
         := 'u=' || pcusuari || ' f=' || pfecha || ' m=' || pcmoneop || ' t=' || ptipo
            || ' m=' || pmedio;
      v_ntraza       NUMBER := 0;
      v_origen       NUMBER;
      v_pesos        NUMBER;
   BEGIN
      v_ntraza := 1;

      SELECT NVL(SUM(m.imovimi), 0), NVL(SUM(m.iimpins), 0)
        INTO v_origen, v_pesos
        FROM cajamov c, caja_datmedio m
       WHERE c.cmoneop = pcmoneop
         AND c.ctipmov = 4
         AND c.cusuari = pcusuari
         AND TRUNC(c.ffecmov) = TO_DATE(pfecha, 'DDMMYYYY')
         AND m.seqcaja = c.seqcaja
         AND m.cmedmov = pmedio;

      v_ntraza := 2;

      IF ptipo = 1 THEN
         v_ttexto := v_origen;
      ELSIF ptipo = 2 THEN
         v_ttexto := v_pesos;
      ELSE
         v_ttexto := NULL;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_depositocajamov;

   -- Bug 0032660/0190245 - 12/11/2014 - JMF
   -- Bug 32661/0189343 - 17/10/2014 - JMF
   -- Calcular importes del saldo dia siguiente
   FUNCTION f_get_saldoantcajamov(
      pcusuari IN VARCHAR2,
      pfecha IN VARCHAR2,
      pcmoneop IN NUMBER,
      ptipo IN NUMBER)
      RETURN VARCHAR2 IS
      v_ttexto       VARCHAR2(100) := '';
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.f_get_saldoantcajamov';
      v_tparam       VARCHAR2(1000)
                 := 'u=' || pcusuari || ' f=' || pfecha || ' m=' || pcmoneop || ' t=' || ptipo;
      v_ntraza       NUMBER := 0;
      v_fec          VARCHAR2(100);
   BEGIN
      -- "Saldo día siguiente", resultado de la diferencia entre el total de ingresos en efectivo
      -- y la suma de los importes de confirmación de depósito en efectivo
      v_ntraza := 1;
      v_fec := TO_CHAR(TO_DATE(pfecha, 'ddmmyyyy') - 1, 'ddmmyyyy');

      IF ptipo = 1 THEN
         v_ntraza := 2;
         v_ttexto := NVL(pac_informes_152.f_get_saldocajamov(pcusuari, pfecha, pcmoneop, 3, 0,
                                                             1),
                         0)
                     + NVL(pac_informes_152.f_get_medio_origen(pcusuari, pfecha, pcmoneop, 0),
                           0)
                     + NVL(pac_informes_152.f_get_apuntemanual(pcusuari, pfecha, pcmoneop, 1),
                           0)
                     - NVL(pac_informes_152.f_get_saldocajamov(pcusuari, pfecha, pcmoneop, 4,
                                                               0, 1),
                           0);
      ELSIF ptipo = 2 THEN
         v_ntraza := 3;
         v_ttexto := NVL(pac_informes_152.f_get_saldocajamov(pcusuari, pfecha, pcmoneop, 3, 0,
                                                             2),
                         0)
                     + NVL(pac_informes_152.f_get_medio_pesos(pcusuari, pfecha, pcmoneop, 0),
                           0)
                     + NVL(pac_informes_152.f_get_apuntemanual(pcusuari, pfecha, pcmoneop, 2),
                           0)
                     - NVL(pac_informes_152.f_get_saldocajamov(pcusuari, pfecha, pcmoneop, 4,
                                                               0, 2),
                           0);
      ELSE
         v_ttexto := NULL;
      END IF;

      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN '';
   END f_get_saldoantcajamov;

    /******************************************************************************************
     Descripció: Detalle del map 908 Recibos a última situación
     return:     texto detalle
     -- Bug 0036392/0207888 - 17/06/2015 - DCG
   ******************************************************************************************/
   FUNCTION f_908_cab(p_idioma IN NUMBER)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_152.F_908_CAB';
      v_tparam       VARCHAR2(1000) := 'idi=' || p_idioma;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_idi          NUMBER;
   BEGIN
      v_ntraza := 100;
      v_idi := NVL(p_idioma, NVL(f_usu_idioma, 3));
      v_ntraza := 110;
      -- bug 26430 - 31/10/2013 - JMF: Comisiones indirectas
      v_ntraza := 130;
      v_ttexto := 'select f_axis_literales(100784, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902909, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905315, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101028, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9001875, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101168, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100883, ' || v_idi
                  || ')|| '' '' || f_axis_literales(9001875, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(109716, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(103313, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101516, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100879, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101619, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100895, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905334, ' || v_idi || ')' || v_sep   -- Recibo agrupadro
                  || 'f_axis_literales(100584, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100883, ' || v_idi
                  || ')|| '' '' || f_axis_literales(100895, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000562, ' || v_idi
                  || ')|| '' '' || f_axis_literales(100895, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100885, ' || v_idi
                  || ') || '' '' || f_axis_literales(100895, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(102302, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000842, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100563, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9905112, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000553, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(100874, ' || v_idi
                  || ') || '' '' || f_axis_literales(9001875, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9901743, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(1000575, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(101006, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9000469, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(106053, ' || v_idi || ')' || v_sep
                  || 'f_axis_literales(9902593, ' || v_idi || ')
     linea from dual';
      v_ntraza := 150;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 from dual';
   END;

    /******************************************************************************************
     Descripció: Detalle del map 908 Recibos a última situación
     return:     texto detalle
     -- Bug 0036392/0207888 - 17/06/2015 - DCG
   ******************************************************************************************/
   FUNCTION f_908_det(
      pcidioma IN NUMBER,
      pcempres IN NUMBER,
      pdesde IN VARCHAR2,
      phasta IN VARCHAR2,
      pcestrec IN NUMBER DEFAULT NULL,
      pctiprec IN NUMBER DEFAULT NULL,
      pcagente IN NUMBER DEFAULT NULL,
      pcsituac IN NUMBER DEFAULT NULL,
      pfiltro IN NUMBER DEFAULT NULL,
      psproduc IN NUMBER DEFAULT NULL,
      pnpoliza IN NUMBER DEFAULT NULL)
      RETURN VARCHAR2 IS
      v_tobjeto      VARCHAR2(100) := 'PAC_INFORMES_COLM.f_908_DET';
      v_tparam       VARCHAR2(1000)
         := 'a=' || pcidioma || ' b=' || pcempres || ' c=' || pdesde || ' d=' || phasta
            || ' e=' || pcestrec || ' f=' || pctiprec || ' g=' || pcsituac || ' h=' || pfiltro
            || ' i=' || psproduc || ' j=' || pnpoliza;
      v_ntraza       NUMBER := 0;
      v_sep          VARCHAR2(50) := '||' || CHR(39) || ';' || CHR(39) || '||';
      v_ret          VARCHAR2(1) := CHR(10);
      v_init         VARCHAR2(32000);
      v_ttexto       VARCHAR2(32000);
      v_ini          VARCHAR2(100);
      v_fin          VARCHAR2(100);
      v_fil          NUMBER;
      vdia           NUMBER;
      vultimodia     NUMBER;
      vhasta         DATE;
      d_calini       DATE;
      d_calfin       DATE;
      v_subtiprec_err NUMBER;
   BEGIN
      v_ntraza := 50;
      d_calini := TO_DATE(LPAD(pdesde, 8, '0'), 'ddmmyyyy');
      v_ntraza := 60;
      d_calfin := TO_DATE(LPAD(phasta, 8, '0'), 'ddmmyyyy');
      v_ntraza := 100;
      v_ini := 'to_date(' || CHR(39) || TO_CHAR(d_calini, 'ddmmyyyy') || CHR(39)
               || ',''ddmmyyyy'')';
      v_ntraza := 110;
      v_fin := 'to_date(' || CHR(39) || TO_CHAR(d_calfin, 'ddmmyyyy') || CHR(39)
               || ',''ddmmyyyy'')';
      v_ntraza := 120;
      v_emp := f_empres;
      v_subtiprec_err := NVL(pac_parametros.f_parempresa_n(v_emp, 'SUBTIPREC_ERRONEO'),0);


      IF pfiltro IS NULL THEN
         v_fil := 0;
      ELSE
         v_fil := pfiltro;
      END IF;

      v_ntraza := 130;
      v_ttexto :=
         'SELECT ra.tramo ' || v_sep
         || ' f_desproducto_t(se.cramo, se.cmodali, se.ctipseg, se.ccolect, 1,' || pcidioma
         || ')' || v_sep
         || ' pac_isqlfor.f_dni(se.sseguro, 1, NULL) ||'' ''||
         pac_isqlfor.f_persona(se.sseguro, 1, NULL) '
         || v_sep
         || ' pac_isqlfor.f_dni(se.sseguro, 2, NULL) ||'' ''|| pac_isqlfor.f_persona(se.sseguro, 2, NULL) '
         || v_sep || ' se.npoliza
        ' || v_sep || ' se.ncertif ' || v_sep || ' se.fefecto ' || v_sep
         || ' se.fcarpro
        ' || v_sep || ' ff_desvalorfijo(17,' || pcidioma || ', se.cforpag) ' || v_sep
         || '
         ff_desvalorfijo(1026,' || pcidioma
         || ',NVL(m.ctipcob, NVL(re.ctipcob, NVL(se.ctipcob, 2))))
        ' || v_sep
         || ' (SELECT MAX(co.descripcion)
                           FROM cobbancario co
                          WHERE co.ccobban = NVL(m.ccobban, NVL(re.ccobban, se.ccobban)))
        '
         || v_sep || ' e.tempres ' || v_sep || ' re.nrecibo ' || v_sep
         || '(select nrecunif from adm_recunif where nrecibo = re.nrecibo)' || v_sep
         || ' ff_desagente(re.cagente) ' || v_sep || ' re.fefecto ' || v_sep || ' re.femisio '
         || v_sep || '
         re.fvencim ' || v_sep || ' ff_desvalorfijo(8,' || pcidioma || ', re.ctiprec) '
         || v_sep
         || ' (SELECT COUNT(*)
              FROM movrecibo
             WHERE (cestrec = 0
                    AND cestant IN(1, 3))
               AND nrecibo = re.nrecibo) '
         || v_sep
         || ' (SELECT MAX(v.itotalr)
                                                            FROM vdetrecibos v
                                                           WHERE v.nrecibo = re.nrecibo)
        '
         || v_sep
         || ' (SELECT MAX(v.itotalr)
                           FROM vdetrecibos_monpol v
                          WHERE v.nrecibo = re.nrecibo) '
         || v_sep || ' ff_desvalorfijo(1, ' || pcidioma || ', f_cestrec_mv(re.nrecibo, NULL)) '
         || v_sep || ' ff_desvalorfijo(61, ' || pcidioma || ', se.csituac) ' || v_sep
         || ' NVL((SELECT trechazo
                  FROM devbanrecibos ti, detrechazo_banco cb
                 WHERE ti.nrecibo = re.nrecibo
                   AND sdevolu = (SELECT MAX(sdevolu)
                                    FROM devbanrecibos
                                   WHERE nrecibo = re.nrecibo
                                     AND fremesa <= m.fmovini)
                   AND ti.cdevrec = cb.crechazo
                   AND ti.ccobban = cb.ccobban
                   AND cb.cempres = '
         || pcempres || '
                   AND cb.cidioma = ' || pcidioma
         || '),
               (SELECT trechazo
                  FROM devbanrecibos ti, detrechazo_banco cb, adm_recunif_his ar
                 WHERE ti.nrecibo = ar.nrecunif
                   AND sdevolu = (SELECT MAX(sdevolu)
                                    FROM devbanrecibos
                                   WHERE nrecibo = ar.nrecunif
                                     AND fremesa <= m.fmovini)
                   AND ti.cdevrec = cb.crechazo
                   AND ti.ccobban = cb.ccobban
                   AND cb.cempres = '
         || pcempres || '
                   AND cb.cidioma = ' || pcidioma
         || '
                   AND re.nrecibo = ar.nrecibo
                   AND TRUNC(m.fmovdia) = TRUNC(ar.fhis)))
        '
         || v_sep || ' m.fcontab ' || v_sep || ' m.fmovini' || v_sep
         || '(select rc.nfactura from relaciones rel, relaciones_cab rc
             where re.nrecibo = rel.nrecibo and rel.srelacion = rc.srelacion)'
         || v_sep
         || '(select rc.nmes_ano from relaciones rel, relaciones_cab rc
             where re.nrecibo = rel.nrecibo and rel.srelacion = rc.srelacion)'
         || v_sep
         || ' ff_desvalorfijo(75, ' || pcidioma || ', re.cestimp) linea
   FROM seguros se,
        agentes_agente a,
        recibos re,
        movrecibo m,
        empresas e,
        ramos ra
  WHERE se.sseguro = re.sseguro
    AND re.nrecibo = m.nrecibo
     AND ('||v_subtiprec_err||' =0 OR ('||v_subtiprec_err||'=1 AND NVL(re.csubtiprec,-1) <> 21))
    AND m.fmovfin IS NULL
    AND re.cagente = a.cagente
    AND re.cempres = a.cempres
    AND(re.cagente, re.cempres) IN(
          SELECT rc.cagente, rc.cempres
            FROM (SELECT     rc.cagente, rc.cempres
                        FROM redcomercial rc
                       WHERE rc.fmovfin IS NULL
                  START WITH rc.cagente =';

      IF pcagente IS NOT NULL THEN
         v_ttexto := v_ttexto || pcagente;
      ELSE
         v_ttexto := v_ttexto || 'ff_agente_cpolvisio(pac_user.ff_get_cagente(f_user))';
      END IF;

      v_ttexto :=
         v_ttexto
         || ' CONNECT BY PRIOR rc.cagente = rc.cpadre
                         AND PRIOR rc.fmovfin IS NULL) rc,
                 agentes_agente_pol a
           WHERE rc.cagente = a.cagente)
    AND(('
         || v_fil || ' = 0
         AND re.fefecto >= NVL(' || v_ini || ', re.fefecto)
         AND re.fefecto <= NVL(' || v_fin || ', re.fefecto))
        OR(' || v_fil || ' = 1
           AND m.fmovini >= NVL(' || v_ini || ', m.fmovini)
           AND m.fmovini <= NVL(' || v_fin || ', m.fmovini))
        OR(' || v_fil || ' = 2
           AND m.fcontab >= NVL(' || v_ini || ', fcontab)
           AND m.fcontab <= NVL(' || v_fin || ', fcontab)))
    AND re.ctiprec =';

      IF pctiprec IS NOT NULL THEN
         v_ttexto := v_ttexto || pctiprec || ' AND f_cestrec_mv(re.nrecibo, NULL) =';
      ELSE
         v_ttexto := v_ttexto || 're.ctiprec AND f_cestrec_mv(re.nrecibo, NULL) =';
      END IF;

      IF pcestrec IS NOT NULL THEN
         v_ttexto := v_ttexto || pcestrec;
      ELSE
         v_ttexto := v_ttexto || 'f_cestrec_mv(re.nrecibo, NULL)';
      END IF;

      IF pcsituac IS NOT NULL THEN
         v_ttexto := v_ttexto || ' AND se.csituac =' || pcsituac;
      ELSE
         v_ttexto := v_ttexto || ' AND se.csituac = se.csituac';
      END IF;

      v_ttexto := v_ttexto || ' AND re.cempres = ' || pcempres || ' AND e.cempres = re.cempres';

      IF psproduc IS NOT NULL THEN
         v_ttexto := v_ttexto || ' AND se.sproduc =' || psproduc;
      ELSE
         v_ttexto := v_ttexto || ' AND se.sproduc = se.sproduc';
      END IF;

      IF pnpoliza IS NOT NULL THEN
         v_ttexto := v_ttexto || ' AND se.npoliza =' || pnpoliza;
      ELSE
         v_ttexto := v_ttexto || ' AND se.npoliza = se.npoliza';
      END IF;

      v_ttexto := v_ttexto || ' AND ra.cramo = se.cramo AND ra.cidioma = ' || pcidioma;
      RETURN v_ttexto;
   EXCEPTION
      WHEN OTHERS THEN
         p_tab_error(f_sysdate, f_user, v_tobjeto, v_ntraza, v_tparam || ': Error' || SQLCODE,
                     SQLERRM);
         RETURN 'select 1 linea from dual';
   END f_908_det;
END pac_informes_152;

/

  GRANT EXECUTE ON "AXIS"."PAC_INFORMES_152" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."PAC_INFORMES_152" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."PAC_INFORMES_152" TO "PROGRAMADORESCSI";
