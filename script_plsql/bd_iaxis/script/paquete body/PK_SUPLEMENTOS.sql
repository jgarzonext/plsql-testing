/* Formatted on 2020/01/03 10:53 (Formatter Plus v4.8.8) */
CREATE OR REPLACE PACKAGE BODY pk_suplementos
AS
   /******************************************************************************
       NAME:       PK_SUPLEMENTOS
       PURPOSE:    Contiene las funciones necesarias para realizar un suplemento
       REVISIONS:
       Ver        Date        Author   Description
       ------  ----------  -------  ------------------------------------
       1.0     ??/??/????  ???      1. Created this package body.
       2.0     12/03/2009  DRA      2. 0009423: IAX - Gesti? propostes retingudes: detecci? difer?ncies al modificar capitals o afegir garanties
       3.0     17/03/2009  RSC      3. An?lisis adaptaci?n productos indexados
       4.0     03/04/2009  DRA      4. 0009217: IAX - Suplement de cl?usules
       5.0     06/05/2009  DRA      5. 0010001: IAX - Preguntes opcionals amb valors NULLS
       6.0     24/04/2009  RSC      6. 0009905: Suplemento de cambio de forma de pago diferido
       7.0     29/05/2009  ICV      7. 0008947: CRE046 - Gesti?n de cobertura Enfermedad Grave en siniestros
       8.0     09/07/2009  DRA      8. 0010519: CRE - Incidencia suplementos ramo salud (2)
       9.0     17/07/2009  DRA      9. 0010184: APR - Suplemento de cambio de recargo de fraccionamiento
       10.0    07/07/2009  RSC     10. 0010656: APR - Error en suplemento de cambio de cuenta
       11.0    26/08/2009  DRA     11. 0010985: CRE - Detectar cambios de Descuentos y Sobreprimas
       12.0    07/09/2009  DRA     12. 0011047: CRE - Suplemento Baja de Asegurado
       13.0    16/09/2009  JTS     13. 0011099: CRE - Incidencia suplemento productos de Salud
       14.0    17/09/2009  AMC     14. 11165: Se sustitu?e  T_iax_saldodeutorseg por t_iax_prestamoseg
       15.0    21/09/2009  NMM     15. 10961: CRE - Incidencia en p?liza CVC 23001722.
       16.0    06/10/2009  JMF     16. 11349: CRE - Suplemento de cartera de PPJ Din?mico
       17.0    06/10/2009  JMF     17. 10908: CRE - ULK - Parametritzaci? del suplement autom?tic d'actualitzaci? de patrimoni.
       18.0    13/10/2009  XVM     18. 0011376: CEM - Suplementos y param. DIASATRAS
       19.0    01/10/2009  DRA     19. 0011183: CRE - Suplemento de alta de asegurado ya existente
       20.0    30/10/2009  AMC     20. 11376 - CEM - Suplementos y param. DIASATRAS
       21.0    10/11/2009  AMC     21. 0011695: CEM - Fecha de efecto de los suplementos por defecto
       22.0    06/11/2009  APD     22. Bug 11595: CEM - Siniestros. Adaptaci?n al nuevo m?dulo de siniestros
       23.0    28/08/2009  DRA     23. 0010569: CRE080 - Suplementos/ Anulaciones para el producto Saldo Deutors
       24.0    31/12/2009  NMM     24. 12442: ADAPTACI? PPJ (CAGRPRO 11).
       25.0    07/01/2010  DRA     25. 0012590: CEM103 - CONSTANTS: Revisi? parametritzaci? familia de productes CONSTANTS
       26.0    26/01/2010  DRA     26. 0011737: APR - suplemento de cambio de revalorizaci?n
       27.0    27/01/2010  DRA     27. 0012421: CRE 80- Saldo deutors II
       28.0    03/02/2010  RSC     28. 0011735: APR - suplemento de modificaci?n de capital /prima
       29.0    23/02/2010  DRA     29. 0013254: Change the way of payment
       30.0    11/03/2010  MCA     30. 0012087: To change the brokers.
       31.0    17/03/2010  DRA     31. 0013685: error al introducir una aportaci?n periodica en p?liza 80000175
       32.0    25/03/2010  DRA     32. 0013888: CEM800 - Augmentar precisi? dels camps TVALORA i TVALORD (DETMOVSEGURO, ESTDETMOVSEGURO)
       33.0    12/04/2010  JMF     33. 0013392 APR - verificar el suplemento masivo de cambio de agente
       34.0    16/04/2010  DRA     34. 0013888: CEM800 - Augmentar precisi? dels camps TVALORA i TVALORD (DETMOVSEGURO, ESTDETMOVSEGURO)
       35.0    19/04/2010  DRA     35. 0014172: CEM800 - SUPLEMENTS: Error en el suplement de preguntes de p?lissa de la p?lissa 60115905.
       36.0    06/05/2010  DRA     36. 0014431: AGA016 - Suplements Llar/Comunitats/Facultatiu
       37.0    25/05/2010  JMC     37. 0014574: Modificaci?n control errores en funci?n f_validar_permite_suplemento.
       38.0    02/06/2010  JMF     38. 0014185 ENSA101 - Proceso de carga del fichero (beneficio definido)
       39.0    31/05/2010  RSC     39. 0014741: APR703 - Baja de garant?as b?sicas
       40.0    30/06/2010  DRA     40. 0014709: CEM - Cambio de forma de pago diferida
       41.0    10/06/2010  RSC     41. 0013832: APRS015 - suplemento de aportaciones ?nicas
       42.0    30/07/2010  DRA     42. 0015563: CEM - Eliminar garant?a en gesti?n de retenidas.
       43.0    31/08/2010  DRA     43. 0015684: CRE800 - Modificaci? de garanties en prop. suplement
       44.0    02/11/2010  XPL     44. 16352: CRT702 - M?dulo de Propuestas de Suplementos, -- BUG16352:XPL:02112010 INICI
       45.0    08/11/2010  APD     45. 16095: Implementacion y parametrizacion producto GROUPLIFE
       45.0    04/11/2010  DRA     45. 0015823: CRE803 - Activar suplement autom?tic fi n?mina domiciliada per al producte CV Previsi? (293)
       46.0    07/12/2010  JMP     46. 0016903: CEM - No permitir suplementos si fecha revisi?n anterior al efecto del suplemento
       47.0    20/12/2010  SMF     47. 0016961: AGA901 - Configuraci?n del producto de GENERALS ATUR
       48.0    21/12/2010  JMF     48. 0016856 CEM - Escut Amortitzaci? proc?s anual actualitzaci? de capitals
       49.0    27/12/2010  JMF     49. 0016544 AGA601 - RC Artesans
       50.0    24/01/2011  JMP     50. 0017341: Suplemento de preguntas FlexiLife
       51.0    01/02/2011  ETM     51. 0017428: AGA800 - suplement de canvi de risc
       52.0    10/03/2011  DRA     52. 0017787: CRE998 - Suplement m?ltiple en p?lisses d'estalvi
       53.0    15/03/2011  ICV     53. 0017939: CX803 - Rehabilitaci?n pago peri?dico
       54.0    18/05/2011  APD     54. 0018362: LCOL003 - Par?metros en cl?usulas y visualizaci?n cl?usulas autom?ticas
       55.0    04/07/2011  JTS     55. 0017255: CRT003 - Definir propuestas de suplementos en productos
       56.0    22/07/2011  DRA     56. 0017255: CRT003 - Definir propuestas de suplementos en productos
       57.0    18/10/2011  RSC     57. 0019504: LCOL_T003: Desarrrollo y parametrizaci?n extraprimas/sobreprimas
       58.0    27/09/2011  DRA     58. 0019069: LCOL_C001 - Co-corretaje
       59.0    08/11/2011  SMF     59. 0019808: LCOL_T004-Parametrizaci?n de suplementos
       60.0    17/11/2011  RSC     60. 0019808: LCOL_T004-Parametrizaci?n de suplementos
       61.0    02/12/2011  RSC     61. 0019808: LCOL_T004-Parametrizaci?n de suplementos
       62.0    02/12/2011  JRH     62. 0020672: Supresi?n de garant?as de asistencia
       63.0    23/01/2012  JMF     63. 0020761 LCOL_A001- Quotes targetes
       64.0    27/02/2012  APD     64. 0021121: MDP701 - TEC - DETALLE DE PRIMAS DE GARANTIAS
       65.0    24/10/2012  DCT     65. 0023860: LCOL - Parametrizaci?n y suplementos - Vida Grupo
       66.0    09/11/2012  XVM     66. 0023460: LCOL_T020-COA Suplements de Canvi de Coasseguran?a
       67.0    20/11/2012  DRA     67. 0024653: MDP - PER - Suplementos relacionados con personas.
       68.0    01/11/2012  DRA     68. 0024271: LCOL_T010-LCOL - SUPLEMENTO DE TRASLADO DE VIGENCIA
       69.0    12/12/2012  JMF     0024832 LCOL - Cartera colectivos - Procesos
       70.0    18/12/2012  APD     0024278: LCOL_T010 - Suplementos diferidos - Cartera - colectivos
       71.0    29/01/2013  JMF     0025862: LCOL: Suplemento Retorno
       72.0    16/02/2013  DRA     72. 0025583: LCOL - Revision incidencias qtracker (IV)
       73.0    27/02/2013  APD     73. 0025840: LCOL_T031-LCOL - Fase 3 - (Id 111, 112, 115) - Parametrizaci?n suplementos
       74.0    26/04/2013  JGR     74. 0026728: El suplemento 286 - Cambio/Inclusi?n domiciliaci?n bancaria no informa el campo RECIBOS.CTIPBAN
       75.0    06/05/2013  ECP     75. 0026488: LCOL_T010-LCOL - Revision incidencias qtracker (VI). Nota 143831.
       76.0    30/05/2013  ECP     76. 0026488: LCOL_T010-LCOL - Revision incidencias qtracker (VI). Nota 145539.
       77.0    14/06/2013  ECP     77. 0026488: LCOL_T010-LCOL - Revision incidencias qtracker (VI). Nota 146853
       78.0    03/07/2013  ECP     78. 0027539: LCOL_T010-LCOL - Revision incidencias qtracker (VII). Nota 148213
       79.0    12/07/2013  APD     79. 0027539: LCOL_T010-LCOL - Revision incidencias qtracker (VII). Nota 148894
       80.0    12/07/2013  ECP     80. 0027539: LCOL_T010-LCOL - Revision incidencias qtracker (VII). Nota 149070
       81.0    25/07/2013  JDS     81. 0026923: LCOL - TEC - Revisi?n Q-Trackers Fase 3A
       82.0    26/07/2013  MMM     82. 0027723: LCOL_A003-Una poliza que esta domiciliada o en tramite de respuesta no se debe modificar
       83.0    31/07/2013  DCT     83. 0027048: LCOL_T010-Revision incidencias qtracker (V)
       84.0    28/08/2013  DCT     84. 0027539: LCOL_T010-LCOL - Revision incidencias qtracker (VII)
       85.0    30/08/2013  MDS     85. 0027304: POSS518 (POSSF200)- Resolucion de Incidencias FASE 1-2: Tecnico - Rentas Vitalicias
       86.0    04/11/2013  MMS     86. 0027304: POSS518 (POSSF200)- Resolucion de Incidencias FASE 1-2: Tecnico - Rentas Vitalicias
       87.0    07/11/2013  RCL     87. 0028455: LCOL_T031- TEC - Revisi?n Q-Trackers Fase 3A II
       88.0    08/11/2013  RCL     88. 0027048: LCOL_T010-Revision incidencias qtracker (V)
       89.0    19/11/2013  RCL     89. 0028536: LCOL895-Enmascarar cuenta bancaria (suplementos) - Fase Mejoras - ID 503
       90.0    25/11/2013  JSV     90. 0027876: LCOL_F3B-Parametrizacion suplementos AUTOS COLECTIVOS (Producto AWS)
       91.0    09/12/2013  AGG     91. 0026508/0160502: POSRA400-(POSRA400)-Vida Grupo Exequias
       92.0    10/12/2013  DCT     92. 0029229 LCOL_T010-LCOL - Revision incidencias Suspensi?n / Reinicio (VIII).
       93.0    18/12/2013  JSV     93. 0029358: LCOL_T010-LCOL - Revision incidencias qtracker (VIII)
       94.0    07/01/2014  JDS     94. 0029358: LCOL_T010-LCOL - Revision incidencias qtracker (VIII)
       95.0    09/01/2014  JMG     95. 0029240: LCOL896-Soporte Cliente en Liberty (Diciembre 2013)  Nota 0161228
       96.0    21/01/2014  JTT     96. 0026501: A?adir el parametro PSSEGURO a las funciones p_recuperadescripcrespue, getvalorselect, f_grabar_detalle
       97.0    20/02/2014  JSV     97. 0029991: LCOL_T010-Revision incidencias qtracker (2014/02)
       98.0    30/04/2014  FAL     98. 0027642: RSA102 - Producto Tradicional
       99.0    27/01/2015  MDS     99. 0033346: COLM004-Parametrizaciones gen?ricas entorno de VAL
      100.0    30/01/2015  AFM    100. 0034462: Suplementos de convenios (retroactivos)
     101.0    31/08/2016  JLTS   101. CONF-233: VIGENCIA_AMPAROS_GTEC25_TRASLADOS
     102.0    01/03/2019  CES   102. TCS-1554: Convivencia Osiris iAxis
     103.0    05/04/2019  CJMR   103. IAXIS-3395: Ajuste en presentaci?n de modificaciones
     104.0    09/04/2019  CJMR   104. IAXIS-3396: Se agrega campo para ajustar cambios de fechas de vigencias
     105.0    10/05/2019  ECP    105. IAXIS -3631. Cambio de Estado cuando las p¿lizas est¿n vencidas
     106.0    18/06/2019  ROHIT   106. IAXIS 4320: Errores Ramo Cumplimiento : for adding Beneficiario anulado and Beneficiario a¿adido
     107.0    04/09/2019  CJMR    107. IAXIS-5222. Fechas de vigencia en Amparo de salarios (7005) - Cumplimiento
    108.0    23/09/2019  CJMR    108. IAXIS-5423. Ajustes deducibles.
    109.0    04/11/2019  CJMR    109. IAXIS-5428. Ajustes Corretaje
     110.0    24/12/2019  ECP     110 IAXIS-3504. Pantallas Gestión Suplementos
     111.0    27/02/2020  ECP     111. IAXIS-13001. No detecta ningun cambio al realizar endoso de cambio de preguntas y coaseguradora
     112.0    03/03/2020  ECP    112. IAXIS-6141. Deducibles para Suplementos (Endosos)
   ******************************************************************************/
   e_param_error   EXCEPTION;

   FUNCTION f_permite_este_suplemento (
      psseguro   IN   NUMBER,
      pfefecto   IN   DATE,
      pcmotmov   IN   NUMBER
   )
      RETURN NUMBER
   IS
      CURSOR selects (pcconfig IN VARCHAR2)
      IS
         SELECT   tselect
             FROM pds_supl_permite
            WHERE cconfig = pcconfig
         ORDER BY nselect;

      hay_valor     NUMBER;
      vcconfig      VARCHAR2 (100);
      vsproduc      NUMBER;
      vncertif      NUMBER;
      v_select      VARCHAR2 (6000);
      v_fefecto     DATE;
      vpasexec      NUMBER;
      v_count       NUMBER;                        -- BUG24726:DRA:04/02/2013
      v_csituac     NUMBER;                 --IAXIS-3361 -- ECP -- 10/05/2019
      hay_valores   NUMBER          := 0;    -- IAXIS-3504--ECP -- 02/01/2020
   BEGIN
      vpasexec := 1;

-- Ini IAXIS-3361 -- ECP -- 10/05/2019
      BEGIN
         SELECT sproduc, ncertif, csituac
           INTO vsproduc, vncertif, v_csituac
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            BEGIN
               SELECT sproduc, ncertif, csituac
                 INTO vsproduc, vncertif, v_csituac
                 FROM estseguros
                WHERE sseguro = psseguro;
            EXCEPTION
               WHEN OTHERS
               THEN
                  RETURN 107804;    -- Error al obtener el c?digo de producto
            END;
      END;

      vpasexec := 2;

      -- Validaci?n de fecha de efecto del movimiento (valida si paramentro de motivo de movimiento 'FFECTO_ANT' no existe o cero).
      IF v_csituac <> 3
      THEN
         IF NVL (f_parmotmov (pcmotmov, 'ULTIM_RECIBO_COBRADO', vsproduc), 0) =
                                                                            1
         THEN
            BEGIN
               vpasexec := 3;

               --- Comprobamos la fecha
               SELECT NVL (MAX (fvencim), pfefecto)
                 INTO v_fefecto
                 FROM recibos r, movrecibo m
                WHERE sseguro = psseguro
                  AND r.nrecibo = m.nrecibo
                  AND m.fmovfin IS NULL
                  AND cestrec = 1;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_fefecto := pfefecto;
            END;

            vpasexec := 4;

            IF TRUNC (pfefecto) < v_fefecto
            THEN
               RETURN 9901064;
            --la fecha no puede ser inferior al ?ltimo suplemento
            END IF;
         END IF;

         vpasexec := 5;

-- Fin IAXIS-3361 -- ECP -- 10/05/2019
    -- BUG24726:DRA:04/02/2013:Inici:Miramos si hay algun suplemento de validacion ?nica hecho
         SELECT COUNT (1)
           INTO v_count
           FROM estseguros s, pds_estsegurosupl p
          WHERE s.ssegpol = psseguro
            AND p.sseguro = s.sseguro
            AND p.cestado = 'X'
            AND p.cmotmov <> pcmotmov
            AND (   p.cmotmov IN (SELECT c.cmotmov
                                    FROM codimotmov c
                                   WHERE c.ctipval = 1)
                 OR pcmotmov IN (SELECT c.cmotmov
                                   FROM codimotmov c
                                  WHERE c.ctipval = 1)
                );

         IF v_count > 0
         THEN
            RETURN 151271;
         -- Existe una incompatibilidad entre los suplementos realizados
         END IF;

         -- BUG24726:DRA:04/02/2013:Fi
         vpasexec := 6;

         -- Validaci?n de fecha de efecto del movimiento (valida si paramentro de motivo de movimiento 'FFECTO_ANT' no existe o cero).
         IF NVL (f_parmotmov (pcmotmov, 'FEFECTO_ANT', vsproduc), 0) = 0
         THEN
            vpasexec := 7;

            --BUG 29229 - INICIO - DCT - 09/12/2013 - LCOL_T010-LCOL - Revision incidencias Suspensi?n / Reinicio (VIII). Anadir motivos 391 y 392
            --BUG27048 - INICIO - DCT - 08/11/2013 - Anadir AND mm.cmotmov NOT IN (996,997,403)
            --BUG40014 - INICIO - JMT - 30/05/2016 - Anadir  NOT IN (999)
            BEGIN
               --- Comprobamos la fecha
               -- -- CONF-274-25/11/2016-JLTS- Se adiciona pac_suspension.vcod_reinicio en lugar del 392
               IF vncertif > 0
               THEN
                  SELECT m.fefecto
                    INTO v_fefecto
                    FROM movseguro m, seguros s
                   WHERE m.sseguro = psseguro
                     AND s.sseguro = m.sseguro
                     AND nmovimi =
                            (SELECT MAX (mm.nmovimi)
                               FROM movseguro mm
                              WHERE mm.sseguro = psseguro
                                AND mm.cmovseg NOT IN (52)
                                AND mm.cmotmov NOT IN
                                       (999,
                                        996,
                                        997,
                                        403,
                                        391,
                                        pac_suspension.vcod_reinicio,
                                        261,
                                        263
                                       ));
               ELSE
                  SELECT m.fefecto
                    INTO v_fefecto
                    FROM movseguro m, seguros s
                   WHERE m.sseguro = psseguro
                     AND s.sseguro = m.sseguro
                     AND nmovimi =
                            (SELECT MAX (mm.nmovimi)
                               FROM movseguro mm
                              WHERE mm.sseguro = psseguro
                                AND mm.cmovseg NOT IN (52)
                                AND mm.cmotmov NOT IN
                                       (999,
                                        996,
                                        997,
                                        403,
                                        391,
                                        pac_suspension.vcod_reinicio,
                                        261,
                                        263
                                       ));
               END IF;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_fefecto := pfefecto;
            END;

            --BUG27048 - FIN - DCT - 08/11/2013 - Anadir AND mm.cmotmov NOT IN (996,997,403)
            --BUG 29229 - INICIO - DCT - 09/12/2013 - LCOL_T010-LCOL - Revision incidencias Suspensi?n / Reinicio (VIII). Anadir motivos 391 y 392
            vpasexec := 8;

            IF v_fefecto > TRUNC (pfefecto)
            THEN
                     p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_validar_cambios',
                      2,
                      'fechat 5 f_grabar_detalle',
                         ' psseguro-->'
                      || psseguro

                      || ' v_fefecto-->'
                      ||v_fefecto
                      || 'pfefecto '
                      || pfefecto
                     );
               RETURN 103307;
            --la fecha no puede ser inferior al ?ltimo suplemento
            END IF;
         END IF;
      END IF;

      vpasexec := 9;

      BEGIN
         SELECT p.cconfig
           INTO vcconfig
           FROM pds_supl_config p, pds_supl_cod_config pd,
                pds_config_user pds
          WHERE pds.cuser = f_user
            AND pds.cconsupl = pd.cconsupl
            AND p.cconfig = pd.cconfig
            AND sproduc = vsproduc
            --AND p.cmodo like 'SUPLEMENTO'||'%'''
            AND p.cmotmov = pcmotmov;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 180286;      -- Suplemento no permitido para este producto
      END;

--      p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_grabar_detalle',
--                         ' psseguro-->'
--                      || psseguro
--
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'vcconfig  '
--                      || vcconfig
--                     );
      hay_valor := 0;
      vpasexec := 10;

      FOR x IN selects (vcconfig)
      LOOP
         v_select := x.tselect;
         --            v_select    := REPLACE (x.tselect, ':psseguro', psseguro);
         v_select := REPLACE (v_select, ':pssegpol', psseguro);
         v_select :=
            REPLACE (v_select,
                     ':pfefecto',
                     CHR (39) || TO_CHAR (pfefecto, 'dd/mm/yyyy') || CHR (39)
                    );
         v_select := REPLACE (v_select, ':pcmotmov', pcmotmov);
--        p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_grabar_detalle',
--                         ' psseguro-->'
--                      || psseguro
--                                            || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'v_select  '
--                      || v_select
--                     );
         -- Nota:
         -- En la select de la tabla PDS_SUPL_PERMITE se utiliza el parametro :pssegpol para que la misma select
         -- funcione al llamar a la funcion F_VALIDAR_PERMITE_SUPLEMENTO
         /*
                                             {Comprobamos si se ha realizado el cambio,}
         */
         vpasexec := 11;

         EXECUTE IMMEDIATE v_select
                     USING OUT hay_valor;

--         p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_grabar_detalle',
--                         ' psseguro-->'
--                      || psseguro
--
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'hay_valor  '
--                      || hay_valor
--                     );
         IF hay_valor <> 0
         THEN
            --hay_valores := hay_valores + hay_valor;
            RETURN hay_valor;
         END IF;
      END LOOP;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_permite_este_suplemento',
                      vpasexec,
                      'Error no controlado',
                      SQLERRM
                     );
         RETURN 140999;                                 -- Error no controlado
   END f_permite_este_suplemento;

-- Ini -- ECP -- 24/12/2019
   FUNCTION f_validar_permite_suplemento (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      psproduc   IN   NUMBER,
      pdate      IN   DATE DEFAULT NULL,
      pcmodo     IN   VARCHAR2 DEFAULT 'SUPLEMENTO',
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      CURSOR motivos
      IS
         -- SELECT cmotmov, ctipo, tfecrec
         -- FROM pds_suplfecharecibo
         --WHERE sproduc = psproduc;
         SELECT   cmotmov, ctipfec, tfecrec, p.cconfig
             FROM pds_supl_config p,
                  pds_supl_cod_config pd,
                  pds_config_user pds
            WHERE pds.cuser = f_user
              AND pds.cconsupl = pd.cconsupl
              AND p.cconfig = pd.cconfig
              AND sproduc = psproduc
              AND p.cmodo LIKE pcmodo || '%'
              AND p.cmotmov = NVL (pcmotmov, cmotmov)
         ORDER BY cmotmov;                          -- BUG15563:DRA:30/07/2010

      CURSOR selects (pcconfig IN VARCHAR2)
      IS
         SELECT   tselect
             FROM pds_supl_permite
            WHERE cconfig = pcconfig
         ORDER BY nselect;

      vfsuplem      DATE;
      num_err       NUMBER;
      vssegpol      NUMBER;
      hay_valores   NUMBER                  := 0;
      hay_valor     NUMBER                  := 0;
      v_select      VARCHAR2 (6000);
      v_e           VARCHAR2 (3);
      vfsuplpds     DATE;
      vcfefecto     VARCHAR2 (100);
      vpasexec      NUMBER                  := 0;
      vnumerr       NUMBER;
      vmodfefe      NUMBER;
      vcrealiza     NUMBER;
      vparamin      tab_error.terror%TYPE;    -- Bug: 14574 - 25/05/2010 - JMC
   BEGIN
      vparamin :=
            'Parametros:'
         || CHR (13)
         || 'psseguro='
         || psseguro
         || CHR (13)
         || 'pnmovimi='
         || pnmovimi
         || CHR (13)
         || 'psproduc='
         || psproduc
         || CHR (13)
         || 'pdate='
         || TO_CHAR (pdate, 'dd/mm/yyyy')
         || CHR (13)
         || 'pcmodo='
         || pcmodo
         || CHR (13);

      BEGIN
         SELECT ssegpol
           INTO vssegpol
           FROM estseguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 101919;             --Error al leer en la tabla de seguros
      END;

      vpasexec := 1;

      FOR c IN motivos
      LOOP
         hay_valor := 0;
         hay_valores := 0;
         vpasexec := 21;

         IF pdate IS NULL
         THEN
            vpasexec := 31;

            BEGIN
               SELECT fsuplem
                 INTO vfsuplem
                 FROM pds_estsegurosupl
                WHERE sseguro = psseguro
                  AND nmovimi = pnmovimi
                  AND cmotmov = c.cmotmov;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vfsuplem := f_sysdate;
            END;
         ELSE
            vpasexec := 41;
            vfsuplem := NVL (pdate, f_sysdate);
         END IF;

         FOR x IN selects (c.cconfig)
         LOOP
            v_select := REPLACE (x.tselect, ':psseguro', psseguro);
            v_select := REPLACE (v_select, ':pssegpol', vssegpol);
            v_select := REPLACE (v_select, ':pnmovimi', pnmovimi);
            v_select :=
               REPLACE (v_select,
                        ':pfefecto',
                        CHR (39) || TO_CHAR (vfsuplem, 'dd/mm/yyyy')
                        || CHR (39)
                       );

            /*
                                                                                                                    {Comprobamos si se ha realizado el cambio,}
            */
            EXECUTE IMMEDIATE v_select
                        USING OUT hay_valor;

            IF hay_valor <> 0
            THEN
               hay_valores := hay_valores + 1;
            END IF;
         END LOOP;

         vpasexec := 2;

         --JAMF 11695
         --Debemos mirar que si no hay acci?n configurada ponga como incompatible seg?n las fechas por defecto
         --sean distintas a la que se pasa como par?metro
         IF pcmodo <> 'MODIF_PROP'
         THEN
            vmodfefe :=
               pac_cfg.f_get_user_accion_permitida
                                             
                                             --(pusuario, 'FECHA_SUPLEMENTO', 0,   --JAMF 11695
               (                              f_user,
                                              'FECHA_SUPLEMENTO',
                                              psproduc,
                                              pac_md_common.f_get_cxtempresa,
                                              vcrealiza
                                             );
            vpasexec := 3;

            IF vmodfefe = 0
            THEN
               vpasexec := 5;
               vnumerr :=
                  f_get_fsupl_pds (psproduc,
                                   vssegpol,        -- BUG14709:DRA:30/06/2010
                                   c.cmotmov,
                                   vfsuplpds,
                                   vfsuplem
                                  );                -- BUG14709:DRA:30/06/2010

               IF vnumerr <> 0
               THEN
                  RETURN vnumerr;        --Error al buscar en PDS_SUPL_CONFIG
               END IF;

               IF vfsuplem <> vfsuplpds
               THEN
                  hay_valores := hay_valores + 1;
               END IF;
            --JAMF 11695
            END IF;
         END IF;

         IF hay_valores <> 0
         THEN
            UPDATE pds_estsegurosupl
               SET cestado = 'F'                        --No se puede realizar
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND cmotmov = c.cmotmov;
         END IF;
      END LOOP;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_validar_permite_suplemento',
                      vpasexec,
                      'error no controlat',
                      SUBSTR (vparamin || SQLERRM, 1, 2500)
                     );
         RETURN 140999;
   END f_validar_permite_suplemento;

   PROCEDURE p_insdetmovseguro (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      pcmotmov   IN   NUMBER,
      pnriesgo   IN   NUMBER,
      pcgarant   IN   NUMBER,
      pantes     IN   VARCHAR2,
      pdespues   IN   VARCHAR2,
      pcpregun   IN   NUMBER DEFAULT 0
   )
   IS
      vobject    VARCHAR2 (200)   := 'p_insdetmovseguro';
      vpasexec   NUMBER           := 1;
      vantes     VARCHAR2 (32000) := SUBSTR (pantes, 1, 1000);
      vdespues   VARCHAR2 (32000) := SUBSTR (pdespues, 1, 1000);
   BEGIN
      p_tab_error (f_sysdate,
                   f_user,
                   vobject,
                   vpasexec,
                   'traza 1',
                      'psseguro '
                   || psseguro
                   || 'pnmovimi'
                   || pnmovimi
                   || ' pcmotmov-->'
                   || pcmotmov
                   || 'pnriesgo'
                   || pnriesgo
                   || 'vantes '
                   || vantes
                   || 'vdespues '
                   || vdespues
                  );
      vpasexec := 2;

      BEGIN
         INSERT INTO estdetmovseguro
                     (sseguro, nmovimi, cmotmov, nriesgo, cgarant,
                      cpregun, tvalora, tvalord
                     )
              VALUES (psseguro, pnmovimi, pcmotmov, pnriesgo, pcgarant,
                      NVL (pcpregun, 0), vantes, vdespues
                     );
      EXCEPTION
         WHEN DUP_VAL_ON_INDEX
         THEN
            vpasexec := 3;

            UPDATE estdetmovseguro
               SET tvalora = vantes,
                   -- BUG13888:DRA:25/03/2010
                   tvalord = vdespues
             -- BUG13888:DRA:25/03/2010
            WHERE  sseguro = psseguro
               AND nriesgo = pnriesgo
               AND cgarant = pcgarant
               AND cpregun = NVL (pcpregun, 0)
               AND cmotmov = pcmotmov
               AND nmovimi = pnmovimi;
         WHEN OTHERS
         THEN
            vpasexec := 4;
--                p_tab_error (f_sysdate,
--                   f_user,
--                   vobject,
--                   vpasexec,
--                   'traza 1',
--                   'psseguro '||psseguro||'pnmovimi'||pnmovimi||' pcmotmov-->'||pcmotmov||'pnriesgo'||pnriesgo||'vantes '||vantes||'vdespues '||vdespues
                  --);
      END;
   END p_insdetmovseguro;

   -- Recupera la descripci? d'una pregunta amb llista de valors asociada
   -- Bug26501 - 21/01/2014 - JTT: S'afegeix el parametre sseguro
   PROCEDURE p_recuperadescripcrespue (
      psproduc             NUMBER,
      -- BUG12590:07/01/2010:DRA:S'afegeix el sproduc
      pcpregun             NUMBER,
      ovantes     IN OUT   VARCHAR2,
      ovdespues   IN OUT   VARCHAR2,
      pcidioma             NUMBER,
      psseguro    IN       NUMBER DEFAULT NULL
   )
   IS
      retval   NUMBER;

      FUNCTION getvalorof (pcpregun NUMBER, pcrespue VARCHAR2, pidioma NUMBER)
         RETURN VARCHAR
      IS
         valof   VARCHAR2 (50);
      BEGIN
         BEGIN
            SELECT trespue
              INTO valof
              FROM respuestas rsp
             WHERE rsp.cpregun = pcpregun
               AND rsp.crespue = pcrespue
               AND rsp.cidioma = pidioma;
         EXCEPTION
            WHEN OTHERS
            THEN
               valof := pcrespue;
         END;

         RETURN valof;
      END getvalorof;

      -- Bug26501 - 21/01/2014 - JTT: S'afegeix el parametre p_sseguro
      FUNCTION getvalorselect (
         p_sproduc        NUMBER,
         -- BUG12590:07/01/2010:DRA:S'afegeix el sproduc
         p_cpregun        NUMBER,
         p_crespue        VARCHAR2,
         p_cidioma        NUMBER,
         p_sseguro   IN   NUMBER DEFAULT NULL
      )
         RETURN VARCHAR2
      IS
         w_tconsulta    codipregun.tconsulta%TYPE;
         w_codi         VARCHAR2 (100);
         w_descripcio   VARCHAR2 (500);
         cur            sys_refcursor;
         ptrespue       VARCHAR2 (500);
         -- Bug 19808 - RSC - 02/12/2011 - LCOL_T004-Parametrizaci?n de suplementos
         v_ctippre      codipregun.ctippre%TYPE;
         v_npoliza      seguros.npoliza%TYPE;
         v_cagente      seguros.cagente%TYPE;
         v_cactivi      seguros.cactivi%TYPE;
      -- Fin Bug 19808
      BEGIN
         -- Bug26501 - 21/01/2014 - JTT: recuperamos el numero de poliza
         -- PRBMANT-13 - No se realizaba bien el suplemento, a?adimos el cactivi.
         BEGIN
            SELECT npoliza, cagente, cactivi
              INTO v_npoliza, v_cagente, v_cactivi
              FROM estseguros
             WHERE sseguro = p_sseguro;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_npoliza := NULL;
         END;

         -- Bug 19808 - RSC - 02/12/2011 - LCOL_T004-Parametrizaci?n de suplementos
         SELECT tconsulta, ctippre
           INTO w_tconsulta, v_ctippre
           FROM codipregun
          WHERE cpregun = p_cpregun;

         IF INSTR (w_tconsulta, 'ORDER') != 0
         THEN
            --quitamos el order by solo si la select la tiene
            w_tconsulta :=
                     SUBSTR (w_tconsulta, 1, INSTR (w_tconsulta, 'ORDER') - 2);
         END IF;

         w_tconsulta := REPLACE (w_tconsulta, ':PMT_IDIOMA', p_cidioma);
         w_tconsulta := REPLACE (w_tconsulta, ':PMT_SPRODUC', p_sproduc);
         -- Bug26501 - 21/01/2013 - JTT: Informamos el PMT_NPOLIZA
         w_tconsulta := REPLACE (w_tconsulta, ':PMT_NPOLIZA', v_npoliza);
         w_tconsulta := REPLACE (w_tconsulta, ':PMT_CAGENTE', v_cagente);
         w_tconsulta := REPLACE (w_tconsulta, ':PMT_CACTIVI', v_cactivi);
         
         -- Ini IAXIS-13001 -- ECP -- 27/02/2020
          w_tconsulta := REPLACE (w_tconsulta, ':PMT_SSEGURO', p_sseguro);
         -- Fin IAXIS-13001 -- ECP -- 27/02/2020
         OPEN cur FOR w_tconsulta;

         FETCH cur
          INTO w_codi, w_descripcio;

         WHILE cur%FOUND
         LOOP
            -- Bug 19808 - RSC - 02/12/2011 - LCOL_T004-Parametrizaci?n de suplementos
            IF v_ctippre IN (4, 5)
            THEN
               IF w_codi = p_crespue
               THEN
                  ptrespue := SUBSTR (w_descripcio, 1, 200);
                  RETURN ptrespue;
               END IF;
            ELSE
               IF TO_NUMBER (w_codi) = TO_NUMBER (p_crespue)
               THEN
                  ptrespue := SUBSTR (w_descripcio, 1, 200);
                  RETURN ptrespue;
               END IF;
            END IF;

            -- Fin Bug 19808
            FETCH cur
             INTO w_codi, w_descripcio;
         END LOOP;

         CLOSE cur;

         RETURN '--';
      END getvalorselect;
   BEGIN
      BEGIN
         SELECT ctippre
           INTO retval
           FROM codipregun
          WHERE cpregun = pcpregun;
      EXCEPTION
         WHEN OTHERS
         THEN
            retval := -1;
      END;

      IF retval IN (1, 2)
      THEN
         -- Tipus pregunta amb llista de valors asociada
         ovantes := getvalorof (pcpregun, ovantes, pcidioma);
         ovdespues := getvalorof (pcpregun, ovdespues, pcidioma);
      ELSIF retval = 6
      THEN
         -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
         -- BUG26501 - 21/01/2014 - JTT: S'afegeix el psseguro
         ovantes :=
             getvalorselect (psproduc, pcpregun, ovantes, pcidioma, psseguro);
         ovdespues :=
            getvalorselect (psproduc, pcpregun, ovdespues, pcidioma,
                            psseguro);
      -- BUG12590:07/01/2010:DRA:Fi
      END IF;
   END p_recuperadescripcrespue;

   FUNCTION f_grabar_detalle (
      pssegpol   IN   NUMBER,
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      pcmotmov   IN   NUMBER,
      pcidioma   IN   NUMBER,
      psproduc   IN   NUMBER
   )
      RETURN NUMBER
   IS
      vantes                VARCHAR2 (32000);
      -- Bug 0014185 - 02/06/2010 - JMF
      -- Bug 0025583 - 09/06/2010 - NSS
      vdespues              VARCHAR2 (32000);
       -- Bug 0014185 - 02/06/2010 - JMF
       -- Bug 0025583 - 09/06/2010 - NSS
      --INI IAXIS-5376 AABG: Declaracion de variables para Clinical
      vantesdef             VARCHAR2 (32000)               := '';
      vdespregunta          VARCHAR2 (32000)               := '';
      vpregunta             VARCHAR2 (32000)               := '';
      vliteral              VARCHAR2 (100)                 := '';
      vtextocolumna         VARCHAR2 (1000)                := '';
      --FIN IAXIS-5376 AABG: Declaracion de variables para Clinical
      vnriesgo              NUMBER;
      vcgarant              NUMBER;
      vcempres              NUMBER;
      vcobjase              NUMBER;
      -- Bug 36596/211327 - IGIL INI
      mensajes              t_iax_mensajes;
      -- Bug 36596/211327 - IGIL FIN
      v_ctipcob_a           seguros.ctipcob%TYPE;
      v_ctipcob_d           seguros.ctipcob%TYPE;
      ccantes               seguros.cbancar%TYPE;
      ccdespues             seguros.cbancar%TYPE;
      ccantes_a             VARCHAR2 (100);
      ccantes_b             VARCHAR2 (100);
      ccantes_format        VARCHAR2 (100);
      ccdespues_a           VARCHAR2 (100);
      ccdespues_b           VARCHAR2 (100);
      ccdespues_format      VARCHAR2 (100);
      cctipbanant           seguros.ctipban%TYPE;
      cctipbandes           seguros.ctipban%TYPE;
      cclong                tipos_cuenta.longitud%TYPE;
      idiomaa               NUMBER;
      idiomad               NUMBER;
      cduracia              NUMBER;
      cduracid              NUMBER;
      crevalia              NUMBER;
      crevalid              NUMBER;
      prevalia              NUMBER;
      prevalid              NUMBER;
      irevalia              NUMBER;                -- BUG11737:DRA:26/01/2010
      irevalid              NUMBER;                -- BUG11737:DRA:26/01/2010
      vcdomicia             NUMBER;
      vcdomicid             NUMBER;
      cforpaga              NUMBER;
      cforpagd              NUMBER;
      literal               VARCHAR2 (2000);
      num_err               NUMBER;
      fcarproa              DATE;
      fcarprod              DATE;
      v_fsuplem             DATE;
      dummy                 DATE;
      pers_reg2             estpersonas%ROWTYPE;
      pers_reg              personas%ROWTYPE;
      pers_reg4             estper_detper%ROWTYPE;
      pers_reg3             per_detper%ROWTYPE;
      ptlin1                VARCHAR2 (200);
      ptlin2                VARCHAR2 (200);
      ptlin3                VARCHAR2 (200);
      literal1              VARCHAR2 (400);
      literal2              VARCHAR2 (400);
      v_crespue_a           VARCHAR2 (100);
      v_crespue_d           VARCHAR2 (100);
      v_crespue_ab          VARCHAR2 (100);
      v_crespue_db          VARCHAR2 (100);
      v_crespue_ca          VARCHAR2 (100);
      v_crespue_cb          VARCHAR2 (100);
      v_crespue_ba          VARCHAR2 (100);
      v_crespue_bc          VARCHAR2 (100);
      v_crespue_antes       NUMBER;
      v_crespue_desp        NUMBER;
      v_trespues_antes      VARCHAR2 (500);
      v_trespues_desp       VARCHAR2 (500);
      sexoa                 VARCHAR2 (40);
      sexod                 VARCHAR2 (40);
      cambio                NUMBER;
      v_csubpro             NUMBER;
      literal3              VARCHAR2 (100);
      cagentea              NUMBER;
      cagented              NUMBER;
      agentea               VARCHAR2 (150);
      agented               VARCHAR2 (150);
      vniniran              NUMBER;
      vnfinran              NUMBER;
      vppenali              NUMBER;
      vcgarant_contratada   NUMBER;
      vsperson              NUMBER;
      vmandato              VARCHAR2 (35);
      v_cgasges_a           NUMBER;
      v_cgasges_d           NUMBER;
      v_cgasred_a           NUMBER;
      v_cgasred_d           NUMBER;
      v_gestion_a           VARCHAR2 (50);
      v_gestion_d           VARCHAR2 (50);
      v_redis_a             VARCHAR2 (50);
      v_redis_d             VARCHAR2 (50);
      vcpregun              NUMBER                         := 0;
      verror                NUMBER;
      v_recargo             NUMBER (6, 2);
      v_dtocom              NUMBER (6, 2);         -- BUG10985:DRA:26/08/2009
      -- BUG10184:DRA:17/07/2009:Inici
      v_crecfra_ori         seguros.crecfra%TYPE;
      v_crecfra_des         seguros.crecfra%TYPE;
      v_trecfra_ori         VARCHAR2 (50);
      v_trecfra_des         VARCHAR2 (50);
      -- BUG10184:DRA:17/07/2009:Fi

      -- BUG10569:DRA:31/08/2009:Inici
      v_ctipimp             prestamoseg.ctipimp%TYPE;
      v_dtipimp             VARCHAR2 (100);
      v_porcen              prestamoseg.porcen%TYPE;
      v_dporcen             VARCHAR2 (100);
      v_icapmax             prestamoseg.icapmax%TYPE;
      v_dcapmax             VARCHAR2 (100);
      v_ilimite             prestamoseg.ilimite%TYPE;
      v_dlimite             VARCHAR2 (100);
      v_isaldo              prestamoseg.isaldo%TYPE;
      v_dsaldo              VARCHAR2 (100);
      v_icapaseg            prestamoseg.icapaseg%TYPE;
      v_dcapaseg            VARCHAR2 (100);
      v_existe              NUMBER;
      -- BUG10569:DRA:31/08/2009:Fi
      w_cramo               productos.cramo%TYPE;
      w_cmodali             productos.cmodali%TYPE;
      w_ctipseg             productos.ctipseg%TYPE;
      w_ccolect             productos.ccolect%TYPE;
      -- BUG14431:DRA:06/05/2010:Inici
      v_tdomici_a           sitriesgo.tdomici%TYPE;
      v_cprovin_a           sitriesgo.cprovin%TYPE;
      v_cpostal_a           sitriesgo.cpostal%TYPE;
      v_cpoblac_a           sitriesgo.cpoblac%TYPE;
      v_csiglas_a           sitriesgo.csiglas%TYPE;
      v_tnomvia_a           sitriesgo.tnomvia%TYPE;
      v_nnumvia_a           sitriesgo.nnumvia%TYPE;
      v_tcomple_a           sitriesgo.tcomple%TYPE;
      v_cciudad_a           sitriesgo.cciudad%TYPE;
      v_fgisx_a             sitriesgo.fgisx%TYPE;
      v_fgisy_a             sitriesgo.fgisy%TYPE;
      v_fgisz_a             sitriesgo.fgisz%TYPE;
      v_cvalida_a           sitriesgo.cvalida%TYPE;
      v_tdomici_d           sitriesgo.tdomici%TYPE;
      v_cprovin_d           sitriesgo.cprovin%TYPE;
      v_cpostal_d           sitriesgo.cpostal%TYPE;
      v_cpoblac_d           sitriesgo.cpoblac%TYPE;
      v_csiglas_d           sitriesgo.csiglas%TYPE;
      v_tnomvia_d           sitriesgo.tnomvia%TYPE;
      v_nnumvia_d           sitriesgo.nnumvia%TYPE;
      v_tcomple_d           sitriesgo.tcomple%TYPE;
      v_cciudad_d           sitriesgo.cciudad%TYPE;
      v_fgisx_d             sitriesgo.fgisx%TYPE;
      v_fgisy_d             sitriesgo.fgisy%TYPE;
      v_fgisz_d             sitriesgo.fgisz%TYPE;
      v_cvalida_d           sitriesgo.cvalida%TYPE;
      v_triesgo_1           VARCHAR2 (100);
      v_triesgo_2           VARCHAR2 (100);
      v_triesgo_3           VARCHAR2 (100);
      -- BUG14431:DRA:06/05/2010:Fi
      -- BUG17255:DRA:26/07/2011:Inici
      v_norden              autconductores.norden%TYPE;
      v_fnacimi             autconductores.fnacimi%TYPE;
      v_fcarnet             autconductores.fcarnet%TYPE;
      v_csexo               autconductores.csexo%TYPE;
      v_npuntos             autconductores.npuntos%TYPE;
      v_sperson_tit         benespseg.sperson_tit%TYPE;
      v_borrado             NUMBER                         := 0;
      vffinbe               benespseg.ffinben%TYPE;
      v_ffinben             benespseg.ffinben%TYPE;
      vctipben              benespseg.ctipben%TYPE;
      vcparen               benespseg.cparen%TYPE;
      vpparticip            benespseg.pparticip%TYPE;
      vnorden               NUMBER                         := 0;
      -- BUG17255:DRA:26/07/2011:Fi
      v_ncuotar_a           seguros.ncuotar%TYPE;
      v_ncuotar_d           seguros.ncuotar%TYPE;
      --BUG23860:DCT:24/10/2012:Inici
      ctipcoma              NUMBER;
      ctipcomd              NUMBER;
      comisiona             VARCHAR2 (150);
      comisiond             VARCHAR2 (150);
      --BUG23860:DCT:18/10/2012:Fin

      --BUG 23460: XVM :24/10/2012--INI
      vfinicoa              coacuadro.finicoa%TYPE;
      vfcuacoa              coacuadro.fcuacoa%TYPE;
      vffincoa              coacuadro.ffincoa%TYPE;
      vploccoa              coacuadro.ploccoa%TYPE;
      vccompan              coacuadro.ccompan%TYPE;
      vnpoliza              coacuadro.npoliza%TYPE;
      vpcescoa              coacedido.pcescoa%TYPE;
      vpcomcoa              coacedido.pcomcoa%TYPE;
      vccompans             coacedido.ccompan%TYPE;
      vpcomcon              coacedido.pcomcon%TYPE;
      vpcomgas              coacedido.pcomgas%TYPE;
      vpcesion              coacedido.pcesion%TYPE;
      vnendoso              coacuadro.nendoso%TYPE;                --CONF-249
      --BUG 23460: XVM :24/10/2012--FIN

      -- BUG24271:DRA:1/11/2012:Inici
      v_fefectoa            DATE;
      v_frenovaa            DATE;
      v_fefectod            DATE;
      v_frenovad            DATE;
      -- BUG24271:DRA:1/11/2012:Fi
      vseparador            VARCHAR2 (10);    -- Bug 25840 - APD - 19/03/2013
      v_iprianu             garanseg.iprianu%TYPE;         -- Bug 34462 - AFM
      vcestado              benespseg.cestado%TYPE;         --Bug 34907 - DCT
---------------------------
      v_cambio              NUMBER;
      -- INI BUG 647 - 13/02/2018 - JLTS
      v_fdummy01_ant        VARCHAR2 (32000);
      v_fdummy01_des        VARCHAR2 (32000);
      v_fdummy02_ant        VARCHAR2 (32000);
      v_fdummy02_des        VARCHAR2 (32000);
      v_fdummy03_ant        VARCHAR2 (32000);
      v_fdummy03_des        VARCHAR2 (32000);
      v_fdummy04_ant        VARCHAR2 (32000)               := NULL;
      v_fdummy04_des        VARCHAR2 (32000)               := NULL;
      lliteral              VARCHAR (400);
      
      

      -- FIN BUG 647 - 13/02/2018 - JLTS

      -- Bug 30642/169851 - 20/03/2014 - AMC
      CURSOR cur_comisionsegu
      IS
         SELECT *
           FROM comisionsegu
          WHERE sseguro = pssegpol AND nmovimi = (SELECT MAX (nmovimi)
                                                    FROM comisionsegu
                                                   WHERE sseguro = pssegpol);

      CURSOR cur_comisionsegu2
      IS
         SELECT *
           FROM estcomisionsegu
          WHERE sseguro = psseguro AND nmovimi = pnmovimi;

      --Fi Bug 30642/169851 - 20/03/2014 - AMC

      ------------------
      CURSOR garantias_real
      IS
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT   TO_CHAR (NVL (s.icapital, 0), 'FM999G999G999G990D00')
                                                                       antes,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        -- BUG 20672-  01/2012 - JRH  -  0020672: LCOL_T001-LCOL - UAT - TEC:Si capital vale 0 como en las de asistencia
                        AND g.cobliga = 1
                        -- Fi BUG 20672-  01/2012 - JRH
                        AND g.icapital = s.icapital)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        -- ha de trovar els canvis per preguntes
                        AND ed.cmotmov = 281)
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 9699 - APD - 23/04/2009 - fin
      CURSOR garantias_est
      IS
         SELECT   TO_CHAR (NVL (s.icapital, 0),
                           'FM999G999G999G990D00'
                          ) despues,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.icapital = s.icapital)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        -- ha de trovar els canvis per preguntes
                        AND ed.cmotmov = 281)
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      CURSOR garantias_real_not_in_246
      IS
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT   TO_CHAR (NVL (s.icapital, 0), 'FM999G999G999G990D00') antes,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NVL (f_pargaranpro_v (x.cramo,
                                        x.cmodali,
                                        x.ctipseg,
                                        x.ccolect,
                                        x.cactivi,
                                        s.cgarant,
                                        UPPER ('TIPO')
                                       ),
                       0
                      ) NOT IN (3, 4, 5)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        -- BUG 20672-  01/2012 - JRH  -  0020672: LCOL_T001-LCOL - UAT - TEC:Si capital vale 0 como en las de asistencia
                        AND g.cobliga = 1
                        -- Fi BUG 20672-  01/2012 - JRH
                        AND g.icapital = s.icapital)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        -- ha de trovar els canvis per preguntes
                        AND ed.cmotmov = 281)
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 9699 - APD - 23/04/2009 - fin
      CURSOR garantias_est_not_in_246
      IS
         SELECT   TO_CHAR (NVL (s.icapital, 0),
                           'FM999G999G999G990D00'
                          ) despues,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NVL (f_pargaranpro_v (x.cramo,
                                        x.cmodali,
                                        x.ctipseg,
                                        x.ccolect,
                                        x.cactivi,
                                        s.cgarant,
                                        UPPER ('TIPO')
                                       ),
                       0
                      ) NOT IN (3, 4, 5)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.icapital = s.icapital)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        -- ha de trovar els canvis per preguntes
                        AND ed.cmotmov = 281)
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 14741 - RSC - 07/06/2010 - APR703 - Baja de garant?as b?sicas
      CURSOR garantias_real_baja
      IS
         SELECT   0 despues, s.cgarant, s.nriesgo, s.iprianu
             FROM garanseg s
            WHERE s.sseguro = pssegpol
              AND s.ffinefe IS NULL
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1)
         ORDER BY s.norden;

      -- Fin Bug 14741

      -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
      CURSOR garantias_real_sobrepr
      IS
         SELECT   NVL (s.precarg, 0) antes, s.cgarant, s.nriesgo
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1
                        -- BUG7701:dra:10-02-2009: Para cuando se eliminan garant?as
                        AND NVL (g.precarg, 0) = NVL (s.precarg, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cmotmov = 801
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trobar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 9699 - APD - 23/04/2009 - fin
      CURSOR garantias_est_sobrepr
      IS
         SELECT   NVL (s.precarg, 0) despues, s.cgarant, s.nriesgo
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND NVL (g.precarg, 0) = NVL (s.precarg, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.cmotmov = 801
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trovar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 19504 - RSC - 18/10/2011 - LCOL_T003: Desarrrollo y parametrizaci?n extraprimas/sobreprimas
      CURSOR garantias_real_iextrap
      IS
         SELECT   NVL (s.iextrap, 0) antes, s.cgarant, s.nriesgo
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1
                        -- BUG7701:dra:10-02-2009: Para cuando se eliminan garant?as
                        AND NVL (g.iextrap, 0) = NVL (s.iextrap, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cmotmov = 801
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trobar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      CURSOR garantias_est_iextrap
      IS
         SELECT   NVL (s.iextrap, 0) despues, s.cgarant, s.nriesgo
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND NVL (g.iextrap, 0) = NVL (s.iextrap, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.cmotmov = 801
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trovar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- Fin Bug 19504

      --------------------
-- BUG10985:DRA:26/08/2009:Inici
      CURSOR garantias_real_dtocom
      IS
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT   NVL (s.pdtocom, 0) antes, s.cgarant, s.nriesgo
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1
                        -- BUG7701:dra:10-02-2009: Para cuando se eliminan garant?as
                        AND NVL (g.pdtocom, 0) = NVL (s.pdtocom, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cmotmov = 802
                        -- Bug 10961.21/09/2009.Canviem 801 per 802
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trovar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      CURSOR garantias_est_dtocom
      IS
         SELECT   NVL (s.pdtocom, 0) despues, s.cgarant, s.nriesgo
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND NVL (g.pdtocom, 0) = NVL (s.pdtocom, 0))
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.cmotmov = 802
                        -- Bug 10961.21/09/2009.Canviem 801 per 802
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              -- ha de trovar els canvis per preguntes
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- INI CONF-233 - 31/08/2016 ? JLTS ? Adicion de cursores de traslados
      CURSOR traslados_vigencia
      IS
         SELECT      'Fini: '
                  || TO_CHAR (finivig, 'DD/MM/YYYY')
                  || ' Ffin: '
                  || TO_CHAR (ffinvig, 'DD/MM/YYYY') antes,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1
                        AND g.ffinvig = s.ffinvig
                        AND g.finivig = s.finivig)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        AND ed.cmotmov = 918)
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      CURSOR traslados_vigencia_est
      IS
         SELECT      'Fini: '
                  || TO_CHAR (finivig, 'DD/MM/YYYY')
                  || ' Ffin: '
                  || TO_CHAR (ffinvig, 'DD/MM/YYYY') despues,
                  s.cgarant, s.nriesgo
             FROM estgaranseg s, estseguros x
            WHERE s.sseguro = psseguro
              AND s.nmovimi = pnmovimi
              AND s.sseguro = x.sseguro
              AND s.ctipgar <> 8
              AND s.cobliga = 1
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM garanseg g
                      WHERE g.sseguro = pssegpol
                        AND g.ffinefe IS NULL
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.ffinvig = s.ffinvig
                        AND g.finivig = s.finivig)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.cmotmov = 918
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0)
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      -- FIN CONF-233 - 25/08/2016 ? JLTS ? Adicion de cursores de traslados

      ---FAC
      CURSOR garantias_vigencia
      IS
         SELECT      'Fini: '
                  || TO_CHAR (finivig, 'DD/MM/YYYY')
                  || ' Ffin: '
                  || TO_CHAR (ffinvig, 'DD/MM/YYYY') antes,
                  s.cgarant, s.nriesgo, s.iprianu
             FROM garanseg s, garanpro e, seguros x
            WHERE s.cgarant = e.cgarant
              AND s.ffinefe IS NULL
              AND s.sseguro = pssegpol
              AND x.sseguro = s.sseguro
              AND e.ctipgar <> 8
              AND e.cgarant = s.cgarant
              AND e.sproduc = psproduc
              AND e.cactivi =
                           pac_seguros.ff_get_actividad (x.sseguro, s.nriesgo)
              AND NOT EXISTS (
                     SELECT g.cgarant
                       FROM estgaranseg g
                      WHERE g.sseguro = psseguro
                        AND g.nmovimi = pnmovimi
                        AND g.nriesgo = s.nriesgo
                        AND g.cgarant = s.cgarant
                        AND g.cobliga = 1
                        AND g.ffinvig = s.ffinvig
                        AND g.finivig = s.finivig)
              AND NOT EXISTS (
                     SELECT ed.cgarant
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = s.nriesgo
                        AND ed.cgarant = s.cgarant
                        AND ed.cpregun = 0
                        AND ed.cmotmov = 915)
              -- BUG10519:DRA:09/07/2009:Inici
              AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY s.norden;

      CURSOR garantias_vigencia_est
      IS
         SELECT 'Valor Asegurado ' || g.crespue despues, g.cgarant, g.nriesgo
           FROM estpregungaranseg g, estseguros s
          WHERE g.sseguro = psseguro
            AND g.nmovimi = pnmovimi
            AND s.sseguro = g.sseguro
            AND NVL
                   (f_pargaranpro_v
                             (s.cramo,
                              s.cmodali,
                              s.ctipseg,
                              s.ccolect,
                              s.cactivi,
                              g.cgarant,
                              UPPER (' TIPO
                                ')
                             ),
                    0
                   ) NOT IN (4, 5)
            AND g.cpregun = 2893
            AND g.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
            AND g.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         UNION
         SELECT    'Fini: '
                || TO_CHAR (finivig, 'DD/MM/YYYY')
                || ' Ffin: '
                || TO_CHAR (ffinvig, 'DD/MM/YYYY') despues,
                s.cgarant, s.nriesgo
           FROM estgaranseg s, estseguros x
          WHERE s.sseguro = psseguro
            AND s.nmovimi = pnmovimi
            AND s.sseguro = x.sseguro
            AND s.ctipgar <> 8
            AND s.cobliga = 1
            AND NOT EXISTS (
                   SELECT g.cgarant
                     FROM garanseg g
                    WHERE g.sseguro = pssegpol
                      AND g.ffinefe IS NULL
                      AND g.nriesgo = s.nriesgo
                      AND g.cgarant = s.cgarant
                      AND g.ffinvig = s.ffinvig
                      AND g.finivig = s.finivig)
            AND NOT EXISTS (
                   SELECT ed.cgarant
                     FROM estdetmovseguro ed
                    WHERE ed.sseguro = psseguro
                      AND ed.nmovimi = pnmovimi
                      AND ed.cmotmov = 915
                      -- Bug 10961.21/09/2009.Canviem 801 per 802
                      AND ed.nriesgo = s.nriesgo
                      AND ed.cgarant = s.cgarant
                      AND ed.cpregun = 0)
            -- ha de trovar els canvis per preguntes
            -- BUG10519:DRA:09/07/2009:Inici
            AND s.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
            AND s.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL);

---FAC
-- BUG10985:DRA:26/08/2009:Fi
-----------------------------------------------
/*CURSOR clausulas_esp_est IS
SELECT e.nordcla, e.tclaesp despues
  FROM estclausuesp e
 WHERE e.sseguro = psseguro
   AND e.cclaesp = 2
   AND e.ffinclau IS NULL
   AND NOT EXISTS(SELECT cclaesp
                    FROM clausuesp
                   WHERE sseguro = pssegpol
                     AND cclaesp = 2
                     AND nordcla = e.nordcla
                     AND ffinclau IS NULL)
   -- BUG10519:DRA:09/07/2009:Inici
   AND(e.nriesgo = 0
       OR(e.nriesgo IN(SELECT r.nriesgo
                         FROM riesgos r
                        WHERE r.sseguro = pssegpol
                          AND r.fanulac IS NULL)
          AND e.nriesgo IN(SELECT er.nriesgo
                             FROM estriesgos er
                            WHERE er.sseguro = psseguro
                              AND er.fanulac IS NULL)));*/

      --BUG24382:DCT:31/10/2012  No para cmotmov = 283
      CURSOR clausulas_esp_est
      IS
         SELECT   e.nordcla, e.tclaesp despues
             FROM estclausuesp e
            WHERE e.sseguro = psseguro
              AND e.cclaesp = 2
              AND e.ffinclau IS NULL
              AND pcmotmov <> 283
              AND NOT EXISTS (
                     SELECT cclaesp
                       FROM clausuesp
                      WHERE sseguro = pssegpol
                        AND cclaesp = 2
                        AND nordcla = e.nordcla
                        AND ffinclau IS NULL
                        AND pcmotmov <> 283)
              -- BUG10519:DRA:09/07/2009:Inici
              AND (   e.nriesgo = 0
                   OR (    e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                       AND e.nriesgo IN (
                              SELECT er.nriesgo
                                FROM estriesgos er
                               WHERE er.sseguro = psseguro
                                 AND er.fanulac IS NULL)
                      )
                  )
         ORDER BY e.nordcla;

      -------------------------- Beneficiarios nominales
      CURSOR clausula_bene
      IS
         SELECT 'E' tipomov, nriesgo, cgarant, sperson sperson, sperson_tit,
                finiben, ffinben, ctipben, cparen, pparticip, cestado
           FROM estbenespseg                                                 --
          WHERE sseguro = psseguro AND nmovimi = pnmovimi
         UNION
         SELECT 'A' tipomov, nriesgo, cgarant, sperson, sperson_tit, finiben,
                ffinben, ctipben, cparen, pparticip, cestado
           FROM benespseg                                                    --
          WHERE sseguro = pssegpol AND nmovimi = (SELECT MAX (nmovimi)
                                                    FROM benespseg
                                                   WHERE sseguro = pssegpol);

      -- BUG10519:DRA:09/07/2009:Fi
      -- BUG10519:DRA:09/07/2009:Fi
      /*CURSOR clausulas_esp_real IS
      SELECT e.nordcla, e.tclaesp antes
        FROM clausuesp e
       WHERE e.sseguro = pssegpol
         AND e.cclaesp = 2
         AND e.ffinclau IS NULL
         AND NOT EXISTS(SELECT cclaesp
                          FROM estclausuesp
                         WHERE sseguro = psseguro
                           AND cclaesp = 2
                           AND nordcla = e.nordcla
                           AND tclaesp = e.tclaesp
                           AND ffinclau IS NULL)
         -- BUG10519:DRA:09/07/2009:Inici
         AND(e.nriesgo = 0
             OR(e.nriesgo IN(SELECT r.nriesgo
                               FROM riesgos r
                              WHERE r.sseguro = pssegpol
                                AND r.fanulac IS NULL)
                AND e.nriesgo IN(SELECT er.nriesgo
                                   FROM estriesgos er
                                  WHERE er.sseguro = psseguro
                                    AND er.fanulac IS NULL)));*/

      --BUG24382:DCT:31/10/2012  no para cmotmov = 283
      CURSOR clausulas_esp_real
      IS
         SELECT   e.nordcla, e.tclaesp antes
             FROM clausuesp e
            WHERE e.sseguro = pssegpol
              AND e.cclaesp = 2
              AND e.ffinclau IS NULL
              AND pcmotmov <> 283
              AND NOT EXISTS (
                     SELECT cclaesp
                       FROM estclausuesp
                      WHERE sseguro = psseguro
                        AND cclaesp = 2
                        AND nordcla = e.nordcla
                        AND tclaesp = e.tclaesp
                        AND ffinclau IS NULL
                        AND pcmotmov <> 283)
              -- BUG10519:DRA:09/07/2009:Inici
              AND (   e.nriesgo = 0
                   OR (    e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                       AND e.nriesgo IN (
                              SELECT er.nriesgo
                                FROM estriesgos er
                               WHERE er.sseguro = psseguro
                                 AND er.fanulac IS NULL)
                      )
                  )
         ORDER BY e.nordcla;

      -- BUG10519:DRA:09/07/2009:Fi
      -----------------------------------------------  BUG9107:DRA:17-02-2009
      /*CURSOR clausulas_seg_est IS
      SELECT e.sclagen, g.tclatit despues
        FROM estclaususeg e, clausugen g
       WHERE e.sseguro = psseguro
         AND e.ffinclau IS NULL
         AND g.sclagen = e.sclagen
         AND g.cidioma = pcidioma
         AND NOT EXISTS(SELECT c.sclagen
                          FROM claususeg c
                         WHERE c.sseguro = pssegpol
                           AND c.ffinclau IS NULL
                           AND c.sclagen = e.sclagen);*/

      --BUG24382:DCT:31/10/2012  Si 283 multiple
      CURSOR clausulas_seg_est
      IS
         SELECT   e.sclagen, g.tclatit despues
             FROM estclaususeg e, clausugen g, clausupro p, estseguros es
            WHERE e.sseguro = psseguro
              AND e.ffinclau IS NULL
              AND g.sclagen = e.sclagen
              AND g.cidioma = pcidioma
              AND e.sseguro = es.sseguro
              AND p.cramo = es.cramo
              AND p.cmodali = es.cmodali
              AND p.ctipseg = es.ctipseg
              AND p.ccolect = es.ccolect
              AND e.sclagen = p.sclagen
              AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1)
              AND NOT EXISTS (
                     SELECT c.sclagen
                       FROM claususeg c, clausupro p, seguros s
                      WHERE c.sseguro = pssegpol
                        AND c.ffinclau IS NULL
                        AND c.sclagen = e.sclagen
                        AND c.sseguro = s.sseguro
                        AND p.cramo = s.cramo
                        AND p.cmodali = s.cmodali
                        AND p.ctipseg = s.ctipseg
                        AND p.ccolect = s.ccolect
                        AND c.sclagen = p.sclagen
                        AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1))
         ORDER BY e.nordcla;

      /*CURSOR clausulas_seg_real IS
      SELECT c.sclagen, g.tclatit antes
        FROM claususeg c, clausugen g
       WHERE c.sseguro = pssegpol
         AND c.ffinclau IS NULL
         AND g.sclagen = c.sclagen
         AND g.cidioma = pcidioma
         AND NOT EXISTS(SELECT e.sclagen
                          FROM estclaususeg e
                         WHERE e.sseguro = psseguro
                           AND e.ffinclau IS NULL
                           AND e.sclagen = c.sclagen);*/
      --BUG24382:DCT:31/10/2012  Si 283 multiple
      CURSOR clausulas_seg_real
      IS
         SELECT   c.sclagen, g.tclatit antes
             FROM claususeg c, clausugen g, clausupro p, seguros s
            WHERE c.sseguro = pssegpol
              AND c.ffinclau IS NULL
              AND g.sclagen = c.sclagen
              AND g.cidioma = pcidioma
              AND c.sseguro = s.sseguro
              AND p.cramo = s.cramo
              AND p.cmodali = s.cmodali
              AND p.ctipseg = s.ctipseg
              AND p.ccolect = s.ccolect
              AND c.sclagen = p.sclagen
              AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1)
              AND NOT EXISTS (
                     SELECT e.sclagen
                       FROM estclaususeg e, clausupro p, estseguros es
                      WHERE e.sseguro = psseguro
                        AND e.ffinclau IS NULL
                        AND e.sclagen = c.sclagen
                        AND e.sseguro = es.sseguro
                        AND p.cramo = es.cramo
                        AND p.cmodali = es.cmodali
                        AND p.ctipseg = es.ctipseg
                        AND p.ccolect = es.ccolect
                        AND e.sclagen = p.sclagen
                        AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1))
         ORDER BY c.nordcla;

----------------------------------------------------------------------
      CURSOR clausulas
      IS
         SELECT   sseguro, nriesgo
             FROM riesgos
            WHERE sseguro = pssegpol AND fanulac IS NULL
         ORDER BY nriesgo;

----------------------------------------------------------------------
-- Bug 18362 - APD - 18/05/2011 - se anaden los cursores para las
-- clausulas con parametros
/*CURSOR clauparaseg_est IS
SELECT *
  FROM estclauparaseg e
 WHERE e.sseguro = psseguro;*/

      --BUG24382:DCT:31/10/2012  Anadir clausupro.multiple=1
      CURSOR clauparaseg_est
      IS
         SELECT   e.*, c.tparame || ': ' || e.tparame tresul,
                  c.tparame tparam
             FROM estclauparaseg e, clausupro p, estseguros s, clausupara c
            WHERE e.sseguro = psseguro
              AND e.sseguro = s.sseguro
              AND p.cramo = s.cramo
              AND p.cmodali = s.cmodali
              AND p.ctipseg = s.ctipseg
              AND p.ccolect = s.ccolect
              AND e.sclagen = p.sclagen
              AND c.sclagen = e.sclagen
              AND c.cidioma = pcidioma
              AND c.nparame = e.nparame
              AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1)
         ORDER BY e.nordcla;

      --AND e.nmovimi = pnmovimi;
      /*CURSOR clauparaseg_real IS
      SELECT c.sclagen, c.nparame, c.tparame, c.nordcla
        FROM clauparaseg c
       WHERE c.sseguro = pssegpol
         --AND c.nmovimi = pnmovimi
         AND NOT EXISTS(SELECT 1
                          FROM estclauparaseg e
                         WHERE e.sseguro = psseguro
                           AND e.sclagen = c.sclagen
                           AND e.nriesgo = c.nriesgo
                           AND e.nordcla = c.nordcla
                           AND e.nmovimi = pnmovimi
                           AND e.nparame = c.nparame);*/

      --BUG24382:DCT:31/10/2012  Anadir clausupro.multiple=1
      CURSOR clauparaseg_real
      IS
         SELECT   c.sclagen, c.nparame, c.tparame, c.nordcla,
                  c.tparame || ': ' || cl.tparame tresul
             FROM clauparaseg c, clausupro p, seguros s, clausupara cl
            WHERE c.sseguro = pssegpol
              AND c.sseguro = s.sseguro
              AND p.cramo = s.cramo
              AND p.cmodali = s.cmodali
              AND cl.sclagen = c.sclagen
              AND cl.cidioma = pcidioma
              AND cl.nparame = c.nparame
              AND p.ctipseg = s.ctipseg
              AND p.ccolect = s.ccolect
              AND c.sclagen = p.sclagen
              AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1)
              AND NOT EXISTS (
                     SELECT 1
                       FROM estclauparaseg e, clausupro p2, estseguros es
                      WHERE e.sseguro = psseguro
                        AND e.sclagen = c.sclagen
                        AND e.nriesgo = c.nriesgo
                        AND e.nordcla = c.nordcla
                        AND e.nmovimi = pnmovimi
                        AND e.sseguro = es.sseguro
                        AND p2.cramo = es.cramo
                        AND p2.cmodali = es.cmodali
                        AND p2.ctipseg = es.ctipseg
                        AND p2.ccolect = es.ccolect
                        AND e.sclagen = p2.sclagen
                        AND NVL (p2.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1)
                        AND e.nparame = c.nparame)
         ORDER BY c.nordcla;

      -- Fin Bug 18362 - APD - 18/05/2011
      ------------------ DIRECCIONES
      CURSOR direcciones
      IS
         SELECT   d.*, pac_persona.f_sperson_spereal (s.sperson) spereal,
                  p.tpoblac
             FROM estper_direcciones d, esttomadores s, poblaciones p
            WHERE s.sseguro = psseguro
              AND p.cprovin = d.cprovin
              AND p.cpoblac = d.cpoblac
              AND s.sperson = d.sperson
         ORDER BY s.nordtom, d.cdomici;

      CURSOR direcciones_riesgos (pnriesgo IN NUMBER)
      IS
         SELECT   d.*, pac_persona.f_sperson_spereal (s.sperson) spereal,
                  p.tpoblac
             FROM estper_direcciones d, estriesgos s, poblaciones p
            WHERE s.sseguro = psseguro
              AND p.cprovin = d.cprovin
              AND p.cpoblac = d.cpoblac
              AND s.sperson = d.sperson
              AND s.nriesgo = pnriesgo
              AND s.nriesgo IN (SELECT nriesgo
                                  FROM riesgos
                                 WHERE sseguro = pssegpol AND fanulac IS NULL)
         ORDER BY s.nriesgo, d.cdomici;

      ------------------ PERSONAS
      CURSOR riesgos_ahora
      IS
         SELECT   p.*, pac_persona.f_sperson_spereal (p.sperson) spereal1,
                  e.nriesgo
             FROM estriesgos e, estpersonas p
            WHERE e.sseguro = psseguro
              AND e.sperson = p.sperson
              AND e.fanulac IS NULL
         ORDER BY e.nriesgo;

      CURSOR riesgos_antes
      IS
         SELECT   p.*, e.nriesgo
             FROM riesgos e, personas p
            WHERE e.sseguro = pssegpol
              AND e.sperson = p.sperson
              AND e.fanulac IS NULL
         ORDER BY e.nriesgo;

      -------------------------- canvi domicili prenedors
      CURSOR tomadores_antes
      IS
         SELECT   e.*
             FROM tomadores e, per_personas p
            WHERE e.sseguro = pssegpol AND e.sperson = p.sperson
         ORDER BY e.nordtom;

      CURSOR tomadores_ahora
      IS
         SELECT   p.*, pac_persona.f_sperson_spereal (p.sperson) spereal1,
                  e.*
             FROM esttomadores e, estpersonas p
            WHERE e.sseguro = psseguro AND e.sperson = p.sperson
         ORDER BY e.nordtom;

      -------------------------- canvi domicili asegurats
      CURSOR asegurados_antes
      IS
         SELECT   e.*
             FROM asegurados e, per_personas p
            WHERE e.sseguro = pssegpol AND e.sperson = p.sperson
         ORDER BY e.norden;

      CURSOR asegurados_ahora
      IS
         SELECT   p.*, pac_persona.f_sperson_spereal (p.sperson) spereal1,
                  e.*
             FROM estassegurats e, estpersonas p
            WHERE e.sseguro = psseguro AND e.sperson = p.sperson
         ORDER BY e.norden;

      -------------------------- BAJA DE RIESGOS
      CURSOR riesgos_baja
      IS
         SELECT   nriesgo, fanulac, sperson,
                  pac_persona.f_sperson_spereal (sperson) spereal
             FROM estriesgos
            WHERE estriesgos.sseguro = psseguro
              AND nmovimb = pnmovimi
              AND tnatrie IS NULL
         -- BUG 0033346/0194092 - FAL - 20/01/2015. Baja de riesgo en modificaci?n de propuestas MODIF_PROP_801
         UNION ALL
         SELECT   nriesgo, fanulac, sperson,
                  pac_persona.f_sperson_spereal (sperson) spereal
             FROM riesgos
            WHERE riesgos.sseguro = (SELECT ssegpol
                                       FROM estseguros
                                      WHERE sseguro = psseguro)
              AND tnatrie IS NULL
         MINUS
         SELECT   nriesgo, fanulac, sperson,
                  pac_persona.f_sperson_spereal (sperson) spereal
             FROM estriesgos
            WHERE estriesgos.sseguro = psseguro AND tnatrie IS NULL
         -- FI BUG 0033346/0194092 - FAL - 20/01/2015
         ORDER BY nriesgo;

-- BUG 23860/0130231 - FAL - 26/11/2012 - Que no detecte la baja de riesgo innominado

      -- BUG 23860/0130231 - FAL - 26/11/2012 -- baja riesgos innominadoa
      CURSOR riesgos_baja_innom
      IS
         SELECT   nriesgo, fanulac, tnatrie, nmovimb
             FROM estriesgos
            WHERE estriesgos.sseguro = psseguro
              AND nmovimb = pnmovimi
              AND tnatrie IS NOT NULL
         ORDER BY nriesgo;

      -- FI BUG 23860/0130231

      -------------------------- ALTA DE RIESGOS
      CURSOR riesgos_alta
      IS
         SELECT   nriesgo, fefecto, sperson
             FROM estriesgos
            WHERE sseguro = psseguro AND nmovima = pnmovimi
                  AND tnatrie IS NULL
         ORDER BY nriesgo;

-- BUG 23860/0130231 - FAL - 26/11/2012 - Que no detecte al alta de riesgo innominado

      -- BUG 23860/0130231 - FAL - 26/11/2012
      CURSOR riesgos_alta_innom
      IS
         SELECT   nriesgo, fefecto, sperson, tnatrie
             FROM estriesgos
            WHERE sseguro = psseguro
                                    --AND nmovima = pnmovimi  -- BUG 22095 - FAL - 16/04/2013
                  AND tnatrie IS NOT NULL
         -- BUG 22095 - FAL - 16/04/2013
         MINUS
         SELECT   nriesgo, fefecto, sperson, tnatrie
             FROM riesgos
            WHERE sseguro = pssegpol
                                    --AND nmovima = pnmovimi
                  AND tnatrie IS NOT NULL
         -- FI BUG 22095 - FAL - 16/04/2013
         ORDER BY nriesgo;

      -- FI BUG 23860/0130231

      ---------------------------- CAMBIO DE PRIMA
      CURSOR c_prima
      IS
         SELECT iprianu antes, nriesgo, cgarant
           FROM garanseg
          WHERE ffinefe IS NULL
            AND sseguro = pssegpol
            AND nriesgo IN (SELECT nriesgo
                              FROM riesgos
                             WHERE sseguro = pssegpol AND fanulac IS NULL)
            AND nriesgo IN (SELECT nriesgo
                              FROM estriesgos
                             WHERE sseguro = psseguro AND fanulac IS NULL)
            AND iprianu = 0
         MINUS
         SELECT iprianu antes, nriesgo, cgarant
           FROM estgaranseg
          WHERE NVL (cobliga, 1) = 1
            AND sseguro = psseguro
            AND nriesgo IN (SELECT nriesgo
                              FROM riesgos
                             WHERE sseguro = pssegpol AND fanulac IS NULL)
            AND nriesgo IN (SELECT nriesgo
                              FROM estriesgos
                             WHERE sseguro = psseguro AND fanulac IS NULL)
            AND nriesgo IN (SELECT nriesgo
                              FROM garanseg
                             WHERE sseguro = pssegpol AND iprianu = 0);

      -- ini Bug 0016961 - 20/12/2010 - SMF
      CURSOR c_prima2
      IS
         SELECT iprianu antes, nriesgo, cgarant
           FROM garanseg
          WHERE ffinefe IS NULL AND sseguro = pssegpol
         MINUS
         SELECT iprianu antes, nriesgo, cgarant
           FROM estgaranseg
          WHERE NVL (cobliga, 1) = 1
            AND sseguro = psseguro
            AND nmovimi = pnmovimi;

      -- fin Bug 0016961 - 20/12/2010 - SMF

      ---------------------------- PENALIZACION
      CURSOR c_penali
      IS
         SELECT niniran, nfinran, ppenali, ctipmov
           FROM penaliseg
          WHERE sseguro = pssegpol AND nmovimi = (SELECT MAX (nmovimi)
                                                    FROM penaliseg
                                                   WHERE sseguro = pssegpol)
         MINUS
         SELECT niniran, nfinran, ppenali, ctipmov
           FROM estpenaliseg
          WHERE sseguro = psseguro;

      ---------------------------- GARANTIAS ADICIONALES
      CURSOR c_garant_est_adicionales
      IS
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT   g.cgarant, g.cobliga
             FROM estgaranseg g, estseguros s
            WHERE g.sseguro = s.sseguro
              AND g.sseguro = psseguro
              AND (   (    NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'TIPO'
                                    ),
                               0
                              ) = 6
                       AND NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'PROPIETARIO'
                                    ),
                               0
                              ) = 1
                      )
                   OR (    NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'TIPO'
                                    ),
                               0
                              ) = 6
                       AND NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'PROPIETARIO'
                                    ),
                               0
                              ) = 2
                      )
                   OR (    NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'TIPO'
                                    ),
                               0
                              ) = 7
                       AND NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'PROPIETARIO'
                                    ),
                               0
                              ) = 1
                      )
                   OR (    NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'TIPO'
                                    ),
                               0
                              ) = 7
                       AND NVL
                              (f_pargaranpro_v
                                    (cramo,
                                     cmodali,
                                     ctipseg,
                                     ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     cgarant,
                                     'PROPIETARIO'
                                    ),
                               0
                              ) = 2
                      )
                  )
              -- BUG10519:DRA:09/07/2009:Inici
              AND g.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND g.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY g.norden;

      -- BUG10519:DRA:09/07/2009:Fi

      -- Bug 9699 - APD - 23/04/2009 - fin

      -- RSC 20/09/2007 SEGDISIN2 --------------------------------------------
      v_segdisin2diff       NUMBER;
      v_cmodinv_a           NUMBER;
      v_cmodinv_d           NUMBER;
      v_tmodinv_a           VARCHAR2 (50);
      v_tmodinv_d           VARCHAR2 (50);

      CURSOR cur_segdisin2
      IS
         SELECT s.ccesta, s.pdistrec, s.cmodabo, f.tfonabv
           FROM segdisin2 s, fondos f
          WHERE s.sseguro = pssegpol
            AND s.ccesta = f.ccodfon
            AND s.ffin IS NULL
            AND s.nmovimi = (SELECT MAX (nmovimi)
                               FROM segdisin2
                              WHERE sseguro = pssegpol AND ffin IS NULL);

      CURSOR cur_estsegdisin2
      IS
         SELECT s.ccesta, s.pdistrec, s.cmodabo, f.tfonabv
           FROM estsegdisin2 s, fondos f
          WHERE s.sseguro = psseguro
            AND s.ccesta = f.ccodfon
            AND s.ffin IS NULL
            AND s.nmovimi = (SELECT MAX (nmovimi)
                               FROM estsegdisin2
                              WHERE sseguro = psseguro AND ffin IS NULL);

------------------------------------------------------------------------

      --JRH 09/2007 Tarea 2674: Intereses para LRC. Pueden haber varios intereses por p?liza en las tablas de intereses
      vantes2               VARCHAR2 (2500);
      vdespues2             VARCHAR2 (2500);
      vantes1               VARCHAR2 (2500);   -- Bug 25840 - APD - 07/05/2013
      vdespues1             VARCHAR2 (2500);   -- Bug 25840 - APD - 07/05/2013
      vdespues3             VARCHAR2 (2500);   -- Bug 25840 - APD - 07/05/2013
      vdespues4             VARCHAR2 (2500);   -- Bug 25840 - APD - 07/05/2013
      vcvalor1              bf_bonfranseg.cvalor1%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcvalor2              bf_bonfranseg.cvalor2%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcimpmin              bf_bonfranseg.cimpmin%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcimpmax              bf_bonfranseg.cimpmax%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcgrup                bf_bonfranseg.cgrup%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcsubgrup             bf_bonfranseg.cgrup%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcversion             bf_bonfranseg.cgrup%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcnivel               bf_bonfranseg.cnivel%TYPE;
                                                -- IAXIS-5423  CJMR 23/09/2019
      -- Bug 25840 - APD - 07/05/2013
      vtgrup                bf_desgrup.tgrup%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vtnivel_antes         bf_desnivel.tnivel%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vtnivel_despues       bf_desnivel.tnivel%TYPE;
      -- Bug 25840 - APD - 07/05/2013
      vcontratada           BOOLEAN;
      -- INI IAXIS-5423  CJMR 23/09/2019
      vimpmin               bf_bonfranseg.impmin%TYPE;
      vimpvalor1            bf_bonfranseg.impvalor1%TYPE;

      -- FIN IAXIS-5423  CJMR 23/09/2019
      CURSOR intereses_real
      IS
         SELECT i1.pinttec, i1.ndesde, i1.nhasta
           FROM intertecseg i1
          WHERE i1.sseguro = pssegpol
            AND i1.nmovimi = (SELECT MAX (a.nmovimi)
                                FROM intertecseg a
                               WHERE a.sseguro = pssegpol);

      CURSOR intereses_est
      IS
         SELECT i1.pinttec, i1.ndesde, i1.nhasta
           FROM estintertecseg i1
          WHERE sseguro = psseguro AND nmovimi = pnmovimi;

      -- BUG10519:DRA:09/07/2009: Inici -- Preguntas a nivel de Riesgo --------
      CURSOR c_pregun_riesgo_real
      IS
         SELECT   DECODE (cp.ctippre,
                          4, p.trespue,             -- BUG10985:DRA:26/08/2009
                          5, p.trespue,
                          p.crespue
                         ) antes,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM pregunseg p, pregunpro e, seguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = pssegpol
              AND p.nmovimi = (SELECT MAX (ps.nmovimi)
                                 FROM pregunseg ps
                                WHERE ps.sseguro = pssegpol)
              AND e.sproduc = psproduc
              AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                  )                                  --BUG23860:DCT:26/10/2012
              AND cp.cpregun = p.cpregun             -- BUG9988:DRA:30/04/2009
              AND NOT EXISTS (
                     SELECT ep.cpregun
                       FROM estpregunseg ep
                      WHERE ep.sseguro = psseguro
                        AND ep.nmovimi = pnmovimi
                        AND ep.nriesgo = p.nriesgo
                        AND ep.cpregun = p.cpregun
                        AND DECODE (cp.ctippre,
                                    4, NVL (ep.trespue, '**'),
                                    -- BUG10985:DRA:26/08/2009
                                    5, NVL (ep.trespue, '**'),
                                    TO_CHAR (ep.crespue)
                                   ) =
                               DECODE (cp.ctippre,
                                       4, NVL (p.trespue, '**'),
                                       -- BUG10985:DRA:26/08/2009
                                       5, NVL (p.trespue, '**'),
                                       TO_CHAR (p.crespue)
                                      ))
              AND NOT EXISTS (
                     SELECT ed.cpregun
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = p.nriesgo
                        AND ed.cgarant = 0
                        AND ed.cpregun = p.cpregun
                        AND ed.cmotmov IN (685, 689))
              -- BUG10519:DRA:09/07/2009:Inici
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      CURSOR c_preguntab_riesgo_real
      IS
         SELECT   DECODE (p.ccolumna,
                          2, p.tvalor,
                          3, p.fvalor,
                          p.nvalor
                         ) antes,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM pregunsegtab p, pregunpro e, seguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND p.nmovimi = (SELECT MAX (ps.nmovimi)
                                 FROM pregunsegtab ps
                                WHERE ps.sseguro = psseguro)
              AND e.sproduc = psproduc
              AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                  )                                  --BUG23860:DCT:26/10/2012
              AND cp.cpregun = p.cpregun
              AND NOT EXISTS (
                     SELECT ep.cpregun
                       FROM estpregunsegtab ep
                      WHERE ep.sseguro = psseguro
                        AND ep.nmovimi = 1
                        AND ep.nriesgo = p.nriesgo
                        AND ep.cpregun = p.cpregun
                        AND DECODE (p.ccolumna,
                                    2, NVL (ep.tvalor, '**'),
                                    3, NVL (ep.fvalor, '**'),
                                    TO_CHAR (ep.nvalor)
                                   ) =
                               DECODE (p.ccolumna,
                                       2, NVL (p.tvalor, '**'),
                                       3, NVL (p.fvalor, '**'),
                                       TO_CHAR (p.nvalor)
                                      ))
              AND NOT EXISTS (
                     SELECT ed.cpregun
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = p.nriesgo
                        AND ed.cgarant = 0
                        AND ed.cpregun = p.cpregun
                        AND ed.cmotmov IN (685, 689))
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = psseguro
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      -- BUG10519:DRA:09/07/2009:Fi
      CURSOR c_pregun_riesgo_est
      IS
         SELECT   DECODE (cp.ctippre,
                          4, p.trespue,             -- BUG10985:DRA:26/08/2009
                          5, p.trespue,
                          p.crespue
                         ) despues,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM estpregunseg p, pregunpro e, estseguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND p.nmovimi = pnmovimi
              AND e.sproduc = psproduc
              AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                  )                                  --BUG23860:DCT:26/10/2012
              AND cp.cpregun = p.cpregun             -- BUG9988:DRA:30/04/2009
              AND NOT EXISTS (
                     SELECT ps.cpregun
                       FROM pregunseg ps
                      WHERE ps.sseguro = pssegpol
                        AND ps.nriesgo = p.nriesgo
                        AND ps.cpregun = p.cpregun
                        AND ps.nmovimi = (SELECT MAX (psg.nmovimi)
                                            FROM pregunseg psg
                                           WHERE psg.sseguro = pssegpol)
                        AND DECODE (cp.ctippre,
                                    4, NVL (ps.trespue, '**'),
                                    -- BUG10985:DRA:26/08/2009
                                    5, NVL (ps.trespue, '**'),
                                    TO_CHAR (ps.crespue)
                                   ) =
                               DECODE (cp.ctippre,
                                       4, NVL (p.trespue, '**'),
                                       -- BUG10985:DRA:26/08/2009
                                       5, NVL (p.trespue, '**'),
                                       TO_CHAR (p.crespue)
                                      ))
              AND NOT EXISTS (
                     SELECT ed.cpregun
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = p.nriesgo
                        AND ed.cgarant = 0
                        AND ed.cpregun = p.cpregun
                        AND ed.cmotmov IN (685, 689))
              -- BUG10519:DRA:09/07/2009:Inici
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      CURSOR c_preguntab_riesgo_est
      IS
         SELECT   DECODE (p.ccolumna,
                          2, p.tvalor,
                          3, p.fvalor,
                          p.nvalor
                         ) despues,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM estpregunsegtab p, pregunpro e, estseguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND p.nmovimi = pnmovimi
              AND e.sproduc = psproduc
              AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                  )                                  --BUG23860:DCT:26/10/2012
              AND cp.cpregun = p.cpregun
              AND NOT EXISTS (
                     SELECT ps.cpregun
                       FROM pregunsegtab ps
                      WHERE ps.sseguro = pssegpol
                        AND ps.nriesgo = p.nriesgo
                        AND ps.cpregun = p.cpregun
                        AND ps.nmovimi = (SELECT MAX (psg.nmovimi)
                                            FROM pregunsegtab psg
                                           WHERE psg.sseguro = pssegpol)
                        AND DECODE (p.ccolumna,
                                    2, NVL (ps.tvalor, '**'),
                                    3, NVL (ps.fvalor, '**'),
                                    TO_CHAR (ps.nvalor)
                                   ) =
                               DECODE (p.ccolumna,
                                       2, NVL (p.tvalor, '**'),
                                       3, NVL (p.fvalor, '**'),
                                       TO_CHAR (p.nvalor)
                                      ))
              AND NOT EXISTS (
                     SELECT ed.cpregun
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = p.nriesgo
                        AND ed.cgarant = 0
                        AND ed.cpregun = p.cpregun
                        AND ed.cmotmov IN (685, 689))
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      --INI IAXIS 5376 AABG: Se crea nuevo cursor sin validacion de fecha
      CURSOR c_preguntab_riesgo_est_clin
      IS
         SELECT   p.nvalor despues, p.cpregun, p.nriesgo, p.nmovimi,
                  p.ccolumna
             FROM estpregunsegtab p, pregunpro e, estseguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND p.nmovimi = pnmovimi
              AND e.sproduc = psproduc
              AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                  )                                  --BUG23860:DCT:26/10/2012
              AND cp.cpregun = p.cpregun
              AND p.nvalor !=
                     (SELECT ps.nvalor
                        FROM pregunsegtab ps
                       WHERE ps.sseguro = pssegpol
                         AND p.ccolumna = ps.ccolumna
                         AND ps.nmovimi =
                                (SELECT MAX (pss.nmovimi)
                                   FROM pregunsegtab pss
                                  WHERE pss.sseguro = pssegpol
                                    AND pss.ccolumna = ps.ccolumna))
              AND NOT EXISTS (
                     SELECT ed.cpregun
                       FROM estdetmovseguro ed
                      WHERE ed.sseguro = psseguro
                        AND ed.nmovimi = pnmovimi
                        AND ed.nriesgo = p.nriesgo
                        AND ed.cgarant = 0
                        AND ed.cpregun = p.cpregun
                        AND ed.cmotmov IN (685, 689))
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      --FIN IAXIS 5376 AABG: Se crea nuevo cursor sin validacion de fecha
      CURSOR c_pregun_riesgo_real_247
      IS
         SELECT   DECODE (cp.ctippre,
                          4, p.trespue,             -- BUG10985:DRA:26/08/2009
                          5, p.trespue,
                          p.crespue
                         ) antes,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM pregunseg p, pregunpro e, seguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = pssegpol
              AND p.nmovimi = (SELECT MAX (ps.nmovimi)
                                 FROM pregunseg ps
                                WHERE ps.sseguro = pssegpol)
              AND e.sproduc = psproduc
              AND e.cpretip = 2
              AND cp.cpregun = p.cpregun             -- BUG9988:DRA:30/04/2009
              AND NOT EXISTS (
                     SELECT ep.cpregun
                       FROM estpregunseg ep
                      WHERE ep.sseguro = psseguro
                        AND ep.nmovimi = pnmovimi
                        AND ep.nriesgo = p.nriesgo
                        AND ep.cpregun = p.cpregun
                        AND DECODE (cp.ctippre,
                                    4, NVL (ep.trespue, '**'),
                                    -- BUG10985:DRA:26/08/2009
                                    5, NVL (ep.trespue, '**'),
                                    TO_CHAR (ep.crespue)
                                   ) =
                               DECODE (cp.ctippre,
                                       4, NVL (p.trespue, '**'),
                                       -- BUG10985:DRA:26/08/2009
                                       5, NVL (p.trespue, '**'),
                                       TO_CHAR (p.crespue)
                                      ))
              /*AND NOT EXISTS(SELECT ed.cpregun
               FROM estdetmovseguro ed
              WHERE ed.sseguro = psseguro
                AND ed.nmovimi = pnmovimi
                AND ed.nriesgo = p.nriesgo
                AND ed.cgarant = 0
                AND ed.cpregun = p.cpregun
                AND ed.cmotmov IN(247, 685, 689))*/
              -- BUG10519:DRA:09/07/2009:Inici
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      -- BUG10519:DRA:09/07/2009:Fi
      CURSOR c_pregun_riesgo_est_247
      IS
         SELECT   DECODE (cp.ctippre,
                          4, p.trespue,             -- BUG10985:DRA:26/08/2009
                          5, p.trespue,
                          p.crespue
                         ) despues,
                  p.cpregun, p.nriesgo, p.nmovimi
             FROM estpregunseg p, pregunpro e, estseguros s, codipregun cp
            WHERE p.cpregun = e.cpregun
              AND e.cnivel = 'R'
              AND p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND p.nmovimi = pnmovimi
              AND e.sproduc = psproduc
              AND e.cpretip = 2
              AND cp.cpregun = p.cpregun             -- BUG9988:DRA:30/04/2009
              AND NOT EXISTS (
                     SELECT ps.cpregun
                       FROM pregunseg ps
                      WHERE ps.sseguro = pssegpol
                        AND ps.nriesgo = p.nriesgo
                        AND ps.cpregun = p.cpregun
                        AND ps.nmovimi = (SELECT MAX (psg.nmovimi)
                                            FROM pregunseg psg
                                           WHERE psg.sseguro = pssegpol)
                        AND DECODE (cp.ctippre,
                                    4, NVL (ps.trespue, '**'),
                                    -- BUG10985:DRA:26/08/2009
                                    5, NVL (ps.trespue, '**'),
                                    TO_CHAR (ps.crespue)
                                   ) =
                               DECODE (cp.ctippre,
                                       4, NVL (p.trespue, '**'),
                                       -- BUG10985:DRA:26/08/2009
                                       5, NVL (p.trespue, '**'),
                                       TO_CHAR (p.crespue)
                                      ))
              /*AND NOT EXISTS(SELECT ed.cpregun
               FROM estdetmovseguro ed
              WHERE ed.sseguro = psseguro
                AND ed.nmovimi = pnmovimi
                AND ed.nriesgo = p.nriesgo
                AND ed.cgarant = 0
                AND ed.cpregun = p.cpregun
                AND ed.cmotmov IN(247, 685, 689))*/
              AND p.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
              AND p.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL)
         ORDER BY p.cpregun;

      -- BUG10519:DRA:09/07/2009:Fi
      -- BUG10519:DRA:09/07/2009: Fi -- Preguntas a nivel de Riesgo --------
      CURSOR c_garanties_reduides
      IS
         SELECT   TO_CHAR (NVL (d.icapital, 0), 'FM999G999G999G990D00') antes,
                  d.cgarant, d.nriesgo, d.iprianu, dg.ndetgar
             FROM garanseg d, seguros s, detgaranseg dg
            WHERE d.sseguro = s.sseguro
              AND dg.sseguro = d.sseguro
              AND dg.nmovimi = d.nmovimi
              AND dg.cgarant = d.cgarant
              AND dg.nriesgo = d.nriesgo
              AND dg.finiefe = d.finiefe
              AND d.nmovimi =
                     (SELECT MAX (nmovimi)
                        FROM garanseg g
                       WHERE g.sseguro = pssegpol
                         AND g.cgarant = d.cgarant
                         AND g.nriesgo = d.nriesgo
                         AND d.finiefe = g.finiefe)
              AND s.sseguro = pssegpol
              AND d.icapital NOT IN (
                        SELECT icapital
                          FROM estgaranseg ed
                         WHERE ed.sseguro = psseguro
                               AND d.cgarant = ed.cgarant)
              AND pac_propio.f_garan_reducida (s.sseguro,
                                               d.cgarant,
                                               dg.ndetgar,
                                               'POL'
                                              ) = 0
              AND NVL (f_pargaranpro_v (s.cramo,
                                        s.cmodali,
                                        s.ctipseg,
                                        s.ccolect,
                                        s.cactivi,
                                        d.cgarant,
                                        'REDUCIBLE'
                                       ),
                       0
                      ) = 1
         ORDER BY d.norden;

      --BUG 17428: ETM :01/02/2011--INI
      --MODIF RIESGOS
      CURSOR riesgos_modif_antes
      IS
         SELECT   p.*
             FROM riesgos e, sitriesgo p
            WHERE e.sseguro = pssegpol
              AND e.sseguro = p.sseguro
              AND e.nriesgo = p.nriesgo
              AND e.fanulac IS NULL
         ORDER BY e.nriesgo;

      --BUG 17428: ETM :01/02/2011--FIN

      --BUG 23460: XVM :24/10/2012--INI
      --COASAEGURO/COACEDIDO
      CURSOR coacuadro_real
      IS
         SELECT co.sseguro, co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                co.ccompan, co.npoliza, co.nendoso                  --CONF-249
           FROM coacuadro co
          WHERE co.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacuadro a
                               WHERE a.sseguro = pssegpol)
         MINUS
         SELECT c.sseguro, c.finicoa, c.ffincoa, c.ploccoa, c.fcuacoa,
                c.ccompan, c.npoliza, c.nendoso                     --CONF-249
           FROM estcoacuadro c
          WHERE c.sseguro = psseguro AND c.ncuacoa = pnmovimi;

      CURSOR coacuadro_est
      IS
         SELECT c.sseguro, c.finicoa, c.ffincoa, c.ploccoa, c.fcuacoa,
                c.ccompan, c.npoliza
           FROM estcoacuadro c
          WHERE c.sseguro = psseguro AND c.ncuacoa = pnmovimi
         MINUS
         SELECT co.sseguro, co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                co.ccompan, co.npoliza
           FROM coacuadro co
          WHERE co.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacuadro a
                               WHERE a.sseguro = pssegpol);

      CURSOR coacuadro_real_acep
      IS                                                              --ramiro
         SELECT co.sseguro, co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                co.ccompan, co.npoliza, co.nendoso, cc.pcescoa,
                cc.ccompan ccompans
           FROM coacuadro co, coacedido cc
          WHERE co.sseguro = pssegpol
            AND cc.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacuadro a
                               WHERE a.sseguro = pssegpol)
         MINUS
         SELECT c.sseguro, c.finicoa, c.ffincoa, c.ploccoa, c.fcuacoa,
                c.ccompan, c.npoliza, c.nendoso,                      --ramiro
                                                cc.pcescoa,
                cc.ccompan ccompans
           FROM estcoacuadro c, estcoacedido cc
          WHERE c.sseguro = psseguro
            AND cc.sseguro = psseguro
            AND c.ncuacoa = pnmovimi;

      CURSOR coacuadro_est_compa
      IS
         SELECT e.finicoa finicoa, e.ffincoa ffincoa, e.ploccoa ploccoa,
                e.fcuacoa fcuacoa, e.ccompan ccompan, e.npoliza npoliza,
                e.nendoso nendoso, cc.pcescoa pcescoa, cc.ccompan ccompans
           FROM estcoacuadro e, estcoacedido cc
          WHERE e.sseguro = psseguro
            AND cc.sseguro = psseguro
            AND e.ncuacoa = pnmovimi;

      CURSOR coacuadro_est_acep
      IS
         SELECT c.sseguro, c.finicoa, c.ffincoa, c.ploccoa, c.fcuacoa,
                c.ccompan, c.npoliza, c.nendoso                       --ramiro
           FROM estcoacuadro c
          WHERE c.sseguro = psseguro AND c.ncuacoa = pnmovimi
         MINUS
         SELECT co.sseguro, co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                co.ccompan, co.npoliza, co.nendoso
           FROM coacuadro co
          WHERE co.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacuadro a
                               WHERE a.sseguro = pssegpol);           --ramiro

      CURSOR coacedido_real
      IS
         SELECT co.sseguro, co.ccompan, co.pcescoa, co.pcomcoa, co.pcomcon,
                co.pcomgas, co.pcesion
           FROM coacedido co
          WHERE co.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacedido a
                               WHERE a.sseguro = pssegpol)
         MINUS
         SELECT c.sseguro, c.ccompan, c.pcescoa, c.pcomcoa, c.pcomcon,
                c.pcomgas, c.pcesion
           FROM estcoacedido c
          WHERE c.sseguro = psseguro AND c.ncuacoa = pnmovimi;

      CURSOR coacedido_est
      IS
         SELECT c.sseguro, c.ccompan, c.pcescoa, c.pcomcoa, c.pcomcon,
                c.pcomgas, c.pcesion
           FROM estcoacedido c
          WHERE c.sseguro = psseguro AND c.ncuacoa = pnmovimi
         MINUS
         SELECT co.sseguro, co.ccompan, co.pcescoa, co.pcomcoa, co.pcomcon,
                co.pcomgas, co.pcesion
           FROM coacedido co
          WHERE co.sseguro = pssegpol
            AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                FROM coacedido a
                               WHERE a.sseguro = pssegpol);
      -- Ini IAXIS-6141 -- ECP -- 03/03/2020
      -- INI IAXIS-5423  CJMR 23/09/2019
      CURSOR bonfranseg_antes
      IS
         SELECT   norden, cgrup, cnivel, cimpmin, impmin, cvalor1 ,impvalor1
             FROM (SELECT bfpag.norden, b2.cgrup, b2.cnivel, b2.cimpmin,
                          b2.impmin, b2.cvalor1, b2.impvalor1
                     FROM bf_bonfranseg b2 INNER JOIN seguros s
                          ON b2.sseguro = s.sseguro
                          INNER JOIN bf_proactgrup bfpag
                          ON s.sproduc = bfpag.sproduc
                        AND s.cactivi = bfpag.cactivi
                        AND b2.cgrup = bfpag.cgrup
                    WHERE b2.sseguro = pssegpol
                      AND b2.nmovimi =
                             (SELECT MAX (b1.nmovimi)
                                FROM bf_bonfranseg b1
                               WHERE b1.sseguro = pssegpol
                                 AND b1.nmovimi < pnmovimi
                                 AND b1.nriesgo IN (
                                        SELECT r.nriesgo
                                          FROM riesgos r
                                         WHERE r.sseguro = pssegpol
                                           AND r.fanulac IS NULL)
                                 AND b1.nriesgo IN (
                                        SELECT er.nriesgo
                                          FROM estriesgos er
                                         WHERE er.sseguro = psseguro
                                           AND er.fanulac IS NULL))
                   MINUS
                   SELECT bfpag.norden, b.cgrup, b.cnivel, b.cimpmin,
                          b.impmin, b.cvalor1, b.impvalor1
                     FROM estbf_bonfranseg b INNER JOIN estseguros s
                          ON b.sseguro = s.sseguro
                          INNER JOIN bf_proactgrup bfpag
                          ON s.sproduc = bfpag.sproduc
                        AND s.cactivi = bfpag.cactivi
                        AND b.cgrup = bfpag.cgrup
                    WHERE b.sseguro = psseguro
                      AND b.nmovimi = pnmovimi
                      AND b.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                      AND b.nriesgo IN (
                             SELECT er.nriesgo
                               FROM estriesgos er
                              WHERE er.sseguro = psseguro
                                AND er.fanulac IS NULL))
         ORDER BY norden;

      CURSOR bonfranseg_alta
      IS
         SELECT   norden, cgrup, cnivel, cimpmin, impmin, cvalor1,  impvalor1
             FROM (SELECT bfpag.norden, b.cgrup, b.cnivel, b.cimpmin,
                          b.impmin,  b.cvalor1, b.impvalor1
                     FROM estbf_bonfranseg b INNER JOIN estseguros s
                          ON b.sseguro = s.sseguro
                          INNER JOIN bf_proactgrup bfpag
                          ON s.sproduc = bfpag.sproduc
                        AND s.cactivi = bfpag.cactivi
                        AND b.cgrup = bfpag.cgrup
                    WHERE b.sseguro = psseguro
                      AND b.nmovimi = pnmovimi
                      AND b.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                      AND b.nriesgo IN (
                             SELECT er.nriesgo
                               FROM estriesgos er
                              WHERE er.sseguro = psseguro
                                AND er.fanulac IS NULL)
                   MINUS
                   SELECT bfpag.norden, b2.cgrup, b2.cnivel, b2.cimpmin,
                          b2.impmin , b2.cvalor1 , b2.impvalor1
                     FROM bf_bonfranseg b2 INNER JOIN seguros s
                          ON b2.sseguro = s.sseguro
                          INNER JOIN bf_proactgrup bfpag
                          ON s.sproduc = bfpag.sproduc
                        AND s.cactivi = bfpag.cactivi
                        AND b2.cgrup = bfpag.cgrup
                    WHERE b2.sseguro = pssegpol
                      AND b2.nmovimi =
                             (SELECT MAX (b1.nmovimi)
                                FROM bf_bonfranseg b1
                               WHERE b1.sseguro = pssegpol
                                 AND b1.nmovimi < pnmovimi
                                 AND b1.nriesgo IN (
                                        SELECT r.nriesgo
                                          FROM riesgos r
                                         WHERE r.sseguro = pssegpol
                                           AND r.fanulac IS NULL)
                                 AND b1.nriesgo IN (
                                        SELECT er.nriesgo
                                          FROM estriesgos er
                                         WHERE er.sseguro = psseguro
                                           AND er.fanulac IS NULL)))
         ORDER BY norden;

      -- FIN IAXIS-5423  CJMR 23/09/2019
      -- Fin  IAXIS-6141 -- ECP -- 03/03/2020

      --BUG 23460: XVM :24/10/2012--FIN
      vcagente              agentes.cagente%TYPE;
      -- dra 9-1-08: bug mantis 8660
      vcontador             NUMBER;
      v_ccobban_a           NUMBER;
      v_ccobban_d           NUMBER;
      v_texto               VARCHAR2 (4000);
      --Ini Bug 26488 --ECP--06/05/2013
      v_escertif0           NUMBER;
      --Fin Bug 26488 --ECP--06/05/2013
      vsliteral             NUMBER;            -- Bug 27304 - MDS - 30/08/2013
      vcagrupa_old          VARCHAR2 (200)                 := NULL;
      --IAXIS-2085 03/04/2019 AP
      vcagrupa_new          VARCHAR2 (200)                 := NULL;
   --IAXIS-2085 03/04/2019 AP
   BEGIN
      -- Ini Bug 27304 - MDS - 30/08/2013
      IF pac_mdpar_productos.f_get_parproducto ('ALTERNATIVO_BENEF',
                                                psproduc) = 1
      THEN
         vsliteral := 800127;
      ELSE
         vsliteral := 1053;
      END IF;

--      p_tab_error (f_sysdate,
--                            f_user,
--                            'pk_suplementos.f_validar_cambios',
--                            1,
--                             'fechat 77 f_grabar_detalle',
--                                  ' psseguro-->'
--                      || psseguro
--
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'pnmovimi  '
--                      || pnmovimi);
      -- Fin Bug 27304 - MDS - 30/08/2013
      BEGIN
         SELECT DECODE (cestado, 'X', 0, 180498)
           -- 180498 = No se puede realizar el suplemento.
         INTO   num_err
           FROM pds_estsegurosupl
          WHERE sseguro = psseguro AND nmovimi = pnmovimi
                AND cmotmov = pcmotmov;
      EXCEPTION
         WHEN OTHERS
         THEN
--            p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_grabar_detalle',
--                         ' psseguro-->'
--                      || psseguro
--
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'pnmovimi  '
--                      || pnmovimi
--                     ||SQLERRM);
            num_err := 180498;
      END;

            /*IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;
      */
      SELECT csubpro
        INTO v_csubpro
        FROM seguros s, productos p
       WHERE s.sseguro = pssegpol AND s.sproduc = p.sproduc;

      IF v_csubpro IN (2, 3)
      THEN
         literal2 := f_axis_literales (100547, pcidioma);          -- riesgo:
      ELSE
         literal2 := NULL;
      END IF;

      IF pcmotmov IN (668)
      THEN
         BEGIN
            vnriesgo := 1;
            vcgarant := 0;
            vcpregun := 0;
            literal := f_axis_literales (102359, pcidioma);

            -- Hasta aqu? solo se comprueba que el cdomici no haya cambiado
            BEGIN
               SELECT    literal
                      || ' '
                      || t.cdomici
                      || '.-'
                      || tdomici
                      || '('
                      || cpostal
                      || ' '
                      || p.tpoblac
                      || ')',
                      d.cdomici
                 INTO vantes,
                      vcdomicia
                 FROM tomadores t, per_direcciones d, poblaciones p
                WHERE t.sseguro = pssegpol
                  AND t.sperson = d.sperson
                  AND t.cdomici = d.cdomici
                  AND p.cprovin = d.cprovin
                  AND p.cpoblac = d.cpoblac
                  AND t.nordtom = 1;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  NULL;
            END;

            BEGIN
               SELECT    literal
                      || ' '
                      || t.cdomici
                      || '.-'
                      || tdomici
                      || '('
                      || cpostal
                      || ' '
                      || p.tpoblac
                      || ')',
                      t.cdomici
                 INTO vdespues,
                      vcdomicid
                 FROM esttomadores t, estper_direcciones d, poblaciones p
                WHERE t.sseguro = psseguro
                  AND t.sperson = d.sperson
                  AND t.cdomici = d.cdomici
                  AND p.cprovin = d.cprovin
                  AND p.cpoblac = d.cpoblac
                  AND t.nordtom = 1;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  NULL;
            END;

            IF vcdomicia <> vcdomicid
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            ELSE
               FOR c IN direcciones
               LOOP
                  vcgarant := vcgarant + 1;
                  vdespues :=
                        literal
                     || ' '
                     || c.cdomici
                     || '.-'
                     || c.tdomici
                     || '('
                     || c.cpostal
                     || ' '
                     || c.tpoblac
                     || ')';

                  BEGIN
                     SELECT    literal
                            || ' '
                            || t.cdomici
                            || '.-'
                            || tdomici
                            || '('
                            || cpostal
                            || ' '
                            || p.tpoblac
                            || ')'
                       INTO vantes
                       FROM estper_personas per,
                            estper_direcciones t,
                            poblaciones p
                      WHERE t.sperson = c.sperson
                        AND t.cdomici = c.cdomici
                        AND p.cprovin = t.cprovin
                        AND p.cpoblac = t.cpoblac
                        AND per.sperson = t.sperson
                        AND per.sseguro = psseguro;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := NULL;
                  END;

                  IF vantes <> vdespues AND vantes IS NOT NULL
                  THEN
                     -- Insertamos el detalle.
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vcpregun
                                       );
                  ELSE
                     num_err := 107804;
                  END IF;
               END LOOP;
            END IF;
         END;
      ELSIF pcmotmov = 528
      THEN
-- Reducci?n garantias
--------------------------------------------------------------------------
         FOR c IN c_garanties_reduides
         LOOP
            BEGIN
               SELECT TO_CHAR (ed.icapital, 'FM999G999G999G990D00'),
                      ed.iprianu
                 INTO v_crespue_d,
                      v_crespue_a
                 FROM estgaranseg ed, estseguros es, estdetgaranseg dg
                WHERE es.sseguro = ed.sseguro
                  AND es.sseguro = psseguro
                  AND ed.cgarant = c.cgarant
                  AND ed.nmovimi = pnmovimi
                  AND ed.nriesgo = c.nriesgo
                  AND ed.nriesgo = dg.nriesgo
                  AND ed.nmovimi = dg.nmovimi
                  AND ed.cgarant = dg.cgarant
                  AND ed.sseguro = dg.sseguro
                  AND ed.finiefe = dg.finiefe
                  AND dg.ndetgar = c.ndetgar
                  AND ed.iprianu = 0
                  AND pac_propio.f_garan_reducida (es.ssegpol,
                                                   ed.cgarant,
                                                   c.ndetgar,
                                                   'POL'
                                                  ) = 0
                  AND NVL (f_pargaranpro_v (es.cramo,
                                            es.cmodali,
                                            es.ctipseg,
                                            es.ccolect,
                                            es.cactivi,
                                            ed.cgarant,
                                            'REDUCIBLE'
                                           ),
                           0
                          ) = 1;

               num_err := f_desgarantia (c.cgarant, pcidioma, literal);
               vantes := literal || ' - ';
               literal := f_axis_literales (102003, pcidioma);       -- Prima:
               vantes := vantes || literal || ' ' || c.iprianu;
               literal := f_axis_literales (1000073, pcidioma);    -- capital:
               vantes := vantes || ', ' || literal || ' : ' || c.antes;
               num_err := f_desgarantia (c.cgarant, pcidioma, literal);
               vdespues := literal || ' - ';
               literal := f_axis_literales (102003, pcidioma);       -- Prima:
               vdespues := vdespues || literal || ' ' || v_crespue_a;
               literal := f_axis_literales (1000073, pcidioma);    -- Capital:
               vdespues := vdespues || ', ' || literal || ' : ' || v_crespue_d;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  NVL (c.nriesgo, 1),
                                  c.cgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;
         END LOOP;
      ELSIF pcmotmov IN (672)
      THEN
         BEGIN
            vcgarant := 0;
            literal := f_axis_literales (102359, pcidioma);

            FOR reg IN riesgos_antes
            LOOP
               vnriesgo := reg.nriesgo;
               vcdomicia := 0;
               vcdomicid := 0;

               -- Hasta aqu? solo se comprueba que el cdomici no haya cambiado
               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         d.cdomici
                    INTO vantes,
                         vcdomicia
                    FROM riesgos t, per_direcciones d, poblaciones p
                   WHERE t.sseguro = pssegpol
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac
                     AND t.nriesgo = reg.nriesgo;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         t.cdomici
                    INTO vdespues,
                         vcdomicid
                    FROM estriesgos t, estper_direcciones d, poblaciones p
                   WHERE t.sseguro = psseguro
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac
                     AND t.nriesgo = reg.nriesgo;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               IF vcdomicia <> vcdomicid
               THEN
                  IF literal2 IS NOT NULL
                  THEN
                     vantes :=
                              literal2 || ' ' || reg.nriesgo || ' ' || vantes;
                     vdespues :=
                            literal2 || ' ' || reg.nriesgo || ' ' || vdespues;
                  END IF;

                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               ELSE
                  FOR c IN direcciones_riesgos (reg.nriesgo)
                  LOOP
                     vcgarant := vcgarant + 1;
                     vdespues :=
                           literal
                        || ' '
                        || c.cdomici
                        || '.-'
                        || c.tdomici
                        || '('
                        || c.cpostal
                        || ' '
                        || c.tpoblac
                        || ')';

                     BEGIN
                        SELECT    literal
                               || ' '
                               || t.cdomici
                               || '.-'
                               || tdomici
                               || '('
                               || cpostal
                               || ' '
                               || p.tpoblac
                               || ')'
                          INTO vantes
                          FROM per_direcciones t, poblaciones p
                         WHERE sperson = c.spereal
                           AND cdomici = c.cdomici
                           AND p.cprovin = t.cprovin
                           AND p.cpoblac = t.cpoblac;
                     EXCEPTION
                        WHEN NO_DATA_FOUND
                        THEN
                           vantes := NULL;
                     END;

                     IF vantes <> vdespues AND vantes IS NOT NULL
                     THEN
                        -- Insertamos el detalle.
                        IF literal2 IS NOT NULL
                        THEN
                           vantes :=
                              literal2 || ' ' || reg.nriesgo || ' ' || vantes;
                           vdespues :=
                              literal2 || ' ' || reg.nriesgo || ' '
                              || vdespues;
                        END IF;

                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vcpregun
                                          );
                     END IF;
                  END LOOP;
               END IF;
            END LOOP;
         END;
      ELSIF pcmotmov IN (673)
      THEN
         BEGIN
            vcgarant := 0;
            literal := f_axis_literales (102359, pcidioma);

            -- ||' ' || f_axis_literales(109360, pcidioma);
            FOR reg IN tomadores_antes
            LOOP
               vcdomicia := 0;
               vcdomicid := 0;

               -- Hasta aqu? solo se comprueba que el cdomici no haya cambiado
               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         d.cdomici
                    INTO vantes,
                         vcdomicia
                    FROM tomadores t, per_direcciones d, poblaciones p
                   WHERE t.sseguro = pssegpol
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac
                     AND t.nordtom = reg.nordtom;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               

               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         t.cdomici
                    INTO vdespues,
                         vcdomicid
                    FROM esttomadores t, estper_direcciones d, poblaciones p
                   WHERE t.sseguro = psseguro
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac
                     AND t.nordtom = reg.nordtom;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               

               IF vcdomicia <> vcdomicid
               THEN
                  /*IF literal2 IS NOT NULL THEN
                     vantes := literal2 || ' ' || reg.sperson || ' ' || vantes;
                     vdespues := literal2 || ' ' || reg.sperson || ' ' || vdespues;
                  END IF;*/
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     NVL (vnriesgo, 1),
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               ELSE
                  num_err := 107804;
               END IF;
            END LOOP;
         END;
      --BUG    INICIO - DCT - 29/07/2013
      ELSIF pcmotmov IN (676)
      THEN
         BEGIN
            vcgarant := 0;
            literal := f_axis_literales (102359, pcidioma);

            -- ||' ' || f_axis_literales(109360, pcidioma);
            FOR reg IN tomadores_antes
            LOOP
               vcdomicia := 0;
               vcdomicid := 0;

               -- Hasta aqu? solo se comprueba que el cdomici no haya cambiado
               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         d.cdomici
                    INTO vantes,
                         vcdomicia
                    FROM tomadores t, per_direcciones d, poblaciones p
                   WHERE t.sseguro = pssegpol
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         t.cdomici
                    INTO vdespues,
                         vcdomicid
                    FROM esttomadores t, estper_direcciones d, poblaciones p
                   WHERE t.sseguro = psseguro
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               IF vcdomicia <> vcdomicid
               THEN
                  /*IF literal2 IS NOT NULL THEN
                     vantes := literal2 || ' ' || reg.sperson || ' ' || vantes;
                     vdespues := literal2 || ' ' || reg.sperson || ' ' || vdespues;
                  END IF;*/
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     NVL (vnriesgo, 1),
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            END LOOP;
         END;
      -- Bug 31686/177068 - 13/06/2014 - AMC
      ELSIF pcmotmov IN (677)
      THEN
         BEGIN
            vcgarant := 0;
            literal := f_axis_literales (102359, pcidioma);

            FOR reg IN asegurados_antes
            LOOP
               vcdomicia := 0;
               vcdomicid := 0;

               -- Hasta aqu? solo se comprueba que el cdomici no haya cambiado
               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         d.cdomici
                    INTO vantes,
                         vcdomicia
                    FROM asegurados t, per_direcciones d, poblaciones p
                   WHERE t.sseguro = pssegpol
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               BEGIN
                  SELECT    literal
                         || ' '
                         || t.cdomici
                         || '.-'
                         || tdomici
                         || '('
                         || cpostal
                         || ' '
                         || p.tpoblac
                         || ')',
                         t.cdomici
                    INTO vdespues,
                         vcdomicid
                    FROM estassegurats t, estper_direcciones d, poblaciones p
                   WHERE t.sseguro = psseguro
                     AND t.sperson = d.sperson
                     AND t.cdomici = d.cdomici
                     AND p.cprovin = d.cprovin
                     AND p.cpoblac = d.cpoblac;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     NULL;
               END;

               IF vcdomicia <> vcdomicid
               THEN
                  /*IF literal2 IS NOT NULL THEN
                     vantes := literal2 || ' ' || reg.sperson || ' ' || vantes;
                     vdespues := literal2 || ' ' || reg.sperson || ' ' || vdespues;
                  END IF;*/
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     NVL (vnriesgo, 1),
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            END LOOP;
         END;
      -- Fi Bug 31686/177068 - 13/06/2014 - AMC
      ELSIF pcmotmov = 286
      THEN
         vantes := NULL;
         vdespues := NULL;
         p_control_error ('dcomerma', 'error gesti?n 286: ', ('ENTRA 286'));

         -- BUG 0020761 - 23/01/2012 - JMF: afegir ncuotar
         BEGIN
            SELECT s.ctipcob, s.cbancar, s.ctipban, tc.longitud, s.ccobban,
                   s.ncuotar
              INTO v_ctipcob_a, ccantes, cctipbanant, cclong, v_ccobban_a,
                   v_ncuotar_a
              FROM seguros s, tipos_cuenta tc
             WHERE s.ctipban = tc.ctipban(+) AND s.sseguro = pssegpol;

            IF cclong IS NOT NULL
            THEN
               ccantes := LPAD (ccantes, cclong, '0');
            ELSE
               ccantes := ccantes;
            END IF;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT e.ctipcob, e.cbancar, e.ctipban, tc.longitud, e.ccobban,
                   e.ncuotar
              INTO v_ctipcob_d, ccdespues, cctipbandes, cclong, v_ccobban_d,
                   v_ncuotar_d
              FROM estseguros e, tipos_cuenta tc
             WHERE e.ctipban = tc.ctipban(+) AND e.sseguro = psseguro;

            IF cclong IS NOT NULL
            THEN
               ccdespues := LPAD (ccdespues, cclong, '0');
            ELSE
               ccdespues := ccdespues;
            END IF;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         -- BUG13254:DRA:23/02/2010:Inici
         IF NVL (v_ctipcob_a, 0) <> NVL (v_ctipcob_d, 0)
         THEN
            literal := f_axis_literales (151348, pcidioma);
            vantes :=
               literal || ': '
               || ff_desvalorfijo (552, pcidioma, v_ctipcob_a);
            vdespues :=
               literal || ': '
               || ff_desvalorfijo (552, pcidioma, v_ctipcob_d);
         END IF;

         IF NVL (v_ccobban_a, 0) <> NVL (v_ccobban_d, 0)
         THEN
            literal := f_axis_literales (100879, pcidioma);

            BEGIN
               SELECT descripcion
                 INTO v_texto
                 FROM cobbancario
                WHERE ccobban = v_ccobban_a;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_texto := NULL;
            END;

            vantes := vantes || '   ' || literal || ': ' || v_texto;

            BEGIN
               SELECT descripcion
                 INTO v_texto
                 FROM cobbancario
                WHERE ccobban = v_ccobban_d;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_texto := NULL;
            END;

            vdespues := vdespues || '   ' || literal || ': ' || v_texto;
         END IF;

         -- ini BUG 0020761 - 23/01/2012 - JMF: afegir ncuotar
         IF NVL (v_ncuotar_a, -1) <> NVL (v_ncuotar_d, -1)
         THEN
            literal := f_axis_literales (9901245, pcidioma);
            vantes := vantes || '   ' || literal || ': ' || v_ncuotar_a;
            vdespues := vdespues || '   ' || literal || ': ' || v_ncuotar_d;
         END IF;

         -- fin BUG 0020761 - 23/01/2012 - JMF: afegir ncuotar
         IF NVL (ccantes, '0') <> NVL (ccdespues, '0')
         THEN
            literal := f_axis_literales (100930, pcidioma);

            IF NVL (ccantes, '0') <> '0'
            THEN
               --Inici BUG 28536/158964 - RCL - 19/11/2013 - LCOL895-Enmascarar cuenta bancaria (suplementos)
               IF NVL
                     (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'ENMASCARAR_CCC'
                                              ),
                      0
                     ) = 1
               THEN
                  --Enmascaramos xxxx - xxxx - xxxx - nnnn
                  ccantes_a := SUBSTR (ccantes, 0, LENGTH (ccantes) - 4);
                  ccantes_b :=
                      SUBSTR (ccantes, LENGTH (ccantes) - 3,
                              LENGTH (ccantes));
                  ccantes_a := REGEXP_REPLACE (ccantes_a, '[0-9]', 'X');
                  ccantes := ccantes_a || ccantes_b;
               END IF;

               --Fi BUG 28536/158964 - RCL - 19/11/2013 - LCOL895-Enmascarar cuenta bancaria (suplementos)
               verror := f_formatoccc (ccantes, ccantes_format, cctipbanant);
               vantes := vantes || '   ' || literal || ' ' || ccantes_format;
            END IF;

            IF NVL (ccdespues, '0') <> '0'
            THEN
               --Inici BUG 28536/158964 - RCL - 19/11/2013 - LCOL895-Enmascarar cuenta bancaria (suplementos)
               IF NVL
                     (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'ENMASCARAR_CCC'
                                              ),
                      0
                     ) = 1
               THEN
                  --Enmascaramos xxxx - xxxx - xxxx - nnnn
                  ccdespues_a := SUBSTR (ccdespues, 0, LENGTH (ccdespues) - 4);
                  ccdespues_b :=
                     SUBSTR (ccdespues,
                             LENGTH (ccdespues) - 3,
                             LENGTH (ccdespues)
                            );
                  ccdespues_a := REGEXP_REPLACE (ccdespues_a, '[0-9]', 'X');
                  ccdespues := ccdespues_a || ccdespues_b;
               END IF;

               --Fi BUG 28536/158964 - RCL - 19/11/2013 - LCOL895-Enmascarar cuenta bancaria (suplementos)
               verror :=
                       f_formatoccc (ccdespues, ccdespues_format, cctipbandes);
               vdespues :=
                       vdespues || '   ' || literal || ' ' || ccdespues_format;
            END IF;
         END IF;

         --DC01 - INI
         IF     NVL
                   (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'INS_MANDATO'
                                              ),
                    0
                   ) = 1
            AND NVL (ccantes, '0') = NVL (ccdespues, '0')
         THEN
            BEGIN
               SELECT cmandato, sperson
                 INTO vmandato, vsperson
                 FROM estmandatos
                WHERE cbancar = ccantes;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vmandato := NULL;
            END;

            vdespues := vdespues || '   ' || literal || ': ' || vmandato;

            BEGIN
               SELECT cmandato, sperson
                 INTO vmandato, vsperson
                 FROM mandatos
                WHERE cbancar = ccantes
                  AND sperson = (SELECT spereal
                                   FROM estper_personas
                                  WHERE sperson = vsperson)
                  AND ffirma =
                         (SELECT MAX (ffirma)
                            FROM mandatos
                           WHERE cbancar = ccantes
                             AND sperson = (SELECT spereal
                                              FROM estper_personas
                                             WHERE sperson = vsperson));
            EXCEPTION
               WHEN OTHERS
               THEN
                  vmandato := NULL;
            END;

            vantes := vantes || '   ' || literal || ' ' || vmandato;
            p_control_error ('dcomerma',
                             'error gesti?n:',
                             (vantes || ';' || vdespues)
                            );
         END IF;

         --DC01 -  FIN

         -- BUG13254:DRA:23/02/2010:Fi
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 667
      THEN
         SELECT i.tidioma
           INTO vantes
           FROM seguros s, idiomas i
          WHERE s.sseguro = pssegpol AND s.cidioma = i.cidioma;

         SELECT i.tidioma
           INTO vdespues
           FROM estseguros s, idiomas i
          WHERE s.sseguro = psseguro AND s.cidioma = i.cidioma;

         literal := f_axis_literales (100622, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 226
      THEN
         SELECT TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (120453, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      -- BUG17255:DRA:22/07/2011:Inici
      ELSIF pcmotmov = 276
      THEN
         FOR c IN (SELECT a.nriesgo, a.sperson, a.norden, a.fnacimi,
                          a.fcarnet, a.csexo, a.npuntos
                     FROM autconductores a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autconductores a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo))
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg
                 FROM personas
                WHERE sperson = c.sperson;
            EXCEPTION
               WHEN OTHERS
               THEN
                  pers_reg.tnombre := NULL;
                  pers_reg.tapelli := NULL;
            END;

            literal2 := f_axis_literales (9001027, pcidioma);     -- Conductor
            vantes :=
                  vantes
               || literal2
               || ': '
               || pers_reg.tnombre
               || ' '
               || pers_reg.tapelli
               || ', '
               || f_axis_literales (500102, pcidioma)
               || ': '
               || c.norden
               || ', '
               || f_axis_literales (100959, pcidioma)
               || ': '
               || NVL (c.fnacimi, pers_reg.fnacimi)
               || ', '
               || f_axis_literales (9001171, pcidioma)
               || ': '
               || c.fcarnet
               || ', '
               || f_axis_literales (100962, pcidioma)
               || ': '
               || ff_desvalorfijo (11,
                                   pcidioma,
                                   NVL (c.csexo, pers_reg.csexper)
                                  )
               || ', '
               || f_axis_literales (9001173, pcidioma)
               || ': '
               || c.npuntos;

            BEGIN
               SELECT e.sperson, e.norden, e.fnacimi, e.fcarnet, e.csexo,
                      e.npuntos
                 INTO vsperson, v_norden, v_fnacimi, v_fcarnet, v_csexo,
                      v_npuntos
                 FROM estautconductores e
                WHERE e.sseguro = psseguro
                  AND e.nriesgo = c.nriesgo
                  AND e.nmovimi = pnmovimi
                  AND e.norden = c.norden;

               BEGIN
                  SELECT *
                    INTO pers_reg2
                    FROM estpersonas
                   WHERE sperson = vsperson;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     pers_reg2.tnombre := NULL;
                     pers_reg2.tapelli := NULL;
               END;

               vdespues :=
                     vdespues
                  || literal2
                  || ': '
                  || pers_reg2.tnombre
                  || ' '
                  || pers_reg2.tapelli
                  || ', '
                  || f_axis_literales (500102, pcidioma)
                  || ': '
                  || v_norden
                  || ', '
                  || f_axis_literales (100959, pcidioma)
                  || ': '
                  || NVL (v_fnacimi, pers_reg2.fnacimi)
                  || ', '
                  || f_axis_literales (9001171, pcidioma)
                  || ': '
                  || v_fcarnet
                  || ', '
                  || f_axis_literales (100962, pcidioma)
                  || ': '
                  || ff_desvalorfijo (11,
                                      pcidioma,
                                      NVL (v_csexo, pers_reg2.csexper)
                                     )
                  || ', '
                  || f_axis_literales (9001173, pcidioma)
                  || ': '
                  || v_npuntos;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vsperson := -1;
                  vdespues := vdespues || literal2 || ': --';
            END;

            vcgarant := 0;
            vnriesgo := c.nriesgo;
            vantes := vantes || CHR (10);
            vdespues := vdespues || CHR (10);
         END LOOP;

         IF vantes <> vdespues
         THEN
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vsperson
                              );
         END IF;

         vantes := '';
         vdespues := '';

         FOR c IN
            (SELECT e.nriesgo, e.sperson, e.norden, e.fnacimi, e.fcarnet,
                    e.csexo, e.npuntos
               FROM estautconductores e
              WHERE e.sseguro = psseguro
                AND e.nmovimi = pnmovimi
                AND NVL (pac_persona.f_sperson_spereal (e.sperson), -1) NOT IN (
                       SELECT NVL (a.sperson, -1)
                         FROM autconductores a
                        WHERE a.sseguro = pssegpol
                          AND a.nriesgo = e.nriesgo
                          AND a.nmovimi =
                                 (SELECT MAX (a1.nmovimi)
                                    FROM autconductores a1
                                   WHERE a1.sseguro = a.sseguro
                                     AND a1.nriesgo = a.nriesgo)))
         LOOP
            literal2 := f_axis_literales (9001027, pcidioma);    -- Conductor

            BEGIN
               SELECT a.sperson, a.norden, a.fnacimi, a.fcarnet, a.csexo,
                      a.npuntos
                 INTO vsperson, v_norden, v_fnacimi, v_fcarnet, v_csexo,
                      v_npuntos
                 FROM autconductores a
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autconductores a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.norden = c.norden;

               BEGIN
                  SELECT *
                    INTO pers_reg
                    FROM personas
                   WHERE sperson = vsperson;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     pers_reg.tnombre := NULL;
                     pers_reg.tapelli := NULL;
               END;

               vantes :=
                     vantes
                  || literal2
                  || ': '
                  || pers_reg.tnombre
                  || ' '
                  || pers_reg.tapelli
                  || ', '
                  || f_axis_literales (500102, pcidioma)
                  || ': '
                  || v_norden
                  || ', '
                  || f_axis_literales (100959, pcidioma)
                  || ': '
                  || NVL (v_fnacimi, pers_reg.fnacimi)
                  || ', '
                  || f_axis_literales (9001171, pcidioma)
                  || ': '
                  || v_fcarnet
                  || ', '
                  || f_axis_literales (100962, pcidioma)
                  || ': '
                  || ff_desvalorfijo (11,
                                      pcidioma,
                                      NVL (v_csexo, pers_reg.csexper)
                                     )
                  || ', '
                  || f_axis_literales (9001173, pcidioma)
                  || ': '
                  || v_npuntos;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vsperson := -1;
                  vantes := vantes || literal2 || ': --';
            END;

            BEGIN
               SELECT *
                 INTO pers_reg2
                 FROM estpersonas
                WHERE sperson = c.sperson;
            EXCEPTION
               WHEN OTHERS
               THEN
                  pers_reg2.tnombre := NULL;
                  pers_reg2.tapelli := NULL;
            END;

            vdespues :=
                  vdespues
               || literal2
               || ': '
               || pers_reg2.tnombre
               || ' '
               || pers_reg2.tapelli
               || ', '
               || f_axis_literales (500102, pcidioma)
               || ': '
               || c.norden
               || ', '
               || f_axis_literales (100959, pcidioma)
               || ': '
               || NVL (c.fnacimi, pers_reg2.fnacimi)
               || ', '
               || f_axis_literales (9001171, pcidioma)
               || ': '
               || c.fcarnet
               || ', '
               || f_axis_literales (100962, pcidioma)
               || ': '
               || ff_desvalorfijo (11,
                                   pcidioma,
                                   NVL (c.csexo, pers_reg2.csexper)
                                  )
               || ', '
               || f_axis_literales (9001173, pcidioma)
               || ': '
               || c.npuntos;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            vantes := vantes || CHR (10);
            vdespues := vdespues || CHR (10);
         END LOOP;

         IF vantes <> vdespues
         THEN
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vsperson
                              );
         END IF;
      -- BUG17255:DRA:22/07/2011:Fi
      ELSIF pcmotmov = 277
      THEN
         FOR c IN (SELECT e.nriesgo, e.nmovimi
                     FROM estautriesgos e
                    WHERE e.sseguro = psseguro AND e.nmovimi = pnmovimi)
         LOOP
            SELECT    pac_autos.f_desversion (a.cversion)
                   || ' - '
                   || f_axis_literales (9001045, pcidioma)
                   || ': '
                   || ff_desvalorfijo (290, pcidioma, a.ctipmat)
                   || ' - '
                   || a.cmatric
                   || ' - '
                   || f_axis_literales (9001072, pcidioma)
                   || ': '
                   || pac_autos.f_desuso (a.cuso, pcidioma)
                   || ' ('
                   || pac_autos.f_dessubuso (a.csubuso, pcidioma)
                   || ') - '
                   || f_axis_literales (9001074, pcidioma)
                   || ': '
                   || TO_DATE (a.fmatric, 'DD/MM/YYYY')
                   || ' - '
                   || f_axis_literales (9001066, pcidioma)
                   || ': '
                   || ff_desvalorfijo (295, pcidioma, a.nkilometros)
                   || ' - '
                   || f_axis_literales (9001075, pcidioma)
                   || ': '
                   || ff_desvalorfijo (108, pcidioma, a.cvehnue)
                   || ' - '
                   || f_axis_literales (1000247, pcidioma)
                   || ': '
                   || a.ivehicu
                   || ' - '
                   || f_axis_literales (9001063, pcidioma)
                   || ': '
                   || a.npma
                   || ' - '
                   || f_axis_literales (9001064, pcidioma)
                   || ': '
                   || a.ntara
                   || ' - '
                   || f_axis_literales (9001062, pcidioma)
                   || ': '
                   || ff_desvalorfijo (440, pcidioma, a.ccolor)
                   || ' - '
                   || f_axis_literales (9001061, pcidioma)
                   || ': '
                   || a.nbastid
                   || ' - '
                   || f_axis_literales (9001065, pcidioma)
                   || ': '
                   || a.nplazas
                   || ' - '
                   || f_axis_literales (9001078, pcidioma)
                   || ': '
                   || ff_desvalorfijo (296, pcidioma, a.cgaraje)
                   || ' - '
                   || f_axis_literales (9001067, pcidioma)
                   || ': '
                   || ff_desvalorfijo (108, pcidioma, a.cusorem)
                   || ' ('
                   || ff_desvalorfijo (297, pcidioma, a.cremolque)
                   || ') - '
                   || f_axis_literales (100588, pcidioma)
                   || ': '
                   || a.triesgo
              INTO vantes
              FROM autriesgos a
             WHERE a.sseguro = pssegpol
               AND a.nriesgo = c.nriesgo
               AND a.nmovimi =
                      (SELECT MAX (a1.nmovimi)
                         FROM autriesgos a1
                        WHERE a1.sseguro = a.sseguro
                              AND a1.nriesgo = a.nriesgo);

            SELECT    pac_autos.f_desversion (a.cversion)
                   || ' - '
                   || f_axis_literales (9001045, pcidioma)
                   || ': '
                   || ff_desvalorfijo (290, pcidioma, a.ctipmat)
                   || ' - '
                   || a.cmatric
                   || ' - '
                   || f_axis_literales (9001072, pcidioma)
                   || ': '
                   || pac_autos.f_desuso (a.cuso, pcidioma)
                   || ' ('
                   || pac_autos.f_dessubuso (a.csubuso, pcidioma)
                   || ') - '
                   || f_axis_literales (9001074, pcidioma)
                   || ': '
                   || TO_DATE (a.fmatric, 'DD/MM/YYYY')
                   || ' - '
                   || f_axis_literales (9001066, pcidioma)
                   || ': '
                   || ff_desvalorfijo (295, pcidioma, a.nkilometros)
                   || ' - '
                   || f_axis_literales (9001075, pcidioma)
                   || ': '
                   || ff_desvalorfijo (108, pcidioma, a.cvehnue)
                   || ' - '
                   || f_axis_literales (1000247, pcidioma)
                   || ': '
                   || a.ivehicu
                   || ' - '
                   || f_axis_literales (9001063, pcidioma)
                   || ': '
                   || a.npma
                   || ' - '
                   || f_axis_literales (9001064, pcidioma)
                   || ': '
                   || a.ntara
                   || ' - '
                   || f_axis_literales (9001062, pcidioma)
                   || ': '
                   || ff_desvalorfijo (440, pcidioma, a.ccolor)
                   || ' - '
                   || f_axis_literales (9001061, pcidioma)
                   || ': '
                   || a.nbastid
                   || ' - '
                   || f_axis_literales (9001065, pcidioma)
                   || ': '
                   || a.nplazas
                   || ' - '
                   || f_axis_literales (9001078, pcidioma)
                   || ': '
                   || ff_desvalorfijo (296, pcidioma, a.cgaraje)
                   || ' - '
                   || f_axis_literales (9001067, pcidioma)
                   || ': '
                   || ff_desvalorfijo (108, pcidioma, a.cusorem)
                   || ' ('
                   || ff_desvalorfijo (297, pcidioma, a.cremolque)
                   || ') - '
                   || f_axis_literales (100588, pcidioma)
                   || ': '
                   || a.triesgo
              INTO vdespues
              FROM estautriesgos a
             WHERE a.sseguro = psseguro
               AND a.nriesgo = c.nriesgo
               AND a.nmovimi = pnmovimi;

            literal := f_axis_literales (9001037, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := 1;
            vcgarant := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov = 282
      THEN
         SELECT s.cduraci
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT s.cduraci
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (100715, pcidioma);
         vantes := literal || ' ' || ff_desvalorfijo (41, pcidioma, vantes);
         vdespues :=
                    literal || ' ' || ff_desvalorfijo (41, pcidioma, vdespues);
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov IN (220, 729)
      THEN
         --JRH 729
         SELECT crevali, prevali, irevali           -- BUG11737:DRA:26/01/2010
           INTO crevalia, prevalia, irevalia
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT crevali, prevali, irevali           -- BUG11737:DRA:26/01/2010
           INTO crevalid, prevalid, irevalid
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (101431, pcidioma);
         num_err := f_desvalorfijo (62, pcidioma, crevalia, vantes);
         num_err := f_desvalorfijo (62, pcidioma, crevalid, vdespues);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;

         IF prevalia IS NOT NULL
         THEN
            IF crevalia = 1
            THEN
               vantes :=
                  vantes || ' - '
                  || TO_CHAR (irevalia, 'FM999G999G999G990D00');
            ELSE
               vantes := vantes || ' - ' || prevalia || '%';
            END IF;
         END IF;

         IF prevalid IS NOT NULL
         THEN
            IF crevalid = 1
            THEN
               vdespues :=
                     vdespues
                  || ' - '
                  || TO_CHAR (irevalid, 'FM999G999G999G990D00');
            ELSE
               vdespues := vdespues || ' - ' || prevalid || '%';
            END IF;
         END IF;

         vnriesgo := 1;
         vcgarant := 0;
      -- Bug 11735 - RSC - 03/02/2010 - Se anade el motivo 237
      -- Bug 14738 - RSC - 05/07/2010 - APR703 - Traspasos de garant?as   (anadimos 608)
      ELSIF pcmotmov IN (237, 608)
      THEN
         -- Bug 14738 - RSC - 05/07/2010 - APR703 - Traspasos de garant?as
         IF pcmotmov IN (608)
         THEN
            FOR c IN garantias_real_baja
            LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_desgarantia (c.cgarant, pcidioma, literal);

               BEGIN
                  SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                    INTO vantes
                    FROM garanseg
                   WHERE sseguro = pssegpol
                     AND nriesgo = c.nriesgo
                     AND cgarant = c.cgarant
                     AND ffinefe IS NULL;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := 0;                                     --nuLL;
               END;

               vdespues := literal || ': ' || c.despues;
               vantes := literal || ': ' || vantes;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END LOOP;
         END IF;

         -- Fin Bug 14738
         -- Bug 23037 - 10/09/2012 - APD - se modifica la select (cursor)
         --FOR c IN garantias_est
         FOR c IN (SELECT TO_CHAR (NVL (s.icapital, 0),
                                   'FM999G999G999G990D00'
                                  ) despues,
                          s.cgarant, s.nriesgo, s.iprianu
                     FROM estgaranseg s, estseguros x
                    WHERE s.sseguro = psseguro
                      AND s.nmovimi = pnmovimi
                      AND s.sseguro = x.sseguro
                      AND s.cobliga = 1
                      AND NOT EXISTS (
                             SELECT g.cgarant
                               FROM garanseg g
                              WHERE g.sseguro = pssegpol
                                AND g.ffinefe IS NULL
                                AND g.nriesgo = s.nriesgo
                                AND g.cgarant = s.cgarant))
         -- fin Bug 23037 - 10/09/2012 - APD
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                 INTO vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;                                        --nuLL;
            END;

            -- Bug 14738 - RSC - 05/07/2010 - APR703 - Traspasos de garant?as
            IF pcmotmov IN (608)
            THEN
               vdespues :=
                     f_axis_literales (9901266, pcidioma)
                  || '('
                  || literal
                  || '): '
                  || c.despues;
            ELSE
               vdespues := literal || ': ' || c.despues;
            END IF;

            -- Fin Bug 14738
            vantes := literal || ': ' || vantes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- Bug.: 8947 - ICV - Se anade el motivo de movimiento 516
         -- Bug.: 11349 - JMF - Se anade el motivo de movimiento 688
         -- Fin Bug 14738
            -- INI IAXIS-5423  CJMR 23/09/2019
         IF pcmotmov IN (237)
         THEN
            FOR franq_alta IN bonfranseg_alta
            LOOP
               literal := f_axis_literales (9001800, pcidioma);
               vtnivel_antes := NULL;
               vtnivel_despues := NULL;
               literal :=
                     literal
                  || ' '
                  || ff_desfranquicia (franq_alta.cgrup, pcidioma);
               vantes := literal || ': ';
               vdespues := literal || ': ';

               BEGIN
                  SELECT tnivel
                    INTO vtnivel_despues
                    FROM bf_desnivel
                   WHERE cgrup = franq_alta.cgrup
                     AND cnivel = franq_alta.cnivel
                     AND cidioma = pcidioma;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     vtnivel_despues := NULL;
               END;

               literal := f_axis_literales (9904858, pcidioma);
               vdespues := vdespues || vtnivel_despues || ' - ' || literal;
               vdespues :=
                     vdespues
                  || ' '
                  || franq_alta.impmin
                  || '  '
                  || ff_desvalorfijo (1104, pcidioma, franq_alta.cimpmin);

               IF vantes <> vdespues
               THEN
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     franq_alta.cgrup,
                                     vantes,
                                     vdespues,
                                     0
                                    );
               END IF;
            END LOOP;
         END IF;
      -- FIN IAXIS-5423  CJMR 23/09/2019

      -- Bug 14741 - RSC - 07/06/2010 - APR703 - Baja de garant?as b?sicas
      ELSIF pcmotmov IN (239)
      THEN
         FOR c IN garantias_real_baja
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                 INTO vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;                                        --nuLL;
            END;

            vdespues := literal || ': ' || c.despues;
            vantes := literal || ': ' || vantes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- Bug.: 8947 - ICV - Se anade el motivo de movimiento 516
         -- Bug.: 11349 - JMF - Se anade el motivo de movimiento 688
         -- Fin Bug 14741
            -- INI IAXIS-5423  CJMR 23/09/2019
         FOR franq_ant IN bonfranseg_antes
         LOOP
            literal := f_axis_literales (9001800, pcidioma);
            vtnivel_antes := NULL;
            vtnivel_despues := NULL;
            literal :=
               literal || ' ' || ff_desfranquicia (franq_ant.cgrup, pcidioma);
            vantes := literal || ': ';
            vdespues := literal || ': ';
            

            BEGIN
               SELECT tnivel
                 INTO vtnivel_antes
                 FROM bf_desnivel
                WHERE cgrup = franq_ant.cgrup
                  AND cnivel = franq_ant.cnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_antes := NULL;
            END;
            SELECT b.nriesgo, b.cnivel, b.cimpmin, b.impmin, b.impvalor1
              INTO vnriesgo, vcnivel, vcimpmin, vimpmin, vimpvalor1
              FROM estbf_bonfranseg b
             WHERE b.sseguro = psseguro
               AND b.nmovimi = pnmovimi
               AND b.cgrup = franq_ant.cgrup
               AND b.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
               AND b.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL);

            BEGIN
               SELECT tnivel
                 INTO vtnivel_antes
                 FROM bf_desnivel
                WHERE cgrup = franq_ant.cgrup
                  AND cnivel = franq_ant.cnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_antes := NULL;
            END;

            literal := f_axis_literales (9904858, pcidioma);
            vantes := vantes || vtnivel_antes || ' - ' || literal;
            vantes :=
                  vantes
               || ' '
               || franq_ant.impmin
               || '  '
               || ff_desvalorfijo (1104, pcidioma, franq_ant.cimpmin);
               
               

            IF vantes <> vdespues
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  franq_ant.cgrup,
                                  vantes,
                                  vdespues,
                                  0
                                 );
            END IF;
         END LOOP;
      -- FIN IAXIS-5423  CJMR 23/09/2019

      -- Bug 13832 - RSC - 10/06/2010 - APRS015 - suplemento de aportaciones ?nicas
      ELSIF pcmotmov IN (600)
      THEN
         v_crespue_a := NULL;

         FOR regs IN
            (SELECT TO_CHAR (d.icapital, 'FM999G999G999G990D00') v_crespue_d,
                    d.cgarant vcgarant, d.nriesgo vnriesgo
               FROM estgaranseg g, estdetgaranseg d, estseguros s
              WHERE s.sseguro = psseguro
                AND g.sseguro = s.sseguro
                AND g.cobliga = 1
                AND g.sseguro = d.sseguro
                AND g.nmovimi = d.nmovimi
                AND g.nriesgo = d.nriesgo
                AND g.cgarant = d.cgarant
                AND d.ndetgar NOT IN (
                       SELECT ndetgar
                         FROM garanseg g2, detgaranseg d2
                        WHERE g2.sseguro = pssegpol
                          AND g2.ffinefe IS NULL
                          AND g2.sseguro = d2.sseguro
                          AND g2.nmovimi = d2.nmovimi
                          AND g2.cgarant = d2.cgarant
                          AND g2.nriesgo = d2.nriesgo
                          AND g2.cgarant = d.cgarant
                          AND g2.nriesgo = d.nriesgo
                          AND g2.nmovimi = d.nmovimi - 1)
                AND d.cunica = 1)
         LOOP
            literal := f_axis_literales (180435, pcidioma);
            -- Aportaci?n extraordinaria
            vantes := v_crespue_a;
            vdespues :=
                  literal
               || ' ('
               || ff_desgarantia (regs.vcgarant, pcidioma)
               || '): '
               || regs.v_crespue_d;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               regs.vnriesgo,
                               regs.vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- Fin Bug 13832
      -- Bug 0016961 - 20/12/2010 - SMF  ELSIF pcmotmov IN(665, 281, 669, 516, 517, 688, 238) THEN
      --FAC
      ELSIF pcmotmov IN (915)
      THEN
         FOR c IN garantias_vigencia_est
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT 'Valor Asegurado ' || g.crespue
                 INTO vantes
                 FROM pregungaranseg g, seguros s
                WHERE g.sseguro = pssegpol
                  AND s.sseguro = g.sseguro
                  AND NVL
                         (f_pargaranpro_v
                             (s.cramo,
                              s.cmodali,
                              s.ctipseg,
                              s.ccolect,
                              s.cactivi,
                              g.cgarant,
                              UPPER (' TIPO
                                ')
                             ),
                          0
                         ) NOT IN (4, 5)
                  AND g.cpregun = 2893
                  AND g.nmovimi = (SELECT MAX (p.nmovimi)
                                     FROM pregunseg p
                                    WHERE p.sseguro = pssegpol)
                  AND g.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                  AND g.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = pssegpol
                                   AND er.fanulac IS NULL);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;
            END;

            vdespues := literal || ': ' || c.despues;
            vantes := literal || ': ' || vantes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );

            BEGIN
               SELECT    'FIni: '
                      || TO_CHAR (finivig, 'DD/MM/YYYY')
                      || ' FFin: '
                      || TO_CHAR (ffinvig, 'DD/MM/YYYY')
                 INTO vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;                                        --nuLL;
            END;

            vdespues := literal || ': ' || c.despues;
            vantes := literal || ': ' || vantes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- Validamos si se ha movido la fecha vencimiento
         SELECT    f_axis_literales (120453, pcidioma)
                || ' '
                || TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT    f_axis_literales (120453, pcidioma)
                || ' '
                || TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         vnriesgo := 1;
         vcgarant := 0;

         IF vantes <> vdespues
         THEN
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;

         IF psproduc NOT IN (80007, 80008, 80009, 80010)
         THEN                                    -- IAXIS-3396 CJMR 09/04/2019
            --Validamos cambios en el plazo de ejecuci?n
            SELECT    f_axis_literales (9908900, pcidioma)
                   || ': ('
                   || TO_CHAR (s.fefeplazo, 'DD/MM/YYYY')
                   || ' - '
                   || TO_CHAR (s.fvencplazo, 'DD/MM/YYYY')
                   || ')'
              INTO vantes
              FROM seguros s
             WHERE s.sseguro = pssegpol;

            SELECT    f_axis_literales (9908900, pcidioma)
                   || ': ('
                   || TO_CHAR (s.fefeplazo, 'DD/MM/YYYY')
                   || ' - '
                   || TO_CHAR (s.fvencplazo, 'DD/MM/YYYY')
                   || ')'
              INTO vdespues
              FROM estseguros s
             WHERE s.sseguro = psseguro;
         END IF;                                 -- IAXIS-3396 CJMR 09/04/2019

         vnriesgo := 1;
         vcgarant := 0;
         vcpregun := 1;
         -- Ini IAXIS-6141 -- ECP -- 03/03/2020
         -- INI IAXIS-5423  CJMR 23/09/2019
         FOR franq_ant IN bonfranseg_antes
         LOOP
            literal := f_axis_literales (9001800, pcidioma);
            vtnivel_antes := NULL;
            vtnivel_despues := NULL;
            literal :=
               literal || ' ' || ff_desfranquicia (franq_ant.cgrup, pcidioma);
            vantes := literal || ': ';
            vdespues := literal || ': ';

            SELECT b.nriesgo, b.cnivel, b.cimpmin, b.impmin, b.cvalor1, b.impvalor1
              INTO vnriesgo, vcnivel, vcimpmin, vimpmin, vcvalor1, vimpvalor1
              FROM estbf_bonfranseg b
             WHERE b.sseguro = psseguro
               AND b.nmovimi = pnmovimi
               AND b.cgrup = franq_ant.cgrup
               AND b.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
               AND b.nriesgo IN (
                            SELECT er.nriesgo
                              FROM estriesgos er
                             WHERE er.sseguro = psseguro
                                   AND er.fanulac IS NULL);

            BEGIN
               SELECT tnivel
                 INTO vtnivel_antes
                 FROM bf_desnivel
                WHERE cgrup = franq_ant.cgrup
                  AND cnivel = franq_ant.cnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_antes := NULL;
            END;

            BEGIN
               SELECT tnivel
                 INTO vtnivel_despues
                 FROM bf_desnivel
                WHERE cgrup = franq_ant.cgrup
                  AND cnivel = vcnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_despues := NULL;
            END;
            literal := f_axis_literales (9904858, pcidioma);
            vantes := vantes || vtnivel_antes || ' - ' || literal;
            vdespues := vdespues || vtnivel_despues || ' - ' || literal;
            vantes :=
                  vantes
               || ' '
               || franq_ant.impmin
               || '  '
               || ff_desvalorfijo (1104, pcidioma, franq_ant.cimpmin);
            vdespues :=
                  vdespues
               || ' '
               || vimpmin
               || '  '
               || ff_desvalorfijo (1104, pcidioma, vcimpmin);
             BEGIN
               SELECT impvalor1
                 INTO vtnivel_antes
                 FROM bf_detnivel
                WHERE cgrup = franq_ant.cgrup
                   AND impvalor1 = franq_ant.impvalor1
                 ;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_antes := NULL;
            END;

            BEGIN
               SELECT impvalor1
                 INTO vtnivel_despues
                 FROM bf_detnivel
                WHERE cgrup = franq_ant.cgrup
                  AND impvalor1 = vimpvalor1
                  ;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_despues := NULL;
            END;

            literal := f_axis_literales (9904858, pcidioma);
            vantes := vantes || vtnivel_antes;
            vdespues := vdespues || vtnivel_despues;
            vantes :=
                  vantes
               || ' '
               || franq_ant.impvalor1
               || '  '
               || ff_desvalorfijo (1104, pcidioma, franq_ant.cvalor1);
            vdespues :=
                  vdespues
               || ' '
               || vimpvalor1
               || '  '
               || ff_desvalorfijo (1104, pcidioma, vcvalor1);
               
                
                      -- Fin IAXIS-6141 -- ECP -- 03/03/2020
            IF vantes <> vdespues
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  franq_ant.cgrup,
                                  vantes,
                                  vdespues,
                                  0
                                 );
            END IF;
         END LOOP;
      -- FIN IAXIS-5423  CJMR 23/09/2019

      /* if vantes<>vdespues then
              p_insdetmovseguro(psseguro,
                                pnmovimi,
                                pcmotmov,
                                vnriesgo,
                                vcgarant,
                                vantes,
                                vdespues,
                                vcpregun);
            end if;
      */
          -- INI CONF-233 - 31/08/2016 ? JLTS ? Traslado de vigencia
      ELSIF pcmotmov IN (918)
      THEN
         -- INI BUG 647 - XX/XX/2018 - JLTS
         -- Validamos si se ha movido la fecha efecto, vencimiento,
         SELECT    f_axis_literales (100883, pcidioma)
                || ' '
                || TO_CHAR (s.fefecto, 'DD/MM/YYYY'),
                   f_axis_literales (100885, pcidioma)
                || ' '
                || TO_CHAR (s.fvencim, 'DD/MM/YYYY'),
                   f_axis_literales (9000526, pcidioma)
                || ' '
                || TO_CHAR (s.fefeplazo, 'DD/MM/YYYY'),
                   f_axis_literales (9000527, pcidioma)
                || ' '
                || TO_CHAR (s.fvencplazo, 'DD/MM/YYYY')
           INTO vantes,
                v_fdummy01_ant,
                v_fdummy02_ant,
                v_fdummy03_ant
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT    f_axis_literales (100883, pcidioma)
                || ' '
                || TO_CHAR (s.fefecto, 'DD/MM/YYYY'),
                   f_axis_literales (100885, pcidioma)
                || ' '
                || TO_CHAR (s.fvencim, 'DD/MM/YYYY'),
                   f_axis_literales (9000526, pcidioma)
                || ' '
                || TO_CHAR (s.fefeplazo, 'DD/MM/YYYY'),
                   f_axis_literales (9000527, pcidioma)
                || ' '
                || TO_CHAR (s.fvencplazo, 'DD/MM/YYYY')
           INTO vdespues,
                v_fdummy01_des,
                v_fdummy02_des,
                v_fdummy03_des
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         vnriesgo := 1;
         vcgarant := 0;

         -- Se evalua la fecha efecto
         IF vantes <> vdespues
         THEN
            v_fdummy04_ant := vantes;
            v_fdummy04_des := vdespues;
         END IF;

         -- Se evalua la fecha vencimiento
         IF v_fdummy01_ant <> v_fdummy01_des
         THEN
            IF v_fdummy04_ant IS NULL
            THEN
               v_fdummy04_ant := v_fdummy01_ant;
               v_fdummy04_des := v_fdummy01_des;
            ELSE
               v_fdummy04_ant := v_fdummy04_ant || ' - ' || v_fdummy01_ant;
               v_fdummy04_des := v_fdummy04_des || ' - ' || v_fdummy01_des;
            END IF;
         END IF;

         -- Se evalua la fecha inicio ejecuci?n
         IF v_fdummy02_ant <> v_fdummy02_des
         THEN
            IF v_fdummy04_ant IS NULL
            THEN
               v_fdummy04_ant := v_fdummy02_ant;
               v_fdummy04_des := v_fdummy02_des;
            ELSE
               v_fdummy04_ant := v_fdummy04_ant || ' - ' || v_fdummy02_ant;
               v_fdummy04_des := v_fdummy04_des || ' - ' || v_fdummy02_des;
            END IF;
         END IF;

         -- Se evalua la fecha fin ejecuci?n
         IF v_fdummy03_ant <> v_fdummy03_des
         THEN
            IF v_fdummy04_ant IS NULL
            THEN
               v_fdummy04_ant := v_fdummy03_ant;
               v_fdummy04_des := v_fdummy03_des;
            ELSE
               v_fdummy04_ant := v_fdummy04_ant || ' - ' || v_fdummy03_ant;
               v_fdummy04_des := v_fdummy04_des || ' - ' || v_fdummy03_des;
            END IF;
         END IF;

         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            vnriesgo,
                            vcgarant,
                            v_fdummy04_ant,
                            v_fdummy04_des,
                            vcpregun
                           );
      -- FIN BUG 647 - XX/XX/2018 - JLTS
      -- FIN CONF-233 - 25/08/2016 ? JLTS ? Traslado de vigencia
      ---FAC
      ELSIF pcmotmov IN (665, 281, 669, 516, 517, 688, 246, 247, 826)
      THEN
         IF NVL (f_parproductos_v (psproduc, 'REC_RIESGO_AHORRO'), 0) = 0
         THEN
            FOR c IN garantias_real
            LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_desgarantia (c.cgarant, pcidioma, literal);

               BEGIN
                  SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                    INTO vdespues
                    FROM estgaranseg
                   WHERE sseguro = psseguro
                     AND nriesgo = c.nriesgo
                     AND cgarant = c.cgarant
                     AND cobliga = 1
                     AND nmovimi = pnmovimi;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vdespues := 0;
               END;

               vantes := literal || ': ' || c.antes;
               vdespues := literal || ': ' || vdespues;              --||' ?';
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END LOOP;

            FOR c IN garantias_est
            LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_desgarantia (c.cgarant, pcidioma, literal);

               BEGIN
                  SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                    INTO vantes
                    FROM garanseg
                   WHERE sseguro = pssegpol
                     AND nriesgo = c.nriesgo
                     AND cgarant = c.cgarant
                     AND ffinefe IS NULL;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := 0;                                     --nuLL;
               END;

               vdespues := literal || ': ' || c.despues;
               vantes := literal || ': ' || vantes;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END LOOP;
         ELSE
            IF pcmotmov IN (246)
            THEN
               -- Por el 281 entrariamos! Es lo que queremos!
               FOR c IN garantias_real
               LOOP
                  vantes := NULL;
                  vdespues := NULL;
                  num_err := f_desgarantia (c.cgarant, pcidioma, literal);

                  BEGIN
                     SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                       INTO vdespues
                       FROM estgaranseg
                      WHERE sseguro = psseguro
                        AND nriesgo = c.nriesgo
                        AND cgarant = c.cgarant
                        AND cobliga = 1
                        AND nmovimi = pnmovimi;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := 0;
                  END;

                  vantes := literal || ': ' || c.antes;
                  vdespues := literal || ': ' || vdespues;           --||' ?';
                  vcgarant := c.cgarant;
                  vnriesgo := c.nriesgo;

                  IF literal2 IS NOT NULL
                  THEN
                     vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                     vdespues :=
                               literal2 || ' ' || vnriesgo || ' ' || vdespues;
                  END IF;

                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END LOOP;

               FOR c IN garantias_est
               LOOP
                  vantes := NULL;
                  vdespues := NULL;
                  num_err := f_desgarantia (c.cgarant, pcidioma, literal);

                  BEGIN
                     SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                       INTO vantes
                       FROM garanseg
                      WHERE sseguro = pssegpol
                        AND nriesgo = c.nriesgo
                        AND cgarant = c.cgarant
                        AND ffinefe IS NULL;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := 0;                                  --nuLL;
                  END;

                  vdespues := literal || ': ' || c.despues;
                  vantes := literal || ': ' || vantes;
                  vcgarant := c.cgarant;
                  vnriesgo := c.nriesgo;

                  IF literal2 IS NOT NULL
                  THEN
                     vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                     vdespues :=
                              literal2 || ' ' || c.nriesgo || ' ' || vdespues;
                  END IF;

                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END LOOP;
            ELSE
               FOR c IN garantias_real_not_in_246
               LOOP
                  vantes := NULL;
                  vdespues := NULL;
                  num_err := f_desgarantia (c.cgarant, pcidioma, literal);
                  vcontratada := TRUE;

                  BEGIN
                     SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                       INTO vdespues
                       FROM estgaranseg
                      WHERE sseguro = psseguro
                        AND nriesgo = c.nriesgo
                        AND cgarant = c.cgarant
                        AND cobliga = 1
                        AND nmovimi = pnmovimi;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := 0;
                        vcontratada := FALSE;
                  END;

                  vantes := literal || ': ' || c.antes;
                  vdespues := literal || ': ' || vdespues;           --||' ?';

                  -- Ini 26488 -- ECP -- 06/05/2013
                  BEGIN
                     IF NVL (f_parproductos_v (psproduc,
                                               'ADMITE_CERTIFICADOS'),
                             0
                            ) = 1
                     THEN
                        v_escertif0 :=
                              pac_seguros.f_get_escertifcero (NULL, pssegpol);

                        --AGG 09/12/2013 Bug: 0026508/0160502
                        IF v_escertif0 > 0 AND NOT vcontratada
                        THEN
                           vantes := literal;
                           -- Ini 27539 -- ECP -- 04/07/2013 vdespues := ''; Se cambia por
                           vdespues :=
                                 literal
                              || ': '
                              || f_axis_literales (9905756, pcidioma);
                        -- Fin 27539 -- ECP -- 04/07/2013
                        END IF;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        NULL;
                  END;

                  -- Fin26488 -- ECP -- 06/05/2013
                  vcgarant := c.cgarant;
                  vnriesgo := c.nriesgo;

                  IF literal2 IS NOT NULL
                  THEN
                     vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                     vdespues :=
                               literal2 || ' ' || vnriesgo || ' ' || vdespues;
                  END IF;

                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END LOOP;

               FOR c IN garantias_est_not_in_246
               LOOP
                  vantes := NULL;
                  vdespues := NULL;
                  num_err := f_desgarantia (c.cgarant, pcidioma, literal);
                  vcontratada := TRUE;

                  BEGIN
                     SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                       INTO vantes
                       FROM garanseg
                      WHERE sseguro = pssegpol
                        AND nriesgo = c.nriesgo
                        AND cgarant = c.cgarant
                        AND ffinefe IS NULL;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := 0;                                  --nuLL;
                        vcontratada := FALSE;
                  END;

                  vdespues := literal || ': ' || c.despues;
                  vantes := literal || ': ' || vantes;

                  -- Ini 26488 -- ECP -- 06/05/2013
                  BEGIN
                     IF NVL (f_parproductos_v (psproduc,
                                               'ADMITE_CERTIFICADOS'),
                             0
                            ) = 1
                     THEN
                        v_escertif0 :=
                              pac_seguros.f_get_escertifcero (NULL, pssegpol);

                        --AGG 09/12/2013 Bug: 0026508/0160502
                        IF v_escertif0 > 0 AND NOT vcontratada
                        THEN
                           -- Ini 27539 -- ECP -- 04/07/2013 vantes := ''; Se cambia por
                           vantes :=
                                 literal
                              || ': '
                              || f_axis_literales (9905756, pcidioma);
                           -- Fin 27539 -- ECP -- 04/07/2013
                           vdespues := literal;
                        END IF;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        NULL;
                  END;

                  -- Fin 26488 -- ECP -- 06/05/2013
                  vcgarant := c.cgarant;
                  vnriesgo := c.nriesgo;

                  IF literal2 IS NOT NULL
                  THEN
                     vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                     vdespues :=
                              literal2 || ' ' || c.nriesgo || ' ' || vdespues;
                  END IF;

                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END LOOP;
            END IF;
         END IF;

         -- Bug 13832 - RSC - 10/06/2010 - APRS015 - suplemento de aportaciones ?nicas
         IF pcmotmov NOT IN (238, 246, 247)
         THEN
            -- Fin Bug 13832

            /* Recuperar los cambios en las preguntas de garantias*/
            FOR c IN
               (SELECT DECODE (cp.ctippre,
                               4, p.trespue,        -- BUG10985:DRA:26/08/2009
                               5, p.trespue,
                               p.crespue
                              ) antes,
                       p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                  FROM pregungaranseg p,
                       pregunprogaran e,
                       seguros s,
                       codipregun cp
                 WHERE p.cpregun = e.cpregun
                   AND p.sseguro = s.sseguro
                   AND s.sseguro = pssegpol
                   AND p.cgarant = e.cgarant
                   AND e.sproduc = psproduc
                   AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                       )                             --BUG23860:DCT:26/10/2012
                   AND cp.cpregun = p.cpregun        -- BUG9988:DRA:30/04/2009
                   AND p.nmovimi IN (SELECT MAX (nmovimi)
                                       FROM garanseg gg
                                      WHERE gg.sseguro = pssegpol)
                   AND NOT EXISTS (
                          SELECT ep.cpregun
                            FROM estpregungaranseg ep
                           WHERE ep.sseguro = psseguro
                             AND ep.nmovimi = pnmovimi
                             AND ep.nriesgo = p.nriesgo
                             AND ep.cgarant = p.cgarant
                             AND ep.cpregun = p.cpregun
                             AND DECODE (cp.ctippre,
                                         4, NVL (ep.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (ep.trespue, '**'),
                                         TO_CHAR (ep.crespue)
                                        ) =
                                    DECODE (cp.ctippre,
                                            4, NVL (p.trespue, '**'),
                                            -- BUG10985:DRA:26/08/2009
                                            5, NVL (p.trespue, '**'),
                                            TO_CHAR (p.crespue)
                                           ))
                   -- 29991#c166807
                   AND EXISTS (
                          SELECT 1
                            FROM estgaranseg g
                           WHERE g.sseguro = psseguro
                             AND g.nriesgo = p.nriesgo
                             AND g.cgarant = p.cgarant
                             AND g.nmovimi = pnmovimi
                             AND g.cobliga = 1))
            LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE (cp.ctippre,
                                 4, ep.trespue,     -- BUG10985:DRA:26/08/2009
                                 5, ep.trespue,
                                 ep.crespue
                                )
                    INTO vdespues
                    FROM estpregungaranseg ep, codipregun cp
                   WHERE ep.sseguro = psseguro
                     AND ep.nriesgo = c.nriesgo
                     AND ep.cgarant = c.cgarant     -- BUG14172:DRA:19/04/2010
                     AND ep.cpregun = c.cpregun
                     AND ep.nmovimi = pnmovimi
                     AND cp.cpregun = ep.cpregun;    -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vdespues := '';                                  --NULL;
               END;

               vantes := c.antes;
               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
               p_recuperadescripcrespue (psproduc,
                                         c.cpregun,
                                         vantes,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               -- Nom?s en el cas que sigui amb llista de valors
               -- BUG12590:07/01/2010:DRA:Fi
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END LOOP;

            FOR c IN
               (SELECT DECODE (cp.ctippre,
                               4, p.trespue,        -- BUG10985:DRA:26/08/2009
                               5, p.trespue,
                               p.crespue
                              ) despues,
                       p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                  FROM estpregungaranseg p,
                       pregunprogaran e,
                       estseguros s,
                       codipregun cp,
                       estgaranseg g
                 WHERE s.sseguro = psseguro
                   AND g.sseguro = s.sseguro        -- BUG11737:DRA:25/01/2010
                   AND g.nmovimi = pnmovimi         -- BUG11737:DRA:25/01/2010
                   AND g.cobliga = 1                -- BUG11737:DRA:25/01/2010
                   AND p.sseguro = g.sseguro
                   AND p.nriesgo = g.nriesgo
                   AND p.cgarant = g.cgarant
                   AND p.nmovimi = g.nmovimi
                   AND e.cpregun = p.cpregun
                   AND e.cgarant = p.cgarant
                   AND e.sproduc = psproduc
                   AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                       )                             --BUG23860:DCT:26/10/2012
                   AND cp.cpregun = p.cpregun        -- BUG9988:DRA:30/04/2009
                   AND NOT EXISTS (
                          SELECT ep.cpregun
                            FROM pregungaranseg ep
                           WHERE ep.sseguro = pssegpol
                             AND ep.nriesgo = p.nriesgo
                             AND ep.cgarant = p.cgarant
                             AND ep.cpregun = p.cpregun
                             AND ep.nmovimi IN (SELECT MAX (nmovimi)
                                                  FROM garanseg gg
                                                 WHERE gg.sseguro = pssegpol)
                             AND DECODE (cp.ctippre,
                                         4, NVL (ep.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (ep.trespue, '**'),
                                         TO_CHAR (ep.crespue)
                                        ) =
                                    DECODE (cp.ctippre,
                                            4, NVL (p.trespue, '**'),
                                            -- BUG10985:DRA:26/08/2009
                                            5, NVL (p.trespue, '**'),
                                            TO_CHAR (p.crespue)
                                           ))
                   --29991#c166807
                   AND EXISTS (
                          SELECT 1
                            FROM garanseg g
                           WHERE g.sseguro = pssegpol
                             AND g.nriesgo = p.nriesgo
                             AND g.cgarant = p.cgarant
                             AND g.nmovimi IN (SELECT MAX (nmovimi)
                                                 FROM garanseg gg
                                                WHERE gg.sseguro = pssegpol)))
            LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE (cp.ctippre,
                                 4, p.trespue,      -- BUG10985:DRA:26/08/2009
                                 5, p.trespue,
                                 p.crespue
                                )
                    INTO vantes
                    FROM pregungaranseg p, codipregun cp
                   WHERE p.sseguro = pssegpol
                     AND p.nriesgo = c.nriesgo
                     AND p.cpregun = c.cpregun
                     AND p.cgarant = c.cgarant      -- BUG14172:DRA:19/04/2010
                     AND p.nmovimi =
                            (SELECT MAX (p1.nmovimi)
                               -- BUG14172:DRA:19/04/2010
                             FROM   garanseg p1
                              WHERE p1.sseguro = pssegpol
                                AND p1.nriesgo = c.nriesgo
                                                          --                                         AND p1.cgarant = c.cgarant
                                                          --                                         AND p1.cpregun = c.cpregun
                            )
                     AND cp.cpregun = p.cpregun;     -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vdespues := '';                                  --NULL;
               END;

               vdespues := c.despues;
               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
               p_recuperadescripcrespue (psproduc,
                                         c.cpregun,
                                         vantes,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               -- Nom?s en el cas que sigui amb llista de valors
               -- BUG12590:07/01/2010:DRA:Fi
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END LOOP;

            /*-- Bug 10961.21/09/2009.i.S'elimina un tro? de codi

            -- Bug 13832 - RSC - 10/06/2010 - APRS015 - suplemento de aportaciones ?nicas
            FOR c IN (SELECT DECODE(p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor) antes,
                             p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                        FROM pregungaransegtab p, pregunprogaran e, seguros s, codipregun cp
                       WHERE p.cpregun = e.cpregun
                         AND p.sseguro = s.sseguro
                         AND s.sseguro = pssegpol
                         AND p.cgarant = e.cgarant
                         AND e.sproduc = psproduc
                         AND((e.cpretip <> 2)
                             OR(e.cpretip = 2
                                AND e.esccero = 1))   --BUG23860:DCT:26/10/2012
                         AND cp.cpregun = p.cpregun
                         AND NOT EXISTS(SELECT ep.cpregun
                                          FROM estpregungaransegtab ep
                                         WHERE ep.sseguro = psseguro
                                           AND ep.nmovimi = pnmovimi
                                           AND ep.nriesgo = p.nriesgo
                                           AND ep.cgarant = p.cgarant
                                           AND ep.cpregun = p.cpregun
                                           AND DECODE(p.ccolumna,
                                                      2, NVL(ep.tvalor, '**'),
                                                      3, NVL(ep.fvalor, '**'),
                                                      TO_CHAR(ep.nvalor)) =
                                                 DECODE(p.ccolumna,
                                                        2, NVL(p.tvalor, '**'),
                                                        3, NVL(p.fvalor, '**'),
                                                        TO_CHAR(p.nvalor)))) LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_despregunta(c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE(ep.ccolumna, 2, ep.tvalor, 3, ep.fvalor, ep.nvalor)
                    INTO vdespues
                    FROM estpregungaransegtab ep, codipregun cp
                   WHERE ep.sseguro = psseguro
                     AND ep.nriesgo = c.nriesgo
                     AND ep.cgarant = c.cgarant
                     AND ep.cpregun = c.cpregun
                     AND ep.nmovimi = pnmovimi
                     AND cp.cpregun = ep.cpregun;
               EXCEPTION
                  WHEN NO_DATA_FOUND THEN
                     vdespues := '';   --NULL;
               END;

               vantes := c.antes;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;
               p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes,
                                 vdespues, c.cpregun);
            END LOOP;

            FOR c IN (SELECT DECODE(p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor) despues,
                             p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                        FROM estpregungaransegtab p, pregunprogaran e, estseguros s,
                             codipregun cp, estgaranseg g
                       WHERE s.sseguro = psseguro
                         AND g.sseguro = s.sseguro
                         AND g.nmovimi = pnmovimi
                         AND g.cobliga = 1   -- BUG11737:DRA:25/01/2010
                         AND p.sseguro = g.sseguro
                         AND p.nriesgo = g.nriesgo
                         AND p.cgarant = g.cgarant
                         AND p.nmovimi = g.nmovimi
                         AND e.cpregun = p.cpregun
                         AND e.cgarant = p.cgarant
                         AND e.sproduc = psproduc
                         AND((e.cpretip <> 2)
                             OR(e.cpretip = 2
                                AND e.esccero = 1))   --BUG23860:DCT:26/10/2012
                         AND cp.cpregun = p.cpregun
                         AND NOT EXISTS(SELECT ep.cpregun
                                          FROM pregungaransegtab ep
                                         WHERE ep.sseguro = pssegpol
                                           AND ep.nriesgo = p.nriesgo
                                           AND ep.cgarant = p.cgarant
                                           AND ep.cpregun = p.cpregun
                                           AND DECODE(p.ccolumna,
                                                      2, NVL(ep.tvalor, '**'),
                                                      -- BUG10985:DRA:26/08/2009
                                                      3, NVL(ep.fvalor, '**'),
                                                      TO_CHAR(ep.nvalor)) =
                                                 DECODE(p.ccolumna,
                                                        2, NVL(p.tvalor, '**'),
                                                        -- BUG10985:DRA:26/08/2009
                                                        3, NVL(p.fvalor, '**'),
                                                        TO_CHAR(p.nvalor)))) LOOP
               vantes := NULL;
               vdespues := NULL;
               num_err := f_despregunta(c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE(p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                    INTO vantes
                    FROM pregungaransegtab p, codipregun cp
                   WHERE p.sseguro = pssegpol
                     AND p.nriesgo = c.nriesgo
                     AND p.cpregun = c.cpregun
                     AND p.cgarant = c.cgarant   -- BUG14172:DRA:19/04/2010
                     AND p.nmovimi = (SELECT MAX(p1.nmovimi)
                                        -- BUG14172:DRA:19/04/2010
                                      FROM   pregungaransegtab p1
                                       WHERE p1.sseguro = pssegpol
                                         AND p1.nriesgo = c.nriesgo
                                         AND p1.cgarant = c.cgarant
                                         AND p1.cpregun = c.cpregun)
                     AND cp.cpregun = p.cpregun;   -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND THEN
                     vdespues := '';   --NULL;
               END;

               vdespues := c.despues;
               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;
               p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes,
                                 vdespues, c.cpregun);
            END LOOP;*/

            --BUG:23860:DCT:29/11/2012 - INICIO
            vantes2 := NULL;
            vdespues2 := NULL;

            -- CJMR 05/04/2019 IAXIS-3395
            FOR c IN
               (SELECT DISTINCT DECODE (c.ctipcol,
                                        2, p.tvalor,
                                        1, TO_CHAR (p.nvalor),
                                        5, TO_CHAR (p.nvalor),
                                        TO_CHAR (p.fvalor)
                                       ) antes,
                                p.cpregun, p.nriesgo, p.nmovimi, p.cgarant,
                                c.ctipcol, p.ccolumna, p.nlinea
                           FROM pregungaransegtab p,
                                pregunprogaran e,
                                seguros s,
                                codipregun cp,
                                preguntab_colum c
                          WHERE p.cpregun = e.cpregun
                            AND p.sseguro = s.sseguro
                            AND s.sseguro = pssegpol
                            AND p.cgarant = e.cgarant
                            AND e.sproduc = psproduc
                            AND (   (e.cpretip <> 2)
                                 OR (e.cpretip = 2 AND e.esccero = 1)
                                )                    --BUG23860:DCT:26/10/2012
                            AND cp.cpregun = p.cpregun
                            AND cp.cpregun = c.cpregun
                            AND p.ccolumna = c.ccolumn
                            AND p.nmovimi =
                                   (SELECT MAX (p1.nmovimi)
                                      -- BUG14172:DRA:19/04/2010
                                    FROM   pregungaransegtab p1
                                     WHERE p1.sseguro = pssegpol
                                       AND p1.nriesgo = p.nriesgo
                                       AND p1.cgarant = p.cgarant
                                       AND p1.cpregun = p.cpregun)
                            AND NOT EXISTS (
                                   SELECT ep.cpregun
                                     FROM estpregungaransegtab ep,
                                          preguntab_colum c
                                    WHERE ep.sseguro = psseguro
                                      AND ep.nmovimi = pnmovimi
                                      AND ep.nriesgo = p.nriesgo
                                      AND ep.cgarant = p.cgarant
                                      AND ep.cpregun = p.cpregun
                                      AND ep.ccolumna = p.ccolumna
                                      AND ep.nlinea = p.nlinea
                                      AND ep.cpregun = c.cpregun
                                      AND ep.ccolumna = c.ccolumn
                                      AND DECODE (c.ctipcol,
                                                  2, NVL (ep.tvalor, '**'),
                                                  -- CJMR 05/04/2019 IAXIS-3395
                                                  1, TO_CHAR (ep.nvalor),
                                                  5, TO_CHAR (ep.nvalor),
                                                  NVL (TO_CHAR (ep.fvalor),
                                                       '**'
                                                      )
                                                 ) =
                                             DECODE (c.ctipcol,
                                                     2, NVL (ep.tvalor, '**'),
                                                     -- CJMR 05/04/2019 IAXIS-3395
                                                     1, TO_CHAR (ep.nvalor),
                                                     5, TO_CHAR (ep.nvalor),
                                                     NVL (TO_CHAR (ep.fvalor),
                                                          '**'
                                                         )
                                                    ))
                       ORDER BY p.nlinea, p.ccolumna)
            LOOP                                 -- CJMR 05/04/2019 IAXIS-3395
               vantes := '--';
               vdespues := '--';
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               -- INI CJMR 05/04/2019 IAXIS-3395
               IF c.cpregun = 9551 AND c.ccolumna = 1
               THEN                                               -- Garant?a
                  BEGIN
                     SELECT gg.tgarant
                       INTO vdespues
                       FROM estpregungaransegtab ep, garangen gg
                      WHERE ep.sseguro = psseguro
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nmovimi = pnmovimi
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = gg.cgarant
                        AND gg.cidioma = pcidioma;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := '--';                             --NULL;
                  END;

                  BEGIN
                     SELECT gg.tgarant
                       INTO vantes
                       FROM pregungaransegtab ep, garangen gg
                      WHERE ep.sseguro = pssegpol
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nmovimi = pnmovimi
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = gg.cgarant
                        AND gg.cidioma = pcidioma;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := c.antes;
                  END;
               ELSIF c.cpregun = 9551 AND c.ccolumna = 2
               THEN                                                  -- moneda
                  BEGIN
                     SELECT m.tdescri
                       INTO vdespues
                       FROM estpregungaransegtab ep, monedas m
                      WHERE ep.sseguro = psseguro
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nmovimi = pnmovimi
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = m.cmoneda
                        AND m.cidioma = pcidioma;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := '--';                             --NULL;
                  END;

                  BEGIN
                     SELECT m.tdescri
                       INTO vantes
                       FROM pregungaransegtab ep, monedas m
                      WHERE ep.sseguro = pssegpol
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nmovimi = pnmovimi
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = m.cmoneda
                        AND m.cidioma = pcidioma;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := c.antes;
                  END;
               ELSE
                  -- FIN CJMR 05/04/2019 IAXIS-3395
                  BEGIN
                     SELECT DECODE (c.ctipcol,
                                    2, ep.tvalor,
                                    1, TO_CHAR (ep.nvalor),
                                    TO_CHAR (ep.fvalor)
                                   )
                       INTO vdespues
                       FROM estpregungaransegtab ep, codipregun cp
                      WHERE ep.sseguro = psseguro
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cgarant = c.cgarant
                        AND ep.cpregun = c.cpregun
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nmovimi = pnmovimi
                        AND cp.cpregun = ep.cpregun
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nlinea = c.nlinea;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := '--';                             --NULL;
                  END;

                  vantes := c.antes;
               END IF;                           -- CJMR 05/04/2019 IAXIS-3395

               SELECT f_axis_literales (slitera, pcidioma)
                 INTO literal2
                 FROM preguntab_colum
                WHERE cpregun = c.cpregun
                  AND ccolumn = c.ccolumna
                  AND ctipcol = c.ctipcol;

               vantes2 :=
                   NVL (vantes2, literal) || ' - ' || literal2 || ':'
                   || vantes;
               vdespues2 :=
                  NVL (vdespues2, literal) || ' - ' || literal2 || ':'
                  || vdespues;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes2,
                                  vdespues2,
                                  c.cpregun
                                 );
            END LOOP;

            vantes2 := NULL;
            vdespues2 := NULL;

            -- CJMR 05/04/2019 IAXIS-3395
            FOR c IN
               (SELECT DISTINCT DECODE (c.ctipcol,
                                        2, p.tvalor,
                                        1, TO_CHAR (p.nvalor),
                                        5, TO_CHAR (p.nvalor),
                                        TO_CHAR (p.fvalor)
                                       ) despues,
                                p.cpregun, p.nriesgo, p.nmovimi, p.cgarant,
                                c.ctipcol, p.ccolumna, p.nlinea
                           FROM estpregungaransegtab p,
                                pregunprogaran e,
                                estseguros s,
                                preguntab_colum c,
                                codipregun cp,
                                estgaranseg g
                          WHERE s.sseguro = psseguro
                            AND g.sseguro = s.sseguro
                            AND g.nmovimi = pnmovimi
                            AND g.cobliga = 1       -- BUG11737:DRA:25/01/2010
                            AND p.sseguro = g.sseguro
                            AND p.nriesgo = g.nriesgo
                            AND p.cgarant = g.cgarant
                            AND p.nmovimi = g.nmovimi
                            AND e.cpregun = p.cpregun
                            AND e.cgarant = p.cgarant
                            AND e.sproduc = psproduc
                            AND (   (e.cpretip <> 2)
                                 OR (e.cpretip = 2 AND e.esccero = 1)
                                )                    --BUG23860:DCT:26/10/2012
                            AND cp.cpregun = p.cpregun
                            AND cp.cpregun = c.cpregun
                            AND p.ccolumna = c.ccolumn
                            AND NOT EXISTS (
                                   SELECT ep.cpregun
                                     FROM pregungaransegtab ep,
                                          preguntab_colum c
                                    WHERE ep.sseguro = pssegpol
                                      AND ep.nriesgo = p.nriesgo
                                      AND ep.cgarant = p.cgarant
                                      AND ep.cpregun = p.cpregun
                                      AND ep.ccolumna = p.ccolumna
                                      AND ep.nlinea = p.nlinea
                                      AND ep.cpregun = c.cpregun
                                      AND ep.ccolumna = c.ccolumn
                                      AND ep.nmovimi =
                                             (SELECT MAX (p1.nmovimi)
                                                -- BUG14172:DRA:19/04/2010
                                              FROM   pregungaransegtab p1
                                               WHERE p1.sseguro = pssegpol
                                                 AND p1.nriesgo = p.nriesgo
                                                 AND p1.cgarant = p.cgarant
                                                 AND p1.cpregun = p.cpregun)
                                      AND DECODE (c.ctipcol,
                                                  2, NVL (ep.tvalor, '**'),
                                                  -- CJMR 05/04/2019 IAXIS-3395
                                                  1, TO_CHAR (ep.nvalor),
                                                  5, TO_CHAR (ep.nvalor),
                                                  NVL (TO_CHAR (ep.fvalor),
                                                       '**'
                                                      )
                                                 ) =
                                             DECODE (c.ctipcol,
                                                     2, NVL (p.tvalor, '**'),
                                                     -- CJMR 05/04/2019 IAXIS-3395
                                                     1, TO_CHAR (p.nvalor),
                                                     5, TO_CHAR (p.nvalor),
                                                     NVL (TO_CHAR (p.fvalor),
                                                          '**'
                                                         )
                                                    ))
                       ORDER BY p.nlinea, p.ccolumna)
            LOOP                                 -- CJMR 05/04/2019 IAXIS-3395
               vantes := '--';
               vdespues := '--';
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               -- INI CJMR 05/04/2019 IAXIS-3395
               IF c.cpregun = 9551 AND c.ccolumna = 1
               THEN                                               -- Garant?a
                  BEGIN
                     SELECT gg.tgarant
                       INTO vantes
                       FROM pregungaransegtab pg, garangen gg
                      WHERE pg.sseguro = pssegpol
                        AND pg.nriesgo = c.nriesgo
                        AND pg.cpregun = c.cpregun
                        AND pg.cgarant = c.cgarant
                        AND pg.nlinea = c.nlinea
                        AND pg.ccolumna = c.ccolumna
                        AND pg.nvalor = gg.cgarant
                        AND gg.cidioma = pcidioma
                        AND pg.nmovimi =
                               (SELECT MAX (p1.nmovimi)
                                  FROM pregungaransegtab p1
                                 WHERE p1.sseguro = pssegpol
                                   AND p1.nriesgo = c.nriesgo
                                   AND p1.cgarant = c.cgarant
                                   AND p1.cpregun = c.cpregun);
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := '--';                               --NULL;
                  END;

                  BEGIN
                     SELECT gg.tgarant
                       INTO vdespues
                       FROM estpregungaransegtab ep, garangen gg
                      WHERE ep.sseguro = psseguro
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = gg.cgarant
                        AND gg.cidioma = pcidioma
                        AND ep.nmovimi =
                               (SELECT MAX (p1.nmovimi)
                                  FROM estpregungaransegtab p1
                                 WHERE p1.sseguro = psseguro
                                   AND p1.nriesgo = c.nriesgo
                                   AND p1.cgarant = c.cgarant
                                   AND p1.cpregun = c.cpregun);
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := c.despues;
                  END;
               ELSIF c.cpregun = 9551 AND c.ccolumna = 2
               THEN                                                   --Moneda
                  BEGIN
                     SELECT m.tdescri
                       INTO vantes
                       FROM pregungaransegtab pg, monedas m
                      WHERE pg.sseguro = pssegpol
                        AND pg.nriesgo = c.nriesgo
                        AND pg.cpregun = c.cpregun
                        AND pg.cgarant = c.cgarant
                        AND pg.nlinea = c.nlinea
                        AND pg.ccolumna = c.ccolumna
                        AND pg.nvalor = m.cmoneda
                        AND m.cidioma = pcidioma
                        AND pg.nmovimi =
                               (SELECT MAX (p1.nmovimi)
                                  FROM pregungaransegtab p1
                                 WHERE p1.sseguro = pssegpol
                                   AND p1.nriesgo = c.nriesgo
                                   AND p1.cgarant = c.cgarant
                                   AND p1.cpregun = c.cpregun);
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := '--';                               --NULL;
                  END;

                  BEGIN
                     SELECT m.tdescri
                       INTO vdespues
                       FROM estpregungaransegtab ep, monedas m
                      WHERE ep.sseguro = psseguro
                        AND ep.nriesgo = c.nriesgo
                        AND ep.cpregun = c.cpregun
                        AND ep.cgarant = c.cgarant
                        AND ep.nlinea = c.nlinea
                        AND ep.ccolumna = c.ccolumna
                        AND ep.nvalor = m.cmoneda
                        AND m.cidioma = pcidioma
                        AND ep.nmovimi =
                               (SELECT MAX (p1.nmovimi)
                                  FROM estpregungaransegtab p1
                                 WHERE p1.sseguro = psseguro
                                   AND p1.nriesgo = c.nriesgo
                                   AND p1.cgarant = c.cgarant
                                   AND p1.cpregun = c.cpregun);
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vdespues := c.despues;
                  END;
               ELSE
                  BEGIN
                     SELECT DECODE (c.ctipcol,
                                    2, p.tvalor,
                                    1, TO_CHAR (p.nvalor),
                                    TO_CHAR (p.fvalor)
                                   )
                       INTO vantes
                       FROM pregungaransegtab p, codipregun cp
                      WHERE p.sseguro = pssegpol
                        AND p.nriesgo = c.nriesgo
                        AND p.cpregun = c.cpregun
                        AND p.cgarant = c.cgarant   -- BUG14172:DRA:19/04/2010
                        AND p.ccolumna = c.ccolumna
                        AND p.nlinea = c.nlinea
                        AND p.nmovimi =
                               (SELECT MAX (p1.nmovimi)
                                  -- BUG14172:DRA:19/04/2010
                                FROM   pregungaransegtab p1
                                 WHERE p1.sseguro = pssegpol
                                   AND p1.nriesgo = c.nriesgo
                                   AND p1.cgarant = c.cgarant
                                   AND p1.cpregun = c.cpregun)
                        AND cp.cpregun = p.cpregun;  -- BUG9988:DRA:30/04/2009
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vantes := '--';                               --NULL;
                  END;

                  vdespues := c.despues;
               END IF;

               -- FIN CJMR 05/04/2019 IAXIS-3395

               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               SELECT f_axis_literales (slitera, pcidioma)
                 INTO literal2
                 FROM preguntab_colum
                WHERE cpregun = c.cpregun
                  AND ccolumn = c.ccolumna
                  AND ctipcol = c.ctipcol;

               vantes2 :=
                   NVL (vantes2, literal) || ' - ' || literal2 || ':'
                   || vantes;
               vdespues2 :=
                  NVL (vdespues2, literal) || ' - ' || literal2 || ':'
                  || vdespues;
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes2,
                                  vdespues2,
                                  c.cpregun
                                 );
            END LOOP;
         --BUG 24657: XVM :24/10/2012--FIN
         -- FIN BUG 17341 - 24/01/2011 - JMP
         -- fin Bug 0016544 - 27/12/2010 - JMF
         --BUG:23860:DCT:29/11/2012 - FIN
         END IF;

         IF pcmotmov IN (247)
         THEN
            FOR c IN c_pregun_riesgo_real_247
            LOOP
               vantes := NULL;
               vdespues := NULL;
               vcgarant := 0;
               vnriesgo := c.nriesgo;
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE (p.cpregun,
                                 4049, ff_desvalorfijo (11,
                                                        pcidioma,
                                                        p.crespue
                                                       ),
                                 DECODE (cp.ctippre,
                                         4, p.trespue,
                                         -- BUG10985:DRA:26/08/2009
                                         5, p.trespue,
                                         p.crespue
                                        )
                                )
                    INTO vdespues
                    FROM estpregunseg p, codipregun cp
                   WHERE p.sseguro = psseguro
                     AND p.nriesgo = c.nriesgo
                     AND p.cpregun = c.cpregun
                     AND p.nmovimi = pnmovimi
                     AND cp.cpregun = p.cpregun;     -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vdespues := ' ';                                 --NULL;
               END;

               IF c.cpregun = 4049
               THEN
                  vdespues := ff_desvalorfijo (11, pcidioma, c.antes);
               ELSE
                  vantes := c.antes;
               END IF;

               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
               p_recuperadescripcrespue (psproduc,
                                         c.cpregun,
                                         vantes,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               -- Nom?s en el cas que sigui amb llista de valors
               -- BUG12590:07/01/2010:DRA:Fi
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END LOOP;

            FOR c IN c_pregun_riesgo_est_247
            LOOP
               vantes := NULL;
               vdespues := NULL;
               vcgarant := 0;
               vnriesgo := c.nriesgo;
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE (p.cpregun,
                                 4049, ff_desvalorfijo (11,
                                                        pcidioma,
                                                        p.crespue
                                                       ),
                                 DECODE (cp.ctippre,
                                         4, p.trespue,
                                         -- BUG10985:DRA:26/08/2009
                                         5, p.trespue,
                                         p.crespue
                                        )
                                )
                    INTO vantes
                    FROM pregunseg p, codipregun cp
                   WHERE p.sseguro = pssegpol
                     AND p.nriesgo = c.nriesgo
                     AND p.cpregun = c.cpregun
                     AND p.nmovimi = (SELECT MAX (nmovimi)
                                        FROM pregunseg
                                       WHERE sseguro = pssegpol)
                     AND cp.cpregun = p.cpregun;     -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := ' ';                                   --NULL;
               END;

               IF c.cpregun = 4049
               THEN
                  vdespues := ff_desvalorfijo (11, pcidioma, c.despues);
               ELSE
                  vdespues := c.despues;
               END IF;

               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
               p_recuperadescripcrespue (psproduc,
                                         c.cpregun,
                                         vantes,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               -- Nom?s en el cas que sigui amb llista de valors
               -- BUG12590:07/01/2010:DRA:Fi
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END LOOP;
         END IF;
      -- Fin Bug 13832
      /**/
      ELSIF pcmotmov = 821
      THEN
         FOR c IN c_prima
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);
            literal3 := f_axis_literales (102003, pcidioma);          --prima

            BEGIN
               SELECT TO_CHAR (iprianu, 'FM999G999G999G990D00')
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;                                      --NULL;
            END;

            vantes := literal || ' - ' || literal3 || c.antes;
            vdespues := literal || ' - ' || literal3 || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- ini Bug 0016961 - 20/12/2010 - SMF
      ELSIF pcmotmov = 238
      THEN
         FOR c IN c_prima2
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);
            literal3 := f_axis_literales (102003, pcidioma);          --prima

            BEGIN
               SELECT TO_CHAR (iprianu, 'FM999G999G999G990D00')
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;                                      --NULL;
            END;

            vantes := literal || ' - ' || literal3 || c.antes;
            vdespues := literal || ' - ' || literal3 || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- fin Bug 0016961 - 20/12/2010 - SMF
      ELSIF pcmotmov IN (801)
      THEN
         -- cambio de sobreprima, capital de garantias
         literal1 := f_axis_literales (101671, pcidioma);       -- sobreprima

         FOR c IN garantias_real_sobrepr
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT precarg,
                      TO_CHAR (precarg, 'FM9990D00') || ' % ' || literal1
                 INTO v_recargo,
                      vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
                  v_recargo := 0;
            END;

            vantes :=
                  literal
               || ': '
               || TO_CHAR (c.antes, 'FM9990D00')
               || ' % '
               || literal1;
            -- BUG7701:dra:10-02-2009: Para que quede bonito en pantalla
            vdespues := literal || ': ' || vdespues;  -- || ' % ' || literal1;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            -- BUG9423:12-03-2009: Si antes no hab?a garant?a y ahora el % es 0 no hay cambios
            IF NVL (v_recargo, 0) <> NVL (c.antes, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN garantias_est_sobrepr
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT precarg,
                      TO_CHAR (precarg, 'FM9990D00') || ' % ' || literal1
                 INTO v_recargo,
                      vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
                  v_recargo := 0;
            END;

            vdespues :=
                  literal
               || ': '
               || TO_CHAR (c.despues, 'FM9990D00')
               || ' % '
               || literal1;
            -- BUG7701:dra:10-02-2009: Para que quede bonito en pantalla
            vantes := literal || ': ' || vantes;      -- || ' % ' || literal1;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            -- BUG9423:12-03-2009: Si antes no hab?a garant?a y ahora el % es 0 no hay cambios
            IF NVL (v_recargo, 0) <> NVL (c.despues, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         -- Bug 19504 - RSC - 18/10/2011 - LCOL_T003: Desarrrollo y parametrizaci?n extraprimas/sobreprimas
         literal1 := f_axis_literales (101918, pcidioma);        -- extraprima

         FOR c IN garantias_real_iextrap
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT iextrap,
                      TO_CHAR (iextrap, 'FM9990D0000000') || ' ' || literal1
                 INTO v_recargo,
                      vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
                  v_recargo := 0;
            END;

            vantes :=
                  literal
               || ': '
               || TO_CHAR (c.antes, 'FM9990D0000000')
               || ' '
               || literal1;
            vdespues := literal || ': ' || vdespues;  -- || ' % ' || literal1;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            IF NVL (v_recargo, 0) <> NVL (c.antes, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN garantias_est_iextrap
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT iextrap,
                      TO_CHAR (iextrap, 'FM9990D0000000') || ' ' || literal1
                 INTO v_recargo,
                      vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
                  v_recargo := 0;
            END;

            vdespues :=
                  literal
               || ': '
               || TO_CHAR (c.despues, 'FM9990D0000000')
               || ' '
               || literal1;
            vantes := literal || ': ' || vantes;      -- || ' % ' || literal1;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            IF NVL (v_recargo, 0) <> NVL (c.despues, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         -- Fin Bug 19504

         -- Cambio de capital en las garant?as
         FOR c IN garantias_real
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;                                      --NULL;
            END;

            vantes := literal || ': ' || c.antes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               281,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN garantias_est
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
                 INTO vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;
            END;

            vdespues := literal || ': ' || c.despues;
            vantes := literal || ': ' || vantes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               281,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov IN (288, 283)
      THEN
         -- cambio de clausulas especiales
         SELECT cempres, cobjase
           INTO vcempres, vcobjase
           FROM seguros
          WHERE sseguro = pssegpol;

         FOR c IN clausulas_seg_real
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT g.tclatit
                 INTO vdespues
                 FROM estclaususeg e, clausugen g, clausupro p, estseguros s
                WHERE e.sseguro = psseguro
                  AND e.ffinclau IS NULL
                  AND e.sclagen = c.sclagen
                  AND g.sclagen = e.sclagen
                  AND g.cidioma = pcidioma
                  AND e.sseguro = s.sseguro
                  AND p.cramo = s.cramo
                  AND p.cmodali = s.cmodali
                  AND p.ctipseg = s.ctipseg
                  AND p.ccolect = s.ccolect
                  AND e.sclagen = p.sclagen
                  AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  -- Ini 27539 -- ECP -- 12/07/2013 Se cambia vdespues := NULL; por
                  BEGIN
                     IF    NVL (f_parproductos_v (psproduc,
                                                  'ADMITE_CERTIFICADOS'
                                                 ),
                                0
                               ) = 1
                        OR vcobjase = 3
                     THEN
                        vdespues := f_axis_literales (9905756, pcidioma);
                     ELSE
                        vdespues := NULL;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        vdespues := NULL;
                  END;
            -- Fin 27539 -- ECP -- 12/07/2013
            END;

            literal := f_axis_literales (101792, pcidioma);
            vantes := literal || ' ' || c.sclagen || ': ' || c.antes;
            vdespues := literal || ' ' || c.sclagen || ': ' || vdespues;
            --||' ?';
            vcgarant := c.sclagen;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN clausulas_seg_est
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT g.tclatit
                 INTO vantes
                 FROM claususeg cl, clausugen g, clausupro p, seguros s
                WHERE cl.sseguro = pssegpol
                  AND cl.ffinclau IS NULL
                  AND cl.sclagen = c.sclagen
                  AND g.sclagen = cl.sclagen
                  AND g.cidioma = pcidioma
                  AND cl.sseguro = s.sseguro
                  AND p.cramo = s.cramo
                  AND p.cmodali = s.cmodali
                  AND p.ctipseg = s.ctipseg
                  AND p.ccolect = s.ccolect
                  AND g.sclagen = p.sclagen
                  AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  --vdespues := 0;   --NULL;
                  -- Ini 27539 -- ECP -- 12/07/2013 Se cambia vantes := NULL; por
                  BEGIN
                     IF    NVL (f_parproductos_v (psproduc,
                                                  'ADMITE_CERTIFICADOS'
                                                 ),
                                0
                               ) = 1
                        OR vcobjase = 3
                     THEN
                        vantes := f_axis_literales (9905756, pcidioma);
                     ELSE
                        vantes := NULL;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        vantes := NULL;
                  END;
            -- Fin 27539 -- ECP -- 12/07/2013
            END;

            literal := f_axis_literales (101792, pcidioma);
            vantes := literal || ' ' || c.sclagen || ': ' || vantes;
            vdespues := literal || ' ' || c.sclagen || ': ' || c.despues;
            --||' ?';
            vcgarant := c.sclagen;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN clausulas_esp_real
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               -- BUG: 27305    NOTA: 164546 -- 04/02/2014
               SELECT e.tclaesp
                 INTO vdespues
                 FROM estclausuesp e
                WHERE e.sseguro = psseguro
                  AND e.cclaesp = 2
                  AND e.nordcla = c.nordcla
                  AND e.ffinclau IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  -- Ini 27539 -- ECP -- 12/07/2013 Se cambia vdespues := NULL; por
                  BEGIN
                     IF    NVL (f_parproductos_v (psproduc,
                                                  'ADMITE_CERTIFICADOS'
                                                 ),
                                0
                               ) = 1
                        OR vcobjase = 3
                     THEN
                        vdespues := f_axis_literales (9905756, pcidioma);
                     ELSE
                        vdespues := NULL;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        vdespues := NULL;
                  END;
            -- Fin 27539 -- ECP -- 12/07/2013
            END;

            literal := f_axis_literales (101792, pcidioma);                  --
            vantes := literal || ' ' || c.nordcla || ': ' || c.antes;
            vdespues := literal || ' ' || c.nordcla || ': ' || vdespues;
            --||' ?';
            vcgarant := c.nordcla;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN clausulas_esp_est
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               -- BUG: 27305    NOTA: 164546 --  04/02/2014
               SELECT e.tclaesp
                 INTO vantes
                 FROM clausuesp e
                WHERE e.sseguro = pssegpol
                  AND e.cclaesp = 2
                  AND e.nordcla = c.nordcla
                  AND e.ffinclau IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  --vdespues := 0;
                  -- Ini 27539 -- ECP -- 12/07/2013 Se cambia vantes := NULL; por
                  BEGIN
                     IF    NVL (f_parproductos_v (psproduc,
                                                  'ADMITE_CERTIFICADOS'
                                                 ),
                                0
                               ) = 1
                        OR vcobjase = 3
                     THEN
                        vantes := f_axis_literales (9905756, pcidioma);
                     ELSE
                        vantes := NULL;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        vantes := NULL;
                  END;
            -- Fin 27539 -- ECP -- 12/07/2013
            END;

            literal := f_axis_literales (101792, pcidioma);
            vantes := literal || ' ' || c.nordcla || ': ' || vantes;
            vdespues := literal || ' ' || c.nordcla || ': ' || c.despues;
            vcgarant := c.nordcla;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- Bug 18362 - APD - 18/05/2011 -
         -- Busca aquellos parametros que se han modificado o que se hayan anadido
         -- (no estan en clauparaseg pero si en estparaseg)
         vantes2 := NULL;
         vdespues2 := NULL;

         FOR reg IN clauparaseg_est
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT cl.tparame || ': ' || c.tparame tresul
                 INTO vantes
                 FROM clauparaseg c, clausupro p, seguros s, clausupara cl
                WHERE c.sseguro = pssegpol
                  AND c.sclagen = reg.sclagen
                  AND c.nriesgo = reg.nriesgo
                  AND c.nmovimi = pnmovimi - 1
                  AND c.nparame = reg.nparame
                  AND c.nordcla = reg.nordcla
                  AND c.sseguro = s.sseguro
                  AND p.cramo = s.cramo
                  AND p.cmodali = s.cmodali
                  AND p.ctipseg = s.ctipseg
                  AND p.ccolect = s.ccolect
                  AND c.sclagen = p.sclagen
                  AND cl.sclagen = c.sclagen
                  AND cl.cidioma = pcidioma
                  AND cl.nparame = c.nparame
                  AND NVL (p.multiple, -1) =
                                 NVL (DECODE (pcmotmov, 283, 1, 288, NULL),
                                      -1);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  --vdespues := 0;   --NULL;
                  -- Ini 27539 -- ECP -- 12/07/2013 Se cambia vantes := NULL; por
                  BEGIN
                     IF    NVL (f_parproductos_v (psproduc,
                                                  'ADMITE_CERTIFICADOS'
                                                 ),
                                0
                               ) = 1
                        OR vcobjase = 3
                     THEN
                        vantes := f_axis_literales (9905756, pcidioma);
                     ELSE
                        vantes := NULL;
                     END IF;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        vantes := NULL;
                  END;
            -- Fin 27539 -- ECP -- 12/07/2013
            END;

            IF NVL (vantes, ' ') <> reg.tresul
            THEN
               literal := f_axis_literales (101792, pcidioma);
               --literal2 := f_axis_literales(1000381, pcidioma);
               --IF vantes2 IS NULL THEN
               vantes2 := literal || ' ' || reg.sclagen || '. ' || vantes;
               -- ELSE
               --    vantes2 := vantes2 || ' - ' || vantes;
               -- END IF;

               -- IF vdespues2 IS NULL THEN
               vdespues2 :=
                          literal || ' ' || reg.sclagen || '. ' || reg.tresul;
               --ELSE
               --   vdespues2 := vdespues2 || ' - ' || reg.tresul;
               --END IF;
               vcgarant := reg.sclagen;
               vcpregun := reg.nparame;
               vnriesgo := 1;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes2,
                                  vdespues2,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         -- Busca aquellos parametros que se han eliminado
         -- (si estan en clauparaseg pero no en estparaseg)
         FOR reg IN clauparaseg_real
         LOOP
            vantes := reg.tresul;
            vdespues := NULL;
            literal := f_axis_literales (101792, pcidioma);
            literal2 := f_axis_literales (1000381, pcidioma);
            vantes := literal || ' ' || reg.sclagen || '. ' || vantes;
            vdespues :=
                  literal
               || ' '
               || reg.sclagen
               || '. '
               || literal2
               || ': '
               || vdespues;                                          --||' ?';
            vcgarant := reg.sclagen;
            vcpregun := reg.nparame;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- Fin Bug 18362 - APD - 18/05/2011 -
      ELSIF pcmotmov = 213
      THEN
         literal := f_axis_literales (109309, pcidioma);       --beneficiario
         literal2 := f_axis_literales (100547, pcidioma);           -- riesgo

         FOR c IN clausulas
         LOOP
            BEGIN
               SELECT literal || ' ' || texto
                 INTO vantes
                 FROM (SELECT tclaesp texto
                         FROM clausuesp
                        WHERE sseguro = pssegpol
                          AND ffinclau IS NULL
                          AND cclaesp = 1
                          AND nriesgo = c.nriesgo
                       UNION
                       SELECT f_desclausuben (sclaben, pcidioma) texto
                         -- BUG10519:DRA:09/07/2009
                       FROM   claubenseg
                        WHERE sseguro = pssegpol
                          AND nriesgo = c.nriesgo
                          AND ffinclau IS NULL);
            EXCEPTION
               WHEN OTHERS
               THEN
                  vantes := literal;
            END;

            vnriesgo := c.nriesgo;
            vcgarant := 0;

            BEGIN
               SELECT literal || ' ' || texto
                 INTO vdespues
                 FROM (SELECT tclaesp texto
                         FROM estclausuesp
                        WHERE sseguro = psseguro
                          AND nriesgo = c.nriesgo
                          AND cclaesp = 1
                       UNION
                       SELECT f_desclausuben (sclaben, pcidioma) texto
                         FROM estclaubenseg
                        WHERE sseguro = psseguro
                          AND nriesgo = c.nriesgo
                          AND NVL (cobliga, 1) = 1);
            EXCEPTION
               WHEN OTHERS
               THEN
                  vdespues := literal;
            END;

            IF vantes <> vdespues
            THEN
               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov = 671
      THEN
         FOR c IN riesgos_ahora
         LOOP
            BEGIN
               -- dra 9-1-08: bug mantis 8660
               verror :=
                        pac_seguros.f_get_cagente (psseguro, 'EST', vcagente);
               verror :=
                  pac_persona.f_get_dadespersona (c.spereal1,
                                                  vcagente,
                                                  pers_reg
                                                 );

               IF verror <> 0
               THEN
                  pers_reg := NULL;
               END IF;
            EXCEPTION
               WHEN OTHERS
               THEN
                  pers_reg := NULL;
            END;

            vantes := NULL;
            vdespues := NULL;
            cambio := 0;

            IF c.fnacimi <> pers_reg.fnacimi
            THEN
               literal := f_axis_literales (104258, pcidioma);     -- F. nac:
               vantes := literal || TO_CHAR (pers_reg.fnacimi, 'DD/MM/YYYY');
               vdespues := literal || TO_CHAR (c.fnacimi, 'DD/MM/YYYY');
               cambio := 1;
            END IF;

            IF c.csexper <> pers_reg.csexper
            THEN
               num_err :=
                       f_desvalorfijo (11, pcidioma, pers_reg.csexper, sexoa);
               num_err := f_desvalorfijo (11, pcidioma, c.csexper, sexod);
               literal := f_axis_literales (100927, pcidioma);       -- Sexo:
               vantes := vantes || ' - ' || literal || ' ' || sexoa;
               vdespues := vdespues || ' - ' || literal || ' ' || sexod;
               cambio := 1;
            END IF;

            IF c.tbuscar <> pers_reg.tbuscar
            THEN
               literal := f_axis_literales (100925, pcidioma);     -- Nombre:
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ' '
                  || pers_reg.tapelli
                  || ' '
                  || pers_reg.tnombre;
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ' '
                  || c.tapelli
                  || ' '
                  || c.tnombre;
               cambio := 1;
            END IF;

            IF (   c.cidioma <> pers_reg.cidioma
                OR c.nnumnif <> pers_reg.nnumnif
                OR c.csexper <> pers_reg.csexper
                OR c.fnacimi <> pers_reg.fnacimi
                OR c.cpertip <> pers_reg.cpertip
                OR c.nnifdup <> pers_reg.nnifdup
                OR c.nnifrep <> pers_reg.nnifrep
                OR c.cprofes <> pers_reg.cprofes
                OR c.nnumsoe <> pers_reg.nnumsoe
                OR c.cestciv <> pers_reg.cestciv
                OR c.cestado <> pers_reg.cestado
                OR c.cbancar <> pers_reg.cbancar
                OR c.tperobs <> pers_reg.tperobs
                OR c.cnifrep <> pers_reg.cnifrep
                OR c.pdtoint <> pers_reg.pdtoint
                OR c.ccargos <> pers_reg.ccargos
                -- OR c.finform <> pers_reg.finform -- dra 8-10-2008: Lo comento porque sale de la FMOVIMI de la vista PERSONAS
                OR c.fjubila <> pers_reg.fjubila
                OR c.tidenti <> pers_reg.tidenti
                OR c.tpermis <> pers_reg.tpermis
                OR c.producte <> pers_reg.producte
                OR c.num_contra <> pers_reg.num_contra
                OR c.snip <> pers_reg.snip
                OR c.nsocio <> pers_reg.nsocio
                OR c.nhijos <> pers_reg.nhijos
                OR c.claboral <> pers_reg.claboral
                OR c.cvip <> pers_reg.cvip
                OR c.spercon <> pers_reg.spercon
                OR c.fantigue <> pers_reg.fantigue
                OR c.ctrato <> pers_reg.ctrato
               )
            THEN
               cambio := 1;
               literal := f_axis_literales (140249, pcidioma);
               -- Listado cambos de persona
               vantes := vantes || ' - ' || literal;
               vdespues := vdespues || ' - ' || literal;
            END IF;

            vcgarant := 0;
            vnriesgo := c.nriesgo;

            IF cambio = 1
            THEN
               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov = 610
      THEN
         SELECT d.tatribu
           INTO vantes
           FROM seguros s, detvalores d
          WHERE s.sseguro = pssegpol
            AND d.cvalor = 1063
            AND d.cidioma = pcidioma
            AND s.ctipretr = d.catribu;

         SELECT d.tatribu
           INTO vdespues
           FROM estseguros s, detvalores d
          WHERE s.sseguro = psseguro
            AND d.cvalor = 1063
            AND d.cidioma = pcidioma
            AND s.ctipretr = d.catribu;

         literal := f_axis_literales (9903613, pcidioma);
         vantes := literal || ': ' || vantes;
         vdespues := literal || ': ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov IN (611)
      THEN
         -- Suplemento de Gestor de cobro
         FOR c IN (SELECT c.sperson sperson_ori, e.sperson sperson_des
                     FROM gescobros c, estgescobros e
                    WHERE c.sseguro = pssegpol
                      AND e.sseguro = psseguro
                      AND c.sperson <>
                             NVL (pac_persona.f_sperson_spereal (e.sperson),
                                  -1
                                 )
                   UNION
                   SELECT c.sperson sperson_ori, NULL sperson_des
                     FROM gescobros c
                    WHERE c.sseguro = pssegpol
                      AND NOT EXISTS (SELECT 1
                                        FROM estgescobros e
                                       WHERE e.sseguro = psseguro)
                   UNION
                   SELECT NULL sperson_ori, e.sperson sperson_des
                     FROM estgescobros e
                    WHERE e.sseguro = psseguro
                      AND NOT EXISTS (SELECT 1
                                        FROM gescobros c
                                       WHERE c.sseguro = pssegpol))
         LOOP
            literal2 := f_axis_literales (9903385, pcidioma);
            -- Gestor de Cobro
            vantes := literal2 || ': ' || f_nombre (c.sperson_ori, 1, NULL);
            vdespues :=
                    literal2 || ': ' || f_nombre_est (c.sperson_des, 1, NULL);
            vcgarant := 0;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov IN (612)
      THEN
         -- Suplemento domicilio Gestor de cobro
         FOR c IN (SELECT c.sperson sperson_ori, c.cdomici cdomici_ori,
                          e.sperson sperson_des, e.cdomici cdomici_des
                     FROM gescobros c, estgescobros e
                    WHERE c.sseguro = pssegpol
                      AND e.sseguro = psseguro
                      AND c.cdomici <> e.cdomici)
         LOOP
            literal2 := f_axis_literales (102359, pcidioma);    -- Direcci?n:
            num_err :=
               f_direccion (1,
                            c.sperson_ori,
                            c.cdomici_ori,
                            1,
                            ptlin1,
                            ptlin2,
                            ptlin3
                           );
            vantes := literal2 || ' ' || ptlin1;
            num_err :=
               f_estdireccion (1,
                               c.sperson_des,
                               c.cdomici_des,
                               1,
                               ptlin1,
                               ptlin2,
                               ptlin3
                              );
            vdespues :=
                   literal2 || ' ' || ptlin1 || ' ' || ptlin2 || ' ' || ptlin3;
            vcgarant := 0;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov IN (241, 242)
      THEN
         -- baja de riesgos
         FOR c IN riesgos_baja
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg
                 FROM personas
                WHERE sperson = c.spereal;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            literal := f_axis_literales (103192, pcidioma);  -- riesgo anulado
            vantes :=
                literal || ': ' || pers_reg.tnombre || ' ' || pers_reg.tapelli;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov = 243
      THEN
         -- alta de riesgos
         FOR c IN riesgos_alta
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg2
                 FROM estpersonas
                WHERE sperson = c.sperson;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            literal := f_axis_literales (152134, pcidioma);     -- alta riesgo
            vantes := NULL;
            vdespues :=
               literal || ': ' || pers_reg2.tnombre || ' '
               || pers_reg2.tapelli;
            vcgarant := 0;
            vnriesgo := c.nriesgo;

            IF vdespues IS NOT NULL
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      -- BUG17255:DRA:22/07/2011:Inici
      ELSIF pcmotmov IN (215, 696)
      THEN
         -- Modificaci?n de tomadores / Cambio de tomador
         FOR c IN
            (SELECT t.sperson sperson_old, e.sperson sperson_new,
                    t.cdomici cdomici_old, e.cdomici cdomici_new,
                    t.cagrupa cagrupa_old,
                    e.cagrupa cagrupa_new          --IAXIS-2085 03/04/2019 AP
               FROM tomadores t, esttomadores e
              WHERE t.sseguro = pssegpol
                AND e.sseguro = psseguro
                AND (   t.sperson <>
                           NVL (pac_persona.f_sperson_spereal (e.sperson),
                                (t.sperson + 1
                                )
                               )
                     OR t.cdomici <> e.cdomici
                     OR NVL (t.cagrupa, 0) <> NVL (e.cagrupa, 0)
                    )
                AND t.nordtom = e.nordtom
             -- bug 0035712 - FAL - 20/05/2015. A??r tomador no detecta nuevos
             UNION
             SELECT t.sperson sperson_old, e.sperson sperson_new,
                    t.cdomici cdomici_old, e.cdomici cdomici_new,
                    t.cagrupa cagrupa_old,
                    e.cagrupa cagrupa_new           --IAXIS-2085 03/04/2019 AP
               FROM tomadores t, esttomadores e
              WHERE t.sseguro = pssegpol
                AND e.sseguro = psseguro
                AND (   t.sperson <>
                           NVL (pac_persona.f_sperson_spereal (e.sperson),
                                (t.sperson + 1
                                )
                               )
                     OR t.cdomici <> e.cdomici
                     OR NVL (t.cagrupa, 0) <> NVL (e.cagrupa, 0)
                    )
                     -- fi bug 0035712 - FAL - 20/05/2015
            )
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg
                 FROM personas
                WHERE sperson = c.sperson_old;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            literal2 := f_axis_literales (101027, pcidioma);        -- Tomador
            vantes :=
               literal2 || ': ' || pers_reg.tnombre || ' ' || pers_reg.tapelli;
            vcgarant := 0;
            vnriesgo := 1;

            BEGIN
               SELECT *
                 INTO pers_reg2
                 FROM estpersonas
                WHERE sperson = c.sperson_new;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            vdespues :=
               literal2 || ': ' || pers_reg2.tnombre || ' '
               || pers_reg2.tapelli;
            vcgarant := 0;
            vnriesgo := 1;

            -- bug 0035712 - FAL - 20/05/2015.
            /*
            FOR reg IN (SELECT p.*
                          FROM esttomadores e, estper_detper p
                         WHERE e.sperson <> c.sperson_new
                           AND e.sperson = p.sperson
                           AND e.sseguro = psseguro) LOOP
               vdespues := vdespues || CHR(10) || CHR(13)
                           || LPAD(reg.tnombre || ' ' || reg.tapelli1 || ' ' || reg.tapelli2,
                                   LENGTH(literal2));
            END LOOP;
            */
            -- fi bug 0035712 - FAL - 20/05/2015.

            --BUG19870 - JTS - 21/11/2011 afegim text descriptiu al suplement
            IF NVL
                  (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'DET_SUP_TOM'
                                              ),
                   0
                  ) = 1
            THEN
               vdespues := vdespues || ' ' || pers_reg2.nnumide;
               num_err :=
                  f_estdireccion (1,
                                  c.sperson_new,
                                  c.cdomici_new,
                                  1,
                                  ptlin1,
                                  ptlin2,
                                  ptlin3
                                 );
               vdespues :=
                   vdespues || ' ' || ptlin1 || ' ' || ptlin2 || ' ' || ptlin3;
            END IF;

            --INI IAXIS-2085 03/04/2019 AP
            IF NVL (c.cagrupa_old, 0) <> NVL (c.cagrupa_new, 0)
            THEN
               BEGIN
                  SELECT DISTINCT d.tatribu
                             INTO vcagrupa_old
                             FROM detvalores d
                            WHERE d.catribu = c.cagrupa_old
                              AND d.cvalor = 8002007
                              AND d.cidioma = pcidioma
                              AND c.cagrupa_old <> 0;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     literal2 := f_axis_literales (89906196, pcidioma);
               END;

               BEGIN
                  SELECT DISTINCT d.tatribu
                             INTO vcagrupa_new
                             FROM detvalores d
                            WHERE d.catribu = c.cagrupa_new
                              AND d.cvalor = 8002007
                              AND d.cidioma = 8
                              AND c.cagrupa_new <> 0;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     literal2 := f_axis_literales (89906196, pcidioma);
               END;

               literal2 := f_axis_literales (100706, pcidioma);

               --Inicia Bug 4205 - GEK - 16/07/2019
                  --Detalle movimento de poliza apresenta para tomador y agrupacion
               IF vcagrupa_old IS NOT NULL
               THEN
                  vantes :=
                        f_axis_literales (101027, pcidioma)
                     || ': '
                     || pers_reg.tnombre
                     || ' '
                     || pers_reg.tapelli
                     || ' / '
                     || literal2
                     || ' '
                     || vcagrupa_old;
               END IF;

               IF vcagrupa_new IS NOT NULL
               THEN
                  vdespues :=
                        f_axis_literales (101027, pcidioma)
                     || ': '
                     || pers_reg2.tnombre
                     || ' '
                     || pers_reg2.tapelli
                     || ' / '
                     || literal2
                     || ' '
                     || vcagrupa_new;
               END IF;
            --Fim Bug 4205 - GEK - 16/07/2019
            END IF;

            --FIN IAXIS-2085 03/04/2019 AP

            --Fi BUG19870
            IF vdespues IS NOT NULL
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;

            IF     pcmotmov = 215
               AND NVL
                      (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'DET_SUP_TOM'
                                              ),
                       0
                      ) = 0
            THEN
               IF c.cdomici_old <> c.cdomici_new
               THEN
                  literal2 := f_axis_literales (102359, pcidioma);
                  -- Direcci?n:
                  num_err :=
                     f_direccion (1,
                                  c.sperson_old,
                                  c.cdomici_old,
                                  1,
                                  ptlin1,
                                  ptlin2,
                                  ptlin3
                                 );
                  vantes := literal2 || ' ' || ptlin1;
                  num_err :=
                     f_estdireccion (1,
                                     c.sperson_new,
                                     c.cdomici_new,
                                     1,
                                     ptlin1,
                                     ptlin2,
                                     ptlin3
                                    );
                  vdespues :=
                     literal2 || ' ' || ptlin1 || ' ' || ptlin2 || ' '
                     || ptlin3;
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     668,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            END IF;
         END LOOP;
      ELSIF pcmotmov IN (230, 297)
      THEN
         -- Modificaci?n de asegurados / propietarios
         SELECT cempres, cobjase
           INTO vcempres, vcobjase
           FROM seguros
          WHERE sseguro = pssegpol;

         -- Con este cursor identificaremos los asegurados/propietarios eliminados
         FOR c IN
            (SELECT a.nriesgo, a.sperson sperson_old, a.cdomici cdomici_old
               FROM asegurados a
              WHERE a.sseguro = pssegpol
                AND NOT EXISTS (
                       SELECT 1
                         FROM estassegurats e
                        WHERE e.sseguro = psseguro
                          AND NVL (pac_persona.f_sperson_spereal (e.sperson),
                                   -1
                                  ) = a.sperson
                          AND (   a.ffecfin = e.ffecfin
                               OR (a.ffecfin IS NULL AND e.ffecfin IS NULL)
                              )))
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg
                 FROM personas
                WHERE sperson = c.sperson_old;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            vcgarant := c.sperson_old;
            vnriesgo := NVL (c.nriesgo, 0);

            IF pcmotmov = 230
            THEN
               literal2 := f_axis_literales (9902462, pcidioma);
               -- Asegurado anulado
               vantes :=
                     literal2
                  || ': '
                  || pers_reg.nnumide
                  || ' '
                  || pers_reg.tnombre
                  || ' '
                  || pers_reg.tapelli;
               g_vantes :=
                     ': '
                  || pers_reg.nnumide
                  || ' '
                  || pers_reg.tnombre
                  || ' '
                  || pers_reg.tapelli;

               IF NVL (pac_parametros.f_parempresa_n (vcempres, 'DET_SUP_TOM'),
                       0
                      ) = 1
               THEN
                  IF vcobjase = 1
                  THEN
                     vantes :=
                           vantes
                        || ' '
                        || pers_reg.fnacimi
                        || ' '
                        || ff_desvalorfijo (11, 2, pers_reg.csexper);
                  END IF;

                  num_err :=
                     f_direccion (1,
                                  c.sperson_old,
                                  NVL (c.cdomici_old, 1),
                                  1,
                                  ptlin1,
                                  ptlin2,
                                  ptlin3
                                 );
                  vantes :=
                     vantes || ' ' || ptlin1 || ' ' || ptlin2 || ' ' || ptlin3;
               END IF;

               vdespues := literal2 || ': -- ';
            ELSIF pcmotmov = 297
            THEN
               literal2 := f_axis_literales (9902465, pcidioma);
               -- Propietario anulado
               vantes :=
                     literal2
                  || ': '
                  || pers_reg2.nnumide
                  || ' '
                  || pers_reg2.tnombre
                  || ' '
                  || pers_reg2.tapelli;

               IF NVL (pac_parametros.f_parempresa_n (vcempres, 'DET_SUP_TOM'),
                       0
                      ) = 1
               THEN
                  num_err :=
                     f_direccion (1,
                                  c.sperson_old,
                                  NVL (c.cdomici_old, 1),
                                  1,
                                  ptlin1,
                                  ptlin2,
                                  ptlin3
                                 );
                  vantes :=
                     vantes || ' ' || ptlin1 || ' ' || ptlin2 || ' ' || ptlin3;
               END IF;

               vdespues := literal2 || ': -- ';
            END IF;

            IF vdespues IS NOT NULL OR vantes IS NOT NULL
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  NVL (vnriesgo, 1),
                                  NVL (vcgarant, 0),
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         -- Ahora miramos los asegurados/propietarios que se anaden
         FOR c IN
            (SELECT e.sperson sperson_new, e.ffecini, e.ffecfin, e.ffecmue,
                    e.nriesgo, NVL (e.cdomici, 1) cdomici_new, e.fecretroact
               FROM estassegurats e
              WHERE e.sseguro = psseguro
                --Bug 27876/159537 - JSV - 25/11/2013
                AND e.ffecfin IS NULL
                AND NOT EXISTS (
                       SELECT 1
                         FROM asegurados a
                        WHERE a.sseguro = pssegpol
                          AND a.sperson =
                                 NVL
                                    (pac_persona.f_sperson_spereal (e.sperson),
                                     -1
                                    )
                          AND (   a.ffecfin = e.ffecfin
                               OR (a.ffecfin IS NULL AND e.ffecfin IS NULL)
                              )))
         LOOP
            BEGIN
               SELECT *
                 INTO pers_reg2
                 FROM estpersonas
                WHERE sperson = c.sperson_new;
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;

            vcgarant := pac_persona.f_sperson_spereal (c.sperson_new);
            vnriesgo := NVL (c.nriesgo, 0);

            IF pcmotmov = 230
            THEN
               literal2 := f_axis_literales (9902463, pcidioma);
               -- Asegurado anadido
               vantes := literal2 || ': -- ';
               vdespues :=
                     literal2
                  || ': '
                  || pers_reg2.nnumide
                  || ' '
                  || pers_reg2.tnombre
                  || ' '
                  || pers_reg2.tapelli;

               IF NVL (pac_parametros.f_parempresa_n (vcempres, 'DET_SUP_TOM'),
                       0
                      ) = 1
               THEN
                  IF vcobjase = 1
                  THEN
                     vdespues :=
                           vdespues
                        || ' '
                        || pers_reg2.fnacimi
                        || ' '
                        || ff_desvalorfijo (11, 2, pers_reg2.csexper);
                  END IF;

                  num_err :=
                     f_estdireccion (1,
                                     pers_reg2.sperson,
                                     NVL (c.cdomici_new, 1),
                                     1,
                                     ptlin1,
                                     ptlin2,
                                     ptlin3
                                    );
                  vdespues :=
                     vdespues || ' ' || ptlin1 || ' ' || ptlin2 || ' '
                     || ptlin3;
               END IF;
            ELSIF pcmotmov = 297
            THEN
               literal2 := f_axis_literales (9902464, pcidioma);
               -- Propietario anadido
               vantes := literal2 || ': -- ';
               vdespues :=
                     literal2
                  || ': '
                  || pers_reg2.nnumide
                  || ' '
                  || pers_reg2.tnombre
                  || ' '
                  || pers_reg2.tapelli;

               IF NVL (pac_parametros.f_parempresa_n (vcempres, 'DET_SUP_TOM'),
                       0
                      ) = 1
               THEN
                  num_err :=
                     f_estdireccion (1,
                                     pers_reg2.sperson,
                                     NVL (c.cdomici_new, 1),
                                     1,
                                     ptlin1,
                                     ptlin2,
                                     ptlin3
                                    );
                  vdespues :=
                     vdespues || ' ' || ptlin1 || ' ' || ptlin2 || ' '
                     || ptlin3;
               END IF;
            END IF;

            IF vdespues IS NOT NULL OR vantes IS NOT NULL
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  NVL (vnriesgo, 1),
                                  NVL (vcgarant, 0),
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      -- BUG17255:DRA:22/07/2011:Fi
      ELSIF pcmotmov = 244
      THEN
         -- BUG14431:DRA:06/05/2010:Inici
         BEGIN
            vcgarant := 0;
            vcpregun := 0;
            literal := f_axis_literales (102359, pcidioma);
            literal2 := f_axis_literales (100547, pcidioma);        -- riesgo

            FOR regrma IN riesgos_modif_antes
            LOOP
               vnriesgo := regrma.nriesgo;

               -- Hasta aqu? solo se comprueba si la direccion ha cambiado
               BEGIN
                  SELECT s.tdomici, s.cprovin, s.cpostal, s.cpoblac,
                         s.csiglas, s.tnomvia, s.nnumvia, s.tcomple,
                         s.cciudad, s.fgisx, s.fgisy, s.fgisz,
                         s.cvalida
                    INTO v_tdomici_a, v_cprovin_a, v_cpostal_a, v_cpoblac_a,
                         v_csiglas_a, v_tnomvia_a, v_nnumvia_a, v_tcomple_a,
                         v_cciudad_a, v_fgisx_a, v_fgisy_a, v_fgisz_a,
                         v_cvalida_a
                    FROM riesgos r, sitriesgo s
                   WHERE r.sseguro = pssegpol
                     AND r.nriesgo = vnriesgo
                     AND s.sseguro = r.sseguro
                     AND s.nriesgo = r.nriesgo;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     v_tdomici_a := NULL;
                     v_cprovin_a := NULL;
                     v_cpostal_a := NULL;
                     v_cpoblac_a := NULL;
                     v_csiglas_a := NULL;
                     v_tnomvia_a := NULL;
                     v_nnumvia_a := NULL;
                     v_tcomple_a := NULL;
                     v_cciudad_a := NULL;
                     v_fgisx_a := NULL;
                     v_fgisy_a := NULL;
                     v_fgisz_a := NULL;
                     v_cvalida_a := NULL;
               END;

               BEGIN
                  SELECT s.tdomici, s.cprovin, s.cpostal, s.cpoblac,
                         s.csiglas, s.tnomvia, s.nnumvia, s.tcomple,
                         s.cciudad, s.fgisx, s.fgisy, s.fgisz,
                         s.cvalida
                    INTO v_tdomici_d, v_cprovin_d, v_cpostal_d, v_cpoblac_d,
                         v_csiglas_d, v_tnomvia_d, v_nnumvia_d, v_tcomple_d,
                         v_cciudad_d, v_fgisx_d, v_fgisy_d, v_fgisz_d,
                         v_cvalida_d
                    FROM estriesgos r, estsitriesgo s
                   WHERE r.sseguro = psseguro
                     AND r.nriesgo = vnriesgo
                     AND s.sseguro = r.sseguro
                     AND s.nriesgo = r.nriesgo;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     v_tdomici_d := NULL;
                     v_cprovin_d := NULL;
                     v_cpostal_d := NULL;
                     v_cpoblac_d := NULL;
                     v_csiglas_d := NULL;
                     v_tnomvia_d := NULL;
                     v_nnumvia_d := NULL;
                     v_tcomple_d := NULL;
                     v_cciudad_d := NULL;
                     v_fgisx_d := NULL;
                     v_fgisy_d := NULL;
                     v_fgisz_d := NULL;
                     v_cvalida_d := NULL;
               END;

               --BUG 17428: ETM :01/02/2011--INI
               IF    v_tdomici_a
                  || v_cprovin_a
                  || v_cpostal_a
                  || v_cpoblac_a
                  || v_csiglas_a
                  || v_tnomvia_a
                  || v_nnumvia_a
                  || v_tcomple_a
                  || v_cciudad_a
                  || v_fgisx_a
                  || v_fgisy_a
                  || v_fgisz_a
                  || v_cvalida_a <>
                        v_tdomici_d
                     || v_cprovin_d
                     || v_cpostal_d
                     || v_cpoblac_d
                     || v_csiglas_d
                     || v_tnomvia_d
                     || v_nnumvia_d
                     || v_tcomple_d
                     || v_cciudad_d
                     || v_fgisx_d
                     || v_fgisy_d
                     || v_fgisz_d
                     || v_cvalida_d
               THEN
                  num_err :=
                     f_desriesgo (pssegpol,
                                  regrma.nriesgo,
                                  NULL,
                                  pcidioma,
                                  v_triesgo_1,
                                  v_triesgo_2,
                                  v_triesgo_3
                                 );
                  vantes :=
                        literal
                     || v_triesgo_1
                     || ' '
                     || v_triesgo_2
                     || ' '
                     || v_triesgo_3
                     || ' '
                     || literal2
                     || ' '
                     || regrma.nriesgo;
                  num_err :=
                     f_estdesriesgo (psseguro,
                                     regrma.nriesgo,
                                     NULL,
                                     pcidioma,
                                     v_triesgo_1,
                                     v_triesgo_2,
                                     v_triesgo_3
                                    );
                  vdespues :=
                        literal
                     || v_triesgo_1
                     || ' '
                     || v_triesgo_2
                     || ' '
                     || v_triesgo_3
                     || ' '
                     || literal2
                     || ' '
                     || regrma.nriesgo;
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            --BUG 17428: ETM :01/02/2011--FIN
            END LOOP;
         END;
      -- BUG14431:DRA:06/05/2010:Fi
      ELSIF pcmotmov = 269
      THEN
         SELECT cforpag, fcarpro
           INTO cforpaga, fcarproa
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT cforpag
           INTO cforpagd
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         num_err := f_desvalorfijo (17, pcidioma, cforpaga, vantes);
         num_err := f_desvalorfijo (17, pcidioma, cforpagd, vdespues);
         literal := f_axis_literales (102719, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
         num_err := f_fecha_efecto (psseguro, pnmovimi, v_fsuplem);
         num_err :=
            pac_canviforpag.f_fcarpro_final (pssegpol,
                                             v_fsuplem,
                                             cforpagd,
                                             cforpaga,
                                             fcarprod,
                                             dummy
                                            );
         literal := f_axis_literales (151215, pcidioma);
         -- Fecha proximo recibo
         vantes :=
            vantes || ' ' || literal || ' '
            || TO_CHAR (fcarproa, 'dd/mm/yyyy');
         vdespues :=
            vdespues || ' ' || literal || ' '
            || TO_CHAR (fcarprod, 'dd/mm/yyyy');
      ELSIF pcmotmov = 820
      THEN
         -- cambio beneficiario irrevocable
         SELECT crespue
           INTO v_crespue_a
           FROM pregunseg p
          WHERE p.sseguro = pssegpol
            AND p.cpregun = 5
            AND p.nmovimi = (SELECT MAX (pp.nmovimi)
                               FROM pregunseg pp
                              WHERE pp.sseguro = p.sseguro);

         SELECT crespue
           INTO v_crespue_d
           FROM estpregunseg p
          WHERE p.sseguro = psseguro AND p.cpregun = 5
                AND p.nmovimi = pnmovimi;

         num_err := f_desvalorfijo (9, pcidioma, v_crespue_a, vantes);
         num_err := f_desvalorfijo (9, pcidioma, v_crespue_d, vdespues);
         num_err := f_despregunta (5, pcidioma, literal);
         vantes := literal || ': ' || vantes;
         vdespues := literal || ': ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov IN (225, 212)
      THEN                                                       --AP CONF-167
         SELECT cagente
           INTO cagentea
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT cagente
           INTO cagented
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         num_err := f_desagente (cagentea, agentea);
         num_err := f_desagente (cagented, agented);
         literal := f_axis_literales (102591, pcidioma);
         vantes := literal || ' ' || cagentea || ' ' || agentea;
         vdespues := literal || ' ' || cagented || ' ' || agented;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 674
      THEN
         SELECT cduraci, fefecto                                   --, frenova
           INTO cduracia, v_fefectoa                            --, v_frenovaa
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT cduraci, fefecto                                   --, frenova
           INTO cduracid, v_fefectod                            --, v_frenovad
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         vnriesgo := 1;
         vcgarant := 0;
         vcpregun := 0;

         /*IF cduracia <> cduracid THEN
            literal := f_axis_literales(1000376, pcidioma);
            vantes := literal || ': ' || ff_desvalorfijo(41, pcidioma, cduracia);
            vdespues := literal || ': ' || ff_desvalorfijo(41, pcidioma, cduracid);
            vcpregun := vcpregun - 1;
            p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes,
                              vdespues, vcpregun);
         END IF;*/
         IF v_fefectoa <> v_fefectod
         THEN
            literal := f_axis_literales (9000572, pcidioma);
            vantes := literal || ': ' || TO_CHAR (v_fefectoa, 'DD-MM-YYYY');
            vdespues := literal || ': ' || TO_CHAR (v_fefectod, 'DD-MM-YYYY');
            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      ELSIF pcmotmov = 521
      THEN
         -- cambio Forma de Pago prestaci?
         SELECT cfprest
           INTO v_crespue_a
           FROM seguros_aho
          WHERE sseguro = pssegpol;

         SELECT cfprest
           INTO v_crespue_d
           FROM estseguros_aho
          WHERE sseguro = psseguro;

         num_err := f_desvalorfijo (205, pcidioma, v_crespue_a, vantes);
         num_err := f_desvalorfijo (205, pcidioma, v_crespue_d, vdespues);
         literal := f_axis_literales (180316, pcidioma);
         -- Forma pago prestaci?n:
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 522
      THEN
         -- cambio % inter?s t?cnico garantizado
         IF NVL (f_parproductos_v (psproduc, 'DURACI'), 0) = 1
         THEN
            -- La duracion es por anos pero renovable tantas veces como se quiera
            -- La duraic?n se busca de seguros.nduraci ya que el campo seguros_aho.ndurper no est? informado,
            -- s?lo se informa para aquellos productos con duraci?n por anos limitada (Ej: Europlazo 16 y Euroterm 16)
            SELECT nduraci
              INTO v_crespue_a
              FROM seguros
             WHERE sseguro = pssegpol;

            SELECT nduraci
              INTO v_crespue_d
              FROM estseguros
             WHERE sseguro = psseguro;
         ELSE
            -- resto de productos con duraci?n por anos
            SELECT ndurper
              INTO v_crespue_a
              FROM seguros_aho
             WHERE sseguro = pssegpol;

            SELECT ndurper
              INTO v_crespue_d
              FROM estseguros_aho
             WHERE sseguro = psseguro;
         END IF;

         literal := f_axis_literales (100715, pcidioma);          -- Duraci?n:
         vantes := literal || ' ' || v_crespue_a;
         vdespues := literal || ' ' || v_crespue_d;
         --JRH 09/2007 Tarea 2674: Intereses para LRC. Pueden haber varios intereses en la tabla de intereses
         literal := f_axis_literales (100720, pcidioma);   -- Inter?s t?cnico:
         literal2 := f_axis_literales (108676, pcidioma);            -- Tramos

         FOR c IN intereses_real
         LOOP
            BEGIN
               v_crespue_a := c.pinttec;

               SELECT pinttec
                 INTO v_crespue_d
                 FROM estintertecseg i1
                WHERE i1.sseguro = pssegpol
                  AND ndesde = c.ndesde
                  AND nhasta = c.nhasta;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  v_crespue_d := 0;                                   --NULL;
            END;

            vantes2 :=
                  vantes
               || '; % '
               || literal
               || ': '
               || v_crespue_a
               || '; '
               || literal2
               || ': '
               || c.ndesde
               || '-'
               || c.nhasta;
            vdespues2 :=
                  vdespues
               || '; % '
               || literal
               || ': '
               || v_crespue_d
               || '; '
               || literal2
               || ': '
               || c.ndesde
               || '-'
               || c.nhasta;
            vcgarant := 0;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes2,
                               vdespues2,
                               vcpregun
                              );
         END LOOP;

         --Ponemos este bucle porque podr?an en un futuro haber m?s registros en una tabla que en otra (cambios de duraci?n)
         FOR c IN intereses_est
         LOOP
            BEGIN
               v_crespue_d := c.pinttec;

               SELECT i1.pinttec
                 INTO v_crespue_a
                 FROM intertecseg i1
                WHERE i1.sseguro = pssegpol
                  AND i1.ndesde = c.ndesde
                  AND i1.nhasta = c.nhasta
                  AND i1.nmovimi =
                         (SELECT MAX (a.nmovimi)
                            FROM intertecseg a
                           WHERE a.sseguro = pssegpol
                             AND a.ndesde = i1.ndesde
                             AND a.nhasta = i1.nhasta);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  v_crespue_a := 0;                                   --NULL;
            END;

            vantes2 :=
                  vantes
               || '; % '
               || literal
               || ': '
               || v_crespue_a
               || '; '
               || literal2
               || ': '
               || c.ndesde
               || '-'
               || c.nhasta;
            vdespues2 :=
                  vdespues
               || '; % '
               || literal
               || ': '
               || v_crespue_d
               || '; '
               || literal2
               || ': '
               || c.ndesde
               || '-'
               || c.nhasta;
            vcgarant := 0;
            vnriesgo := 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes2,
                               vdespues2,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov = 523
      THEN
         -- cambio % de penalizaci?n
         vnriesgo := 0;
         vcgarant := 0;

         FOR reg IN c_penali
         LOOP
            vantes := NULL;
            vdespues := NULL;

            SELECT niniran, nfinran, ppenali
              INTO vniniran, vnfinran, vppenali
              FROM estpenaliseg
             WHERE sseguro = psseguro
               AND ctipmov = reg.ctipmov
               AND niniran = reg.niniran;

            literal1 := f_axis_literales (101836, pcidioma);         -- Desde:
            literal2 := f_axis_literales (101837, pcidioma);         -- Hasta:
            literal3 := f_axis_literales (109713, pcidioma);   -- Penalizaci?n
            vantes :=
                  literal1
               || ' '
               || reg.niniran
               || ' '
               || literal2
               || ' '
               || reg.nfinran
               || '   '
               || literal3
               || ' '
               || reg.ppenali
               || ' %';
            vdespues :=
                  literal1
               || ' '
               || vniniran
               || ' '
               || literal2
               || ' '
               || vnfinran
               || '   '
               || literal3
               || ' '
               || vppenali
               || ' %';
            vnriesgo := vnriesgo + 1;

            IF vantes <> vdespues
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov = 525
      THEN
         -- Modificaci?n de gasto vinculado (solo ULK)
         SELECT cgasges, cgasred
           INTO v_cgasges_a, v_cgasred_a
           FROM seguros_ulk
          WHERE sseguro = pssegpol;

         SELECT cgasges, cgasred
           INTO v_cgasges_d, v_cgasred_d
           FROM estseguros_ulk
          WHERE sseguro = psseguro;

         IF v_cgasges_a <> v_cgasges_d
         THEN
            -- descripcion gastos antes
            SELECT tgasto
              INTO v_gestion_a
              FROM desgastos_ulk
             WHERE cgasto = v_cgasges_a AND cidioma = pcidioma;

            -- descripcion gastos despues
            SELECT tgasto
              INTO v_gestion_d
              FROM desgastos_ulk
             WHERE cgasto = v_cgasges_d AND cidioma = pcidioma;

            literal := f_axis_literales (180468, pcidioma); -- Gastos gestion:
            vantes := literal || ' ' || v_cgasges_a || '; ';
            vdespues := literal || ' ' || v_cgasges_d || '; ';
         END IF;

         IF v_cgasred_a <> v_cgasred_d
         THEN
            -- descripcion gastos antes
            SELECT tgasto
              INTO v_redis_a
              FROM desgastos_ulk
             WHERE cgasto = v_cgasred_a AND cidioma = pcidioma;

            -- descripcion gastos despues
            SELECT tgasto
              INTO v_redis_d
              FROM desgastos_ulk
             WHERE cgasto = v_cgasred_d AND cidioma = pcidioma;

            literal := f_axis_literales (180467, pcidioma);
            -- Gastos de redistribuci?n:
            vantes := vantes || ' ' || literal || ' ' || v_cgasred_a || '; ';
            vdespues :=
                      vdespues || ' ' || literal || ' ' || v_cgasred_d || '; ';
         END IF;

         vnriesgo := 1;
         vcgarant := 0;

         IF (v_cgasges_a <> v_cgasges_d) OR (v_cgasred_a <> v_cgasred_d)
         THEN
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      ELSIF pcmotmov IN (526, 408, 409)
      THEN
-- Perfil d' inversi? (cambio de distribuci?n - solo ULK)
--------------------------------------------------------------------------
         SELECT COUNT (1)
           INTO v_segdisin2diff
           FROM (SELECT ccesta, pdistrec
                   FROM segdisin2
                  WHERE sseguro = pssegpol
                    AND ffin IS NULL
                    AND nmovimi = (SELECT MAX (nmovimi)
                                     FROM segdisin2
                                    WHERE sseguro = pssegpol AND ffin IS NULL)
                 MINUS
                 SELECT ccesta, pdistrec
                   FROM estsegdisin2
                  WHERE sseguro = psseguro
                    AND ffin IS NULL
                    AND nmovimi = (SELECT MAX (nmovimi)
                                     FROM estsegdisin2
                                    WHERE sseguro = psseguro AND ffin IS NULL));

         IF v_segdisin2diff <> 0
         THEN
            SELECT cmodinv
              INTO v_cmodinv_a
              FROM seguros_ulk
             WHERE sseguro = pssegpol;

            SELECT cmodinv
              INTO v_cmodinv_d
              FROM estseguros_ulk
             WHERE sseguro = psseguro;

            literal := f_axis_literales (108308, pcidioma);

            -- Modelo de inversi?n:
            IF    (v_cmodinv_a <> v_cmodinv_d)
               OR (    (v_cmodinv_a = v_cmodinv_d)
                   AND v_cmodinv_d =
                                   f_parproductos_v (psproduc, 'PERFIL_LIBRE')
                  )
            THEN
               -- 12442.NMM.12/2009.i.
               num_err :=
                  f_def_producto (psproduc,
                                  w_cramo,
                                  w_cmodali,
                                  w_ctipseg,
                                  w_ccolect
                                 );

               SELECT tmodinv
                 INTO v_tmodinv_a
                 FROM codimodelosinversion
                WHERE cmodinv = v_cmodinv_a
                  AND cidioma = pcidioma
                  AND cramo = w_cramo
                  AND cmodali = w_cmodali
                  AND ctipseg = w_ctipseg
                  AND ccolect = w_ccolect;

               SELECT tmodinv
                 INTO v_tmodinv_d
                 FROM codimodelosinversion
                WHERE cmodinv = v_cmodinv_d
                  AND cidioma = pcidioma
                  AND cramo = w_cramo
                  AND cmodali = w_cmodali
                  AND ctipseg = w_ctipseg
                  AND ccolect = w_ccolect;

               -- 12442.NMM.12/2009.f.
               IF v_cmodinv_a = v_cmodinv_d
               THEN
                  -- Perfil Libre
                  vantes := ' ' || literal || ' ' || v_tmodinv_a || ': ';

                  FOR regs IN cur_segdisin2
                  LOOP
                     num_err :=
                           f_desvalorfijo (8000942, 5, regs.cmodabo, literal);
                     vantes :=
                           vantes
                        || ' '
                        || '('
                        || regs.tfonabv
                        || ','
                        || regs.pdistrec
                        || '%,'
                        || literal
                        || ') ; ';
                  END LOOP;

                  vdespues := ' ' || literal || ' ' || v_tmodinv_d || ': ';

                  FOR regs IN cur_estsegdisin2
                  LOOP
                     num_err :=
                           f_desvalorfijo (8000942, 5, regs.cmodabo, literal);
                     vdespues :=
                           vdespues
                        || ' '
                        || '('
                        || regs.tfonabv
                        || ','
                        || regs.pdistrec
                        || '%,'
                        || literal
                        || ') ; ';
                  END LOOP;
               ELSE
                  -- Otros perfiles
                  IF v_cmodinv_a =
                                  f_parproductos_v (psproduc, 'PERFIL_LIBRE')
                  THEN
                     vantes := ' ' || literal || ' ' || v_tmodinv_a || ': ';

                     FOR regs IN cur_segdisin2
                     LOOP
                        num_err :=
                           f_desvalorfijo (8000942, 5, regs.cmodabo, literal);
                        vantes :=
                              vantes
                           || ' '
                           || '('
                           || regs.tfonabv
                           || ','
                           || regs.pdistrec
                           || '%,'
                           || literal
                           || ') ; ';
                     END LOOP;
                  ELSE
                     vantes :=
                        vantes || ' ' || literal || ' ' || v_tmodinv_a || ';';
                  END IF;

                  IF v_cmodinv_d = f_parproductos_v (psproduc, 'PERFIL_LIBRE')
                  THEN
                     vdespues := ' ' || literal || ' ' || v_tmodinv_d || ': ';

                     FOR regs IN cur_estsegdisin2
                     LOOP
                        num_err :=
                           f_desvalorfijo (8000942, 5, regs.cmodabo, literal);
                        vdespues :=
                              vdespues
                           || ' '
                           || '('
                           || regs.tfonabv
                           || ','
                           || regs.pdistrec
                           || '%,'
                           || literal
                           || ') ; ';
                     END LOOP;
                  ELSE
                     vdespues :=
                        vdespues || ' ' || literal || ' ' || v_tmodinv_d
                        || ';';
                  END IF;
               END IF;
            END IF;

            vnriesgo := 1;
            vcgarant := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      ELSIF pcmotmov = 266
      THEN
-- cambio suspensi?n pago peri?dico
--------------------------------------------------------------------------
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_a
           FROM garanseg
          WHERE sseguro = pssegpol
            AND cgarant = 48
            AND icapital > 0
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM garanseg
                            WHERE sseguro = pssegpol AND cgarant = 48);

         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg
          WHERE sseguro = psseguro AND cgarant = 48 AND icapital = 0;

         literal := f_axis_literales (102003, pcidioma);             -- Prima:
         vantes := literal || ' ' || v_crespue_a;
         vdespues := literal || ' ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 267
      THEN
         -- cambio rehabilitaci?n pago peri?dico
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_a
           FROM garanseg
          WHERE sseguro = pssegpol
            AND cgarant = 48
            AND icapital = 0
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM garanseg
                            WHERE sseguro = pssegpol AND cgarant = 48);

         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg
          WHERE sseguro = psseguro AND cgarant = 48 AND icapital > 0;

         literal := f_axis_literales (102003, pcidioma);             -- Prima:
         vantes := literal || ' ' || v_crespue_a;
         vdespues := literal || ' ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 252
      THEN
         -- cambio aportaci?n peri?dico
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_a
           FROM garanseg
          WHERE sseguro = pssegpol
            AND cgarant = 48
            AND icapital > 0
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM garanseg
                            WHERE sseguro = pssegpol AND cgarant = 48);

         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg
          WHERE sseguro = psseguro AND cgarant = 48 AND icapital > 0;

         -- BUG13685:DRA:17/03/2010:Inici
         IF NVL (v_crespue_a, 0) <> NVL (v_crespue_d, 0)
         THEN
            literal := f_axis_literales (102003, pcidioma);         -- Prima:
            vantes := literal || ' ' || v_crespue_a;
            vdespues := literal || ' ' || v_crespue_d;
            vnriesgo := 1;
            vcgarant := 48;                        -- BUG12710:JRH:25/01/2010
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      --Bug.: 17939 - ICV - 15/03/2011
      --Se comenta la busqueda de cambio de forma de pago en el suplemento 252 ya que realmente los unicos suplementos que
      -- estaban cambiando la fcarpro son el 269, 266, 267 y este estaba avisando, pero no la acababa cambiando.
      /*SELECT cforpag, fcarpro
        INTO cforpaga, fcarproa
        FROM seguros s
       WHERE s.sseguro = pssegpol;

      SELECT cforpag
        INTO cforpagd
        FROM estseguros s
       WHERE s.sseguro = psseguro;

      IF NVL(cforpaga, -1) <> NVL(cforpagd, -1) THEN
         num_err := f_desvalorfijo(17, pcidioma, cforpaga, vantes);
         num_err := f_desvalorfijo(17, pcidioma, cforpagd, vdespues);
         literal := f_axis_literales(102719, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
         num_err := f_fecha_efecto(psseguro, pnmovimi, v_fsuplem);
         num_err := pac_canviforpag.f_fcarpro_final(pssegpol, v_fsuplem, cforpagd,
                                                    cforpaga, fcarprod, dummy);
         literal := f_axis_literales(151215, pcidioma);   -- Fecha proximo recibo
         vantes := vantes || ' ' || literal || ' ' || TO_CHAR(fcarproa, 'dd/mm/yyyy');
         vdespues := vdespues || ' ' || literal || ' ' || TO_CHAR(fcarprod, 'dd/mm/yyyy');
         p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes,
                           vdespues, vcpregun);
      END IF;*/
      --fin Bug.: 17939 - ICV - 15/03/2011
      -- BUG13685:DRA:17/03/2010:Fi
      ELSIF pcmotmov = 524
      THEN
         -- modificacion garantias adicionales
         vnriesgo := 0;
         vcgarant := 0;

         -- Cursor que devuelve todas las garantias adicionales posibles de la poliza
         FOR reg IN c_garant_est_adicionales
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant_contratada := 0;

            BEGIN
               SELECT 1
                 INTO vcgarant_contratada
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND ffinefe IS NULL
                  -- se buscan las garantias adicionales actuales contratadas (?ltimo movimiento)
                  AND cgarant = reg.cgarant;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vcgarant_contratada := 0;
            END;

            -- Si ha habido un cambio de garantias adicionales contratadas, se insertan los cambios en detmovseguro
            IF vcgarant_contratada <> reg.cobliga
            THEN
               num_err := f_desgarantia (reg.cgarant, pcidioma, literal);
               literal1 := f_axis_literales (140907, pcidioma); -- Contratada
               literal2 := f_axis_literales (105300, pcidioma);

               -- No contratada
               IF vcgarant_contratada = 1
               THEN
                  vantes := literal || ': ' || literal1;
               ELSE
                  vantes := literal || ': ' || literal2;
               END IF;

               IF reg.cobliga = 1
               THEN
                  vdespues := literal || ': ' || literal1;
               ELSE
                  vdespues := literal || ': ' || literal2;
               END IF;

               vnriesgo := vnriesgo + 1;

               IF vantes <> vdespues
               THEN
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            END IF;
         END LOOP;
      ELSIF pcmotmov = 500
      THEN
         -- Aportaci?n Extraordinaria
         v_crespue_a := NULL;

         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg g, estseguros s
          WHERE s.sseguro = psseguro
            AND g.sseguro = s.sseguro
            AND g.cobliga = 1
            AND f_pargaranpro_v (s.cramo,
                                 s.cmodali,
                                 s.ctipseg,
                                 s.ccolect,
                                 pac_seguros.ff_get_actividad (s.sseguro,
                                                               g.nriesgo,
                                                               'EST'
                                                              ),
                                 g.cgarant,
                                 'TIPO'
                                ) = 4;                         --JRH El tipo 4

         -- Bug 9699 - APD - 23/04/2009 - fin
         literal := f_axis_literales (180435, pcidioma);
         -- Aportaci?n extraordinaria
         vantes := v_crespue_a;
         vdespues := literal || ': ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 556
      THEN
         -- JRH 12/2008 Part. Benef.
         v_crespue_a := NULL;

         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg g, estseguros s
          WHERE s.sseguro = psseguro
            AND g.sseguro = s.sseguro
            AND g.cobliga = 1
            AND f_pargaranpro_v (s.cramo,
                                 s.cmodali,
                                 s.ctipseg,
                                 s.ccolect,
                                 pac_seguros.ff_get_actividad (s.sseguro,
                                                               g.nriesgo,
                                                               'EST'
                                                              ),
                                 g.cgarant,
                                 'TIPO'
                                ) = 12;   --JRH El tipo 12 es garant?a tipo PB

         -- Bug 9699 - APD - 23/04/2009 - fin
         literal := f_axis_literales (108834, pcidioma);
         -- Aportaci?n extraordinaria
         vantes := v_crespue_a;
         vdespues := literal || ': ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 265
      THEN
         -- Fallecimiento de un asegurado ( productos 2 cabezas )
         v_crespue_a := NULL;

         SELECT sperson
           INTO vsperson
           FROM estassegurats
          WHERE sseguro = psseguro AND ffecfin IS NOT NULL;

         literal := f_axis_literales (101253, pcidioma);  -- Persona fallecida
         vantes := v_crespue_a;
         v_crespue_d := f_nombre_est (vsperson, 1, psseguro);
         vdespues := literal || ': ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 219
      THEN
         -- Cambio de Vencimiento
         SELECT TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT TO_CHAR (s.fvencim, 'DD/MM/YYYY')
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (120453, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 550
      THEN
         --JRH Tarea 6966 Anado el movimiento 550
         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_a
           FROM garanseg
          WHERE sseguro = pssegpol
            AND cgarant = 48
            AND icapital > 0
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM garanseg
                            WHERE sseguro = pssegpol AND cgarant = 48);

         SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
           INTO v_crespue_d
           FROM estgaranseg
          WHERE sseguro = psseguro AND cgarant = 48 AND icapital > 0;

         literal := f_axis_literales (102003, pcidioma);             -- Prima:
         vantes := literal || ' ' || v_crespue_a;
         vdespues := literal || ' ' || v_crespue_d;
         vnriesgo := 1;
         vcgarant := 0;
      ELSIF pcmotmov = 684
      THEN
         -- Modificaci?n preguntas nivel poliza
         FOR c IN
            (SELECT DECODE (cp.ctippre,
                            4, p.trespue,           -- BUG10985:DRA:26/08/2009
                            5, p.trespue,
                            p.crespue
                           ) antes,
                    p.cpregun, p.nmovimi
               FROM pregunpolseg p, pregunpro e, seguros s, codipregun cp
              WHERE p.cpregun = e.cpregun
                AND e.cnivel = 'P'
                AND p.sseguro = s.sseguro
                AND s.sseguro = pssegpol
                AND p.nmovimi = (SELECT MAX (pp.nmovimi)
                                   FROM pregunpolseg pp
                                  WHERE pp.sseguro = pssegpol)
                AND e.sproduc = psproduc
                AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                    )                                --BUG23860:DCT:26/10/2012
                AND cp.cpregun = p.cpregun           -- BUG9988:DRA:30/04/2009
                AND NOT EXISTS (
                       SELECT ep.cpregun
                         FROM estpregunpolseg ep
                        WHERE ep.sseguro = psseguro
                          AND ep.nmovimi = pnmovimi
                          AND ep.cpregun = p.cpregun
                          AND DECODE (cp.ctippre,
                                      4, NVL (ep.trespue, '**'),
                                      -- BUG10985:DRA:26/08/2009
                                      5, NVL (ep.trespue, '**'),
                                      TO_CHAR (ep.crespue)
                                     ) =
                                 DECODE (cp.ctippre,
                                         4, NVL (p.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (p.trespue, '**'),
                                         TO_CHAR (p.crespue)
                                        ))
                AND NOT EXISTS (
                       SELECT ed.cpregun
                         FROM estdetmovseguro ed
                        WHERE ed.sseguro = psseguro
                          AND ed.nmovimi = pnmovimi
                          AND ed.nriesgo = 0
                          AND ed.cgarant = 0
                          AND ed.cpregun = p.cpregun
                          AND ed.cmotmov = 684))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vdespues
                 FROM estpregunpolseg p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '';                                     --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := 0;
            vnriesgo := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN
            (SELECT DECODE (cp.ctippre,
                            4, p.trespue,           -- BUG10985:DRA:26/08/2009
                            5, p.trespue,
                            p.crespue
                           ) despues,
                    p.cpregun, p.nmovimi
               FROM estpregunpolseg p,
                    pregunpro e,
                    estseguros s,
                    codipregun cp
              WHERE p.cpregun = e.cpregun
                AND e.cnivel = 'P'
                AND p.sseguro = s.sseguro
                AND s.sseguro = psseguro
                AND p.nmovimi = pnmovimi
                AND e.sproduc = psproduc
                AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                    )                                --BUG23860:DCT:26/10/2012
                AND cp.cpregun = p.cpregun           -- BUG9988:DRA:30/04/2009
                AND NOT EXISTS (
                       SELECT ps.cpregun
                         FROM pregunpolseg ps
                        WHERE ps.sseguro = pssegpol
                          AND ps.nmovimi = (SELECT MAX (pp.nmovimi)
                                              FROM pregunpolseg pp
                                             WHERE pp.sseguro = pssegpol)
                          AND ps.cpregun = p.cpregun
                          AND DECODE (cp.ctippre,
                                      4, NVL (ps.trespue, '**'),
                                      -- BUG10985:DRA:26/08/2009
                                      5, NVL (ps.trespue, '**'),
                                      TO_CHAR (ps.crespue)
                                     ) =
                                 DECODE (cp.ctippre,
                                         4, NVL (p.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (p.trespue, '**'),
                                         TO_CHAR (p.crespue)
                                        ))
                AND NOT EXISTS (
                       SELECT ed.cpregun
                         FROM estdetmovseguro ed
                        WHERE ed.sseguro = psseguro
                          AND ed.nmovimi = pnmovimi
                          AND ed.nriesgo = 0
                          AND ed.cgarant = 0
                          AND ed.cpregun = p.cpregun
                          AND ed.cmotmov = 684))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vantes
                 FROM pregunpolseg p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi =
                         (SELECT MAX (p1.nmovimi)   -- BUG14172:DRA:19/04/2010
                            FROM pregunpolseg p1
                           WHERE p1.sseguro = pssegpol
                             AND p1.cpregun = c.cpregun)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '';                                       --NULL;
            END;

            vdespues := c.despues;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := 0;
            vnriesgo := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN (SELECT DECODE (p.ccolumna,
                                  2, p.tvalor,
                                  3, p.fvalor,
                                  p.nvalor
                                 ) antes,
                          p.cpregun, p.nmovimi
                     FROM pregunpolsegtab p,
                          pregunpro e,
                          seguros s,
                          codipregun cp
                    WHERE p.cpregun = e.cpregun
                      AND e.cnivel = 'P'
                      AND p.sseguro = s.sseguro
                      AND s.sseguro = pssegpol
                      AND p.nmovimi = (SELECT MAX (pp.nmovimi)
                                         FROM pregunpolsegtab pp
                                        WHERE pp.sseguro = pssegpol)
                      AND e.sproduc = psproduc
                      AND (   (e.cpretip <> 2)
                           OR (e.cpretip = 2 AND e.esccero = 1)
                          )                          --BUG23860:DCT:26/10/2012
                      AND cp.cpregun = p.cpregun
                      AND NOT EXISTS (
                             SELECT ep.cpregun
                               FROM estpregunpolsegtab ep
                              WHERE ep.sseguro = psseguro
                                AND ep.nmovimi = pnmovimi
                                AND ep.cpregun = p.cpregun
                                AND DECODE (p.ccolumna,
                                            2, NVL (ep.tvalor, '**'),
                                            3, NVL (ep.fvalor, '**'),
                                            TO_CHAR (ep.nvalor)
                                           ) =
                                       DECODE (p.ccolumna,
                                               2, NVL (p.tvalor, '**'),
                                               3, NVL (p.fvalor, '**'),
                                               TO_CHAR (p.nvalor)
                                              ))
                      AND NOT EXISTS (
                             SELECT ed.cpregun
                               FROM estdetmovseguro ed
                              WHERE ed.sseguro = psseguro
                                AND ed.nmovimi = pnmovimi
                                AND ed.nriesgo = 0
                                AND ed.cgarant = 0
                                AND ed.cpregun = p.cpregun
                                AND ed.cmotmov = 684))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                 INTO vdespues
                 FROM estpregunpolsegtab p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '';                                     --NULL;
            END;

            vantes := c.antes;
            vcgarant := 0;
            vnriesgo := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN (SELECT DECODE (p.ccolumna,
                                  2, p.tvalor,
                                  3, p.fvalor,
                                  p.nvalor
                                 ) despues,
                          p.cpregun, p.nmovimi
                     FROM estpregunpolsegtab p,
                          pregunpro e,
                          estseguros s,
                          codipregun cp
                    WHERE p.cpregun = e.cpregun
                      AND e.cnivel = 'P'
                      AND p.sseguro = s.sseguro
                      AND s.sseguro = psseguro
                      AND p.nmovimi = pnmovimi
                      AND e.sproduc = psproduc
                      AND (   (e.cpretip <> 2)
                           OR (e.cpretip = 2 AND e.esccero = 1)
                          )                          --BUG23860:DCT:26/10/2012
                      AND cp.cpregun = p.cpregun
                      AND NOT EXISTS (
                             SELECT ps.cpregun
                               FROM pregunpolsegtab ps
                              WHERE ps.sseguro = pssegpol
                                AND ps.nmovimi =
                                                (SELECT MAX (pp.nmovimi)
                                                   FROM pregunpolsegtab pp
                                                  WHERE pp.sseguro = pssegpol)
                                AND ps.cpregun = p.cpregun
                                AND DECODE (p.ccolumna,
                                            2, NVL (ps.tvalor, '**'),
                                            3, NVL (ps.fvalor, '**'),
                                            TO_CHAR (ps.nvalor)
                                           ) =
                                       DECODE (cp.ctippre,
                                               2, NVL (p.tvalor, '**'),
                                               3, NVL (p.fvalor, '**'),
                                               TO_CHAR (p.nvalor)
                                              ))
                      AND NOT EXISTS (
                             SELECT ed.cpregun
                               FROM estdetmovseguro ed
                              WHERE ed.sseguro = psseguro
                                AND ed.nmovimi = pnmovimi
                                AND ed.nriesgo = 0
                                AND ed.cgarant = 0
                                AND ed.cpregun = p.cpregun
                                AND ed.cmotmov = 684))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                 INTO vantes
                 FROM pregunpolsegtab p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi =
                         (SELECT MAX (p1.nmovimi)
                            FROM pregunpolsegtab p1
                           WHERE p1.sseguro = pssegpol
                             AND p1.cpregun = c.cpregun)
                  AND cp.cpregun = p.cpregun;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '';                                       --NULL;
            END;

            vdespues := c.despues;
            vcgarant := 0;
            vnriesgo := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         -- INI IAXIS-5428 CJMR 04/11/2019
         vcpregun := 0;

         FOR ctj IN
            (SELECT c.cagente cagente_ori, e.cagente cagente_des
               FROM age_corretaje c, estage_corretaje e
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM pregunpolseg /*age_corretaje*/ c1
                                  WHERE c1.sseguro = c.sseguro)
                AND e.sseguro = psseguro
                AND e.nmovimi = pnmovimi
                AND c.nordage = e.nordage
                AND (   c.cagente <> e.cagente
                     OR NVL (c.ppartici, -1) <> NVL (e.ppartici, -1)
                     --OR NVL(c.pcomisi, -1) <> NVL(e.pcomisi, -1)  -- BUG22402:DRA:10/07/2012
                     OR NVL (c.islider, -1) <> NVL (e.islider, -1)
                    )
             UNION
             SELECT c.cagente cagente_ori, NULL cagente_des
               FROM age_corretaje c
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM pregunpolseg /*age_corretaje*/ c1
                                  WHERE c1.sseguro = c.sseguro)
                AND NOT EXISTS (
                       SELECT 1
                         FROM estage_corretaje e
                        WHERE e.sseguro = psseguro
                          AND e.nmovimi = pnmovimi
                          AND e.nordage = c.nordage)
             UNION
             SELECT NULL cagente_ori, e.cagente cagente_des
               FROM estage_corretaje e
              WHERE e.sseguro = psseguro
                AND e.nmovimi = pnmovimi
                AND NOT EXISTS (
                       SELECT 1
                         FROM age_corretaje c
                        WHERE c.sseguro = pssegpol
                          AND c.nmovimi =
                                      (SELECT MAX (c1.nmovimi)
                                         FROM pregunpolseg /*age_corretaje*/ c1
                                        WHERE c1.sseguro = c.sseguro)
                          AND c.nordage = e.nordage))
         LOOP
            BEGIN
               -- Bug 27539/149064 - APD - 24/07/2013 - el MAX nmovimi se debe buscar
               -- de pregunpolseg
               SELECT    c.cagente
                      || ' - '
                      || f_axis_literales (104818, pcidioma)
                      || ': '
                      || c.ppartici
                      -- || ' - ' || f_axis_literales(9001923, pcidioma) || ': ' || c.pcomisi -- BUG22402:DRA:10/07/2012
                      || ' - '
                      || f_axis_literales (9902425, pcidioma)
                      || ': '
                      || ff_desvalorfijo (9, pcidioma, c.islider)
                 INTO vantes
                 FROM age_corretaje c
                WHERE c.sseguro = pssegpol
                  AND c.cagente = ctj.cagente_ori
                  AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                     FROM pregunpolseg /*age_corretaje*/ c1
                                    WHERE c1.sseguro = c.sseguro);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
            END;

            BEGIN
               SELECT    c.cagente
                      || ' - '
                      || f_axis_literales (104818, pcidioma)
                      || ': '
                      || c.ppartici
                      -- || ' - ' || f_axis_literales(9001923, pcidioma) || ': ' || c.pcomisi  -- BUG22402:DRA:10/07/2012
                      || ' - '
                      || f_axis_literales (9902425, pcidioma)
                      || ': '
                      || ff_desvalorfijo (9, pcidioma, c.islider)
                 INTO vdespues
                 FROM estage_corretaje c
                WHERE c.sseguro = psseguro
                  AND c.cagente = ctj.cagente_des
                  AND c.nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
            END;

            literal := f_axis_literales (100584, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := 1;
            vcgarant := 0;
            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- FIN IAXIS-5428 CJMR 04/11/2019
      ELSIF pcmotmov = 955
      THEN
         FOR c IN (SELECT CASE
                             WHEN e.cpregun = 7005
                                THEN e.trespue
                             WHEN e.cpregun = 7006
                                THEN r.trespue
                             ELSE TO_CHAR (e.crespue)
                          END antes,
                          e.cpregun, e.nriesgo
                     FROM pregunseg e, seguros s, pregunpro p, respuestas r
                    WHERE e.cpregun IN (7003, 7004, 7005, 7006)
                      AND e.sseguro = pssegpol
                      AND r.cpregun(+) = e.cpregun
                      AND r.crespue(+) = e.crespue
                      AND e.nmovimi = (SELECT MAX (nmovimi)
                                         FROM pregunseg
                                        WHERE sseguro = pssegpol)
                      AND e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM estriesgos r
                               WHERE r.sseguro = psseguro
                                     AND r.fanulac IS NULL)
                      AND s.sseguro = e.sseguro
                      AND s.sproduc = p.sproduc
                      AND e.cpregun = p.cpregun
                      AND (   (p.cpretip <> 2)
                           OR (p.cpretip = 2 AND p.esccero = 1)
                          ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vantes := NVL (c.antes, ' ');
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT CASE
                         WHEN e.cpregun = 7005
                            THEN e.trespue
                         WHEN e.cpregun = 7006
                            THEN r.trespue
                         ELSE TO_CHAR (e.crespue)
                      END
                 INTO vdespues
                 FROM estpregunseg e, estseguros s, pregunpro p, respuestas r
                WHERE e.cpregun = c.cpregun
                  AND e.sseguro = psseguro
                  AND r.cpregun(+) = e.cpregun
                  AND r.crespue(+) = e.crespue
                  AND e.nmovimi = pnmovimi
                  AND e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                  AND s.sseguro = e.sseguro
                  AND s.sproduc = p.sproduc
                  AND e.cpregun = p.cpregun
                  AND ((p.cpretip <> 2) OR (p.cpretip = 2 AND p.esccero = 1)
                      );
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            IF vantes != vdespues
            THEN
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN (SELECT CASE
                             WHEN e.cpregun = 7005
                                THEN e.trespue
                             WHEN e.cpregun = 7006
                                THEN r.trespue
                             ELSE TO_CHAR (e.crespue)
                          END despues,
                          e.cpregun, e.nriesgo
                     FROM estpregunseg e,
                          estseguros s,
                          pregunpro p,
                          respuestas r
                    WHERE e.cpregun IN (7003, 7004, 7005, 7006)
                      AND e.sseguro = psseguro
                      AND r.cpregun(+) = e.cpregun
                      AND r.crespue(+) = e.crespue
                      AND e.nmovimi = pnmovimi
                      AND e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                      AND s.sseguro = e.sseguro
                      AND s.sproduc = p.sproduc
                      AND e.cpregun = p.cpregun
                      AND (   (p.cpretip <> 2)
                           OR (p.cpretip = 2 AND p.esccero = 1)
                          ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vdespues := NVL (c.despues, ' ');
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT CASE
                         WHEN e.cpregun = 7005
                            THEN e.trespue
                         WHEN e.cpregun = 7006
                            THEN r.trespue
                         ELSE TO_CHAR (e.crespue)
                      END
                 INTO vantes
                 FROM pregunseg e, seguros s, pregunpro p, respuestas r
                WHERE e.cpregun = c.cpregun
                  AND r.cpregun(+) = e.cpregun
                  AND r.crespue(+) = e.crespue
                  AND e.sseguro = pssegpol
                  AND e.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunseg
                                    WHERE sseguro = pssegpol)
                  AND e.nriesgo IN (
                              SELECT r.nriesgo
                                FROM estriesgos r
                               WHERE r.sseguro = psseguro
                                     AND r.fanulac IS NULL)
                  AND s.sseguro = e.sseguro
                  AND s.sproduc = p.sproduc
                  AND e.cpregun = p.cpregun
                  AND ((p.cpretip <> 2) OR (p.cpretip = 2 AND p.esccero = 1)
                      );
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := ' ';                                      --NULL;
            END;

            IF vantes != vdespues
            THEN
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN (SELECT DISTINCT r.trespue antes, e.cpregun, e.nriesgo
                              FROM pregungaranseg e,
                                   seguros s,
                                   pregunprogaran p,
                                   respuestas r
                             WHERE e.cpregun IN (7006)
                               AND e.sseguro = pssegpol
                               AND r.cpregun = e.cpregun
                               AND r.crespue = e.crespue
                               AND e.nmovimi = (SELECT MAX (nmovimi)
                                                  FROM pregunseg
                                                 WHERE sseguro = pssegpol)
                               AND e.nriesgo IN (
                                      SELECT r.nriesgo
                                        FROM estriesgos r
                                       WHERE r.sseguro = psseguro
                                         AND r.fanulac IS NULL)
                               AND s.sseguro = e.sseguro
                               AND s.sproduc = p.sproduc
                               AND e.cpregun = p.cpregun
                               AND (   (p.cpretip <> 2)
                                    OR (p.cpretip = 2 AND p.esccero = 1)
                                   ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vantes := NVL (c.antes, ' ');
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DISTINCT r.trespue
                          INTO vdespues
                          FROM estpregungaranseg e,
                               estseguros s,
                               pregunprogaran p,
                               respuestas r
                         WHERE e.cpregun = c.cpregun
                           AND e.sseguro = psseguro
                           AND e.nmovimi = pnmovimi
                           AND r.cpregun = e.cpregun
                           AND r.crespue = e.crespue
                           AND e.nriesgo IN (
                                  SELECT r.nriesgo
                                    FROM riesgos r
                                   WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                           AND s.sseguro = e.sseguro
                           AND s.sproduc = p.sproduc
                           AND e.cpregun = p.cpregun
                           AND (   (p.cpretip <> 2)
                                OR (p.cpretip = 2 AND p.esccero = 1)
                               );
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            IF vantes != vdespues
            THEN
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN (SELECT DISTINCT r.trespue despues, e.cpregun, e.nriesgo
                              FROM estpregungaranseg e,
                                   estseguros s,
                                   pregunprogaran p,
                                   respuestas r
                             WHERE e.cpregun IN (7006)
                               AND e.sseguro = psseguro
                               AND e.nmovimi = pnmovimi
                               AND r.cpregun = e.cpregun
                               AND r.crespue = e.crespue
                               AND e.nriesgo IN (
                                      SELECT r.nriesgo
                                        FROM riesgos r
                                       WHERE r.sseguro = pssegpol
                                         AND r.fanulac IS NULL)
                               AND s.sseguro = e.sseguro
                               AND s.sproduc = p.sproduc
                               AND e.cpregun = p.cpregun
                               AND (   (p.cpretip <> 2)
                                    OR (p.cpretip = 2 AND p.esccero = 1)
                                   ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vdespues := NVL (c.despues, ' ');
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DISTINCT r.trespue
                          INTO vantes
                          FROM pregungaranseg e,
                               seguros s,
                               pregunprogaran p,
                               respuestas r
                         WHERE e.cpregun = c.cpregun
                           AND e.sseguro = pssegpol
                           AND r.cpregun = e.cpregun
                           AND r.crespue = e.crespue
                           AND e.nmovimi = (SELECT MAX (nmovimi)
                                              FROM pregungaranseg
                                             WHERE sseguro = pssegpol)
                           AND e.nriesgo IN (
                                  SELECT r.nriesgo
                                    FROM estriesgos r
                                   WHERE r.sseguro = psseguro
                                     AND r.fanulac IS NULL)
                           AND s.sseguro = e.sseguro
                           AND s.sproduc = p.sproduc
                           AND e.cpregun = p.cpregun
                           AND (   (p.cpretip <> 2)
                                OR (p.cpretip = 2 AND p.esccero = 1)
                               );
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := ' ';                                      --NULL;
            END;

            IF vantes != vdespues
            THEN
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END IF;
         END LOOP;
      -- BUG10184:DRA:17/07/2009:Fi
      ELSIF pcmotmov IN (685, 689, 675)
      THEN
         -- Modificaci?n preguntas nivel riesgo
         FOR c IN c_pregun_riesgo_real
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vdespues
                 FROM estpregunseg p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN c_preguntab_riesgo_real
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                 INTO vdespues
                 FROM estpregunsegtab p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            --p_recuperadescripcrespue(psproduc, c.cpregun, vantes, vdespues, pcidioma);
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            --vantes := literal || ': ' || vantes;
            --vdespues := literal || ': ' || vdespues;

            /*IF literal2 IS NOT NULL THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;*/
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN c_pregun_riesgo_est
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vantes
                 FROM pregunseg p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunseg
                                    WHERE sseguro = pssegpol)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := ' ';                                      --NULL;
            END;

            vdespues := c.despues;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         --INI IAXIS 5376 AABG: Se llama a cursor unicamente para validaciones de producto 8063
         IF (pcmotmov = 685 AND psproduc = 8063)
         THEN
            vantes := NULL;
            vantesdef := '';
            vdespues := NULL;
            vcgarant := 0;
            vdespregunta := '';
            vpregunta := 0;

            FOR c IN c_preguntab_riesgo_est_clin
            LOOP
               vtextocolumna := '';
               vnriesgo := c.nriesgo;
               vdespregunta := f_despregunta (c.cpregun, pcidioma, literal);
               vpregunta := c.cpregun;

               BEGIN
                  SELECT p.nvalor
                    INTO vantes
                    FROM pregunsegtab p
                   WHERE p.sseguro = pssegpol
                     AND p.ccolumna = c.ccolumna
                     AND p.nmovimi =
                            (SELECT MAX (pss.nmovimi)
                               FROM pregunsegtab pss
                              WHERE pss.sseguro = pssegpol
                                AND pss.ccolumna = p.ccolumna);

                  SELECT slitera
                    INTO vliteral
                    FROM preguntab_colum pc
                   WHERE pc.cpregun = c.cpregun AND pc.ccolumn = c.ccolumna;

                  --Se obtiene el titulo de la columna
                  vtextocolumna := f_axis_literales (vliteral, pcidioma);
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := ' ';                                   --NULL;
               END;

               vantesdef :=
                          vantesdef || vtextocolumna || ': ' || vantes || ', ';
               vdespues :=
                        vdespues || vtextocolumna || ': ' || c.despues || ', ';
            END LOOP;

            IF vpregunta > 0
            THEN
               p_recuperadescripcrespue (psproduc,
                                         vpregunta,
                                         vantesdef,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               vantesdef := literal || ': ' || vantesdef;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantesdef :=
                              literal2 || ' ' || vnriesgo || ' ' || vantesdef;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantesdef,
                                  vdespues,
                                  vpregunta
                                 );
            END IF;
         ELSE
            --Para producto 8062 y motmov 685
            FOR c IN c_preguntab_riesgo_est
            LOOP
               vantes := NULL;
               vdespues := NULL;
               vcgarant := 0;
               vnriesgo := c.nriesgo;
               num_err := f_despregunta (c.cpregun, pcidioma, literal);

               BEGIN
                  SELECT DECODE (p.ccolumna,
                                 2, p.tvalor,
                                 3, p.fvalor,
                                 p.nvalor
                                )
                    INTO vantes
                    FROM pregunsegtab p, codipregun cp
                   WHERE p.sseguro = pssegpol
                     AND p.nriesgo = c.nriesgo
                     AND p.cpregun = c.cpregun
                     AND p.nmovimi = (SELECT MAX (nmovimi)
                                        FROM pregunsegtab
                                       WHERE sseguro = pssegpol)
                     AND cp.cpregun = p.cpregun;     -- BUG9988:DRA:30/04/2009
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := ' ';                                   --NULL;
               END;

               vdespues := c.despues;
               -- INI IAXIS 5326 AABG: Ajuste para obtener la descripcion de la pregunta
               p_recuperadescripcrespue (psproduc,
                                         c.cpregun,
                                         vantes,
                                         vdespues,
                                         pcidioma,
                                         psseguro
                                        );
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               -- FIN IAXIS 5326 AABG: Ajuste para obtener la descripcion de la pregunta

               -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
               p_tab_error (f_sysdate,
                            f_user,
                            'PAC_EMISION.MV.f_retener_poliza',
                            12,
                            'AABG PAK_SUPLEMENTOS LLAMADO A FUNCION75',
                            NULL
                           );
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  c.cpregun
                                 );
            END LOOP;
         END IF;
      --FIN IAXIS 5376 AABG: Se llama a cursor unicamente para validaciones de producto 8063

      -- BUG10184:DRA:17/07/2009:Inici
      ELSIF pcmotmov = 927
      THEN
         SELECT crecfra
           INTO v_crecfra_ori
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT crecfra
           INTO v_crecfra_des
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         num_err :=
                   f_desvalorfijo (49, pcidioma, v_crecfra_ori, v_trecfra_ori);
         num_err :=
                   f_desvalorfijo (49, pcidioma, v_crecfra_des, v_trecfra_des);
         literal := f_axis_literales (103832, pcidioma);
         vantes := literal || ' ' || v_trecfra_ori;
         vdespues := literal || ' ' || v_trecfra_des;
         vnriesgo := 1;
         vcgarant := 0;
      -- BUG10184:DRA:17/07/2009:Fi
      -- Bug 10961.21/09/2009.i: CRE - Incidencia en p?liza CVC 23001722
      ELSIF pcmotmov = 802
      THEN
         literal1 := f_axis_literales (103100, pcidioma);

         -- Descompte comercial
         FOR c IN garantias_real_dtocom
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT pdtocom,
                      TO_CHAR (pdtocom, 'FM9990D00') || ' % ' || literal1
                 INTO v_dtocom,
                      vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
                  v_dtocom := 0;
            END;

            vantes :=
                  literal
               || ': '
               || TO_CHAR (c.antes, 'FM9990D00')
               || ' % '
               || literal1;
            -- BUG7701:dra:10-02-2009: Para que quede bonito en pantalla
            vdespues := literal || ': ' || vdespues;  -- || ' % ' || literal1;
            --||' ?';
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            -- BUG9423:12-03-2009: Si antes no hab?a garant?a y ahora el % es 0 no hay cambios
            IF NVL (v_dtocom, 0) <> NVL (c.antes, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;

         FOR c IN garantias_est_dtocom
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT pdtocom,
                      TO_CHAR (pdtocom, 'FM9990D00') || ' % ' || literal1
                 INTO v_dtocom,
                      vantes
                 FROM garanseg
                WHERE sseguro = pssegpol
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND ffinefe IS NULL;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
                  v_dtocom := 0;
            END;

            vdespues :=
                  literal
               || ': '
               || TO_CHAR (c.despues, 'FM9990D00')
               || ' % '
               || literal1;
            -- BUG7701:dra:10-02-2009: Para que quede bonito en pantalla
            vantes := literal || ': ' || vantes;      -- || ' % ' || literal1;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            -- BUG9423:12-03-2009: Si antes no hab?a garant?a y ahora el % es 0 no hay cambios
            IF NVL (v_dtocom, 0) <> NVL (c.despues, 0)
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      -- Bug 10961.21/09/2009.f: CRE - Incidencia en p?liza CVC 23001722
      -- Bug 10907 - 03/09/2009 - JMF
      ELSIF pcmotmov = 686
      THEN
         -- Modificaci? capital assegurat
         vcontador := -1;

         FOR c10 IN (SELECT DISTINCT e.nriesgo
                                FROM estprestamoseg e
                               WHERE e.sseguro = psseguro
                                 AND e.nmovimi = pnmovimi)
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vnriesgo := c10.nriesgo;
            vcgarant := 0;

            FOR c11 IN
               (SELECT e.ctapres, e.isaldo, e.porcen, e.ilimite, e.icapmax,
                       e.ctipimp, e.icapaseg
                  FROM estprestamoseg e
                 WHERE e.sseguro = psseguro
                   AND e.nmovimi = pnmovimi
                   AND e.nriesgo = c10.nriesgo
                   AND NOT EXISTS (
                          SELECT 1
                            FROM prestamoseg s
                           WHERE s.sseguro = pssegpol
                             AND s.nriesgo = c10.nriesgo
                             AND s.nmovimi = (SELECT MAX (s1.nmovimi)
                                                FROM prestamoseg s1
                                               WHERE s1.sseguro = pssegpol)
                             AND s.ctapres = e.ctapres
                             AND NVL (s.isaldo, -1) = NVL (e.isaldo, -1)
                             AND NVL (s.porcen, -1) = NVL (e.porcen, -1)
                             AND NVL (s.ilimite, -1) = NVL (e.ilimite, -1)
                             AND NVL (s.icapmax, -1) = NVL (e.icapmax, -1)
                             AND NVL (s.ctipimp, -1) = NVL (e.ctipimp, -1)
                             AND NVL (s.icapaseg, -1) = NVL (e.icapaseg, -1)))
            LOOP
               vdespues := c11.ctapres;
               vantes := c11.ctapres;

               BEGIN
                  SELECT s.ctipimp,
                            f_axis_literales (9002015, pcidioma)
                         || '='
                         || ff_desvalorfijo (402, pcidioma, s.ctipimp),
                         s.isaldo,
                            f_axis_literales (9001942, pcidioma)
                         || '='
                         || TO_CHAR (s.isaldo, 'FM9G999G999G990D00'),
                         s.porcen,
                            f_axis_literales (101467, pcidioma)
                         || '='
                         || TO_CHAR (s.porcen, 'FM990D00'),
                         s.ilimite,
                            f_axis_literales (108871, pcidioma)
                         || '='
                         || TO_CHAR (s.ilimite, 'FM9G999G999G990D00'),
                         s.icapmax,
                            f_axis_literales (105815, pcidioma)
                         || '='
                         || TO_CHAR (s.icapmax, 'FM9G999G999G990D00'),
                         s.icapaseg,
                            f_axis_literales (9002016, pcidioma)
                         || '='
                         || TO_CHAR (s.icapaseg, 'FM9G999G999G990D00')
                    INTO v_ctipimp,
                         v_dtipimp,
                         v_isaldo,
                         v_dsaldo,
                         v_porcen,
                         v_dporcen,
                         v_ilimite,
                         v_dlimite,
                         v_icapmax,
                         v_dcapmax,
                         v_icapaseg,
                         v_dcapaseg
                    FROM prestamoseg s
                   WHERE s.sseguro = pssegpol
                     AND s.nriesgo = c10.nriesgo
                     AND s.nmovimi = (SELECT MAX (s1.nmovimi)
                                        FROM prestamoseg s1
                                       WHERE s1.sseguro = pssegpol)
                     AND s.ctapres = c11.ctapres;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vantes := '  ';
                     v_ctipimp := NULL;
                     v_isaldo := NULL;
                     v_porcen := NULL;
                     v_ilimite := NULL;
                     v_icapmax := NULL;
                     v_icapaseg := NULL;
               END;

               IF NVL (v_ctipimp, -1) <> NVL (c11.ctipimp, -1)
               THEN
                  IF v_ctipimp IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dtipimp, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (9002015, pcidioma)
                             || '='
                             || ff_desvalorfijo (402, pcidioma, c11.ctipimp),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_isaldo, -1) <> NVL (c11.isaldo, -1)
               THEN
                  IF v_isaldo IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dsaldo, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (9001942, pcidioma)
                             || '='
                             || TO_CHAR (c11.isaldo, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_porcen, -1) <> NVL (c11.porcen, -1)
               THEN
                  IF v_porcen IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dporcen, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (101467, pcidioma)
                             || '='
                             || TO_CHAR (c11.porcen, 'FM990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_ilimite, -1) <> NVL (c11.ilimite, -1)
               THEN
                  IF v_ilimite IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dlimite, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (108871, pcidioma)
                             || '='
                             || TO_CHAR (c11.ilimite, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_icapmax, -1) <> NVL (c11.icapmax, -1)
               THEN
                  IF v_icapmax IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dcapmax, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (105815, pcidioma)
                             || '='
                             || TO_CHAR (c11.icapmax, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_icapaseg, -1) <> NVL (c11.icapaseg, -1)
               THEN
                  IF v_icapaseg IS NOT NULL
                  THEN
                     vantes := SUBSTR (vantes || ', ' || v_dcapaseg, 1, 2500);
                  END IF;

                  vdespues :=
                     SUBSTR (   vdespues
                             || ', '
                             || f_axis_literales (9002016, pcidioma)
                             || '='
                             || TO_CHAR (c11.icapaseg, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcontador
                                 );
               vcontador := vcontador - 1;
            END LOOP;
         END LOOP;

         -- Fi Bug 10907 - 18/08/2009 - JMF

         -- BUG10569:DRA:31/08/2009:Inici
         FOR c10 IN (SELECT DISTINCT e.nriesgo
                                FROM prestamoseg e
                               WHERE e.sseguro = pssegpol
                                 AND e.nmovimi =
                                                (SELECT MAX (s1.nmovimi)
                                                   FROM prestamoseg s1
                                                  WHERE s1.sseguro = pssegpol))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vnriesgo := c10.nriesgo;
            vcgarant := 0;

            FOR c11 IN (SELECT e.ctapres, e.isaldo, e.porcen, e.ilimite,
                               e.icapmax, e.ctipimp, e.icapaseg
                          FROM prestamoseg e
                         WHERE e.sseguro = pssegpol
                           AND e.nmovimi = (SELECT MAX (s1.nmovimi)
                                              FROM prestamoseg s1
                                             WHERE s1.sseguro = pssegpol)
                           AND e.nriesgo = c10.nriesgo
                           AND NOT EXISTS (
                                  SELECT 1
                                    FROM estprestamoseg s
                                   WHERE s.sseguro = psseguro
                                     AND s.nriesgo = c10.nriesgo
                                     AND s.nmovimi = pnmovimi
                                     AND s.ctapres = e.ctapres
                                     AND NVL (s.isaldo, -1) =
                                                             NVL (e.isaldo,
                                                                  -1)
                                     AND NVL (s.porcen, -1) =
                                                             NVL (e.porcen,
                                                                  -1)
                                     AND NVL (s.ilimite, -1) =
                                                            NVL (e.ilimite,
                                                                 -1)
                                     AND NVL (s.icapmax, -1) =
                                                            NVL (e.icapmax,
                                                                 -1)
                                     AND NVL (s.ctipimp, -1) =
                                                            NVL (e.ctipimp,
                                                                 -1)
                                     AND NVL (s.icapaseg, -1) =
                                                           NVL (e.icapaseg,
                                                                -1)))
            LOOP
               vantes := c11.ctapres;
               vdespues := c11.ctapres;

               BEGIN
                  SELECT s.ctipimp,
                            f_axis_literales (9002015, pcidioma)
                         || '='
                         || ff_desvalorfijo (402, pcidioma, s.ctipimp),
                         s.isaldo,
                            f_axis_literales (9001942, pcidioma)
                         || '='
                         || TO_CHAR (s.isaldo, 'FM9G999G999G990D00'),
                         s.porcen,
                            f_axis_literales (101467, pcidioma)
                         || '='
                         || TO_CHAR (s.porcen, 'FM990D00'),
                         s.ilimite,
                            f_axis_literales (108871, pcidioma)
                         || '='
                         || TO_CHAR (s.ilimite, 'FM9G999G999G990D00'),
                         s.icapmax,
                            f_axis_literales (105815, pcidioma)
                         || '='
                         || TO_CHAR (s.icapmax, 'FM9G999G999G990D00'),
                         s.icapaseg,
                            f_axis_literales (9002016, pcidioma)
                         || '='
                         || TO_CHAR (s.icapaseg, 'FM9G999G999G990D00')
                    INTO v_ctipimp,
                         v_dtipimp,
                         v_isaldo,
                         v_dsaldo,
                         v_porcen,
                         v_dporcen,
                         v_ilimite,
                         v_dlimite,
                         v_icapmax,
                         v_dcapmax,
                         v_icapaseg,
                         v_dcapaseg
                    FROM estprestamoseg s
                   WHERE s.sseguro = psseguro
                     AND s.nriesgo = c10.nriesgo
                     AND s.nmovimi = pnmovimi
                     AND s.ctapres = c11.ctapres;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     vdespues := '  ';
                     v_ctipimp := NULL;
                     v_isaldo := NULL;
                     v_porcen := NULL;
                     v_ilimite := NULL;
                     v_icapmax := NULL;
                     v_icapaseg := NULL;
               END;

               IF NVL (v_ctipimp, -1) <> NVL (c11.ctipimp, -1)
               THEN
                  IF v_ctipimp IS NOT NULL
                  THEN
                     vdespues :=
                              SUBSTR (vdespues || ', ' || v_dtipimp, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (9002015, pcidioma)
                             || '='
                             || ff_desvalorfijo (402, pcidioma, c11.ctipimp),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_isaldo, -1) <> NVL (c11.isaldo, -1)
               THEN
                  IF v_isaldo IS NOT NULL
                  THEN
                     vdespues :=
                               SUBSTR (vdespues || ', ' || v_dsaldo, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (9001942, pcidioma)
                             || '='
                             || TO_CHAR (c11.isaldo, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_porcen, -1) <> NVL (c11.porcen, -1)
               THEN
                  IF v_porcen IS NOT NULL
                  THEN
                     vdespues :=
                              SUBSTR (vdespues || ', ' || v_dporcen, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (101467, pcidioma)
                             || '='
                             || TO_CHAR (c11.porcen, 'FM990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_ilimite, -1) <> NVL (c11.ilimite, -1)
               THEN
                  IF v_ilimite IS NOT NULL
                  THEN
                     vdespues :=
                              SUBSTR (vdespues || ', ' || v_dlimite, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (108871, pcidioma)
                             || '='
                             || TO_CHAR (c11.ilimite, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_icapmax, -1) <> NVL (c11.icapmax, -1)
               THEN
                  IF v_icapmax IS NOT NULL
                  THEN
                     vdespues :=
                              SUBSTR (vdespues || ', ' || v_dcapmax, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (105815, pcidioma)
                             || '='
                             || TO_CHAR (c11.icapmax, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               IF NVL (v_icapaseg, -1) <> NVL (c11.icapaseg, -1)
               THEN
                  IF v_icapaseg IS NOT NULL
                  THEN
                     vdespues :=
                             SUBSTR (vdespues || ', ' || v_dcapaseg, 1, 2500);
                  END IF;

                  vantes :=
                     SUBSTR (   vantes
                             || ', '
                             || f_axis_literales (9002016, pcidioma)
                             || '='
                             || TO_CHAR (c11.icapaseg, 'FM9G999G999G990D00'),
                             1,
                             2500
                            );
               END IF;

               -- Ahora miramos si el detalle que vamos a escribir ya existe o no
               SELECT COUNT ('1')
                 INTO v_existe
                 FROM estdetmovseguro
                WHERE sseguro = psseguro
                  AND nmovimi = pnmovimi
                  AND cmotmov = pcmotmov
                  AND nriesgo = vnriesgo
                  AND cgarant = vcgarant
                  AND tvalora = vantes
                  AND tvalord = vdespues;

               IF v_existe = 0
               THEN
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcontador
                                    );
                  vcontador := vcontador - 1;
               END IF;
            END LOOP;
         END LOOP;

         -- BUG10569:DRA:31/08/2009:Fi
         -- BUG12421:DRA:27/01/2010:Inici
         FOR c10 IN (SELECT s.icapmax
                       FROM saldodeutorseg s
                      WHERE s.sseguro = pssegpol
                        AND s.nmovimi = (SELECT MAX (s1.nmovimi)
                                           FROM saldodeutorseg s1
                                          WHERE s1.sseguro = pssegpol)
                        AND NOT EXISTS (
                               SELECT 1
                                 FROM estsaldodeutorseg e
                                WHERE e.sseguro = psseguro
                                  AND e.nmovimi = pnmovimi
                                  AND NVL (e.icapmax, -1) = NVL (s.icapmax,
                                                                 -1)))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vnriesgo := 1;
            vcgarant := 0;

            BEGIN
               SELECT s.icapmax,
                         f_axis_literales (9002025, pcidioma)
                      || '='
                      || TO_CHAR (s.icapmax, 'FM9G999G999G990D00')
                 INTO v_icapmax,
                      v_dcapmax
                 FROM estsaldodeutorseg s
                WHERE s.sseguro = psseguro AND s.nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '  ';
                  v_icapmax := NULL;
            END;

            IF NVL (v_icapmax, -1) <> NVL (c10.icapmax, -1)
            THEN
               IF v_icapmax IS NOT NULL
               THEN
                  vdespues := SUBSTR (v_dcapmax, 1, 2500);
               END IF;

               vantes :=
                  SUBSTR (   f_axis_literales (9002025, pcidioma)
                          || '='
                          || TO_CHAR (c10.icapmax, 'FM9G999G999G990D00'),
                          1,
                          2500
                         );
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               0
                              );
         END LOOP;
      -- BUG12421:DRA:27/01/2010:Fi
      -- Bug 10908 - 28/08/2009 - JMF
      ELSIF pcmotmov = 687
      THEN
         -- Actualitzaci? de patrimoni
         vantes := NULL;
         vdespues := NULL;
         vnriesgo := 0;
         vcgarant := 0;
         num_err := f_despregunta (572, pcidioma, literal);

         SELECT MAX (p.crespue) despues, MAX (p.nriesgo) riesgo
           INTO vdespues, vnriesgo
           FROM estpregunseg p
          WHERE p.cpregun = 572
            AND p.sseguro = psseguro
            AND p.nmovimi = pnmovimi
            AND NOT EXISTS (
                   SELECT 1
                     FROM pregunseg ps
                    WHERE ps.sseguro = pssegpol
                      AND ps.nriesgo = p.nriesgo
                      AND ps.cpregun = 572
                      AND ps.nmovimi = (SELECT MAX (psg.nmovimi)
                                          FROM pregunseg psg
                                         WHERE psg.sseguro = pssegpol)
                      AND ps.crespue = p.crespue);

         SELECT MAX (ps.crespue) antes
           INTO vantes
           FROM pregunseg ps
          WHERE ps.sseguro = pssegpol
            AND ps.nriesgo = vnriesgo
            AND ps.cpregun = 572
            AND ps.nmovimi = (SELECT MAX (psg.nmovimi)
                                FROM pregunseg psg
                               WHERE psg.sseguro = pssegpol);

         IF vantes IS NOT NULL AND vdespues IS NOT NULL
         THEN
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               572
                              );
         END IF;
      -- FI Bug 10908 - 28/08/2009 - JMF
      -- Bug 16095 - 08/11/2010 - APD
      ELSIF pcmotmov = 330
      THEN
         -- Retencion por revision de salario
         vantes := NULL;
         vdespues := NULL;
         vnriesgo := 0;
         vcgarant := 0;

         SELECT creteni
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         SELECT creteni
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         IF vantes = 0 AND                               -- poliza NO retenida
                          vdespues = 1
         THEN
            -- poliza retenida
            literal := f_axis_literales (9901538, pcidioma);
            -- Retencion por revision de salario
            vantes := NULL;
            vdespues := literal;
         ELSIF vantes = 1 AND                               -- poliza retenida
                             vdespues = 0
         THEN
            -- poliza NO retenida
            literal := f_axis_literales (9901538, pcidioma);
            -- Retencion por revision de salario
            vantes := literal;
            vdespues := NULL;
         END IF;
      -- FI Bug 16095 - 08/11/2010 - APD
      -- Bug 16095 - 08/11/2010 - APD
      ELSIF pcmotmov IN (331)
      THEN
         -- Suplemento Renovacion Garantia
         v_crespue_a := NULL;
         v_crespue_d := NULL;

         FOR regs IN (SELECT TO_CHAR (d.fvencim, 'DD/MM/YYYY') v_crespue_d,
                             d.cgarant vcgarant, d.nriesgo vnriesgo
                        FROM estgaranseg g, estdetgaranseg d, estseguros s
                       WHERE s.sseguro = psseguro
                         AND g.sseguro = s.sseguro
                         AND g.cobliga = 1
                         AND g.sseguro = d.sseguro
                         AND g.nmovimi = d.nmovimi
                         AND g.nriesgo = d.nriesgo
                         AND g.cgarant = d.cgarant
                         AND d.ndetgar NOT IN (
                                SELECT ndetgar
                                  FROM garanseg g2, detgaranseg d2
                                 WHERE g2.sseguro = pssegpol
                                   AND g2.ffinefe IS NULL
                                   AND g2.sseguro = d2.sseguro
                                   AND g2.nmovimi = d2.nmovimi
                                   AND g2.cgarant = d2.cgarant
                                   AND g2.nriesgo = d2.nriesgo
                                   AND g2.cgarant = d.cgarant
                                   AND g2.nriesgo = d.nriesgo
                                   AND g2.nmovimi = d.nmovimi - 1)
                                                                  --AND d.cunica = 1) LOOP
                    )
         LOOP
            SELECT TO_CHAR (d.fvencim, 'DD/MM/YYYY'), d.cgarant, d.nriesgo
              INTO v_crespue_a, vcgarant, vnriesgo
              FROM estdetgaranseg d
             WHERE d.sseguro = pssegpol
               AND d.ndetgar NOT IN (
                      SELECT ndetgar
                        FROM garanseg g2, detgaranseg d2
                       WHERE g2.sseguro = pssegpol
                         AND g2.ffinefe IS NULL
                         AND g2.sseguro = d2.sseguro
                         AND g2.nmovimi = d2.nmovimi
                         AND g2.cgarant = d2.cgarant
                         AND g2.nriesgo = d2.nriesgo
                         AND g2.cgarant = d.cgarant
                         AND g2.nriesgo = d.nriesgo
                         AND g2.nmovimi = d.nmovimi - 1);

            --AND d.cunica = 1
            literal := f_axis_literales (120453, pcidioma);
            -- Fecha de vencimiento:
            vantes :=
                  literal
               || ' ('
               || ff_desgarantia (vcgarant, pcidioma)
               || '): '
               || v_crespue_a;
            vdespues :=
                  literal
               || ' ('
               || ff_desgarantia (regs.vcgarant, pcidioma)
               || '): '
               || regs.v_crespue_d;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               regs.vnriesgo,
                               regs.vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- FI Bug 16095 - 08/11/2010 - APD

      -- ini Bug 0016856 - 21/12/2010 - JMF
      ELSIF pcmotmov = 690
      THEN
         -- Actualitzaci? de patrimoni
         vantes := NULL;
         vdespues := NULL;
         vnriesgo := 0;
         vcgarant := 0;
         literal := f_axis_literales (9901735, pcidioma);

         -- Comprobar si existe interficie act.capital, pendiente actualizar en cartera.
         SELECT MAX (1)
           INTO vdespues
           FROM estseguros a, estgaranseg b, int_prestamos e
          WHERE a.sseguro = psseguro
            AND b.sseguro = a.sseguro
            AND b.nmovimi = (SELECT MAX (b1.nmovimi)
                               FROM estgaranseg b1
                              WHERE b1.sseguro = b.sseguro)
            AND NVL (b.icapital, 0) > 0
            AND e.npoliza = a.npoliza
            AND e.fmovimi = b.finiefe;

         IF vdespues = 1
         THEN
            SELECT MAX (d.icapital) antes, MAX (b.icapital) despues
              INTO vantes, vdespues
              FROM estseguros a, estgaranseg b, garanseg d
             WHERE a.sseguro = psseguro
               AND b.sseguro = a.sseguro
               AND b.nmovimi = (SELECT MAX (b1.nmovimi)
                                  FROM estgaranseg b1
                                 WHERE b1.sseguro = b.sseguro)
               AND d.sseguro = pssegpol
               AND d.nmovimi = (SELECT MAX (d1.nmovimi)
                                  FROM garanseg d1
                                 WHERE d1.sseguro = d.sseguro)
               AND d.nriesgo = b.nriesgo
               AND d.cgarant = b.cgarant
               AND EXISTS (
                      SELECT 1
                        FROM int_prestamos e
                       WHERE e.npoliza = a.npoliza
                         AND e.fmovimi = b.finiefe
                         AND NOT EXISTS (
                                SELECT 1
                                  FROM int_carga_ctrl_linea f
                                 WHERE f.sproces = e.sinterf
                                   AND f.nlinea = e.nlinea
                                   AND f.cestado IN (1, 3)))
               AND NVL (b.icapital, 0) <> NVL (d.icapital, 0);

            IF vantes IS NOT NULL OR vdespues IS NOT NULL
            THEN
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  NULL
                                 );
            END IF;
         END IF;
      -- fin Bug 0016856 - 21/12/2010 - JMF

      -- ini Bug 0016544 - 27/12/2010 - JMF
      ELSIF pcmotmov = 209
      THEN
         -- Canvi de naturalesa del risc
         vantes := NULL;
         vdespues := NULL;
         vnriesgo := 0;
         vcgarant := 0;
         literal := f_axis_literales (102524, pcidioma);

         DECLARE
            CURSOR c9
            IS
               SELECT a.nriesgo,
                         literal
                      || ': '
                      || a.tnatrie
                      || DBMS_LOB.SUBSTR (a.tdescrie) antes,
                         literal
                      || ': '
                      || b.tnatrie
                      || DBMS_LOB.SUBSTR (b.tdescrie) despues
                 FROM riesgos a, estriesgos b
                WHERE a.sseguro = pssegpol
                  AND b.sseguro = psseguro
                  AND a.nriesgo = b.nriesgo
                  AND NVL (a.tnatrie || DBMS_LOB.SUBSTR (a.tdescrie), 'x') <>
                          NVL (b.tnatrie || DBMS_LOB.SUBSTR (b.tdescrie), 'x');
         BEGIN
            FOR f9 IN c9
            LOOP
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  f9.nriesgo,
                                  vcgarant,
                                  f9.antes,
                                  f9.despues,
                                  NULL
                                 );
            END LOOP;
         END;
      -- BUG 17341 - 24/01/2011 - JMP - Anadimos el motivo 691
      ELSIF pcmotmov = 691
      THEN
         FOR c IN c_pregun_riesgo_real
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vdespues
                 FROM estpregunseg p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN c_pregun_riesgo_est
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vantes
                 FROM pregunseg p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunseg
                                    WHERE sseguro = pssegpol)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := ' ';                                      --NULL;
            END;

            vdespues := c.despues;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN c_preguntab_riesgo_real
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                 INTO vdespues
                 FROM estpregunsegtab p, codipregun cp
                WHERE p.sseguro = psseguro
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = pnmovimi
                  AND cp.cpregun = p.cpregun;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := ' ';                                    --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            --p_recuperadescripcrespue(psproduc, c.cpregun, vantes, vdespues, pcidioma);
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            --vantes := literal || ': ' || vantes;
            --vdespues := literal || ': ' || vdespues;

            /*IF literal2 IS NOT NULL THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;*/
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN c_preguntab_riesgo_est
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (p.ccolumna, 2, p.tvalor, 3, p.fvalor, p.nvalor)
                 INTO vantes
                 FROM pregunsegtab p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunsegtab
                                    WHERE sseguro = pssegpol)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := ' ';                                      --NULL;
            END;

            vdespues := c.despues;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         /* Recuperar los cambios en las preguntas de garantias*/
         FOR c IN (SELECT DECODE (cp.ctippre,
                                  4, p.trespue,     -- BUG10985:DRA:26/08/2009
                                  5, p.trespue,
                                  p.crespue
                                 ) antes,
                          p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                     FROM pregungaranseg p,
                          pregunprogaran e,
                          seguros s,
                          codipregun cp
                    WHERE p.cpregun = e.cpregun
                      AND p.sseguro = s.sseguro
                      AND s.sseguro = pssegpol
                      AND p.cgarant = e.cgarant
                      AND e.sproduc = psproduc
                      AND e.cpretip <> 2
                      AND cp.cpregun = p.cpregun     -- BUG9988:DRA:30/04/2009
                      AND NOT EXISTS (
                             SELECT ep.cpregun
                               FROM estpregungaranseg ep
                              WHERE ep.sseguro = psseguro
                                AND ep.nmovimi = pnmovimi
                                AND ep.nriesgo = p.nriesgo
                                AND ep.cgarant = p.cgarant
                                AND ep.cpregun = p.cpregun
                                AND DECODE (cp.ctippre,
                                            4, NVL (ep.trespue, '**'),
                                            -- BUG10985:DRA:26/08/2009
                                            5, NVL (ep.trespue, '**'),
                                            TO_CHAR (ep.crespue)
                                           ) =
                                       DECODE (cp.ctippre,
                                               4, NVL (p.trespue, '**'),
                                               -- BUG10985:DRA:26/08/2009
                                               5, NVL (p.trespue, '**'),
                                               TO_CHAR (p.crespue)
                                              )))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, ep.trespue,        -- BUG10985:DRA:26/08/2009
                              5, ep.trespue,
                              ep.crespue
                             )
                 INTO vdespues
                 FROM estpregungaranseg ep, codipregun cp
                WHERE ep.sseguro = psseguro
                  AND ep.nriesgo = c.nriesgo
                  AND ep.cgarant = c.cgarant        -- BUG14172:DRA:19/04/2010
                  AND ep.cpregun = c.cpregun
                  AND ep.nmovimi = pnmovimi
                  AND cp.cpregun = ep.cpregun;       -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '';                                     --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN (SELECT DECODE (p.ccolumna,
                                  2, p.tvalor,
                                  3, p.fvalor,
                                  p.nvalor
                                 ) antes,
                          p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
                     FROM pregungaransegtab p,
                          pregunprogaran e,
                          seguros s,
                          codipregun cp
                    WHERE p.cpregun = e.cpregun
                      AND p.sseguro = s.sseguro
                      AND s.sseguro = pssegpol
                      AND p.cgarant = e.cgarant
                      AND e.sproduc = psproduc
                      AND e.cpretip <> 2
                      AND cp.cpregun = p.cpregun
                      AND NOT EXISTS (
                             SELECT ep.cpregun
                               FROM estpregungaransegtab ep
                              WHERE ep.sseguro = psseguro
                                AND ep.nmovimi = pnmovimi
                                AND ep.nriesgo = p.nriesgo
                                AND ep.cgarant = p.cgarant
                                AND ep.cpregun = p.cpregun
                                AND DECODE (p.ccolumna,
                                            2, NVL (ep.tvalor, '**'),
                                            3, NVL (ep.fvalor, '**'),
                                            TO_CHAR (ep.nvalor)
                                           ) =
                                       DECODE (p.ccolumna,
                                               2, NVL (p.tvalor, '**'),
                                               3, NVL (p.fvalor, '**'),
                                               TO_CHAR (p.nvalor)
                                              )))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (ep.ccolumna,
                              2, ep.tvalor,
                              3, ep.fvalor,
                              ep.nvalor
                             )
                 INTO vdespues
                 FROM estpregungaransegtab ep, codipregun cp
                WHERE ep.sseguro = psseguro
                  AND ep.nriesgo = c.nriesgo
                  AND ep.cgarant = c.cgarant
                  AND ep.cpregun = c.cpregun
                  AND ep.nmovimi = pnmovimi
                  AND cp.cpregun = ep.cpregun;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '';                                     --NULL;
            END;

            vantes := c.antes;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;
      ELSIF pcmotmov = 680
      THEN
         -- Modificacion de preguntas de garantias
         /* Recuperar los cambios en las preguntas de garantias*/
         --BUG 24657: XVM :24/10/2012--Inicio
         FOR c IN
            (SELECT DECODE (cp.ctippre,
                            4, p.trespue,           -- BUG10985:DRA:26/08/2009
                            5, p.trespue,
                            p.crespue
                           ) antes,
                    p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
               FROM pregungaranseg p,
                    pregunprogaran e,
                    seguros s,
                    codipregun cp
              WHERE p.cpregun = e.cpregun
                AND p.sseguro = s.sseguro
                AND s.sseguro = pssegpol
                AND p.cgarant = e.cgarant
                AND e.sproduc = psproduc
                AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                    )                                --BUG23860:DCT:26/10/2012
                AND cp.cpregun = p.cpregun           -- BUG9988:DRA:30/04/2009
                AND p.nmovimi =
                       (SELECT MAX (p1.nmovimi)
                          -- BUG14172:DRA:19/04/2010
                        FROM   pregungaranseg p1
                         WHERE p1.sseguro = pssegpol
                           AND p1.nriesgo = p.nriesgo
                           AND p1.cgarant = p.cgarant
                           AND p1.cpregun = p.cpregun)
                AND NOT EXISTS (
                       SELECT ep.cpregun
                         FROM estpregungaranseg ep
                        WHERE ep.sseguro = psseguro
                          AND ep.sseguro = p.sseguro
                          AND ep.nmovimi = pnmovimi
                          AND ep.nriesgo = p.nriesgo
                          AND ep.cgarant = p.cgarant
                          AND ep.cpregun = p.cpregun
                          AND DECODE (cp.ctippre,
                                      4, NVL (ep.trespue, '**'),
                                      -- BUG10985:DRA:26/08/2009
                                      5, NVL (ep.trespue, '**'),
                                      TO_CHAR (ep.crespue)
                                     ) =
                                 DECODE (cp.ctippre,
                                         4, NVL (p.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (p.trespue, '**'),
                                         TO_CHAR (p.crespue)
                                        )))
         LOOP
            vantes := '--';
            vdespues := '--';
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, ep.trespue,        -- BUG10985:DRA:26/08/2009
                              5, ep.trespue,
                              ep.crespue
                             )
                 INTO vdespues
                 FROM estpregungaranseg ep, codipregun cp
                WHERE ep.sseguro = psseguro
                  AND ep.nriesgo = c.nriesgo
                  AND ep.cgarant = c.cgarant        -- BUG14172:DRA:19/04/2010
                  AND ep.cpregun = c.cpregun
                  AND ep.nmovimi = pnmovimi
                  AND cp.cpregun = ep.cpregun;       -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';                                   --NULL;
            END;

            vantes := c.antes;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         FOR c IN
            (SELECT DECODE (cp.ctippre,
                            4, p.trespue,           -- BUG10985:DRA:26/08/2009
                            5, p.trespue,
                            p.crespue
                           ) despues,
                    p.cpregun, p.nriesgo, p.nmovimi, p.cgarant
               FROM estpregungaranseg p,
                    pregunprogaran e,
                    estseguros s,
                    codipregun cp,
                    estgaranseg g
              WHERE s.sseguro = psseguro
                AND g.sseguro = s.sseguro           -- BUG11737:DRA:25/01/2010
                AND g.nmovimi = pnmovimi            -- BUG11737:DRA:25/01/2010
                AND g.cobliga = 1                   -- BUG11737:DRA:25/01/2010
                AND p.sseguro = g.sseguro
                AND p.nriesgo = g.nriesgo
                AND p.cgarant = g.cgarant
                AND p.nmovimi = g.nmovimi
                AND e.cpregun = p.cpregun
                AND e.cgarant = p.cgarant
                AND e.sproduc = psproduc
                AND ((e.cpretip <> 2) OR (e.cpretip = 2 AND e.esccero = 1)
                    )                                --BUG23860:DCT:26/10/2012
                AND cp.cpregun = p.cpregun           -- BUG9988:DRA:30/04/2009
                AND NOT EXISTS (
                       SELECT ep.cpregun
                         FROM pregungaranseg ep
                        WHERE ep.sseguro = pssegpol
                          AND ep.sseguro = p.sseguro
                          AND ep.nriesgo = p.nriesgo
                          AND ep.cgarant = p.cgarant
                          AND ep.cpregun = p.cpregun
                          AND p.nmovimi =
                                 (SELECT MAX (p1.nmovimi)
                                    -- BUG14172:DRA:19/04/2010
                                  FROM   pregungaranseg p1
                                   WHERE p1.sseguro = pssegpol
                                     AND p1.nriesgo = p.nriesgo
                                     AND p1.cgarant = p.cgarant
                                     AND p1.cpregun = p.cpregun)
                          AND DECODE (cp.ctippre,
                                      4, NVL (ep.trespue, '**'),
                                      -- BUG10985:DRA:26/08/2009
                                      5, NVL (ep.trespue, '**'),
                                      TO_CHAR (ep.crespue)
                                     ) =
                                 DECODE (cp.ctippre,
                                         4, NVL (p.trespue, '**'),
                                         -- BUG10985:DRA:26/08/2009
                                         5, NVL (p.trespue, '**'),
                                         TO_CHAR (p.crespue)
                                        )))
         LOOP
            vantes := '--';
            vdespues := '--';
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (cp.ctippre,
                              4, p.trespue,         -- BUG10985:DRA:26/08/2009
                              5, p.trespue,
                              p.crespue
                             )
                 INTO vantes
                 FROM pregungaranseg p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.cgarant = c.cgarant         -- BUG14172:DRA:19/04/2010
                  AND p.nmovimi =
                         (SELECT MAX (p1.nmovimi)
                            -- BUG14172:DRA:19/04/2010
                          FROM   pregungaranseg p1
                           WHERE p1.sseguro = pssegpol
                             AND p1.nriesgo = c.nriesgo
                             AND p1.cgarant = c.cgarant
                             AND p1.cpregun = c.cpregun)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';                                   --NULL;
            END;

            vdespues := c.despues;
            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            -- BUG26501 - 21/01/2014 - JTT: S'afegeix el sseguro
            p_recuperadescripcrespue (psproduc,
                                      c.cpregun,
                                      vantes,
                                      vdespues,
                                      pcidioma,
                                      psseguro
                                     );
            -- Nom?s en el cas que sigui amb llista de valors
            -- BUG12590:07/01/2010:DRA:Fi
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || c.nriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || c.nriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               c.cpregun
                              );
         END LOOP;

         vantes2 := NULL;
         vdespues2 := NULL;

         FOR c IN (SELECT DISTINCT DECODE (c.ctipcol,
                                           2, p.tvalor,
                                           1, p.nvalor,
                                           p.fvalor
                                          ) antes,
                                   p.cpregun, p.nriesgo, p.nmovimi, p.cgarant,
                                   c.ctipcol, p.ccolumna, p.nlinea
                              FROM pregungaransegtab p,
                                   pregunprogaran e,
                                   seguros s,
                                   codipregun cp,
                                   preguntab_colum c
                             WHERE p.cpregun = e.cpregun
                               AND p.sseguro = s.sseguro
                               AND s.sseguro = pssegpol
                               AND p.cgarant = e.cgarant
                               AND e.sproduc = psproduc
                               AND (   (e.cpretip <> 2)
                                    OR (e.cpretip = 2 AND e.esccero = 1)
                                   )                 --BUG23860:DCT:26/10/2012
                               AND cp.cpregun = p.cpregun
                               AND cp.cpregun = c.cpregun
                               AND p.ccolumna = c.ccolumn
                               AND p.nmovimi =
                                      (SELECT MAX (p1.nmovimi)
                                         -- BUG14172:DRA:19/04/2010
                                       FROM   pregungaransegtab p1
                                        WHERE p1.sseguro = pssegpol
                                          AND p1.nriesgo = p.nriesgo
                                          AND p1.cgarant = p.cgarant
                                          AND p1.cpregun = p.cpregun)
                               AND NOT EXISTS (
                                      SELECT ep.cpregun
                                        FROM estpregungaransegtab ep,
                                             preguntab_colum c
                                       WHERE ep.sseguro = psseguro
                                         AND ep.sseguro = p.sseguro
                                         AND ep.nmovimi = pnmovimi
                                         AND ep.nriesgo = p.nriesgo
                                         AND ep.cgarant = p.cgarant
                                         AND ep.cpregun = p.cpregun
                                         AND ep.ccolumna = p.ccolumna
                                         AND ep.nlinea = p.nlinea
                                         AND ep.cpregun = c.cpregun
                                         AND ep.ccolumna = c.ccolumn
                                         AND DECODE (c.ctipcol,
                                                     2, NVL (ep.tvalor, '**'),
                                                     1, TO_CHAR (ep.nvalor),
                                                     NVL (ep.fvalor, '**')
                                                    ) =
                                                DECODE (c.ctipcol,
                                                        2, NVL (ep.tvalor,
                                                                '**'
                                                               ),
                                                        1, TO_CHAR (ep.nvalor),
                                                        NVL (ep.fvalor, '**')
                                                       ))
                          ORDER BY p.ccolumna)
         LOOP                                                           --CJMR
            vantes := '--';
            vdespues := '--';
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (c.ctipcol,
                              2, ep.tvalor,
                              1, ep.nvalor,
                              ep.fvalor
                             )
                 INTO vdespues
                 FROM estpregungaransegtab ep, codipregun cp
                WHERE ep.sseguro = psseguro
                  AND ep.nriesgo = c.nriesgo
                  AND ep.cgarant = c.cgarant
                  AND ep.cpregun = c.cpregun
                  AND ep.ccolumna = c.ccolumna
                  AND ep.nmovimi = pnmovimi
                  AND cp.cpregun = ep.cpregun
                  AND ep.ccolumna = c.ccolumna
                  AND ep.nlinea = c.nlinea;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';                                   --NULL;
            END;

            vantes := c.antes;

            SELECT f_axis_literales (slitera, pcidioma)
              INTO literal2
              FROM preguntab_colum
             WHERE cpregun = c.cpregun AND ctipcol = c.ctipcol;

            vantes2 :=
                   NVL (vantes2, literal) || ' - ' || literal2 || ':'
                   || vantes;
            vdespues2 :=
               NVL (vdespues2, literal) || ' - ' || literal2 || ':'
               || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes2,
                               vdespues2,
                               c.cpregun
                              );
         END LOOP;

         vantes2 := NULL;
         vdespues2 := NULL;

         FOR c IN (SELECT DISTINCT DECODE (c.ctipcol,
                                           2, p.tvalor,
                                           1, p.nvalor,
                                           p.fvalor
                                          ) despues,
                                   p.cpregun, p.nriesgo, p.nmovimi, p.cgarant,
                                   c.ctipcol, p.ccolumna, p.nlinea
                              FROM estpregungaransegtab p,
                                   pregunprogaran e,
                                   estseguros s,
                                   preguntab_colum c,
                                   codipregun cp,
                                   estgaranseg g
                             WHERE s.sseguro = psseguro
                               AND g.sseguro = s.sseguro
                               AND g.nmovimi = pnmovimi
                               AND g.cobliga = 1    -- BUG11737:DRA:25/01/2010
                               AND p.sseguro = g.sseguro
                               AND p.nriesgo = g.nriesgo
                               AND p.cgarant = g.cgarant
                               AND p.nmovimi = g.nmovimi
                               AND e.cpregun = p.cpregun
                               AND e.cgarant = p.cgarant
                               AND e.sproduc = psproduc
                               AND (   (e.cpretip <> 2)
                                    OR (e.cpretip = 2 AND e.esccero = 1)
                                   )                 --BUG23860:DCT:26/10/2012
                               AND cp.cpregun = p.cpregun
                               AND cp.cpregun = c.cpregun
                               AND p.ccolumna = c.ccolumn
                               AND NOT EXISTS (
                                      SELECT ep.cpregun
                                        FROM pregungaransegtab ep,
                                             preguntab_colum c
                                       WHERE ep.sseguro = pssegpol
                                         AND ep.sseguro = p.sseguro
                                         AND ep.nriesgo = p.nriesgo
                                         AND ep.cgarant = p.cgarant
                                         AND ep.cpregun = p.cpregun
                                         AND ep.ccolumna = p.ccolumna
                                         AND ep.nlinea = p.nlinea
                                         AND ep.cpregun = c.cpregun
                                         AND ep.ccolumna = c.ccolumn
                                         AND ep.nmovimi =
                                                (SELECT MAX (p1.nmovimi)
                                                   -- BUG14172:DRA:19/04/2010
                                                 FROM   pregungaransegtab p1
                                                  WHERE p1.sseguro = pssegpol
                                                    AND p1.nriesgo = p.nriesgo
                                                    AND p1.cgarant = p.cgarant
                                                    AND p1.cpregun = p.cpregun)
                                         AND DECODE (p.ccolumna,
                                                     2, NVL (ep.tvalor, '**'),
                                                     1, TO_CHAR (ep.nvalor),
                                                     NVL (ep.fvalor, '**')
                                                    ) =
                                                DECODE (p.ccolumna,
                                                        2, NVL (p.tvalor,
                                                                '**'),
                                                        1, TO_CHAR (p.nvalor),
                                                        NVL (p.fvalor, '**')
                                                       ))
                          ORDER BY p.ccolumna)
         LOOP                                                           --CJMR
            vantes := '--';
            vdespues := '--';
            num_err := f_despregunta (c.cpregun, pcidioma, literal);

            BEGIN
               SELECT DECODE (c.ctipcol, 2, p.tvalor, 1, p.nvalor, p.fvalor)
                 INTO vantes
                 FROM pregungaransegtab p, codipregun cp
                WHERE p.sseguro = pssegpol
                  AND p.nriesgo = c.nriesgo
                  AND p.cpregun = c.cpregun
                  AND p.cgarant = c.cgarant         -- BUG14172:DRA:19/04/2010
                  AND p.ccolumna = c.ccolumna
                  AND p.nlinea = c.nlinea
                  AND p.nmovimi =
                         (SELECT MAX (p1.nmovimi)
                            -- BUG14172:DRA:19/04/2010
                          FROM   pregungaransegtab p1
                           WHERE p1.sseguro = pssegpol
                             AND p1.nriesgo = c.nriesgo
                             AND p1.cgarant = c.cgarant
                             AND p1.cpregun = c.cpregun)
                  AND cp.cpregun = p.cpregun;        -- BUG9988:DRA:30/04/2009
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';                                     --NULL;
            END;

            vdespues := c.despues;

            -- BUG12590:07/01/2010:DRA:Inici: S'afegeix el sproduc
            SELECT f_axis_literales (slitera, pcidioma)
              INTO literal2
              FROM preguntab_colum
             WHERE cpregun = c.cpregun
               AND ccolumn = c.ccolumna
               AND ctipcol = c.ctipcol;

            vantes2 :=
                   NVL (vantes2, literal) || ' - ' || literal2 || ':'
                   || vantes;
            vdespues2 :=
               NVL (vdespues2, literal) || ' - ' || literal2 || ':'
               || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes2,
                               vdespues2,
                               c.cpregun
                              );
         END LOOP;
      --BUG 24657: XVM :24/10/2012--FIN
      -- FIN BUG 17341 - 24/01/2011 - JMP
      -- fin Bug 0016544 - 27/12/2010 - JMF
      ------------- ELSIFOS --------------------
      ELSIF pcmotmov IN (400, 401)
      THEN
         SELECT nriesgo, cgarant, NULL, tvalor, cpregun
           INTO vnriesgo, vcgarant, vantes, vdespues, vcpregun
           FROM est_supdesc
          WHERE sseguro = psseguro AND nmovimi = pnmovimi
                AND cmotmov = pcmotmov;

         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            vnriesgo,
                            vcgarant,
                            vantes,
                            vdespues,
                            vcpregun
                           );
      -- BUG17255:DRA:18/07/2011:Inici
      ELSIF pcmotmov = 937
      THEN
         SELECT TO_CHAR (s.fefecto, 'DD/MM/YYYY')
           INTO vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT TO_CHAR (s.fefecto, 'DD/MM/YYYY')
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (112475, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      -- BUG17255:DRA:18/07/2011:Fi
      -- BUG19069:DRA:29/09/2011:Inici
      ELSIF pcmotmov = 825
      THEN
         vcpregun := 0;

         FOR ctj IN
            (SELECT c.cagente cagente_ori, e.cagente cagente_des
               FROM age_corretaje c, estage_corretaje e
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM pregunpolseg /*age_corretaje*/ c1
                                  WHERE c1.sseguro = c.sseguro)
                AND e.sseguro = psseguro
                AND e.nmovimi = pnmovimi
                AND c.nordage = e.nordage
                AND (   c.cagente <> e.cagente
                     OR NVL (c.ppartici, -1) <> NVL (e.ppartici, -1)
                     --OR NVL(c.pcomisi, -1) <> NVL(e.pcomisi, -1)  -- BUG22402:DRA:10/07/2012
                     OR NVL (c.islider, -1) <> NVL (e.islider, -1)
                    )
             UNION
             SELECT c.cagente cagente_ori, NULL cagente_des
               FROM age_corretaje c
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM pregunpolseg /*age_corretaje*/ c1
                                  WHERE c1.sseguro = c.sseguro)
                AND NOT EXISTS (
                       SELECT 1
                         FROM estage_corretaje e
                        WHERE e.sseguro = psseguro
                          AND e.nmovimi = pnmovimi
                          AND e.nordage = c.nordage)
             UNION
             SELECT NULL cagente_ori, e.cagente cagente_des
               FROM estage_corretaje e
              WHERE e.sseguro = psseguro
                AND e.nmovimi = pnmovimi
                AND NOT EXISTS (
                       SELECT 1
                         FROM age_corretaje c
                        WHERE c.sseguro = pssegpol
                          AND c.nmovimi =
                                      (SELECT MAX (c1.nmovimi)
                                         FROM pregunpolseg /*age_corretaje*/ c1
                                        WHERE c1.sseguro = c.sseguro)
                          AND c.nordage = e.nordage))
         LOOP
            BEGIN
               -- Bug 27539/149064 - APD - 24/07/2013 - el MAX nmovimi se debe buscar
               -- de pregunpolseg
               SELECT    c.cagente
                      || ' - '
                      || f_axis_literales (104818, pcidioma)
                      || ': '
                      || c.ppartici
                      -- || ' - ' || f_axis_literales(9001923, pcidioma) || ': ' || c.pcomisi -- BUG22402:DRA:10/07/2012
                      || ' - '
                      || f_axis_literales (9902425, pcidioma)
                      || ': '
                      || ff_desvalorfijo (9, pcidioma, c.islider)
                 INTO vantes
                 FROM age_corretaje c
                WHERE c.sseguro = pssegpol
                  AND c.cagente = ctj.cagente_ori
                  AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                     FROM pregunpolseg /*age_corretaje*/ c1
                                    WHERE c1.sseguro = c.sseguro);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
            END;

            BEGIN
               SELECT    c.cagente
                      || ' - '
                      || f_axis_literales (104818, pcidioma)
                      || ': '
                      || c.ppartici
                      -- || ' - ' || f_axis_literales(9001923, pcidioma) || ': ' || c.pcomisi  -- BUG22402:DRA:10/07/2012
                      || ' - '
                      || f_axis_literales (9902425, pcidioma)
                      || ': '
                      || ff_desvalorfijo (9, pcidioma, c.islider)
                 INTO vdespues
                 FROM estage_corretaje c
                WHERE c.sseguro = psseguro
                  AND c.cagente = ctj.cagente_des
                  AND c.nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
            END;

            literal := f_axis_literales (100584, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := 1;
            vcgarant := 0;
            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- BUG19069:DRA:29/09/2011:Fi

      -- ini Bug 0025862 - 28/01/2013 - JMF afegir 827
      ELSIF pcmotmov = 827
      THEN
         vcpregun := 0;

         -- Bug 27539/149064 - APD - 24/07/2013 - el MAX nmovimi se debe buscar
         -- de pregunpolseg
         FOR f1 IN
            (SELECT a.sperson ori, c.sperson des
               FROM rtn_convenio a, estrtn_convenio c
              WHERE a.sseguro = pssegpol
                AND a.nmovimi = (SELECT MAX (nmovimi)
                                   FROM pregunpolseg /*rtn_convenio*/ b
                                  WHERE b.sseguro = a.sseguro)
                AND c.sseguro = psseguro
                AND a.sperson = pac_persona.f_sperson_spereal (c.sperson)
                AND a.pretorno <> c.pretorno
             UNION
             SELECT a.sperson ori, NULL des
               FROM rtn_convenio a
              WHERE a.sseguro = pssegpol
                AND a.nmovimi = (SELECT MAX (nmovimi)
                                   FROM pregunpolseg /*rtn_convenio*/ b
                                  WHERE b.sseguro = a.sseguro)
                AND NOT EXISTS (
                       SELECT 1
                         FROM estrtn_convenio c
                        WHERE c.sseguro = psseguro
                          AND pac_persona.f_sperson_spereal (c.sperson) =
                                                                     a.sperson)
             UNION
             SELECT NULL ori, c.sperson des
               FROM estrtn_convenio c
              WHERE c.sseguro = psseguro
                AND NOT EXISTS (
                       SELECT 1
                         FROM rtn_convenio a
                        WHERE a.sseguro = pssegpol
                          AND a.nmovimi =
                                        (SELECT MAX (nmovimi)
                                           FROM pregunpolseg /*rtn_convenio*/ b
                                          WHERE b.sseguro = a.sseguro)
                          AND a.sperson =
                                     pac_persona.f_sperson_spereal (c.sperson)))
         LOOP
            BEGIN
               vantes := NULL;

               -- Bug 27539/149064 - APD - 24/07/2013 - el MAX nmovimi se debe buscar
               -- de pregunpolseg
               SELECT f_axis_literales (101467, pcidioma) || ' ' || a.pretorno
                 INTO vantes
                 FROM rtn_convenio a
                WHERE a.sseguro = pssegpol
                  AND a.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunpolseg /*rtn_convenio*/ b
                                    WHERE b.sseguro = a.sseguro)
                  AND a.sperson = f1.ori;

               BEGIN
                  SELECT *
                    INTO pers_reg
                    FROM personas
                   WHERE sperson = f1.ori;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     pers_reg.tnombre := NULL;
                     pers_reg.tapelli := NULL;
               END;

               vantes :=
                  pers_reg.tnombre || ' ' || pers_reg.tapelli || ' ' || vantes;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := '--';
            END;

            BEGIN
               vdespues := NULL;

               SELECT f_axis_literales (101467, pcidioma) || ' ' || c.pretorno
                 INTO vdespues
                 FROM estrtn_convenio c
                WHERE c.sseguro = psseguro AND sperson = f1.des;

               BEGIN
                  SELECT *
                    INTO pers_reg2
                    FROM estpersonas
                   WHERE sperson = f1.des;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     pers_reg2.tnombre := NULL;
                     pers_reg2.tapelli := NULL;
               END;

               vdespues :=
                  pers_reg2.tnombre || ' ' || pers_reg2.tapelli || ' '
                  || vdespues;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := '--';
            END;

            vnriesgo := 1;
            vcgarant := 0;
            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- fin Bug 0025862 - 28/01/2013 - JMF afegir 827
      ELSIF pcmotmov IN (692, 694, 697, 698, 794)
      THEN
         vnriesgo := 1;
         vcgarant := 0;
         vnorden := 1;

         FOR c IN clausula_bene
         LOOP
            v_borrado := 0;
            vantes := NULL;

            IF c.tipomov = 'E'
            THEN
               BEGIN
                  SELECT cgarant, sperson_tit, finiben, ffinben,
                         ctipben, cparen, pparticip, nriesgo, cestado
                    INTO vcgarant, v_sperson_tit, vffinbe, v_ffinben,
                         vctipben, vcparen, vpparticip, vnriesgo, vcestado
                    FROM benespseg
                   WHERE sseguro = pssegpol
                     AND sperson =
                            NVL (pac_persona.f_sperson_spereal (c.sperson),
                                 c.sperson
                                )
                     AND nmovimi = (SELECT MAX (nmovimi)
                                      FROM benespseg
                                     WHERE sseguro = pssegpol);
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     -- es nuevo.
                     --beneficiario
                     --INICIO BUG 27539_151566 - DCT - 28/08/2013
                     literal := f_axis_literales (9905938, pcidioma);
                             --literal := f_axis_literales(109309, pcidioma);
                     --FIN BUG 27539_151566 - DCT - 28/08/2013
                     --vantes := literal || ' ' || f_axis_literales(1000134, pcidioma);   -- no existe
                     vdespues :=
                          literal || ' ' || f_nombre_est (c.sperson, 1, NULL);
                     -------added by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     vantes := f_axis_literales (89906328, pcidioma);
                                                       ---benficiario anadido
                     -------ended by rohit for iaxis 4320 benficiario anadido and Beneficiario a¿adido

                     --- Vantes :=lliteral;
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes || ': --',
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                     -------added by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     vantes := NULL;

                     -------added by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido

                     -- garantia
                     IF c.cgarant <> 0
                     THEN
                        literal := f_axis_literales (100561, pcidioma);
                        --garantia
                        -- vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(1000134, pcidioma);   -- no existe
                        vdespues :=
                              f_nombre_est (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desgarantia (c.cgarant, pcidioma);
                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vnorden
                                          );
                        vnorden := vnorden + 1;
                     END IF;

                     -- tipo de beneficiario
                     literal := f_axis_literales (9901522, pcidioma);
                     --tipo beneficiario
                     -- vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(1000134, pcidioma);   -- no existe
                     vdespues :=
                           f_nombre_est (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        -- Ini Bug 27304 - MDS - 30/08/2013
                        --|| ff_desvalorfijo(1053, pcidioma, c.ctipben);
                        || ff_desvalorfijo (vsliteral, pcidioma, c.ctipben);
                        -- Fin Bug 27304 - MDS - 30/08/2013
                     -------added by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     vantes :=
                              f_axis_literales (89906329, pcidioma)
                              || g_vantes;       ---benficiario anulado  added
                     -------ended by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
-------added by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     vantes := NULL;                                  ---added

-------ended by rohit for iaxis 4320 addition of benficiario anadido and Beneficiario a¿adido
                     --benefeciario CONTINGENCIA
                     IF c.ctipben = 3
                     THEN
                        literal := f_axis_literales (9902661, pcidioma);

                        --benef.  continge

                        --vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(1000134, pcidioma);   -- no existe
                        IF pac_persona.f_sperson_spereal (c.sperson_tit) IS NULL
                        THEN
                           --Si no existe en las reales :
                           vdespues :=
                                 f_nombre_est (c.sperson, 1, NULL)
                              || ' : '
                              || literal
                              || ' '
                              || f_nombre_est (NVL (c.sperson_tit, 0), 1,
                                               NULL);
                        ELSE
                           vdespues :=
                                 f_nombre_est (c.sperson, 1, NULL)
                              || ' : '
                              || literal
                              || ' '
                              || f_nombre
                                    (NVL
                                        (NVL
                                            (pac_persona.f_sperson_spereal
                                                                (c.sperson_tit),
                                             c.sperson_tit
                                            ),
                                         0
                                        ),
                                     1,
                                     NULL
                                    );
                        END IF;

                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vnorden
                                          );
                        vnorden := vnorden + 1;
                     END IF;

                     --BUG 28455/158132 - RCL - 07/11/2013 - 0028455: LCOL_T031- TEC - Revisi?n Q-Trackers Fase 3A II
                     IF     vantes IS NOT NULL
                        AND c.pparticip IS NOT NULL
                        AND c.pparticip > 0
                     THEN
                        -- Participaci?n de benef.
                        literal := f_axis_literales (104818, pcidioma);
                        --particip. benef
                        --vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(1000134, pcidioma);   -- no existe
                        vdespues :=
                              f_nombre_est (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || c.pparticip;
                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vnorden
                                          );
                        vnorden := vnorden + 1;
                     END IF;

                     --BUG 28455/158132 - RCL - 07/11/2013 - 0028455: LCOL_T031- TEC - Revisi?n Q-Trackers Fase 3A II
                     IF vantes IS NOT NULL AND c.cparen IS NOT NULL
                     THEN
                        -- cparent
                        literal := f_axis_literales (9902580, pcidioma);
                        --particip. benef
                        --vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(9902580, pcidioma);   -- no existe
                        vdespues :=
                              f_nombre_est (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desvalorfijo (1054, pcidioma, c.cparen);
                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vnorden
                                          );
                        vnorden := vnorden + 1;
                     END IF;

                     --BUG 34907 - 15/04/2015 - DCT
                     IF vantes IS NOT NULL AND c.cestado IS NOT NULL
                     THEN
                        -- estado
                        literal := f_axis_literales (101510, pcidioma);
                        --particip. benef
                        --vantes := f_nombre(  NVL(pac_persona.f_sperson_spereal( c.sperson),  c.sperson), 1, NULL)||' : '||literal || ' ' || f_axis_literales(9902580, pcidioma);   -- no existe
                        vdespues :=
                              f_nombre_est (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desvalorfijo (800128, pcidioma, c.cestado);
                        p_insdetmovseguro (psseguro,
                                           pnmovimi,
                                           pcmotmov,
                                           vnriesgo,
                                           vcgarant,
                                           vantes,
                                           vdespues,
                                           vnorden
                                          );
                        vnorden := vnorden + 1;
                     END IF;
               END;
            ELSE
               BEGIN
                  SELECT cgarant,
                         NVL
                            (NVL (pac_persona.f_sperson_spereal (sperson_tit),
                                  sperson_tit
                                 ),
                             0
                            ),
                         finiben, ffinben, ctipben, cparen, pparticip,
                         nriesgo, cestado
                    INTO vcgarant,
                         v_sperson_tit,
                         vffinbe, v_ffinben, vctipben, vcparen, vpparticip,
                         vnriesgo, vcestado
                    FROM estbenespseg eb, estper_personas ep
                   WHERE eb.sseguro = psseguro
                     AND eb.sseguro = ep.sseguro
                     AND eb.sperson = ep.sperson
                     AND ep.spereal = c.sperson;
               EXCEPTION
                  WHEN NO_DATA_FOUND
                  THEN
                     --Borrado
                     BEGIN
                        SELECT fsuplem
                          INTO v_ffinben
                          FROM pds_estsegurosupl
                         WHERE sseguro = psseguro AND cmotmov = 697;
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                           v_ffinben := NULL;
                     END;

                     v_borrado := 1;
                     -- solo deber?a pasar en caso de baja
                     --INICIO BUG 27539_151566 - DCT - 28/08/2013
                     literal := f_axis_literales (9905936, pcidioma);
                             --literal := f_axis_literales(9901519, pcidioma);
                     --FIN BUG 27539_151566 - DCT - 28/08/2013
                     --
                     -- INI - JLB -  MSV-21 -
                     --vdespues := literal || ' ' || f_nombre(c.sperson, 1, NULL) || ' '
                     --           || f_axis_literales(9000447, pcidioma) || ' : ' || v_ffinben;
                     vdespues := NULL;
                     vantes :=
                           literal
                        || ' '
                        || f_nombre (c.sperson, 1, NULL)
                        || ' '
                        || f_axis_literales (9000447, pcidioma)
                        || ' : '
                        || v_ffinben;
                     -- FIN - JLB -  MSV-21
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  WHEN OTHERS
                  THEN
                     vdespues := '--';
               END;

               IF NVL (v_borrado, 0) = 0
               THEN
                  IF     NVL (c.cgarant, 0) <> 0
                     AND NVL (c.cgarant, 0) <> NVL (vcgarant, 0)
                  THEN
                     literal := f_axis_literales (100561, pcidioma);

                     --garantia
                     IF vcgarant IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desgarantia (c.cgarant, pcidioma);
                     END IF;

                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        || ff_desgarantia (vcgarant, pcidioma);
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  IF NVL (c.ctipben, 0) <> NVL (vctipben, 0)
                  THEN
                     -- tipo de beneficiario
                     literal := f_axis_literales (9901522, pcidioma);

                     --tipo beneficiario
                     IF vctipben IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           -- Ini Bug 27304 - MDS - 30/08/2013
                           --|| ff_desvalorfijo(1053, pcidioma, vctipben);
                           || ff_desvalorfijo (vsliteral, pcidioma, vctipben);
                     -- Fin Bug 27304 - MDS - 30/08/2013
                     END IF;

                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        -- Ini Bug 27304 - MDS - 30/08/2013
                        --|| ff_desvalorfijo(1053, pcidioma, c.ctipben);
                        || ff_desvalorfijo (vsliteral, pcidioma, c.ctipben);
                     -- Fin Bug 27304 - MDS - 30/08/2013
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  IF     c.ctipben = 3
                     AND NVL (c.sperson_tit, -1) <> NVL (v_sperson_tit, -1)
                  THEN
                     literal := f_axis_literales (9902661, pcidioma);
                     --benef.  continge
                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        || f_nombre (c.sperson_tit, 1, NULL);             -- n

                     IF v_sperson_tit IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || f_nombre_est (v_sperson_tit, 1, NULL);
                     END IF;

                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  IF NVL (c.pparticip, -1) <> NVL (vpparticip, -1)
                  THEN
                     -- Participaci?n de benef.
                     literal := f_axis_literales (104818, pcidioma);
                     --particip. benef
                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        || c.pparticip;

                     IF vpparticip IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || vpparticip;
                     END IF;

                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  IF NVL (c.cparen, -1) <> NVL (vcparen, -1)
                  THEN
                     -- cparent
                     literal := f_axis_literales (9902580, pcidioma);
                     --particip. benef
                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        || ff_desvalorfijo (1054, pcidioma, c.cparen);

                     IF vcparen IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desvalorfijo (1054, pcidioma, vcparen);
                     END IF;

                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  IF c.ffinben <> NVL (v_ffinben, f_sysdate)
                  THEN
                     -- solo deber?a pasar en caso de baja
                     --INICIO BUG 27539_151566 - DCT - 28/08/2013
                     literal := f_axis_literales (9905936, pcidioma);
                            --literal := f_axis_literales(9901519, pcidioma);
                     --FIN BUG 27539_151566 - DCT - 28/08/2013
                     vdespues :=
                           literal
                        || ' '
                        || f_nombre (c.sperson, 1, NULL)
                        || ' '
                        || f_axis_literales (9000447, pcidioma)
                        || ' : '
                        || v_ffinben;
                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;

                  --15/04/2015
                  IF NVL (c.cestado, -1) <> NVL (vcestado, -1)
                  THEN
                     -- estado
                     literal := f_axis_literales (101510, pcidioma);
                     --estado benef
                     vantes :=
                           f_nombre (c.sperson, 1, NULL)
                        || ' : '
                        || literal
                        || ' '
                        || ff_desvalorfijo (800128, pcidioma, c.cestado);

                     IF vcparen IS NOT NULL
                     THEN
                        vdespues :=
                              f_nombre (c.sperson, 1, NULL)
                           || ' : '
                           || literal
                           || ' '
                           || ff_desvalorfijo (800128, pcidioma, vcestado);
                     END IF;

                     p_insdetmovseguro (psseguro,
                                        pnmovimi,
                                        pcmotmov,
                                        vnriesgo,
                                        vcgarant,
                                        vantes,
                                        vdespues,
                                        vnorden
                                       );
                     vnorden := vnorden + 1;
                  END IF;
               END IF;
            END IF;
         END LOOP;

         IF pcmotmov = 692
         THEN
            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_a
              FROM garanseg
             WHERE sseguro = pssegpol
               AND cgarant = 48
               AND icapital > 0
               AND nmovimi = (SELECT MAX (nmovimi)
                                FROM garanseg
                               WHERE sseguro = pssegpol AND cgarant = 48);

            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_d
              FROM estgaranseg
             WHERE sseguro = psseguro AND cgarant = 48 AND icapital > 0;

            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_ab
              FROM garanseg
             WHERE sseguro = pssegpol
               AND cgarant = 52
               AND icapital > 0
               AND nmovimi = (SELECT MAX (nmovimi)
                                FROM garanseg
                               WHERE sseguro = pssegpol AND cgarant = 52);

            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_db
              FROM estgaranseg
             WHERE sseguro = psseguro AND cgarant = 52 AND icapital > 0;

            -- BUG13685:DRA:17/03/2010:Inici
            IF NVL (v_crespue_a, 0) <> NVL (v_crespue_d, 0)
            THEN
               literal := f_axis_literales (102003, pcidioma);      -- Prima:
               vantes := literal || ' ' || v_crespue_a;
               vdespues := literal || ' ' || v_crespue_d;
               vnriesgo := 1;
               vcgarant := 48;                     -- BUG12710:JRH:25/01/2010
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            ELSE
               IF NVL (v_crespue_ab, 0) <> NVL (v_crespue_db, 0)
               THEN
                  literal := f_axis_literales (102003, pcidioma);   -- Prima:
                  vantes := literal || ' ' || v_crespue_ab;
                  vdespues := literal || ' ' || v_crespue_db;
                  vnriesgo := 1;
                  vcgarant := 52;                  -- BUG12710:JRH:25/01/2010
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     vnriesgo,
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
               END IF;
            END IF;
         END IF;
      -- Inicio BUG 0023068: MDP_T001-Fase 2: Suplementos Inquilinos / Avalistas  HWP
      ELSIF pcmotmov IN (240)
      THEN
         vnorden := 0;

         FOR ctj IN
            (SELECT c.sperson csperson_ori, c.ctipfig ctipfig_ori,
                    e.sperson csperson_des, e.ctipfig ctipfig_des
               FROM inquiaval c, estinquiaval e
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM inquiaval c1
                                  WHERE c1.sseguro = c.sseguro)
                AND e.sseguro = psseguro
                AND e.nmovimi = (SELECT MAX (c3.nmovimi)
                                   FROM estinquiaval c3
                                  WHERE c3.sseguro = e.sseguro)
                AND e.ctipfig = c.ctipfig
                AND c.sperson <>
                            NVL (pac_persona.f_sperson_spereal (e.sperson),
                                 -1)
                AND NOT EXISTS (
                       SELECT 1
                         FROM estinquiaval e
                        WHERE e.sseguro = psseguro
                          AND c.sperson =
                                 NVL
                                    (pac_persona.f_sperson_spereal (e.sperson),
                                     -1
                                    )
                          AND e.ctipfig = c.ctipfig
                          AND e.nmovimi = (SELECT MAX (c2.nmovimi)
                                             FROM estinquiaval c2
                                            WHERE c2.sseguro = e.sseguro))
             UNION
             SELECT c.sperson csperson_ori, c.ctipfig ctipfig_ori,
                    NULL csperson_des, NULL ctipfig_des
               FROM inquiaval c
              WHERE c.sseguro = pssegpol
                AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                   FROM inquiaval c1
                                  WHERE c1.sseguro = c.sseguro)
                AND NOT EXISTS (
                       SELECT 1
                         FROM estinquiaval e
                        WHERE e.sseguro = psseguro
                          AND c.sperson =
                                 NVL
                                    (pac_persona.f_sperson_spereal (e.sperson),
                                     -1
                                    )
                          AND e.ctipfig = c.ctipfig
                          AND e.nmovimi = (SELECT MAX (c2.nmovimi)
                                             FROM estinquiaval c2
                                            WHERE c2.sseguro = e.sseguro))
             UNION
             SELECT NULL csperson_ori, NULL ctipfig_ori,
                    e.sperson csperson_des, e.ctipfig ctipfig_des
               FROM estinquiaval e
              WHERE e.sseguro = psseguro
                AND e.nmovimi = (SELECT MAX (c2.nmovimi)
                                   FROM estinquiaval c2
                                  WHERE c2.sseguro = e.sseguro)
                AND NOT EXISTS (
                       SELECT 1
                         FROM inquiaval c
                        WHERE c.sseguro = pssegpol
                          AND c.ctipfig = e.ctipfig
                          AND c.sperson =
                                 NVL
                                    (pac_persona.f_sperson_spereal (e.sperson),
                                     -1
                                    )
                          AND c.nmovimi = (SELECT MAX (c1.nmovimi)
                                             FROM inquiaval c1
                                            WHERE c1.sseguro = c.sseguro)))
         LOOP
            vantes :=
                  ff_desvalorfijo (800099, pcidioma, ctj.ctipfig_ori)
               || ' : '
               || f_nombre (ctj.csperson_ori, 1, NULL);
            vdespues :=
                  ff_desvalorfijo (800099, pcidioma, ctj.ctipfig_des)
               || ' : '
               || f_nombre_est (ctj.csperson_des, 1, NULL);
            literal :=
                  f_axis_literales (9903896, pcidioma)
               || '/'
               || f_axis_literales (9903897, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := 1;
            vcgarant := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- FIN BUG 0023068: MDP_T001-Fase 2: Suplementos Inquilinos / Beneficiarios   HWP
      -- Bug 21686 - APD - 15/03/2012 - se anade el suplemento 810
      ELSIF pcmotmov = 810
      THEN
-- Suplemento post- Migraci?n
--------------------------------------------------------------------------
         literal := f_axis_literales (9903450, pcidioma);
         -- Movimiento de migraci?n realizado
         vantes := NULL;
         vdespues := literal;
         vnriesgo := 1;
         vcgarant := 0;
      -- fin Bug 21686 - APD - 15/03/2012
      -- Bug 23067 - APD - 10/09/2012 - se anade el suplemento 355
      ELSIF pcmotmov IN (355, 357)
      THEN
         -- Suplemento 355.-Aumento de capitales
         -- Suplemento 357.-Aumento de capitales por infraseguro
         FOR c IN (SELECT icapital antes, nriesgo, cgarant
                     FROM garanseg
                    WHERE ffinefe IS NULL AND sseguro = pssegpol)
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT icapital
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
            END;

            IF c.antes < vdespues
            THEN
               -- ha habido aumento
               vantes :=
                  literal || ': '
                  || TO_CHAR (c.antes, 'FM999G999G999G990D00');
               vdespues :=
                  literal || ': '
                  || TO_CHAR (vdespues, 'FM999G999G999G990D00');
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      -- Bug 23067 - APD - 10/09/2012 - se anade el suplemento 355
      ELSIF pcmotmov = 356
      THEN
         -- Disminucion de capitales
         FOR c IN (SELECT icapital antes, nriesgo, cgarant
                     FROM garanseg g
                    WHERE ffinefe IS NULL
                      AND sseguro = pssegpol
                      AND EXISTS (
                             SELECT 1
                               FROM estgaranseg e
                              WHERE e.sseguro = psseguro
                                AND e.cobliga = 1
                                AND e.nmovimi = pnmovimi
                                AND e.cgarant = g.cgarant))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT icapital
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
            END;

            IF c.antes > vdespues
            THEN
               -- ha habido disminucion
               vantes :=
                  literal || ': '
                  || TO_CHAR (c.antes, 'FM999G999G999G990D00');
               vdespues :=
                  literal || ': '
                  || TO_CHAR (vdespues, 'FM999G999G999G990D00');
               vcgarant := c.cgarant;
               vnriesgo := c.nriesgo;

               IF literal2 IS NOT NULL
               THEN
                  vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
                  vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
               END IF;

               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov = 358
      THEN
         -- Cambio descuentos/recargos t?cnicos
         -- se comprueba si ha habido cambio de descuentos/recargos tecnicos a nivel de garantia
         FOR c IN (SELECT g.cgarant, g.nriesgo, NVL (g.precarg, 0) antes,
                          NVL (g.pdtotec, 0) antes2
                     FROM garanseg g, estgaranseg e, estriesgos er,
                          riesgos r
                    WHERE g.ffinefe IS NULL
                      AND g.sseguro = pssegpol
                      AND NVL (e.cobliga, 1) = 1
                      AND e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND g.cgarant = e.cgarant
                      AND r.sseguro = g.sseguro
                      AND r.nriesgo = g.nriesgo
                      AND er.sseguro = e.sseguro
                      AND er.nriesgo = e.nriesgo
                      AND (   (       NVL (g.precarg, 0) <> NVL (e.precarg, 0)
                                  AND NVL (er.precarg, 0) <>
                                                            NVL (e.precarg, 0)
                                  AND NVL (r.precarg, 0) <>
                                                           NVL (er.precarg, 0)
                                  AND NVL (er.precarg, 0) <> 0
                               OR (    NVL (g.precarg, 0) <>
                                                            NVL (e.precarg, 0)
                                   AND NVL (r.precarg, 0) =
                                                           NVL (er.precarg, 0)
                                  )
                              )
                           OR (   (    NVL (g.pdtotec, 0) <>
                                                            NVL (e.pdtotec, 0)
                                   AND NVL (er.pdtotec, 0) <>
                                                            NVL (e.pdtotec, 0)
                                   AND NVL (r.pdtotec, 0) <>
                                                           NVL (er.pdtotec, 0)
                                   AND NVL (er.pdtotec, 0) <> 0
                                  )
                               OR (    NVL (g.pdtotec, 0) <>
                                                            NVL (e.pdtotec, 0)
                                   AND NVL (r.pdtotec, 0) =
                                                           NVL (er.pdtotec, 0)
                                  )
                              )
                          ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vantes2 := NULL;
            vdespues2 := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT NVL (precarg, 0), NVL (pdtotec, 0)
                 INTO vdespues, vdespues2
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- se comprueba si ha habido cambio de descuentos/recargos tecnicos a nivel de riesgo
         FOR c IN (SELECT r.nriesgo, NVL (r.precarg, 0) antes,
                          NVL (r.pdtotec, 0) antes2
                     FROM estriesgos er, riesgos r, estseguros es, seguros s
                    WHERE r.sseguro = pssegpol
                      AND er.sseguro = psseguro
                      AND r.sseguro = s.sseguro
                      AND er.sseguro = es.sseguro
                      AND er.nriesgo = r.nriesgo
                      AND (   (   (    NVL (r.precarg, 0) <>
                                                           NVL (er.precarg, 0)
                                   AND NVL (s.precarg, 0) <>
                                                           NVL (es.precarg, 0)
                                   AND NVL (es.precarg, 0) <> 0
                                  )
                               OR (    NVL (r.precarg, 0) <>
                                                           NVL (er.precarg, 0)
                                   AND NVL (s.precarg, 0) =
                                                           NVL (es.precarg, 0)
                                  )
                              )
                           OR (   (    NVL (r.pdtotec, 0) <>
                                                           NVL (er.pdtotec, 0)
                                   AND NVL (s.pdtotec, 0) <>
                                                           NVL (es.pdtotec, 0)
                                   AND NVL (es.pdtotec, 0) <> 0
                                  )
                               OR (    NVL (r.pdtotec, 0) <>
                                                           NVL (er.pdtotec, 0)
                                   AND NVL (s.pdtotec, 0) =
                                                           NVL (es.pdtotec, 0)
                                  )
                              )
                          ))
         LOOP
            BEGIN
               SELECT NVL (precarg, 0), NVL (pdtotec, 0)
                 INTO vdespues, vdespues2
                 FROM estriesgos
                WHERE sseguro = psseguro AND nriesgo = c.nriesgo;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            -- Bug 25840 - APD - 27/02/2013
            literal := f_axis_literales (9905048, pcidioma);
            -- fin Bug 25840 - APD - 27/02/2013
            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- se comprueba si ha habido cambio de descuentos/recargos tecnicos a nivel de poliza
         FOR c IN (SELECT NVL (s.precarg, 0) antes, NVL (s.pdtotec, 0) antes2
                     FROM estseguros es, seguros s
                    WHERE s.sseguro = pssegpol
                      AND es.sseguro = psseguro
                      AND (   NVL (s.precarg, 0) <> NVL (es.precarg, 0)
                           OR NVL (s.pdtotec, 0) <> NVL (es.pdtotec, 0)
                          ))
         LOOP
            BEGIN
               SELECT NVL (precarg, 0), NVL (pdtotec, 0)
                 INTO vdespues, vdespues2
                 FROM estseguros
                WHERE sseguro = psseguro;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            -- Bug 25840 - APD - 27/02/2013
            literal := f_axis_literales (9905049, pcidioma);
            -- fin Bug 25840 - APD - 27/02/2013
            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vnriesgo := 0;
            vcgarant := 0;
            vcpregun := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov = 359
      THEN
         -- Cambio descuentos/recargos cormerciales
         -- se comprueba si ha habido cambio de descuentos/recargos cormerciales a nivel de garantia
         FOR c IN (SELECT g.cgarant, g.nriesgo, NVL (g.preccom, 0) antes,
                          NVL (g.pdtocom, 0) antes2
                     FROM garanseg g, estgaranseg e, estriesgos er,
                          riesgos r
                    WHERE g.ffinefe IS NULL
                      AND g.sseguro = pssegpol
                      AND NVL (e.cobliga, 1) = 1
                      AND e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND g.cgarant = e.cgarant
                      AND r.sseguro = g.sseguro
                      AND r.nriesgo = g.nriesgo
                      AND er.sseguro = e.sseguro
                      AND er.nriesgo = e.nriesgo
                      AND (   (       NVL (g.preccom, 0) <> NVL (e.preccom, 0)
                                  AND NVL (er.preccom, 0) <>
                                                            NVL (e.preccom, 0)
                                  AND NVL (r.preccom, 0) <>
                                                           NVL (er.preccom, 0)
                                  AND NVL (er.preccom, 0) <> 0
                               OR (    NVL (g.preccom, 0) <>
                                                            NVL (e.preccom, 0)
                                   AND NVL (r.preccom, 0) =
                                                           NVL (er.preccom, 0)
                                  )
                              )
                           OR (   (    NVL (g.pdtocom, 0) <>
                                                            NVL (e.pdtocom, 0)
                                   AND NVL (er.pdtocom, 0) <>
                                                            NVL (e.pdtocom, 0)
                                   AND NVL (r.pdtocom, 0) <>
                                                           NVL (er.pdtocom, 0)
                                   AND NVL (er.pdtocom, 0) <> 0
                                  )
                               OR (    NVL (g.pdtocom, 0) <>
                                                            NVL (e.pdtocom, 0)
                                   AND NVL (r.pdtocom, 0) =
                                                           NVL (er.pdtocom, 0)
                                  )
                              )
                          ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vantes2 := NULL;
            vdespues2 := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT NVL (preccom, 0), NVL (pdtocom, 0)
                 INTO vdespues, vdespues2
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND cobliga = 1
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- se comprueba si ha habido cambio de descuentos/recargos cormerciales a nivel de riesgo
         FOR c IN (SELECT r.nriesgo, NVL (r.preccom, 0) antes,
                          NVL (r.pdtocom, 0) antes2
                     FROM estriesgos er, riesgos r, estseguros es, seguros s
                    WHERE r.sseguro = pssegpol
                      AND er.sseguro = psseguro
                      AND r.sseguro = s.sseguro
                      AND er.sseguro = es.sseguro
                      AND er.nriesgo = r.nriesgo
                      AND (   (   (    NVL (r.preccom, 0) <>
                                                           NVL (er.preccom, 0)
                                   AND NVL (s.preccom, 0) <>
                                                           NVL (es.preccom, 0)
                                   AND NVL (es.preccom, 0) <> 0
                                  )
                               OR (    NVL (r.preccom, 0) <>
                                                           NVL (er.preccom, 0)
                                   AND NVL (s.preccom, 0) =
                                                           NVL (es.preccom, 0)
                                  )
                              )
                           OR (   (    NVL (r.pdtocom, 0) <>
                                                           NVL (er.pdtocom, 0)
                                   AND NVL (s.pdtocom, 0) <>
                                                           NVL (es.pdtocom, 0)
                                   AND NVL (es.pdtocom, 0) <> 0
                                  )
                               OR (    NVL (r.pdtocom, 0) <>
                                                           NVL (er.pdtocom, 0)
                                   AND NVL (s.pdtocom, 0) =
                                                           NVL (es.pdtocom, 0)
                                  )
                              )
                          ))
         LOOP
            BEGIN
               SELECT NVL (preccom, 0), NVL (pdtocom, 0)
                 INTO vdespues, vdespues2
                 FROM estriesgos
                WHERE sseguro = psseguro AND nriesgo = c.nriesgo;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            -- Bug 25840 - APD - 27/02/2013
            literal := f_axis_literales (9905051, pcidioma);
            -- fin Bug 25840 - APD - 27/02/2013
            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         -- se comprueba si ha habido cambio de descuentos/recargos cormerciales a nivel de poliza
         FOR c IN (SELECT NVL (s.preccom, 0) antes, NVL (s.pdtocom, 0) antes2
                     FROM estseguros es, seguros s
                    WHERE s.sseguro = pssegpol
                      AND es.sseguro = psseguro
                      AND (   NVL (s.preccom, 0) <> NVL (es.preccom, 0)
                           OR NVL (s.pdtocom, 0) <> NVL (es.pdtocom, 0)
                          ))
         LOOP
            BEGIN
               SELECT NVL (preccom, 0), NVL (pdtocom, 0)
                 INTO vdespues, vdespues2
                 FROM estseguros
                WHERE sseguro = psseguro;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            -- Bug 25840 - APD - 27/02/2013
            literal := f_axis_literales (9905052, pcidioma);
            -- fin Bug 25840 - APD - 27/02/2013
            vantes :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || c.antes
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || c.antes2
               || '%';
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (101369, pcidioma)
               || ' = '
               || vdespues
               || '%'
               || ';'
               || f_axis_literales (9903807, pcidioma)
               || ' = '
               || vdespues2
               || '%';
            vnriesgo := 0;
            vcgarant := 0;
            vcpregun := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      --BUG23860:DCT:24/10/2012:Inici
      ELSIF pcmotmov = 828
      THEN
         SELECT ctipcom
           INTO ctipcoma
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT ctipcom
           INTO ctipcomd
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         comisiona := ff_desvalorfijo (55, pcidioma, ctipcoma);
         comisiond := ff_desvalorfijo (55, pcidioma, ctipcomd);
         literal := f_axis_literales (101509, pcidioma);    --101509  Comisi?n
         --vantes := literal || ' ' || ctipcoma || ' ' || comisiona;
         --vdespues := literal || ' ' || ctipcomd || ' ' || comisiond;
         vantes := literal || ' ' || comisiona;
         vdespues := literal || ' ' || comisiond;
         vnriesgo := 1;
         vcgarant := 0;
         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            vnriesgo,
                            vcgarant,
                            vantes,
                            vdespues,
                            vcpregun
                           );

         -- Bug 30642/169851 - 20/03/2014 - AMC
         SELECT COUNT (1)
           INTO v_cambio
           FROM (SELECT cmodcom, pcomisi, ninialt, nfinalt
                   FROM comisionsegu
                  WHERE sseguro = pssegpol
                    AND nmovimi = (SELECT MAX (nmovimi)
                                     FROM comisionsegu
                                    WHERE sseguro = pssegpol)
                 MINUS
                 SELECT cmodcom, pcomisi, ninialt, nfinalt
                   FROM estcomisionsegu
                  WHERE sseguro = psseguro AND nmovimi = pnmovimi);

         -- Fi Bug 30642/169851 - 20/03/2014 - AMC
         IF (v_cambio > 0 AND ctipcoma = 90 AND ctipcomd = 90)
         THEN
            FOR regs IN cur_comisionsegu
            LOOP
               vantes :=
                     vantes
                  || ' '
                  || ff_desvalorfijo (67, pcidioma, regs.cmodcom)
                  || ':'
                  || regs.pcomisi
                  || '%; ';
            END LOOP;

            FOR regs IN cur_comisionsegu2
            LOOP
               vdespues :=
                     vdespues
                  || ' '
                  || ff_desvalorfijo (67, pcidioma, regs.cmodcom)
                  || ':'
                  || regs.pcomisi
                  || '%; ';
            END LOOP;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      --BUG23860:DCT:24/10/2012:Fin
      -- BUG 0023115/0119971 - FAL - 13/11/2012
      ELSIF pcmotmov IN (900, 905)
      THEN
         --Ini Bug 26488 --ECP--06/05/2013 TO_CHAR(s.frenova, 'dd/mm/yyyy') Se cambia por
         SELECT TO_CHAR (NVL (s.frenova, s.fcaranu), 'dd/mm/yyyy')
           --Fin Bug 26488 --ECP--06/05/2013
         INTO   vantes
           FROM seguros s
          WHERE s.sseguro = pssegpol;

         SELECT TO_CHAR (s.frenova, 'dd/mm/yyyy')
           INTO vdespues
           FROM estseguros s
          WHERE s.sseguro = psseguro;

         literal := f_axis_literales (800314, pcidioma);
         vantes := literal || ' ' || vantes;
         vdespues := literal || ' ' || vdespues;
         vnriesgo := 1;
         vcgarant := 0;
      -- FI BUG 0023115/0119971
      -- BUG 23860/0130231 - FAL - 26/11/2012
      ELSIF pcmotmov IN (899, 897)
      THEN
         -- (cmotmov: 899 - Alta de plan - No genera recibo) -- BUG 0022095 - FAL - 24/04/2013 - Anade cmotmov: 897 Alta de riesgo innominado (genera recibo)
         FOR c IN riesgos_alta_innom
         LOOP
            literal := f_axis_literales (9904563, pcidioma);
            vantes := NULL;
            vdespues := literal || ': ' || c.tnatrie;
            vcgarant := 0;
            vnriesgo := c.nriesgo;

            IF vdespues IS NOT NULL
            THEN
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov IN (898, 896)
      THEN
         -- (cmotmov:898 - Baja de plan - No genera recibo) -- BUG 0022095 - FAL - 24/04/2013 - Anade cmotmov: 896 Baja de riesgo innominado (genera recibo)
         FOR c IN riesgos_baja_innom
         LOOP
            literal := f_axis_literales (9904565, pcidioma);
            vantes := literal || ': ' || c.tnatrie;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := c.nriesgo;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- FI BUG 23860/0130231
      ELSIF pcmotmov = 341
      THEN
         -- Canvi de Franqu?cies Volunt?ries
         -- se comprueba si ha habido cambio de franquicias a nivel de garantias
         FOR c IN (SELECT g.cgarant, g.nriesgo, NVL (g.ifranqu, 0) antes
                     FROM garanseg g, estgaranseg e, estriesgos er,
                          riesgos r
                    WHERE g.ffinefe IS NULL
                      AND g.sseguro = pssegpol
                      AND NVL (e.cobliga, 1) = 1
                      AND e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND g.cgarant = e.cgarant
                      AND r.sseguro = g.sseguro
                      AND r.nriesgo = g.nriesgo
                      AND er.sseguro = e.sseguro
                      AND er.nriesgo = e.nriesgo
                      AND (NVL (g.ifranqu, 0) <> NVL (e.ifranqu, 0))
                   UNION
                   SELECT e.cgarant, er.nriesgo, NULL antes
                     FROM estgaranseg e, estriesgos er
                    WHERE NVL (e.cobliga, 1) = 1
                      AND e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND er.sseguro = e.sseguro
                      AND er.nriesgo = e.nriesgo
                      AND NVL (e.ifranqu, 0) <> 0
                      AND NOT EXISTS (
                             SELECT 1
                               FROM garanseg g, riesgos r
                              WHERE g.cgarant = e.cgarant
                                AND g.sseguro = pssegpol
                                AND r.sseguro = g.sseguro
                                AND r.nriesgo = g.nriesgo))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vantes2 := NULL;
            vdespues2 := NULL;
            num_err := f_desgarantia (c.cgarant, pcidioma, literal);

            BEGIN
               SELECT NVL (ifranqu, 0)
                 INTO vdespues
                 FROM estgaranseg
                WHERE sseguro = psseguro
                  AND nriesgo = c.nriesgo
                  AND cgarant = c.cgarant
                  AND nmovimi = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
                  vdespues2 := 0;
            END;

            vantes :=
                  literal
               || ': '
               || f_axis_literales (9000940, pcidioma)
               || ' = '
               || c.antes;
            vdespues :=
                  literal
               || ': '
               || f_axis_literales (9000940, pcidioma)
               || ' = '
               || vdespues;
            vcgarant := c.cgarant;
            vnriesgo := c.nriesgo;

            IF literal2 IS NOT NULL
            THEN
               vantes := literal2 || ' ' || vnriesgo || ' ' || vantes;
               vdespues := literal2 || ' ' || vnriesgo || ' ' || vdespues;
            END IF;

            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      ELSIF pcmotmov IN (340, 342, 343)
      THEN
         -- Canvi de Franqu?cies Manuals i T?cniques
         vnorden := 0;                        -- Bug 25840 - APD - 27/02/2013

         -- Bug 25840 - APD - 07/05/2013 - se modifica la manera de encontrar si ha habido
         -- cambio en los pcmotmov IN(340, 342, 343) y la manera de mostrarlos por pantalla
         -- se comprueba si ha habido cambio de franquicias a nivel de bf_bonfranseg
         FOR c IN (SELECT s.cempres, bf.cgrup, bf.csubgrup, bf.cversion,
                          bf.cnivel, b.tgrup, bf.cvalor1,
                          bf.impvalor1 antes1, bf.cvalor2,
                          bf.impvalor2 antes2, bf.cimpmax, bf.impmax antes3,
                          bf.cimpmin, bf.impmin antes4
                     FROM estseguros e,
                          seguros s,
                          bf_bonfranseg bf,
                          estbf_bonfranseg ebf,
                          bf_desgrup b,
                          bf_codgrup bc
                    WHERE e.sseguro = psseguro
                      AND s.sseguro = pssegpol
                      AND bf.sseguro = s.sseguro
                      AND ebf.sseguro = e.sseguro
                      AND bf.cgrup = ebf.cgrup
                      AND bf.nmovimi = (SELECT MAX (nmovimi)
                                          FROM bf_bonfranseg
                                         WHERE sseguro = s.sseguro)
                      AND ebf.nmovimi = (SELECT MAX (nmovimi)
                                           FROM estbf_bonfranseg
                                          WHERE sseguro = e.sseguro)
                      AND bc.cempres = s.cempres
                      AND bc.cgrup = bf.cgrup
                      AND (   (pcmotmov = 340 AND bc.ctipgrup = 2)
                           OR (pcmotmov = 342 AND bc.ctipgrup = 1)
                           OR (pcmotmov = 343 AND bc.ctipgrup = 2)
                          )
                      AND b.cgrup = bf.cgrup
                      AND b.cidioma = pcidioma
                      AND b.cempres = s.cempres
                      AND (   NVL (ebf.csubgrup, 0) <> NVL (bf.csubgrup, 0)
                           OR NVL (ebf.cnivel, 0) <> NVL (bf.cnivel, 0)
                           OR NVL (bf.cvalor1, 0) <> NVL (ebf.cvalor1, 0)
                           OR NVL (bf.cvalor2, 0) <> NVL (ebf.cvalor2, 0)
                           OR NVL (bf.impvalor1, 0) <> NVL (ebf.impvalor1, 0)
                           OR NVL (bf.impvalor2, 0) <> NVL (ebf.impvalor2, 0)
                           OR NVL (bf.impmax, 0) <> NVL (ebf.impmax, 0)
                           OR NVL (bf.impmin, 0) <> NVL (ebf.impmin, 0)
                          ))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcempres := NULL;
            vcgrup := NULL;
            vcsubgrup := NULL;
            vcversion := NULL;
            vcnivel := NULL;
            vtgrup := NULL;
            vcvalor1 := NULL;
            vdespues1 := NULL;
            vcvalor2 := NULL;
            vdespues2 := NULL;
            vcimpmax := NULL;
            vdespues3 := NULL;
            vcimpmin := NULL;
            vdespues4 := NULL;
            vtnivel_antes := NULL;
            vtnivel_despues := NULL;
            literal := NULL;

            BEGIN
               SELECT s.cempres, e.cgrup, e.csubgrup, e.cversion, e.cnivel,
                      b.tgrup, e.cvalor1, e.impvalor1 vdespues1, e.cvalor2,
                      e.impvalor2 vdespues2, e.cimpmax, e.impmax vdespues3,
                      e.cimpmin, e.impmin vdespue4
                 INTO vcempres, vcgrup, vcsubgrup, vcversion, vcnivel,
                      vtgrup, vcvalor1, vdespues1, vcvalor2,
                      vdespues2, vcimpmax, vdespues3,
                      vcimpmin, vdespues4
                 FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                WHERE e.sseguro = psseguro
                  AND e.cgrup = c.cgrup
                  AND s.sseguro = e.sseguro
                  AND b.cgrup = e.cgrup
                  AND b.cidioma = pcidioma
                  AND b.cempres = s.cempres;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues1 := NULL;
                  vdespues2 := NULL;
                  vdespues3 := NULL;
                  vdespues4 := NULL;
            END;

            IF NVL (vdespues1, -1) <> NVL (c.antes1, -1)
            THEN
               IF c.antes1 IS NOT NULL
               THEN
                  vantes :=
                        vantes
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, c.cvalor1)
                     || ': '
                     || c.antes1;
               END IF;

               IF vdespues1 IS NOT NULL
               THEN
                  vdespues :=
                        vdespues
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, vcvalor1)
                     || ': '
                     || vdespues1;
               END IF;
            END IF;

            IF NVL (vdespues2, -1) <> NVL (c.antes2, -1)
            THEN
               IF c.antes2 IS NOT NULL
               THEN
                  vantes :=
                        vantes
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, c.cvalor2)
                     || ': '
                     || c.antes2;
               END IF;

               IF vdespues2 IS NOT NULL
               THEN
                  vdespues :=
                        vdespues
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, vcvalor2)
                     || ': '
                     || vdespues2;
               END IF;
            END IF;

            IF NVL (vdespues3, -1) <> NVL (c.antes3, -1)
            THEN
               IF c.antes3 IS NOT NULL
               THEN
                  vantes :=
                        vantes
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, c.cimpmax)
                     || ': '
                     || c.antes3;
               END IF;

               IF vdespues3 IS NOT NULL
               THEN
                  vdespues :=
                        vdespues
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, vcimpmax)
                     || ': '
                     || vdespues3;
               END IF;
            END IF;

            IF NVL (vdespues4, -1) <> NVL (c.antes4, -1)
            THEN
               IF c.antes4 IS NOT NULL
               THEN
                  vantes :=
                        vantes
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, c.cimpmin)
                     || ': '
                     || c.antes4;
               END IF;

               IF vdespues4 IS NOT NULL
               THEN
                  vdespues :=
                        vdespues
                     || ' '
                     || ff_desvalorfijo (1104, pcidioma, vcimpmin)
                     || ': '
                     || vdespues4;
               END IF;
            END IF;

            BEGIN
               SELECT tnivel
                 INTO vtnivel_antes
                 FROM bf_desnivel
                WHERE cempres = c.cempres
                  AND cgrup = c.cgrup
                  AND csubgrup = c.csubgrup
                  AND cversion = c.cversion
                  AND cnivel = c.cnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_antes := NULL;
            END;

            BEGIN
               SELECT tnivel
                 INTO vtnivel_despues
                 FROM bf_desnivel
                WHERE cempres = vcempres
                  AND cgrup = vcgrup
                  AND csubgrup = vcsubgrup
                  AND cversion = vcversion
                  AND cnivel = vcnivel
                  AND cidioma = pcidioma;
            EXCEPTION
               WHEN OTHERS
               THEN
                  vtnivel_despues := NULL;
            END;

            -- Bug 25840 - APD - 27/02/2013
            IF pcmotmov IN (340, 343)
            THEN
               literal := f_axis_literales (9001800, pcidioma);
            -- Franquicias
            ELSIF pcmotmov IN (342)
            THEN
               literal := f_axis_literales (9001799, pcidioma);
            -- Bonus/malus
            END IF;

            -- fin Bug 25840 - APD - 27/02/2013
            vantes := literal || ': ' || c.tgrup || ': ' || vantes;
            vdespues := literal || ': ' || vtgrup || ': ' || vdespues;

            IF vtnivel_antes IS NOT NULL AND vtnivel_despues IS NOT NULL
            THEN
               vantes := literal || ': ' || c.tgrup || ': ' || vtnivel_antes;
               vdespues :=
                         literal || ': ' || vtgrup || ': ' || vtnivel_despues;
            END IF;

            vnriesgo := 1;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            -- Bug 25840 - APD - 27/02/2013 - para que no de error por PK
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 07/05/2013
      -- Bug 25840 - APD - 07/05/2013 - se comenta como se buscaba antes si habia habido
      -- cambio en los pcmotmov IN(340, 342, 343). Esta es la manera de MDP pero como
      -- actualmenete esta parado el proyecto de MDP se comenta el codigo (tal vez
      -- para MDP la nueva manera de mirar si hay cambio en los pcmotmov IN(340, 342, 343)
      -- tambien sirva)
      /*
               -- se comprueba si ha habido cambio de franquicias a nivel de bf_bonfranseg
               FOR c IN (SELECT bf.cgrup, b.tgrup || ': ' || bf.impvalor1 || ' ' antes,
                                b.tgrup || ': ' || bf.impvalor2 || ' ' antes2,
                                b.tgrup || ': ' || bf.impmax || ' ' antes3,
                                b.tgrup || ': ' || bf.impmin || ' ' antes4
                           FROM estseguros e, seguros s, bf_bonfranseg bf, estbf_bonfranseg ebf,
                                bf_desgrup b, bf_codgrup bc
                          WHERE e.sseguro = psseguro
                            AND s.sseguro = pssegpol
                            AND bf.sseguro = s.sseguro
                            AND ebf.sseguro = e.sseguro
                            AND bf.cgrup = ebf.cgrup
                            AND bf.nmovimi = (SELECT MAX(nmovimi)
                                                FROM bf_bonfranseg
                                               WHERE sseguro = s.sseguro)
                            AND ebf.nmovimi = (SELECT MAX(nmovimi)
                                                 FROM estbf_bonfranseg
                                                WHERE sseguro = e.sseguro)
                            AND bc.cempres = s.cempres
                            AND bc.cgrup = bf.cgrup
                            AND((pcmotmov = 340
                                 AND bc.ctipgrup = 2)
                                OR(pcmotmov = 342
                                   AND bc.ctipgrup = 1)
                                OR(pcmotmov = 343
                                   AND bc.ctipgrup = 2))
                            AND b.cgrup = bf.cgrup
                            AND b.cidioma = pcidioma
                            AND b.cempres = s.cempres
                            AND(NVL(ebf.csubgrup, 0) <> NVL(bf.csubgrup, 0)
                                OR NVL(ebf.cnivel, 0) <> NVL(bf.cnivel, 0)
                                OR NVL(bf.cvalor1, 0) <> NVL(ebf.cvalor1, 0)
                                OR NVL(bf.cvalor2, 0) <> NVL(ebf.cvalor2, 0)
                                OR NVL(bf.impvalor1, 0) <> NVL(ebf.impvalor1, 0)
                                OR NVL(bf.impvalor2, 0) <> NVL(ebf.impvalor2, 0)
                                OR NVL(bf.impmax, 0) <> NVL(ebf.impmax, 0)
                                OR NVL(bf.impmin, 0) <> NVL(ebf.impmin, 0))) LOOP

                  vantes := NULL;
                  vdespues := NULL;
                  vantes2 := NULL;
                  vdespues2 := NULL;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impvalor1 || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes THEN
                     vantes := vantes || c.antes;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impvalor2 || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes2 THEN
                     vantes := vantes || c.antes2;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impmax || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes3 THEN
                     vantes := vantes || c.antes3;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impmin || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes4 THEN
                     vantes := vantes || c.antes4;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  -- Bug 25840 - APD - 27/02/2013
                  IF pcmotmov IN(340, 343) THEN
                     literal := f_axis_literales(9001800, pcidioma);   -- Franquicias
                  ELSIF pcmotmov IN(342) THEN
                     literal := f_axis_literales(9001799, pcidioma);   -- Bonus/malus
                  END IF;

                  vantes2 := literal || ': ' || vantes;
                  vdespues := literal || ': ' || vdespues2;
                  -- fin Bug 25840 - APD - 27/02/2013
                  vnriesgo := 1;
                  vcgarant := 0;
                  vcpregun := 0;
                  vnorden := vnorden + 1;   -- Bug 25840 - APD - 27/02/2013 - para que no de error por PK
                  p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes2,
                                    vdespues, vnorden);
               END LOOP;

            -- se comprueba si ha habido cambio de franquicias a nivel de bf_bonfranseg
               FOR c IN (SELECT bf.cgrup, b.tgrup || ': ' || bf.impvalor1 || ' ' antes,
                                b.tgrup || ': ' || bf.impvalor2 || ' ' antes2,
                                b.tgrup || ': ' || bf.impmax || ' ' antes3,
                                b.tgrup || ': ' || bf.impmin || ' ' antes4
                           FROM seguros s, bf_bonfranseg bf, bf_desgrup b, bf_codgrup bc
                          WHERE s.sseguro = pssegpol
                            AND bf.sseguro = s.sseguro
                            AND bc.cempres = s.cempres
                            AND bc.cgrup = bf.cgrup
                            AND((pcmotmov = 340
                                 AND bc.ctipgrup = 2)
                                OR(pcmotmov = 342
                                   AND bc.ctipgrup = 1)
                                OR(pcmotmov = 343
                                   AND bc.ctipgrup = 2))
                            AND b.cgrup = bf.cgrup
                            AND b.cidioma = pcidioma
                            AND b.cempres = s.cempres
                            AND bf.nmovimi = (SELECT MAX(nmovimi)
                                                FROM bf_bonfranseg
                                               WHERE sseguro = s.sseguro)
                            AND NOT EXISTS(SELECT 1
                                             FROM estseguros e, estbf_bonfranseg ebf
                                            WHERE e.sseguro = psseguro
                                              AND ebf.sseguro = e.sseguro
                                              AND ebf.nmovimi = (SELECT MAX(nmovimi)
                                                                   FROM estbf_bonfranseg
                                                                  WHERE sseguro = e.sseguro))
                         UNION
                         SELECT bf.cgrup, NULL || ': ' || NULL || ' ' antes,
                                NULL || ': ' || NULL || ' ' antes2,
                                NULL || ': ' || NULL || ' ' antes3,
                                NULL || ': ' || NULL || ' ' antes4
                           FROM estseguros s, estbf_bonfranseg bf, bf_codgrup bc
                          WHERE s.sseguro = psseguro
                            AND bf.sseguro = s.sseguro
                            AND bf.nmovimi = (SELECT MAX(nmovimi)
                                                FROM estbf_bonfranseg
                                               WHERE sseguro = s.sseguro)
                            AND bc.cempres = s.cempres
                            AND bc.cgrup = bf.cgrup
                            AND((pcmotmov = 340
                                 AND bc.ctipgrup = 2)
                                OR(pcmotmov = 342
                                   AND bc.ctipgrup = 1)
                                OR(pcmotmov = 343
                                   AND bc.ctipgrup = 2))
                            AND NOT EXISTS(SELECT 1
                                             FROM seguros e, bf_bonfranseg ebf
                                            WHERE e.sseguro = pssegpol
                                              AND ebf.sseguro = e.sseguro
                                              AND ebf.nmovimi = (SELECT MAX(nmovimi)
                                                                   FROM bf_bonfranseg
                                                                  WHERE sseguro = e.sseguro))) LOOP

                  vantes := NULL;
                  vdespues := NULL;
                  vantes2 := NULL;
                  vdespues2 := NULL;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impvalor1 || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes THEN
                     vantes := vantes || c.antes;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impvalor2 || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes2 THEN
                     vantes := vantes || c.antes2;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impmax || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes3 THEN
                     vantes := vantes || c.antes3;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  BEGIN
                     SELECT b.tgrup || ': ' || e.impmin || ' ' vdespues
                       INTO vdespues
                       FROM estbf_bonfranseg e, bf_desgrup b, estseguros s
                      WHERE e.sseguro = psseguro
                        AND e.cgrup = c.cgrup
                        AND s.sseguro = e.sseguro
                        AND b.cgrup = e.cgrup
                        AND b.cidioma = pcidioma
                        AND b.cempres = s.cempres;
                  EXCEPTION
                     WHEN NO_DATA_FOUND THEN
                        vdespues := NULL;
                  END;

                  IF vdespues NOT LIKE c.antes4 THEN
                     vantes := vantes || c.antes4;
                     vdespues2 := vdespues2 || vdespues;
                  END IF;

                  -- Bug 25840 - APD - 27/02/2013
                  IF pcmotmov IN(340, 343) THEN
                     literal := f_axis_literales(9001800, pcidioma);   -- Franquicias
                  ELSIF pcmotmov IN(342) THEN
                     literal := f_axis_literales(9001799, pcidioma);   -- Bonus/malus
                  END IF;

                  vantes2 := literal || ': ' || vantes;
                  vdespues := literal || ': ' || vdespues2;
                  -- fin Bug 25840 - APD - 27/02/2013
                  vnriesgo := 1;
                  vcgarant := 0;
                  vcpregun := 0;
                  vnorden := vnorden + 1;   -- Bug 25840 - APD - 27/02/2013 - para que no de error por PK
                  p_insdetmovseguro(psseguro, pnmovimi, pcmotmov, vnriesgo, vcgarant, vantes2,
                                    vdespues, vnorden);
               END LOOP;
      */
      -- fin Bug 25840 - APD - 07/05/2013
      ELSIF pcmotmov = 938
      THEN
         --BUG 23460: XVM :24/10/2012--INI
         ---------------------------- COACEDIDO
         vcgarant := 0;
         vnriesgo := 0;
         vcpregun := 0;

         FOR c IN coacuadro_real
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT e.finicoa, e.ffincoa, e.ploccoa, e.fcuacoa, e.ccompan,
                      e.npoliza
                 INTO vfinicoa, vffincoa, vploccoa, vfcuacoa, vccompan,
                      vnpoliza
                 FROM estcoacuadro e
                WHERE e.sseguro = psseguro AND e.ncuacoa = pnmovimi;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
            END;

            IF vdespues = 0
            THEN
               literal := f_axis_literales (105387, pcidioma);    --Coaseguro
               vantes := literal || '--';
               vdespues := literal || ': --';
               literal := f_axis_literales (9904485, pcidioma);
               --Inicio vigencia cuadro coaseguro
               vantes := vantes || literal || ': ' || c.finicoa;
               literal := f_axis_literales (9904486, pcidioma);
               --Final vigencia cuadro coaseguro
               vantes := vantes || ' - ' || literal || ': ' || c.ffincoa;
               literal := f_axis_literales (9904487, pcidioma);
               --Retenido en cedido o aceptado en aceptado
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904488, pcidioma);
               --Alta del cuadro
               vantes := vantes || ' - ' || literal || ': ' || c.fcuacoa;
               literal := f_axis_literales (9904489, pcidioma);
               --Compania aceptado
               vantes := vantes || ' - ' || literal || ': ' || c.ccompan;
               literal := f_axis_literales (9904490, pcidioma);
               --P?liza Origen del aceptado
               vantes := vantes || ' - ' || literal || ': ' || c.npoliza;
            ELSE
               IF (   (vfinicoa <> c.finicoa)
                   OR (vffincoa <> c.ffincoa)
                   OR (vploccoa <> c.ploccoa)
                   OR (vfcuacoa <> c.fcuacoa)
                   OR (vccompan <> c.ccompan)
                   OR (vnpoliza <> c.npoliza)
                  )
               THEN
                  literal := f_axis_literales (105387, pcidioma); --Coaseguro
                  vantes := literal || '--';
                  vdespues := literal || '--';
                  literal := f_axis_literales (9904485, pcidioma);
                  --Inicio vigencia cuadro coaseguro
                  vantes := vantes || literal || ': ' || c.finicoa;
                  vdespues := vdespues || literal || ': ' || vfinicoa;
                  literal := f_axis_literales (9904486, pcidioma);
                  --Final vigencia cuadro coaseguro
                  vantes := vantes || ' - ' || literal || ': ' || c.ffincoa;
                  vdespues :=
                             vdespues || ' - ' || literal || ': ' || vffincoa;
                  literal := f_axis_literales (9904487, pcidioma);
                  --Retenido en cedido o aceptado en aceptado
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vploccoa, 'FM999G999G999G990D00');
                  literal := f_axis_literales (9904488, pcidioma);
                  --Alta del cuadro
                  vantes := vantes || ' - ' || literal || ': ' || c.fcuacoa;
                  vdespues := vdespues || ' - ' || literal || ': ' || vfcuacoa;
                  literal := f_axis_literales (9904489, pcidioma);
                  --Compania aceptado
                  vantes := vantes || ' - ' || literal || ': ' || c.ccompan;
                  vdespues := vdespues || ' - ' || literal || ': ' || vccompan;
                  literal := f_axis_literales (9904490, pcidioma);
                  --P?liza Origen del aceptado
                  vantes := vantes || ' - ' || literal || ': ' || c.npoliza;
                  vdespues := vdespues || ' - ' || literal || ': ' || vnpoliza;
               END IF;
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN coacuadro_est
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                      co.ccompan, co.npoliza
                 INTO vfinicoa, vffincoa, vploccoa, vfcuacoa,
                      vccompan, vnpoliza
                 FROM coacuadro co
                WHERE co.sseguro = pssegpol
                  AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                      FROM coacuadro a
                                     WHERE a.sseguro = pssegpol);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;
            END;

            IF vantes = 0
            THEN
               literal := f_axis_literales (105387, pcidioma);    --Coaseguro
               vantes := literal || ': --';
               vdespues := literal || '--';
               literal := f_axis_literales (9904485, pcidioma);
               --Inicio vigencia cuadro coaseguro
               vdespues := vdespues || literal || ': ' || c.finicoa;
               literal := f_axis_literales (9904486, pcidioma);
               --Final vigencia cuadro coaseguro
               vdespues := vdespues || ' - ' || literal || ': ' || c.ffincoa;
               literal := f_axis_literales (9904487, pcidioma);
               --Retenido en cedido o aceptado en aceptado
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904488, pcidioma);
               --Alta del cuadro
               vdespues := vdespues || ' - ' || literal || ': ' || c.fcuacoa;
               literal := f_axis_literales (9904489, pcidioma);
               --Compania aceptado
               vdespues := vdespues || ' - ' || literal || ': ' || c.ccompan;
               literal := f_axis_literales (9904490, pcidioma);
               --P?liza Origen del aceptado
               vdespues := vdespues || ' - ' || literal || ': ' || c.npoliza;
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN coacedido_real
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT ccompan, pcescoa, pcomcoa, pcomcon, pcomgas,
                      pcesion
                 INTO vccompan, vpcescoa, vpcomcoa, vpcomcon, vpcomgas,
                      vpcesion
                 FROM estcoacedido
                WHERE sseguro = psseguro
                  AND ncuacoa = pnmovimi
                  AND ccompan = c.ccompan;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
            END;

            IF vdespues = 0
            THEN
               literal := f_axis_literales (103227, pcidioma);
               --Coaseguro cedido
               vantes := literal || '--';
               vdespues := literal || ': --';
               literal := f_axis_literales (9900885, pcidioma);
               --C?digo compania
               vantes := vantes || literal || ': ' || c.ccompan;
               literal := f_axis_literales (9904406, pcidioma);
               --Porcentaje cesi?n coaseguro
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcescoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904407, pcidioma);
               --Porcentaje comisi?n coaseguro
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomcoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904408, pcidioma);
               --Comisi?n consorci
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomcon, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904409, pcidioma);
               --Porcentaje gastos sobre la comisi?n
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomgas, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904410, pcidioma);
               --Porcentaje cesi?n sobre la totalidad cedida
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcesion, 'FM999G999G999G990D00');
            ELSE
               IF (   (vpcescoa <> c.pcescoa)
                   OR (vpcomcoa <> c.pcomcoa)
                   OR (vpcomcon <> c.pcomcon)
                   OR (vpcomgas <> c.pcomgas)
                   OR (vpcesion <> c.pcesion)
                  )
               THEN
                  literal := f_axis_literales (103227, pcidioma);
                  --Coaseguro cedido
                  vantes := literal || '--';
                  vdespues := literal || '--';
                  literal := f_axis_literales (9900885, pcidioma);
                  --C?digo compania
                  vantes := vantes || literal || ': ' || c.ccompan;
                  vdespues := vdespues || literal || ': ' || vccompan;
                  literal := f_axis_literales (9904406, pcidioma);
                  --Porcentaje cesi?n coaseguro
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.pcescoa, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vpcescoa, 'FM999G999G999G990D00');
                  literal := f_axis_literales (9904407, pcidioma);
                  --Porcentaje comisi?n coaseguro
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.pcomcoa, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vpcomcoa, 'FM999G999G999G990D00');
                  literal := f_axis_literales (9904408, pcidioma);
                  --Comisi?n consorci
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.pcomcon, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vpcomcon, 'FM999G999G999G990D00');
                  literal := f_axis_literales (9904409, pcidioma);
                  --Porcentaje gastos sobre la comisi?n
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.pcomgas, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vpcomgas, 'FM999G999G999G990D00');
                  literal := f_axis_literales (9904410, pcidioma);
                  --Porcentaje cesi?n sobre la totalidad cedida
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.pcesion, 'FM999G999G999G990D00');
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (vpcesion, 'FM999G999G999G990D00');
               END IF;
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN coacedido_est
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT co.ccompan, co.pcescoa, co.pcomcoa, co.pcomcon,
                      co.pcomgas, co.pcesion
                 INTO vccompan, vpcescoa, vpcomcoa, vpcomcon,
                      vpcomgas, vpcesion
                 FROM coacedido co
                WHERE co.sseguro = pssegpol
                  AND co.ccompan = c.ccompan
                  AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                      FROM coacedido a
                                     WHERE a.sseguro = pssegpol);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;
            END;

            IF vantes = 0
            THEN
               literal := f_axis_literales (103227, pcidioma);
               --Coaseguro cedido
               vantes := literal || ': --';
               vdespues := literal || '--';
               literal := f_axis_literales (9900885, pcidioma);
               --C?digo compania
               vdespues := vdespues || literal || ': ' || c.ccompan;
               literal := f_axis_literales (9904406, pcidioma);
               --Porcentaje cesi?n coaseguro
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcescoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904407, pcidioma);
               --Porcentaje comisi?n coaseguro
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomcoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904408, pcidioma);
               --Comisi?n consorci
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomcon, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904409, pcidioma);
               --Porcentaje gastos sobre la comisi?n
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcomgas, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904410, pcidioma);
               --Porcentaje cesi?n sobre la totalidad cedida
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.pcesion, 'FM999G999G999G990D00');
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      --BUG 23460: XVM :24/10/2012--FIN
      ELSIF pcmotmov = 699
      THEN
         vcgarant := 0;
         vnriesgo := 0;
         vcpregun := 0;
         vantes := NULL;

         SELECT tmovimi
           INTO vdespues
           FROM est_texmovseguro
          WHERE sseguro = psseguro AND nmovimi = pnmovimi;

         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            vnriesgo,
                            vcgarant,
                            vantes,
                            vdespues,
                            vcpregun
                           );
      ELSIF pcmotmov IN (693, 695, 795)
      THEN
         BEGIN
            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_a
              FROM garanseg
             WHERE sseguro = pssegpol
               AND cgarant = 48
               AND icapital > 0
               AND nmovimi = (SELECT MAX (nmovimi)
                                FROM garanseg
                               WHERE sseguro = pssegpol AND cgarant = 48);
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_a := 0;
         END;

         BEGIN
            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_d
              FROM estgaranseg
             WHERE sseguro = psseguro AND cgarant = 48 AND icapital > 0;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_d := 0;
         END;

         BEGIN
            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_ab
              FROM garanseg
             WHERE sseguro = pssegpol
               AND cgarant = 52
               AND icapital > 0
               AND nmovimi = (SELECT MAX (nmovimi)
                                FROM garanseg
                               WHERE sseguro = pssegpol AND cgarant = 52);
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_ab := 0;
         END;

         BEGIN
            SELECT TO_CHAR (icapital, 'FM999G999G999G990D00')
              INTO v_crespue_db
              FROM estgaranseg
             WHERE sseguro = psseguro AND cgarant = 52 AND icapital > 0;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_db := 0;
         END;

         -- BUG13685:DRA:17/03/2010:Inici
         IF NVL (v_crespue_ab, 0) <> NVL (v_crespue_db, 0)
         THEN
            literal := f_axis_literales (9001858, pcidioma);        -- Renta:
            vantes := literal || ' ' || v_crespue_ab;
            vdespues := literal || ' ' || v_crespue_db;
            vnriesgo := 1;
            vcgarant := 52;                        -- BUG12710:JRH:25/01/2010
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         ELSE
            IF NVL (v_crespue_a, 0) <> NVL (v_crespue_d, 0)
            THEN
               literal := f_axis_literales (102003, pcidioma);      -- Prima:
               vantes := literal || ' ' || v_crespue_a;
               vdespues := literal || ' ' || v_crespue_d;
               vnriesgo := 1;
               vcgarant := 48;                     -- BUG12710:JRH:25/01/2010
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vcpregun
                                 );
            END IF;
         END IF;

         -- Bug 25840 - APD - 11/03/2013 - se anade el suplemento 420.-Cambio de vehiculo
         --ETM ini--12/11/2013
         BEGIN
            SELECT nmesextra
              INTO v_crespue_ca
              FROM seguros_ren
             WHERE sseguro = pssegpol;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_ca := 0;
         END;

         BEGIN
            SELECT nmesextra
              INTO v_crespue_cb
              FROM estseguros_ren
             WHERE sseguro = psseguro;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_cb := 0;
         END;

         ---IMESEXTRA
         BEGIN
            SELECT imesextra
              INTO v_crespue_ba
              FROM seguros_ren
             WHERE sseguro = pssegpol;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_ba := 0;
         END;

         BEGIN
            SELECT imesextra
              INTO v_crespue_bc
              FROM estseguros_ren
             WHERE sseguro = psseguro;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_crespue_bc := 0;
         END;

         IF NVL (v_crespue_ca, 0) <> NVL (v_crespue_cb, 0)
         THEN
            vcpregun := vcpregun + 1;
            literal := f_axis_literales (9000670, pcidioma);
            --mesada extra --preguntas(254)
            vantes := literal || ' ' || v_crespue_ca;
            vdespues := literal || ' ' || v_crespue_cb;
            vnriesgo := 1;
            vcgarant := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;

         IF NVL (v_crespue_ba, 0) <> NVL (v_crespue_bc, 0)
         THEN
            vcpregun := vcpregun + 1;
            literal := f_axis_literales (9000473, pcidioma);
            --mesada IMESEXTRA
            vantes := literal || ' ' || v_crespue_ba;
            vdespues := literal || ' ' || v_crespue_bc;
            vnriesgo := 1;
            vcgarant := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;

         FOR reg IN (SELECT e.cpregun, e.crespue, e.trespue, e.nriesgo
                       FROM estseguros s, estpregunseg e, pregunpro p
                      WHERE e.sseguro = psseguro
                        AND e.nmovimi = pnmovimi
                        AND s.sseguro = e.sseguro
                        AND p.sproduc = s.sproduc
                        AND p.cpretip = 1
                        AND e.nriesgo IN (
                               SELECT er.nriesgo
                                 FROM estriesgos er
                                WHERE er.sseguro = psseguro
                                  AND er.fanulac IS NULL)
                     MINUS
                     SELECT e.cpregun, e.crespue, e.trespue, e.nriesgo
                       FROM seguros s, pregunseg e, pregunpro p
                      WHERE e.sseguro = pssegpol
                        AND s.sseguro = e.sseguro
                        AND p.sproduc = s.sproduc
                        AND p.cpretip = 1
                        AND e.nriesgo IN (
                               SELECT r.nriesgo
                                 FROM riesgos r
                                WHERE r.sseguro = pssegpol
                                  AND r.fanulac IS NULL)
                        AND e.nmovimi = (SELECT MAX (nmovimi)
                                           FROM pregunseg
                                          WHERE sseguro = pssegpol))
         LOOP
            vantes := NULL;
            vdespues := NULL;
            vcgarant := 0;
            vnriesgo := reg.nriesgo;
            num_err := f_despregunta (reg.cpregun, pcidioma, literal);

            BEGIN
               SELECT crespue, trespue
                 INTO v_crespue_desp, v_trespues_desp
                 FROM estpregunseg e
                WHERE e.sseguro = psseguro
                  AND e.nmovimi = pnmovimi
                  AND e.nriesgo = NVL (reg.nriesgo, 1)
                  AND e.cpregun = reg.cpregun;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_crespue_desp := NULL;
            END;

            BEGIN
               SELECT crespue, trespue
                 INTO v_crespue_antes, v_trespues_antes
                 FROM pregunseg e
                WHERE e.sseguro = pssegpol
                  AND e.nmovimi = (SELECT MAX (nmovimi)
                                     FROM pregunseg
                                    WHERE sseguro = pssegpol)
                  AND e.nriesgo = NVL (reg.nriesgo, 1)
                  AND e.cpregun = reg.cpregun;
            EXCEPTION
               WHEN OTHERS
               THEN
                  v_crespue_antes := NULL;
            END;

            vcpregun := vcpregun + 1;

            IF v_crespue_antes IS NOT NULL
            THEN
               v_trespues_antes := NULL;
               num_err :=
                  f_desrespuesta (v_crespue_antes,
                                  reg.cpregun,
                                  pcidioma,
                                  v_trespues_antes
                                 );

               IF num_err <> 0
               THEN
                  v_trespues_antes := v_crespue_antes;
               END IF;
            END IF;

            vantes := literal || ' ' || v_trespues_antes;

            IF v_crespue_desp IS NOT NULL
            THEN
               v_trespues_desp := NULL;
               num_err :=
                  f_desrespuesta (v_crespue_desp,
                                  reg.cpregun,
                                  pcidioma,
                                  v_trespues_desp
                                 );

               IF num_err <> 0
               THEN
                  v_trespues_desp := v_crespue_desp;
               END IF;
            END IF;

            vdespues := literal || ' ' || v_trespues_desp;
            vnriesgo := 1;
            vcgarant := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      --ETM fin --12/11/2013
      ELSIF pcmotmov = 420
      THEN
         vnorden := 0;
         vseparador := ' - ';

         -- con esta select ya se recuperan los registros que se han modificado,
         -- pues si entra por el pcmotmov = 420 es porque realmente ha habido un
         -- cambio de vehiculo (se ha detectado el cambio en la select de la
         -- tabla pds_supl_validacio) por lo que no es necesario poner las mismas
         -- select o parecidas que en la tabla pds_supl_validacio
         -- para este suplemento no hay registros que se dan de baja o alta, solo
         -- se modifican sus datos
         FOR c IN (SELECT e.nriesgo, e.nmovimi
                     FROM estautriesgos e
                    WHERE e.sseguro = psseguro AND e.nmovimi = pnmovimi)
         LOOP
            BEGIN
               SELECT    DECODE (v.cmarca,
                                 ev.cmarca, NULL,
                                    f_axis_literales (9001046, 2)
                                 || ': '
                                 || pac_autos.f_desmarca (v.cmarca)
                                 || ' ('
                                 || v.cmarca
                                 || ')'
                                 || vseparador
                                )
                      || DECODE (v.ctipveh,
                                 ev.ctipveh, NULL,
                                    f_axis_literales (9001060, 2)
                                 || ': '
                                 || pac_autos.f_destipveh (v.ctipveh, 2)
                                 || vseparador
                                )
                      || DECODE (v.cmodelo,
                                 ev.cmodelo, NULL,
                                    f_axis_literales (9001059, 2)
                                 || ': '
                                 || pac_autos.f_desmodelo (v.cmodelo,
                                                           v.cmarca)
                                 || vseparador
                                )
                      || DECODE (v.cversion,
                                 ev.cversion, NULL,
                                    f_axis_literales (9001146, 2)
                                 || ': '
                                 || v.cversion
                                 || '-'
                                 || pac_autos.f_desversion (v.cversion)
                                 || vseparador
                                )
                      || DECODE (a.anyo,
                                 e.anyo, NULL,
                                    f_axis_literales (108515, 2)
                                 || ': '
                                 || a.anyo
                                 || vseparador
                                )
                      || DECODE (a.triesgo,
                                 e.triesgo, NULL,
                                    f_axis_literales (100588, 2)
                                 || ': '
                                 || a.triesgo
                                 || vseparador
                                ) antes,
                         DECODE (v.cmarca,
                                 ev.cmarca, NULL,
                                    f_axis_literales (9001046, 2)
                                 || ': '
                                 || pac_autos.f_desmarca (ev.cmarca)
                                 || ' ('
                                 || ev.cmarca
                                 || ')'
                                 || vseparador
                                )
                      || DECODE (v.ctipveh,
                                 ev.ctipveh, NULL,
                                    f_axis_literales (9001060, 2)
                                 || ': '
                                 || pac_autos.f_destipveh (ev.ctipveh, 2)
                                 || vseparador
                                )
                      || DECODE (v.cmodelo,
                                 ev.cmodelo, NULL,
                                    f_axis_literales (9001059, 2)
                                 || ': '
                                 || pac_autos.f_desmodelo (ev.cmodelo,
                                                           ev.cmarca
                                                          )
                                 || vseparador
                                )
                      || DECODE (v.cversion,
                                 ev.cversion, NULL,
                                    -- Bug 31686/178769 - 03/07/2014- AMC
                                    f_axis_literales (9001146, 2)
                                 || ': '
                                 || ev.cversion
                                 || '-'
                                 || pac_autos.f_desversion (ev.cversion)
                                 || vseparador
                                )
                      || DECODE (a.anyo,
                                 e.anyo, NULL,
                                    f_axis_literales (108515, 2)
                                 || ': '
                                 || e.anyo
                                 || vseparador
                                )
                      || DECODE (a.triesgo,
                                 e.triesgo, NULL,
                                    f_axis_literales (100588, 2)
                                 || ': '
                                 || e.triesgo
                                 || vseparador
                                ) despues
                 INTO vantes,
                      vdespues
                 FROM autriesgos a,
                      aut_versiones v,
                      estautriesgos e,
                      aut_versiones ev
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cversion = v.cversion
                  AND e.sseguro = psseguro
                  AND e.nriesgo = c.nriesgo
                  AND e.nmovimi = pnmovimi
                  AND e.cversion = ev.cversion;

               -- todos los campos deben tener el vseparador al final en la select
               -- aqui en cuando se elimina el vseparador del ultimo campo
               vantes := SUBSTR (vantes, 1, INSTR (vantes, vseparador, -1));
               vdespues :=
                         SUBSTR (vdespues, 1, INSTR (vdespues, vseparador, -1));
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
                  vdespues := NULL;
            END;

            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 11/03/2013
      -- Bug 25840 - APD - 11/03/2013 - se anade el suplemento 420.-Cambio de Codigo FaseColda
      ELSIF pcmotmov = 421
      THEN
         vnorden := 0;

         -- con esta select ya se recuperan los registros que se han modificado,
         -- pues si entra por el pcmotmov = 421 es porque realmente ha habido un
         -- cambio de Codigo FaseColda (se ha detectado el cambio en la select de la
         -- tabla pds_supl_validacio) por lo que no es necesario poner las mismas
         -- select o parecidas que en la tabla pds_supl_validacio
         -- para este suplemento no hay registros que se dan de baja o alta, solo
         -- se modifican sus datos
         FOR c IN (SELECT e.nriesgo, e.nmovimi
                     FROM estautriesgos e
                    WHERE e.sseguro = psseguro AND e.nmovimi = pnmovimi)
         LOOP
            BEGIN
               SELECT    DECODE (a.cversion,
                                 e.cversion, NULL,
                                    f_axis_literales (9904186, 2)
                                 || ': '
                                 || a.cversion
                                )
                      || ', '
                      || DECODE (a.triesgo,
                                 e.triesgo, NULL,
                                    f_axis_literales (100588, 2)
                                 || ': '
                                 || a.triesgo
                                 || vseparador
                                ) antes,
                         DECODE (a.cversion,
                                 e.cversion, NULL,
                                    f_axis_literales (9904186, 2)
                                 || ': '
                                 || e.cversion
                                )
                      || ', '
                      || DECODE (a.triesgo,
                                 e.triesgo, NULL,
                                    f_axis_literales (100588, 2)
                                 || ': '
                                 || e.triesgo
                                 || vseparador
                                ) despues
                 INTO vantes,
                      vdespues
                 FROM autriesgos a, estautriesgos e
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND e.sseguro = psseguro
                  AND e.nriesgo = c.nriesgo
                  AND e.nmovimi = pnmovimi;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
                  vdespues := NULL;
            END;

            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 11/03/2013

      -- Bug 25840 - APD - 12/03/2013 - se anade el suplemento 422.-Cambio de datos del vehiculo
      ELSIF pcmotmov = 422
      THEN
         vnorden := 0;
         vseparador := ' - ';

         -- con esta select ya se recuperan los registros que se han modificado,
         -- pues si entra por el pcmotmov = 422 es porque realmente ha habido un
         -- cambio de datos del vehiculo (se ha detectado el cambio en la select de la
         -- tabla pds_supl_validacio) por lo que no es necesario poner las mismas
         -- select o parecidas que en la tabla pds_supl_validacio
         -- para este suplemento no hay registros que se dan de baja o alta, solo
         -- se modifican sus datos
         FOR c IN (SELECT e.nriesgo, e.nmovimi
                     FROM estautriesgos e
                    WHERE e.sseguro = psseguro AND e.nmovimi = pnmovimi)
         LOOP
            BEGIN
               SELECT    DECODE (a.cuso,
                                 e.cuso, NULL,
                                    f_axis_literales (9001072, pcidioma)
                                 || ': '
                                 || pac_autos.f_desuso (a.cuso, pcidioma)
                                 || ' ('
                                 || pac_autos.f_dessubuso (a.csubuso,
                                                           pcidioma)
                                 || ') '
                                 || vseparador
                                )
                      || DECODE (a.fmatric,
                                 e.fmatric, NULL,
                                    f_axis_literales (9001074, pcidioma)
                                 || ': '
                                 || TO_CHAR (a.fmatric, 'dd/mm/yyyy')
                                 || vseparador
                                )
                      || DECODE (a.nkilometros,
                                 e.nkilometros, NULL,
                                    f_axis_literales (9001066, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (295,
                                                     pcidioma,
                                                     a.nkilometros
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.cvehnue,
                                 e.cvehnue, NULL,
                                    f_axis_literales (9001075, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (108,
                                                     pcidioma,
                                                     NVL (a.cvehnue, 0)
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ivehicu,
                                 e.ivehicu, NULL,
                                    f_axis_literales (9904878, pcidioma)
                                 || ': '
                                 || a.ivehicu
                                 || vseparador
                                )
                      || DECODE (a.npma,
                                 e.npma, NULL,
                                    f_axis_literales (9904881, pcidioma)
                                 || ': '
                                 || a.npma
                                 || vseparador
                                )
                      || DECODE (a.ntara,
                                 e.ntara, NULL,
                                    f_axis_literales (9001064, pcidioma)
                                 || ': '
                                 || a.ntara
                                 || vseparador
                                )
                      || DECODE (a.ccolor,
                                 e.ccolor, NULL,
                                    f_axis_literales (9001062, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (440, pcidioma, a.ccolor)
                                 || vseparador
                                )
                      || DECODE (a.nbastid,
                                 e.nbastid, NULL,
                                    f_axis_literales (9904877, pcidioma)
                                 || ': '
                                 || a.nbastid
                                 || vseparador
                                )
                      || DECODE (a.nplazas,
                                 e.nplazas, NULL,
                                    f_axis_literales (9904888, pcidioma)
                                 || ': '
                                 || a.nplazas
                                 || vseparador
                                )
                      || DECODE (a.cgaraje,
                                 e.cgaraje, NULL,
                                    f_axis_literales (9001078, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (296, pcidioma, a.cgaraje)
                                 || vseparador
                                )
                      || DECODE (NVL (a.cusorem, 0),
                                 NVL (e.cusorem, 0), NULL,
                                    f_axis_literales (9001067, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (108,
                                                     pcidioma,
                                                     NVL (a.cusorem, 0)
                                                    )
                                 || ' ('
                                 || ff_desvalorfijo (297,
                                                     pcidioma,
                                                     a.cremolque
                                                    )
                                 || ') '
                                 || vseparador
                                )
                      || DECODE (a.cpaisorigen,
                                 e.cpaisorigen, NULL,
                                    f_axis_literales (100816, pcidioma)
                                 || ': '
                                 || a.cpaisorigen
                                 || vseparador
                                )
                      || DECODE (a.cmotor,
                                 e.cmotor, NULL,
                                    f_axis_literales (9904880, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (291, pcidioma, a.cmotor)
                                 || vseparador
                                )
                      || DECODE (a.cchasis,
                                 e.cchasis, NULL,
                                    f_axis_literales (9904655, pcidioma)
                                 || ': '
                                 || a.cchasis
                                 || vseparador
                                )
                      || DECODE (a.ivehinue,
                                 e.ivehinue, NULL,
                                    f_axis_literales (9904886, pcidioma)
                                 || ': '
                                 || a.ivehinue
                                 || vseparador
                                )
                      || DECODE (a.nkilometraje,
                                 e.nkilometraje, NULL,
                                    f_axis_literales (9904723, pcidioma)
                                 || ': '
                                 || a.nkilometraje
                                 || vseparador
                                )
                      || DECODE (a.ccilindraje,
                                 e.ccilindraje, NULL,
                                    f_axis_literales (9904725, pcidioma)
                                 || ': '
                                 || a.ccilindraje
                                 || vseparador
                                )
                      || DECODE (a.cpintura,
                                 e.cpintura, NULL,
                                    f_axis_literales (9904728, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (760, pcidioma,
                                                     a.cpintura)
                                 || vseparador
                                )
                      || DECODE (a.ccaja,
                                 e.ccaja, NULL,
                                    f_axis_literales (9904729, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000907,
                                                     pcidioma,
                                                     a.ccaja
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ccampero,
                                 e.ccampero, NULL,
                                    f_axis_literales (9904730, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (758, pcidioma,
                                                     a.ccampero)
                                 || vseparador
                                )
                      || DECODE (a.ctipcarroceria,
                                 e.ctipcarroceria, NULL,
                                    f_axis_literales (9904731, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (761,
                                                     pcidioma,
                                                     a.ctipcarroceria
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.cservicio,
                                 e.cservicio, NULL,
                                    f_axis_literales (9904732, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000904,
                                                     pcidioma,
                                                     a.cservicio
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.corigen,
                                 e.corigen, NULL,
                                    f_axis_literales (9000443, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000905,
                                                     pcidioma,
                                                     a.corigen
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ctransporte,
                                 e.ctransporte, NULL,
                                    f_axis_literales (9904733, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (307,
                                                     pcidioma,
                                                     a.ctransporte
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.codmotor,
                                 e.codmotor, NULL,
                                    f_axis_literales (9904654, pcidioma)
                                 || ': '
                                 || a.codmotor
                                 || vseparador
                                )
                      || DECODE (a.cversion,
                                 NULL, NULL,
                                 DECODE (a.anyo,
                                         NULL, NULL,
                                         DECODE ((SELECT vcomercial
                                                    FROM aut_versiones_anyo
                                                   WHERE cversion = a.cversion
                                                     AND anyo = a.anyo),
                                                 (SELECT vcomercial
                                                    FROM aut_versiones_anyo
                                                   WHERE cversion = e.cversion
                                                     AND anyo = e.anyo), NULL,
                                                    f_axis_literales (9904726,
                                                                      pcidioma
                                                                     )
                                                 || ': '
                                                 || (SELECT vcomercial
                                                       FROM aut_versiones_anyo
                                                      WHERE cversion =
                                                                    a.cversion
                                                        AND anyo = a.anyo)
                                                 || vseparador
                                                )
                                        )
                                )
                      || DECODE (a.cversion,
                                 NULL, NULL,
                                 DECODE
                                       ((SELECT vcomercial
                                           FROM aut_versiones_anyo
                                          WHERE cversion = a.cversion
                                            AND anyo =
                                                   (SELECT MAX (anyo)
                                                      FROM aut_versiones_anyo d
                                                     WHERE d.cversion =
                                                                    a.cversion)),
                                        (SELECT vcomercial
                                           FROM aut_versiones_anyo
                                          WHERE cversion = e.cversion
                                            AND anyo =
                                                   (SELECT MAX (anyo)
                                                      FROM aut_versiones_anyo d
                                                     WHERE d.cversion =
                                                                    e.cversion)), NULL,
                                           f_axis_literales (9904727,
                                                             pcidioma)
                                        || ': '
                                        || (SELECT vcomercial
                                              FROM aut_versiones_anyo
                                             WHERE cversion = a.cversion
                                               AND anyo =
                                                      (SELECT MAX (anyo)
                                                         FROM aut_versiones_anyo d
                                                        WHERE d.cversion =
                                                                    a.cversion))
                                        || vseparador
                                       )
                                ) antes,
                         DECODE (a.cuso,
                                 e.cuso, NULL,
                                    f_axis_literales (9001072, pcidioma)
                                 || ': '
                                 || pac_autos.f_desuso (e.cuso, pcidioma)
                                 || ' ('
                                 || pac_autos.f_dessubuso (e.csubuso,
                                                           pcidioma)
                                 || ') '
                                 || vseparador
                                )
                      || DECODE (a.fmatric,
                                 e.fmatric, NULL,
                                    f_axis_literales (9001074, pcidioma)
                                 || ': '
                                 || TO_CHAR (e.fmatric, 'dd/mm/yyyy')
                                 || vseparador
                                )
                      || DECODE (a.nkilometros,
                                 e.nkilometros, NULL,
                                    f_axis_literales (9001066, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (295,
                                                     pcidioma,
                                                     e.nkilometros
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.cvehnue,
                                 e.cvehnue, NULL,
                                    f_axis_literales (9001075, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (108,
                                                     pcidioma,
                                                     NVL (e.cvehnue, 0)
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ivehicu,
                                 e.ivehicu, NULL,
                                    f_axis_literales (9904878, pcidioma)
                                 || ': '
                                 || e.ivehicu
                                 || vseparador
                                )
                      || DECODE (a.npma,
                                 e.npma, NULL,
                                    f_axis_literales (9904881, pcidioma)
                                 || ': '
                                 || e.npma
                                 || vseparador
                                )
                      || DECODE (a.ntara,
                                 e.ntara, NULL,
                                    f_axis_literales (9001064, pcidioma)
                                 || ': '
                                 || e.ntara
                                 || vseparador
                                )
                      || DECODE (a.ccolor,
                                 e.ccolor, NULL,
                                    f_axis_literales (9001062, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (440, pcidioma, e.ccolor)
                                 || vseparador
                                )
                      || DECODE (a.nbastid,
                                 e.nbastid, NULL,
                                    f_axis_literales (9904877, pcidioma)
                                 || ': '
                                 || e.nbastid
                                 || vseparador
                                )
                      || DECODE (a.nplazas,
                                 e.nplazas, NULL,
                                    f_axis_literales (9904888, pcidioma)
                                 || ': '
                                 || e.nplazas
                                 || vseparador
                                )
                      || DECODE (a.cgaraje,
                                 e.cgaraje, NULL,
                                    f_axis_literales (9001078, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (296, pcidioma, e.cgaraje)
                                 || vseparador
                                )
                      || DECODE (NVL (a.cusorem, 0),
                                 NVL (e.cusorem, 0), NULL,
                                    f_axis_literales (9001067, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (108,
                                                     pcidioma,
                                                     NVL (e.cusorem, 0)
                                                    )
                                 || ' ('
                                 || ff_desvalorfijo (297,
                                                     pcidioma,
                                                     e.cremolque
                                                    )
                                 || ') '
                                 || vseparador
                                )
                      || DECODE (a.cpaisorigen,
                                 e.cpaisorigen, NULL,
                                    f_axis_literales (100816, pcidioma)
                                 || ': '
                                 || e.cpaisorigen
                                 || vseparador
                                )
                      || DECODE (a.cmotor,
                                 e.cmotor, NULL,
                                    f_axis_literales (9904880, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (291, pcidioma, e.cmotor)
                                 || vseparador
                                )
                      || DECODE (a.cchasis,
                                 e.cchasis, NULL,
                                    f_axis_literales (9904655, pcidioma)
                                 || ': '
                                 || e.cchasis
                                 || vseparador
                                )
                      || DECODE (a.ivehinue,
                                 e.ivehinue, NULL,
                                    f_axis_literales (9904886, pcidioma)
                                 || ': '
                                 || e.ivehinue
                                 || vseparador
                                )
                      || DECODE (a.nkilometraje,
                                 e.nkilometraje, NULL,
                                    f_axis_literales (9904723, pcidioma)
                                 || ': '
                                 || e.nkilometraje
                                 || vseparador
                                )
                      || DECODE (a.ccilindraje,
                                 e.ccilindraje, NULL,
                                    f_axis_literales (9904725, pcidioma)
                                 || ': '
                                 || e.ccilindraje
                                 || vseparador
                                )
                      || DECODE (a.cpintura,
                                 e.cpintura, NULL,
                                    f_axis_literales (9904728, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (760, pcidioma,
                                                     e.cpintura)
                                 || vseparador
                                )
                      || DECODE (a.ccaja,
                                 e.ccaja, NULL,
                                    f_axis_literales (9904729, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000907,
                                                     pcidioma,
                                                     e.ccaja
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ccampero,
                                 e.ccampero, NULL,
                                    f_axis_literales (9904730, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (758, pcidioma,
                                                     e.ccampero)
                                 || vseparador
                                )
                      || DECODE (a.ctipcarroceria,
                                 e.ctipcarroceria, NULL,
                                    f_axis_literales (9904731, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (761,
                                                     pcidioma,
                                                     e.ctipcarroceria
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.cservicio,
                                 e.cservicio, NULL,
                                    f_axis_literales (9904732, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000904,
                                                     pcidioma,
                                                     e.cservicio
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.corigen,
                                 e.corigen, NULL,
                                    f_axis_literales (9000443, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (8000905,
                                                     pcidioma,
                                                     e.corigen
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.ctransporte,
                                 e.ctransporte, NULL,
                                    f_axis_literales (9904733, pcidioma)
                                 || ': '
                                 || ff_desvalorfijo (307,
                                                     pcidioma,
                                                     e.ctransporte
                                                    )
                                 || vseparador
                                )
                      || DECODE (a.codmotor,
                                 e.codmotor, NULL,
                                    f_axis_literales (9904654, pcidioma)
                                 || ': '
                                 || e.codmotor
                                 || vseparador
                                )
                      || DECODE (e.cversion,
                                 NULL, NULL,
                                 DECODE (e.anyo,
                                         NULL, NULL,
                                         DECODE ((SELECT vcomercial
                                                    FROM aut_versiones_anyo
                                                   WHERE cversion = a.cversion
                                                     AND anyo = a.anyo),
                                                 (SELECT vcomercial
                                                    FROM aut_versiones_anyo
                                                   WHERE cversion = e.cversion
                                                     AND anyo = e.anyo), NULL,
                                                    f_axis_literales (9904726,
                                                                      pcidioma
                                                                     )
                                                 || ': '
                                                 || (SELECT vcomercial
                                                       FROM aut_versiones_anyo
                                                      WHERE cversion =
                                                                    e.cversion
                                                        AND anyo = e.anyo)
                                                 || vseparador
                                                )
                                        )
                                )
                      || DECODE (e.cversion,
                                 NULL, NULL,
                                 DECODE
                                       ((SELECT vcomercial
                                           FROM aut_versiones_anyo
                                          WHERE cversion = a.cversion
                                            AND anyo =
                                                   (SELECT MAX (anyo)
                                                      FROM aut_versiones_anyo d
                                                     WHERE d.cversion =
                                                                    a.cversion)),
                                        (SELECT vcomercial
                                           FROM aut_versiones_anyo
                                          WHERE cversion = e.cversion
                                            AND anyo =
                                                   (SELECT MAX (anyo)
                                                      FROM aut_versiones_anyo d
                                                     WHERE d.cversion =
                                                                    e.cversion)), NULL,
                                           f_axis_literales (9904727,
                                                             pcidioma)
                                        || ': '
                                        || (SELECT vcomercial
                                              FROM aut_versiones_anyo
                                             WHERE cversion = e.cversion
                                               AND anyo =
                                                      (SELECT MAX (anyo)
                                                         FROM aut_versiones_anyo d
                                                        WHERE d.cversion =
                                                                    e.cversion))
                                        || vseparador
                                       )
                                ) despues
                 INTO vantes,
                      vdespues
                 FROM autriesgos a, estautriesgos e
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND e.sseguro = psseguro
                  AND e.nriesgo = c.nriesgo
                  AND e.nmovimi = pnmovimi;

               -- todos los campos deben tener el vseparador al final en la select
               -- aqui en cuando se elimina el vseparador del ultimo campo
               vantes := SUBSTR (vantes, 1, INSTR (vantes, vseparador, -1));
               vdespues :=
                         SUBSTR (vdespues, 1, INSTR (vdespues, vseparador, -1));
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
                  vdespues := NULL;
            END;

            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 12/03/2013
      -- Bug 25840 - APD - 19/02/2013 - se anade el suplemento 423.-Cambio de matricula
      ELSIF pcmotmov = 423
      THEN
         vnorden := 0;

         -- con esta select ya se recuperan los registros que se han modificado,
         -- pues si entra por el pcmotmov = 423 es porque realmente ha habido un
         -- cambio de matricula (se ha detectado el cambio en la select de la
         -- tabla pds_supl_validacio) por lo que no es necesario poner las mismas
         -- select o parecidas que en la tabla pds_supl_validacio
         -- para este suplemento no hay registros que se dan de baja o alta, solo
         -- se modifican sus datos
         FOR c IN (SELECT e.nriesgo, e.nmovimi
                     FROM estautriesgos e
                    WHERE e.sseguro = psseguro AND e.nmovimi = pnmovimi)
         LOOP
            BEGIN
               SELECT    ff_desvalorfijo (290, pcidioma, a.ctipmat)
                      || ' - '
                      || a.cmatric
                 INTO vantes
                 FROM autriesgos a
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo);
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
            END;

            BEGIN
               SELECT    ff_desvalorfijo (290, pcidioma, a.ctipmat)
                      || ' - '
                      || a.cmatric
                 INTO vdespues
                 FROM estautriesgos a
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi = c.nmovimi;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            literal := f_axis_literales (9001045, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 19/02/2013

      -- Bug 25840 - APD - 12/03/2013 - se anade el suplemento 424.-Cambio de accesorios
      ELSIF pcmotmov = 424
      THEN
         vnorden := 0;
         vseparador := ' - ';

         -- se recuperan los registros que se han modificado o se han anadido
         FOR c IN (SELECT nriesgo, caccesorio, ctipacc, fini, ivalacc,
                          tdesacc, casegurable
                     FROM estautdetriesgos a
                    WHERE a.sseguro = psseguro
                      AND a.nmovimi = pnmovimi
                      AND a.nriesgo IN (SELECT a1.nriesgo
                                          FROM autriesgos a1
                                         WHERE a1.sseguro = pssegpol)
                   MINUS
                   SELECT nriesgo, caccesorio, ctipacc, fini, ivalacc,
                          tdesacc, casegurable
                     FROM autdetriesgos a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo))
         LOOP
            BEGIN
               SELECT    f_axis_literales (9001364, 2)
                      || ': '
                      || ac.taccesorio
                      || vseparador
                      || f_axis_literales (108455, 2)
                      || ': '
                      || ff_desvalorfijo (292, pcidioma, a.ctipacc)
                      || vseparador
                      || f_axis_literales (9001365, 2)
                      || ': '
                      || a.ivalacc
                      || vseparador
                      || f_axis_literales (9904757, 2)
                      || ': '
                      || a.tdesacc
                      || vseparador
                      || f_axis_literales (9904752, 2)
                      || ': '
                      || ff_desvalorfijo (108,
                                          pcidioma,
                                          NVL (a.casegurable, 0)
                                         )
                 INTO vantes
                 FROM autdetriesgos a, aut_accesorios ac
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  --AND a.cversion = c.cversion
                  AND a.caccesorio = c.caccesorio
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND ac.cversion = 0
                  AND ac.caccesorio = a.caccesorio;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- caso que se haya anadido un registro
                  vantes := NULL;
            END;

            BEGIN
               SELECT    f_axis_literales (9001364, 2)
                      || ': '
                      || ac.taccesorio
                      || vseparador
                      || f_axis_literales (108455, 2)
                      || ': '
                      || ff_desvalorfijo (292, pcidioma, a.ctipacc)
                      || vseparador
                      || f_axis_literales (9001365, 2)
                      || ': '
                      || a.ivalacc
                      || vseparador
                      || f_axis_literales (9904757, 2)
                      || ': '
                      || a.tdesacc
                      || vseparador
                      || f_axis_literales (9904752, 2)
                      || ': '
                      || ff_desvalorfijo (108,
                                          pcidioma,
                                          NVL (a.casegurable, 0)
                                         )
                 INTO vdespues
                 FROM estautdetriesgos a, aut_accesorios ac
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  --AND a.cversion = c.cversion
                  AND a.caccesorio = c.caccesorio
                  AND a.nmovimi = pnmovimi
                  AND ac.cversion = 0
                  AND ac.caccesorio = a.caccesorio;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            --literal := f_axis_literales(9001362, pcidioma);
            --vantes := literal || ': ' || vantes;
            --vdespues := literal || ': ' || vdespues;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;

         -- se recuperan los registros que se han eliminado
         FOR c IN (SELECT a.nriesgo, a.nmovimi, a.caccesorio
                     FROM autdetriesgos a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND NOT EXISTS (
                             SELECT 1
                               FROM estautdetriesgos e
                              WHERE e.sseguro = psseguro
                                AND e.nriesgo = a.nriesgo
                                --  AND e.cversion = a.cversion
                                AND e.caccesorio = a.caccesorio
                                AND e.nmovimi = pnmovimi))
         LOOP
            BEGIN
               SELECT    f_axis_literales (9001364, 2)
                      || ': '
                      || ac.taccesorio
                      || vseparador
                      || f_axis_literales (108455, 2)
                      || ': '
                      || ff_desvalorfijo (292, pcidioma, a.ctipacc)
                      || vseparador
                      || f_axis_literales (9001365, 2)
                      || ': '
                      || a.ivalacc
                      || vseparador
                      || f_axis_literales (9904757, 2)
                      || ': '
                      || a.tdesacc
                      || vseparador
                      || f_axis_literales (9904752, 2)
                      || ': '
                      || ff_desvalorfijo (108,
                                          pcidioma,
                                          NVL (a.casegurable, 0)
                                         )
                 INTO vantes
                 FROM autdetriesgos a, aut_accesorios ac
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  --AND a.cversion = c.cversion
                  AND a.caccesorio = c.caccesorio
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND ac.cversion = 0
                  AND ac.caccesorio = a.caccesorio;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
            END;

            -- Siempre sera Null ya que se ha eliminado el registro
            vdespues := NULL;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 12/03/2013
      -- Bug 25840 - APD - 12/03/2013 - se anade el suplemento 425.-Cambio de dispositivos de seguridad
      ELSIF pcmotmov = 425
      THEN
         vnorden := 0;
         vseparador := ' - ';

         -- se recuperan los registros que se han modificado o se han anadido
         FOR c IN (SELECT nriesgo, cdispositivo, cpropdisp, finicontrato,
                          ncontrato
                     FROM estautdisriesgos e
                    WHERE e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND e.nriesgo IN (SELECT a1.nriesgo
                                          FROM autriesgos a1
                                         WHERE a1.sseguro = pssegpol)
                   MINUS
                   SELECT nriesgo, cdispositivo, cpropdisp, finicontrato,
                          ncontrato
                     FROM autdisriesgos a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo))
         LOOP
            BEGIN
               SELECT    f_axis_literales (112015, pcidioma)
                      || ': '
                      || d.tdispositivo
                      || vseparador
                      || f_axis_literales (9904764, pcidioma)
                      || ': '
                      || ff_desvalorfijo (8000912, pcidioma, a.cpropdisp)
                      || vseparador
                      || f_axis_literales (103717, pcidioma)
                      || ': '
                      || TO_CHAR (a.finicontrato, 'DD/MM/YYYY')
                      || vseparador
                      || f_axis_literales (9002195, pcidioma)
                      || ': '
                      || a.ncontrato
                 INTO vantes
                 FROM autdisriesgos a, aut_dispositivos d
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  --AND a.cversion = c.cversion
                  AND a.cdispositivo = c.cdispositivo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND d.cversion = 0
                  AND d.cdispositivo = a.cdispositivo;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- caso que se haya anadido un registro
                  vantes := NULL;
            END;

            BEGIN
               SELECT    f_axis_literales (112015, pcidioma)
                      || ': '
                      || d.tdispositivo
                      || vseparador
                      || f_axis_literales (9904764, pcidioma)
                      || ': '
                      || ff_desvalorfijo (8000912, pcidioma, a.cpropdisp)
                      || vseparador
                      || f_axis_literales (103717, pcidioma)
                      || ': '
                      || TO_CHAR (a.finicontrato, 'DD/MM/YYYY')
                      || vseparador
                      || f_axis_literales (9002195, pcidioma)
                      || ': '
                      || a.ncontrato
                 INTO vdespues
                 FROM estautdisriesgos a, aut_dispositivos d
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  --  AND a.cversion = c.cversion
                  AND a.cdispositivo = c.cdispositivo
                  AND a.nmovimi = pnmovimi
                  AND d.cversion = 0
                  AND d.cdispositivo = a.cdispositivo;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;

         -- se recuperan los registros que se han eliminado
         FOR c IN (SELECT a.nriesgo, a.nmovimi, a.cdispositivo
                     FROM autdisriesgos a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND NOT EXISTS (
                             SELECT 1
                               FROM estautdisriesgos e
                              WHERE e.sseguro = psseguro
                                AND e.nmovimi = pnmovimi
                                AND e.nriesgo = a.nriesgo
                                -- AND e.cversion = a.cversion
                                AND e.cdispositivo = a.cdispositivo))
         LOOP
            BEGIN
               SELECT    f_axis_literales (112015, pcidioma)
                      || ': '
                      || d.tdispositivo
                      || vseparador
                      || f_axis_literales (9904764, pcidioma)
                      || ': '
                      || ff_desvalorfijo (8000912, pcidioma, a.cpropdisp)
                      || vseparador
                      || f_axis_literales (103717, pcidioma)
                      || ': '
                      || TO_CHAR (a.finicontrato, 'DD/MM/YYYY')
                      || vseparador
                      || f_axis_literales (9002195, pcidioma)
                      || ': '
                      || a.ncontrato
                 INTO vantes
                 FROM autdisriesgos a, aut_dispositivos d
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  --AND a.cversion = c.cversion
                  AND a.cdispositivo = c.cdispositivo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND d.cversion = 0
                  AND d.cdispositivo = a.cdispositivo;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
            END;

            -- Siempre sera Null ya que se ha eliminado el registro
            vdespues := NULL;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 12/03/2013
      -- Bug 25840 - APD - 12/03/2013 - se anade el suplemento 426.-Cambio de direccion del conductor
      ELSIF pcmotmov = 426
      THEN
         vnorden := 0;

         -- se recuperan los registros que se han modificado o se han anadido
         FOR c IN (SELECT nriesgo, cdomici
                     FROM estautconductores a
                    WHERE a.sseguro = psseguro
                      AND a.nmovimi = pnmovimi
                      AND a.nriesgo IN (SELECT a1.nriesgo
                                          FROM autriesgos a1
                                         WHERE a1.sseguro = pssegpol)
                      AND a.cprincipal = 1
                   MINUS
                   SELECT nriesgo, cdomici
                     FROM autconductores a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND a.cprincipal = 1)
         LOOP
            BEGIN
               SELECT    d.tdomici
                      || ', '
                      || d.cpostal
                      || ' '
                      || DECODE (d.cprovin,
                                 NULL, NULL,
                                 DECODE (d.cpoblac,
                                         NULL, NULL,
                                         (SELECT TRIM (tpoblac)
                                            FROM poblaciones
                                           WHERE cprovin = d.cprovin
                                             AND cpoblac = d.cpoblac)
                                        )
                                )
                 INTO vantes
                 FROM autconductores a, per_direcciones d
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cprincipal = 1
                  AND a.sperson = d.sperson
                  AND a.cdomici = d.cdomici;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- caso que se haya anadido un registro
                  vantes := NULL;
            END;

            BEGIN
               SELECT    d.tdomici
                      || ', '
                      || d.cpostal
                      || ' '
                      || DECODE (d.cprovin,
                                 NULL, NULL,
                                 DECODE (d.cpoblac,
                                         NULL, NULL,
                                         (SELECT TRIM (tpoblac)
                                            FROM poblaciones
                                           WHERE cprovin = d.cprovin
                                             AND cpoblac = d.cpoblac)
                                        )
                                )
                 INTO vdespues
                 FROM estautconductores a, estper_direcciones d
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi = pnmovimi
                  AND a.cprincipal = 1
                  AND a.sperson = d.sperson
                  AND a.cdomici = d.cdomici;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            literal := f_axis_literales (101078, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;

         -- se recuperan los registros que se han eliminado (aunque en ese caso no se dar?
         -- esta funcionalidad, la dejamos por si acaso)
         FOR c IN (SELECT nriesgo, cdomici
                     FROM autconductores a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND a.cprincipal = 1
                      AND NOT EXISTS (
                             SELECT 1
                               FROM estautconductores e
                              WHERE e.sseguro = psseguro
                                AND e.nmovimi = pnmovimi
                                AND e.nriesgo = a.nriesgo
                                AND e.cprincipal = a.cprincipal))
         LOOP
            BEGIN
               SELECT    d.tdomici
                      || ', '
                      || d.cpostal
                      || ' '
                      || DECODE (d.cprovin,
                                 NULL, NULL,
                                 DECODE (d.cpoblac,
                                         NULL, NULL,
                                         (SELECT TRIM (tpoblac)
                                            FROM poblaciones
                                           WHERE cprovin = d.cprovin
                                             AND cpoblac = d.cpoblac)
                                        )
                                )
                 INTO vantes
                 FROM autconductores a, per_direcciones d
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cprincipal = 1
                  AND a.sperson = d.sperson
                  AND a.cdomici = d.cdomici;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
            END;

            -- Siempre sera Null ya que se ha eliminado el registro
            vdespues := NULL;
            literal := f_axis_literales (101078, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- fin Bug 25840 - APD - 12/03/2013

      -- Bug 26740/142775 - 25/04/2013 - AMC
      ELSIF pcmotmov = 427
      THEN
         vnorden := 0;

         -- se recuperan los registros que se han modificado o se han anadido
         FOR c IN (SELECT nriesgo, exper_manual, exper_sinie_manual
                     FROM estautconductores a
                    WHERE a.sseguro = psseguro
                      AND a.nmovimi = pnmovimi
                      AND a.nriesgo IN (SELECT a1.nriesgo
                                          FROM autriesgos a1
                                         WHERE a1.sseguro = pssegpol)
                      AND a.cprincipal = 1
                   MINUS
                   SELECT nriesgo, exper_manual, exper_sinie_manual
                     FROM autconductores a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND a.cprincipal = 1)
         LOOP
            BEGIN
               SELECT exper_manual
                 INTO vantes
                 FROM autconductores a
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cprincipal = 1;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- caso que se haya anadido un registro
                  vantes := NULL;
            END;

            BEGIN
               SELECT exper_manual
                 INTO vdespues
                 FROM estautconductores a
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi = pnmovimi
                  AND a.cprincipal = 1;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            ---INI bug 31686#c181829, jds 19/08/2014,
            IF NVL (vantes, -1) <> NVL (vdespues, -1)
            THEN
               literal := f_axis_literales (9905038, pcidioma);
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;
               vnriesgo := c.nriesgo;
               vcgarant := 0;
               vcpregun := 0;
               vnorden := vnorden + 1;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vnorden
                                 );
            END IF;

            BEGIN
               SELECT d.tatribu
                 INTO vantes
                 FROM autconductores a, detvalores d
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cprincipal = 1
                  AND d.catribu = a.exper_sinie_manual
                  AND d.cidioma = pcidioma
                  AND d.cvalor = 800080;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- caso que se haya anadido un registro
                  vantes := NULL;
            END;

            BEGIN
               SELECT d.tatribu
                 INTO vdespues
                 FROM estautconductores a, detvalores d
                WHERE a.sseguro = psseguro
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi = pnmovimi
                  AND a.cprincipal = 1
                  AND d.catribu = a.exper_sinie_manual
                  AND d.cidioma = pcidioma
                  AND d.cvalor = 800080;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vdespues := NULL;
            END;

            IF NVL (vantes, -1) <> NVL (vdespues, -1)
            THEN
               literal := f_axis_literales (9906559, pcidioma);
               vantes := literal || ': ' || vantes;
               vdespues := literal || ': ' || vdespues;
               vnriesgo := c.nriesgo;
               vcgarant := 0;
               vcpregun := 0;
               vnorden := vnorden + 1;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vnorden
                                 );
            END IF;
         ---FI bug 31686#c181829, jds 19/08/2014,
         END LOOP;

         -- se recuperan los registros que se han eliminado (aunque en ese caso no se dar?
         -- esta funcionalidad, la dejamos por si acaso)
         FOR c IN (SELECT nriesgo, exper_manual
                     FROM autconductores a
                    WHERE a.sseguro = pssegpol
                      AND a.nmovimi =
                             (SELECT MAX (a1.nmovimi)
                                FROM autriesgos a1
                               WHERE a1.sseguro = a.sseguro
                                 AND a1.nriesgo = a.nriesgo)
                      AND a.cprincipal = 1
                      AND NOT EXISTS (
                             SELECT 1
                               FROM estautconductores e
                              WHERE e.sseguro = psseguro
                                AND e.nmovimi = pnmovimi
                                AND e.nriesgo = a.nriesgo
                                AND e.cprincipal = a.cprincipal))
         LOOP
            BEGIN
               SELECT exper_manual
                 INTO vantes
                 FROM autconductores a
                WHERE a.sseguro = pssegpol
                  AND a.nriesgo = c.nriesgo
                  AND a.nmovimi =
                         (SELECT MAX (a1.nmovimi)
                            FROM autriesgos a1
                           WHERE a1.sseguro = a.sseguro
                             AND a1.nriesgo = a.nriesgo)
                  AND a.cprincipal = 1;
            EXCEPTION
               WHEN OTHERS
               THEN
                  -- por si falla la select
                  vantes := NULL;
            END;

            -- Siempre sera Null ya que se ha eliminado el registro
            vdespues := NULL;
            literal := f_axis_literales (9905038, pcidioma);
            vantes := literal || ': ' || vantes;
            vdespues := literal || ': ' || vdespues;
            vnriesgo := c.nriesgo;
            vcgarant := 0;
            vcpregun := 0;
            vnorden := vnorden + 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vnorden
                              );
         END LOOP;
      -- Bug 26740/142775 - 25/04/2013 - AMC
      ELSIF pcmotmov IN (730)
      THEN
         FOR g IN (SELECT g.crevali crevalia, g.prevali prevalia,
                          g.irevali irevalia, e.crevali crevalid,
                          e.prevali prevalid, e.irevali irevalid, g.cgarant,
                          g.nriesgo
                     FROM garanseg g, estgaranseg e
                    WHERE g.sseguro = pssegpol
                      AND g.nmovimi =
                             (SELECT MAX (g1.nmovimi)
                                FROM garanseg g1
                               WHERE g1.sseguro = g.sseguro
                                 AND g1.nriesgo = g.nriesgo
                                 AND g1.cgarant = g.cgarant)
                      AND e.sseguro = psseguro
                      AND e.nmovimi = pnmovimi
                      AND e.nriesgo = g.nriesgo
                      AND e.cgarant = g.cgarant
                      AND e.cobliga = 1
                      AND (   NVL (g.crevali, 0) <> NVL (e.crevali, 0)
                           OR NVL (g.prevali, 0) <> NVL (e.prevali, 0)
                           OR NVL (g.irevali, 0) <> NVL (e.irevali, 0)
                          )
                      AND g.nriesgo IN (
                              SELECT r.nriesgo
                                FROM riesgos r
                               WHERE r.sseguro = pssegpol
                                     AND r.fanulac IS NULL)
                      AND e.nriesgo IN (
                             SELECT er.nriesgo
                               FROM estriesgos er
                              WHERE er.sseguro = psseguro
                                AND er.fanulac IS NULL))
         LOOP
            literal :=
                  f_axis_literales (101431, pcidioma)
               || ' '
               || f_axis_literales (100561, pcidioma);
            vantes :=
                  literal
               || ' - '
               || ff_desgarantia (g.cgarant, pcidioma)
               || ': '
               || ff_desvalorfijo (62, pcidioma, g.crevalia);

            IF g.prevalia IS NOT NULL
            THEN
               IF g.crevalia = 1
               THEN
                  vantes :=
                        vantes
                     || ' - '
                     || TO_CHAR (NVL (g.irevalia, 0), 'FM999G999G999G990D00');
               ELSIF g.crevalia IN (2, 6, 14, 17)
               THEN
                  vantes := vantes || ' - ' || NVL (g.prevalia, 0) || '%';
               ELSE
                  vantes := vantes;
               END IF;
            END IF;

            vdespues :=
                  literal
               || ' - '
               || ff_desgarantia (g.cgarant, pcidioma)
               || ': '
               || ff_desvalorfijo (62, pcidioma, g.crevalid);

            IF g.prevalid IS NOT NULL
            THEN
               IF g.crevalid = 1
               THEN
                  vdespues :=
                        vdespues
                     || ' - '
                     || TO_CHAR (NVL (g.irevalid, 0), 'FM999G999G999G990D00');
               ELSIF g.crevalid IN (2, 6, 14, 17)
               THEN
                  vdespues := vdespues || ' - ' || NVL (g.prevalid, 0) || '%';
               ELSE
                  vdespues := vdespues;
               END IF;
            END IF;

            vnriesgo := g.nriesgo;
            vcgarant := g.cgarant;
            vcpregun := 0;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      -- INI BUG: 0034462 - AFM
      ELSIF pcmotmov IN (962)
      THEN
         -- Suplemento cambio de convenios
         FOR g IN (SELECT e.idversion version_act, c.idversion version_ant
                     FROM estcnv_conv_emp_seg e, cnv_conv_emp_seg c
                    WHERE e.sseguro = psseguro
                      AND c.sseguro = pssegpol
                      AND c.nmovimi = (SELECT MAX (nmovimi)
                                         FROM cnv_conv_emp_seg
                                        WHERE sseguro = pssegpol)
                      AND e.nmovimi = (SELECT MAX (nmovimi)
                                         FROM estcnv_conv_emp_seg
                                        WHERE sseguro = psseguro))
         LOOP
            IF g.version_act <> g.version_ant
            THEN
               -- BUG 0034462 - FAL - 08/04/2015
               SELECT nversion
                 INTO vdespues2
                 FROM cnv_conv_emp_vers
                WHERE idversion = g.version_act;

               SELECT nversion
                 INTO vantes2
                 FROM cnv_conv_emp_vers
                WHERE idversion = g.version_ant;

               -- FI BUG 0034462 - FAL - 08/04/2015
               literal := f_axis_literales (9001146, pcidioma);     -- Version
               vantes :=
                     literal
                  || ': '
                  || g.version_ant
                  || ', '
                  || f_axis_literales (9000577, pcidioma)
                  || ': '
                  || vantes2;                -- BUG 0034462 - FAL - 08/04/2015
               vdespues :=
                     literal
                  || ': '
                  || g.version_act
                  || ', '
                  || f_axis_literales (9000577, pcidioma)
                  || ': '
                  || vdespues2;              -- BUG 0034462 - FAL - 08/04/2015
               vnriesgo := 0;
               vcgarant := 0;
               vcpregun := 0;
               vnorden := vnorden + 1;
               p_insdetmovseguro (psseguro,
                                  pnmovimi,
                                  pcmotmov,
                                  vnriesgo,
                                  vcgarant,
                                  vantes,
                                  vdespues,
                                  vnorden
                                 );
            END IF;
         END LOOP;
      ELSIF pcmotmov IN (601)
      THEN
         -- Suplemento de Regularizaci?n
         BEGIN
            SELECT SUM (iprianu)
              INTO v_iprianu
              FROM estgaranseg
             WHERE sseguro = psseguro AND nmovimi = pnmovimi;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               v_iprianu := 0;
            WHEN OTHERS
            THEN
               v_iprianu := 0;
         END;

         --
         literal := f_axis_literales (103335, pcidioma);   -- Regularizaciones
         vantes := literal || ': ' || 0;
         vdespues := literal || ': ' || v_iprianu;
         vnriesgo := 0;
         vcgarant := 0;
         vcpregun := 0;
         vnorden := vnorden + 1;
         --
         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            vnriesgo,
                            vcgarant,
                            vantes,
                            vdespues,
                            vnorden
                           );
      -- FIN BUG: 0034462 - AFM
      -- Bug 36596/211327 - IGIL INI
      ELSIF pcmotmov IN (970)
      THEN
         BEGIN
            vcgarant := 0;
            literal := f_axis_literales (9905523, pcidioma);
            literal1 := f_axis_literales (9908311, pcidioma);
            literal2 := f_axis_literales (9908320, pcidioma);
            literal3 := f_axis_literales (9908321, pcidioma);

            FOR reg IN (SELECT a.cestado_des, c.cestado cestado_ant,
                               a.feviden_des, c.feviden feviden_ant,
                               a.cpago_des, c.cpago cpago_ant, a.ieviden_des,
                               c.ieviden ieviden_ant, a.evidencia
                          FROM (SELECT e.cestado cestado_des,
                                       e.feviden feviden_des,
                                       e.cpago cpago_des,
                                       e.ieviden ieviden_des, e.speraseg,
                                       e.ceviden, e.norden, e.nmovimi,
                                       e.sseguro, pssegpol segpol,
                                       (SELECT MAX (nmovimi)
                                          FROM citamedica_undw
                                         WHERE sseguro = pssegpol)
                                                            nmovimi_pol_real,
                                          evi.codevid
                                       || ' - '
                                       || evi.teviden evidencia
                                  FROM estcitamedica_undw e,
                                       desevidencias_udw evi
                                 WHERE e.sseguro = psseguro
                                   AND e.nmovimi = pnmovimi
                                   AND e.ceviden = evi.ceviden
                                   AND evi.cidioma = pcidioma) a
                               FULL OUTER JOIN
                               citamedica_undw c
                               ON c.sseguro = a.segpol
                             AND c.ceviden = a.ceviden
                             AND c.speraseg = a.speraseg
                             AND c.norden = a.norden
                             AND c.nmovimi = a.nmovimi_pol_real
                         WHERE (c.sseguro = pssegpol OR a.sseguro = psseguro
                               )
                           AND (   c.nmovimi = (SELECT MAX (nmovimi)
                                                  FROM citamedica_undw
                                                 WHERE sseguro = pssegpol)
                                OR a.nmovimi = pnmovimi
                               ))
            LOOP
               BEGIN
                  vantes := reg.evidencia || ' -> ';
                  vdespues := reg.evidencia || ' -> ';

                  IF    reg.cestado_ant <> reg.cestado_des
                     OR reg.cestado_ant IS NULL
                     OR reg.cestado_des IS NULL
                  THEN
                     vantes :=
                           vantes
                        || literal
                        || ' : '
                        || pac_md_listvalores.f_getdescripvalores
                                                             (8001025,
                                                              reg.cestado_ant,
                                                              mensajes
                                                             );
                     vdespues :=
                           vdespues
                        || literal
                        || ' : '
                        || pac_md_listvalores.f_getdescripvalores
                                                             (8001025,
                                                              reg.cestado_des,
                                                              mensajes
                                                             );
                  END IF;

                  IF    reg.feviden_ant <> reg.feviden_des
                     OR reg.feviden_ant IS NULL
                     OR reg.feviden_des IS NULL
                  THEN
                     vantes :=
                           vantes
                        || ' >'
                        || literal1
                        || ' : '
                        || TO_CHAR (reg.feviden_ant, 'dd/MM/yyyy HH24:mi:ss');
                     vdespues :=
                           vdespues
                        || ' >'
                        || literal1
                        || ' : '
                        || TO_CHAR (reg.feviden_des, 'dd/MM/yyyy HH24:mi:ss');
                  END IF;

                  IF    reg.cpago_ant <> reg.cpago_des
                     OR reg.cpago_ant IS NULL
                     OR reg.cpago_des IS NULL
                  THEN
                     vantes :=
                           vantes
                        || ' >'
                        || literal2
                        || ' : '
                        || NVL
                              (pac_md_listvalores.f_getdescripvalores
                                                               (8001028,
                                                                reg.cpago_ant,
                                                                mensajes
                                                               ),
                               reg.cpago_ant
                              );
                     vdespues :=
                           vdespues
                        || ' >'
                        || literal2
                        || ' : '
                        || NVL
                              (pac_md_listvalores.f_getdescripvalores
                                                               (8001028,
                                                                reg.cpago_des,
                                                                mensajes
                                                               ),
                               reg.cpago_des
                              );
                  END IF;

                  IF    reg.ieviden_ant <> reg.ieviden_des
                     OR reg.ieviden_ant IS NULL
                     OR reg.ieviden_des IS NULL
                  THEN
                     vantes :=
                        vantes || ' >' || literal3 || ' : '
                        || reg.ieviden_ant;
                     vdespues :=
                        vdespues || ' >' || literal3 || ' : '
                        || reg.ieviden_des;
                  END IF;

                  IF     reg.ieviden_ant IS NULL
                     AND reg.cpago_ant IS NULL
                     AND reg.feviden_ant IS NULL
                     AND reg.cestado_ant IS NULL
                  THEN
                     vantes := ' ';
                  END IF;

                  IF     reg.ieviden_des IS NULL
                     AND reg.cpago_des IS NULL
                     AND reg.feviden_des IS NULL
                     AND reg.cestado_des IS NULL
                  THEN
                     vdespues := ' ';
                  END IF;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     NULL;
               END;

               IF vantes <> vdespues
               THEN
                  p_insdetmovseguro (psseguro,
                                     pnmovimi,
                                     pcmotmov,
                                     NVL (vnriesgo, 1),
                                     vcgarant,
                                     vantes,
                                     vdespues,
                                     vcpregun
                                    );
                  vcpregun := vcpregun + 1;
               END IF;
            END LOOP;
         END;
        -- Bug 36596/211327 - IGIL FIN
      -- CONF-274-25/11/2016-JLTS- Ini
      ELSIF pcmotmov = pac_suspension.vcod_reinicio
      THEN                                                              -- 141
         BEGIN
            vcgarant := 0;
            vnriesgo := 0;

            SELECT    f_axis_literales (9904516,
                                        pac_md_common.f_get_cxtidioma)
                   || ' - '
                   || f_axis_literales (9904528,
                                        pac_md_common.f_get_cxtidioma)
                   || ' :'
                   || s.finicio
              INTO vantes
              FROM suspensionseg s
             WHERE s.sseguro = pssegpol
               AND s.nmovimi =
                      (SELECT MAX (s1.nmovimi)
                         FROM suspensionseg s1
                        WHERE s1.sseguro = s.sseguro
                          AND s1.ffinal IS NULL
                          AND s1.cmotmov = 391);
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               vantes := NULL;
         END;

         BEGIN
            SELECT    f_axis_literales (9904516,
                                        pac_md_common.f_get_cxtidioma)
                   || ' - '
                   || f_axis_literales (9909832,
                                        pac_md_common.f_get_cxtidioma)
                   || ' :'
                   || s.ffinal
              INTO vdespues
              FROM estsuspensionseg s
             WHERE s.sseguro = psseguro
               AND s.nmovimi =
                      (SELECT MAX (s1.nmovimi)
                         FROM estsuspensionseg s1
                        WHERE s1.sseguro = s.sseguro
                          AND s1.ffinal IS NOT NULL
                          AND s1.cmotmov = pac_suspension.vcod_reinicio);
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               vdespues := NULL;
         END;

         IF vantes <> vdespues
         THEN
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               NVL (vnriesgo, 1),
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
            vcpregun := vcpregun + 1;
         END IF;
      -- CONF-274-25/11/2016-JLTS- Fin
      END IF;

      --se a?aden movimientos para suplementos en las cargas de ARL, el insdetmovseguro lo har? en el gen?rico, por lo que no se excluyen de ah?.
      IF pcmotmov IN (950, 951, 952, 953, 954)
      THEN
         vnriesgo := 1;
         vcgarant := 0;
         vcpregun := 0;
      END IF;

      -- INI BUG: 35095 - PRB - 199894
      IF pcmotmov IN (964, 965)
      THEN
         SELECT COUNT (1)
           INTO v_segdisin2diff
           FROM (SELECT s.nriesgo, s.norden, s.nif, s.nombre, s.apellidos,
                        s.csexo, s.fnacim, s.falta, s.fbaja
                   FROM estasegurados_innom s
                  WHERE s.sseguro = psseguro AND s.nmovimi = pnmovimi
                 MINUS
                 SELECT a.nriesgo, a.norden, a.nif, a.nombre, a.apellidos,
                        a.csexo, a.fnacim, a.falta, a.fbaja
                   FROM asegurados_innom a
                  WHERE a.sseguro IN (SELECT es.ssegpol
                                        FROM estseguros es
                                       WHERE es.ssegpol = psseguro)
                    AND a.nmovimi IN (
                               SELECT MAX (m.nmovimi)
                                 FROM asegurados_innom m
                                WHERE m.sseguro IN (
                                                    SELECT e.ssegpol
                                                      FROM estseguros e
                                                     WHERE e.ssegpol =
                                                                      psseguro)));

         IF v_segdisin2diff <> 0
         THEN
            vantes := NULL;
            vdespues := f_axis_literales (9907627, pcidioma);
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END IF;
      END IF;

      IF pcmotmov IN (971)
      THEN                                                            --ramiro
          --BUG 23460: XVM :24/10/2012--INI
         ---------------------------- COACEDIDO
         vcgarant := 0;
         vnriesgo := 0;
         vcpregun := 0;

         FOR c IN coacuadro_real_acep
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT e.finicoa, e.ffincoa, e.ploccoa, e.fcuacoa, e.ccompan,
                      e.npoliza, e.nendoso, e.ploccoa, cc.pcescoa,
                      cc.ccompan ccompans
                 INTO vfinicoa, vffincoa, vploccoa, vfcuacoa, vccompan,
                      vnpoliza, vnendoso, vploccoa, vpcescoa,
                      vccompans
                 FROM estcoacuadro e, estcoacedido cc
                WHERE e.sseguro = psseguro
                  AND cc.sseguro = psseguro
                  AND e.ncuacoa = pnmovimi
                  AND ROWNUM = 1;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vdespues := 0;
            END;

            IF vdespues = 0
            THEN
               literal := f_axis_literales (105387, pcidioma);    --Coaseguro
               vantes := literal || '--';
               vdespues := literal || ': --';
               literal := f_axis_literales (9904485, pcidioma);
               --Inicio vigencia cuadro coaseguro
               vantes := vantes || literal || ': ' || c.finicoa;
               literal := f_axis_literales (9904486, pcidioma);
               --Final vigencia cuadro coaseguro
               vantes := vantes || ' - ' || literal || ': ' || c.ffincoa;
               literal := f_axis_literales (9904487, pcidioma);
               --Retenido en cedido o aceptado en aceptado
               vantes :=
                     vantes
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904488, pcidioma);
               --Alta del cuadro
               vantes := vantes || ' - ' || literal || ': ' || c.fcuacoa;
               literal := f_axis_literales (9904489, pcidioma);
               --Compania aceptado
               vantes :=
                  vantes || ' - ' || literal || ': '
                  || ff_descompania (c.ccompan);
               literal := f_axis_literales (9904490, pcidioma);
               --P?liza Origen del aceptado
               vantes := vantes || ' - ' || literal || ': ' || c.npoliza;
               literal := f_axis_literales (9905423, pcidioma);
               --Numero Endoso --ramiro
               vantes := vantes || ' - ' || literal || ': ' || c.nendoso;
            -- ramiro
            ELSE
               FOR f IN coacuadro_est_compa
               LOOP
                  IF (   (f.finicoa <> c.finicoa)
                      OR (f.ffincoa <> c.ffincoa)
                      OR (f.ploccoa <> c.ploccoa)
                      OR (f.fcuacoa <> c.fcuacoa)
                      OR (f.ccompan <> c.ccompan)
                      OR (f.npoliza <> c.npoliza)
                      OR (f.ploccoa <> c.ploccoa)
                      OR (f.ccompans <> c.ccompans)
                      OR (f.pcescoa <> c.pcescoa)
                     )
                  THEN
                     literal := f_axis_literales (105387, pcidioma);
                     --Coaseguro
                     vantes := literal || '--';
                     vdespues := literal || '--';
                     literal := f_axis_literales (9904485, pcidioma);
                     --Inicio vigencia cuadro coaseguro
                     vantes := vantes || literal || ': ' || c.finicoa;
                     vdespues := vdespues || literal || ': ' || f.finicoa;
                     literal := f_axis_literales (9904486, pcidioma);
                     --Final vigencia cuadro coaseguro
                     vantes :=
                              vantes || ' - ' || literal || ': ' || c.ffincoa;
                     vdespues :=
                            vdespues || ' - ' || literal || ': ' || f.ffincoa;
                     literal := f_axis_literales (9904487, pcidioma);
                     --Retenido en cedido o aceptado en aceptado
                     vantes :=
                           vantes
                        || ' - '
                        || literal
                        || ': '
                        || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
                     vdespues :=
                           vdespues
                        || ' - '
                        || literal
                        || ': '
                        || TO_CHAR (f.ploccoa, 'FM999G999G999G990D00');
                     literal := f_axis_literales (9904488, pcidioma);
                     --Alta del cuadro
                     vantes := vantes || ' - ' || literal || ': ' || c.fcuacoa;
                     vdespues :=
                             vdespues || ' - ' || literal || ': ' || f.fcuacoa;
                     literal := f_axis_literales (9904489, pcidioma);
                     --Compania aceptado
                     vantes :=
                           vantes
                        || ' - '
                        || literal
                        || ': '
                        || ff_descompania (c.ccompan);
                     vdespues :=
                           vdespues
                        || ' - '
                        || literal
                        || ': '
                        || ff_descompania (f.ccompan);
                     literal := f_axis_literales (9904490, pcidioma);
                     --P?liza Origen del aceptado
                     vantes := vantes || ' - ' || literal || ': ' || c.npoliza;
                     vdespues :=
                             vdespues || ' - ' || literal || ': ' || f.npoliza;
                     literal := f_axis_literales (9904490, pcidioma);
                     --P?liza Origen del aceptado
                     vantes := vantes || ' - ' || literal || ': ' || c.ploccoa;
                     literal := f_axis_literales (9904141, pcidioma);
                     vdespues :=
                             vdespues || ' - ' || literal || ': ' || f.ploccoa;
                     literal := f_axis_literales (9902917, pcidioma);
                     vdespues :=
                             vdespues || ' - ' || literal || ': ' || f.pcescoa;
                     literal := f_axis_literales (9909999, pcidioma);
                     vdespues :=
                             vdespues || ' - ' || literal || ': ' || f.pcescoa;
                     literal :=
                           vdespues
                        || ' - '
                        || literal
                        || ': '
                        || f_axis_literales (9905423, pcidioma);
                     --Endoso  --ramiro
                     vantes := vantes || ' - ' || literal || ': ' || c.nendoso;
                     --ramiro
                     vdespues :=
                              vdespues || ' - ' || literal || ': ' || vnendoso;
                  --ramiro
                  END IF;
               END LOOP;
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;

         FOR c IN coacuadro_est_acep
         LOOP
            vantes := NULL;
            vdespues := NULL;

            BEGIN
               SELECT co.finicoa, co.ffincoa, co.ploccoa, co.fcuacoa,
                      co.ccompan, co.npoliza, co.nendoso
                 INTO vfinicoa, vffincoa, vploccoa, vfcuacoa,
                      vccompan, vnpoliza, vnendoso
                 FROM coacuadro co
                WHERE co.sseguro = pssegpol
                  AND co.ncuacoa = (SELECT MAX (a.ncuacoa)
                                      FROM coacuadro a
                                     WHERE a.sseguro = pssegpol);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  vantes := 0;
            END;

            IF vantes = 0
            THEN
               literal := f_axis_literales (105387, pcidioma);    --Coaseguro
               vantes := literal || ': --';
               vdespues := literal || '--';
               literal := f_axis_literales (9904485, pcidioma);
               --Inicio vigencia cuadro coaseguro
               vdespues := vdespues || literal || ': ' || c.finicoa;
               literal := f_axis_literales (9904486, pcidioma);
               --Final vigencia cuadro coaseguro
               vdespues := vdespues || ' - ' || literal || ': ' || c.ffincoa;
               literal := f_axis_literales (9904487, pcidioma);
               --Retenido en cedido o aceptado en aceptado
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
               literal := f_axis_literales (9904488, pcidioma);
               --Alta del cuadro
               vdespues := vdespues || ' - ' || literal || ': ' || c.fcuacoa;
               literal := f_axis_literales (9904489, pcidioma);
               --Compania aceptado
               vdespues :=
                     vdespues
                  || ' - '
                  || literal
                  || ': '
                  || ff_descompania (c.ccompan);
               literal := f_axis_literales (9904490, pcidioma);
               --P?liza Origen del aceptado
               vdespues := vdespues || ' - ' || literal || ': ' || c.npoliza;
               literal := f_axis_literales (9905423, pcidioma);
               --Numero Endoso --ramiro
               vantes := vantes || ' - ' || literal || ': ' || c.nendoso;
                                                                     -- ramiro
            -- INI CONF-1309 / QT1824 CJMR
            ELSE
               literal := f_axis_literales (105387, pcidioma);    --Coaseguro
               vantes := literal || ': ';
               vdespues := literal || ': ';

               IF (vfinicoa <> c.finicoa)
               THEN
                  literal := f_axis_literales (9904485, pcidioma);
                  --Inicio vigencia cuadro coaseguro
                  vantes := vantes || ' - ' || literal || ': ' || vfinicoa;
                  vdespues :=
                            vdespues || ' - ' || literal || ': ' || c.finicoa;
               END IF;

               IF (vffincoa <> c.ffincoa)
               THEN
                  literal := f_axis_literales (9904486, pcidioma);
                  --Final vigencia cuadro coaseguro
                  vantes := vantes || ' - ' || literal || ': ' || vffincoa;
                  vdespues :=
                            vdespues || ' - ' || literal || ': ' || c.ffincoa;
               END IF;

               IF (vploccoa <> c.ploccoa)
               THEN
                  literal := f_axis_literales (9904487, pcidioma);
                  --Retenido en cedido o aceptado en aceptado
                  vantes := vantes || ' - ' || literal || ': ' || vploccoa;
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || TO_CHAR (c.ploccoa, 'FM999G999G999G990D00');
               END IF;

               IF (vfcuacoa <> c.fcuacoa)
               THEN
                  literal := f_axis_literales (9904488, pcidioma);
                  --Alta del cuadro
                  vantes := vantes || ' - ' || literal || ': ' || vfcuacoa;
                  vdespues :=
                            vdespues || ' - ' || literal || ': ' || c.fcuacoa;
               END IF;

               IF (vccompan <> c.ccompan)
               THEN
                  literal := f_axis_literales (9904489, pcidioma);
                  --Compania aceptado
                  vantes :=
                        vantes
                     || ' - '
                     || literal
                     || ': '
                     || ff_descompania (vccompan);
                  vdespues :=
                        vdespues
                     || ' - '
                     || literal
                     || ': '
                     || ff_descompania (c.ccompan);
               END IF;

               IF (vnpoliza <> c.npoliza)
               THEN
                  literal := f_axis_literales (9904490, pcidioma);
                  --P?liza Origen del aceptado
                  vantes := vantes || ' - ' || literal || ': ' || vnpoliza;
                  vdespues :=
                            vdespues || ' - ' || literal || ': ' || c.npoliza;
               END IF;

               IF (vnendoso <> c.nendoso)
               THEN
                  literal := f_axis_literales (9905423, pcidioma);
                  --Numero Endoso
                  vantes := vantes || ' - ' || literal || ': ' || vnendoso;
                  vdespues :=
                            vdespues || ' - ' || literal || ': ' || c.nendoso;
               END IF;
            -- FIN CONF-1309 / QT1824 CJMR
            END IF;

            vcpregun := vcpregun - 1;
            p_insdetmovseguro (psseguro,
                               pnmovimi,
                               pcmotmov,
                               vnriesgo,
                               vcgarant,
                               vantes,
                               vdespues,
                               vcpregun
                              );
         END LOOP;
      END IF;

-- FIN BUG: 35095 - PRB - 199894
-- Bug 10908 - 28/08/2009 - JMF afegir 687
-- Bug 16095 - 08/1/2010 - APD afegir 331
-- Bug 0016856 - 21/12/2010 - JMF afegir 690
-- Bug 0016544 - 27/12/2010 - JMF afegir 209
-- BUG 0017341 - 24/01/2011 - JMP afegir 691
-- BUG 0023460 - 24/10/2012 - XVM afegir 938 Coacedido
-- Bug 0025862 - 28/01/2013 - JMF afegir 827
-- Bug 25840 - APD - 19/02/2013 -- se anade el cmotmov = 423, 420, 422, 424, 425, 426
-- Bug 26737/142770  - 24/04/2013 - AMC - se anade 675
-- Bug 26740/142775 - 25/04/2013 - AMC - se anade 427
-- BUG: 0034462 - AFM se a?ade 602 y 962
-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-- ??????????? NOTA: PONER LOS CODIGOS ORDENADAMENTE !!!!!!!!!!!!!!
-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      IF pcmotmov NOT IN
            (pac_suspension.vcod_reinicio,
             -- CONF-274-25/11/2016-JLTS- Se insertar pac_suspension.vcod_reinicio (141)
             209,
             213,
             215,
             230,
             237,
             238,
             239,
             240,
             241,
             242,
             243,
             246,
             247,
             252,
             276,
             281,
             283,
             288,
             297,
             331,
             340,
             341,
             342,
             343,
             355,
             356,
             357,
             358,
             359,
             400,
             401,
             420,
             421,
             422,
             423,
             424,
             425,
             426,
             427,
             522,
             523,
             524,
             525,
             526,
             528,
             600,
             602,
             608,
             611,
             612,
             668,
             669,
             671,
             672,
             673,
             674,
             675,
             676,
             680,
             684,
             685,
             686,
             687,
             689,
             690,
             691,
             692,
             693,
             694,
             695,
             696,
             697,
             698,
             730,
             794,
             795,
             801,
             802,
             821,
             825,
             827,
             828,
             915,                               -- IAXIS-5423  CJMR 23/09/2019
             918,
             938,
             955,
             962,
             964,
             965,
             601,
             970,
             971
            )
      THEN
-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-- ??????????? NOTA: PONER LOS CODIGOS ORDENADAMENTE !!!!!!!!!!!!!!
-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--JRH 09/2007 Tarea 2674: Anadimos el 522 porque puede haber m?s de un registro por p?liza en las tablas de intereses
--Bug 11735 - RSC - 03/02/2010 - Anadimos el 237, 238
--BUG27304 - MMS - 20131104 - Anadimos 698
--BUG35095 - PRB - 199894 - Anadimos 964 965
         p_insdetmovseguro (psseguro,
                            pnmovimi,
                            pcmotmov,
                            NVL (vnriesgo, 1),
                            -- CONF-274-25/11/2016-JLTS- Se incluye el NVL..1
                            NVL (vcgarant, 0),
                            -- CONF-274-25/11/2016-JLTS- Se incluye el NVL..0
                            vantes,
                            vdespues,
                            vcpregun
                           );
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_grabar_detalle',
                      NVL (pcmotmov, 0),
                      'error no controlat',
                      SQLERRM
                     );
         RETURN vnriesgo;
   END f_grabar_detalle;

   FUNCTION f_siguientes_forms (
      psseguro   IN   NUMBER,
      psproduc   IN   NUMBER,
      pcmotmov   IN   NUMBER,
      ptform     IN   VARCHAR2,
      pcconfig   IN   VARCHAR2
   )
      RETURN NUMBER
   IS
      CURSOR sig
      IS
         SELECT   tform_sig tform
             FROM pds_supl_orden_form f
            WHERE f.cconfig = pcconfig AND f.tform = ptform
         ORDER BY norden;
   --Funci?n que inserta en la tabla temporal por p?liza
   -- para saber que pantallas a de visitar para finalizar
   -- correctamente el suplemento.
   BEGIN
      FOR c IN sig
      LOOP
         BEGIN
            INSERT INTO pds_estsigform
                        (sseguro, tform
                        )
                 VALUES (psseguro, c.tform
                        );
         EXCEPTION
            WHEN DUP_VAL_ON_INDEX
            THEN
               NULL;                    -- Si ja est? a la llista no l'afegim
            WHEN OTHERS
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_suplementos.f_siguientes_forms',
                            2,
                            'error no controlat',
                            SQLERRM
                           );
               RETURN 140999;                            --Error no controlado
         END;
      END LOOP;

      RETURN 0;
   END f_siguientes_forms;

   FUNCTION f_nuevos_suplementos (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      psproduc   IN   NUMBER,
      ptform     IN   VARCHAR2,
      pcconfig   IN   VARCHAR2
   )
      RETURN NUMBER
   IS
      CURSOR realizados
      IS
         SELECT cmotmov, fsuplem
           FROM pds_estsegurosupl
          WHERE sseguro = psseguro AND nmovimi = pnmovimi AND cestado = 'R';

      num_err   NUMBER;
   BEGIN
      FOR c IN realizados
      LOOP
         IF c.fsuplem IS NOT NULL
         THEN
            UPDATE pds_estsegurosupl
               SET cestado = 'F'
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND (   (fsuplem <> c.fsuplem AND cmotmov <> c.cmotmov)
                    OR (cmotmov IN (
                              SELECT cmotinc
                                FROM pds_suplincompatible
                               WHERE sproduc = psproduc
                                     AND cmotmov = c.cmotmov)
                       )
                   );
         END IF;

         UPDATE pds_estsegurosupl
            SET cestado = 'X'
          WHERE sseguro = psseguro
            AND nmovimi = pnmovimi
            AND cmotmov = c.cmotmov
            AND cestado = 'R';

         --llenamos la tabla de siguientes forms a visitar
         num_err :=
            f_siguientes_forms (psseguro,
                                psproduc,
                                c.cmotmov,
                                ptform,
                                pcconfig
                               );
      END LOOP;

      RETURN 0;
   END;

   /*
                                       {fin de la declaraciones privadas}
   */
   FUNCTION f_inicializar_fechas (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      psproduc   IN   NUMBER,
      pdate      IN   DATE DEFAULT NULL,
      pcmodo     IN   VARCHAR2 DEFAULT 'SUPLEMENTO',
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      CURSOR motivos
      IS
         SELECT cmotmov, ctipfec, tfecrec
           FROM pds_supl_config p,
                pds_supl_cod_config pd,
                pds_config_user pds
          WHERE pds.cuser = f_user
            AND pds.cconsupl = pd.cconsupl
            AND p.cconfig = pd.cconfig
            AND sproduc = psproduc
            AND p.cmotmov = pcmotmov;

      vfsuplem      DATE;
      num_err       NUMBER;
      vssegpol      NUMBER;
      vidversion    NUMBER;                                 -- BUG 34462 - AFM
      vfefectopol   DATE;                                   -- BUG 34462 - AFM
   BEGIN
      BEGIN
         SELECT ssegpol, fefecto
           INTO vssegpol, vfefectopol
           FROM estseguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 101919;             --Error al leer en la tabla de seguros
      END;

--      p_tab_error (f_sysdate,
--                   f_user,
--                   'PK_SUPLEMENTOS.f_inicializar_fechas 3',
--                   1,
--                   'traza',
--                   'psseguro = ' || psseguro || ' pcmotmov = ' || pcmotmov
--                  );
      FOR c IN motivos
      LOOP
--         p_tab_error (f_sysdate,
--                      f_user,
--                      'PK_SUPLEMENTOS.f_inicializar_fechas',
--                      2,
--                      'traza',
--                         'psseguro = '
--                      || psseguro
--                      || ' pcmotmov = '
--                      || c.cmotmov
--                      || 'ctipfec-->'
--                      || c.ctipfec
--                      || 'tfecrec-->'
--                      || c.tfecrec
--                     );
         IF pdate IS NULL
         THEN
            IF c.ctipfec = 0
            THEN
               vfsuplem := NULL;
--               p_tab_error (f_sysdate,
--                            f_user,
--                            'PK_SUPLEMENTOS.f_inicializar_fechas',
--                            3,
--                            'traza',
--                               'psseguro = '
--                            || psseguro
--                            || ' pcmotmov = '
--                            || c.cmotmov
--                            || 'ctipfec-->'
--                            || c.ctipfec
--                            || 'tfecrec-->'
--                            || c.tfecrec
--                            || ' vfsuplem-->'
--                            || vfsuplem
--                           );
            ELSE
               IF c.tfecrec = 'F_CAPITAL'
               THEN
                  num_err := f_capital (psproduc, psseguro, vfsuplem);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               4,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               ELSIF c.tfecrec = 'F_CFORPAG'
               THEN
                  num_err := f_cforpag (psproduc, psseguro, vfsuplem);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               5,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               ELSIF c.tfecrec = 'F_SYSDATE'
               THEN
                  vfsuplem := TRUNC (f_sysdate);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               6,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               ELSIF c.tfecrec = 'F_FCARPRO'
               THEN
                  num_err := f_fcarpro (vssegpol, vfsuplem);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               7,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               -- Bug 19808 - RSC - 10/11/2011 - Comprobamos si la fecha de fecto supera el m?ximo
               ELSIF c.tfecrec = 'F_FCARANU'
               THEN
                  num_err := f_fcaranu (vssegpol, vfsuplem);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               8,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               -- AFM INI RETRO
               ELSIF c.tfecrec = 'F_FVERSCONV'
               THEN
                  num_err :=
                     pk_suplementos.f_fversconv (vssegpol,
                                                 'EST',
                                                 vfsuplem,
                                                 vidversion
                                                );
                  vfsuplem := GREATEST (vfsuplem, vfefectopol);

--                  p_tab_error (f_sysdate,
--                               f_user,
--                               'PK_SUPLEMENTOS.f_inicializar_fechas',
--                               9,
--                               'traza',
--                                  'psseguro = '
--                               || psseguro
--                               || ' pcmotmov = '
--                               || c.cmotmov
--                               || 'ctipfec-->'
--                               || c.ctipfec
--                               || 'tfecrec-->'
--                               || c.tfecrec
--                               || ' vfsuplem-->'
--                               || vfsuplem
--                               || 'num_err'
--                               || num_err
--                              );
                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               -- AFM INI RETRO
               END IF;
            -- Fin Bug 19808
            END IF;
         ELSE
            vfsuplem := pdate;
--            p_tab_error (f_sysdate,
--                         f_user,
--                         'PK_SUPLEMENTOS.f_inicializar_fechas f',
--                         10,
--                         'traza',
--                            'psseguro = '
--                         || psseguro
--                         || ' pcmotmov = '
--                         || c.cmotmov
--                         || 'ctipfec-->'
--                         || c.ctipfec
--                         || 'tfecrec-->'
--                         || c.tfecrec
--                         || ' vfsuplem-->'
--                         || vfsuplem
--                         || 'num_err'
--                         || num_err
--                        );
         END IF;

--         p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_siguientes_forms',
--                      2,
--                      'fechat',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || c.cmotmov
--                      || 'vfsuplem-->'
--                      || vfsuplem
--                     );
         BEGIN
            INSERT INTO pds_estsegurosupl
                        (sseguro, nmovimi, cmotmov, fsuplem, cestado
                        )
                 VALUES (psseguro, pnmovimi, c.cmotmov, vfsuplem, 0
                        );
         EXCEPTION
            WHEN DUP_VAL_ON_INDEX
            THEN
               NULL;     --si ya existe es que est?n haciendo m?s suplementos
         END;
--         p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_siguientes_forms',
--                      2,
--                      'fechat 2',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || c.cmotmov
--                      || 'vfsuplem-->'
--                      || vfsuplem
--                     );
      END LOOP;

--      p_tab_error (f_sysdate,
--                   f_user,
--                   'pk_suplementos.f_siguientes_forms t',
--                   2,
--                   'fechat 3',
--                      ' psseguro-->'
--                   || psseguro
--                   || 'pnmovimi-->'
--                   || pnmovimi
--                   || ' c.cmotmov-->'
--                   || pcmotmov
--                   || 'vfsuplem-->'
--                   || vfsuplem
--                  );
      BEGIN
         INSERT INTO pds_estsegurosupl
                     (sseguro, nmovimi, cmotmov,
                      fsuplem, cestado
                     )
              VALUES (psseguro, pnmovimi, pcmotmov,
                      NVL (vfsuplem, f_sysdate), 0
                     );
      EXCEPTION
         WHEN DUP_VAL_ON_INDEX
         THEN
            NULL;        --si ya existe es que est?n haciendo m?s suplementos
      END;

--      p_tab_error (f_sysdate,
--                   f_user,
--                   'pk_suplementos.f_siguientes_forms',
--                   2,
--                   'fechat 4',
--                      ' psseguro-->'
--                   || psseguro
--                   || 'pnmovimi-->'
--                   || pnmovimi
--                   || ' c.cmotmov-->'
--                   || pcmotmov
--                   || 'vfsuplem-->'
--                   || vfsuplem
--                  );
      num_err :=
         f_validar_permite_suplemento (psseguro,
                                       pnmovimi,
                                       psproduc,
                                       pdate,
                                       pcmodo,
                                       pcmotmov
                                      );
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_inicializar_fechas',
                      3,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;
   END;

   FUNCTION f_validar_cambios (
      pcuser     IN   VARCHAR2,
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      psproduc   IN   NUMBER,
      ptform          VARCHAR2,
      pcmodo     IN   VARCHAR2,
      pcidioma   IN   NUMBER DEFAULT 2,
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      --Ini Bug.: 8947 - ICV - 28/05/2009.Se anade un nuevo parametro de entrada para diferenciar
      -- si este movimiento se valida a el mismo exclusivamente o si valida con el resto de movimientos del producto.
      CURSOR cambios (pcconfsupl IN VARCHAR2)
      IS
         SELECT   c.cmotmov, c.cconfig
             FROM pds_supl_cod_config cc, pds_supl_config c
            WHERE c.sproduc = psproduc
              AND cc.cconsupl = pcconfsupl
              AND cc.cconfig = c.cconfig
              AND (   (    pcmotmov IS NULL
                       -- BUG24726:DRA:05/02/2013:Inici
                       AND NOT EXISTS (
                              SELECT 1
                                FROM pds_estsegurosupl p
                               WHERE p.sseguro = psseguro
                                 AND p.nmovimi = pnmovimi
                                 AND p.cestado = 'X'
                                 AND p.cmotmov <> c.cmotmov
                                 AND p.cmotmov IN (
                                        SELECT cod.cmotmov
                                          FROM codimotmov cod
                                         WHERE cod.cmotmov = p.cmotmov
                                           AND cod.ctipval = 1))
                      )
                   -- BUG24726:DRA:05/02/2013:Fi
                   OR c.cmotmov IN DECODE ((SELECT ctipval
                                              FROM codimotmov cod
                                             WHERE cod.cmotmov = pcmotmov),
                                           0, (SELECT cod.cmotmov
                                                 FROM codimotmov cod
                                                WHERE cod.cmotmov = c.cmotmov
                                                  AND cod.ctipval = 0),
                                           pcmotmov
                                          )
                  )
         ORDER BY c.cmotmov;

      --Fin Bug.: 8947
      CURSOR selects (pcconfig IN VARCHAR2)
      IS
         SELECT   tselect
             FROM pds_supl_validacio
            WHERE cconfig = pcconfig
         ORDER BY nselect;

      pssegpol      NUMBER;
      mi_select     VARCHAR2 (1000);
      mi_cambio     NUMBER;
      mis_cambios   NUMBER;
      num_err       NUMBER;
      aux           NUMBER;

      TYPE t_cursor IS REF CURSOR;

      curs          t_cursor;
      c_cconfsupl   VARCHAR2 (50);
      v_select      VARCHAR2 (6000);
      testt         NUMBER;
      vcont         NUMBER;
      vpsaexec      NUMBER          := 0;
   BEGIN
      /*
                              {Primero se mira que configuraci?n tiene el usuario asignada}
      */
      vpsaexec := 1;

      BEGIN
         SELECT cconsupl
           INTO c_cconfsupl
           FROM pds_config_user
          WHERE cuser = UPPER (pcuser);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 151746;
      --{No se ha encontrado la configuraci?n de navegaci?n para este usuario}
      END;

      vpsaexec := 2;

      IF c_cconfsupl IS NULL
      THEN
         RETURN 151746;
      --{No se ha encontrado la configuraci?n de navegaci?n para este usuario}
      END IF;

      -- obtengo el sseguro de las tablas reales.
      SELECT ssegpol
        INTO pssegpol
        FROM estseguros
       WHERE sseguro = psseguro;

      vpsaexec := 3;

      FOR c IN cambios (c_cconfsupl)
      LOOP
         mi_cambio := 0;
         mis_cambios := 0;
         vpsaexec := 4;

         FOR x IN selects (c.cconfig)
         LOOP
            p_control_error ('ecpp',
                             'xxx: ',
                             (   c.cconfig
                              || ';'
                              || psseguro
                              || ';'
                              || pssegpol
                              || ';'
                              || pnmovimi
                             )
                            );
            v_select := REPLACE (LOWER (x.tselect), ':psseguro', psseguro);
            v_select := REPLACE (LOWER (v_select), ':pssegpol', pssegpol);
            v_select := REPLACE (LOWER (v_select), ':pnmovimi', pnmovimi);
            vpsaexec := 5;

            /*
                                    {Comprobamos si se ha realizado el cambio,}
            */
            EXECUTE IMMEDIATE v_select
                        USING OUT mi_cambio;

            --dc01-->
            IF     c.cmotmov = 286
               AND NVL
                      (pac_parametros.f_parempresa_n
                                              (pac_md_common.f_get_cxtempresa,
                                               'INS_MANDATO'
                                              ),
                       0
                      ) = 1
            THEN
               mi_cambio := 1;
               p_control_error ('dcomerma',
                                'error gesti?n 286 v_select: ',
                                (v_select)
                               );
            END IF;

            --dc01<--
            p_control_error ('dcomerma',
                             'error gesti?n 286 mi_cambio: ',
                             (mi_cambio)
                            );

            IF mi_cambio <> 0
            THEN
               mis_cambios := mis_cambios + 1;
            END IF;
         END LOOP;

--         p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 4',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'mis_cambios '
--                      || mis_cambios
--                     );
         IF mis_cambios <> 0
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         'pk_suplementos.f_validar_cambios',
                         2,
                         'fechat 5',
                            ' psseguro-->'
                         || psseguro
                         || 'pnmovimi-->'
                         || pnmovimi
                         || ' c.cmotmov-->'
                         || pcmotmov
                         || 'mis_cambios '
                         || mis_cambios
                        );

            UPDATE pds_estsegurosupl
               SET cestado = 'R'                                   --Realizado
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND cmotmov = c.cmotmov;

            -- Bug 24278 - APD - 18/12/2012
            -- si est? informado el campo cpropagasupl no eliminar la informacion de la tabla
            -- estdetmovseguro
            -- si no est? informado el campo s? se puede eliminar la infomacion
            SELECT COUNT (1)
              INTO vcont
              FROM estdetmovseguro
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND cmotmov = c.cmotmov
               AND cpropagasupl IS NOT NULL;

--               p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'vcont '
--                      || vcont
--                     );
            IF vcont = 0
            THEN
               -- Borramos la informaci?n que teniamos hasta ahora pq  la vamos a regenerar
               DELETE FROM estdetmovseguro
                     WHERE sseguro = psseguro
                       AND nmovimi = pnmovimi
                       AND cmotmov = c.cmotmov;
            END IF;

            -- fin Bug 24278 - APD - 18/12/2012
--            p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'vcont '
--                      || vcont
--                     );
            num_err :=
               f_nuevos_suplementos (psseguro,
                                     pnmovimi,
                                     psproduc,
                                     ptform,
                                     c.cconfig
                                    );
--            p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 nuevo',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'num_err  '
--                      || num_err
--                     );
            num_err :=
                   f_validar_permite_suplemento (psseguro, pnmovimi, psproduc);
--                    p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_validar_permite_suplemento',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'num_err  '
--                      || num_err
--                     );
            --, pdate, pcmodo);

            --grabamos en el detalle de movseguro-est
            num_err :=
               f_grabar_detalle (pssegpol,
                                 psseguro,
                                 pnmovimi,
                                 c.cmotmov,
                                 pcidioma,
                                 psproduc
                                );
--                                 p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_validar_cambios',
--                      2,
--                      'fechat 5 f_grabar_detalle',
--                         ' psseguro-->'
--                      || psseguro
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' c.cmotmov-->'
--                      || pcmotmov
--                      || 'num_err  '
--                      || num_err
--                     );
         ELSIF mis_cambios = 0
         THEN
            DELETE      estdetmovseguro
                  WHERE sseguro = psseguro
                    AND nmovimi = pnmovimi
                    AND cmotmov = c.cmotmov;

            DELETE FROM pds_estsigform
                  WHERE (sseguro, tform) IN (
                           SELECT sseguro, tform
                             FROM pds_configorden
                            WHERE sseguro = psseguro
                              AND cmotmov = c.cmotmov
                              AND sproduc = psproduc);

            UPDATE pds_estsegurosupl        -- inicializamos los incompatibles
               SET cestado = '0'
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND cestado NOT IN ('X', 'F')   -- Bug 19808 - RSC - 17/11/2011
               AND NOT EXISTS (
                      SELECT cmotmov   -- el movimiento se ha hecho alguna vez
                        FROM pds_estsegurosupl
                       WHERE sseguro = psseguro
                         AND nmovimi = pnmovimi
                         AND cmotmov = c.cmotmov
                         AND cestado IN ('0', 'F'))
               AND (   (    fsuplem <>
                               (SELECT fsuplem
                                  -- se inicializan los que tinen fechas diferentes
                                FROM   pds_estsegurosupl
                                 WHERE sseguro = psseguro
                                   AND nmovimi = pnmovimi
                                   AND cmotmov = c.cmotmov)
                        AND cmotmov <> c.cmotmov
                       )
                    OR (cmotmov IN (
                              SELECT cmotinc
                                FROM pds_suplincompatible
                               WHERE sproduc = psproduc
                                     AND cmotmov = c.cmotmov)
                       )
                   )
               --aquellos que son incompatible
               AND NOT EXISTS (
                      SELECT cmotmov
                        -- no existe un movimiento hecho con la misma fecha
                      FROM   pds_estsegurosupl
                       WHERE sseguro = psseguro
                         AND nmovimi = pnmovimi
                         AND cestado = 'X'
                         AND cmotmov <> c.cmotmov
                         AND fsuplem =
                                (SELECT fsuplem
                                   FROM pds_estsegurosupl
                                  WHERE sseguro = psseguro
                                    AND nmovimi = pnmovimi
                                    AND cmotmov = c.cmotmov));

            UPDATE pds_estsegurosupl
               SET cestado = '0'                  -- inicializa a no realizado
             WHERE sseguro = psseguro
               AND nmovimi = pnmovimi
               AND cmotmov = c.cmotmov
               AND cestado NOT IN ('F');       -- Bug 19808 - RSC - 17/11/2011

            DELETE FROM estdetmovseguro
                  WHERE sseguro = psseguro
                    AND nmovimi = pnmovimi
                    AND cmotmov = c.cmotmov;

            num_err :=
                   f_validar_permite_suplemento (psseguro, pnmovimi, psproduc);
         --, pdate, pcmodo);
         END IF;
      END LOOP;

      vpsaexec := 6;

      DELETE      pds_estsigform
            WHERE sseguro = psseguro AND tform = ptform;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         --{ p_tahiti_Error(null, 'errrr',sqlerrm);}
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_validar_cambios',
                      4,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;                               -- { Error no controlat}
   END;

   --
   FUNCTION f_fecha_efecto (
      psseguro   IN       NUMBER,
      pnmovimi   IN       NUMBER,
      pfecha     IN OUT   DATE
   )
      RETURN NUMBER
   IS
      fecmovi   DATE;
   BEGIN
      BEGIN
         SELECT DISTINCT (fsuplem)
                    INTO pfecha
                    FROM pds_estsegurosupl
                   WHERE sseguro = psseguro
                     AND nmovimi = NVL (pnmovimi, nmovimi)
                     AND cestado = 'X'
                     AND fsuplem IS NOT NULL;
      EXCEPTION
         WHEN TOO_MANY_ROWS
         THEN
            RETURN 151271;           -- Hi ha incompatibilitat de suplementos
         WHEN NO_DATA_FOUND
         THEN
            BEGIN
               SELECT DISTINCT (fsuplem)
                          INTO pfecha
                          FROM pds_estsegurosupl
                         WHERE sseguro = psseguro
                           AND nmovimi = NVL (pnmovimi, nmovimi)
                           AND cestado = 'X';
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  BEGIN
                     SELECT DISTINCT (fsuplem)
                                INTO pfecha
                                FROM pds_estsegurosupl
                               WHERE sseguro = psseguro
                                 AND nmovimi = NVL (pnmovimi, nmovimi);
                  EXCEPTION
                     WHEN TOO_MANY_ROWS
                     THEN
                        RETURN 151271;
                  -- Hi ha incompatibilitat de suplementos
                  END;
            END;
      END;

      RETURN 0;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN 151272;            -- No existen suplementos para esta p?liza
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_fecha_efecto',
                      5,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;                                   --Error no controlat
   END;

   FUNCTION f_obtener_cmotmov (
      psseguro   IN       NUMBER,
      pnmovimi   IN       NUMBER,
      pcmotmov   IN OUT   NUMBER
   )
      RETURN NUMBER
   IS
      v_cgenrec   NUMBER;
      v_num_reg   NUMBER;
   BEGIN
      BEGIN
         SELECT DISTINCT (cmotmov)
                    INTO pcmotmov
                    FROM pds_estsegurosupl
                   WHERE sseguro = psseguro
                     AND nmovimi = NVL (pnmovimi, nmovimi)
                     --AND cestado = 'X'
                     ;
      EXCEPTION
         WHEN TOO_MANY_ROWS
         THEN
            BEGIN
               -- Se busca si se est? realizando el suplemento de Fallecimiento de un asegurado ( productos 2 cabezas )
               -- En el caso que se est? realizando el suplemento de Fallecimiento de un asegurado ( productos 2 cabezas ),
               -- no se quiere que se detecte que se est? realizando un motivo m?ltiple (se puede estar realizando un motivo
               -- m?ltiple cuando ha habido un cambio de direccion para el segundo asegurado al realizar el suplemento de
               -- Fallecimiento de un asegurado ( productos 2 cabezas ))
               SELECT COUNT (1)
                 INTO v_num_reg
                 FROM pds_estsegurosupl
                WHERE sseguro = psseguro
                  AND nmovimi = NVL (pnmovimi, nmovimi)
                  AND cestado = 'X'
                  AND cmotmov = 265;

               -- Fallecimiento de un asegurado ( productos 2 cabezas )

               -- Si no se est? realzando el suplemento de Fallecimiento de un asegurado ( productos 2 cabezas ),
               -- se devolver? como motivo de movimiento el Motivo M?ltiple
               IF v_num_reg = 0
               THEN
                  SELECT DISTINCT (cgenrec)
                             INTO v_cgenrec
                             FROM pds_estsegurosupl p, codimotmov c
                            WHERE p.sseguro = psseguro
                              AND p.nmovimi = NVL (pnmovimi, p.nmovimi)
                              AND p.cestado = 'X'
                              AND c.cmotmov = p.cmotmov;

                  IF v_cgenrec = 0
                  THEN
                     pcmotmov := 670;
                  ELSE
                     pcmotmov := 666;
                  END IF;
               ELSE
                  -- Si s? se est? realizando el suplemento de Fallecimiento de un asegurado ( productos 2 cabezas ),
                  -- se devolver? como motivo de movimiento Fallecimiento de un asegurado ( productos 2 cabezas )
                  pcmotmov := 265;
               -- Fallecimiento de un asegurado ( productos 2 cabezas )
               END IF;
            EXCEPTION
               WHEN TOO_MANY_ROWS
               THEN
                  pcmotmov := 666;
            END;
         WHEN NO_DATA_FOUND
         THEN
            --Si no hay datos miramos si el producto permite inspeccion y cogemos el motivo del movimiento del seguro
            SELECT cmotmov
              INTO pcmotmov
              FROM estseguros s, movseguro m
             WHERE s.sseguro = psseguro
               AND m.nmovimi = NVL (pnmovimi, m.nmovimi)
               AND s.ssegpol = m.sseguro
               AND NVL (pac_parametros.f_parproducto_n (s.sproduc,
                                                        'GESTION_IR'
                                                       ),
                        0
                       ) = 1;
      END;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_obtener_cmotmov',
                      6,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;                                  --Error no controlat.
   END;

   FUNCTION f_visitar_forms (
      psseguro    IN   NUMBER,
      pform_act   IN   VARCHAR2,
      psproduc    IN   NUMBER
   )
      RETURN VARCHAR2
   IS
      CURSOR orden
      IS
         SELECT DISTINCT form_sig, LEVEL
                    FROM pds_codwizard
                   WHERE sproduc = psproduc
                     AND cmodo = 'ALTA_POLIZA'
                     AND form_sig IS NOT NULL
              START WITH form_act = pform_act
              CONNECT BY PRIOR form_sig = form_act
                ORDER BY LEVEL;

      vtform   VARCHAR2 (30);
   -- funci?n que nos retorna el siguiente formulario que tenemos
   -- que llamar para la ejecuci?n correcta del suplemento
   BEGIN
      FOR c IN orden
      LOOP
         BEGIN
            SELECT tform
              INTO vtform
              FROM pds_estsigform
             WHERE sseguro = psseguro AND tform = c.form_sig;

            -- Si no segueix el ordre l?gic de la aplicaci? un cop visitat l'el?liminem
            -- per evitar bucles
            DELETE      pds_estsigform
                  WHERE sseguro = psseguro AND tform = pform_act;

            RETURN vtform;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;                         -- Si no ha trobat res continuem
         END;
      END LOOP;

      BEGIN
         SELECT tform
           INTO vtform
           FROM pds_estsigform
          WHERE sseguro = psseguro AND tform <> pform_act;

         RETURN vtform;
      EXCEPTION
         WHEN OTHERS
         THEN
            NULL;
      END;

      RETURN vtform;
   END f_visitar_forms;

   FUNCTION f_capital (
      psproduc   IN       NUMBER,
      psseguro   IN       NUMBER,
      pdata      IN OUT   DATE
   )
      RETURN NUMBER
   IS
      num_err     NUMBER;
      v_cforpag   NUMBER;
   BEGIN
      -- Si es producto de ahorro entonces grabamos la fecha de la pr?xima
      -- cartera, sino la fecha del dia
      pdata := TRUNC (f_sysdate);
      RETURN 0;
   END f_capital;

   FUNCTION f_cforpag (
      psproduc   IN       NUMBER,
      psseguro   IN       NUMBER,
      pdata      IN OUT   DATE
   )
      RETURN NUMBER
   IS
      v_cforpag   NUMBER;
      num_err     NUMBER;
   BEGIN
      -- Si es producto de ahorro entonces grabamos la fecha de la pr?xima
      -- cartera, sino la fecha del dia
      pdata := TRUNC (f_sysdate);
      RETURN 0;
   END f_cforpag;

   FUNCTION f_fcarpro (psseguro IN NUMBER, pdata IN OUT DATE)
      RETURN NUMBER
   IS
      num_err     NUMBER;
      v_fcarpro   DATE;
      v_fefepol   DATE;
   BEGIN
      BEGIN
         SELECT fcarpro, fefecto
           INTO v_fcarpro, v_fefepol
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN OTHERS
         THEN
            RETURN 102903;                      --No s'ha trobat cap registre
      END;

      IF v_fefepol > TRUNC (f_sysdate)
      THEN
         pdata := v_fefepol;
      ELSE
         pdata := v_fcarpro;
      END IF;

      RETURN 0;
   END f_fcarpro;

   FUNCTION f_validar_garantias (
      psseguro   IN       NUMBER,
      pnriesgo   IN       NUMBER,
      pnmovimi   IN       NUMBER,
      psproduc   IN       NUMBER,
      pssegpol   IN       NUMBER,
      vmensa     IN OUT   VARCHAR2
   )
      RETURN NUMBER
   IS
      num_err       NUMBER := 0;
      v_aumento     NUMBER;
      v_reduccion   NUMBER;
   BEGIN
      -- miramos que las garant?as tengan capital igual o mayor aL
      --  de garanseg
      IF f_prod_ahorro (psproduc) = 0
      THEN
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT COUNT (1)
           INTO v_aumento
           FROM estgaranseg s, estseguros x
          WHERE s.sseguro = psseguro
            AND s.nmovimi = pnmovimi
            AND s.nriesgo = pnriesgo
            AND s.sseguro = x.sseguro
            AND NVL
                   (f_pargaranpro_v (x.cramo,
                                     x.cmodali,
                                     x.ctipseg,
                                     x.ccolect,
                                     pac_seguros.ff_get_actividad (x.sseguro,
                                                                   s.nriesgo,
                                                                   'EST'
                                                                  ),
                                     s.cgarant,
                                     'MOSTRAR_CAPITAL'
                                    ),
                    0
                   ) IN (1, 3)
            AND s.cobliga = 1
            AND EXISTS (
                   SELECT cgarant
                     FROM garanseg
                    WHERE sseguro = pssegpol
                      AND nriesgo = pnriesgo
                      AND cgarant = s.cgarant
                      AND ffinefe IS NULL
                      AND icapital < NVL (s.icapital, icapital));

         -- Bug 9699 - APD - 23/04/2009 - fin
         IF v_aumento > 0
         THEN
            RETURN 1;                              -- se ha aumentado capital
         END IF;

         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT COUNT (1)
           INTO v_reduccion
           FROM estgaranseg s, estseguros x
          WHERE s.sseguro = psseguro
            AND s.nmovimi = pnmovimi
            AND s.nriesgo = pnriesgo
            AND s.sseguro = x.sseguro
            AND NVL
                   (f_pargaranpro_v (x.cramo,
                                     x.cmodali,
                                     x.ctipseg,
                                     x.ccolect,
                                     pac_seguros.ff_get_actividad (x.sseguro,
                                                                   s.nriesgo,
                                                                   'EST'
                                                                  ),
                                     s.cgarant,
                                     'MOSTRAR_CAPITAL'
                                    ),
                    0
                   ) IN (1, 3)
            AND s.cobliga = 1
            AND EXISTS (
                   SELECT cgarant
                     FROM garanseg
                    WHERE sseguro = pssegpol
                      AND nriesgo = pnriesgo
                      AND cgarant = s.cgarant
                      AND ffinefe IS NULL
                      AND icapital > NVL (s.icapital, icapital));

         -- Bug 9699 - APD - 23/04/2009 - fin
         IF v_reduccion > 0
         THEN
            RETURN 2;                             -- se ha disminuido capital
         END IF;
      END IF;

      RETURN 0;
   END f_validar_garantias;

   FUNCTION f_traspasar_direcciones (
      psseguro   IN   NUMBER,
      psperson   IN   NUMBER,
      pnmovimi   IN   NUMBER
   )
      RETURN NUMBER
   IS
      vcdomici    NUMBER;
      total       NUMBER;
      v_aux       NUMBER;
      v_cclaper   NUMBER;
   BEGIN
      --guardamos las direcciones en la tabla especial, como es solo para suplementos,
      --grabamos el sseguro real
      RETURN (0);
   END f_traspasar_direcciones;

   FUNCTION f_recuperar_direcciones (psseguro IN NUMBER, pnmovimi IN NUMBER)
      RETURN NUMBER
   IS
      -- cursor de  tomadores
      CURSOR tomadores
      IS
         SELECT sperson, cdomici
           FROM tomadores
          WHERE sseguro = psseguro;

      CURSOR riesgos
      IS
         SELECT sperson, cdomici
           FROM riesgos
          WHERE sseguro = psseguro AND fanulac IS NULL;

      -- cursor de direcciones
      num_err       NUMBER;
      vcreteni      NUMBER;
      vcsituac      NUMBER;
      vcdomici      NUMBER;
      cdomici_aux   NUMBER;
   BEGIN
      -- Miramos si hay direcciones en supdirecciones
      RETURN (0);
   END f_recuperar_direcciones;

   FUNCTION f_borrar_supdirecciones (psseguro IN NUMBER, pnmovimi IN NUMBER)
      RETURN NUMBER
   IS
   BEGIN
      RETURN (0);
   EXCEPTION
      WHEN OTHERS
      THEN
         RETURN 105419;
   END f_borrar_supdirecciones;

   FUNCTION f_pds_deshabilitar (
      pccampval   IN   VARCHAR2,
      pttabval    IN   VARCHAR2,
      psseguro    IN   NUMBER
   )
      RETURN VARCHAR2
   IS
      v_select   VARCHAR2 (1000);
      cur        PLS_INTEGER;
      vn_valor   NUMBER;
      fdbk       PLS_INTEGER;
   BEGIN
      v_select :=
            'SELECT '
         || pccampval
         || ' FROM '
         || pttabval
         || ' WHERE sseguro  = '
         || psseguro;
      cur := DBMS_SQL.open_cursor;
      DBMS_SQL.parse (cur, v_select, DBMS_SQL.native);
      DBMS_SQL.define_column (cur, 1, vn_valor);    --definici?n de la columna
      fdbk := DBMS_SQL.EXECUTE (cur);               --ejecuci?n de la consulta

      IF DBMS_SQL.fetch_rows (cur) > 0
      THEN
         --posisci?n en el primer registro de la select
         DBMS_SQL.COLUMN_VALUE (cur, 1, vn_valor);
      --volcado del valor de la consulta en la variable
      ELSE
         vn_valor := NULL;            --teoricamente aqui nunca entrar? (nvl)
      END IF;

      DBMS_SQL.close_cursor (cur);         --cerramos el cursor de la consulta
      RETURN TO_CHAR (vn_valor);
   EXCEPTION
      WHEN OTHERS
      THEN
         IF DBMS_SQL.is_open (cur)
         THEN
            --Cerramos el cursor si esta abierto.
            DBMS_SQL.close_cursor (cur);
         END IF;

         RETURN NULL;
   END f_pds_deshabilitar;

   FUNCTION f_obtener_k_prestamo (
      psseguro    IN       NUMBER,
      pnriesgo    IN       NUMBER,
      picapital   IN OUT   NUMBER
   )
      RETURN NUMBER
   IS
      pporcen   NUMBER (5, 2);
   BEGIN
      /*
                                                          {Obtenemos el capital y el porcentaje del prestamo}
      */
      BEGIN
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT SUM (icapital)
           INTO picapital
           FROM garanseg g, seguros s
          WHERE g.sseguro = psseguro
            AND g.nriesgo = pnriesgo
            AND g.ffinefe IS NULL
            AND g.sseguro = s.sseguro
            AND f_pargaranpro_v (s.cramo,
                                 s.cmodali,
                                 s.ctipseg,
                                 s.ccolect,
                                 pac_seguros.ff_get_actividad (s.sseguro,
                                                               g.nriesgo
                                                              ),
                                 g.cgarant,
                                 'BASE_CAPITAL'
                                ) = 1;
      -- Bug 9699 - APD - 23/04/2009 - fin
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 151499;              --{El pr?stamo ha cambiado de datos }
      END;

      /*
                                                                                                              {Obtenemos el porcentaje del seguro sobre el prestamo}
      */
      BEGIN
         SELECT pporcen
           INTO pporcen
           FROM prestamoseg
          WHERE sseguro = psseguro AND ffinprest IS NULL;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 151499;              --{El pr?stamo ha cambiado de datos }
      END;

      /*
                                                                                                              {Obtenemos el capital del prestamo}
      */
      picapital := (picapital * 100) / pporcen;
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_obtener_k_ini_prestamo',
                      1,
                      'Error al trobar capital',
                      SQLERRM
                     );
         RETURN 151395;                --{Error al obtener el importe capital}
   END f_obtener_k_prestamo;

   FUNCTION f_obtener_porcentaje (psseguro IN NUMBER, pporcen IN OUT NUMBER)
      RETURN NUMBER
   IS
   BEGIN
      /*
                                                                                                  {Obtenemos el porcentaje del seguro sobre el prestamo}
      */
      BEGIN
         SELECT pporcen
           INTO pporcen
           FROM prestamoseg
          WHERE sseguro = psseguro AND ffinprest IS NULL;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 151499;              --{El pr?stamo ha cambiado de datos }
      END;

      RETURN 0;
   END f_obtener_porcentaje;

   FUNCTION f_actualiza_porcentaje (
      psseguro    IN   NUMBER,
      pnriesgo    IN   NUMBER,
      picapital   IN   NUMBER,
      ppporcen    IN   NUMBER
   )
      RETURN NUMBER
   IS
      ccramo      NUMBER;
      ccmodali    NUMBER;
      cctipseg    NUMBER;
      cccolect    NUMBER;
      ccactitvi   NUMBER;
   BEGIN
      /*
                                                                                                               {Obtenemos la codificaci?n del seguro}
      */
      BEGIN
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT cramo, cmodali, ctipseg, ccolect,
                pac_seguros.ff_get_actividad (psseguro, pnriesgo, 'EST')
                                                                      cactivi
           INTO ccramo, ccmodali, cctipseg, cccolect,
                ccactitvi
           FROM estseguros
          WHERE sseguro = psseguro;
      -- Bug 9699 - APD - 23/04/2009 - fin
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 101903;            --{seguro no trobat a la taula seguros}
      END;

      /*
                                                                                                              {Actualizamos el capital y la prima para obligar a tarifar}
      */
      UPDATE estgaranseg g
         SET icapital = picapital,
             iprianu = NULL
       WHERE sseguro = psseguro
         AND nriesgo = pnriesgo
         AND f_pargaranpro_v (ccramo,
                              ccmodali,
                              cctipseg,
                              cccolect,
                              ccactitvi,
                              g.cgarant,
                              'BASE_CAPITAL'
                             ) = 1;

      /*
                              {Actualizamos el porcentaje en estprestamosseg}
      */
      UPDATE estprestamoseg
         SET pporcen = ppporcen
       WHERE sseguro = psseguro;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_actualiza_porcentaje',
                      7,
                      'Error no controlat',
                      SQLERRM
                     );
         RETURN 140999;                                 --{Error no controlat}
   END f_actualiza_porcentaje;

   FUNCTION f_traspasar_datos_personas (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      /*
                                                                                                  {Funci?n que traspasa el contenido de las tablas de personas y direcciones a las tablas EST}
      */
      CURSOR mis_riesgos (p_sseguro IN NUMBER)
      IS
         SELECT sperson
           FROM riesgos
          WHERE sseguro = p_sseguro;

      n_ncontrol   NUMBER;
   BEGIN
      RETURN (0);
   END f_traspasar_datos_personas;

   PROCEDURE p_borrar_datos_asegurado (psseguro IN NUMBER)
   IS
      CURSOR mis_riesgos
      IS
         SELECT sperson
           FROM riesgos
          WHERE sseguro = psseguro
         UNION
         SELECT sperson
           FROM asegurados
          WHERE sseguro = psseguro;
   BEGIN
      NULL;
   END p_borrar_datos_asegurado;

   FUNCTION f_recuperar_datos_asegurado (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      CURSOR mis_riesgos
      IS
         SELECT e.*
           FROM riesgos r, estpersonas e
          WHERE r.sseguro = psseguro AND e.sperson = r.sperson;

      vtraza     VARCHAR2 (100);
      vnnumide   per_personas.nnumide%TYPE;
   BEGIN
      RETURN (0);
   END f_recuperar_datos_asegurado;

   -- CONF-274-25/11/2016-JLTS- Ini
   FUNCTION f_valida_suspension (psseguro NUMBER, pcmotmov IN NUMBER)
      RETURN NUMBER
   IS
      vobj        VARCHAR2 (100)      := 'pk_suplementos.f_valuda_suspension';
      vparam      VARCHAR2 (2000)
         := 'parametros - psseguro = ' || psseguro || ' pcmotmov: '
            || pcmotmov;
      vpasexec    NUMBER                    := 0;
      v_cmovseg   codimotmov.cmovseg%TYPE;
      v_finicio   DATE;
      v_ffinal    DATE;
   BEGIN
      BEGIN
         SELECT finicio, ffinal
           INTO v_finicio, v_ffinal
           FROM suspensionseg
          WHERE sseguro = psseguro
            AND cmotmov = pcmotmov
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM suspensionseg
                            WHERE sseguro = psseguro
                                                    --AND cmotmov = pcmotmov -- CONF-1199 LRB Se comenta linea para validar que solo permita realiza reinicio 1 vez
                         )
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM movseguro
                            WHERE sseguro = psseguro AND cmotmov = pcmotmov);
      --CONF-784 KJSC permita reinicio asi existan movimientos en la suspension
      EXCEPTION
         WHEN OTHERS
         THEN
            v_finicio := NULL;
            v_ffinal := NULL;
      END;

      IF v_finicio IS NULL OR v_finicio IS NOT NULL AND v_ffinal IS NOT NULL
      THEN                       --CONF-784 Se validara que no este suspendida
         RETURN (9904526);
      -- El suplemento de reinicio s?lo puede realizarse si la p?liza est? suspendida
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      vpasexec,
                      vparam,
                      'Error: ' || SQLERRM
                     );
         RETURN 1;
   END f_valida_suspension;

   -- CONF-274-25/11/2016-JLTS- Fin
   FUNCTION f_validar_fechasup (
      psseguro   IN   NUMBER,
      pfefesup   IN   DATE,
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      v_fefecto               DATE;
      v_fcarpro               DATE;
      vsproduc                NUMBER;
      vfvencim                DATE;
      vcduraci                NUMBER;
      num_err                 NUMBER;
      v_cempres               seguros.cempres%TYPE;
      v_frevisio              DATE;
      v_crealiza              cfg_accion.crealiza%TYPE;
      v_tvalpar               VARCHAR2 (50);
      vfsuplem                DATE;
      --BUG29229 - INICIO - DCT - 11/12/2013. Anadir ncertif
      v_ncertif               seguros.ncertif%TYPE;
      --BUG29229 - FIN - DCT - 11/12/2013. Anadir ncertif
      v_numaseg               NUMBER;        --Bug 29240 -- JMG -- 08/01/2014
      v_fefecto_suplem_ant    NUMBER;
      v_admite_certificados   NUMBER;
      v_escertifcero          NUMBER;
      v_fefectopol            seguros.fefecto%TYPE;        -- BUG 34462 - AFM
      vidversion              NUMBER;
      vfultrenova             movseguro.fefecto%TYPE;
      vnmovimi                movseguro.nmovimi%TYPE;
      v_fcaranu               seguros.fcaranu%TYPE;
      -- BUG 0039481 - FAL - 14/01/2016
      v_suspend               NUMBER                     := 0;
      --CONF-274-25/11/2016-JLTS
      v_csituac               NUMBER;      -- IAXIS-3631 -- ECP -- 10/05/2019
   BEGIN
      BEGIN
         --- Comprobamos la fecha
         SELECT m.fefecto, NVL (fcarpro, pfefesup), cempres, sproduc,
                s.fefecto, s.fcaranu, s.csituac
           INTO v_fefecto, v_fcarpro, v_cempres, vsproduc,
                v_fefectopol, v_fcaranu, v_csituac
           FROM movseguro m, seguros s
          WHERE m.sseguro = psseguro
            AND s.sseguro = m.sseguro
            AND nmovimi = (SELECT MAX (mm.nmovimi)
                             FROM movseguro mm
                            WHERE mm.sseguro = psseguro);
      EXCEPTION
         WHEN OTHERS
         THEN
            v_fefecto := v_fefectopol;
      END;

      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_validar_fechasup',
                   72,
                   'traz',
                      'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                   || 'v_fefecto-->'
                   || v_fefecto
                   ||' v_fefectopol -->'
                   || v_fefectopol
                   ||'f_parmotmov (pcmotmov, ''FEFECTO_ANT'', vsproduc)'
                   ||f_parmotmov (pcmotmov, 'FEFECTO_ANT', vsproduc)
                  );

      -- INI BUG 34462 - AFM
      -- Validaciones para realizar un  suplemento retroactivo
      
      IF (NVL (f_parmotmov (pcmotmov, 'FEFECTO_ANT', vsproduc), 0) = 2) 
      THEN
         IF TRUNC (pfefesup) < v_fefectopol
         THEN
            -- La fecha del suplemento no puede ser inferior a la fecha de efecto de la p?liza
             p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_validar_fechasup',
                   702,
                   'traz',
                      'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                   || 'v_fefecto-->'
                   || v_fefecto
                   ||'f_parmotmov (pcmotmov, ''FEFECTO_ANT'', vsproduc)'
                   ||f_parmotmov (pcmotmov, 'FEFECTO_ANT', vsproduc)
                  );
            RETURN 180386;
         END IF;
      ELSE
         -- Si no es retroactivo el suplemento se debe validar lo siguiente
         -- 25/06/2007 Desde hoy se permite realizar suplementos con fecha inferior al ?ltimo suplemento
         -- Esto es debido para que se permitan hacer suplementos de cambio de % de inter?s t?cnico con efecto retroactivo
         -- (?ltima Renovaci?n)
         -- Desde la funci?n pk_suplementos.f_grabar_suplemento_poliza se actualiza la tabla GARANSEG si se ha hecho un
         -- suplemento con efecto retroactivo
         -- 25/06/2007 Pero se tiene que controlar que no se puedan hacer suplementos con fecha anterior al Alta o ?ltima Renovaci?n
         IF NOT (    pac_parametros.f_parempresa_n (v_cempres,
                                                    'VAL_FEC_CONT_EXT'
                                                   ) = 1
                 AND pcmotmov = 500
                )
         THEN
            IF TRUNC (pfefesup) <
                      TO_DATE (frenovacion (NULL, psseguro, 2), 'yyyy/mm/dd')
            THEN
               RETURN 180386;
            -- La fecha del suplemento no puede ser inferior a la fecha de alta o ?ltima renovaci?n
            END IF;

            IF v_fcarpro < pfefesup
            THEN
               -- jlb  I para correduria no se valida la fecha de suplemento
               IF NVL (ff_es_correduria (v_cempres), 0) <> 1
               THEN
                  RETURN 103308;
               END IF;
            --la fecha del suplemento no puede ser superior a la pr?xima cartera
            END IF;
         END IF;
      END IF;

      -- FIN BUG 34462 - AFM

      --Bug 29240 -- JMG -- 08/01/2014  se incluye validacion si tiene asegurados.
      v_admite_certificados :=
                   NVL (f_parproductos_v (vsproduc, 'ADMITE_CERTIFICADOS'), 0);
      v_numaseg := 0;

      IF v_admite_certificados = 1
      THEN
         SELECT COUNT (1)
           INTO v_numaseg
           FROM seguros
          WHERE npoliza = (SELECT npoliza
                             FROM seguros
                            WHERE sseguro = psseguro)
            AND ncertif <> 0
            -- Bug 30448/170144 - APD - 19/03/2014
            AND (    csituac <> 2
                 AND csituac <> 3
                 AND NOT (csituac = 4 AND creteni = 3)
                 AND NOT (csituac = 4 AND creteni = 4)
                );
      -- fin Bug 30448/170144 - APD - 19/03/2014
      END IF;

      --JLV. 28132/164566
      --IF v_numaseg > 0 THEN
      --BUG 27539/149535 - INICIO - DCT - 22/07/2013
      v_fefecto_suplem_ant :=
         NVL (pac_parametros.f_parmotmov_n (pcmotmov,
                                            'FEFECTO_SUPLEM_ANT',
                                            vsproduc
                                           ),
              1
             );
      v_escertifcero := pac_seguros.f_get_escertifcero (NULL, psseguro);

      IF    v_fefecto_suplem_ant = 0
         OR (    v_admite_certificados = 1
             AND v_fefecto_suplem_ant = 2
             AND v_escertifcero = 1
             AND v_numaseg > 0
            )
         OR (    v_admite_certificados = 1
             AND v_fefecto_suplem_ant = 3
             AND v_escertifcero = 0
             AND v_numaseg > 0
            )
         --JLV. 28132/164566
         OR (v_admite_certificados = 0)
      THEN
         v_tvalpar :=
            pac_parametros.f_parmotmov_t (pcmotmov,
                                          'FEFECTO_SUPLEM_FEC',
                                          vsproduc
                                         );

         IF v_tvalpar = 'F_SYSDATE'
         THEN
            vfsuplem := TRUNC (f_sysdate);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            IF TRUNC (pfefesup) < TRUNC (vfsuplem)
            THEN
               --La fecha de fecto del suplemento no puede ser anterior al d?a de hoy
               RETURN 9905797;
            END IF;
         ELSIF v_tvalpar = 'F_FCARPRO'
         THEN
            num_err := f_fcarpro (psseguro, vfsuplem);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            IF TRUNC (pfefesup) < TRUNC (vfsuplem)
            THEN
               --La fecha de efecto del suplemento no puede ser anterior a la fecha de la proxima cartera
               RETURN 9905798;
            END IF;
         -- Bug 19808 - RSC - 10/11/2011 - Comprobamos si la fecha de fecto supera el m?ximo
         ELSIF v_tvalpar = 'F_FCARANU'
         THEN
            num_err := f_fcaranu (psseguro, vfsuplem);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            IF TRUNC (pfefesup) < TRUNC (vfsuplem)
            THEN
               --La fecha de efecto del suplemento no puede ser anterior a la fecha de cartera anualidad
               RETURN 9905799;
            END IF;
         -- AFM INI RETRO
         ELSIF v_tvalpar = 'F_FVERSCONV'
         THEN
            num_err :=
               pk_suplementos.f_fversconv (psseguro,
                                           'SEG',
                                           vfsuplem,
                                           vidversion
                                          );

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            IF vfsuplem >= v_fcaranu
            THEN
               -- BUG 0039481 - FAL - 14/01/2016
               RETURN 9908713;
-- No se permite cambio de convenio por efecto version posterior a fecha renovacion
            END IF;

            vfsuplem := GREATEST (vfsuplem, v_fefectopol);
         -- AFM INI RETRO
         ELSIF v_tvalpar = 'F_FRENOV'
         THEN
            --
            num_err := f_fcaranu (psseguro, vfsuplem);

            --
            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            --
            num_err := f_ultrenova (psseguro, vfsuplem, vfultrenova, vnmovimi);

            --
            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            --
            IF     TRUNC (pfefesup) <> TRUNC (vfultrenova)
               AND TRUNC (pfefesup) <> TRUNC (vfsuplem)
            THEN
               RETURN 9908697;
            END IF;
         --
         END IF;
      END IF;

      --END IF;

      --BUG 27539/149535 - FIN - DCT - 22/07/2013
      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_validar_fechasup',
                   9,
                   'traz',
                      'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                   || 'v_fefecto-->'
                   || v_fefecto
                  );

      --BUG29229 - INICIO - DCT - 11/12/2013. Anadir ncertif
      --BUG 11099 - JTS - 10/09/2009
      BEGIN
         SELECT sproduc, fvencim, cduraci, cempres, ncertif
           INTO vsproduc, vfvencim, vcduraci, v_cempres, v_ncertif
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            BEGIN
               SELECT sproduc, fvencim, cduraci, cempres, ncertif
                 INTO vsproduc, vfvencim, vcduraci, v_cempres, v_ncertif
                 FROM seguros
                WHERE sseguro = (SELECT ssegpol
                                   FROM estseguros
                                  WHERE sseguro = psseguro);
            EXCEPTION
               WHEN OTHERS
               THEN
                  RETURN SQLCODE;
            END;
      END;

      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_validar_fechasup',
                   10,
                   'traz',
                      'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                   || 'v_fefecto-->'
                   || v_fefecto
                   || 'vsproduc,'
                   || vsproduc
                   || ' vfvencim,'
                   || vfvencim
                   || ' vcduraci,'
                   || vcduraci
                   || ' v_cempres,'
                   || v_cempres
                   || 'v_ncertif,'
                   || v_ncertif
                  );

      --BUG29229 - FIN - DCT - 11/12/2013. Anadir ncertif

      -- BUG 16903 - 07/12/2010 - JMP - No permitir suplementos si fecha de revisi?n anterior al efecto del suplemento.
      BEGIN
         SELECT frevisio
           INTO v_frevisio
           FROM seguros_aho
          WHERE sseguro = psseguro;

         num_err :=
            pac_cfg.f_get_user_accion_permitida (f_user,
                                                 'SUPLEM_NO_REVISA',
                                                 vsproduc,
                                                 v_cempres,
                                                 v_crealiza
                                                );

         IF num_err <> 1
         THEN
            IF v_frevisio < pfefesup
            THEN
               RETURN 9901724;
            -- La fecha del suplemento no puede ser superior a la de revisi?n
            END IF;
         END IF;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;

      --BUG29229 - INICIO - DCT - 11/12/2013
      --BUG27048 - INICIO - DCT - 08/11/2013
      --Bug 29358/0161703 - JSV - 18/12/2013 - INI
      --IF NVL(f_parproductos_v(vsproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
      --   AND v_ncertif = 0 THEN
      IF     NVL (f_parproductos_v (vsproduc, 'ADMITE_CERTIFICADOS'), 0) = 1
         AND v_ncertif = 0
         AND pac_seguros.f_es_col_admin (psseguro, 'SEG') = 1
      THEN
         BEGIN
            --Bug 29358/0161703 - JSV - 18/12/2013 - FIN
            --BUG29229 - FIN - DCT - 11/12/2013
            -- INI RLLF 12022014  Que no valide nada para este caso
            IF NVL (f_parproductos_v (vsproduc, 'SUPLEMENTOS_FPOLIZA'), 0) !=
                                                                            1
            THEN
               -- Tomamos la max fecha de efecto de la poliza en cuesti?n.
               -- Los suplelemntos anulados delos certificados no los tenemos que contar.
               -- INI RLLF 13022014 Finalmente que no valide nada
               --SELECT MAX(m.fefecto)
               --  INTO v_fefecto
               --  FROM movseguro m, seguros s
               -- WHERE s.sseguro =  psseguro
               --   AND s.sseguro = m.sseguro
               --   AND s.csituac <> 2
               --   AND m.cmovseg NOT IN(52);

               --ELSE
               -- Tomamos la max fecha de efecto de los diferentes certificados.
               -- Los suplelemntos anulados delos certificados no los tenemos que contar.
               --
               SELECT MAX (m.fefecto)
                 INTO v_fefecto
                 FROM movseguro m, seguros s
                WHERE s.npoliza = (SELECT npoliza
                                     FROM seguros
                                    WHERE sseguro = psseguro)
                  AND s.ncertif <> 0
                  AND s.sseguro = m.sseguro
                  AND s.csituac <> 2
                  AND m.cmovseg NOT IN (52);

               IF TRUNC (pfefesup) < TRUNC (v_fefecto)
               THEN
                  --la fecha no puede ser inferior al ?ltimo suplemento
                  RETURN 9901064;
               END IF;
            END IF;
         -- FIN RLLF 12022014  Que no valide nada para este caso
         EXCEPTION
            WHEN OTHERS
            THEN
               RETURN SQLCODE;
         END;
      END IF;

      -- CONF-274-25/11/2016-JLTS- Ini
      --Validaci?n no se permitir?n suplementos con fecha efecto en el intervalo que la p?liza est? suspendida
      IF     NVL (f_parproductos_v (vsproduc, 'VAL_SUSP_CUMPLIM'), 0) = 1
         AND pcmotmov != pac_suspension.vcod_reinicio
      THEN
         SELECT COUNT (1)
           INTO v_suspend
           FROM movseguro m, suspensionseg ss
          WHERE m.sseguro = ss.sseguro
            AND m.nmovimi = ss.nmovimi
            AND m.sseguro = psseguro
            AND m.nmovimi = (SELECT MAX (nmovimi)
                               FROM movseguro ms
                              WHERE ms.sseguro = m.sseguro)
            AND m.cmotmov = 391
            AND ss.finicio <= v_fefecto;

         IF v_suspend = 1
         THEN
            RETURN 9909377;
         END IF;
      END IF;

      -- Se valida que la fecha de reinicio no sea menor a la fecha de la ?ltima suspensi?n
      IF     NVL (f_parproductos_v (vsproduc, 'VAL_SUSP_CUMPLIM'), 0) = 1
         AND pcmotmov = pac_suspension.vcod_reinicio
      THEN
         SELECT COUNT (1)
           INTO v_suspend
           FROM movseguro m, suspensionseg ss
          WHERE m.sseguro = ss.sseguro
            AND m.nmovimi = ss.nmovimi
            AND m.sseguro = psseguro
            AND m.nmovimi = (SELECT MAX (nmovimi)
                               FROM movseguro ms
                              WHERE ms.sseguro = m.sseguro)
            AND m.cmotmov = 391
            AND ss.finicio > pfefesup;

         IF v_suspend = 1
         THEN
            RETURN 9904520;
         END IF;
      END IF;

      -- CONF-274-25/11/2016-JLTS- Fin

      --BUG27048 - FIN - DCT - 08/11/2013

      --BUG11376-XVM-13102009
      --RETURN pac_seguros.f_valida_fefecto(vsproduc, pfefesup, vfvencim, vcduraci);
      RETURN pk_suplementos.f_valida_fefecto (vsproduc,
                                              pfefesup,
                                              vfvencim,
                                              vcduraci,
                                              pcmotmov
                                             );
   --Fi BUG 11099 - JTS - 10/09/2009
   END f_validar_fechasup;

   FUNCTION f_permite_suplementos (
      psseguro   IN   NUMBER,
      pfefesup   IN   DATE DEFAULT NULL,
      pcmotmov   IN   NUMBER DEFAULT NULL,
      pcmodo     IN   VARCHAR2 DEFAULT 'SUPLEMENTO'
   )
      RETURN NUMBER
   IS
      /************************************************************************************
                     Se comprobar? que la p?liza est? vigente, no est? retenida y la fecha est? permitida
            0.- permite suplementos
           1.- no permite suplementos
           12-6-2006. Si es un PP se comprueba que el Plan est? abierto
           RSC - 17-09-2007. Si el producto es Unit Linked (agrupacion 21) se comprueba
                             que el producto tenga todos los fondos de inversi?n disponibles abiertos.
         pfefesup: si es null significa que de entrada no tenemos fecha de suplemento
                   y se asignar? de forma autom?tica seg?n los motivos de movimiento
      *************************************************************************************/
      reg_seg      seguros%ROWTYPE;
      num_err      NUMBER;
      ocoderror    NUMBER;
      omsgerror    VARCHAR2 (1000);
      v_contador   NUMBER;
-- 82. MMM - 0027723: LCOL_A003-Una poliza que esta domiciliada o en tramite de respuesta no se debe modificar
   BEGIN
      -- Comprobamos la situaci?n de la p?liza
      -- Ini IAXIS-3504 -- ECP -- 26/12/2019
      BEGIN
         SELECT *
           INTO reg_seg
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            BEGIN
               SELECT *
                 INTO reg_seg
                 FROM seguros
                WHERE sseguro = (SELECT ssegpol
                                   FROM estseguros
                                  WHERE sseguro = psseguro);
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  p_tab_error (f_sysdate,
                               f_user,
                               'pk_suplementos.f_permite_suple',
                               23,
                               'traz',
                                  'reg_seg.csituac-->'
                               || reg_seg.csituac
                               || 'reg_seg.creteni-->'
                               || reg_seg.creteni
                              );
            END;
      END;

      -- FinIAXIS-3504 -- ECP -- 26/12/2019

      --      IF reg_seg.cagrpro = 11 THEN   -- si es de Planes
      --         IF f_ppabierto(psseguro, NULL, NVL(pfefesup, f_sysdate)) <> 'A' THEN
      --            RETURN 152766;   -- plan de pensones no activo en el d?a de hoy
      --         END IF;
      --      END IF;

      --      IF f_parproductos_v(reg_seg.sproduc, 'ES_PRODUCTO_INDEXADO') = 1 THEN   -- Es producto indexado
      --         -- Bug 9031 - 17/03/2009 - RSC - An?lisis adaptaci?n productos indexados
      --         -- Modificamos PAC_VAL_ULK por PAC_VAL_FINV
      --         IF pac_val_finv.f_valida_ulk_abierto(psseguro, NULL, NVL(pfefesup, f_sysdate)) IS NULL THEN
      --            RETURN 180508;   -- El producto no est? activo
      --         END IF;
      --      -- Fin Bug 9031
      --      END IF;
      -- Ini IAXIS-3504 -- ECP -- 26/12/2019
      -- Ini IAXIS-3631 -- ECP -- 10/05/2019
      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_permite_suple',
                   7,
                   'traz',
                      'reg_seg.csituac-->'
                   || reg_seg.csituac
                   || 'reg_seg.creteni-->'
                   || reg_seg.creteni
                  );

      IF reg_seg.csituac IN (0, 3, 5) AND reg_seg.creteni = 0
      -- IAXIS-3504 -- ECP -- 26/12/2019
      THEN
         NULL;
      ELSE
         IF pcmodo = 'MODIF_PROP'
         THEN
            NULL;                                  -- BUG15684:DRA:31/08/2010
         ELSE
            RETURN 104257;
         END IF;
      -- la p?liza no est? en situaci?n de hacer suplementos
      END IF;

-- FIn IAXIS-3631 -- ECP -- 10/05/2019
-- Ini IAXIS-3631 -- ECP -- 10/05/2019
      --IF reg_seg.csituac <> 3 then
      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_permite_suple',
                   72,
                   'traz',
                      'reg_seg.csituac-->'
                   || reg_seg.csituac
                   || 'reg_seg.creteni-->'
                   || reg_seg.creteni
                   || 'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                  );

      IF pfefesup IS NOT NULL
      THEN
        
         num_err := f_validar_fechasup (psseguro, reg_seg.fefecto, pcmotmov);
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_permite_suple',
                      8,
                      'traz',
                         'reg_seg.csituac-->'
                      || reg_seg.csituac
                      || 'reg_seg.creteni-->'
                      || reg_seg.creteni
                      || 'psseguro-->'
                      || psseguro
                      || 'pfefesup-->'
                      || pfefesup
                      || 'pcmotmov-->'
                      || pcmotmov
                      || 'num_err '
                      || num_err
                     );
         
         RETURN num_err;
      END IF;

      p_tab_error (f_sysdate,
                   f_user,
                   'pk_suplementos.f_permite_suple',
                   8,
                   'traz',
                      'reg_seg.csituac-->'
                   || reg_seg.csituac
                   || 'reg_seg.creteni-->'
                   || reg_seg.creteni
                   || 'psseguro-->'
                   || psseguro
                   || 'pfefesup-->'
                   || pfefesup
                   || 'pcmotmov-->'
                   || pcmotmov
                   || 'num_err '
                   || num_err
                  );

      --end if;
-- FIn IAXIS-3631 -- ECP -- 10/05/2019
      -- CONF-274-25/11/2016-JLTS- Ini
      IF pcmotmov = pac_suspension.vcod_reinicio
      THEN                                                              -- 141
         num_err := f_valida_suspension (psseguro, 391);
         RETURN num_err;
      END IF;

      -- CONF-274-25/11/2016-JLTS- Fin
      -- 82. MMM - 0027723: LCOL_A003-Una poliza que esta domiciliada o en tramite de respuesta no se debe modificar - Inicio
      IF NVL
            (pac_parametros.f_parempresa_n (pac_md_common.f_get_cxtempresa (),
                                            'NO_SUPLE_SI_DOMIS'
                                           ),
             0
            ) = 1
      THEN
         -- Bug 29256/160558 - 09/12/2013 - AMC
         /* SELECT COUNT(*)
           INTO v_contador
           FROM recibos
          WHERE sseguro = psseguro
            AND cestimp = 5;

         IF v_contador > 0 THEN
            RETURN 9903191;
         END IF;*/
         v_contador := pac_domis.f_valida_domi_poliza (psseguro);

         IF v_contador > 0
         THEN
            RETURN v_contador;
         END IF;
      -- Fi Bug 29256/160558 - 09/12/2013 - AMC
      END IF;

      IF NVL
            (pac_parametros.f_parempresa_n (pac_md_common.f_get_cxtempresa (),
                                            'NO_SUPLE_SI_NOTIF'
                                           ),
             0
            ) = 1
      THEN
         SELECT COUNT (*)
           INTO v_contador
           FROM recibos
          WHERE sseguro = psseguro AND cestimp = 12;

         IF v_contador > 0
         THEN
            RETURN 9903192;
         END IF;
      END IF;

      -- 82. MMM - 0027723: LCOL_A003-Una poliza que esta domiciliada o en tramite de respuesta no se debe modificar - Fin
      RETURN 0;
   END f_permite_suplementos;

   -- Bug 11376 - 30/10/2009 - AMC  - Se anade el pcmotmov
   FUNCTION f_permite_anadir_suplementos (
      psseguro   IN   NUMBER,
      puser      IN   VARCHAR2,
      pcmodo     IN   VARCHAR2,
      ptform     IN   VARCHAR2,
      ptcampo    IN   VARCHAR2 DEFAULT '*',
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      /*******************************************************************************
                     psseguro: sseguro de la tabla ESTSEGUROS
      *************************************************************************************/
      v_form      VARCHAR2 (30);
      v_sproduc   NUMBER;
      v_ssegpol   NUMBER;
      contador    NUMBER         := 0;       -- IAXIS-3631  --ECP--10/05/2019
      v_csituac   NUMBER;                    -- IAXIS-3631  --ECP--10/05/2019
      vobject     VARCHAR2 (100)
                             := 'PK_SUPLEMENTOS.f_permite_anadir_suplementos';
      vpasexec    NUMBER         := 1;
      v_fefecto DATE;
   BEGIN
      -- Ini -- IAXIS-3631  --ECP--10/05/2019
      p_tab_error (f_sysdate,
                   f_user,
                   vobject,
                   vpasexec,
                   'tra',
                      ' psseguro-->'
                   || psseguro
                   || ' puser-->'
                   || puser
                   || ' pcmodo-->'
                   || pcmodo
                   || ' ptform -->'
                   || ptform
                   || ' ptcampo -->'
                   || ptcampo
                   || ' pcmotmov -->'
                   || pcmotmov
                  );

      BEGIN
         SELECT sproduc, ssegpol, csituac, fefecto
           INTO v_sproduc, v_ssegpol, v_csituac, v_fefecto
           FROM estseguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            BEGIN
               SELECT sproduc, sseguro, csituac, fefecto
                 INTO v_sproduc, v_ssegpol, v_csituac, v_fefecto
                 FROM seguros
                WHERE sseguro = psseguro;
            EXCEPTION
               WHEN OTHERS
               THEN
                  RETURN 103286;
            END;
      END;

      p_tab_error (f_sysdate,
                   f_user,
                   vobject,
                   vpasexec,
                   'tras',
                      ' v_sproduc-->'
                   || v_sproduc
                   || ' v_ssegpol-->'
                   || v_ssegpol
                   || ' v_csituac-->'
                   || v_csituac
                  );
      v_form :=
         pac_wizard.f_obtener_from (puser, v_sproduc, pcmodo, ptform, ptcampo);

      IF v_csituac <> 3
      THEN
         BEGIN
            SELECT COUNT (*)
              INTO contador
              FROM pds_estsegurosupl
             WHERE sseguro = psseguro
               AND cestado IN ('0', 'X')
               AND pk_suplementos.f_validar_fechasup (v_ssegpol,
                                                      v_fefecto,
                                                      pcmotmov
                                                     ) = 0;
         EXCEPTION
            WHEN OTHERS
            THEN
               contador := 0;
         END;

         IF contador = 0
         THEN
            RETURN 1;                        -- no PERMITE AnADIR SUPLEMENTOS
         ELSE
            RETURN 0;                           -- PERMITE AnADIR SUPLEMENTOS
         END IF;
      END IF;

      -- Fin IAXIS-3631  --ECP--10/05/2019
      RETURN 0;
   END f_permite_anadir_suplementos;

   -- Bug 11376 - 30/10/2009 - AMC - Se anade el parametro pcmotmov
   FUNCTION f_inicializar_suplemento (
      psseguro        IN       NUMBER,
      pcmodo          IN       VARCHAR2,
      pfefesup        IN       DATE DEFAULT NULL,
      ptform          IN       VARCHAR2,
      ptcampo         IN       VARCHAR2 DEFAULT '*',
      pcmotmov        IN       NUMBER,
      p_est_sseguro   OUT      NUMBER,
      pnmovimi        OUT      NUMBER,
      pllamada        IN       VARCHAR2 DEFAULT 'PRAGMA',
      -- BUG15823:DRA:04/11/2010
      pvalida_supl    IN       NUMBER DEFAULT 1
   )                                           -- Bug 26070 - APD - 11/03/2013
      RETURN NUMBER
   IS
      -- PRAGMA AUTONOMOUS_TRANSACTION;

      /******************************************************************************************
                                psseguro: sseguro de la tabla SEGUROS
        pcmodo: 'SUPLEMENTO'
        pfefesup: fecha del suplemento (s?lo se informar? si la fecha es fija (central))
        ptform: form desde el que llamamos a la funci?n (para saber si hay suplementos compatibles)
        ptcampo: campo desde el que llamamos a la funci?n (para saber si hay suplementos compatibles)
                si no nos interesa se pone '*' o no se pasa el par?metro
      *******************************************************************************************/
      num_err    NUMBER;
      mens       VARCHAR2 (2000);
      vtraza     NUMBER;
      salir      EXCEPTION;
      lcuantos   NUMBER;
      lcregul    NUMBER;
      lsproduc   seguros.sproduc%TYPE;

      FUNCTION f_ini_suplemento_pragma (
         psseguro        IN       NUMBER,
         pcmodo          IN       VARCHAR2,
         pfefesup        IN       DATE DEFAULT NULL,
         ptform          IN       VARCHAR2,
         ptcampo         IN       VARCHAR2 DEFAULT '*',
         p_est_sseguro   IN OUT   NUMBER,
         pnmovimi        IN OUT   NUMBER,
         pcmotmov        IN       NUMBER
      )
         RETURN NUMBER
      IS
         PRAGMA AUTONOMOUS_TRANSACTION;
         num_err         NUMBER;
         mens            VARCHAR2 (2000);
         v_est_sseguro   NUMBER;
         v_sproduc       NUMBER;
         v_nmovimi       NUMBER;
         v_cactivi       NUMBER;
         salir           EXCEPTION;
         vtraza          NUMBER;

         CURSOR est
         IS
            SELECT sseguro
              FROM estseguros
             WHERE ssegpol = psseguro;

         CURSOR risc (v_est_sseguro IN NUMBER)
         IS
            SELECT nriesgo
              FROM estriesgos
             WHERE sseguro = v_est_sseguro AND fanulac IS NULL;
      -- BUG11047:DRA:08/09/2009
      BEGIN
         vtraza := 1;

         FOR c IN est
         LOOP
            pac_alctr126.borrar_tablas_est (c.sseguro);
         END LOOP;

         pac_alctr126.traspaso_tablas_seguros (psseguro,
                                               mens,
                                               'ALSUP003',
                                               NULL,
                                               NVL (pfefesup,
                                                    TRUNC (f_sysdate)
                                                   )
                                              );

         IF mens IS NOT NULL
         THEN
            -- se deber? grabar en tab_error
            num_err := 105419;                               --ERROR TRASPASO
            RAISE salir;
         END IF;

         vtraza := 2;

         -- Averiguamos el sseguro de las tablas EST
         BEGIN
            SELECT MAX (sseguro), MAX (sproduc), MAX (cactivi)
              INTO v_est_sseguro, v_sproduc, v_cactivi
              FROM estseguros
             WHERE ssegpol = psseguro;

            vtraza := 21;

            SELECT DISTINCT (nmovimi)
                       INTO v_nmovimi
                       FROM estgaranseg
                      WHERE sseguro = v_est_sseguro;
         EXCEPTION
            WHEN OTHERS
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_suplementos.f_ini_suplemento_pragma',
                            vtraza,
                            'Error no controlat',
                            SQLCODE || '-' || SQLERRM
                           );
               RAISE salir;
         END;

         vtraza := 3;
         -- Ini 3504 -- ECP -- 24/12/2019
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_ini_suplemento_pragma',
                      vtraza,
                      'antes de inicializar 1',
                         'pcmotmov'
                      || pcmotmov
                      || 'pcmodo '
                      || pcmodo
                      || ' pfefesup '
                      || pfefesup
                      || ' v_est_sseguro'
                      || v_est_sseguro
                      || '  v_nmovimi '
                      || v_nmovimi
                      || 'v_sproduc-'
                      || v_sproduc
                     );
         num_err :=
            pk_suplementos.f_inicializar_fechas (v_est_sseguro,
                                                 v_nmovimi,
                                                 v_sproduc,
                                                 NVL (pfefesup, f_sysdate),
                                                 pcmodo,
                                                 pcmotmov
                                                );  -- BUG15684:DRA:31/08/2010
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_ini_suplemento_pragma',
                      vtraza,
                      'después de inicializar',
                         'pcmotmov'
                      || pcmotmov
                      || 'pcmodo '
                      || pcmodo
                      || ' pfefesup '
                      || pfefesup
                      || ' v_est_sseguro'
                      || v_est_sseguro
                      || '  v_nmovimi '
                      || v_nmovimi
                      || 'v_sproduc-'
                      || v_sproduc
                      || 'num_err'
                      || num_err
                     );

         -- Fin 3504 -- ECP -- 24/12/2019
         IF num_err <> 0
         THEN
            --no hay suplementos
            pac_alctr126.borrar_tablas_est (v_est_sseguro);
            RAISE salir;
         END IF;

         vtraza := 31;
         num_err :=
            pk_suplementos.f_permite_anadir_suplementos (v_est_sseguro,
                                                         UPPER (f_user),
                                                         pcmodo,
                                                         ptform,
                                                         ptcampo,
                                                         pcmotmov
                                                        );

         IF num_err <> 0
         THEN
            --no hay suplementos
            pac_alctr126.borrar_tablas_est (v_est_sseguro);
            RAISE salir;
         END IF;

         vtraza := 4;

         FOR c_risc IN risc (v_est_sseguro)
         LOOP
            -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
            num_err :=
               pk_nueva_produccion.f_garanpro_estgaranseg
                               (v_est_sseguro,
                                c_risc.nriesgo,
                                v_nmovimi,
                                v_sproduc,
                                NVL (pfefesup, TRUNC (f_sysdate)),
                                pac_seguros.ff_get_actividad (v_est_sseguro,
                                                              c_risc.nriesgo,
                                                              'EST'
                                                             )
                               );

            IF num_err <> 0
            THEN
               --no hay suplementos
               pac_alctr126.borrar_tablas_est (v_est_sseguro);
               RAISE salir;
            END IF;
         -- Bug 9699 - APD - 23/04/2009 - fin
         END LOOP;

         vtraza := 5;

         -- de momento se hace aqu?, pero deber?a hacerse en el pac_alctr126.traspaso_tablas_seguros
         UPDATE estclaubenseg
            SET cobliga = 1
          WHERE sseguro = v_est_sseguro;

         p_est_sseguro := v_est_sseguro;
         pnmovimi := v_nmovimi;
         COMMIT;
         RETURN 0;
      EXCEPTION
         WHEN salir
         THEN
            ROLLBACK;
            p_tab_error (f_sysdate,
                         f_user,
                         'pk_suplementos.f_ini_suplemento_pragma',
                         vtraza,
                         'Error no controlat',
                         num_err || '-' || mens
                        );
            RETURN num_err;
      END f_ini_suplemento_pragma;

      -- BUG15823:DRA:04/11/2010:Inici
      FUNCTION f_ini_suplemento_nopragma (
         psseguro        IN       NUMBER,
         pcmodo          IN       VARCHAR2,
         pfefesup        IN       DATE DEFAULT NULL,
         ptform          IN       VARCHAR2,
         ptcampo         IN       VARCHAR2 DEFAULT '*',
         p_est_sseguro   IN OUT   NUMBER,
         pnmovimi        IN OUT   NUMBER,
         pcmotmov        IN       NUMBER
      )
         RETURN NUMBER
      IS
         --
         num_err         NUMBER;
         mens            VARCHAR2 (2000);
         v_est_sseguro   NUMBER;
         v_sproduc       NUMBER;
         v_nmovimi       NUMBER;
         v_cactivi       NUMBER;
         salir           EXCEPTION;
         vtraza          NUMBER;

         CURSOR est
         IS
            SELECT sseguro
              FROM estseguros
             WHERE ssegpol = psseguro;

         CURSOR risc (v_est_sseguro IN NUMBER)
         IS
            SELECT nriesgo
              FROM estriesgos
             WHERE sseguro = v_est_sseguro AND fanulac IS NULL;
      -- BUG11047:DRA:08/09/2009
      BEGIN
         vtraza := 1;

         FOR c IN est
         LOOP
            pac_alctr126.borrar_tablas_est (c.sseguro);
         END LOOP;

         pac_alctr126.traspaso_tablas_seguros (psseguro,
                                               mens,
                                               'ALSUP003',
                                               NULL,
                                               NVL (pfefesup,
                                                    TRUNC (f_sysdate)
                                                   )
                                              );

         IF mens IS NOT NULL
         THEN
            -- se deber? grabar en tab_error
            num_err := 105419;                               --ERROR TRASPASO
            RAISE salir;
         END IF;

         vtraza := 2;

         -- Averiguamos el sseguro de las tablas EST
         BEGIN
            SELECT MAX (sseguro), MAX (sproduc), MAX (cactivi)
              INTO v_est_sseguro, v_sproduc, v_cactivi
              FROM estseguros
             WHERE ssegpol = psseguro;

            SELECT DISTINCT (nmovimi)
                       INTO v_nmovimi
                       FROM estgaranseg
                      WHERE sseguro = v_est_sseguro;
         EXCEPTION
            WHEN OTHERS
            THEN
               RAISE salir;
         END;

         vtraza := 3;
         -- Ini 3504 -- ECP -- 24/12/2019
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_ini_suplemento_pragma',
                      vtraza,
                      'antes de inicializar y',
                         'pcmotmov'
                      || pcmotmov
                      || 'pcmodo '
                      || pcmodo
                      || ' pfefesup '
                      || pfefesup
                      || ' v_est_sseguro'
                      || v_est_sseguro
                      || '  v_nmovimi '
                      || v_nmovimi
                      || 'v_sproduc-'
                      || v_sproduc
                      || 'num_err'
                      || num_err
                     );
         num_err :=
            pk_suplementos.f_inicializar_fechas (v_est_sseguro,
                                                 v_nmovimi,
                                                 v_sproduc,
                                                 NVL (pfefesup, f_sysdate),
                                                 pcmodo,
                                                 pcmotmov
                                                );  -- BUG15684:DRA:31/08/2010
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_ini_suplemento_pragma',
                      vtraza,
                      'después de inicializar z',
                         'pcmotmov'
                      || pcmotmov
                      || 'pcmodo '
                      || pcmodo
                      || ' pfefesup '
                      || pfefesup
                      || ' v_est_sseguro'
                      || v_est_sseguro
                      || '  v_nmovimi '
                      || v_nmovimi
                      || 'v_sproduc-'
                      || v_sproduc
                      || 'num_err'
                      || num_err
                     );

-- Fin 3504 -- ECP -- 24/12/2019
         IF num_err <> 0
         THEN
            --no hay suplementos
            pac_alctr126.borrar_tablas_est (v_est_sseguro);
            RAISE salir;
         END IF;

         vtraza := 31;
         num_err :=
            pk_suplementos.f_permite_anadir_suplementos (v_est_sseguro,
                                                         UPPER (f_user),
                                                         pcmodo,
                                                         ptform,
                                                         ptcampo,
                                                         pcmotmov
                                                        );

         IF num_err <> 0
         THEN
            --no hay suplementos
            pac_alctr126.borrar_tablas_est (v_est_sseguro);
            RAISE salir;
         END IF;

         vtraza := 4;

         FOR c_risc IN risc (v_est_sseguro)
         LOOP
            -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
            num_err :=
               pk_nueva_produccion.f_garanpro_estgaranseg
                               (v_est_sseguro,
                                c_risc.nriesgo,
                                v_nmovimi,
                                v_sproduc,
                                NVL (pfefesup, TRUNC (f_sysdate)),
                                pac_seguros.ff_get_actividad (v_est_sseguro,
                                                              c_risc.nriesgo,
                                                              'EST'
                                                             )
                               );

            IF num_err <> 0
            THEN
               --no hay suplementos
               pac_alctr126.borrar_tablas_est (v_est_sseguro);
               RAISE salir;
            END IF;
         -- Bug 9699 - APD - 23/04/2009 - fin
         END LOOP;

         vtraza := 5;

         -- de momento se hace aqu?, pero deber?a hacerse en el pac_alctr126.traspaso_tablas_seguros
         UPDATE estclaubenseg
            SET cobliga = 1
          WHERE sseguro = v_est_sseguro;

         p_est_sseguro := v_est_sseguro;
         pnmovimi := v_nmovimi;
         COMMIT;
         RETURN 0;
      EXCEPTION
         WHEN salir
         THEN
            ROLLBACK;
            p_tab_error (f_sysdate,
                         f_user,
                         'pk_suplementos.f_ini_suplemento_nopragma',
                         vtraza,
                         'Error no controlat',
                         num_err || '-' || mens
                        );
            RETURN num_err;
      END f_ini_suplemento_nopragma;
   -- BUG15823:DRA:04/11/2010:Inici
   BEGIN
      vtraza := 1;

      -- Bug 26070 - APD - 11/03/2013
      IF pvalida_supl = 1
      THEN
         num_err :=
            pk_suplementos.f_permite_suplementos (psseguro,
                                                  pfefesup,
                                                  pcmotmov,
                                                  pcmodo
                                                 );

         IF num_err <> 0
         THEN
            RAISE salir;
         END IF;
      END IF;

      -- INI BUG 34462. AFM
      BEGIN
         SELECT sproduc
           INTO lsproduc
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            -- Error al buscar la p?liza
            RETURN 140897;
      END;

      --
      IF NVL (f_parmotmov (pcmotmov, 'FEFECTO_ANT', lsproduc), 0) = 2
      THEN
         -- Validamos que la p?liza no sea administrada.
         IF     NVL (f_parproductos_v (lsproduc, 'ADMITE_CERTIFICADOS'), 0) =
                                                                            1
            AND pac_seguros.f_get_escertifcero (NULL, psseguro) <> 1
            AND pac_seguros.f_es_col_admin (psseguro) = 1
         THEN
            --
            -- Las p?liza administradas no esta?n permitidas en convenios
            RETURN 9907522;
         --
         END IF;

         -- Validamos si ya existe un suplemento retroactivo  anterior
         SELECT COUNT (*), SUM (DECODE (NVL (cregul, 0), 1, 1, 0))
           INTO lcuantos, lcregul
           FROM movseguro
          WHERE sseguro = psseguro AND cmovseg IN (1, 2)
                AND fefecto > pfefesup;

         IF lcregul <> 0
         THEN
            -- no se puede efectuar un suplemento retroactivo anterior al ?ltimo suplemento retroactivo existente en el sistema
            RETURN 9907553;
         END IF;
      END IF;

      -- FIN BUG 34462. AFM

      -- fin Bug 26070 - APD - 11/03/2013

      -- BUG15823:DRA:04/11/2010:Ahora se analiza si utilizar PRAGMA o no para el tema
      --  de los suplementos autom?ticos y diferidos en las renovaciones de cartera, porque
      --  sino no coge bien las FCARPRO que se van actualizando en
      IF NVL (pllamada, 'PRAGMA') = 'NOPRAGMA'
      THEN
         vtraza := 2;
         num_err :=
            f_ini_suplemento_nopragma (psseguro,
                                       pcmodo,
                                       pfefesup,
                                       ptform,
                                       ptcampo,
                                       p_est_sseguro,
                                       pnmovimi,
                                       pcmotmov
                                      );
      ELSE
         vtraza := 3;
         --Bug.: 8947 - ICV - Se crea una nueva funci?n con el pragma autonomous
         -- que tenia la actual, despues de hacer las comprobaciones sobre la misma sesi?n en seguros.
         num_err :=
            f_ini_suplemento_pragma (psseguro,
                                     pcmodo,
                                     pfefesup,
                                     ptform,
                                     ptcampo,
                                     p_est_sseguro,
                                     pnmovimi,
                                     pcmotmov
                                    );
      END IF;

      IF NVL (f_parmotmov (pcmotmov, 'FEFECTO_ANT', lsproduc), 0) = 2
      THEN
         IF lcuantos > 0 AND lcregul = 0
         THEN
            UPDATE estseguros
               SET cregul = 1
             WHERE sseguro = p_est_sseguro;
         END IF;
      END IF;

      RETURN num_err;
   EXCEPTION
      WHEN salir
      THEN
         ROLLBACK;
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_inicializar_suplemento',
                      vtraza,
                      'Error no controlat',
                      num_err || '-' || mens
                     );
         RETURN num_err;
   END f_inicializar_suplemento;

   FUNCTION f_grabar_suplemento_poliza (psseguro IN NUMBER, pnmovimi IN NUMBER)
      RETURN NUMBER
   IS
      /******************************************************************************************
                                             funcion que graba una p?liza una vez que ya estamos en la pantalla final con
        todos los datos validados
      *******************************************************************************************/
      v_ssegpol    NUMBER;
      v_csituac    NUMBER;
      num_err      NUMBER;
      v_nsuplem    NUMBER;
      v_cmotmov    NUMBER;
      v_fsuplem    DATE;
      error        VARCHAR2 (3000);
      prim_total   NUMBER;
      v_nmovimi    NUMBER;
      v_cregul     estseguros.cregul%TYPE;                  -- BUG: 34462 AFM
      vcmovseg     NUMBER;
   BEGIN
      -- obtenemos datos del seguro
      SELECT s.ssegpol, ss.csituac, s.nsuplem, s.cregul
        INTO v_ssegpol, v_csituac, v_nsuplem, v_cregul
        FROM estseguros s, seguros ss
       WHERE s.sseguro = psseguro AND s.ssegpol = ss.sseguro;

      -- obtenemos el motivo de movimiento
      num_err :=
              pk_suplementos.f_obtener_cmotmov (psseguro, pnmovimi, v_cmotmov);

      IF num_err <> 0
      THEN
         RETURN num_err;
      END IF;

      -- obtenemos la fecha de efecto
      num_err := pk_suplementos.f_fecha_efecto (psseguro, pnmovimi, v_fsuplem);

      IF num_err <> 0
      THEN
         RETURN num_err;
      END IF;

      num_err :=
           pac_clausulas.f_ins_clausulas (psseguro, NULL, pnmovimi, v_fsuplem);

      IF num_err <> 0
      THEN
         RETURN num_err;
      END IF;

      -- bug 0024832 afegir 17
      IF v_csituac NOT IN (5, 17)
      THEN
         -- si = 5 estamos modificando una propuesta de suplemento
         -- si =17 estamos modificando una propuesta de cartera
         num_err :=
            f_movseguro (v_ssegpol,
                         NULL,
                         v_cmotmov,
                         1,
                         v_fsuplem,
                         NULL,
                         v_nsuplem + 1,
                         0,
                         NULL,
                         v_nmovimi,
                         -- BUG 34462 - AFM
                         NULL,
                         NULL,
                         NULL,
                         NULL,
                         v_cregul
                        );

         IF num_err <> 0
         THEN
            RETURN num_err;
         END IF;

         IF v_nmovimi <> pnmovimi
         THEN
            RETURN 9999;
         END IF;

         num_err := f_act_hisseg (v_ssegpol, v_nmovimi - 1);

         IF num_err <> 0
         THEN
            RETURN num_err;
         END IF;

         UPDATE estseguros
            SET csituac = 5,
                nsuplem = v_nsuplem + 1
          WHERE sseguro = psseguro;
      --(JAS)11.12.2007 Afegit per a evitar passarli un null com a nmovimi a la funci? de traspaso de tablas_est,
      --cosa que provocava l'esborrat de totes els moviments de la p?lissa.
      ELSE
         v_nmovimi := pnmovimi;
      END IF;

      -- traspasamos a las tablas de SEGUROS
      pac_alctr126.traspaso_tablas_est (psseguro,
                                        v_fsuplem,
                                        NULL,
                                        error,
                                        'ALSUP003',
                                        NULL,
                                        v_nmovimi,
                                        v_fsuplem
                                       );

      IF error IS NOT NULL
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_nueva_produccion.f_grabar_suplemento_poliza',
                      1,
                         'traspaso tablas sseguro ='
                      || psseguro
                      || ' ssegpol ='
                      || v_ssegpol,
                      error
                     );
         RETURN 105419;                                      -- error traspaso
      END IF;

      -- Averiguamos el iprianu total
      prim_total := f_segprima (v_ssegpol, v_fsuplem);

      -- modificamos los valores del seguro
      BEGIN
         UPDATE seguros
            SET iprianu = prim_total
          WHERE sseguro = v_ssegpol;
      EXCEPTION
         WHEN OTHERS
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         'pk_nueva_produccion.f_grabar_suplemento_poliza',
                         2,
                         'error al modificar seguros  ssegpol =' || v_ssegpol,
                         SQLERRM
                        );
            RETURN 102361;              -- error al modificar la tabla seguros
      END;

      SELECT cmovseg
        INTO vcmovseg
        FROM codimotmov
       WHERE cmotmov = v_cmotmov;                                  --Convenios

      IF vcmovseg <> 6
      THEN
         -- modificamos los valores de garanseg
         BEGIN
            UPDATE garanseg
               SET ffinefe = v_fsuplem
             WHERE sseguro = v_ssegpol AND ffinefe > v_fsuplem;
         EXCEPTION
            WHEN OTHERS
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_nueva_produccion.f_grabar_suplemento_poliza',
                            2,
                               'error al modificar garanseg  ssegpol ='
                            || v_ssegpol,
                            SQLERRM
                           );
               RETURN 180385;           -- error al modificar la tabla seguros
         END;
      ELSE
         BEGIN
            UPDATE garanseg
               SET ffinefe = v_fsuplem
             WHERE sseguro = v_ssegpol AND nmovimi = v_nmovimi;
         EXCEPTION
            WHEN OTHERS
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_nueva_produccion.f_grabar_suplemento_poliza',
                            3,
                               'error al modificar garanseg  ssegpol ='
                            || v_ssegpol,
                            SQLERRM
                           );
               RETURN 180385;           -- error al modificar la tabla seguros
         END;
      END IF;

      num_err := f_final_suplemento (psseguro, v_nmovimi, v_ssegpol);
      RETURN 0;
   END f_grabar_suplemento_poliza;

   FUNCTION f_final_suplemento (
      p_est_sseguro   IN   NUMBER,
      pnmovimi        IN   NUMBER,
      psseguro        IN   NUMBER
   )
      RETURN NUMBER
   IS
      --     PRAGMA autonomous_transaction;
      num_err   NUMBER;
   BEGIN
      pac_alctr126.borrar_tablas_est (p_est_sseguro);
      --  num_err    := Pk_Suplementos.f_borrar_supdirecciones (psseguro, NULL);

      --  IF num_err <> 0 THEN
      --      RETURN num_err;
      --  END IF;

      --  p_borrar_datos_asegurado (psseguro);
      --      COMMIT;
      RETURN 0;
   END f_final_suplemento;

   FUNCTION f_update_rec_pend (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      -- Bug 11488 - 21/10/2009 - AMC
      CURSOR recibos_poliza
      IS
         SELECT nrecibo, ccobban, cestaux, cestimp, cbancar, cgescob,
                ctipban, ctipcob
           -- 74. 0026728 (anadir ctipban), MDS - 27/01/2015 - a?adido ctipcob
         FROM   recibos
          WHERE sseguro = psseguro
            AND NVL (f_cestrec (nrecibo, NULL), 0) = 0
            AND NVL (recibos.esccero, 0) = 0;

      -- Fi Bug 11488 - 21/10/2009 - AMC
      v_cbancar   seguros.cbancar%TYPE;
      v_ctipban   seguros.ctipban%TYPE;        -- 74. 0026728 (anadir ctipban)
      v_ccobban   NUMBER;
      v_ctipcob   seguros.ctipcob%TYPE;
      -- MDS - 27/01/2015 - a?adido tipo de cobro
      v_csoprec   agentes.csoprec%TYPE;
      -- MDS - 03/02/2015 - a?adido soporte recibos agentes
      v_cestimp   recibos.cestimp%TYPE;
   -- MDS - 03/02/2015 - a?adido estado impresi?n recibos
   BEGIN
      BEGIN
         SELECT cbancar, ccobban, ctipban,
                ctipcob                        -- 74. 0026728 (anadir ctipban)
           INTO v_cbancar, v_ccobban, v_ctipban,
                v_ctipcob
           -- 74. 0026728 (anadir ctipban), MDS - 27/01/2015 - a?adido ctipcob
         FROM   seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN OTHERS
         THEN
            RETURN 101919;               -- error al leer de la tabla seguros
      END;

      -- MDS - 03/02/2015 - obtener csoprec del agente
      BEGIN
         SELECT csoprec
           INTO v_csoprec
           FROM agentes
          WHERE cagente = (SELECT cagente
                             FROM seguros
                            WHERE sseguro = psseguro);
      EXCEPTION
         WHEN OTHERS
         THEN
            RETURN 104473;               -- error al leer de la tabla agentes
      END;

      -- MDS - 03/02/2015 - obtener el nuevo estado impresi?n del recibo
      IF v_csoprec IS NOT NULL AND v_csoprec = 2
      THEN
         v_cestimp := 0;                                     -- No se imprime
      ELSE
         IF v_ccobban IS NULL
         THEN
            v_cestimp := 1;                             -- Pendiente imprimir
         ELSE
            v_cestimp := 4;                          -- Pendiente env?o cobro
         END IF;
      END IF;

      FOR reg IN recibos_poliza
      LOOP
         -- MDS - 27/01/2015 - a?adido tipo de cobro
         -- cuidado que campos a null no se interpretan correctamente sin el nvl
         IF    NVL (v_ctipcob, -1) <> NVL (reg.ctipcob, -1)
            OR NVL (v_cbancar, '#') <> NVL (reg.cbancar, '#')
            OR NVL (v_ctipban, -1) <> NVL (reg.ctipban, -1)
            -- 74. 0026728 (anadir ctipban)
            OR NVL (v_ccobban, -1) <> NVL (reg.ccobban, -1)
         THEN
            -- Modificamos los recibos.
            BEGIN
               UPDATE recibos
                  SET ctipcob = v_ctipcob,
                      cbancar = v_cbancar,
                      ccobban = v_ccobban,
                      ctipban = v_ctipban,     -- 74. 0026728 (anadir ctipban)
                      cestimp = v_cestimp
                -- MDS - 03/02/2015 - a?adido cestimp
               WHERE  nrecibo = reg.nrecibo;
            EXCEPTION
               WHEN OTHERS
               THEN
                  p_tab_error (f_sysdate,
                               f_user,
                               'pk_suplementos==> f_update_rec_pend',
                               1,
                               'error al modificar el recibo',
                                  'SSEGURO ='
                               || psseguro
                               || ' nrecibo ='
                               || reg.nrecibo
                               || 'error ='
                               || SQLERRM
                              );
                  RETURN 102358;
            END;
         END IF;
      END LOOP;

      RETURN 0;
   END f_update_rec_pend;

   FUNCTION f_abrir_sin_baja_ries (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      CURSOR c_riesgos_baja (pnmovimi IN NUMBER)
      IS
         -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
         SELECT   nriesgo, r.fefecto, r.fanulac, s.sproduc, p.nnumpag,
                  pac_seguros.ff_get_actividad (s.sseguro, r.nriesgo)
                                                                     cactivi,
                  s.cbancar
             FROM riesgos r, seguros s, productos p
            WHERE r.sseguro = psseguro
              AND nmovimb = pnmovimi
              AND s.sseguro = r.sseguro
              AND p.sproduc = s.sproduc
         ORDER BY nriesgo;

      -- Bug 9699 - APD - 23/04/2009 - fin
      CURSOR c_gar (pnriesgo IN NUMBER)
      IS
         SELECT *
           FROM garanseg
          WHERE sseguro = psseguro
            AND nriesgo = pnriesgo
            AND nmovimi =
                      (SELECT MAX (gg.nmovimi)
                         FROM garanseg gg
                        WHERE gg.sseguro = psseguro AND gg.nriesgo = pnriesgo);

      vdescri      VARCHAR2 (1000);
      num_err      NUMBER;
      anyos        NUMBER;
      ptraza       NUMBER;
      v_fsinies    DATE;
      v_fnotifi    DATE;
      v_nsinies    NUMBER;
      v_ivalora    NUMBER;
      v_icaprisc   NUMBER;
      v_ipenali    NUMBER;
      v_sproduc    NUMBER;
      v_nnumpag    NUMBER;
      v_cactivi    NUMBER;
      v_cbancar    seguros.cbancar%TYPE;
      v_nmovimi    NUMBER;
      v_cempres    NUMBER;
      v_ntramit    NUMBER;
      v_ctramit    NUMBER;
      v_nmovres    NUMBER;
      v_ifranq     NUMBER;                          --Bug 27059:NSS:03/06/2013
   BEGIN
      SELECT MAX (nmovimi)
        INTO v_nmovimi
        FROM movseguro
       WHERE sseguro = psseguro;

      -- BUG 11595 - 03/11/2009 - APD - Adaptaci?n al nuevo m?dulo de siniestros
      -- En funci?n del parempresa 'MODULO_SINI' si = 0, entonces se est? en el
      -- modulo antiguo (se ejecutar? la primera parte del IF); si = 1, entonces
      -- se est? en el modulo nuevo (se ejecutar? la segunda parte del IF)
      -- Hay que tener en cuenta que cuando se modifique alguna parte de un IF
      -- se debe modificar tambi?n la otra (es decir, cuando se haga una modificacion
      -- para el modelo antiguo de siniestros, por ejemplo, el mismo cambio se debe
      -- replicar para el modelo nuevo de siniestros)
      SELECT cempres
        INTO v_cempres
        FROM seguros
       WHERE sseguro = psseguro;

      -- Modelo antiguo de siniestros
      IF NVL (pac_parametros.f_parempresa_n (v_cempres, 'MODULO_SINI'), 0) = 0
      THEN
         -- el siniestro ser? un rescate parcial por la baja de un riesgo
         FOR i IN c_riesgos_baja (v_nmovimi)
         LOOP
            num_err := f_difdata (i.fefecto, i.fanulac, 1, 1, anyos);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            ptraza := 1;

            IF anyos >= 2
            THEN
               v_fsinies := i.fanulac;
               v_fnotifi := TRUNC (f_sysdate);
               ptraza := 2;
               vdescri :=
                      f_desriesgo_t (psseguro, i.nriesgo, NULL, f_usu_idioma);
               -- BUG10519:DRA:09/07/2009
               num_err :=
                  pac_sin.f_inicializar_siniestro (psseguro,
                                                   i.nriesgo,
                                                   v_fsinies,
                                                   v_fnotifi,
                                                      'Rescate Asegurado: '
                                                   || vdescri,
                                                   5,
                                                   0,
                                                   20,
                                                   v_nsinies,
                                                   NULL
                                                  );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;

               -- marcamos el siniestro con el nmovimi del suplemento
               UPDATE siniestros
                  SET nmovimi = v_nmovimi
                WHERE nsinies = v_nsinies;

               -- VALORACIONES
               FOR ii IN c_gar (i.nriesgo)
               LOOP
                  ptraza := 3;
                  num_err :=
                     pk_cal_sini.valo_pagos_sini (v_fsinies,
                                                  psseguro,
                                                  v_nsinies,
                                                  i.sproduc,
                                                  i.cactivi,
                                                  ii.cgarant,
                                                  4,
                                                  0,
                                                  v_fnotifi,
                                                  v_ivalora,
                                                  v_ipenali,
                                                  v_icaprisc
                                                 );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;

                  ptraza := 4;
                  num_err :=
                     pac_sin_insert.f_insert_valoraciones (v_nsinies,
                                                           ii.cgarant,
                                                           v_fnotifi,
                                                           v_ivalora,
                                                           v_ipenali,
                                                           v_icaprisc
                                                          );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               END LOOP;

               -- DESTINATARIOS
               ptraza := 5;
               num_err :=
                  pac_sin_insert.f_insert_destinatarios (v_nsinies,
                                                         psseguro,
                                                         i.nriesgo,
                                                         i.nnumpag,
                                                         1,
                                                         1,
                                                         NULL,
                                                         NULL,
                                                         i.cbancar,
                                                         NULL
                                                        );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;
            END IF;
         END LOOP;
      ELSE
         -- Modelo nuevo de siniestros
         -- el siniestro ser? un rescate parcial por la baja de un riesgo
         FOR i IN c_riesgos_baja (v_nmovimi)
         LOOP
            num_err := f_difdata (i.fefecto, i.fanulac, 1, 1, anyos);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            ptraza := 1;

            IF anyos >= 2
            THEN
               v_fsinies := i.fanulac;
               v_fnotifi := TRUNC (f_sysdate);
               ptraza := 2;
               vdescri :=
                      f_desriesgo_t (psseguro, i.nriesgo, NULL, f_usu_idioma);
               -- BUG10519:DRA:09/07/2009
               num_err :=
                  pac_siniestros.f_inicializa_sin (psseguro,
                                                   i.nriesgo,
                                                   NULL,
                                                   v_fsinies,
                                                   v_fnotifi,
                                                      'Rescate Asegurado: '
                                                   || vdescri,
                                                   5,
                                                   0,
                                                   20,
                                                   v_nsinies,
                                                   v_nmovimi,
                                                   v_ntramit
                                                  );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;

               -- marcamos el siniestro con el nmovimi del suplemento
               UPDATE sin_siniestro
                  SET nmovimi = v_nmovimi
                WHERE nsinies = v_nsinies;

               -- VALORACIONES
               FOR ii IN c_gar (i.nriesgo)
               LOOP
                  BEGIN
                     SELECT ctramit
                       INTO v_ctramit
                       FROM sin_tramitacion
                      WHERE nsinies = v_nsinies AND ntramit = v_ntramit;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        RETURN 9000859;
                  -- Error al leer de la tabla SIN_TRAMITACION
                  END;

                  ptraza := 3;
                  num_err :=
                     pac_sin_formula.f_cal_valora (v_fsinies,
                                                   psseguro,
                                                   NULL,
                                                   v_nsinies,
                                                   v_ntramit,
                                                   v_ctramit,
                                                   i.sproduc,
                                                   i.cactivi,
                                                   ii.cgarant,
                                                   4,
                                                   0,
                                                   v_fnotifi,
                                                   f_sysdate,
                                                   NULL,
                                                   NULL,
                                                   v_ivalora,
                                                   v_ipenali,
                                                   v_icaprisc,
                                                   v_ifranq
                                                  --Bug 27059:NSS:03/06/2013
                                                  );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;

                  ptraza := 4;
                  num_err :=
                     pac_siniestros.f_ins_reserva (v_nsinies,
                                                   v_ntramit,
                                                   1,
                                                   ii.cgarant,
                                                   1,
                                                   v_fnotifi,
                                                   'EUR',
                                                     NVL (v_ivalora, 0)
                                                   - NVL (v_ipenali, 0),
                                                   NULL,
                                                   v_icaprisc,
                                                   v_ipenali,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   NULL,
                                                   v_nmovres,
                                                   1,
                                                   --cmovres --Bug 31294/174788:NSS:22/05/2014
                                                   v_ifranq
                                                  --Bug 27059:NSS:03/06/2013
                                                  );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               END LOOP;

               -- DESTINATARIOS
               ptraza := 5;
               num_err :=
                  pac_sin_rescates.f_ins_destinatario (v_nsinies,
                                                       v_ntramit,
                                                       psseguro,
                                                       i.nriesgo,
                                                       i.nnumpag,
                                                       1,
                                                       1,
                                                       NULL,
                                                       NULL,
                                                       i.cbancar,
                                                       NULL
                                                      );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;
            END IF;
         END LOOP;
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_abrir_sin_baja_ries',
                      ptraza,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;
         RETURN 0;
   END f_abrir_sin_baja_ries;

   FUNCTION f_abrir_sin_baja_gar (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      CURSOR c_gar_baja_rie (pnmovimi IN NUMBER)
      IS
         SELECT DISTINCT r.nriesgo, g.ffinefe, r.fefecto,
                         g.nmovimi nmov_baja
                    FROM garanseg g, riesgos r
                   WHERE r.sseguro = g.sseguro
                     AND r.nriesgo = g.nriesgo
                     AND r.sseguro = psseguro
                     AND r.fanulac IS NULL             -- no est? dado de baja
                     AND g.ffinefe IS NOT NULL
                     AND g.nmovimi =
                            (SELECT MAX (nmovimi)
                               FROM garanseg ggg
                              WHERE ggg.sseguro = g.sseguro
                                AND ggg.nriesgo = g.nriesgo
                                -- AND    ggg.cgarant = g.cgarant
                                AND ggg.nmovimi < pnmovimi)
                     AND NOT EXISTS (
                            SELECT ggg.cgarant
                              FROM garanseg ggg
                             WHERE ggg.sseguro = g.sseguro
                               AND ggg.nriesgo = g.nriesgo
                               AND ggg.cgarant = g.cgarant
                               AND ggg.nmovimi = pnmovimi);

      CURSOR c_gar_baja (
         pnriesgo     IN   NUMBER,
         pnmov_baja   IN   NUMBER,
         pnmovimi     IN   NUMBER,
         psproduc     IN   NUMBER
      )
      IS
         SELECT r.nriesgo, g.cgarant
           FROM garanseg g, riesgos r, seguros s
          WHERE r.sseguro = g.sseguro
            AND r.nriesgo = g.nriesgo
            AND r.sseguro = psseguro
            AND r.nriesgo = pnriesgo
            AND r.fanulac IS NULL                      -- no est? dado de baja
            AND g.ffinefe IS NOT NULL
            AND g.nmovimi = pnmov_baja
            -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas
            AND g.sseguro = s.sseguro
            AND (   f_parproductos_v (psproduc, 'DETALLE_GARANT') IS NULL
                 OR (    f_parproductos_v (psproduc, 'DETALLE_GARANT') IN
                                                                       (1, 2)
                     AND NVL (f_pargaranpro_v (s.cramo,
                                               s.cmodali,
                                               s.ctipseg,
                                               s.ccolect,
                                               s.cactivi,
                                               g.cgarant,
                                               'REDUCIBLE'
                                              ),
                              0
                             ) = 1
                    )
                )
            -- Fin Bug 14741
            AND NOT EXISTS (
                   SELECT ggg.cgarant
                     FROM garanseg ggg
                    WHERE ggg.sseguro = g.sseguro
                      AND ggg.nriesgo = g.nriesgo
                      AND ggg.cgarant = g.cgarant
                      AND ggg.nmovimi = pnmovimi);

      vdescri      VARCHAR2 (1000);
      num_err      NUMBER;
      anyos        NUMBER;
      ptraza       NUMBER;
      v_fsinies    DATE;
      v_fnotifi    DATE;
      v_nsinies    NUMBER;
      v_ivalora    NUMBER;
      v_icaprisc   NUMBER;
      v_ipenali    NUMBER;
      v_sproduc    NUMBER;
      v_nnumpag    NUMBER;
      v_cactivi    NUMBER;
      v_cbancar    seguros.cbancar%TYPE;
      v_nmovimi    NUMBER;
      v_cempres    NUMBER;
      v_ntramit    NUMBER;
      v_ctramit    NUMBER;
      v_nmovres    NUMBER;
      -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas
      v_nmovimi2   NUMBER;
      v_unavez     NUMBER                 := 0;
      v_ifranq     NUMBER;                          --Bug 27059:NSS:03/06/2013
   -- Fin Bug 14741
   BEGIN
      SELECT MAX (nmovimi)
        INTO v_nmovimi
        FROM movseguro
       WHERE sseguro = psseguro;

      -- Bug 13829 - 31/05/2010 - Rescates APR
      v_nmovimi2 := v_nmovimi;

      -- Fin Bug 13829

      -- BUG 11595 - 03/11/2009 - APD - Adaptaci?n al nuevo m?dulo de siniestros
      -- En funci?n del parempresa 'MODULO_SINI' si = 0, entonces se est? en el
      -- modulo antiguo (se ejecutar? la primera parte del IF); si = 1, entonces
      -- se est? en el modulo nuevo (se ejecutar? la segunda parte del IF)
      -- Hay que tener en cuenta que cuando se modifique alguna parte de un IF
      -- se debe modificar tambi?n la otra (es decir, cuando se haga una modificacion
      -- para el modelo antiguo de siniestros, por ejemplo, el mismo cambio se debe
      -- replicar para el modelo nuevo de siniestros)
      SELECT cempres
        INTO v_cempres
        FROM seguros
       WHERE sseguro = psseguro;

      -- Modelo antiguo de siniestros
      IF NVL (pac_parametros.f_parempresa_n (v_cempres, 'MODULO_SINI'), 0) = 0
      THEN
         -- el siniestro ser? un rescate parcial por la baja de garantias
         FOR i IN c_gar_baja_rie (v_nmovimi)
         LOOP
            num_err := f_difdata (i.fefecto, i.ffinefe, 1, 1, anyos);

            IF num_err <> 0
            THEN
               RETURN num_err;
            END IF;

            ptraza := 1;

            IF anyos >= 2
            THEN
               v_fsinies := i.ffinefe;
               v_fnotifi := TRUNC (f_sysdate);

               BEGIN
                  -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
                  SELECT s.sproduc, nnumpag,
                         pac_seguros.ff_get_actividad (s.sseguro, i.nriesgo)
                                                                      cactivi,
                         cbancar
                    INTO v_sproduc, v_nnumpag,
                         v_cactivi,
                         v_cbancar
                    FROM seguros s, productos p
                   WHERE p.sproduc = s.sproduc AND s.sseguro = psseguro;
               -- Bug 9699 - APD - 23/04/2009 - fin
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     RETURN 101903;
               -- seguro no encontrado en la tabla seguros
               END;

               ptraza := 2;
               vdescri :=
                       f_desriesgo_t (psseguro, i.nriesgo, NULL, f_usu_idioma);
               -- BUG10519:DRA:09/07/2009
               num_err :=
                  pac_sin.f_inicializar_siniestro (psseguro,
                                                   i.nriesgo,
                                                   v_fsinies,
                                                   v_fnotifi,
                                                      'Rescate Asegurado: '
                                                   || vdescri,
                                                   5,
                                                   1,
                                                   20,
                                                   v_nsinies,
                                                   NULL
                                                  );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;

               -- marcamos el siniestro con el nmovimi del suplemento
               UPDATE siniestros
                  SET nmovimi = v_nmovimi
                WHERE nsinies = v_nsinies;

               -- VALORACIONES
               FOR ii IN c_gar_baja (i.nriesgo,
                                     i.nmov_baja,
                                     v_nmovimi,
                                     v_sproduc
                                    )
               LOOP
                  ptraza := 3;
                  num_err :=
                     pk_cal_sini.valo_pagos_sini (v_fsinies,
                                                  psseguro,
                                                  v_nsinies,
                                                  v_sproduc,
                                                  v_cactivi,
                                                  ii.cgarant,
                                                  4,
                                                  0,
                                                  v_fnotifi,
                                                  v_ivalora,
                                                  v_ipenali,
                                                  v_icaprisc
                                                 );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;

                  ptraza := 4;
                  num_err :=
                     pac_sin_insert.f_insert_valoraciones (v_nsinies,
                                                           ii.cgarant,
                                                           v_fnotifi,
                                                           v_ivalora,
                                                           v_ipenali,
                                                           v_icaprisc
                                                          );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;
               END LOOP;

               -- DESTINATARIOS
               ptraza := 5;
               num_err :=
                  pac_sin_insert.f_insert_destinatarios (v_nsinies,
                                                         psseguro,
                                                         i.nriesgo,
                                                         v_nnumpag,
                                                         1,
                                                         1,
                                                         NULL,
                                                         NULL,
                                                         v_cbancar,
                                                         NULL
                                                        );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;
            END IF;
         END LOOP;
      ELSE
         -- Modelo nuevo de siniestros
         -- el siniestro ser? un rescate parcial por la baja de garantias
         FOR i IN c_gar_baja_rie (v_nmovimi)
         LOOP
            -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas
            --num_err := f_difdata(i.fefecto, i.ffinefe, 1, 1, anyos);
            --IF num_err <> 0 THEN
            --   RETURN num_err;
            --END IF;
            -- Fin Bug 14741
            ptraza := 1;
            -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas (4, 0 --> 5, 1)
            --IF anyos >= 2 THEN
            -- Fin Bug 14741
            v_fsinies := i.ffinefe;
            v_fnotifi := TRUNC (f_sysdate);

            BEGIN
               -- Bug 9699 - APD - 23/04/2009 - en lugar de coger la acticad de la tabla seguros, llamar a la funci?n pac_seguros.ff_get_actividad
               SELECT s.sproduc, nnumpag,
                      pac_seguros.ff_get_actividad (s.sseguro, i.nriesgo)
                                                                      cactivi,
                      cbancar
                 INTO v_sproduc, v_nnumpag,
                      v_cactivi,
                      v_cbancar
                 FROM seguros s, productos p
                WHERE p.sproduc = s.sproduc AND s.sseguro = psseguro;
            -- Bug 9699 - APD - 23/04/2009 - fin
            EXCEPTION
               WHEN OTHERS
               THEN
                  RETURN 101903;  -- seguro no encontrado en la tabla seguros
            END;

            -- VALORACIONES
            FOR ii IN c_gar_baja (i.nriesgo,
                                  i.nmov_baja,
                                  v_nmovimi2,
                                  v_sproduc
                                 )
            LOOP
               IF v_unavez = 0
               THEN
                  ptraza := 2;
                  vdescri :=
                      f_desriesgo_t (psseguro, i.nriesgo, NULL, f_usu_idioma);
                  -- BUG10519:DRA:09/07/2009
                  num_err :=
                     pac_siniestros.f_inicializa_sin
                                                   (psseguro,
                                                    i.nriesgo,
                                                    NULL,
                                                    v_fsinies,
                                                    v_fnotifi,
                                                       'Rescate Asegurado: '
                                                    || vdescri,
                                                    5,
                                                    1,
                                                    20,
                                                    v_nsinies,
                                                    v_nmovimi,
                                                    v_ntramit
                                                   );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;

                  -- marcamos el siniestro con el nmovimi del suplemento
                  UPDATE sin_siniestro
                     SET nmovimi = v_nmovimi
                   WHERE nsinies = v_nsinies;
               END IF;

               BEGIN
                  SELECT ctramit
                    INTO v_ctramit
                    FROM sin_tramitacion
                   WHERE nsinies = v_nsinies AND ntramit = v_ntramit;
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     RETURN 9000859;
               -- Error al leer de la tabla SIN_TRAMITACION
               END;

               ptraza := 3;
               -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas (4, 0 --> 5, 1)
               num_err :=
                  pac_sin_formula.f_cal_valora (v_fsinies,
                                                psseguro,
                                                NULL,
                                                v_nsinies,
                                                v_ntramit,
                                                v_ctramit,
                                                v_sproduc,
                                                v_cactivi,
                                                ii.cgarant,
                                                5,
                                                1,
                                                v_fnotifi,
                                                f_sysdate,
                                                NULL,
                                                NULL,
                                                v_ivalora,
                                                v_ipenali,
                                                v_icaprisc,
                                                v_ifranq
                                               --Bug 27059:NSS:03/06/2013
                                               );

               -- Fin Bug 14741
               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;

               ptraza := 4;
               num_err :=
                  pac_siniestros.f_ins_reserva (v_nsinies,
                                                v_ntramit,
                                                1,
                                                ii.cgarant,
                                                1,
                                                v_fnotifi,
                                                'EUR',
                                                  NVL (v_ivalora, 0)
                                                - NVL (v_ipenali, 0),
                                                NULL,
                                                v_icaprisc,
                                                v_ipenali,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                v_nmovres,
                                                1,
                                                --cmovres --Bug 31294/174788:NSS:22/05/2014
                                                v_ifranq
                                               --Bug 27059:NSS:03/06/2013
                                               );

               IF num_err <> 0
               THEN
                  RETURN num_err;
               END IF;

               IF v_unavez = 0
               THEN
                  -- DESTINATARIOS
                  ptraza := 5;
                  num_err :=
                     pac_sin_rescates.f_ins_destinatario (v_nsinies,
                                                          v_ntramit,
                                                          psseguro,
                                                          i.nriesgo,
                                                          v_nnumpag,
                                                          1,
                                                          1,
                                                          NULL,
                                                          NULL,
                                                          v_cbancar,
                                                          NULL
                                                         );

                  IF num_err <> 0
                  THEN
                     RETURN num_err;
                  END IF;

                  v_unavez := 1;
               END IF;
            END LOOP;
           -- Bug 14741 - 31/05/2010 - APR703 - Baja de garant?as b?sicas (4, 0 --> 5, 1)
         --END IF;
         -- Fin Bug 14741
         END LOOP;
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_abrir_sin_baja_gar',
                      ptraza,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;
   END f_abrir_sin_baja_gar;

   FUNCTION f_post_suplemento (
      psseguro   IN   NUMBER,
      pcmodo     IN   VARCHAR2 DEFAULT 'SUPLEMENTO'
   )
      RETURN NUMBER
   IS
      CURSOR c_procedure (
         puser      IN   VARCHAR2,
         pcmotmov   IN   NUMBER,
         psproduc   IN   NUMBER,
         pcmodo     IN   VARCHAR2
      )
      IS
         SELECT   pp.*
             FROM pds_post_supl pp,
                  pds_supl_config pd,
                  pds_supl_cod_config pds,
                  pds_config_user pu
            WHERE pu.cuser = puser
              AND pu.cconsupl = pds.cconsupl
              AND pds.cconfig = pd.cconfig
              AND pd.cmotmov = pcmotmov
              AND pd.sproduc = psproduc
              AND pd.cmodo = pcmodo
              AND pd.cconfig = pp.cconfig
         ORDER BY pp.norden;

      CURSOR c_suplementos (psseguro IN NUMBER)
      IS
         SELECT DISTINCT d.cmotmov, s.sproduc, m.cusumov
                    FROM detmovseguro d, seguros s, movseguro m
                   WHERE d.sseguro = psseguro
                     AND d.sseguro = s.sseguro
                     AND s.sseguro = m.sseguro
                     AND m.nmovimi = d.nmovimi
                     AND d.nmovimi = (SELECT MAX (mm.nmovimi)
                                        FROM movseguro mm
                                       WHERE mm.sseguro = psseguro)
                ORDER BY cmotmov;

      num_err   NUMBER          := 0;
      ss        VARCHAR2 (3000);
   BEGIN
      FOR cur_sup IN c_suplementos (psseguro)
      LOOP
         -- para cada motivo de suplemento miramos si hay un procedimiento a ejecutar
         FOR cur IN c_procedure (cur_sup.cusumov,
                                 cur_sup.cmotmov,
                                 cur_sup.sproduc,
                                 pcmodo
                                )
         LOOP
            num_err := 0;
            ss := 'begin :num_err := ' || cur.tfuncion || '(:psseguro); end;';

            EXECUTE IMMEDIATE ss
                        USING OUT num_err, IN psseguro;

            IF num_err <> 0
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_suplementos==> f_post_suplemento',
                            1,
                            'num_err funcion <> 0',
                               'SSEGURO ='
                            || psseguro
                            || ' num_err ='
                            || num_err
                            || ' funcion ='
                            || cur.tfuncion
                           );
               RETURN num_err;
            END IF;
         END LOOP;
      END LOOP;

      RETURN num_err;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos==> f_post_suplemento',
                      1,
                      'num_err funcion <> 0',
                      'SSEGURO =' || psseguro || ' error =' || SQLERRM
                     );
         RETURN -1;
   END f_post_suplemento;

   FUNCTION f_anular_riesgo (
      psseguro     IN   NUMBER,
      pnriesgo     IN   NUMBER,
      pfanulac     IN   DATE,
      pnmovimi     IN   NUMBER,
      pssegpol     IN   NUMBER,
      pcnotibaja   IN   NUMBER DEFAULT NULL,
      pcmotmov     IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      vnmovimi_vig    NUMBER;
      vnmovimi_prop   NUMBER;
      vsproduc        NUMBER;
      vcobjase        NUMBER;
      vsperson        NUMBER;
      vcdomici        NUMBER;
      vcont           NUMBER;
      --ACC 13122008
      valpar          NUMBER;
      vsperasegnext   NUMBER;
      vcdomici_pol    NUMBER;
      vcdomici_new    NUMBER;
      num_err         NUMBER;
   BEGIN
      DELETE FROM estpregunseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estpregunsegtab
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estpregungaranseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estpregungaransegtab
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG11047:DRA:04/09/2009:Inici
      DELETE FROM estdetgaranseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estgaransegcom
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- Bug 21121 - APD - 23/02/2012 - se anade la tabla estdetprimas
      DELETE FROM estdetprimas
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- fin Bug 21121 - APD - 23/02/2012
      DELETE FROM estgaranseggas
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estgaranseg_sbpri
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG 34462 - AFM ini
      DELETE FROM esttramosregul
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG 34462 - AFM  fin

      -- BUG11047:DRA:04/09/2009:Fi
      DELETE FROM estgaranseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estresulseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estclaubenseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estclauparesp
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estclausuesp
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG11047:DRA:04/09/2009:Inici
      DELETE FROM estautconductores
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estautdetriesgos
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estautriesgos
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- Bug 11165 - 16/09/2009 - AMC - Se sustitune  estdetsaldodeutorseg por estprestamoseg
      DELETE FROM estprestamoseg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estmotreten_rev
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estmotretencion
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      DELETE FROM estplanrentasirreg
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG 34462 - AFM ini
      DELETE FROM estaseguradosmes
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG 34462 - AFM  fin
      DELETE FROM estsegdisin2
            WHERE sseguro = psseguro
              AND nriesgo = pnriesgo
              AND nmovimi = pnmovimi;

      -- BUG11047:DRA:04/09/2009:Fi
      UPDATE estassegurats
         SET ffecfin = pfanulac
       WHERE sseguro = psseguro AND norden = pnriesgo;

      UPDATE estriesgos
         SET fanulac = pfanulac,
             nmovimb = pnmovimi
       WHERE sseguro = psseguro AND nriesgo = pnriesgo;

      -- jmc 04/01/05.
      -- Si el riesgo es el tomador se cambia el tomador por el
      -- minimo nriesgo activo.

      -- 1 Saber si el objeto asegurado del seguro es una persona.
      SELECT sproduc
        INTO vsproduc
        FROM estseguros
       WHERE sseguro = psseguro;

      SELECT cobjase
        INTO vcobjase
        FROM productos
       WHERE sproduc = vsproduc;

      -- 2 Saber si la persona de tomadores es la misma que el riesgo que
      --   estamos anulando. En este caso cambio del tomador
      IF vcobjase = 1
      THEN
         --ACC 13122008
         -- Adaptar l'anul?laci? d'un risc en funci? del parproductos ANULRIESCTOM
         -- i assignar els valors nous per el prenador en cas necessari
         num_err := f_parproductos (vsproduc, 'ANULRIESCTOM', valpar);

         IF num_err <> 0
         THEN
            RETURN num_err;
         END IF;

         IF NVL (valpar, 0) = 1
         THEN
            --comprovar parproductos ANULRIESCTOM
            --ACC 13122008 codi existen
            SELECT sperson
              INTO vsperson
              FROM estriesgos
             WHERE sseguro = psseguro AND nriesgo = pnriesgo;

            SELECT COUNT (*)
              INTO vcont
              FROM esttomadores
             WHERE sseguro = psseguro AND sperson = vsperson;

            IF vcont > 0
            THEN
               --ACC 15122008
               --S'ha de comprovar que tingui m?s d'un  prenador
               --si t? m?s d'un el seg?ent passa a ser el principal
               --si no tingues prenedors el seg?ent assegurat passa a ser
               --prenador amb la dirrecci? de l'ultim prenador actiu
               SELECT COUNT (*)
                 INTO vcont
                 FROM esttomadores
                WHERE sseguro = psseguro;

               IF vcont > 1
               THEN
                  --t? m?s que el prenador actual
                  DELETE      esttomadores
                        WHERE sseguro = psseguro AND sperson = vsperson;

                  UPDATE esttomadores
                     SET nordtom = 1
                   WHERE sseguro = psseguro
                     AND nordtom IN (
                              SELECT MIN (nordtom)
                                FROM esttomadores
                               WHERE sseguro = psseguro
                                     AND sperson != vsperson);
               ELSE
                  --nom?s tenim prenador
                  SELECT COUNT (*)
                    INTO vcont
                    FROM estassegurats
                   WHERE sseguro = psseguro AND ffecfin IS NULL;

                  -- BUG11183:DRA:01/10/2009
                  IF vcont > 1
                  THEN
--t? m?s que l'assegurat/prenador actual
--**********
--ACC 13122008 nou codi
-- Es busca el seg?ent assegurat
                     SELECT sperson
                       INTO vsperasegnext
                       FROM estassegurats
                      WHERE sseguro = psseguro
                        AND ffecfin IS NULL
                        AND norden IN (
                                  SELECT MIN (norden)
                                    FROM estassegurats
                                   WHERE sseguro = psseguro
                                         AND ffecfin IS NULL);

                     -- Es recupera direcci? del contracte
                     SELECT cdomici
                       INTO vcdomici_pol
                       FROM esttomadores
                      WHERE sseguro = psseguro AND sperson = vsperson;

                     -- Es comprova si la direcci? del contracte ja existeix en el nou
                     num_err :=
                        pac_persona.f_valida_misma_direccion (vsperson,
                                                              vcdomici_pol,
                                                              vsperasegnext,
                                                              vcdomici_new
                                                             );

                     IF num_err <> 0
                     THEN
                        RETURN num_err;
                     END IF;

                     -- Existeix la direcci? per tant es crea
                     IF vcdomici_new IS NULL
                     THEN
                        BEGIN
                           SELECT MAX (cdomici) + 1
                             INTO vcdomici_new
                             FROM estdirecciones
                            WHERE sperson = vsperasegnext;
                        EXCEPTION
                           WHEN NO_DATA_FOUND
                           THEN
                              vcdomici_new := 1;
                           WHEN OTHERS
                           THEN
                              RETURN 104474;
                        -- Error al leer de la tabla DIRECCIONES
                        END;

                        INSERT INTO estper_direcciones
                                    (sperson, cagente, cdomici, ctipdir,
                                     csiglas, tnomvia, nnumvia, tcomple,
                                     tdomici, cpostal, cpoblac, cprovin,
                                     cusuari, fmovimi)
                           (SELECT vsperasegnext, cagente, vcdomici_new,
                                   ctipdir, csiglas, tnomvia, nnumvia,
                                   tcomple, tdomici, cpostal, cpoblac,
                                   cprovin, f_user, f_sysdate
                              FROM estper_direcciones
                             WHERE sperson = vsperson
                               AND cdomici = vcdomici_pol);
                     END IF;

                     UPDATE esttomadores
                        SET sperson = vsperasegnext,
                            cdomici = vcdomici_new
                      WHERE sseguro = psseguro AND sperson = vsperson;
                  END IF;                            -- fi n?mero d'assegurats
               END IF;                                --fi n?mero de prenadors
            END IF;                        --fi comprova assegurat es prenador
         END IF;
      -- ACC 13122008 fi modificaci? comprovar parproductos ANULRIESCTOM
      END IF;

      -- Insertamos la notificaci?n de baja del riesgo y de sus correspondientes garant?as.
      RETURN (0);
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pac_suplementos.f_anular_riesgo',
                      1,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 112044;
   END f_anular_riesgo;

   FUNCTION f_borrar_riesgo (
      psseguro   IN   NUMBER,
      pnriesgo   IN   NUMBER DEFAULT NULL,
      ptablas    IN   VARCHAR2 DEFAULT NULL
   )
      RETURN NUMBER
   IS
      --
      CURSOR c1 (psseguro IN NUMBER)
      IS
         SELECT nriesgo
           FROM estriesgos
          WHERE sseguro = psseguro
         MINUS
         SELECT nriesgo
           FROM riesgos
          WHERE sseguro = (SELECT ssegpol
                             FROM estseguros
                            WHERE sseguro = psseguro);

      TYPE rtablas IS RECORD (
         wtablas   VARCHAR2 (100)
      );

      TYPE ttablas IS TABLE OF rtablas
         INDEX BY BINARY_INTEGER;

      vtablas         ttablas;
      vindice         NUMBER;
      vcadena         VARCHAR2 (10000);
      vcadena_in      VARCHAR2 (10000);
      num_nriesgo     NUMBER;
      nriesgo_nuevo   NUMBER;
      nriesgo_ant     NUMBER;
   BEGIN
      -- Primero comprobamos que en el caso de pnriesgo a nulo
      -- borramos los riesgos que estan en est y no en car.
      IF pnriesgo IS NULL
      THEN
         SELECT COUNT (*)
           INTO num_nriesgo
           FROM (SELECT nriesgo
                   FROM estriesgos
                  WHERE sseguro = psseguro
                 MINUS
                 SELECT nriesgo
                   FROM riesgos
                  WHERE sseguro = (SELECT ssegpol
                                     FROM estseguros
                                    WHERE sseguro = psseguro));

         IF num_nriesgo = 0
         THEN
            RETURN 0;
         END IF;
      ELSE
         SELECT COUNT (*)
           INTO num_nriesgo
           FROM estriesgos
          WHERE sseguro = psseguro AND nriesgo = pnriesgo;

         IF num_nriesgo = 0
         THEN
            RETURN 104431;
         END IF;

         SELECT COUNT (*)
           INTO num_nriesgo
           FROM estriesgos
          WHERE sseguro = psseguro;
      END IF;

      --Asignamos las tablas a borrar
      vtablas (0).wtablas := 'pregunseg';
      vtablas (1).wtablas := 'pregungaranseg';
      vtablas (2).wtablas := 'garanseg';
      vtablas (3).wtablas := 'RESULSEG';
      vtablas (4).wtablas := 'claubenseg';
      vtablas (5).wtablas := 'CLAUPARESP';
      vtablas (6).wtablas := 'CLAUSUESP';
      vtablas (7).wtablas := 'riesgos';
      vtablas (8).wtablas := 'pregunsegtab';
      vtablas (9).wtablas := 'pregungaransegtab';
      -- la tabla riesgos tiene que ser la ultima.
      --Proceso que ejecuta los deletes correspondientes,.
      --dependiendo de los parametros.
      vcadena_in := NULL;

      FOR cur IN c1 (psseguro)
      LOOP
         vcadena_in := vcadena_in || cur.nriesgo || ',';
      END LOOP;

      vcadena_in := SUBSTR (vcadena_in, 1, LENGTH (vcadena_in) - 1) || ')';

      IF NVL (ptablas, 'EST') = 'EST'
      THEN
         vcadena := 'delete estassegurats ';
         vcadena :=
               vcadena || ' where sseguro=' || psseguro || ' and norden in (';

         IF pnriesgo IS NOT NULL
         THEN
            vcadena := vcadena || pnriesgo || ')';
         ELSE
            vcadena := vcadena || vcadena_in;
         END IF;

         EXECUTE IMMEDIATE vcadena;
      END IF;

      vindice := vtablas.FIRST;

      WHILE vindice IS NOT NULL
      LOOP
         vcadena :=
                'delete ' || NVL (ptablas, 'est')
                || vtablas (vindice).wtablas;
         vcadena :=
              vcadena || ' where sseguro=' || psseguro || ' and nriesgo in (';

         IF pnriesgo IS NOT NULL
         THEN
            vcadena := vcadena || pnriesgo || ')';
         ELSE
            vcadena := vcadena || vcadena_in;
         END IF;

         EXECUTE IMMEDIATE vcadena;

         vindice := vtablas.NEXT (vindice);
      END LOOP;

      --en caso que el parametro pnriesgo este informado
      --renumeramos los riesgos.
      IF pnriesgo IS NOT NULL
      THEN
         FOR i IN pnriesgo + 1 .. num_nriesgo
         LOOP
            nriesgo_nuevo := i - 1;
            nriesgo_ant := i;

            INSERT INTO estriesgos
                        (sseguro, nriesgo, nmovima, fefecto, sperson,
                         cclarie, nmovimb, fanulac, tnatrie, cdomici,
                         nasegur, starjet, nedacol, csexcol)
               (SELECT sseguro, nriesgo_nuevo, nmovima, fefecto, sperson,
                       cclarie, nmovimb, fanulac, tnatrie, cdomici, nasegur,
                       starjet, nedacol, csexcol
                  FROM estriesgos
                 WHERE sseguro = psseguro AND nriesgo = nriesgo_ant);

            IF NVL (ptablas, 'EST') = 'EST'
            THEN
               UPDATE estassegurats
                  SET norden = nriesgo_nuevo
                WHERE sseguro = psseguro AND norden = nriesgo_ant;
            END IF;

            vindice := vtablas.LAST - 1;

            FOR x IN 0 .. vindice
            LOOP
               vcadena :=
                      'update ' || NVL (ptablas, 'est')
                      || vtablas (x).wtablas;
               vcadena := vcadena || ' set nriesgo=' || nriesgo_nuevo;
               vcadena := vcadena || ' where sseguro =' || psseguro;
               vcadena := vcadena || ' and nriesgo = ' || nriesgo_ant;

               EXECUTE IMMEDIATE vcadena;
            END LOOP;

            DELETE FROM estriesgos
                  WHERE nriesgo = nriesgo_ant AND sseguro = psseguro;
         END LOOP;
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         --return 112044;
         RETURN SQLCODE;
   END f_borrar_riesgo;

   -- RSC 26/03/2008 Post suplemento del movimiento 550 (Rescate parcial)
   -- JRH Tarea 6966
   FUNCTION f_genera_lineas_saldo (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      num_err    NUMBER;
      vccalint   NUMBER;
   BEGIN
      num_err :=
         pac_ctaseguro.f_inscta_prov_cap (psseguro,
                                          TRUNC (f_sysdate),
                                          'R',
                                          NULL
                                         );

      IF num_err <> 0
      THEN
         RETURN num_err;
      END IF;

      IF pac_ctaseguro.f_tiene_ctashadow (psseguro, NULL) = 1
      THEN
         num_err :=
            pac_ctaseguro.f_inscta_prov_cap_shw (psseguro,
                                                 TRUNC (f_sysdate),
                                                 'R',
                                                 NULL
                                                );

         IF num_err <> 0
         THEN
            RETURN num_err;
         END IF;
      END IF;

      RETURN 0;
   END f_genera_lineas_saldo;

   FUNCTION f_anula_rec_pend (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      -- RSC 04/04/2008 (extraido de PAC_RESCATES.f_sol_rescate)  -------------
      nrec_pend   NUMBER                     := 0;
      rec_pend    pac_anulacion.recibos_pend;
      num_err     NUMBER;

      CURSOR rec_pendientes
      IS
         SELECT r.nrecibo, m.fmovini, r.fefecto
           FROM recibos r, movrecibo m
          WHERE r.sseguro = psseguro
            AND NVL (f_cestrec (r.nrecibo, NULL), 0) = 0
            AND m.nrecibo = r.nrecibo
            AND m.fmovfin IS NULL;

      vcapital    NUMBER;
   BEGIN
      -- RSC 04/04/2008 -------------------------------------------------------
      /************************************************************************
                                Incidencias:
        - Suplemento de Cambio de aportaci?n: cuando el suplemento de cambio de
          aportaci?n es a prima = 0 entonces debe anular los recibos pendientes.
      ************************************************************************/
      /* {busqueda de recibos pendientes} */
      FOR c IN rec_pendientes
      LOOP
         rec_pend (nrec_pend).nrecibo := c.nrecibo;
         rec_pend (nrec_pend).fmovini := c.fmovini;
         rec_pend (nrec_pend).fvencim := NULL;
         rec_pend (nrec_pend).fefecto := c.fefecto;
         nrec_pend := nrec_pend + 1;
      END LOOP;

      -- Obtenemos el importe de la prima, si es 0, entonces anularemos los recibos
      -- BUG10985:DRA:26/08/2009:Inici: jramiro pide la sustitucion de CGARANT=48 por f_pargaranpro_v
      SELECT g.icapital
        INTO vcapital
        FROM garanseg g, seguros s
       WHERE s.sseguro = psseguro
         AND g.sseguro = s.sseguro
         AND NVL (f_pargaranpro_v (s.cramo,
                                   s.cmodali,
                                   s.ctipseg,
                                   s.ccolect,
                                   s.cactivi,
                                   g.cgarant,
                                   UPPER ('TIPO')
                                  ),
                  0
                 ) = 3
         AND g.nmovimi =
                (SELECT MAX (g2.nmovimi)
                   FROM garanseg g2
                  WHERE g2.sseguro = psseguro
                    AND NVL (f_pargaranpro_v (s.cramo,
                                              s.cmodali,
                                              s.ctipseg,
                                              s.ccolect,
                                              s.cactivi,
                                              g2.cgarant,
                                              UPPER ('TIPO')
                                             ),
                             0
                            ) = 3);

      -- BUG10985:DRA:26/08/2009:Fi
      IF vcapital = 0 AND nrec_pend > 0
      THEN
         --> Anulaci?n de los recibos pendientes
         num_err := pac_anulacion.f_baja_rec_pend (f_sysdate, rec_pend);

         IF num_err <> 0
         THEN
            p_tab_error (f_sysdate,
                         getuser,
                         'pk_suplementos==> f_anula_rec_pend',
                         1,
                         'error al anular los recibos pendientes',
                         'SSEGURO =' || psseguro || 'error =' || num_err
                        );
            RETURN num_err;
         END IF;
      END IF;

      RETURN 0;
   END f_anula_rec_pend;

   /*************************************************************************
                                              BUG9217 - 03/04/2009 - DRA
      Retorna por par?metro si permite hacer el suplemento de un motivo determinado
      param in  pcuser      : C?digo del usuario
      param in  pcmotmov    : C?digo del motivo
      param in  psproduc    : id. producto
      return                : 0.- SI    <> 0 --> NO (literal error)
   *************************************************************************/
   FUNCTION f_permite_supl_prod (
      p_cuser     IN   pds_config_user.cuser%TYPE,
      p_cmotmov   IN   pds_supl_config.cmotmov%TYPE,
      p_sproduc   IN   productos.sproduc%TYPE
   )
      RETURN NUMBER
   IS
      v_permite   VARCHAR2 (1);
   BEGIN
      BEGIN
         SELECT 1
           INTO v_permite
           FROM pds_supl_config p, pds_supl_cod_config pd,
                pds_config_user pds
          WHERE pds.cuser = p_cuser
            AND pds.cconsupl = pd.cconsupl
            AND p.cconfig = pd.cconfig
            AND sproduc = p_sproduc
            AND p.cmodo = 'SUPLEMENTO'
            AND p.cmotmov = p_cmotmov;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 180286;      -- Suplemento no permitido para este producto
      END;

      RETURN 0;
   END f_permite_supl_prod;

   /*************************************************************************
                                                                                                              Retorna en una variable de salida de tipo T_LISTA_ID la lista de motivos
      de movimiento de suplemento generados en un suplemento.
      param in  pcuser    : C?digo del usuario.
      param in  psseguro  : C?digo de seguro.
      param in  pnmovimi  : C?digo de movimiento de suplemento.
      param in  psproduc  : C?digo de producto.
      param in  ptform    : C?digo de form (BBDD)
      param in  pcmodo    : Modalidad
      param out pcmotmovs : Lista de motivos de movimiento
      param in  pcidioma  : Idioma
      return              : 0.- OK    <> 0 --> Error
   *************************************************************************/
   -- Bug 9905 - 24/04/2009 - RSC - Suplemento de cambio de forma de pago diferido
   FUNCTION f_get_cmotmov_cambios (
      pcuser      IN       VARCHAR2,
      psseguro    IN       NUMBER,
      pnmovimi    IN       NUMBER,
      psproduc    IN       NUMBER,
      ptform               VARCHAR2,
      pcmodo      IN       VARCHAR2,
      pcmotmovs   OUT      t_lista_id,
      pcidioma    IN       NUMBER DEFAULT 2
   )
      RETURN NUMBER
   IS
      CURSOR cambios (pcconfsupl IN VARCHAR2)
      IS
         SELECT   c.cmotmov, c.cconfig
             FROM pds_supl_cod_config cc, pds_supl_config c
            WHERE c.sproduc = psproduc
              AND cc.cconsupl = pcconfsupl
              AND cc.cconfig = c.cconfig
         ORDER BY c.cmotmov;

      CURSOR selects (pcconfig IN VARCHAR2)
      IS
         SELECT   tselect
             FROM pds_supl_validacio
            WHERE cconfig = pcconfig
         ORDER BY nselect;

      pssegpol      NUMBER;
      mi_select     VARCHAR2 (1000);
      mi_cambio     NUMBER;
      mis_cambios   NUMBER;
      num_err       NUMBER;
      aux           NUMBER;

      TYPE t_cursor IS REF CURSOR;

      curs          t_cursor;
      c_cconfsupl   VARCHAR2 (50);
      v_select      VARCHAR2 (6000);
      testt         NUMBER;
      v_cmotmovs    t_lista_id      := t_lista_id ();
   BEGIN
      /*
                  {Primero se mira que configuraci?n tiene el usuario asignada}
      */
      BEGIN
         SELECT cconsupl
           INTO c_cconfsupl
           FROM pds_config_user
          WHERE cuser = UPPER (pcuser);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 151746;
      --{No se ha encontrado la configuraci?n de navegaci?n para este usuario}
      END;

--      p_tab_error (f_sysdate,
--                   f_user,
--                   'pk_suplementos.f_get_cmotmov_cambios',
--                   1,
--                   'traza',
--                   'c_cconfsupl-->' || c_cconfsupl
--                  );
      IF c_cconfsupl IS NULL
      THEN
         RETURN 151746;
      --{No se ha encontrado la configuraci?n de navegaci?n para este usuario}
      END IF;

      -- obtengo el sseguro de las tablas reales.
      SELECT ssegpol
        INTO pssegpol
        FROM estseguros
       WHERE sseguro = psseguro;

--      p_tab_error (f_sysdate,
--                   f_user,
--                   'pk_suplementos.f_get_cmotmov_cambios',
--                   2,
--                   'traza',
--                   ' psseguro-->' || psseguro || ' pssegpol-->' || pssegpol
--                  );
      FOR c IN cambios (c_cconfsupl)
      LOOP
         mi_cambio := 0;
         mis_cambios := 0;

--         p_tab_error (f_sysdate,
--                      f_user,
--                      'pk_suplementos.f_get_cmotmov_cambios',
--                      2,
--                      'traza x',
--                         ' psseguro-->'
--                      || psseguro
--                      || ' mi_cambio-->'
--                      || mi_cambio
--                      || ' mis_cambios-->'
--                      || mis_cambios
--                      || 'pnmovimi-->'
--                      || pnmovimi
--                      || ' pssegpol-->'
--                      || pssegpol
--                     );
         FOR x IN selects (c.cconfig)
         LOOP
            v_select := REPLACE (LOWER (x.tselect), ':psseguro', psseguro);
            v_select := REPLACE (LOWER (v_select), ':pssegpol', pssegpol);
            v_select := REPLACE (LOWER (v_select), ':pnmovimi', pnmovimi);

--            p_tab_error (f_sysdate,
--                         f_user,
--                         'pk_suplementos.f_get_cmotmov_cambios',
--                         2,
--                         'traza y',
--                         SUBSTR (' v_select-->' || v_select, 1, 2000)
--                        );
            EXECUTE IMMEDIATE v_select
                        USING OUT mi_cambio;

--            p_tab_error (f_sysdate,
--                         f_user,
--                         'pk_suplementos.f_get_cmotmov_cambios',
--                         2,
--                         'traza y',
--                         ' mi_cambio-->' || mi_cambio
--                        );
            IF mi_cambio <> 0
            THEN
               mis_cambios := mis_cambios + 1;
            END IF;
--            p_tab_error (f_sysdate,
--                         f_user,
--                         'pk_suplementos.f_get_cmotmov_cambios',
--                         2,
--                         'traza y',
--                         ' mi_cambios-->' || mis_cambios
--                        );
         END LOOP;

         IF mis_cambios <> 0
         THEN
            v_cmotmovs.EXTEND;
            v_cmotmovs (v_cmotmovs.LAST) := ob_lista_id ();
            v_cmotmovs (v_cmotmovs.LAST).idd := c.cmotmov;
         END IF;
      END LOOP;

      pcmotmovs := v_cmotmovs;
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         --{ p_tahiti_Error(null, 'errrr',sqlerrm);}
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_validar_cambios',
                      4,
                      'error no controlat',
                      SQLERRM
                     );
         RETURN 140999;                               -- { Error no controlat}
   END f_get_cmotmov_cambios;

   -- Fin Bug 9905

   /*************************************************************************
                  Funci?n destinada a su utilizaci?n como POST SUPLEMENTO en aquellos
      contextos en que se utilice la tabla SEG_CBANCAR y se quiera dejar
      el campo CBANCOB a NULL cuando se haya realizado un suplemento
      de modificaci?n de cuenta.
      param in  psseguro  : C?digo de seguro.
      return              : 0.- OK    <> 0 --> Error
   *************************************************************************/
   -- Bug 10656 - 07/07/2009 - RSC - APR - Error en suplemento de cambio de cuenta
   FUNCTION f_update_cbancob_cbancar (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      v_cbancar   seguros.cbancar%TYPE;
      v_finiefe   seg_cbancar.finiefe%TYPE;
      v_ccobban   NUMBER;
      -- Bug - 07/07/2009 - RSC -
      v_nmovimi   movseguro.nmovimi%TYPE;
   BEGIN
      SELECT cbancar
        INTO v_cbancar
        FROM seguros
       WHERE sseguro = psseguro;

      IF v_cbancar IS NOT NULL
      THEN
         UPDATE seg_cbancar
            SET cbancar = v_cbancar,
                cbancob = NULL
          WHERE sseguro = psseguro
            AND nmovimi = (SELECT MAX (nmovimi)
                             FROM seg_cbancar
                            WHERE sseguro = psseguro)
            AND ffinefe IS NULL;

         IF SQL%ROWCOUNT = 0
         THEN
            -- Si contratan primero en manual y
            -- despues pasan a domiciliado
            SELECT MAX (nmovimi)
              INTO v_nmovimi
              FROM garanseg
             WHERE sseguro = psseguro;

            SELECT DISTINCT finiefe
                       INTO v_finiefe
                       FROM garanseg
                      WHERE sseguro = psseguro AND nmovimi = v_nmovimi;

            INSERT INTO seg_cbancar
                        (sseguro, nmovimi, finiefe, ffinefe, cbancar, cbancob
                        )
                 VALUES (psseguro, v_nmovimi, v_finiefe, NULL, v_cbancar, NULL
                        );
         END IF;
      ELSE
         -- Bug 10656 - 07/07/2009 - RSC - Error en suplemento de cambio de cuenta
         -- Provocado por un cambio de domiciliaci?n a manual (por ejemplo)
         -- BUG13254:DRA:26/02/2010:Inici
         -- Si no encuentra registro es que se ha cambiado desde una forma de pago sin cuenta
         BEGIN
            SELECT DISTINCT finiefe
                       INTO v_finiefe
                       FROM seg_cbancar
                      WHERE sseguro = psseguro
                        AND nmovimi = (SELECT MAX (nmovimi)
                                         FROM seg_cbancar
                                        WHERE sseguro = psseguro);

            UPDATE seg_cbancar
               SET ffinefe = v_finiefe
             WHERE sseguro = psseguro AND nmovimi =
                                                   (SELECT MAX (nmovimi)
                                                      FROM seg_cbancar
                                                     WHERE sseguro = psseguro);
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;
      -- BUG13254:DRA:26/02/2010:Fi
      END IF;

      -- Fin Bug 10656
      RETURN 0;
   END f_update_cbancob_cbancar;

   -- Fin Bug 10656

   /***********************************************************************
                 FUNCTION F_VALIDA_FEFECTO:
      Funci? que valida la data efecte
      param in psproduc : Codi producte
      param in pfefecto  : Data efecte
      param in pfvencim : Data venciment
      param in pcmotmov : Codi motiu
      return            : 0 -> Tot correcte
                          1 -> S'ha produit un error
      13/10/2009   XVM    --BUG11376
   ***********************************************************************/
   FUNCTION f_valida_fefecto (
      psproduc   IN   seguros.sproduc%TYPE,
      pfefecto   IN   seguros.fefecto%TYPE,
      pfvencim   IN   seguros.fvencim%TYPE,
      pcduraci   IN   seguros.cduraci%TYPE,
      pcmotmov   IN   NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS
      vnumerr      NUMBER;
      vpasexec     NUMBER         := 1;
      vparam       VARCHAR2 (200)
         :=    'psproduc: '
            || psproduc
            || ' pfefecto: '
            || pfefecto
            || ' pfvencim: '
            || pfvencim
            || ' pcduraci: '
            || pcduraci
            || ' pcmotmov: '
            || pcmotmov;
      vobject      VARCHAR2 (200) := 'PK_SUPLEMENTOS.F_VALIDA_FEFECTO';
      vcontmot     NUMBER (1);
      vparametro   NUMBER;
   BEGIN
      --Comprovaci? de par?metres
      IF pfefecto IS NULL OR psproduc IS NULL
      THEN
         RAISE e_param_error;
      END IF;

      vpasexec := 2;
      vnumerr := 0;

      -- Comprobamos que la f.vencim. sea posterior a la f.efecto, y si la f.vencim. no est? informada, miramos el cduraci
      IF pfvencim IS NOT NULL
      THEN
         vpasexec := 3;

         IF pcmotmov = 601
         THEN
            -- BUG 0039504 - FAL - 14/01/2016 - Se permite la regularizaci??e personas a efecto = fvencim al ser retroactivo
            IF TRUNC (pfvencim) < TRUNC (pfefecto)
            THEN
               vnumerr := 9908711;
            END IF;
         ELSE
            IF TRUNC (pfvencim) <= TRUNC (pfefecto)
            THEN
               vnumerr := 100022;
            END IF;
         END IF;
      ELSE
         vpasexec := 4;

         -- Bug 23117 - RSC - 30/07/2012 - LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN AnO (anadimos 6)
         IF pcduraci NOT IN (0, 4, 6)
         THEN
            vnumerr := 151288;
         END IF;
      END IF;

      --Comprobamos si la fecha de efecto debe ser el d?a 1 de mes.
      IF NVL (f_parproductos_v (psproduc, 'SUP_DIA_INICIO_01'), 0) = 1
      THEN
         vparametro :=
                      f_parmotmov (pcmotmov, 'SALTA_DIA_INICIO_01', psproduc);

         IF vparametro IS NULL OR vparametro = 0
         THEN
            IF TO_CHAR (pfefecto, 'DD') <> '01'
            THEN
               vnumerr := 1000459;
            END IF;
         END IF;
      END IF;

      -- Bug 19808 - RSC - 10/11/2011 - Comprobamos si la fecha de fecto supera el m?ximo
      IF f_parproductos_v (psproduc, 'DIASDESPU_SUPLEM') IS NOT NULL
      THEN
         IF pfefecto >
                 TRUNC (f_sysdate)
               + NVL (f_parproductos_v (psproduc, 'DIASDESPU_SUPLEM'), 0)
         THEN
            RETURN 101490;                          -- Fecha fuera de l?mites
         END IF;
      END IF;

      -- Fin Bug 19808
      RETURN vnumerr;
   EXCEPTION
      WHEN e_param_error
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobject,
                      vpasexec,
                      vparam,
                      'Par?metros incorrectos'
                     );
         RETURN 1000005;
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobject,
                      vpasexec,
                      vparam,
                      SQLCODE || ' - ' || SQLERRM
                     );
         RETURN 1000455;
   END f_valida_fefecto;

   /*************************************************************************
                           Funci?n que sirve para realizar un cambio de agente y para crear nuevos detalles de personas
   de aguellas personas que no tenga detalle seg?n el agente de visi?n de la poliza.
   Donde este proceso es: vcagente_ant  === Agente inicio
                          reg.cpervisio ==  Agente Final
        param in psseguro : codigo del seguro
        retorno : 0 ok
                  1 error
     Bug 11468 - 22/10/2009 - AMC
   *************************************************************************/
   FUNCTION f_cambio_agente (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      /* Proceso que sirve para realizar un cambio de agente y para crear nuevos detalles de personas
                  de aguellas personas que no tenga detalle seg?n el agente de visi?n de la pnoliza.
      Donde este proceso es:
         vcagente_ant  === Agente inicio
         reg.cpervisio ==  Agente Final*/
      vcont          NUMBER;
      vcempres       empresas.cempres%TYPE      := 2;           -- APRA LEVEN
      vcidioma       per_detper.cidioma%TYPE;
      vtapelli1      per_detper.tapelli1%TYPE;
      vtapelli2      per_detper.tapelli2%TYPE;
      vtnombre       per_detper.tnombre%TYPE;
      vtnombre1      per_detper.tnombre1%TYPE;
      vtnombre2      per_detper.tnombre2%TYPE;
      vtsiglas       per_detper.tsiglas%TYPE;
      vcprofes       per_detper.cprofes%TYPE;
      vtbuscar       per_detper.tbuscar%TYPE;
      vcestciv       per_detper.cestciv%TYPE;
      vcpais         per_detper.cpais%TYPE;
      vtraza         NUMBER                     := 0;
      vcagente_ant   agentes.cagente%TYPE;
      v_cod          NUMBER;

      -- Seleccionamos las personas que no tienen detalle de persona para el nivel de visi?n del agente de la p?liza.
      CURSOR cur_detpersonas
      IS
         SELECT   ff_agente_cpervisio (s.cagente,
                                       f_sysdate,
                                       s.cempres
                                      ) cpervisio,
                  p.sperson, per.nnumide
             FROM seguros s, v_personas_seguros p, per_personas per
            WHERE p.sseguro = s.sseguro
              AND s.sseguro = psseguro
              AND per.sperson = p.sperson
              AND NOT EXISTS (
                     SELECT 1
                       FROM per_detper x
                      WHERE x.sperson = p.sperson
                        AND x.cagente =
                               ff_agente_cpervisio (s.cagente,
                                                    f_sysdate,
                                                    s.cempres
                                                   ))
              AND p.sperson IS NOT NULL
         ORDER BY p.sperson;
   BEGIN
      vtraza := 1;

      -- Este ser? el agente del que cogemos todos los datos. ( Agente antes del cambio de agente)
      SELECT cagente
        INTO vcagente_ant
        FROM historicoseguros
       WHERE sseguro = psseguro AND nmovimi = (SELECT MAX (nmovimi)
                                                 FROM historicoseguros
                                                WHERE sseguro = psseguro);

      vtraza := 2;

      FOR reg IN cur_detpersonas
      LOOP
         vtraza := 3;
-------------------------- per_detper
-- Insertamos el nuevo de detalle, en el caso de existir un detalle ya para el agente fin lo que hacemos es fusionar, es decir
-- por defecto cogemos los campos del agente inicio, pero si no estan informados y en el agnete fin si dejamos esta informaci?n.
----------------------------------------------------------------------------------------------------------------------------
         vtraza := 4;

         -- Si existe ya detalle para el nuevo agente
         BEGIN
            INSERT INTO per_detper
                        (sperson, cagente, cidioma, tapelli1, tapelli2,
                         tnombre, tsiglas, cprofes, tbuscar, cestciv, cpais,
                         cusuari, fmovimi, tnombre1, tnombre2)
               SELECT sperson, reg.cpervisio, cidioma, tapelli1, tapelli2,
                      tnombre, tsiglas, cprofes, tbuscar, cestciv, cpais,
                      f_user, f_sysdate, tnombre1, tnombre2
                 FROM per_detper
                WHERE sperson = reg.sperson AND cagente = vcagente_ant;

--INI 1554 CESS
            pac_convivencia.p_send_data (reg.sperson, 1,
                                         UPPER ('per_detper'));
--END 1554 CESS
         EXCEPTION
            WHEN DUP_VAL_ON_INDEX
            THEN
               SELECT cidioma, tapelli1, tapelli2, tnombre, tsiglas,
                      cprofes, tbuscar, cestciv, cpais, tnombre1,
                      tnombre2
                 INTO vcidioma, vtapelli1, vtapelli2, vtnombre, vtsiglas,
                      vcprofes, vtbuscar, vcestciv, vcpais, vtnombre1,
                      vtnombre2
                 FROM per_detper
                WHERE sperson = reg.sperson AND cagente = vcagente_ant;

               UPDATE per_detper
                  SET cidioma = NVL (cidioma, vcidioma),
                      tapelli1 = NVL (tapelli1, vtapelli1),
                      tapelli2 = NVL (tapelli2, vtapelli2),
                      tnombre = NVL (tnombre, vtnombre),
                      tnombre1 = NVL (tnombre1, vtnombre1),
                      tnombre2 = NVL (tnombre2, vtnombre2),
                      tsiglas = NVL (tsiglas, vtsiglas),
                      cprofes = NVL (cprofes, vcprofes),
                      tbuscar = NVL (tbuscar, vtbuscar),
                      cestciv = NVL (cestciv, vcestciv),
                      cpais = NVL (cpais, vcpais)
                WHERE sperson = reg.sperson AND cagente = reg.cpervisio;

--INI 1554 CESS
               pac_convivencia.p_send_data (reg.sperson,
                                            1,
                                            UPPER ('per_detper')
                                           );
--END 1554 CESS
         END;

         vtraza := 5;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Cuentas bancarias
-- Traspasamos solo las cuentas que no existan ya para el nuevo agente
----------------------------------------------------------------------------------------------------------------------------
         SELECT NVL (MAX (cnordban), 0)
           INTO v_cod
           FROM per_ccc
          WHERE sperson = reg.sperson;

         vtraza := 6;

         FOR reggar IN (SELECT sperson, cagente, ctipban, cbancar, fbaja,
                               cdefecto, cusumov, fusumov, cnordban
                          FROM per_ccc c
                         WHERE sperson = reg.sperson
                           AND cagente = vcagente_ant
                           AND NOT EXISTS (
                                  SELECT 1
                                    FROM per_ccc cc
                                   WHERE cc.sperson = reg.sperson
                                     AND cc.cagente = reg.cpervisio
                                     AND cc.ctipban = c.ctipban
                                     AND c.cbancar = cc.cbancar))
         LOOP
            vtraza := 7;
            v_cod := v_cod + 1;

            INSERT INTO per_ccc
                        (sperson, cagente, ctipban,
                         cbancar, fbaja, cdefecto,
                         cnordban, cusumov, fusumov
                        )
                 VALUES (reg.sperson, reg.cpervisio, reggar.ctipban,
                         reggar.cbancar, reggar.fbaja, reggar.cdefecto,
                         v_cod, f_user, f_sysdate
                        );

            vtraza := 8;
            --INI 1554 CESS
            pac_convivencia.p_send_data (reg.sperson, 1, UPPER ('per_ccc'));
--END 1554 CESS
         END LOOP;

         -- la cuenta por defecto le pongo la del agente inicio
         BEGIN
            -- Primero pongo a todos las cuentas a que no sean por defecto
            UPDATE per_ccc
               SET cdefecto = 0
             WHERE sperson = reg.sperson AND cagente = reg.cpervisio;

            UPDATE per_ccc
               SET cdefecto = 1
             WHERE sperson = reg.sperson
               AND cagente = reg.cpervisio
               AND (ctipban, cbancar) IN (
                      SELECT ctipban, cbancar
                        FROM per_ccc
                       WHERE sperson = reg.sperson
                         AND cagente = vcagente_ant
                         AND cdefecto = 1);

            --INI 1554 CESS
            pac_convivencia.p_send_data (reg.sperson, 1, UPPER ('per_ccc'));
--END 1554 CESS
         EXCEPTION
            WHEN OTHERS
            THEN
               p_tab_error (f_sysdate,
                            f_user,
                            'pk_suplementos.f_cambio_agente',
                            vtraza,
                            'Error al modificar las cuentas',
                               'Error '
                            || SQLERRM
                            || 'persona = '
                            || reg.sperson
                            || ' Agente Inicio = '
                            || vcagente_ant
                            || ' Agente Final = '
                            || reg.cpervisio
                           );                                                --
         END;

         vtraza := 8;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Contactos
-- Solo insertamos  los contactos que no existan en el nuevo agente.
----------------------------------------------------------------------------------------------------------------------------
         SELECT NVL (MAX (cmodcon), 0)
           INTO v_cod
           FROM per_contactos
          WHERE sperson = reg.sperson;

         vtraza := 9;

         -- Solo seleccionamos los contactos que no existan en el nuevo agente.
         FOR reggar IN (SELECT sperson, cagente, cmodcon, ctipcon, tcomcon,
                               tvalcon, cobliga
                          FROM per_contactos c
                         WHERE sperson = reg.sperson
                           AND cagente = vcagente_ant
                           AND NOT EXISTS (
                                  SELECT 1
                                    FROM per_contactos cc
                                   WHERE cc.sperson = reg.sperson
                                     AND cagente = reg.cpervisio
                                     AND cc.tvalcon = c.tvalcon))
         LOOP
            vtraza := 9;
            v_cod := v_cod + 1;

            INSERT INTO per_contactos
                        (sperson, cagente, cmodcon, ctipcon,
                         tcomcon, tvalcon, cobliga,
                         cusuari, fmovimi
                        )
                 VALUES (reg.sperson, reg.cpervisio, v_cod, reggar.ctipcon,
                         reggar.tcomcon, reggar.tvalcon, reggar.cobliga,
                         f_user, f_sysdate
                        );

            vtraza := 10;
--INI 1554 CESS
            pac_convivencia.p_send_data (reg.sperson,
                                         1,
                                         UPPER ('per_contactos')
                                        );
--END 1554 CESS
         END LOOP;

         vtraza := 11;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Direcciones
-- Insertamos todas las direcciones
----------------------------------------------------------------------------------------------------------------------------
         SELECT NVL (MAX (cdomici), 0)
           INTO v_cod
           FROM per_direcciones
          WHERE sperson = reg.sperson;

         vtraza := 12;

         FOR reggar IN (SELECT sperson, cagente, cdomici, ctipdir, csiglas,
                               tnomvia, nnumvia, tcomple, tdomici, cpostal,
                               cpoblac, cprovin
                          FROM per_direcciones
                         WHERE sperson = reg.sperson
                               AND cagente = vcagente_ant)
         LOOP
            v_cod := v_cod + 1;
            vtraza := 13;

            INSERT INTO per_direcciones
                        (sperson, cagente, cdomici, ctipdir,
                         csiglas, tnomvia, nnumvia,
                         tcomple, tdomici, cpostal,
                         cpoblac, cprovin, cusuari, fmovimi
                        )
                 VALUES (reg.sperson, reg.cpervisio, v_cod, reggar.ctipdir,
                         reggar.csiglas, reggar.tnomvia, reggar.nnumvia,
                         reggar.tcomple, reggar.tdomici, reggar.cpostal,
                         reggar.cpoblac, reggar.cprovin, f_user, f_sysdate
                        );

--INI 1554 CESS
            pac_convivencia.p_send_data (reg.sperson,
                                         1,
                                         UPPER ('per_direcciones')
                                        );
--END 1554 CESS
            vtraza := 14;

            FOR reggar1 IN (SELECT sseguro
                              FROM tomadores
                             WHERE sperson = reg.sperson
                               AND cdomici = reggar.cdomici)
            LOOP
               UPDATE tomadores
                  SET cdomici = v_cod
                WHERE sseguro = reggar1.sseguro AND sperson = reg.sperson;
            END LOOP;

            vtraza := 15;

            FOR reggar1 IN (SELECT sseguro, sperson, norden
                              FROM asegurados
                             WHERE sperson = reg.sperson
                               AND cdomici = reggar.cdomici)
            LOOP
               UPDATE asegurados
                  SET cdomici = v_cod
                WHERE sseguro = reggar1.sseguro
                  AND sperson = reggar1.sperson
                  AND norden = reggar1.norden;
            END LOOP;

            vtraza := 16;

            FOR reggar1 IN (SELECT sseguro, nriesgo, sperson
                              FROM riesgos
                             WHERE sperson = reg.sperson
                               AND cdomici = reggar.cdomici)
            LOOP
               UPDATE riesgos
                  SET cdomici = v_cod
                WHERE sseguro = reggar1.sseguro
                  AND sperson = reggar1.sperson
                  AND nriesgo = reggar1.nriesgo;
            END LOOP;

            vtraza := 16;
         END LOOP;

         vtraza := 17;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Identificadores
-- Traspasamos solo los identificadores que no existan ya para el nuevo agente.
----------------------------------------------------------------------------------------------------------------------------
         FOR reggar IN (SELECT sperson, reg.cpervisio, ctipide, nnumide,
                               swidepri, femisio, fcaduca
                          FROM per_identificador
                         WHERE sperson = reg.sperson
                               AND cagente = vcagente_ant)
         LOOP
            BEGIN
               -- Si es el identificador principal ponemso un 1 en el campo swidepri
               INSERT INTO per_identificador
                           (sperson, cagente,
                            ctipide, nnumide,
                            swidepri,
                            femisio, fcaduca
                           )
                    VALUES (reggar.sperson, reggar.cpervisio,
                            reggar.ctipide, reggar.nnumide,
                            DECODE (reggar.nnumide, reg.nnumide, 1, 0),
                            reggar.femisio, reggar.fcaduca
                           );
            EXCEPTION
               WHEN DUP_VAL_ON_INDEX
               THEN
                  NULL;
            END;
         END LOOP;

         vtraza := 18;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Irpf
-- Si existe informaci?n para el nuevo agnete de irpf no traspasamos
-- Si No existe informadi?n de IRPF para el nuevo agente la traspasamos
----------------------------------------------------------------------------------------------------------------------------

         -- si ya existe datos para el nuevo agente no volcamos la informaci?n.
         SELECT COUNT (1)
           INTO vcont
           FROM per_irpf
          WHERE sperson = reg.sperson AND cagente = reg.cpervisio;

         IF vcont = 0
         THEN
            FOR reggar IN (SELECT sperson, csitfam, cnifcon, cgrado, cayuda,
                                  ipension, ianuhijos, prolon, rmovgeo, nano
                             FROM per_irpf
                            WHERE sperson = reg.sperson
                              AND cagente = vcagente_ant)
            LOOP
               BEGIN
                  INSERT INTO per_irpf
                              (sperson, csitfam,
                               cnifcon, cgrado, cayuda,
                               ipension, ianuhijos,
                               prolon, rmovgeo, nano,
                               cagente
                              )
                       VALUES (reggar.sperson, reggar.csitfam,
                               reggar.cnifcon, reggar.cgrado, reggar.cayuda,
                               reggar.ipension, reggar.ianuhijos,
                               reggar.prolon, reggar.rmovgeo, reggar.nano,
                               reg.cpervisio
                              );
               EXCEPTION
                  WHEN DUP_VAL_ON_INDEX
                  THEN
                     NULL;
               END;
            END LOOP;
         END IF;

         vtraza := 19;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Irpf descendicnetes
-- Si existe informaci?n para el nuevo agnete de irpf no traspasamos
-- Si No existe informadi?n de IRPF para el nuevo agente la traspasamos
----------------------------------------------------------------------------------------------------------------------------

         -- si ya existe datos para el nuevo agente no volcamos la informaci?n.
         SELECT COUNT (1)
           INTO vcont
           FROM per_irpfdescen
          WHERE sperson = reg.sperson AND cagente = reg.cpervisio;

         IF vcont = 0
         THEN
            FOR reggar IN (SELECT sperson, fnacimi, cgrado, center, cusuari,
                                  fmovimi, norden, nano, cagente
                             FROM per_irpfdescen
                            WHERE sperson = reg.sperson
                              AND cagente = vcagente_ant)
            LOOP
               BEGIN
                  INSERT INTO per_irpfdescen
                              (sperson, fnacimi, cgrado,
                               center, norden, nano,
                               cagente
                              )
                       VALUES (reg.sperson, reggar.fnacimi, reggar.cgrado,
                               reggar.center, reggar.norden, reggar.nano,
                               reg.cpervisio
                              );
               EXCEPTION
                  WHEN DUP_VAL_ON_INDEX
                  THEN
                     NULL;
               END;
            END LOOP;
         END IF;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Irpf Mayores
-- Si existe informaci?n para el nuevo agnete de irpf no traspasamos
-- Si No existe informadi?n de IRPF para el nuevo agente la traspasamos
----------------------------------------------------------------------------------------------------------------------------

         -- si ya existe datos para el nuevo agente no volcamos la informaci?n.
         SELECT COUNT (1)
           INTO vcont
           FROM per_irpfmayores
          WHERE sperson = reg.sperson AND cagente = reg.cpervisio;

         IF vcont = 0
         THEN
            FOR reggar IN (SELECT sperson, fnacimi, cgrado, crenta, nviven,
                                  cusuari, fmovimi, norden, nano, cagente
                             FROM per_irpfmayores
                            WHERE sperson = reg.sperson
                              AND cagente = vcagente_ant)
            LOOP
               BEGIN
                  INSERT INTO per_irpfmayores
                              (sperson, fnacimi,
                               cgrado, crenta, nviven,
                               norden, nano, cagente
                              )
                       VALUES (reggar.sperson, reggar.fnacimi,
                               reggar.cgrado, reggar.crenta, reggar.nviven,
                               reggar.norden, reggar.nano, reg.cpervisio
                              );
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     NULL;
               END;
            END LOOP;
         END IF;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Nacionalidades
-- Traspasamos solo las nacionalidades que no tiene el nuevo agente.(petar?a por pk)
----------------------------------------------------------------------------------------------------------------------------
         FOR reggar IN (SELECT sperson, cpais, cdefecto
                          FROM per_nacionalidades
                         WHERE sperson = reg.sperson
                               AND cagente = vcagente_ant)
         LOOP
            BEGIN
               INSERT INTO per_nacionalidades
                           (sperson, cagente, cpais,
                            cdefecto
                           )
                    VALUES (reg.sperson, reg.cpervisio, reggar.cpais,
                            reggar.cdefecto
                           );
            EXCEPTION
               WHEN OTHERS
               THEN
                  NULL;
            END;
         END LOOP;

----------------------------------------------------------------------------------------------------------------------------
-------------------------- Parametros personas
-- Traspasamos los parametros que no tiene y si existe en el nuevo agente este parametro lo dejamos
----------------------------------------------------------------------------------------------------------------------------
         FOR reggar IN (SELECT cparam, sperson, nvalpar, tvalpar, fvalpar
                          FROM per_parpersonas
                         WHERE sperson = reg.sperson
                               AND cagente = vcagente_ant)
         LOOP
            BEGIN
               INSERT INTO per_parpersonas
                           (cparam, cagente, sperson,
                            nvalpar, tvalpar, fvalpar
                           )
                    VALUES (reggar.cparam, reg.cpervisio, reg.sperson,
                            reggar.nvalpar, reggar.tvalpar, reggar.fvalpar
                           );

               --INI 1554 CESS
               pac_convivencia.p_send_data (reg.sperson,
                                            1,
                                            UPPER ('per_parpersonas')
                                           );
--END 1554 CESS
            EXCEPTION
               WHEN DUP_VAL_ON_INDEX
               THEN
                  UPDATE per_parpersonas
                     SET nvalpar = reggar.nvalpar,
                         tvalpar = reggar.tvalpar,
                         fvalpar = reggar.fvalpar
                   WHERE sperson = reg.sperson
                     AND cagente = reg.cpervisio
                     AND cparam = reggar.cparam;

                  --INI 1554 CESS
                  pac_convivencia.p_send_data (reg.sperson,
                                               1,
                                               UPPER ('per_parpersonas')
                                              );
--END 1554 CESS
               WHEN OTHERS
               THEN
                  NULL;
            END;
         END LOOP;
      -- Bug 0013392 - 12/04/2010 - JMF: RETURN 0;
      END LOOP;

      RETURN 0;
   -- MCA BUG 12087   Si no ha de crear registros devolvemos todo OK
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'pk_suplementos.f_cambio_agente',
                      vtraza,
                      'Error general',
                      SQLERRM
                     );
         -- Bug 0013392 - 12/04/2010 - JMF: ROLLBACK;
         RETURN 1;
   END f_cambio_agente;

   /*************************************************************************
                                        Funcion para saber si un suplemento es incompatible
    param in psseguro : codigo del seguro
    param in pcmotmov : codigo del motivo del suplemento
    param out pcestado : estado del suplemento
    retorno : 0 ok
              1 error
   -- Bug 116595 - 10/11/2009 - AMC
   *************************************************************************/
   FUNCTION f_supl_incompatible (
      psseguro   IN       NUMBER,
      pcmotmov   IN       NUMBER,
      pcestado   OUT      VARCHAR2
   )
      RETURN NUMBER
   IS
   BEGIN
      SELECT cestado
        INTO pcestado
        FROM pds_estsegurosupl p, estseguros s
       WHERE s.ssegpol = psseguro
         AND p.sseguro = s.sseguro
         AND p.cmotmov = pcmotmov
         AND p.nmovimi IN (SELECT DISTINCT (nmovimi)
                                      FROM estgaranseg
                                     WHERE sseguro = s.sseguro);

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_supl_incompatible',
                      1,
                         'error no controlado psseguro:'
                      || psseguro
                      || ' pcmotmov:'
                      || pcmotmov,
                      SQLERRM
                     );
         RETURN 1;
   END f_supl_incompatible;

   /*************************************************************************
                Funcion para buscar la fecha del suplemento de la configuraci?n indicada en las PDS
    param in psproduc : codigo del producto
    param in psseguro : codigo del seguro
    param in pcmotmov : codigo del motivo del suplemento
    param out pfefecto : fecha de efecto
    retorno : 0 ok
              1 error
   -- Bug 116595 - 10/11/2009 - AMC
   *************************************************************************/
   FUNCTION f_get_fsupl_pds (
      psproduc   IN       NUMBER,
      psseguro   IN       NUMBER,
      pcmotmov   IN       NUMBER,
      pfefecto   OUT      DATE,
      pfsuplem   IN       DATE DEFAULT NULL
   )                                                -- BUG14709:DRA:30/06/2010
      RETURN NUMBER
   IS
      vcfefecto      VARCHAR2 (200);
      vpasexec       NUMBER;
      vnumerr        NUMBER;
      vexiste        NUMBER;
      v_fefectopol   DATE;
      vidversion     NUMBER;
   BEGIN
      -- BUG14709:DRA:30/06/2010:Inici
      -- Si me pasan fecha de suplemento es que se tiene que comprobar si es un diferido
      vexiste := 0;

      IF pfsuplem IS NOT NULL
      THEN
         SELECT COUNT (1)
           INTO vexiste
           FROM sup_diferidosseg
          WHERE cmotmov = pcmotmov
            AND sseguro = psseguro
            AND estado = 0
            AND fecsupl = pfsuplem;
      END IF;

      IF vexiste = 0
      THEN
         SELECT tfecrec
           INTO vcfefecto
           FROM pds_supl_config
          WHERE sproduc = psproduc
            AND cmotmov = pcmotmov
            AND cmodo = 'SUPLEMENTO';

         vpasexec := 4;

         IF vcfefecto = 'F_CAPITAL'
         THEN
            vpasexec := 44;
            vnumerr :=
                      pk_suplementos.f_capital (psproduc, psseguro, pfefecto);

            IF vnumerr <> 0
            THEN
               RETURN vnumerr;
            END IF;
         ELSIF vcfefecto = 'F_CFORPAG'
         THEN
            vpasexec := 444;
            vnumerr :=
                      pk_suplementos.f_cforpag (psproduc, psseguro, pfefecto);

            IF vnumerr <> 0
            THEN
               RETURN vnumerr;
            END IF;
         ELSIF vcfefecto = 'F_SYSDATE'
         THEN
            vpasexec := 4444;
            pfefecto := TRUNC (f_sysdate);
         ELSIF vcfefecto = 'F_FCARPRO'
         THEN
            vpasexec := 44444;
            vnumerr := pk_suplementos.f_fcarpro (psseguro, pfefecto);

            --*****ssegpol****
            IF vnumerr <> 0
            THEN
               RETURN vnumerr;
            END IF;
         ELSIF vcfefecto = 'F_FCARANU'
         THEN
            vpasexec := 444444;
            vnumerr := pk_suplementos.f_fcaranu (psseguro, pfefecto);

            IF vnumerr <> 0
            THEN
               RETURN vnumerr;
            END IF;
         ELSIF vcfefecto = 'F_FVERSCONV'
         THEN
            SELECT fefecto
              INTO v_fefectopol
              FROM seguros
             WHERE sseguro = psseguro;

            vpasexec := 444444;
            vnumerr :=
               pk_suplementos.f_fversconv (psseguro,
                                           'SEG',
                                           pfefecto,
                                           vidversion
                                          );
            pfefecto := GREATEST (pfefecto, v_fefectopol);

            IF vnumerr <> 0
            THEN
               RETURN vnumerr;
            END IF;
         END IF;
      ELSE
         pfefecto := pfsuplem;
      END IF;

      -- BUG14709:DRA:30/06/2010:Fi
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         pfefecto := TRUNC (f_sysdate);
         RETURN 0;
   END f_get_fsupl_pds;

   -- BUG11737:DRA:21/01/2010:Inici
   /*************************************************************************
                  Funci?n destinada a su utilizaci?n como POST SUPLEMENTO en aquellos
      suplementos que se haya modificado el tipo de revalorizacion
      param in  psseguro  : C?digo de seguro.
      return              : 0.- OK    <> 0 --> Error
   *************************************************************************/
   FUNCTION f_actualiza_crevali_detgaran (psseguro IN NUMBER)
      RETURN NUMBER
   IS
   BEGIN
      FOR regs IN (SELECT sseguro, nriesgo, cgarant, nmovimi, finiefe,
                          crevali, prevali, irevali
                     FROM garanseg
                    WHERE sseguro = psseguro AND ffinefe IS NULL)
      LOOP
         -- Actualizamos para todos los detalles de garant?a
         UPDATE detgaranseg
            SET crevali = regs.crevali,
                prevali = regs.prevali,
                irevali = regs.irevali
          WHERE sseguro = regs.sseguro
            AND nriesgo = regs.nriesgo
            AND cgarant = regs.cgarant
            AND nmovimi = regs.nmovimi
            AND finiefe = regs.finiefe;
      END LOOP;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_actualiza_crevali',
                      1,
                      'error no controlado psseguro:' || psseguro,
                      SQLERRM
                     );
         RETURN 140999;
   END f_actualiza_crevali_detgaran;

   -- BUG11737:DRA:21/01/2010:Fi
   FUNCTION f_anular_recibos_pend (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      CURSOR recibos_poliza (pfsuplem IN DATE)
      IS
         SELECT DISTINCT (r.nrecibo)
                    FROM recibos r
                   WHERE sseguro = psseguro
                     AND NVL (f_cestrec (r.nrecibo, pfsuplem), 0) = 0
                     AND TRUNC (r.fefecto) >= TRUNC (pfsuplem);

      vfsuplem      DATE;
      nerr          NUMBER;
      vsumiprianu   NUMBER;
      vnmovimi      NUMBER;
   BEGIN
      SELECT MAX (fefecto), MAX (nmovimi)
        INTO vfsuplem, vnmovimi
        FROM movseguro
       WHERE sseguro = psseguro;

      SELECT SUM (es.iprianu)
        INTO vsumiprianu
        FROM garanseg es, seguros s
       WHERE s.sseguro = es.sseguro
         AND es.sseguro = psseguro
         AND nmovimi = vnmovimi
         AND NVL (f_pargaranpro_v (s.cramo,
                                   s.cmodali,
                                   s.ctipseg,
                                   s.ccolect,
                                   s.cactivi,
                                   es.cgarant,
                                   'REDUCIBLE'
                                  ),
                  0
                 ) = 1
         AND cgarant <> 2116;

      IF vsumiprianu = 0
      THEN
         FOR c IN recibos_poliza (vfsuplem)
         LOOP
            BEGIN
               nerr :=
                      pac_gestion_rec.f_anula_recibo (c.nrecibo, vfsuplem, 0);
            EXCEPTION
               WHEN OTHERS
               THEN
                  p_tab_error
                     (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_anular_recibos_pend - pac_gestion_rec.f_anula_recibo',
                      1,
                         'error no controlado c.nrecibo:'
                      || c.nrecibo
                      || ',sseguro : '
                      || psseguro
                      || ',fsuplem :'
                      || vfsuplem,
                      SQLERRM
                     );
            END;
         END LOOP;
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_anular_recibos_pend',
                      1,
                      'error no controlado psseguro:' || psseguro,
                      SQLERRM
                     );
   END f_anular_recibos_pend;

   -- BUG16352:XPL:02112010 INICI
   /***********************************************************************
                  Recupera la query con las solicitudes seg?n los filtros introducidos
      psseguro IN NUMBER,
      pnmovimi IN NUMBER,
      pnriesgo IN NUMBER,
      pcidioma in number,
      pquery out varchar2
      return             : error
   ***********************************************************************/
   FUNCTION f_get_solicitudsuplementos (
      psseguro   IN       NUMBER,
      pnmovimi   IN       NUMBER,
      pnriesgo   IN       NUMBER,
      pcidioma   IN       NUMBER,
      pquery     OUT      VARCHAR2
   )
      RETURN NUMBER
   IS
      nerr     NUMBER;
      vwhere   VARCHAR2 (200);
      vquery   VARCHAR2 (2000);
   BEGIN
      vwhere := ' where sseguro = ' || psseguro;

      IF pnmovimi IS NOT NULL
      THEN
         vwhere := vwhere || ' and nmovimi = ' || pnmovimi;
      END IF;

      IF pnriesgo IS NOT NULL
      THEN
         vwhere := vwhere || ' and nriesgo = ' || pnriesgo;
      END IF;

      pquery :=
            'select nmovimi,festsup, sseguro,cgarant,
                    (select tmotmov from motmovseg motmov
                      where motmov.CMOTMOV= sup_solicitud.CMOTMOV
                      and cidioma='
         || pcidioma
         || ') as tmotmov, '
         || ' nriesgo,cmotmov, tvalora, tvalord, cestsup, ff_desvalorfijo(800025,'
         || pcidioma
         || ',cestsup) testsup, cpregun
                    from sup_solicitud '
         || vwhere
         || ' ORDER BY sup_solicitud.norden, sup_solicitud.festsup desc, sup_solicitud.nmovimi desc';
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_get_solicitudsuplementos',
                      1,
                      'error no controlado psseguro:' || psseguro,
                      SQLERRM
                     );
         RETURN 140999;
   END f_get_solicitudsuplementos;

   /*************************************************************************
                  Graba las modificaciones realizadas a la propuesta
      param in psseguro  : C¿digo seguro
      param in pnsolici  : C¿digo seguro tablas EST
      return             : NUMBER (1 se ha producido un error, 0 ha ido todo bien)
   *************************************************************************/
   FUNCTION f_actualizar_sol_suplemento (psseguro IN NUMBER, pnsolici IN NUMBER)
      RETURN NUMBER
   IS
      nerr        NUMBER;
      vwhere      VARCHAR2 (200);
      vquery      VARCHAR2 (2000);
      -- jlb
      wnorden     NUMBER;
      wnpoliza    NUMBER;
      pcclagd     NUMBER;
      ptclagd     VARCHAR2 (100);
      vidapunte   NUMBER;
      num_err     NUMBER;
      vfsuplem    DATE;
      vcempres    NUMBER;
      vcidioma    NUMBER;
      v_cagente   NUMBER;
      v_ctipage   NUMBER;
   BEGIN
      FOR i IN (SELECT nmovimi, cmotmov, nriesgo, cgarant, tvalora, tvalord,
                       cpregun
                  FROM estdetmovseguro
                 WHERE sseguro = pnsolici)
      LOOP
         BEGIN
            SELECT NVL (MAX (norden), 0) + 1
              INTO wnorden
              FROM sup_solicitud
             WHERE sseguro = psseguro;

            BEGIN
               SELECT fsuplem
                 INTO vfsuplem
                 FROM pds_estsegurosupl
                WHERE sseguro = pnsolici AND cmotmov = i.cmotmov;
            EXCEPTION
               WHEN NO_DATA_FOUND
               THEN
                  BEGIN
                     SELECT MAX (fsuplem)
                       INTO vfsuplem
                       FROM pds_estsegurosupl
                      WHERE sseguro = pnsolici;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        vfsuplem := f_sysdate;
                  END;
            END;

            -- jlb - anado el norden
            INSERT INTO sup_solicitud
                        (sseguro, nmovimi, cmotmov, nriesgo,
                         cgarant, tvalora, tvalord, cpregun, cestsup,
                         festsup, norden
                        )
                 VALUES (psseguro, i.nmovimi, i.cmotmov, i.nriesgo,
                         i.cgarant, i.tvalora, i.tvalord, i.cpregun, 0,
                         vfsuplem, wnorden
                        );
         EXCEPTION
            WHEN DUP_VAL_ON_INDEX
            THEN
               UPDATE sup_solicitud
                  SET tvalora = i.tvalora,
                      tvalord = i.tvalord,
                      festsup = vfsuplem
                WHERE sseguro = psseguro
                  AND nmovimi = i.nmovimi
                  AND cmotmov = i.cmotmov
                  AND nriesgo = i.nriesgo
                  AND cgarant = i.cgarant
                  AND cpregun = i.cpregun
                  AND cestsup = 0;
         END;
      END LOOP;

      DELETE      estdetmovseguro
            WHERE sseguro = pnsolici;

      pac_alctr126.borrar_tablas_est (pnsolici);

      BEGIN
         SELECT s.cagente, r.ctipage, s.cidioma, npoliza, s.cempres
           INTO v_cagente, v_ctipage, vcidioma, wnpoliza, vcempres
           FROM seguros s, redcomercial r
          WHERE s.sseguro = psseguro
            AND r.cagente = s.cagente
            AND r.fmovini =
                    (SELECT MAX (rr.fmovini)
                       FROM redcomercial rr
                      WHERE rr.cempres = s.cempres AND rr.cagente = s.cagente);

         pcclagd := 1;           -- C?digo Clave Agenda 0:siniestro / 1:poliza
         ptclagd := wnpoliza;                            -- Valor Clave Agenda
         num_err :=
            pac_agenda.f_set_apunte
                             (NULL,
                              NULL,
                              pcclagd,
                              psseguro,
                              0,
                              0,
                              0,         --5,  -- Lo asgino al grupo 0 -- OBSV
                              pac_parametros.f_parempresa_t (vcempres,
                                                             'ENV_TAREAS_DEF'
                                                            ),
                              f_axis_literales (9902334, vcidioma),     --9216
                              f_axis_literales (9902335, vcidioma) || wnpoliza,
                              0,
                              0,
                              NULL,
                              NULL,
                              f_user,
                              NULL,
                              f_sysdate,
                              f_sysdate,
                              NULL,
                              vidapunte
                             );
         num_err :=
            pac_agenda.f_set_agenda
                      (vidapunte,
                       NULL,
                       NULL,
                       0,                --5,  -- Lo asgino al grupo 0 -- OBSV
                       pac_parametros.f_parempresa_t (vcempres,
                                                      'ENV_TAREAS_DEF'
                                                     ),                --9216,
                       pcclagd,
                       psseguro,
                       NULL,
                       f_user,
                       v_ctipage,
                       v_cagente,
                       vcempres,
                       vcidioma,
                       'SUPLEMENTO'
                      );
      EXCEPTION
         WHEN OTHERS
         THEN
            p_tab_error
                       (f_sysdate,
                        f_user,
                        'PK_SUPLEMENTOS.f_actualizar_sol_suplemento, agenda',
                        1,
                        'error no controlado pnsolici:' || pnsolici,
                        SQLERRM
                       );
      END;

      --
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_actualizar_sol_suplemento',
                      1,
                      'error no controlado pnsolici:' || pnsolici,
                      SQLERRM
                     );
         RETURN 140999;
   END f_actualizar_sol_suplemento;

   -- BUG16352:XPL:02112010 fi

   -- BUG17787:DRA:10/03/2011:Inici
   /*************************************************************************
      Realiza los cambios en las tablas EST antes de empezar a modificar
      param in psseguro  : C?digo seguro tablas EST
      param in pnmovimi  : Numero movimiento
      param in pcmotmov  : C?digo motivo movimiento
      return             : NUMBER (1 se ha producido un error, 0 ha ido todo bien)
   *************************************************************************/
   FUNCTION f_pre_suplemento (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      pcmotmov   IN   NUMBER
   )
      RETURN NUMBER
   IS
      --
      nerr        NUMBER;
      v_sproduc   NUMBER;
   BEGIN
      IF pcmotmov = 266
      THEN
         -- Si es un suplemento de suspensi?n de aportaci?n peri?dica,
         --  ponemos a cero el capital de la aportaci?n peri?dica
         UPDATE estgaranseg g
            SET g.icapital = 0
          WHERE g.sseguro = psseguro
            AND g.nmovimi = pnmovimi
            AND 3 =
                   (SELECT NVL
                              (f_pargaranpro_v
                                    (s.cramo,
                                     s.cmodali,
                                     s.ctipseg,
                                     s.ccolect,
                                     pac_seguros.ff_get_actividad (s.sseguro,
                                                                   g.nriesgo,
                                                                   'EST'
                                                                  ),
                                     g.cgarant,
                                     'TIPO'
                                    ),
                               0
                              )
                      FROM estseguros s
                     WHERE s.sseguro = g.sseguro);
      ELSIF pcmotmov = 900
      THEN
         SELECT sproduc
           INTO v_sproduc
           FROM estseguros
          WHERE sseguro = psseguro;

         UPDATE estseguros
            --Ini bug 26488 -- ECP -- 14/06/2013  Se cambia frenova =  NVL(frenova, fcaranu) + NVL(f_parproductos_v(v_sproduc, 'DIAS_PRORROGA'), 0) por
         SET frenova =
                ADD_MONTHS (NVL (frenova, fcaranu),
                            NVL (f_parproductos_v (v_sproduc,
                                                   'MESES_PRORROGA'),
                                 0
                                )
                           ),
             --Fin bug 26488 -- ECP -- 14/06/2013
             cduraci = 6
          WHERE sseguro = psseguro;
      -- Bug 29665/168265 - 04/03/2014 - AMC
      ELSIF pcmotmov = 674
      THEN
         SELECT sproduc
           INTO v_sproduc
           FROM estseguros
          WHERE sseguro = psseguro;

         UPDATE estseguros
            SET cduraci = 6
          WHERE sseguro = psseguro;
      END IF;

      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_pre_suplemento',
                      1,
                         'Error no controlado. psseguro: '
                      || psseguro
                      || ', pnmovimi: '
                      || pnmovimi
                      || ', pcmotmov: '
                      || pcmotmov,
                      SQLERRM
                     );
         RETURN 140999;
   END f_pre_suplemento;

   -- BUG17787:DRA:10/03/2011:Fi

   /*************************************************************************
      Actualiza el estado de la solicitud del suplemento
      param in psseguro  : C?digo seguro
      param in pnmovimi  : Num. Movimiento
      param in pnriesgo  : N. riesgo
      param in pcestsupl  : Estado suplemento
      return             : NUMBER (1 se ha producido un error, 0 ha ido todo bien)
   *************************************************************************/
   FUNCTION f_set_actualizarestado_supl (
      psseguro   IN   NUMBER,
      pnmovimi   IN   NUMBER,
      pnriesgo   IN   NUMBER,
      pcmotmov   IN   NUMBER,
      pcgarant   IN   NUMBER,
      pcpregun   IN   NUMBER,
      pcestado   IN   NUMBER
   )
      RETURN NUMBER
   IS
      vpasexec   NUMBER (8)      := 1;
      vparam     VARCHAR2 (200)
         :=    'psseguro: '
            || psseguro
            || ',pnmovimi = '
            || pnmovimi
            || ',pnriesgo:'
            || pnriesgo
            || ',pcmotmov:'
            || pcmotmov
            || ',pcgarant:'
            || pcgarant
            || ',pcpregun:'
            || pcpregun
            || ',pcestado : '
            || pcestado;
      vobject    VARCHAR2 (200)
                               := 'pk_suplementos.f_set_actualizarestado_supl';
      nerror     NUMBER          := 0;
      vselect    VARCHAR2 (2000);
      vfrom      VARCHAR2 (200);
      vwhere     VARCHAR2 (2000);
      pquery     VARCHAR2 (4000);
      vsseguro   NUMBER;
   BEGIN
      UPDATE sup_solicitud
         SET cestsup = pcestado,
             cmodificado = 1
       WHERE sseguro = psseguro
         AND nmovimi = pnmovimi
         AND nriesgo = pnriesgo
         AND cmotmov = pcmotmov
         AND cgarant = NVL (pcgarant, 0)
         AND cpregun = NVL (pcpregun, 0);

      RETURN nerror;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      'PK_SUPLEMENTOS.f_set_actualizarestado_supl',
                      1,
                         'Error no controlado. psseguro: '
                      || psseguro
                      || ', pnmovimi: '
                      || pnmovimi
                      || ', pnriesgo: '
                      || pnriesgo,
                      SQLERRM
                     );
         RETURN 140999;
   END f_set_actualizarestado_supl;

   /*************************************************************************
      FUNCTION f_prod_permite_supl
      param in psproduc  : psproduc
      param in pcmotmov  : pcmotmov
      param out tmensaje : Mens Error
      return             : NUMBER (1 se ha producido un error, 0 ha ido todo bien)
      --BUG17255 - 04/07/2011 - JTS
   *************************************************************************/
   FUNCTION f_prod_permite_supl (
      psproduc   IN       NUMBER,
      pcmotmov   IN       NUMBER,
      pcactivi   IN       NUMBER,
      tmensaje   OUT      VARCHAR2
   )
      RETURN NUMBER
   IS
      vpasexec    NUMBER (8)     := 1;
      vparam      VARCHAR2 (200)
         :=    'psproduc: '
            || psproduc
            || ',pcmotmov:'
            || pcmotmov
            || ',pcactivi:'
            || pcactivi;
      vobject     VARCHAR2 (200) := 'pk_suplementos.f_prod_permite_supl';
      v_slitera   NUMBER;
   BEGIN
      BEGIN
         SELECT literror
           INTO v_slitera
           FROM pds_supl_permite_prodmov p, pds_config_user us
          WHERE p.sproduc = psproduc
            AND p.cmotmov = pcmotmov
            AND p.cempres = pac_md_common.f_get_cxtempresa
            AND p.cconsupl = us.cconsupl
            AND us.cuser = f_user
            AND p.cactivi = pcactivi;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            RETURN 0;
      END;

      vpasexec := 2;
      tmensaje := f_axis_literales (v_slitera, pac_md_common.f_get_cxtidioma);
      RETURN 1;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobject,
                      vpasexec,
                      'Error no controlado. ' || vparam,
                      SQLCODE || '-' || SQLERRM
                     );
         tmensaje := SQLERRM;
         RETURN 1;
   END f_prod_permite_supl;

   -- Bug 19808 - RSC - 10/11/2011 - Comprobamos si la fecha de fecto supera el m?ximo
   FUNCTION f_fcaranu (psseguro IN NUMBER, pdata IN OUT DATE)
      RETURN NUMBER
   IS
      num_err     NUMBER;
      v_fcaranu   DATE;
      v_fefepol   DATE;
   BEGIN
      BEGIN
         SELECT fcaranu, fefecto
           INTO v_fcaranu, v_fefepol
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN OTHERS
         THEN
            RETURN 102903;                      --No s'ha trobat cap registre
      END;

      IF v_fefepol > TRUNC (f_sysdate)
      THEN
         pdata := v_fefepol;
      ELSE
         pdata := v_fcaranu;
      END IF;

      RETURN 0;
   END f_fcaranu;

   -- Bug 19808
   -- INI BUG CONF-1243 QT_724 y QT_728 - 06/02/2018 - Grabar datos de fechas para Vigencia Amparos (SUPLEMENTO 918)
   FUNCTION f_cambio_fechas_traslado_vig (
      psseguro          IN       NUMBER,
      psproduc          IN       NUMBER,
      pnriesgo          IN       NUMBER,
      pcgarant          IN       NUMBER,
      pnmovimi          IN       NUMBER,
      pfiniefe          IN       DATE,
      pfefecto          IN       DATE,
      pfvencim          IN       DATE,
      pfefeplazo        IN       DATE,
      pfvencplazo       IN       DATE,
      pextcontractual   OUT      NUMBER,
      pcmotmov          IN       NUMBER,         -- IAXIS-3396 CJMR 09/04/2019
      pndias            IN       NUMBER DEFAULT NULL,
      pnmeses           IN       NUMBER DEFAULT NULL,
      pnanios           IN       NUMBER DEFAULT NULL
   )
      RETURN NUMBER
   IS                                            -- IAXIS-3394 CJMR 22/04/2019
      vobj               VARCHAR2 (200)
                             := 'PK_SUPLEMENTOS.f_cambio_fechas_traslado_vig';
      vpar               VARCHAR2 (500)
         :=    'seg='
            || psseguro
            || ' psproduc='
            || psproduc
            || ' pnriesgo='
            || pnriesgo
            || ' pcgarant='
            || pcgarant
            || ' pnmovimi='
            || pnmovimi
            || ' pfiniefe ='
            || pfiniefe
            || ' pfefecto='
            || pfefecto
            || ' pfvencim='
            || pfvencim
            || ' pfefeplazo='
            || pfefeplazo
            || ' pfvencplazo='
            || pfvencplazo
            || ' pcmotmov='
            || pcmotmov;                         -- IAXIS-3396 CJMR 09/04/2019
      v_pasexec          NUMBER                 := 0;
      v_numerr           NUMBER                 := 0;
      v_extcontractual   NUMBER                 := NULL;
      v_cactivi          riesgos.cactivi%TYPE;
      -- INI IAXIS-3396 CJMR 09/04/2019
      v_fvencim          DATE;
      v_fvencplazo       DATE;
   -- FIN IAXIS-3396 CJMR 09/04/2019
   BEGIN
      v_cactivi := pac_seguros.ff_get_actividad (psseguro, pnriesgo, 'EST');
      v_extcontractual :=
         NVL (pac_iaxpar_productos.f_get_pargarantia ('EXCONTRACTUAL',
                                                      psproduc,
                                                      pcgarant,
                                                      v_cactivi
                                                     ),
              0
             );
      pextcontractual := v_extcontractual;

      -- INI IAXIS-3394 CJMR 17/04/2019
      IF pcmotmov = 918
      THEN
         UPDATE estgaranseg e
            SET e.finivig =
                     (  (  TRUNC (e.finivig)
                         + NUMTODSINTERVAL (NVL (pndias, 0), 'DAY')
                        )
                      + NUMTOYMINTERVAL (NVL (pnmeses, 0), 'MONTH')
                     )
                   + NUMTOYMINTERVAL (NVL (pnanios, 0), 'YEAR'),
                e.ffinvig =
                     (  (  TRUNC (e.ffinvig)
                         + NUMTODSINTERVAL (NVL (pndias, 0), 'DAY')
                        )
                      + NUMTOYMINTERVAL (NVL (pnmeses, 0), 'MONTH')
                     )
                   + NUMTOYMINTERVAL (NVL (pnanios, 0), 'YEAR')
          WHERE e.sseguro = psseguro
            AND e.nriesgo = pnriesgo
            AND e.cgarant = pcgarant
            AND e.nmovimi = pnmovimi
            AND e.finiefe = pfefecto;
      ELSIF pcmotmov = 915
      THEN                                   -- INI IAXIS-3396 CJMR 09/04/2019
         SELECT fvencim, fvencplazo
           INTO v_fvencim, v_fvencplazo
           FROM seguros
          WHERE sseguro = psseguro;

         IF v_extcontractual IN (0)
         THEN
            UPDATE estgaranseg e
               SET e.ffinvig =
                      (CASE
                          WHEN (TRUNC (v_fvencim) != TRUNC (pfvencim))
                             THEN pfvencim
                          ELSE e.ffinvig
                       END
                      )
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         -- INI IAXIS-5222 CJMR 04/09/2019
         ELSIF v_extcontractual IN (1)
         THEN
            UPDATE estgaranseg e
               SET e.ffinvig = e.ffinvig + (pfvencplazo - v_fvencplazo)
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         -- FIN IAXIS-5222 CJMR 04/09/2019
         ELSIF v_extcontractual IN (2)
         THEN
            UPDATE estgaranseg e
               SET e.finivig =
                      (CASE
                          WHEN (TRUNC (v_fvencplazo) != TRUNC (pfvencplazo))
                             THEN e.finivig + (pfvencplazo - v_fvencplazo)
                          ELSE e.finivig
                       END
                      ),
                   e.ffinvig = e.ffinvig + (pfvencplazo - v_fvencplazo)
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         END IF;
      ELSIF pcmotmov NOT IN (237, 239)
      THEN                                       -- IAXIS-3396 CJMR 09/04/2019
         IF v_extcontractual IN (0)
         THEN
            UPDATE estgaranseg e
               SET e.finivig = pfefecto,
                   e.ffinvig = pfvencim
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         ELSIF v_extcontractual IN (1)
         THEN
            UPDATE estgaranseg e
               SET e.finivig = pfefecto,
                   e.ffinvig = pfvencplazo
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         ELSIF v_extcontractual IN (2)
         THEN
            UPDATE estgaranseg e
               SET e.finivig = pfvencplazo,
                   e.ffinvig = pfvencim
             WHERE e.sseguro = psseguro
               AND e.nriesgo = pnriesgo
               AND e.cgarant = pcgarant
               AND e.nmovimi = pnmovimi
               AND e.finiefe = pfefecto;
         END IF;
      END IF;

      -- FIN IAXIS-3396 CJMR 09/04/2019
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      v_pasexec,
                      'Error no controlado ' || vpar,
                      v_numerr || ' ' || SQLERRM
                     );
         RETURN 1;
   END f_cambio_fechas_traslado_vig;

   -- FIN BUG CONF-1243 QT_724

   -- BUG24271:DRA:01/11/2012:Inici
   -- Bug 0026070 - 19/03/2013 - JMF
   FUNCTION f_traslado_vigencia (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      vobj                VARCHAR2 (200)
                                      := 'PK_SUPLEMENTOS.f_traslado_vigencia';
      vpar                VARCHAR2 (500)             := 'seg=' || psseguro;
      v_pasexec           NUMBER                     := 0;
      v_nmovimi           movseguro.nmovimi%TYPE;
      v_numerr            NUMBER;
      rpend               pac_anulacion.recibos_pend;
      rcob                pac_anulacion.recibos_cob;
      v_cont_pend         NUMBER;
      v_cont_cob          NUMBER;
      error_proc          EXCEPTION;
      v_fsuplem           movseguro.fefecto%TYPE;
      v_fefecto           seguros.fefecto%TYPE;
      lfvencim            seguros.fvencim%TYPE;
      lfcanua             DATE;
      lfcapro             DATE;
      l_fefecto_1         DATE;
      lfaux               DATE;
      fecha_aux           DATE;
      lcrevfpg            productos.crevfpg%TYPE;
      lndiaspro           productos.ndiaspro%TYPE;
      lcprprod            productos.cprprod%TYPE;
      lctipefe            productos.ctipefe%TYPE;
      lctiprec            recibos.ctiprec%TYPE;
      lctipmov            NUMBER;
      lcmovi              NUMBER;
      lmeses              NUMBER;
      xcmodcom            NUMBER;
      lcforpag            NUMBER;
      ddmm                VARCHAR2 (4);
      dd                  VARCHAR2 (2);
      ximporx             NUMBER;             --Var. muda le devuelve RECRIES
      lcdomper            movseguro.cdomper%TYPE;
      xcimpres            NUMBER;
      v_conta             NUMBER;
      v_emitir            NUMBER                     := 0;
      mensajes            t_iax_mensajes;
      indice              NUMBER;
      indice_e            NUMBER;
      v_cmotret           NUMBER;
      v_nmovimi_col       NUMBER;
      v_nmovimiaux        NUMBER;
      v_nreciboclon       NUMBER;
      v_ssmovrec          movrecibo.smovrec%TYPE     := 0;
      v_nmovimi_reh       movseguro.nmovimi%TYPE;
      v_fefecto_tra       seguros.fefecto%TYPE;
      v_cduraci_tra       seguros.cduraci%TYPE;
      v_frenova_tra       seguros.frenova%TYPE;
      v_fefecto2          seguros.fefecto%TYPE;
      v_cduraci           seguros.cduraci%TYPE;
      v_frenova           seguros.frenova%TYPE;
      v_nmovimi_tr        movseguro.nmovimi%TYPE;
      vnmovimi_anu        movseguro.nmovimi%TYPE;
      v_sseguro_est       estseguros.sseguro%TYPE;
      v_mens              VARCHAR2 (400);
      v_maxnmovim_cert    NUMBER;
      v_nmovimi_rehcero   NUMBER;
      v_fefecto_est       seguros.fefecto%TYPE;
      v_cont_certifs      NUMBER;

      -- Funcion interna, ya que la repetimos para cert padre e hijo
      FUNCTION f_accion_traslado_vigencia (
         p_seg           IN   NUMBER,
         p_trasladovig   IN   DATE DEFAULT NULL
      )
         RETURN NUMBER
      IS
         CURSOR c_riesgos
         IS
            SELECT nriesgo
              FROM riesgos
             WHERE sseguro = p_seg AND fanulac IS NULL;

         pmensaje   VARCHAR2 (500);           -- BUG 27642 - FAL - 30/04/2014
      BEGIN
         v_pasexec := 1000;

         FOR v_pol IN (SELECT *
                         FROM seguros
                        WHERE sseguro = p_seg)
         LOOP
            --
            v_pasexec := 1010;

            SELECT MAX (nmovimi), MAX (fefecto), MAX (lcdomper)
              INTO v_nmovimi, v_fsuplem, lcdomper
              FROM movseguro
             WHERE sseguro = v_pol.sseguro;

            vpar :=
                  's='
               || v_pol.sseguro
               || ' m='
               || v_nmovimi
               || ' s='
               || v_fsuplem
               || ' t='
               || p_trasladovig;
            -- Si la actual fecha certificado es menor fecha traslado, la actualizamos
            v_pasexec := 1020;

            IF NVL (v_pol.ncertif, 0) <> 0 AND p_trasladovig IS NOT NULL
            THEN
               IF v_pol.fefecto < p_trasladovig
               THEN
                  SELECT fefecto, fcarpro, fcaranu,
                         nrenova, frenova, v_pol.fefecto
                    INTO v_pol.fefecto, v_pol.fcarpro, v_pol.fcaranu,
                         v_pol.nrenova, v_pol.frenova, v_pol.fcancel
                    FROM seguros
                   WHERE npoliza = v_pol.npoliza AND ncertif = 0;

                  UPDATE seguros
                     SET fcarpro = v_pol.fcarpro,
                         fcaranu = v_pol.fcaranu,
                         nrenova = v_pol.nrenova,
                         frenova = v_pol.frenova,
                         fcancel = v_pol.fefecto
                   WHERE sseguro = v_pol.sseguro;

                  UPDATE riesgos
                     SET fefecto = v_pol.fefecto
                   WHERE sseguro = v_pol.sseguro;

                  UPDATE asegurados
                     SET ffecini = v_pol.fefecto
                   WHERE sseguro = v_pol.sseguro;

                  --Bug 29665/168265 - 03/03/2014 - AMC
                  UPDATE seguredcom
                     SET fefecto = v_pol.fefecto,
                         fanulac = v_pol.fefecto,
                         fmovini = v_pol.fefecto
                   WHERE sseguro = v_pol.sseguro;
               --Fi Bug 29665/168265 - 03/03/2014 - AMC
               END IF;
            END IF;

            v_pasexec := 2;
            v_cont_pend := 1;
            -- Recorremos los recibos pendientes de cobro y los anulamos
            v_pasexec := 1030;

            IF     v_pol.ncertif = 0
               AND pac_seguros.f_es_col_admin (v_pol.sseguro, 'SEG') = 1
            THEN
               SELECT MIN (nmovimi_0)
                 INTO v_nmovimi_col
                 FROM detmovsegurocol
                WHERE sseguro_0 = v_pol.sseguro;
            END IF;

            IF     NVL (v_pol.ncertif, 0) = 0
               AND NVL
                      (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                       0
                      ) = 1
            THEN
               FOR rp IN (SELECT r.nrecibo, r.fefecto, r.fvencim, m.fmovini
                            FROM recibos r, movrecibo m
                           WHERE r.sseguro = v_pol.sseguro
                             AND f_cestrec (r.nrecibo, f_sysdate) = 0
                             AND r.cestaux = 0           -- solo los agrupados
                             AND m.nrecibo = r.nrecibo
                             AND m.smovrec = (SELECT MAX (m1.smovrec)
                                                FROM movrecibo m1
                                               WHERE m1.nrecibo = m.nrecibo))
               LOOP
                  v_pasexec := 1040;
                  rpend (v_cont_pend).nrecibo := rp.nrecibo;
                  rpend (v_cont_pend).fefecto := rp.fefecto;
                  rpend (v_cont_pend).fvencim := rp.fvencim;
                  rpend (v_cont_pend).fmovini := rp.fmovini;
                  v_cont_pend := v_cont_pend + 1;
               END LOOP;
            ELSE
               -- Si es administrado el extorno lo har? la baja de recibos disparada desde el 0
               IF     NVL
                         (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                          0
                         ) = 1
                  AND pac_seguros.f_es_col_admin (v_pol.sseguro, 'SEG') <> 1
               THEN
                  FOR rp IN (SELECT r.nrecibo, r.fefecto, r.fvencim,
                                    m.fmovini
                               FROM recibos r, movrecibo m
                              WHERE r.sseguro = v_pol.sseguro
                                AND f_cestrec (r.nrecibo, f_sysdate) = 0
                                AND m.nrecibo = r.nrecibo
                                AND m.smovrec =
                                               (SELECT MAX (m1.smovrec)
                                                  FROM movrecibo m1
                                                 WHERE m1.nrecibo = m.nrecibo))
                  LOOP
                     v_pasexec := 1040;
                     rpend (v_cont_pend).nrecibo := rp.nrecibo;
                     rpend (v_cont_pend).fefecto := rp.fefecto;
                     rpend (v_cont_pend).fvencim := rp.fvencim;
                     rpend (v_cont_pend).fmovini := rp.fmovini;
                     v_cont_pend := v_cont_pend + 1;
                  END LOOP;
               END IF;
            END IF;

            v_pasexec := 1050;

            IF v_cont_pend > 1
            THEN
               v_pasexec := 1060;
               -- Si hay recibos pendientes, anulamos estos
               v_numerr :=
                  pac_anulacion.f_baja_rec_pend (NVL (v_fsuplem, f_sysdate),
                                                 rpend,
                                                 0,
                                                 v_nmovimi_col
                                                );

               IF v_numerr <> 0
               THEN
                  vpar :=
                     'seg=' || psseguro || ' fec='
                     || NVL (v_fsuplem, f_sysdate);
                  RAISE error_proc;
               END IF;
            END IF;

            v_pasexec := 1070;
            v_cont_cob := 1;

            -- Recorremos los recibos cobrados los extornamos
            IF     NVL (v_pol.ncertif, 0) = 0
               AND NVL
                      (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                       0
                      ) = 1
            THEN
               FOR rc IN (SELECT r.nrecibo, r.fefecto, r.fvencim, m.fmovini
                            FROM recibos r, movrecibo m
                           WHERE r.sseguro = v_pol.sseguro
                             AND r.cestaux = 0
                             AND f_cestrec (r.nrecibo, f_sysdate) = 1
                             AND m.nrecibo = r.nrecibo
                             AND m.smovrec = (SELECT MAX (m1.smovrec)
                                                FROM movrecibo m1
                                               WHERE m1.nrecibo = m.nrecibo))
               LOOP
                  rcob.DELETE;
                  v_pasexec := 1080;
                  rcob (v_cont_cob).nrecibo := rc.nrecibo;
                  rcob (v_cont_cob).fefecto := rc.fefecto;
                  rcob (v_cont_cob).fvencim := rc.fvencim;
                  rcob (v_cont_cob).fmovini := rc.fmovini;
                  v_pasexec := 1090;
                  v_cont_cob := v_cont_cob + 1;
               END LOOP;
            ELSE
               -- Si es administrado el extorno lo har? la baja de recibos disparada desde el 0
               IF     NVL
                         (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                          0
                         ) = 1
                  AND pac_seguros.f_es_col_admin (v_pol.sseguro, 'SEG') <> 1
               THEN
                  FOR rc IN (SELECT r.nrecibo, r.fefecto, r.fvencim,
                                    m.fmovini
                               FROM recibos r, movrecibo m
                              WHERE r.sseguro = v_pol.sseguro
                                AND f_cestrec (r.nrecibo, f_sysdate) = 1
                                AND m.nrecibo = r.nrecibo
                                AND m.smovrec =
                                               (SELECT MAX (m1.smovrec)
                                                  FROM movrecibo m1
                                                 WHERE m1.nrecibo = m.nrecibo))
                  LOOP
                     rcob.DELETE;
                     v_pasexec := 1080;
                     rcob (v_cont_cob).nrecibo := rc.nrecibo;
                     rcob (v_cont_cob).fefecto := rc.fefecto;
                     rcob (v_cont_cob).fvencim := rc.fvencim;
                     rcob (v_cont_cob).fmovini := rc.fmovini;
                     v_pasexec := 1090;
                     v_cont_cob := v_cont_cob + 1;
                  END LOOP;
               END IF;
            END IF;

            -- Si hay recibos cobrados, anulamos estos
            IF v_cont_cob > 1
            THEN
               v_numerr :=
                  pac_anulacion.f_extorn_rec_cobrats (v_pol.sseguro,
                                                      v_pol.cagente,
                                                      v_nmovimi,
                                                      NVL (v_fsuplem,
                                                           f_sysdate
                                                          ),
                                                      v_pol.cmoneda,
                                                      rcob,
                                                      0,
                                                      0,
                                                      v_nmovimi_col
                                                     );

               IF v_numerr <> 0
               THEN
                  vpar :=
                        'seg='
                     || psseguro
                     || ' age='
                     || v_pol.cagente
                     || ' mov='
                     || v_nmovimi
                     || ' efe='
                     || NVL (v_fsuplem, f_sysdate)
                     || ' mon='
                     || v_pol.cmoneda;
                  RAISE error_proc;
               END IF;
            END IF;

            -- Ahora generamos el nuevo recibo con la nueva fecha de efecto del seguro
            v_pasexec := 1100;

            SELECT crevfpg, ndiaspro, cprprod, ctipefe
              INTO lcrevfpg, lndiaspro, lcprprod, lctipefe
              FROM productos
             WHERE cramo = v_pol.cramo
               AND cmodali = v_pol.cmodali
               AND ctipseg = v_pol.ctipseg
               AND ccolect = v_pol.ccolect;

            v_pasexec := 1110;

            --Forma de pago no ?nica o forma de pago ?nica con renovaci?n,
            IF     (v_pol.cforpag <> 0
                    OR (v_pol.cforpag = 0 AND lcrevfpg = 1)
                   )
               AND v_pol.csituac = 0
            THEN
               --
               v_pasexec := 1120;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  lcforpag := 1;
               -- que calcule las fechas como si fuera pago anual
               ELSE
                  lcforpag := v_pol.cforpag;
               END IF;

               v_pasexec := 1130;
               -- Calcul de la data de renovaci?
               lmeses := 12 / lcforpag;
               v_pasexec := 1140;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  dd := TO_CHAR (v_pol.frenova, 'dd');
                  -- SUBSTR(LPAD(v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := TO_CHAR (v_pol.frenova, 'ddmm');
               -- dd || SUBSTR(LPAD(v_pol.nrenova, 4, 0), 1, 2);
               ELSE
                  -- Fin bug 23117
                  dd := SUBSTR (LPAD (v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := dd || SUBSTR (LPAD (v_pol.nrenova, 4, 0), 1, 2);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               v_pasexec := 1150;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
               ELSE
                  v_pasexec := 1160;

                  -- Fin bug 23117
                  IF    TO_CHAR (v_pol.fefecto, 'DDMM') = ddmm
                     OR LPAD (v_pol.nrenova, 4, 0) IS NULL
                  THEN
                     v_pasexec := 1170;
                     lfcanua := f_summeses (v_pol.fefecto, 12, dd);
                  ELSE
                     v_pasexec := 1180;

                     IF lctipefe = 2
                     THEN
                        -- a d?a 1/mes por exceso
                        fecha_aux := ADD_MONTHS (v_pol.fefecto, 13);
                        lfcanua :=
                           TO_DATE (ddmm || TO_CHAR (fecha_aux, 'YYYY'),
                                    'DDMMYYYY'
                                   );
                     ELSE
                        BEGIN
                           lfcanua :=
                              TO_DATE (ddmm || TO_CHAR (v_pol.fefecto, 'YYYY'),
                                       'DDMMYYYY'
                                      );
                        EXCEPTION
                           WHEN OTHERS
                           THEN
                              IF ddmm = 2902
                              THEN
                                 ddmm := 2802;
                                 lfcanua :=
                                    TO_DATE (   ddmm
                                             || TO_CHAR (v_pol.fefecto,
                                                         'YYYY'),
                                             'DDMMYYYY'
                                            );
                              ELSE
                                 --Fecha de renovaci?n (mmdd) incorrecta
                                 v_numerr := 104510;
                                 vpar :=
                                       'seg='
                                    || psseguro
                                    || ' ddmm='
                                    || ddmm
                                    || ' efe='
                                    || v_pol.fefecto;
                                 RAISE error_proc;
                              END IF;
                        END;
                     END IF;

                     v_pasexec := 1190;

                     IF lfcanua <= v_pol.fefecto
                     THEN
                        lfcanua := f_summeses (lfcanua, 12, dd);
                     END IF;
                  END IF;
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               -- Fin bug 23117
               v_pasexec := 1200;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
               THEN
                  lfcapro := v_pol.frenova;
               ELSE
                  v_pasexec := 1210;

                  -- Se calcula la pr?x. cartera partiendo de la cartera de renovaci?n (fcaranu)
                  -- y rest?ndole periodos de pago
                  -- Calculem la data de propera cartera
                  IF     lctipefe = 2
                     AND TO_CHAR (v_pol.fefecto, 'dd') <> 1
                     AND lcforpag <> 12
                  THEN
                     l_fefecto_1 :=
                           '01/'
                        || TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1), 'mm/yyyy');
                  ELSE
                     l_fefecto_1 := v_pol.fefecto;
                  END IF;

                  lfaux := lfcanua;
                  v_pasexec := 1220;

                  WHILE TRUE
                  LOOP
                     lfaux := f_summeses (lfaux, -lmeses, dd);

                     IF lfaux <= l_fefecto_1
                     THEN
                        lfcapro := f_summeses (lfaux, lmeses, dd);
                        EXIT;
                     END IF;
                  END LOOP;
               END IF;

               v_pasexec := 1230;

               -- Si el d?a de la fecha de efecto es mayor o igual que
               -- ndiaspro, se le anade un periodo m?s.
               -- Nom?s funcionava per mensuals. Cal mirar del periode que cubreix si
               -- supera el dia 15 de l'ultim mes , i que no es passi de la renovaci?
               IF (lndiaspro IS NOT NULL)
               THEN
                  IF     TO_NUMBER (TO_CHAR (v_pol.fefecto, 'dd')) >=
                                                                    lndiaspro
                     AND TO_NUMBER (TO_CHAR (lfcapro, 'mm')) =
                            TO_NUMBER (TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1),
                                                'mm'
                                               )
                                      )
                  THEN
                     -- ?s a dir , que el dia sigui > que el dia 15 de l'ultim m?s del periode
                     lfcapro := ADD_MONTHS (lfcapro, lmeses);

                     IF lfcapro > lfcanua
                     THEN
                        lfcapro := lfcanua;
                     END IF;
                  END IF;
               END IF;

               v_pasexec := 1240;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
                  IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
                  THEN
                     lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
                  ELSE
                     -- Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                     -- con duraci?n vitalicia
                     -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                     lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
                  END IF;
               -- el vencimiento del recibo ser? el vencimiento de la p?liza
               ELSE
                  lfvencim := lfcapro;
               END IF;
            ELSIF v_pol.cforpag = 0 AND lcrevfpg = 0
            THEN
               --Forma de pago ?nica y nueva producci?n ? suplemento
               v_pasexec := 1250;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
                  lfcapro := v_pol.frenova;
                  lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
               ELSE
                  -- Fin bug 23117
                  lfcanua := v_pol.fcaranu;
                  lfcapro := v_pol.fcarpro;
                  --Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                  -- con duraci?n vitalicia
                  -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                  lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;
            -- Fin bug 23117
            ELSE
               -- Si es un suplemento
               v_pasexec := 1260;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  lcforpag := 1;
               -- que calcule las fechas como si fuera pago anual
               ELSE
                  lcforpag := v_pol.cforpag;
               END IF;

               v_pasexec := 1270;
               -- Calcul de la data de renovaci?
               lmeses := 12 / lcforpag;
               v_pasexec := 1280;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  dd := TO_CHAR (v_pol.frenova, 'dd');
                  -- SUBSTR(LPAD(v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := TO_CHAR (v_pol.frenova, 'ddmm');
               -- dd || SUBSTR(LPAD(v_pol.nrenova, 4, 0), 1, 2);
               ELSE
                  -- Fin bug 23117
                  dd := SUBSTR (LPAD (v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := dd || SUBSTR (LPAD (v_pol.nrenova, 4, 0), 1, 2);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               v_pasexec := 1290;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
               ELSE
                  v_pasexec := 1300;

                  -- Fin bug 23117
                  IF    TO_CHAR (v_pol.fefecto, 'DDMM') = ddmm
                     OR LPAD (v_pol.nrenova, 4, 0) IS NULL
                  THEN
                     v_pasexec := 1310;
                     lfcanua := f_summeses (v_pol.fefecto, 12, dd);
                  ELSE
                     v_pasexec := 1320;

                     IF lctipefe = 2
                     THEN
                        -- a d?a 1/mes por exceso
                        fecha_aux := ADD_MONTHS (v_pol.fefecto, 13);
                        lfcanua :=
                           TO_DATE (ddmm || TO_CHAR (fecha_aux, 'YYYY'),
                                    'DDMMYYYY'
                                   );
                     ELSE
                        BEGIN
                           lfcanua :=
                              TO_DATE (ddmm || TO_CHAR (v_pol.fefecto, 'YYYY'),
                                       'DDMMYYYY'
                                      );
                        EXCEPTION
                           WHEN OTHERS
                           THEN
                              IF ddmm = 2902
                              THEN
                                 ddmm := 2802;
                                 lfcanua :=
                                    TO_DATE (   ddmm
                                             || TO_CHAR (v_pol.fefecto,
                                                         'YYYY'),
                                             'DDMMYYYY'
                                            );
                              ELSE
                                 --Fecha de renovaci?n (mmdd) incorrecta
                                 v_numerr := 104510;
                                 vpar :=
                                       'seg='
                                    || psseguro
                                    || ' ddmm='
                                    || ddmm
                                    || ' efe='
                                    || v_pol.fefecto;
                                 RAISE error_proc;
                              END IF;
                        END;
                     END IF;

                     v_pasexec := 1330;

                     IF lfcanua <= v_pol.fefecto
                     THEN
                        lfcanua := f_summeses (lfcanua, 12, dd);
                     END IF;
                  END IF;
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               -- Fin bug 23117
               v_pasexec := 1340;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
               THEN
                  lfcapro := v_pol.frenova;
               ELSE
                  v_pasexec := 1350;

                  -- Se calcula la pr?x. cartera partiendo de la cartera de renovaci?n (fcaranu)
                  -- y rest?ndole periodos de pago
                  -- Calculem la data de propera cartera
                  IF     lctipefe = 2
                     AND TO_CHAR (v_pol.fefecto, 'dd') <> 1
                     AND lcforpag <> 12
                  THEN
                     l_fefecto_1 :=
                           '01/'
                        || TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1), 'mm/yyyy');
                  ELSE
                     l_fefecto_1 := v_pol.fefecto;
                  END IF;

                  lfaux := lfcanua;
                  v_pasexec := 1360;

                  WHILE TRUE
                  LOOP
                     lfaux := f_summeses (lfaux, -lmeses, dd);

                     IF lfaux <= l_fefecto_1
                     THEN
                        lfcapro := f_summeses (lfaux, lmeses, dd);
                        EXIT;
                     END IF;
                  END LOOP;
               END IF;

               v_pasexec := 1370;

               -- Si el d?a de la fecha de efecto es mayor o igual que
               -- ndiaspro, se le anade un periodo m?s.
               -- Nom?s funcionava per mensuals. Cal mirar del periode que cubreix si
               -- supera el dia 15 de l'ultim mes , i que no es passi de la renovaci?
               IF (lndiaspro IS NOT NULL)
               THEN
                  IF     TO_NUMBER (TO_CHAR (v_pol.fefecto, 'dd')) >=
                                                                    lndiaspro
                     AND TO_NUMBER (TO_CHAR (lfcapro, 'mm')) =
                            TO_NUMBER (TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1),
                                                'mm'
                                               )
                                      )
                  THEN
                     -- ?s a dir , que el dia sigui > que el dia 15 de l'ultim m?s del periode
                     lfcapro := ADD_MONTHS (lfcapro, lmeses);

                     IF lfcapro > lfcanua
                     THEN
                        lfcapro := lfcanua;
                     END IF;
                  END IF;
               END IF;

               v_pasexec := 1380;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
                  IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
                  THEN
                     lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
                  ELSE
                     -- Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                     -- con duraci?n vitalicia
                     -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                     lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
                  END IF;
               -- el vencimiento del recibo ser? el vencimiento de la p?liza
               ELSE
                  lfvencim := lfcapro;
               END IF;
            END IF;

            v_pasexec := 1390;
            --Como anulamos los que hab?an pendientes, este lo creamos de nueva producion
            lctiprec := 0;
            lctipmov := 0;
            v_pasexec := 1400;

            IF f_es_renovacion (v_pol.sseguro) = 0
            THEN
               -- es cartera
               xcmodcom := 2;
            ELSE
               -- si es 1 es nueva produccion
               xcmodcom := 1;
            END IF;

            v_pasexec := 1410;

            IF f_esahorro (NULL, v_pol.sseguro, v_numerr) = 1
            THEN
               lcmovi := 2;
            ELSE
               lcmovi := 0;
            END IF;

            v_pasexec := 1420;

            IF v_numerr <> 0
            THEN
               RAISE error_proc;
            END IF;

            v_pasexec := 1430;
            pk_nueva_produccion.p_modificar_fefecto_seg (v_pol.sseguro,
                                                         v_pol.fefecto,
                                                         v_nmovimi,
                                                         'SEG'
                                                        );
            /*UPDATE movseguro
               SET fefecto = v_pol.fefecto
             WHERE sseguro = v_pol.sseguro
               AND nmovimi = v_nmovimi;

               v_pasexec := 1440;

            UPDATE garanseg
               SET finiefe = v_pol.fefecto,
                   ftarifa = v_pol.fefecto
             WHERE sseguro = v_pol.sseguro
               AND nmovimi = v_nmovimi;*/
            v_pasexec := 1450;

            UPDATE seguros
               SET fcarpro = lfcapro,
                   fcaranu = lfcanua,
                   csituac = DECODE (NVL (v_pol.ncertif, 0), 0, 0, 4),
                   creteni = DECODE (NVL (v_pol.ncertif, 0), 0, creteni, 0)
             WHERE sseguro = v_pol.sseguro;

            v_pasexec := 1460;

            SELECT DECODE (cimpres,
                           1, 0,                                  --Se imprime
                           0, 1,                               --No se imprime
                           1
                          )                                          --Tampoco
              INTO xcimpres
              FROM codimotmov
             WHERE cmotmov = 674;

            IF NVL (v_pol.ncertif, 0) = 0
            THEN
               v_pasexec := 1470;

               UPDATE movseguro
                  SET cimpres = xcimpres,
                      femisio = f_sysdate
                WHERE sseguro = v_pol.sseguro AND femisio IS NULL;
            ELSE
               v_pasexec := 1480;

               UPDATE movseguro
                  SET cimpres = xcimpres,
                      femisio = NULL
                WHERE sseguro = v_pol.sseguro
                  AND nmovimi = (SELECT MAX (nmovimi)
                                   FROM movseguro
                                  WHERE sseguro = v_pol.sseguro);
            END IF;

            v_pasexec := 1490;

            IF NVL
                  (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                   0
                  ) = 0
            THEN
               IF NVL (pac_parametros.f_parinstalacion_n ('CALCULO_RECIBO'),
                       1
                      ) = 0
               THEN
                  v_pasexec := 1500;

                  IF    (    NVL (f_parproductos_v (v_pol.sproduc,
                                                    'SEPARA_RIESGO_AHORRO'
                                                   ),
                                  0
                                 ) = 1
                         AND pac_seguros.f_tiene_garanahorro (NULL,
                                                              v_pol.sseguro,
                                                              v_pol.fefecto
                                                             ) = 1
                        )
                     OR NVL (f_parproductos_v (v_pol.sproduc,
                                               'SEPARA_RIESGO_AHORRO'
                                              ),
                             0
                            ) = 0
                  THEN
                     v_pasexec := 1510;
                     v_numerr :=
                        pac_adm.f_recries (v_pol.ctipreb,
                                           v_pol.sseguro,
                                           v_pol.cagente,
                                           f_sysdate,
                                           v_pol.fefecto,
                                           lfvencim,
                                           lctiprec,
                                           NULL,
                                           NULL,
                                           v_pol.ccobban,
                                           NULL,
                                           NULL,
                                           lctipmov,
                                           'R',
                                           xcmodcom,
                                           lfcanua,
                                           0,
                                           lcmovi,
                                           v_pol.cempres,
                                           v_nmovimi,
                                           v_pol.csituac,
                                           ximporx,
                                           NULL
                                          );
                  END IF;
               ELSE
                  v_pasexec := 1520;

                  IF    (    NVL (f_parproductos_v (v_pol.sproduc,
                                                    'SEPARA_RIESGO_AHORRO'
                                                   ),
                                  0
                                 ) = 1
                         AND pac_seguros.f_tiene_garanahorro (NULL,
                                                              v_pol.sseguro,
                                                              v_pol.fefecto
                                                             ) = 1
                        )
                     OR NVL (f_parproductos_v (v_pol.sproduc,
                                               'SEPARA_RIESGO_AHORRO'
                                              ),
                             0
                            ) = 0
                  THEN
                     v_pasexec := 1530;
                     v_numerr :=
                        f_recries (v_pol.ctipreb,
                                   v_pol.sseguro,
                                   v_pol.cagente,
                                   f_sysdate,
                                   v_pol.fefecto,
                                   lfvencim,
                                   lctiprec,
                                   NULL,
                                   NULL,
                                   v_pol.ccobban,
                                   NULL,
                                   NULL,
                                   lctipmov,
                                   'R',
                                   xcmodcom,
                                   lfcanua,
                                   0,
                                   lcmovi,
                                   NULL,
                                   v_nmovimi,
                                   v_pol.csituac,
                                   ximporx,
                                   NULL,
                                   NULL,
                                   NULL,
                                   'CAR',
                                   lcdomper
                                  );
                  END IF;
               END IF;

               IF v_numerr <> 0
               THEN
                  RAISE error_proc;
               END IF;

               v_pasexec := 1540;

               IF pac_corretaje.f_tiene_corretaje (v_pol.sseguro, v_nmovimi) =
                                                                             1
               THEN
                  v_pasexec := 1550;
                  v_numerr :=
                     pac_corretaje.f_reparto_corretaje (v_pol.sseguro,
                                                        v_nmovimi,
                                                        NULL
                                                       );
               END IF;

               IF v_numerr <> 0
               THEN
                  RAISE error_proc;
               END IF;

               v_pasexec := 1560;

               IF pac_retorno.f_tiene_retorno (NULL,
                                               v_pol.sseguro,
                                               v_nmovimi,
                                               'SEG'
                                              ) = 1
               THEN
                  v_numerr :=
                     pac_retorno.f_generar_retorno (v_pol.sseguro,
                                                    v_nmovimi,
                                                    NULL,
                                                    NULL
                                                   );
               END IF;

               IF v_numerr <> 0
               THEN
                  RAISE error_proc;
               END IF;

               v_pasexec := 1570;

               --Si todo ha ido bien, incluso la documentaci?n enviamos a SAP
               --Bug.: 20923 - 14/01/2012 - ICV
               IF NVL (pac_parametros.f_parempresa_n (v_pol.cempres,
                                                      'GESTIONA_COBPAG'
                                                     ),
                       0
                      ) = 1
               THEN
                  v_pasexec := 1580;
                  v_numerr :=
                     pac_ctrl_env_recibos.f_proc_recpag_mov (v_pol.cempres,
                                                             v_pol.sseguro,
                                                             v_nmovimi,
                                                             4,
                                                             NULL
                                                            );

                  --Si ha dado error
                  IF v_numerr <> 0
                  THEN
                     RAISE error_proc;
                  END IF;
               END IF;
            END IF;

            v_pasexec := 1590;

            IF NVL (v_pol.ncertif, 0) <> 0
            THEN
               v_pasexec := 1600;

               FOR f1 IN c_riesgos
               LOOP
                  v_pasexec := 1610;
                  v_numerr :=
                     pac_tarifas.f_tarifar_riesgo_tot
                               (NULL,
                                v_pol.sseguro,
                                f1.nriesgo,
                                v_nmovimi,
                                pac_monedas.f_moneda_producto (v_pol.sproduc),
                                v_pol.fefecto
                               );

                  IF v_numerr <> 0
                  THEN
                     vpar :=
                           'seg='
                        || psseguro
                        || ' rie='
                        || f1.nriesgo
                        || ' mov='
                        || v_nmovimi;
                     RAISE error_proc;
                  END IF;
               END LOOP;
            END IF;

            v_pasexec := 1620;

            IF     NVL (v_pol.ncertif, 0) <> 0
               AND pac_seguros.f_es_col_agrup (v_pol.sseguro, 'SEG') = 1
            THEN
               v_pasexec := 1630;
               p_emitir_propuesta
                               (v_pol.cempres,
                                v_pol.npoliza,
                                v_pol.ncertif,
                                v_pol.cramo,
                                v_pol.cmodali,
                                v_pol.ctipseg,
                                v_pol.ccolect,
                                v_pol.cactivi,
                                pac_monedas.f_moneda_producto (v_pol.sproduc),
                                pac_md_common.f_get_cxtidioma,
                                indice,
                                indice_e,
                                v_cmotret,
                                pmensaje,      -- BUG 27642 - FAL - 30/04/2014
                                NULL,
                                NULL,
                                1
                               );

               IF indice_e = 0 AND indice >= 1
               THEN
                  NULL;                                       -- emision bien
               ELSE
                  v_numerr := 151840;     -- Error en la emisi?n de la p?liza
                  vpar :=
                        'seg='
                     || psseguro
                     || ' pol='
                     || v_pol.npoliza
                     || ' cer='
                     || v_pol.ncertif
                     || ' inde='
                     || indice_e
                     || ' ind='
                     || indice;
                  RAISE error_proc;
               END IF;
            END IF;
         END LOOP;

         v_pasexec := 1640;
         RETURN 0;
      EXCEPTION
         WHEN error_proc
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         vobj,
                         v_pasexec,
                         'Error: ' || v_numerr || ' ' || vpar,
                         f_axis_literales (v_numerr, f_usu_idioma)
                        );
            RETURN v_numerr;
         WHEN OTHERS
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         vobj,
                         v_pasexec,
                         'Error no controlado ' || vpar,
                         v_numerr || ' ' || SQLERRM
                        );
            RETURN 108592;
      END f_accion_traslado_vigencia;

      FUNCTION f_accion_traslado (
         p_seg           IN   NUMBER,
         p_trasladovig   IN   DATE DEFAULT NULL
      )
         RETURN NUMBER
      IS
         CURSOR c_riesgos
         IS
            SELECT nriesgo
              FROM riesgos
             WHERE sseguro = p_seg AND fanulac IS NULL;
      BEGIN
         v_pasexec := 1000;

         FOR v_pol IN (SELECT *
                         FROM seguros
                        WHERE sseguro = p_seg)
         LOOP
            v_pasexec := 1010;

            SELECT MAX (nmovimi), MAX (fefecto), MAX (lcdomper)
              INTO v_nmovimi, v_fsuplem, lcdomper
              FROM movseguro
             WHERE sseguro = v_pol.sseguro;

            SELECT MAX (nmovimi)
              INTO v_nmovimi
              FROM garanseg
             WHERE sseguro = v_pol.sseguro AND ffinefe IS NULL;

            vpar :=
                  's='
               || v_pol.sseguro
               || ' m='
               || v_nmovimi
               || ' s='
               || v_fsuplem
               || ' t='
               || p_trasladovig;
            -- Si la actual fecha certificado es menor fecha traslado, la actualizamos
            v_pasexec := 1020;

            IF NVL (v_pol.ncertif, 0) <> 0 AND p_trasladovig IS NOT NULL
            THEN
               --Bug 29665/168265 - 03/03/2014 - AMC
               --   IF v_pol.fefecto < p_trasladovig THEN
               SELECT fefecto, fcarpro, fcaranu,
                      nrenova, fcaranu /*frenova*/, v_pol.fefecto
                 INTO v_pol.fefecto, v_pol.fcarpro, v_pol.fcaranu,
                      v_pol.nrenova, v_pol.frenova, v_pol.fcancel
                 FROM seguros
                WHERE npoliza = v_pol.npoliza AND ncertif = 0;

               UPDATE seguros
                  SET fcarpro = v_pol.fcarpro,
                      fcaranu = v_pol.fcaranu,
                      nrenova = v_pol.nrenova,
                      frenova = v_pol.frenova,
                      fefecto = v_pol.fefecto
                WHERE sseguro = v_pol.sseguro;

               UPDATE riesgos
                  SET fefecto = v_pol.fefecto
                WHERE sseguro = v_pol.sseguro;

               UPDATE asegurados
                  SET ffecini = v_pol.fefecto
                WHERE sseguro = v_pol.sseguro;

               UPDATE seguredcom
                  SET fefecto = v_pol.fefecto,
                      fanulac = v_pol.fefecto,
                      fmovini = v_pol.fefecto
                WHERE sseguro = v_pol.sseguro;
            /*ELSE
            UPDATE seguros
               SET fcarpro = v_pol.fcarpro,
                   fcaranu = v_pol.fcaranu,
                   nrenova = v_pol.nrenova,
                   frenova = v_pol.frenova
             WHERE sseguro = v_pol.sseguro;*/
            --  END IF;
            -- Fi Bug 29665/168265 - 03/03/2014 - AMC
            END IF;

            -- Recorremos los recibos pendientes de cobro y los anulamos
            v_pasexec := 1030;

            SELECT crevfpg, ndiaspro, cprprod, ctipefe
              INTO lcrevfpg, lndiaspro, lcprprod, lctipefe
              FROM productos
             WHERE cramo = v_pol.cramo
               AND cmodali = v_pol.cmodali
               AND ctipseg = v_pol.ctipseg
               AND ccolect = v_pol.ccolect;

            v_pasexec := 1110;

            --Forma de pago no ?nica o forma de pago ?nica con renovaci?n,
            IF     (v_pol.cforpag <> 0
                    OR (v_pol.cforpag = 0 AND lcrevfpg = 1)
                   )
               AND v_pol.csituac = 0
            THEN
               --
               v_pasexec := 1120;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  lcforpag := 1;
               -- que calcule las fechas como si fuera pago anual
               ELSE
                  lcforpag := v_pol.cforpag;
               END IF;

               v_pasexec := 1130;
               -- Calcul de la data de renovaci?
               lmeses := 12 / lcforpag;
               v_pasexec := 1140;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  dd := TO_CHAR (v_pol.frenova, 'dd');
                  -- SUBSTR(LPAD(v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := TO_CHAR (v_pol.frenova, 'ddmm');
               -- dd || SUBSTR(LPAD(v_pol.nrenova, 4, 0), 1, 2);
               ELSE
                  -- Fin bug 23117
                  dd := SUBSTR (LPAD (v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := dd || SUBSTR (LPAD (v_pol.nrenova, 4, 0), 1, 2);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               v_pasexec := 1150;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
               ELSE
                  v_pasexec := 1160;

                  -- Fin bug 23117
                  IF    TO_CHAR (v_pol.fefecto, 'DDMM') = ddmm
                     OR LPAD (v_pol.nrenova, 4, 0) IS NULL
                  THEN
                     v_pasexec := 1170;
                     lfcanua := f_summeses (v_pol.fefecto, 12, dd);
                  ELSE
                     v_pasexec := 1180;

                     IF lctipefe = 2
                     THEN
                        -- a d?a 1/mes por exceso
                        fecha_aux := ADD_MONTHS (v_pol.fefecto, 13);
                        lfcanua :=
                           TO_DATE (ddmm || TO_CHAR (fecha_aux, 'YYYY'),
                                    'DDMMYYYY'
                                   );
                     ELSE
                        BEGIN
                           lfcanua :=
                              TO_DATE (ddmm || TO_CHAR (v_pol.fefecto, 'YYYY'),
                                       'DDMMYYYY'
                                      );
                        EXCEPTION
                           WHEN OTHERS
                           THEN
                              IF ddmm = 2902
                              THEN
                                 ddmm := 2802;
                                 lfcanua :=
                                    TO_DATE (   ddmm
                                             || TO_CHAR (v_pol.fefecto,
                                                         'YYYY'),
                                             'DDMMYYYY'
                                            );
                              ELSE
                                 --Fecha de renovaci?n (mmdd) incorrecta
                                 v_numerr := 104510;
                                 vpar :=
                                       'seg='
                                    || psseguro
                                    || ' ddmm='
                                    || ddmm
                                    || ' efe='
                                    || v_pol.fefecto;
                                 RAISE error_proc;
                              END IF;
                        END;
                     END IF;

                     v_pasexec := 1190;

                     IF lfcanua <= v_pol.fefecto
                     THEN
                        lfcanua := f_summeses (lfcanua, 12, dd);
                     END IF;
                  END IF;
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               -- Fin bug 23117
               v_pasexec := 1200;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
               THEN
                  lfcapro := v_pol.frenova;
               ELSE
                  v_pasexec := 1210;

                  -- Se calcula la pr?x. cartera partiendo de la cartera de renovaci?n (fcaranu)
                  -- y rest?ndole periodos de pago
                  -- Calculem la data de propera cartera
                  IF     lctipefe = 2
                     AND TO_CHAR (v_pol.fefecto, 'dd') <> 1
                     AND lcforpag <> 12
                  THEN
                     l_fefecto_1 :=
                           '01/'
                        || TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1), 'mm/yyyy');
                  ELSE
                     l_fefecto_1 := v_pol.fefecto;
                  END IF;

                  lfaux := lfcanua;
                  v_pasexec := 1220;

                  WHILE TRUE
                  LOOP
                     lfaux := f_summeses (lfaux, -lmeses, dd);

                     IF lfaux <= l_fefecto_1
                     THEN
                        lfcapro := f_summeses (lfaux, lmeses, dd);
                        EXIT;
                     END IF;
                  END LOOP;
               END IF;

               v_pasexec := 1230;

               -- Si el d?a de la fecha de efecto es mayor o igual que
               -- ndiaspro, se le anade un periodo m?s.
               -- Nom?s funcionava per mensuals. Cal mirar del periode que cubreix si
               -- supera el dia 15 de l'ultim mes , i que no es passi de la renovaci?
               IF (lndiaspro IS NOT NULL)
               THEN
                  IF     TO_NUMBER (TO_CHAR (v_pol.fefecto, 'dd')) >=
                                                                    lndiaspro
                     AND TO_NUMBER (TO_CHAR (lfcapro, 'mm')) =
                            TO_NUMBER (TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1),
                                                'mm'
                                               )
                                      )
                  THEN
                     -- ?s a dir , que el dia sigui > que el dia 15 de l'ultim m?s del periode
                     lfcapro := ADD_MONTHS (lfcapro, lmeses);

                     IF lfcapro > lfcanua
                     THEN
                        lfcapro := lfcanua;
                     END IF;
                  END IF;
               END IF;

               v_pasexec := 1240;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
                  IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
                  THEN
                     lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
                  ELSE
                     -- Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                     -- con duraci?n vitalicia
                     -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                     lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
                  END IF;
               -- el vencimiento del recibo ser? el vencimiento de la p?liza
               ELSE
                  lfvencim := lfcapro;
               END IF;
            ELSIF v_pol.cforpag = 0 AND lcrevfpg = 0
            THEN
               --Forma de pago ?nica y nueva producci?n ? suplemento
               v_pasexec := 1250;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
                  lfcapro := v_pol.frenova;
                  lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
               ELSE
                  -- Fin bug 23117
                  lfcanua := v_pol.fcaranu;
                  lfcapro := v_pol.fcarpro;
                  --Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                  -- con duraci?n vitalicia
                  -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                  lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;
            -- Fin bug 23117
            ELSE
               -- Si es un suplemento
               v_pasexec := 1260;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  lcforpag := 1;
               -- que calcule las fechas como si fuera pago anual
               ELSE
                  lcforpag := v_pol.cforpag;
               END IF;

               v_pasexec := 1270;
               -- Calcul de la data de renovaci?
               lmeses := 12 / lcforpag;
               v_pasexec := 1280;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  dd := TO_CHAR (v_pol.frenova, 'dd');
                  -- SUBSTR(LPAD(v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := TO_CHAR (v_pol.frenova, 'ddmm');
               -- dd || SUBSTR(LPAD(v_pol.nrenova, 4, 0), 1, 2);
               ELSE
                  -- Fin bug 23117
                  dd := SUBSTR (LPAD (v_pol.nrenova, 4, 0), 3, 2);
                  ddmm := dd || SUBSTR (LPAD (v_pol.nrenova, 4, 0), 1, 2);
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               v_pasexec := 1290;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL
               THEN
                  lfcanua := v_pol.frenova;
               ELSE
                  v_pasexec := 1300;

                  -- Fin bug 23117
                  IF    TO_CHAR (v_pol.fefecto, 'DDMM') = ddmm
                     OR LPAD (v_pol.nrenova, 4, 0) IS NULL
                  THEN
                     v_pasexec := 1310;
                     lfcanua := f_summeses (v_pol.fefecto, 12, dd);
                  ELSE
                     v_pasexec := 1320;

                     IF lctipefe = 2
                     THEN
                        -- a d?a 1/mes por exceso
                        fecha_aux := ADD_MONTHS (v_pol.fefecto, 13);
                        lfcanua :=
                           TO_DATE (ddmm || TO_CHAR (fecha_aux, 'YYYY'),
                                    'DDMMYYYY'
                                   );
                     ELSE
                        BEGIN
                           lfcanua :=
                              TO_DATE (ddmm || TO_CHAR (v_pol.fefecto, 'YYYY'),
                                       'DDMMYYYY'
                                      );
                        EXCEPTION
                           WHEN OTHERS
                           THEN
                              IF ddmm = 2902
                              THEN
                                 ddmm := 2802;
                                 lfcanua :=
                                    TO_DATE (   ddmm
                                             || TO_CHAR (v_pol.fefecto,
                                                         'YYYY'),
                                             'DDMMYYYY'
                                            );
                              ELSE
                                 --Fecha de renovaci?n (mmdd) incorrecta
                                 v_numerr := 104510;
                                 vpar :=
                                       'seg='
                                    || psseguro
                                    || ' ddmm='
                                    || ddmm
                                    || ' efe='
                                    || v_pol.fefecto;
                                 RAISE error_proc;
                              END IF;
                        END;
                     END IF;

                     v_pasexec := 1330;

                     IF lfcanua <= v_pol.fefecto
                     THEN
                        lfcanua := f_summeses (lfcanua, 12, dd);
                     END IF;
                  END IF;
               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               END IF;

               -- Fin bug 23117
               v_pasexec := 1340;

               -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
               IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
               THEN
                  lfcapro := v_pol.frenova;
               ELSE
                  v_pasexec := 1350;

                  -- Se calcula la pr?x. cartera partiendo de la cartera de renovaci?n (fcaranu)
                  -- y rest?ndole periodos de pago
                  -- Calculem la data de propera cartera
                  IF     lctipefe = 2
                     AND TO_CHAR (v_pol.fefecto, 'dd') <> 1
                     AND lcforpag <> 12
                  THEN
                     l_fefecto_1 :=
                           '01/'
                        || TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1), 'mm/yyyy');
                  ELSE
                     l_fefecto_1 := v_pol.fefecto;
                  END IF;

                  lfaux := lfcanua;
                  v_pasexec := 1360;

                  WHILE TRUE
                  LOOP
                     lfaux := f_summeses (lfaux, -lmeses, dd);

                     IF lfaux <= l_fefecto_1
                     THEN
                        lfcapro := f_summeses (lfaux, lmeses, dd);
                        EXIT;
                     END IF;
                  END LOOP;
               END IF;

               v_pasexec := 1370;

               -- Si el d?a de la fecha de efecto es mayor o igual que
               -- ndiaspro, se le anade un periodo m?s.
               -- Nom?s funcionava per mensuals. Cal mirar del periode que cubreix si
               -- supera el dia 15 de l'ultim mes , i que no es passi de la renovaci?
               IF (lndiaspro IS NOT NULL)
               THEN
                  IF     TO_NUMBER (TO_CHAR (v_pol.fefecto, 'dd')) >=
                                                                    lndiaspro
                     AND TO_NUMBER (TO_CHAR (lfcapro, 'mm')) =
                            TO_NUMBER (TO_CHAR (ADD_MONTHS (v_pol.fefecto, 1),
                                                'mm'
                                               )
                                      )
                  THEN
                     -- ?s a dir , que el dia sigui > que el dia 15 de l'ultim m?s del periode
                     lfcapro := ADD_MONTHS (lfcapro, lmeses);

                     IF lfcapro > lfcanua
                     THEN
                        lfcapro := lfcanua;
                     END IF;
                  END IF;
               END IF;

               v_pasexec := 1380;

               IF v_pol.cforpag = 0 AND lcrevfpg = 1
               THEN
                  -- Bug 23117 - RSC - 31/07/2012 -  LCOL_T010-LCOL - POLIZAS RENOVABLES Y VIGENCIA DIFERENTE A UN A?O
                  IF v_pol.frenova IS NOT NULL AND lcforpag IN (0, 1)
                  THEN
                     lfvencim := NVL (v_pol.frenova, v_pol.fefecto + 1);
                  ELSE
                     -- Alberto - JAMR 03/2004 - Anado el NVL con lfefecto para la forma de pago ?nica
                     -- con duraci?n vitalicia
                     -- y as? la fecha de vencimiento es la de efecto mas un d?a.
                     lfvencim := NVL (v_pol.fvencim, v_pol.fefecto + 1);
                  END IF;
               -- el vencimiento del recibo ser? el vencimiento de la p?liza
               ELSE
                  lfvencim := lfcapro;
               END IF;
            END IF;

            v_pasexec := 1390;
            --Como anulamos los que hab?an pendientes, este lo creamos de nueva producion
            lctiprec := 0;
            lctipmov := 0;
            v_pasexec := 1400;

            IF f_es_renovacion (v_pol.sseguro) = 0
            THEN
               -- es cartera
               xcmodcom := 2;
            ELSE
               -- si es 1 es nueva produccion
               xcmodcom := 1;
            END IF;

            v_pasexec := 1410;

            IF f_esahorro (NULL, v_pol.sseguro, v_numerr) = 1
            THEN
               lcmovi := 2;
            ELSE
               lcmovi := 0;
            END IF;

            v_pasexec := 1430;
            --IF v_pol.fefecto < p_trasladovig THEN
            pk_nueva_produccion.p_modificar_fefecto_seg (v_pol.sseguro,
                                                         v_pol.fefecto,
                                                         v_nmovimi,
                                                         'SEG'
                                                        );
            v_pasexec := 1450;

            UPDATE seguros
               SET fcarpro = lfcapro,
                   fcaranu = lfcanua,
                   csituac = DECODE (NVL (v_pol.ncertif, 0), 0, 0, 4),
                   creteni = DECODE (NVL (v_pol.ncertif, 0), 0, creteni, 0)
             WHERE sseguro = v_pol.sseguro;

            /*ELSE
                UPDATE seguros
                   SET fcarpro = lfcapro,
                       csituac = DECODE(NVL(v_pol.ncertif, 0), 0, 0, 4),
                       creteni = DECODE(NVL(v_pol.ncertif, 0), 0, creteni, 0)
                 WHERE sseguro = v_pol.sseguro;
            END IF;*/
            v_pasexec := 1460;

            SELECT DECODE (cimpres,
                           1, 0,                                  --Se imprime
                           0, 1,                               --No se imprime
                           1
                          )                                          --Tampoco
              INTO xcimpres
              FROM codimotmov
             WHERE cmotmov = 674;

            IF NVL (v_pol.ncertif, 0) = 0
            THEN
               v_pasexec := 1470;

               UPDATE movseguro
                  SET cimpres = xcimpres,
                      femisio = f_sysdate
                WHERE sseguro = v_pol.sseguro AND femisio IS NULL;
            ELSE
               v_pasexec := 1480;

               UPDATE movseguro
                  SET cimpres = xcimpres,
                      femisio = NULL
                WHERE sseguro = v_pol.sseguro
                  AND nmovimi = (SELECT MAX (nmovimi)
                                   FROM movseguro
                                  WHERE sseguro = v_pol.sseguro);
            END IF;

            v_pasexec := 1490;

            IF NVL (v_pol.ncertif, 0) <> 0
            THEN
               v_pasexec := 1600;

               FOR f1 IN c_riesgos
               LOOP
                  v_pasexec := 1610;
                  v_numerr :=
                     pac_tarifas.f_tarifar_riesgo_tot
                               (NULL,
                                v_pol.sseguro,
                                f1.nriesgo,
                                v_nmovimi,
                                pac_monedas.f_moneda_producto (v_pol.sproduc),
                                v_pol.fefecto
                               );

                  IF v_numerr <> 0
                  THEN
                     vpar :=
                           'seg='
                        || psseguro
                        || ' rie='
                        || f1.nriesgo
                        || ' mov='
                        || v_nmovimi;
                     RAISE error_proc;
                  END IF;
               END LOOP;
            END IF;
         END LOOP;

         v_pasexec := 1640;
         RETURN 0;
      EXCEPTION
         WHEN error_proc
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         vobj,
                         v_pasexec,
                         'Error: ' || v_numerr || ' ' || vpar,
                         f_axis_literales (v_numerr, f_usu_idioma)
                        );
            RETURN v_numerr;
         WHEN OTHERS
         THEN
            p_tab_error (f_sysdate,
                         f_user,
                         vobj,
                         v_pasexec,
                         'Error no controlado ' || vpar,
                         v_numerr || ' ' || SQLERRM
                        );
            RETURN 108592;
      END f_accion_traslado;

      FUNCTION f_emitir_col_admin (
         psseguro   IN       NUMBER,
         mensajes   OUT      t_iax_mensajes
      )
         RETURN NUMBER
      IS
         vobjectname       VARCHAR2 (100)
                                   := 'PAC_IAX_PRODUCCION.f_emitir_col_admin';
         vparam            VARCHAR2 (2000)
                                      := 'parmetros - psseguro: ' || psseguro;
         vnumerr           NUMBER;
         vpasexec          NUMBER                      := 0;
         vsproces          NUMBER;
         vcestadocol       movseguro.cestadocol%TYPE;
         -- Bug 24278 - APD - 05/12/2012
         vnmovimi          NUMBER;
         e_error           EXCEPTION;
         vcontinuaemitir   NUMBER;
      BEGIN
         vpasexec := 501;

         IF psseguro IS NULL
         THEN
            RAISE e_error;
         END IF;

         vpasexec := 502;

         IF     pac_seguros.f_get_escertifcero (NULL, psseguro) = 1
            AND pac_seguros.f_es_col_admin (psseguro, 'SEG') = 1
         THEN
            vcestadocol := pac_movseguro.f_get_cestadocol (psseguro);
         END IF;

         vpasexec := 503;

         IF NVL (vcestadocol, 0) = 2
         THEN
            RAISE e_error;
         END IF;

         vpasexec := 504;
         vsproces := NULL;
         vnumerr :=
            pac_md_produccion.f_emitir_col_admin (psseguro,
                                                  vsproces,
                                                  vcontinuaemitir,
                                                  mensajes,
                                                  1,
                                                  0,
                                                  0
                                                 );

         IF vnumerr <> 0
         THEN
            RAISE e_error;
         END IF;

         vpasexec := 505;

         IF vcontinuaemitir <> 1
         THEN
            IF     pac_seguros.f_get_escertifcero (NULL, psseguro) = 1
               AND pac_seguros.f_es_col_admin (psseguro, 'SEG') = 1
            THEN
               vcestadocol := pac_movseguro.f_get_cestadocol (psseguro);

               IF NVL (vcestadocol, 0) = 0
               THEN
                  vnumerr := pac_movseguro.f_set_cestadocol (psseguro, 1);

                  IF vnumerr <> 0
                  THEN
                     RAISE e_error;
                  END IF;
               END IF;
            END IF;

            vpasexec := 506;
            mensajes := NULL;
         END IF;

         COMMIT;
         pac_seguros.p_modificar_seguro (psseguro, 0);

         IF vcontinuaemitir <> 1
         THEN
            IF vnumerr = 0
            THEN
               vnumerr :=
                  pac_md_bpm.f_lanzar_proceso (psseguro,
                                               1,
                                               NULL,
                                               '*',
                                               'EMITIDA',
                                               mensajes
                                              );
            END IF;

            IF vnumerr <> 0
            THEN
               NULL;
            END IF;
         END IF;

         RETURN 0;
      EXCEPTION
         WHEN e_error
         THEN
            ROLLBACK;

            DECLARE
               v_creteni   NUMBER;
            BEGIN
               SELECT creteni
                 INTO v_creteni
                 FROM seguros
                WHERE sseguro = psseguro;

               IF v_creteni <> 2
               THEN
                  pac_seguros.p_modificar_seguro (psseguro, 0);
               END IF;
            END;

            RETURN 1000006;
      END f_emitir_col_admin;
   BEGIN
      v_pasexec := 1;

      FOR v_pol IN (SELECT *
                      FROM seguros
                     WHERE sseguro = psseguro)
      LOOP
         v_fefecto_tra := v_pol.fefecto;
         v_cduraci_tra := v_pol.cduraci;
         v_frenova_tra := v_pol.frenova;

         IF     NVL (f_parproductos_v (v_pol.sproduc, 'ADMITE_CERTIFICADOS'),
                     0
                    ) = 1
            AND pac_seguros.f_get_escertifcero (NULL, v_pol.sseguro) = 1
         THEN
            -- Emitimos el movimiento de traslado en el certificado 0
            SELECT COUNT (*)
              INTO v_cont_certifs
              FROM seguros
             WHERE npoliza = (SELECT npoliza
                                FROM seguros
                               WHERE sseguro = v_pol.sseguro) AND ncertif > 0;

            IF v_cont_certifs > 0
            THEN
               -- Destrasladamos
               SELECT fefecto, cduraci, frenova
                 INTO v_fefecto2, v_cduraci, v_frenova
                 FROM historicoseguros
                WHERE sseguro = v_pol.sseguro
                  AND nmovimi =
                         (SELECT MAX (nmovimi)
                            FROM historicoseguros
                           WHERE sseguro = v_pol.sseguro
                             AND nmovimi <=
                                      (SELECT nmovimi
                                         FROM movseguro
                                        WHERE sseguro = v_pol.sseguro
                                          AND femisio IS NULL)
                                    - 1);

               UPDATE seguros
                  SET csituac = 0,
                      fefecto = v_fefecto2,
                      cduraci = v_cduraci,
                      frenova = v_frenova,
                      nrenova = TO_CHAR (v_frenova, 'MMDD')
                --Bug 29665/168265 - 04/03/2014 - AMC
               WHERE  sseguro = v_pol.sseguro;

               UPDATE movseguro
                  SET femisio = f_sysdate
                WHERE sseguro = v_pol.sseguro AND femisio IS NULL;

               --Bug 29665/168265 - 03/03/2014 - AMC
               UPDATE seguredcom
                  SET fefecto = v_fefecto2,
                      fanulac = v_fefecto2,
                      fmovini = v_fefecto2
                WHERE sseguro = v_pol.sseguro;

               --Fi Bug 29665/168265 - 03/03/2014 - AMC

               -- Fi destrasladamos
               v_pasexec := 2;
               v_numerr :=
                  pac_iax_anulaciones.f_anulacion (v_pol.sseguro,
                                                   1,
                                                   v_fefecto2,
                                                   334,
                                                   NULL,
                                                   1,
                                                   1,
                                                   NULL,
                                                   0,
                                                   mensajes,
                                                   0,
                                                   0,
                                                   1
                                                  );

               IF v_numerr <> 0
               THEN
                  v_pasexec := 3;
                  RAISE error_proc;
               END IF;

               SELECT MAX (nmovimi)
                 INTO vnmovimi_anu
                 FROM movseguro
                WHERE sseguro = v_pol.sseguro;

               UPDATE movseguro
                  SET cmotmov = 397
                WHERE sseguro = v_pol.sseguro AND nmovimi = vnmovimi_anu;

               v_pasexec := 4;
               v_numerr :=
                  pac_rehabilita.f_rehabilita (v_pol.sseguro,
                                               721,
                                               v_pol.cagente,
                                               v_nmovimi_reh
                                              );
               v_nmovimi_rehcero := v_nmovimi_reh;

               IF v_numerr <> 0
               THEN
                  v_pasexec := 5;
                  RAISE error_proc;
               END IF;

               -- Trasladamos el certificado 0
               pac_alctr126.traspaso_tablas_seguros (v_pol.sseguro, v_mens);

               -- Bug 27539/148894 - APD - 12/07/2013 - se busca sseguro de las
               -- tablas EST que se acaba de generar
               SELECT MAX (sseguro)
                 INTO v_sseguro_est
                 FROM estseguros
                WHERE ssegpol = v_pol.sseguro;

               -- fin Bug 27539/148894 - APD - 12/07/2013
               v_pasexec := 6;
               v_numerr :=
                  f_movseguro (v_pol.sseguro,
                               NULL,
                               674,
                               1,
                               v_fefecto2,
                               NULL,
                               NULL,
                               0,
                               NULL,
                               v_nmovimi_tr,
                               f_sysdate,
                               NULL
                              );

               IF v_numerr <> 0
               THEN
                  v_pasexec := 7;
                  RAISE error_proc;
               END IF;

               v_pasexec := 8;
               pac_alctr126.traspaso_tablas_est (v_sseguro_est,
                                                 v_fefecto2,
                                                 NULL,
                                                 v_mens,
                                                 'ALCTR126',
                                                 NULL,
                                                 v_nmovimi_tr,
                                                 NULL,
                                                 1
                                                );
               v_pasexec := 9;
               pac_alctr126.borrar_tablas_est (v_sseguro_est);
               v_pasexec := 10;

               UPDATE garanseg
                  SET ffinefe = v_fefecto2
                WHERE sseguro = v_pol.sseguro
                  AND ffinefe IS NULL
                  AND nmovimi =
                         (SELECT MAX (nmovimi)
                            FROM garanseg
                           WHERE sseguro = v_pol.sseguro
                             AND ffinefe IS NULL
                             AND nmovimi < v_nmovimi_tr);

               UPDATE clausuesp
                  SET ffinclau = v_fefecto2
                WHERE sseguro = v_pol.sseguro
                  AND ffinclau IS NULL
                  AND nmovimi =
                         (SELECT MAX (nmovimi)
                            FROM clausuesp
                           WHERE sseguro = v_pol.sseguro
                             AND ffinclau IS NULL
                             AND nmovimi < v_nmovimi_tr);

               v_pasexec := 11;

               UPDATE seguros
                  SET csituac = 5,
                      fefecto = v_fefecto_tra,
                      cduraci = v_cduraci_tra,
                      frenova = v_frenova_tra,
                      nrenova = TO_CHAR (v_frenova_tra, 'MMDD')
                --Bug 29665/168265 - 04/03/2014 - AMC
               WHERE  sseguro = v_pol.sseguro;

               v_pasexec := 12;

               UPDATE movseguro
                  SET femisio = NULL
                WHERE sseguro = v_pol.sseguro AND nmovimi = v_nmovimi_tr;

               --Bug 29665/168265 - 03/03/2014 - AMC
               UPDATE seguredcom
                  SET fefecto = v_fefecto_tra,
                      fanulac = v_fefecto_tra,
                      fmovini = v_fefecto_tra
                WHERE sseguro = v_pol.sseguro;

               --Fi Bug 29665/168265 - 03/03/2014 - AMC
               v_pasexec := 13;
               v_numerr := f_accion_traslado (v_pol.sseguro, NULL);

               IF v_numerr <> 0
               THEN
                  v_pasexec := 14;
                  RAISE error_proc;
               END IF;

               -- Actualizamos los recibos generados por la anulaci?n y los colgamos del nuevo movimiento de traslado
               v_pasexec := 15;

               -- Esto no lo hacemos, finalmente ya que si colgamos un recibo de anulaci?n
               -- del movimiento de traslado la contabilidad no sabr? determinar si ese recibo
               -- es de anulaci?n o no y de que tipo de anulaci?n se trata.
               UPDATE recibos
                  SET nmovimi = v_nmovimi_tr
                WHERE sseguro = v_pol.sseguro AND nmovimi = vnmovimi_anu;

               -- Fi Trasladamos el certificado 0
               v_pasexec := 16;

               -- Certificados anulados
               FOR regs IN (SELECT *
                              FROM detmovsegurocol
                             WHERE sseguro_0 = v_pol.sseguro
                               AND nmovimi_0 = vnmovimi_anu - 1)
               LOOP
                  v_pasexec := 17;
                  -- Finalizamos el movimiento vigente del contrato
                  v_numerr :=
                     pac_rehabilita.f_rehabilita (regs.sseguro_cert,
                                                  721,
                                                  v_pol.cagente,
                                                  v_nmovimi_reh
                                                 );

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 18;
                     RAISE error_proc;
                  END IF;

                  v_pasexec := 19;
                  pac_alctr126.traspaso_tablas_seguros (regs.sseguro_cert,
                                                        v_mens
                                                       );
                  v_pasexec := 20;

                  -- Bug 27539/148894 - APD - 12/07/2013 - se busca sseguro de las
                  -- tablas EST que se acaba de generar
                  SELECT MAX (sseguro)
                    INTO v_sseguro_est
                    FROM estseguros
                   WHERE ssegpol = regs.sseguro_cert;

                  -- fin Bug 27539/148894 - APD - 12/07/2013

                  --SELECT fefecto
                  --  INTO v_fefecto_est
                  --  FROM seguros
                  -- WHERE sseguro = regs.sseguro_cert;
                  v_numerr :=
                     f_movseguro (regs.sseguro_cert,
                                  NULL,
                                  674,
                                  1,
                                  v_fefecto2,
                                  NULL,
                                  NULL,
                                  0,
                                  NULL,
                                  v_nmovimi_tr,
                                  f_sysdate,
                                  NULL
                                 );

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 22;
                     RAISE error_proc;
                  END IF;

                  v_pasexec := 23;
                  pac_alctr126.traspaso_tablas_est (v_sseguro_est,
                                                    v_fefecto2,
                                                    NULL,
                                                    v_mens,
                                                    'ALCTR126',
                                                    NULL,
                                                    v_nmovimi_tr,
                                                    NULL,
                                                    1
                                                   );
                  v_pasexec := 24;
                  pac_alctr126.borrar_tablas_est (v_sseguro_est);
                  v_pasexec := 25;

                  UPDATE seguros
                     SET csituac = 4
                   WHERE sseguro = regs.sseguro_cert;

                  v_pasexec := 26;

                  UPDATE movseguro
                     SET femisio = NULL,
                         cmotmov = 100,
                         cmovseg = 0
                   WHERE sseguro = regs.sseguro_cert
                         AND nmovimi = v_nmovimi_tr;

                  v_pasexec := 27;

                  --IF v_fefecto_est < v_fefecto_tra THEN
                  UPDATE garanseg
                     SET ffinefe = v_fefecto2                     --v_fefecto2
                   WHERE sseguro = regs.sseguro_cert
                     AND ffinefe IS NULL
                     AND nmovimi =
                            (SELECT MAX (nmovimi)
                               FROM garanseg
                              WHERE sseguro = regs.sseguro_cert
                                AND ffinefe IS NULL
                                AND nmovimi < v_nmovimi_tr);

                  --END IF;
                  UPDATE clausuesp
                     SET ffinclau = v_fefecto2
                   WHERE sseguro = regs.sseguro_cert
                     AND ffinclau IS NULL
                     AND nmovimi =
                            (SELECT MAX (nmovimi)
                               FROM clausuesp
                              WHERE sseguro = regs.sseguro_cert
                                AND ffinclau IS NULL
                                AND nmovimi < v_nmovimi_tr);

                  v_pasexec := 28;
                  v_numerr :=
                          f_accion_traslado (regs.sseguro_cert, v_fefecto_tra);

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 29;
                     RAISE error_proc;
                  END IF;
               END LOOP;

               IF     v_pol.ncertif = 0
                  AND pac_seguros.f_es_col_admin (v_pol.sseguro, 'SEG') = 1
               THEN
                  v_pasexec := 30;
                  v_numerr :=
                     pac_md_produccion.f_abrir_suplemento (v_pol.sseguro,
                                                           mensajes
                                                          );

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 31;
                     RAISE error_proc;
                  END IF;

                  v_pasexec := 32;
                  pac_iax_produccion.vsseguro := NULL;
                  --                  v_numerr := pac_iax_produccion.f_emitir_col_admin(v_pol.sseguro, v_emitir,
                  --                                                                    mensajes, 1, 0);
                  v_numerr := f_emitir_col_admin (v_pol.sseguro, mensajes);

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 33;
                     RAISE error_proc;
                  END IF;
               END IF;

               v_pasexec := 34;

               FOR regs IN (SELECT *
                              FROM detmovsegurocol
                             WHERE sseguro_0 = v_pol.sseguro
                               AND nmovimi_0 = vnmovimi_anu - 1)
               LOOP
                  v_pasexec := 35;

                  SELECT MAX (nmovimi)
                    INTO v_maxnmovim_cert
                    FROM movseguro
                   WHERE sseguro = regs.sseguro_cert;

                  v_pasexec := 36;

                  UPDATE movseguro
                     SET cmotmov = 674,
                         cmovseg = 1
                   WHERE sseguro = regs.sseguro_cert
                     AND nmovimi = v_maxnmovim_cert;

                  UPDATE recibos
                     SET nmovimi = v_maxnmovim_cert
                   WHERE sseguro = regs.sseguro_cert
                     AND nmovimi = regs.nmovimi_cert;

                  pac_alctr126.borrar_movimiento (regs.sseguro_cert,
                                                  regs.nmovimi_cert,
                                                  1
                                                 );         -- El de anulaci?n
                  pac_alctr126.borrar_movimiento (regs.sseguro_cert,
                                                  regs.nmovimi_cert + 1,
                                                  1
                                                 );    -- El de rehabilitaci?n
               END LOOP;

               -- Esto no lo hacemos, finalmente ya que si colgamos un recibo de anulaci?n
               -- del movimiento de traslado la contabilidad no sabr? determinar si ese recibo
               -- es de anulaci?n o no y de que tipo de anulaci?n se trata.
               pac_alctr126.borrar_movimiento (v_pol.sseguro,
                                               vnmovimi_anu - 2,
                                               1
                                              );           -- Traslado inicial
               pac_alctr126.borrar_movimiento (v_pol.sseguro,
                                               vnmovimi_anu - 1,
                                               1
                                              );
               -- Anulaci?n movimiento inicial
               pac_alctr126.borrar_movimiento (v_pol.sseguro, vnmovimi_anu, 1);
               -- Anulaci?n por traslado
               pac_alctr126.borrar_movimiento (v_pol.sseguro,
                                               v_nmovimi_rehcero,
                                               1
                                              );             -- Rehabilitaci?n

               UPDATE detmovsegurocol
                  SET nmovimi_0 = v_nmovimi_tr
                WHERE sseguro_0 = v_pol.sseguro
                  AND nmovimi_0 = vnmovimi_anu - 1;
            ELSE
               --La caratula no tiene certificados, se simplifica m?s el proceso
               v_pasexec := 111;

               UPDATE seguros
                  SET csituac = 5,
                      fefecto = v_fefecto_tra,
                      cduraci = v_cduraci_tra,
                      frenova = v_frenova_tra
                WHERE sseguro = v_pol.sseguro;

               v_pasexec := 121;

               UPDATE movseguro
                  SET femisio = NULL
                WHERE sseguro = v_pol.sseguro AND nmovimi = v_nmovimi_tr;

               v_pasexec := 122;
               v_numerr := f_accion_traslado (v_pol.sseguro, v_fefecto_tra);

               IF v_numerr <> 0
               THEN
                  v_pasexec := 129;
                  RAISE error_proc;
               END IF;

               IF     v_pol.ncertif = 0
                  AND pac_seguros.f_es_col_admin (v_pol.sseguro, 'SEG') = 1
               THEN
                  v_pasexec := 130;
                  v_numerr :=
                     pac_md_produccion.f_abrir_suplemento (v_pol.sseguro,
                                                           mensajes
                                                          );

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 131;
                     RAISE error_proc;
                  END IF;

                  v_pasexec := 132;
                  pac_iax_produccion.vsseguro := NULL;
                  --                  v_numerr := pac_iax_produccion.f_emitir_col_admin(v_pol.sseguro, v_emitir,
                  --                                                                    mensajes, 1, 0);
                  v_numerr := f_emitir_col_admin (v_pol.sseguro, mensajes);

                  IF v_numerr <> 0
                  THEN
                     v_pasexec := 133;
                     RAISE error_proc;
                  END IF;
               END IF;
            END IF;
         ELSE
            IF NVL
                  (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                   0
                  ) = 0
            THEN
               SELECT COUNT (1)
                 INTO v_conta
                 FROM movseguro
                WHERE sseguro = v_pol.sseguro AND cmovseg <> 0;

               IF v_conta > 0
               THEN
                  -- No se permite realizar el traslado vigencia si existen cambios en la p?liza o certificados
                  v_numerr := 9905088;
                  RAISE error_proc;
               END IF;
            ELSE
               SELECT COUNT (1)
                 INTO v_conta
                 FROM seguros a, movseguro b
                WHERE a.npoliza = v_pol.npoliza
                  AND a.ncertif <> 0
                  AND b.sseguro = a.sseguro
                  AND b.cmovseg <> 0;

               IF v_conta > 0
               THEN
                  -- No se permite realizar el traslado vigencia si existen cambios en la p?liza o certificados
                  v_numerr := 9905088;
                  RAISE error_proc;
               END IF;

               SELECT COUNT (1)
                 INTO v_conta
                 FROM movseguro m, seguros s
                WHERE m.sseguro = v_pol.sseguro
                  AND m.sseguro = s.sseguro
                  AND m.cmovseg <> 0
                  AND NVL (m.cmotven, 0) <> 998
                  AND s.ncertif = 0;

               IF v_conta > 0
               THEN
                  -- No se permite realizar el traslado vigencia si existen cambios en la p?liza o certificados
                  v_numerr := 9905088;
                  RAISE error_proc;
               END IF;
            END IF;

            v_numerr := f_accion_traslado_vigencia (v_pol.sseguro, NULL);

            IF v_numerr <> 0
            THEN
               RAISE error_proc;
            END IF;

            IF     NVL
                      (pac_mdpar_productos.f_get_parproducto
                                                       ('ADMITE_CERTIFICADOS',
                                                        v_pol.sproduc
                                                       ),
                       0
                      ) = 1
               AND v_pol.ncertif = 0
            THEN
               FOR v_cers IN (SELECT *
                                FROM seguros
                               WHERE npoliza = v_pol.npoliza AND ncertif <> 0)
               LOOP
                  v_numerr :=
                     f_accion_traslado_vigencia (v_cers.sseguro,
                                                 v_pol.fefecto
                                                );

                  IF v_numerr <> 0
                  THEN
                     RAISE error_proc;
                  END IF;
               END LOOP;
            END IF;
         END IF;
      END LOOP;

      RETURN 0;
   EXCEPTION
      WHEN error_proc
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      v_pasexec,
                      'Error: ' || v_numerr || ' ' || vpar,
                      f_axis_literales (v_numerr, f_usu_idioma)
                     );
         RETURN v_numerr;
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      v_pasexec,
                      'Error no controlado ' || vpar,
                      v_numerr || ' ' || SQLERRM
                     );
         RETURN 108592;
   END f_traslado_vigencia;

   -- BUG24271:DRA:01/11/2012:Fi
   -- BUG 226488 ECP:30/05/2013
   FUNCTION f_inicia_prorroga (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      v_frenova   DATE;
      v_sproduc   productos.sproduc%TYPE;
   BEGIN
      BEGIN
         SELECT NVL (frenova, fcaranu), sproduc
           INTO v_frenova, v_sproduc
           FROM seguros
          WHERE sseguro = psseguro;
      EXCEPTION
         WHEN OTHERS
         THEN
            RETURN 102903;                      --No s'ha trobat cap registre
      END;

      BEGIN
         UPDATE seguros
            --Ini bug 26488 -- ECP -- 14/06/2013  Se cambia SET frenova = v_frenova + NVL(f_parproductos_v(v_sproduc, 'DIAS_PRORROGA'), 0), por
         SET frenova =
                ADD_MONTHS (v_frenova,
                            NVL (f_parproductos_v (v_sproduc,
                                                   'MESES_PRORROGA'),
                                 0
                                )
                           ),
             --Fin bug 26488 -- ECP -- 14/06/2013
             cduraci = 6
          WHERE sseguro = psseguro;
      END;

      RETURN 0;
   END f_inicia_prorroga;

   -- BUG 226488 ECP:30/05/2013

   --BUG 29229 - INICIO - DCT - 09/12/2013 - LCOL_T010-LCOL - Revision incidencias Suspensi?n / Reinicio (VIII)
   FUNCTION f_pre_inicializacion_supl (psseguro IN NUMBER, pfefecto IN DATE)
      RETURN NUMBER
   IS
      num_err          NUMBER;
      mensajes         t_iax_mensajes;
      vtraza           NUMBER;
      e_object_error   EXCEPTION;
      e_param_error    EXCEPTION;
      vpasexec         NUMBER (8)     := 1;
      vparam           VARCHAR2 (200)
                            := 'seg=' || psseguro || ' pfefecto=' || pfefecto;
      vobject          VARCHAR2 (200)
                                := 'PK_SUPLEMENTOS.f_pre_inicializacion_supl';
   BEGIN
      -- CONF-274-25/11/2016-JLTS- Se adiciona pac_suspension.vcod_reinicio en lugar del 392
      FOR regs IN (SELECT   *
                       FROM movseguro
                      WHERE sseguro = psseguro
                        AND fefecto >= pfefecto
                        AND cmotmov IN (391, pac_suspension.vcod_reinicio)
                        AND cmovseg <> 52
                   ORDER BY nmovimi DESC)
      LOOP
         -->>>>>>>>>>>> 9.2.- <<<<<<<<<<<<<<
         num_err :=
            pac_md_rechazo.rechazo (psseguro,
                                    regs.cmotmov,
                                    regs.nmovimi,
                                    3,
                                    NULL,
                                    mensajes,
                                    1
                                   );                             --pnorec = 1

         IF num_err > 0
         THEN
            RAISE e_object_error;
         END IF;
      END LOOP;

      RETURN 0;
   EXCEPTION
      WHEN e_param_error
      THEN
         pac_iobj_mensajes.p_tratarmensaje (mensajes,
                                            vobject,
                                            1000005,
                                            vpasexec,
                                            vparam
                                           );
         RETURN 1;
      WHEN e_object_error
      THEN
         pac_iobj_mensajes.p_tratarmensaje (mensajes,
                                            vobject,
                                            1000006,
                                            vpasexec,
                                            vparam
                                           );
         RETURN 1;
      WHEN OTHERS
      THEN
         pac_iobj_mensajes.p_tratarmensaje (mensajes,
                                            vobject,
                                            1000001,
                                            vpasexec,
                                            vparam,
                                            psqcode      => SQLCODE,
                                            psqerrm      => SQLERRM
                                           );
         RETURN 1;
   END f_pre_inicializacion_supl;

-- ------------------------------------------------------------------------------------
--  Funcion que busca la versi?n asociada a una p?liza
--  BUG 34462 - AFM
-- ------------------------------------------------------------------------------------
   FUNCTION f_fversconv (
      psseguro     IN       NUMBER,
      pmodo        IN       VARCHAR2,
      pfecha       OUT      DATE,
      pidversion   OUT      NUMBER
   )
      RETURN NUMBER
   IS
      lidconv     NUMBER;
      num_err     NUMBER;
      pnversion   NUMBER;
   BEGIN
      -- Es p?liza convenios. Devuelve 1 si es p?liza de convenios.
      num_err := pac_convenios_emp.f_es_polizaconvenios (psseguro, pmodo);

      IF num_err <> 1
      THEN
         -- Error la p?liza no es de convenios
         RETURN num_err;
      END IF;

      -- Busca el convenio que utiliza la p?liza
      lidconv := pac_convenios_emp.f_conv_poliza (psseguro, pmodo);

      IF lidconv IS NULL
      THEN
         -- Error no se ha encontrado el convenio al que pertenece la p?liza
         RETURN 9907513;
      END IF;

      -- Busca la ?ltima versi?n del convenio.
      num_err :=
         pac_convenios_emp.f_get_versactivaconv (lidconv,
                                                 pidversion,
                                                 pfecha,
                                                 pnversion
                                                );

      IF num_err <> 0
      THEN
         -- Error la p?liza no es de convenios
         RETURN num_err;
      END IF;

      --
      RETURN 0;
   --
   EXCEPTION
      WHEN OTHERS
      THEN
         RETURN 1;
   END f_fversconv;
-- ------------------------------------------------------------------------------------
--  Funcion que modifica GARANSEG las fecha finales afectadas por nuevo movimiento
--  retroactivo
--  BUG 34462 - AFM
-- ------------------------------------------------------------------------------------
   FUNCTION f_corregir_gar_movant (psseguro IN NUMBER, pnmovimi IN NUMBER)
      RETURN NUMBER
   IS
      --
      vobj       VARCHAR2 (100)  := 'pk_suplementos.f_corregir_gar_movant';
      vparam     VARCHAR2 (2000)
          := 'parmetros - psseguro: ' || psseguro || ' nmovimi: ' || pnmovimi;
      vpasexec   NUMBER          := 0;
   --
   BEGIN
      FOR i IN (SELECT   *
                    FROM tramosregul
                   WHERE sseguro = psseguro
                     AND nmovimi = pnmovimi
                     AND finiorigar IS NOT NULL
                --Son garant?a que seguro est?n en ese nmovorigen
                ORDER BY nmovimiorg)
      LOOP
         UPDATE garanseg
            SET ffinefe = i.fecini
          WHERE sseguro = i.sseguro
            AND nriesgo = i.nriesgo
            AND nmovimi = i.nmovimiorg
            AND finiefe = i.finiorigar
            AND cgarant = i.cgarant;
      END LOOP;

      --
      RETURN 0;
   --
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      vpasexec,
                      vparam,
                      'Error: ' || SQLERRM
                     );
         RETURN 1;
   END f_corregir_gar_movant;

   -- BUG 0034462 - FAL - 08/04/2015
   FUNCTION f_get_cmovseg (pcmotmov IN NUMBER, pcmovseg OUT NUMBER)
      RETURN NUMBER
   IS
      vobj        VARCHAR2 (100)            := 'pk_suplementos.f_get_cmovseg';
      vparam      VARCHAR2 (2000)    := 'parametros - pcmotmov: ' || pcmotmov;
      vpasexec    NUMBER                    := 0;
      v_cmovseg   codimotmov.cmovseg%TYPE;
   BEGIN
      p_tab_error (f_sysdate,
                   f_user,
                   'f_get_cmovseg',
                   666,
                   'ini f_get_cmovseg. pcmotmov: ' || pcmotmov,
                   NULL
                  );

      SELECT cmovseg
        INTO pcmovseg
        FROM codimotmov
       WHERE cmotmov = pcmotmov;

      p_tab_error (f_sysdate,
                   f_user,
                   'f_get_cmovseg',
                   666,
                   'v_cmovseg: ' || v_cmovseg,
                   NULL
                  );
      RETURN 0;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_tab_error (f_sysdate,
                      f_user,
                      vobj,
                      vpasexec,
                      vparam,
                      'Error: ' || SQLERRM
                     );
         RETURN 1;
   END f_get_cmovseg;

   -- FI BUG 0034462 - FAL - 08/04/2015

   -- INICIO IAXIS-3606 - 12/04/2019
   FUNCTION f_ins_contragaran_pol (psseguro IN NUMBER)
      RETURN NUMBER
   IS
      v_valor   NUMBER;
   BEGIN
      BEGIN
         SELECT SUM (icapital)
           INTO v_valor
           FROM garanseg a
          WHERE a.sseguro = psseguro
            AND a.nmovimi =
                       (SELECT MAX (b.nmovimi)
                          FROM garanseg b
                         WHERE b.sseguro = psseguro AND b.nriesgo = a.nriesgo);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            v_valor := 0;
      END;

      UPDATE ctgar_contragarantia
         SET ivalor = v_valor
       WHERE scontgar IN (SELECT scontgar
                            FROM ctgar_seguro ctg
                           WHERE ctg.sseguro = psseguro)
                                                        /*AND nmovimi in (SELECT MAX (b.nmovimi)
                                                                        FROM garanseg b
                                                                        WHERE b.sseguro = psseguro
                                                                        AND b.nmovimi <= pnmovimi) */
             AND cestado = 2;

      COMMIT;
      --
      RETURN 0;
   --
   END f_ins_contragaran_pol;
-- FIN IAXIS-3606 - 12/04/2019
END pk_suplementos;
/
