--------------------------------------------------------
--  DDL for Function F_CONSOR_PR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_CONSOR_PR" (PNRECIBO IN NUMBER, PNRIESGO IN NUMBER, PCMODO IN VARCHAR2)
                     RETURN NUMBER authid current_user IS
-- LIBRERÍA:  ALLIBADM
-- ELIMINA LAS LINEAS DE CONSORCIO DE DETRECIBOS QUE SOBRAN EN FUNCIÓN DE SI NOS QUEDAMOS
-- CON EL PRIMER RIESGO O EL RESTO.
XSUMA_NOPR NUMBER;
XPERCENT   NUMBER;
XNVALOR1   NUMBER;
XNVALOR2   NUMBER;
ERROR      NUMBER;
CURSOR SUM_CONSOR_PR IS
SELECT NRECIBO C_RECIBO, NRIESGO C_RIESGO, SUM(ICONCEP) C_SUMA_PR
  FROM DETRECIBOS
 WHERE NRECIBO = PNRECIBO
   AND CCONCEP IN (2,52)
   AND CGARANT = 212
 GROUP BY NRECIBO, NRIESGO;
CURSOR SUM_CONSOR_PR_CAR IS
SELECT NRECIBO C_RECIBO, NRIESGO C_RIESGO, SUM(ICONCEP) C_SUMA_PR
  FROM DETRECIBOSCAR
 WHERE NRECIBO = PNRECIBO
   AND CCONCEP IN (2,52)
   AND CGARANT = 212
 GROUP BY NRECIBO, NRIESGO;
BEGIN
IF PCMODO = 'R' THEN -- MODO REAL
 FOR SCPR IN SUM_CONSOR_PR
 LOOP
   BEGIN
      SELECT SUM(ICONCEP)
        INTO XSUMA_NOPR
        FROM DETRECIBOS
       WHERE NRECIBO = SCPR.C_RECIBO
         AND CCONCEP IN (2,52)
         AND CGARANT <> 212
         AND NRIESGO = SCPR.C_RIESGO;
       EXCEPTION
          WHEN NO_DATA_FOUND THEN
		  ERROR := 103469;	-- REBUT NO TROBAT
		  RETURN ERROR;
	    WHEN OTHERS THEN
		  ERROR := 103512;     -- ERROR AL LLEGIR
		  RETURN ERROR;
   END;
   XPERCENT := (SCPR.C_SUMA_PR / XSUMA_NOPR ) * 100;  -- PORCENTAJE
   IF XPERCENT IS NOT NULL THEN
	BEGIN
	    SELECT NVALOR1, NVALOR2
	      INTO XNVALOR1, XNVALOR2
		FROM LIMITES
	     WHERE CLIMITE = 1
             AND XPERCENT >= NMINIMO
             AND(XPERCENT < NMAXIMO OR NMAXIMO IS NULL);
          EXCEPTION
		WHEN NO_DATA_FOUND THEN
		  ERROR := 103834;	--LÍMIT NO TROBAT A LIMITES
		  RETURN ERROR;
		WHEN OTHERS THEN
		  ERROR := 103514;     -- ERROR AL LLEGIR DE LA TAULA
		  RETURN ERROR;		-- LIMITES
	END;
	SCPR.C_SUMA_PR := SCPR.C_SUMA_PR * XNVALOR1;    -- PRIMER RISC
	XSUMA_NOPR     := XSUMA_NOPR * XNVALOR2 /100;   -- RESTA
	IF XSUMA_NOPR < SCPR.C_SUMA_PR THEN
	  -- NOS QUEDAMOS CON EL CONSORCIO DEL PRIMER RIESGO Y APLICAMOS LA REDUCCION
        -- AL RESTO
         BEGIN
           DELETE FROM DETRECIBOS
            WHERE NRECIBO = SCPR.C_RECIBO
              AND NRIESGO = SCPR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT <> 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103469;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 105156;     -- ERROR A L'ESBORRAR
		   RETURN ERROR;
         END;
         BEGIN
           UPDATE DETRECIBOS
              SET ICONCEP = ICONCEP * XNVALOR1
            WHERE NRECIBO = SCPR.C_RECIBO
              AND NRIESGO = SCPR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT = 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103469;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 104377;     -- ERROR A L'ACTUALITZAR
		   RETURN ERROR;
         END;
	ELSE
	  -- NOS QUEDAMOS CON EL RESTO Y APLICAMOS LA REDUCCION
        -- AL PRIMER RIESGO
         BEGIN
           DELETE FROM DETRECIBOS
            WHERE NRECIBO = SCPR.C_RECIBO
              AND NRIESGO = SCPR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT = 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103469;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 105156;     -- ERROR A L'ESBORRAR
		   RETURN ERROR;
         END;
         BEGIN
           UPDATE DETRECIBOS
              SET ICONCEP = ICONCEP * XNVALOR2 / 100
            WHERE NRECIBO = SCPR.C_RECIBO
              AND NRIESGO = SCPR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT <> 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103469;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 104377;     -- ERROR A L'ACTUALITZAR
		   RETURN ERROR;
         END;
     END IF;
  END IF;
 END LOOP;
ELSE -- MODO DE PRUEBAS
 FOR SCPR_CAR IN SUM_CONSOR_PR_CAR
 LOOP
   BEGIN
      SELECT SUM(ICONCEP)
        INTO XSUMA_NOPR
        FROM DETRECIBOSCAR
       WHERE NRECIBO = SCPR_CAR.C_RECIBO
         AND CCONCEP IN (2,52)
         AND CGARANT <> 212
         AND NRIESGO = SCPR_CAR.C_RIESGO;
       EXCEPTION
          WHEN NO_DATA_FOUND THEN
		  ERROR := 103470;	-- REBUT NO TROBAT
		  RETURN ERROR;
	    WHEN OTHERS THEN
		  ERROR := 103516;     -- ERROR AL LLEGIR
		  RETURN ERROR;
   END;
   XPERCENT := (SCPR_CAR.C_SUMA_PR / XSUMA_NOPR ) * 100;  -- PORCENTAJE
   IF XPERCENT IS NOT NULL THEN
	BEGIN
	    SELECT NVALOR1, NVALOR2
	      INTO XNVALOR1, XNVALOR2
		FROM LIMITES
	     WHERE CLIMITE = 1
             AND XPERCENT >= NMINIMO
             AND(XPERCENT < NMAXIMO OR NMAXIMO IS NULL);
          EXCEPTION
		WHEN NO_DATA_FOUND THEN
		  ERROR := 103834;	--LÍMIT NO TROBAT A LIMITES
		  RETURN ERROR;
		WHEN OTHERS THEN
		  ERROR := 103514;     -- ERROR AL LLEGIR DE LA TAULA
		  RETURN ERROR;		-- LIMITES
	END;
	XSUMA_NOPR := XSUMA_NOPR * XNVALOR2 /100 ;   -- RESTA
	SCPR_CAR.C_SUMA_PR := SCPR_CAR.C_SUMA_PR * XNVALOR1; -- PRIMER RISC
	IF XSUMA_NOPR < SCPR_CAR.C_SUMA_PR THEN
	  -- NOS QUEDAMOS CON EL CONSORCIO DEL PRIMER RIESGO Y APLICAMOS LA REDUCCION
        -- AL RESTO
         BEGIN
           DELETE FROM DETRECIBOSCAR
            WHERE NRECIBO = SCPR_CAR.C_RECIBO
              AND NRIESGO = SCPR_CAR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT <> 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103470;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 105159;     -- ERROR A L'ESBORRAR
		   RETURN ERROR;
         END;
         BEGIN
           UPDATE DETRECIBOSCAR
              SET ICONCEP = ICONCEP * XNVALOR1
            WHERE NRECIBO = SCPR_CAR.C_RECIBO
              AND NRIESGO = SCPR_CAR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT = 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103470;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 104378;     -- ERROR A L'ACTUALITZAR
		   RETURN ERROR;
         END;
	ELSE
	  -- NOS QUEDAMOS CON EL RESTO Y APLICAMOS LA REDUCCION
        -- AL PRIMER RIESGO
         BEGIN
           DELETE FROM DETRECIBOSCAR
            WHERE NRECIBO = SCPR_CAR.C_RECIBO
              AND NRIESGO = SCPR_CAR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT = 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103470;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 105159;     -- ERROR A L'ESBORRAR
		   RETURN ERROR;
         END;
         BEGIN
           UPDATE DETRECIBOSCAR
              SET ICONCEP = ICONCEP * XNVALOR2 / 100
            WHERE NRECIBO = SCPR_CAR.C_RECIBO
              AND NRIESGO = SCPR_CAR.C_RIESGO
              AND CCONCEP IN (2,52)
              AND CGARANT <> 212;
         EXCEPTION
           WHEN NO_DATA_FOUND THEN
		   ERROR := 103470;	-- REBUT NO TROBAT
		   RETURN ERROR;
	     WHEN OTHERS THEN
		   ERROR := 104378;     -- ERROR A L'ACTUALITZAR
		   RETURN ERROR;
         END;
     END IF;
  END IF;
 END LOOP;
END IF;
RETURN 0;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_CONSOR_PR" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_CONSOR_PR" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_CONSOR_PR" TO "PROGRAMADORESCSI";
