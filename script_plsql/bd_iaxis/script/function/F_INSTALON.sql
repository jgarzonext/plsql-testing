--------------------------------------------------------
--  DDL for Function F_INSTALON
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_INSTALON" (MEDIO IN NUMBER, DESTINO IN NUMBER, PERSON IN NUMBER,
	EMPRESA IN NUMBER, AGRUPACION IN NUMBER, FECHA IN DATE,
	MEDPAG IN OUT NUMBER, DELEGACION IN NUMBER, CARTA IN NUMBER,
	PIMPORT IN NUMBER, PSIDEPAG IN NUMBER, PNLIQMEN IN NUMBER,
	PCENTIDA IN NUMBER, PROCES IN NUMBER) RETURN NUMBER authid current_user IS
/***********************************************************************
	F_INSTALON: INSERTA UN TALON EN LA TABLA MEDPAGO
	ALLIBADM
   NDESTIN = 1 AGENTE
           = 2 SINIESTRO
   NMEDIOP  = 1 TALON
           = 2 TRANSFERENCIA
           = 0 EFECTIVO CAJA
   CESTADO = 1 PEDIENTE DE EMITIR
           = 2 EMITIDO
           = 3 RETENIDO
   CCONCIL = 0 FALSO
           = 1 CIERTO
   AGRUPACION = 1 NO VIDA  (ES CUALQUIER TIPO DE CAGRPRO DE PRODUCTOS != 2)
              = 2 VIDA
   SE AÑADE EL CAMPO SSEGURO PARA FACILITAR LA CONSULTA POR
                PRODUCTO EN CASO DE SINIESTROS.
   SE AÑADE NUEVOS PARAMETROS PARA IDENTIFICAR CON MAYOR DETALLE
                     LA CUENTA DE CARGO
 	 CAMBIAN LOS CAMPOS DE LA TABLA
***********************************************************************/
  CTA     VARCHAR2(20);
  CTAENV  VARCHAR2(20);
  ERROR   NUMBER;
  WMEDPAG NUMBER;
BEGIN
  SELECT SMEDPAG.NEXTVAL INTO WMEDPAG FROM DUAL;
  MEDPAG := WMEDPAG;
  ERROR := F_BUSCTACTE(EMPRESA,AGRUPACION,CTA,DELEGACION,PCENTIDA);
  IF ERROR != 0 THEN
    RETURN ERROR;
  END IF;
  IF MEDIO = 2 THEN
    ERROR := F_BUSCTAENV(PERSON,CTAENV);
    IF ERROR != 0 THEN
       RETURN ERROR;
    END IF;
  END IF;
/*   -- VALIDACION INNECESARIA (DA PROBLEMAS CON AGENTES INACTIVOS)
  IF PERSON IS NOT NULL AND DESTINO = 1 THEN
    ERROR := F_DELEGACION(NULL,EMPRESA,PERSON,SYSDATE);
    IF ERROR = 0 THEN
      RETURN 105483;
    END IF;
  END IF;
*/
  INSERT INTO MEDPAGO (SMEDPAG, FEMISIO, FGENERA, NDESTIN, IIMPORT, CCTACTE,
	NTALON, CCTAENV, CESTADO, CCONCIL, CUSUARI, CTIPCAR, SIDEPAG, CAGENTE,
	NLIQMEN, CEMPRES, CDELEGA, CAGRPRO, CENTIDA, SPROCES)
	VALUES (WMEDPAG, FECHA, NULL, DESTINO, PIMPORT, CTA,
	NULL, CTAENV, 1, 0, F_USER, CARTA, PSIDEPAG, PERSON,
	PNLIQMEN, EMPRESA, DELEGACION, AGRUPACION, PCENTIDA, PROCES);
  RETURN 0;
  EXCEPTION
   WHEN OTHERS THEN
     RETURN 105494;
END F_INSTALON;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_INSTALON" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_INSTALON" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_INSTALON" TO "PROGRAMADORESCSI";
