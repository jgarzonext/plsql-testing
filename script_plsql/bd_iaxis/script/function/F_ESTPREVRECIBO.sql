--------------------------------------------------------
--  DDL for Function F_ESTPREVRECIBO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_ESTPREVRECIBO" (PPRIMANY IN NUMBER, PPROPPOL IN NUMBER, PSPROCES IN
	NUMBER, PSSEGURO IN NUMBER, PCMOVIMI IN NUMBER, PNMOVIMI IN NUMBER,
	PIPRINET OUT NUMBER, PIRECEXT	OUT NUMBER, PICONSOR OUT NUMBER, PIRECCON
	OUT NUMBER, PIIPS OUT NUMBER, PIDGS OUT NUMBER, PIARBITR OUT NUMBER,
	PIFNG OUT NUMBER, PIRECFRA OUT NUMBER, PIDTOTEC OUT NUMBER, PIDTOCOM
	OUT NUMBER, PICOMBRU OUT NUMBER, PICOMRET OUT NUMBER, PIDTOOM OUT
	NUMBER, PIPRIDEV OUT NUMBER, PITOTPRI OUT NUMBER, PITOTDTO OUT NUMBER,
	PITOTCON OUT NUMBER, PITOTIMP OUT NUMBER, PITOTALR OUT NUMBER, PNRIESGO
	IN NUMBER DEFAULT NULL) RETURN NUMBER authid current_user IS
--
-- ALLIBADM. FA UN PREVI DELS DETALLS DEL REBUT
-- ABANS DE CREAR-LOS FISICAMENT. CRIDA A LA FUNCIÓ F_DETRECIBO AMB EL PMODO
-- 'P' (PROVES)  O 'N'. ABANS DE CRIDAR A AQUESTA FUNCIÓ, S' HA D' HAVER GRABAT UN
-- NÚMERO DE PROCÉS.
--
--
ERROR		NUMBER;
XIPRINET	NUMBER;
XIRECEXT	NUMBER;
XICONSOR	NUMBER;
XIRECCON	NUMBER;
XIIPS		NUMBER;
XIDGS		NUMBER;
XIARBITR	NUMBER;
XIFNG		NUMBER;
XIRECFRA	NUMBER;
XIDTOTEC	NUMBER;
XIDTOCOM	NUMBER;
XICOMBRU	NUMBER;
XICOMRET	NUMBER;
XIDTOOM	NUMBER;
XIPRIDEV	NUMBER;
XITOTPRI	NUMBER;
XITOTDTO	NUMBER;
XITOTCON	NUMBER;
XITOTIMP	NUMBER;
XITOTALR	NUMBER;
XNRECIBO	NUMBER;
XFVENCIM	DATE;
XTIPOMOVIM	NUMBER;
XCAGENTE	NUMBER;
XCFORPAG	NUMBER;
XFCARANU	DATE;
XFEFECTO	DATE;
XXFVENCIM	DATE;
NSUM		NUMBER;
DUMMY		NUMBER;
XNRECIBO1	NUMBER;
XNRECIBO2	NUMBER;
XNMOVIMI	NUMBER;
BEGIN
BEGIN
SELECT CAGENTE, FEFECTO, NVL(FVENCIM, FEFECTO), FCARANU, NVL(CFORPAG, 1)
INTO XCAGENTE, XFEFECTO, XFVENCIM, XFCARANU, XCFORPAG
FROM ESTSEGUROS
WHERE SSEGURO = PSSEGURO;
EXCEPTION
WHEN NO_DATA_FOUND THEN
	RETURN 101903;		-- SEGURO NO ENCONTRADO EN LA TABLA SEGUROS
WHEN OTHERS THEN
	RETURN 101919;		-- ERROR AL LLEGIR DE SEGUROS
END;
IF PPROPPOL = 0 THEN		-- PROPOSTA
BEGIN
	SELECT NVL(MAX(NRECIBO), 0)
	INTO XNRECIBO
	FROM RECIBOSCAR
	WHERE SPROCES = PSPROCES;
	XNRECIBO1 := XNRECIBO + 1;
	XNRECIBO2 := XNRECIBO + 2;
EXCEPTION
	WHEN OTHERS THEN
	  XNRECIBO1 := 1;
	  XNRECIBO2 := 2;
END;
IF PPRIMANY = 0 THEN	-- 1 REBUT
	IF XCFORPAG <> 0 AND XCFORPAG <>1 THEN
	  NSUM := 12 / XCFORPAG;
	  XXFVENCIM := ADD_MONTHS(XFVENCIM, NSUM);
	  IF XXFVENCIM > XFVENCIM THEN
	    XXFVENCIM := XFVENCIM;
	  END IF;
	ELSE
	  XXFVENCIM := XFVENCIM;
	END IF;
	ERROR := F_ESTINSRECIBO(PSSEGURO, XCAGENTE, SYSDATE, XFEFECTO, XXFVENCIM,
		0, NULL, NULL, NULL, 0, PNRIESGO, XNRECIBO1, 'N', PSPROCES, PCMOVIMI,
		PNMOVIMI, SYSDATE);
	IF ERROR = 0 THEN
	  IF PNMOVIMI = 1 THEN
	    XTIPOMOVIM := 0;		-- NOVA PRODUCCIÓ
	  ELSIF PNMOVIMI > 1 THEN
	    XTIPOMOVIM := 1;		-- SUPLEMENT
	  END IF;
	  XFCARANU := NVL(XFCARANU, XXFVENCIM);
	  ERROR := F_ESTDETRECIBO(PSPROCES, PSSEGURO, XNRECIBO1, XTIPOMOVIM, 'P',
		1, SYSDATE, XFEFECTO, XXFVENCIM, XFCARANU, NULL, PNRIESGO, PNMOVIMI,
		PPROPPOL, DUMMY);
	  IF ERROR = 0 THEN
	    BEGIN
	    SELECT IPRINET, IRECEXT, ICONSOR, IRECCON, IIPS, IDGS, IARBITR,
		IFNG, IRECFRA, IDTOTEC, IDTOCOM, ICOMBRU, ICOMRET, IDTOOM,
		IPRIDEV, ITOTPRI, ITOTDTO, ITOTCON, ITOTIMP, ITOTALR
	    INTO XIPRINET, XIRECEXT, XICONSOR, XIRECCON, XIIPS, XIDGS, XIARBITR,
		XIFNG, XIRECFRA, XIDTOTEC, XIDTOCOM, XICOMBRU, XICOMRET, XIDTOOM,
		XIPRIDEV, XITOTPRI, XITOTDTO, XITOTCON, XITOTIMP, XITOTALR
	    FROM VDETRECIBOSCAR
	    WHERE SPROCES = PSPROCES AND
			NRECIBO = XNRECIBO1;
	    EXCEPTION
	    WHEN NO_DATA_FOUND THEN
		RETURN 104440;		-- REBUT NO TROBAT A VDETRECIBOSCAR
	    WHEN OTHERS THEN
		RETURN 104441;		-- ERROR AL LLEGIR DE VDETRECIBOSCAR
	    END;
	    PIPRINET := XIPRINET;
	    PIRECEXT := XIRECEXT;
	    PICONSOR := XICONSOR;
	    PIRECCON := XIRECCON;
	    PIIPS := XIIPS;
	    PIDGS := XIDGS;
	    PIARBITR := XIARBITR;
	    PIFNG := XIFNG;
	    PIRECFRA := XIRECFRA;
	    PIDTOTEC := XIDTOTEC;
	    PIDTOCOM := XIDTOCOM;
	    PICOMBRU := XICOMRET;
	    PIDTOOM := XIDTOOM;
	    PIPRIDEV := XIPRIDEV;
	    PITOTPRI := XITOTPRI;
	    PITOTDTO := XITOTDTO;
	    PITOTCON := XITOTCON;
	    PITOTIMP := XITOTIMP;
	    PITOTALR := XITOTALR;
	    RETURN 0;
	  ELSE
	    RETURN ERROR;
	  END IF;
	ELSE
	  RETURN ERROR;
	END IF;
ELSIF PPRIMANY = 1 THEN		-- REBUT ANUAL
	XXFVENCIM := ADD_MONTHS(XFEFECTO, 12);
	IF XXFVENCIM > XFVENCIM THEN
	  XXFVENCIM := XFVENCIM;
	END IF;
	ERROR := F_ESTINSRECIBO(PSSEGURO, XCAGENTE, SYSDATE, XFEFECTO, XXFVENCIM,
		0, NULL, NULL, NULL, 0, PNRIESGO, XNRECIBO2, 'N', PSPROCES, PCMOVIMI,
		PNMOVIMI, SYSDATE);
	IF ERROR = 0 THEN
	  IF PNMOVIMI = 1 THEN
	    XTIPOMOVIM := 0;		-- NOVA PRODUCCIÓ
	  ELSIF PNMOVIMI > 1 THEN
	    XTIPOMOVIM := 1;		-- SUPLEMENT
	  END IF;
	  XFCARANU := NVL(XFCARANU, XXFVENCIM);
	  ERROR := F_ESTDETRECIBO(PSPROCES, PSSEGURO, XNRECIBO2, XTIPOMOVIM, 'N',
		1, SYSDATE, XFEFECTO, XXFVENCIM, XFCARANU, NULL, PNRIESGO, PNMOVIMI,
		PPROPPOL, DUMMY);
	  IF ERROR = 0 THEN
	  BEGIN
	    SELECT IPRINET, IRECEXT, ICONSOR, IRECCON, IIPS, IDGS, IARBITR,
		IFNG, IRECFRA, IDTOTEC, IDTOCOM, ICOMBRU, ICOMRET, IDTOOM,
		IPRIDEV, ITOTPRI, ITOTDTO, ITOTCON, ITOTIMP, ITOTALR
	    INTO XIPRINET, XIRECEXT, XICONSOR, XIRECCON, XIIPS, XIDGS, XIARBITR,
		XIFNG, XIRECFRA, XIDTOTEC, XIDTOCOM, XICOMBRU, XICOMRET, XIDTOOM,
		XIPRIDEV, XITOTPRI, XITOTDTO, XITOTCON, XITOTIMP, XITOTALR
	    FROM VDETRECIBOSCAR
	    WHERE SPROCES = PSPROCES AND
			NRECIBO = XNRECIBO2;
	  EXCEPTION
	    WHEN NO_DATA_FOUND THEN
		RETURN 104440;		-- REBUT NO TROBAT A VDETRECIBOSCAR
	    WHEN OTHERS THEN
		RETURN 104441;		-- ERROR AL LLEGIR DE VDETRECIBOSCAR
	  END;
	  PIPRINET := XIPRINET;
	  PIRECEXT := XIRECEXT;
	  PICONSOR := XICONSOR;
	  PIRECCON := XIRECCON;
	  PIIPS := XIIPS;
	  PIDGS := XIDGS;
	  PIARBITR := XIARBITR;
	  PIFNG := XIFNG;
	  PIRECFRA := XIRECFRA;
	  PIDTOTEC := XIDTOTEC;
	  PIDTOCOM := XIDTOCOM;
	  PICOMBRU := XICOMRET;
	  PIDTOOM := XIDTOOM;
	  PIPRIDEV := XIPRIDEV;
	  PITOTPRI := XITOTPRI;
	  PITOTDTO := XITOTDTO;
	  PITOTCON := XITOTCON;
	  PITOTIMP := XITOTIMP;
	  PITOTALR := XITOTALR;
	  RETURN 0;
	  ELSE
	    RETURN ERROR;
	  END IF;
	ELSE
	  RETURN ERROR;
	END IF;
ELSE
	RETURN 101901;		-- PAS DE PARÀMETRES INCORRECTE
END IF;
ELSIF PPROPPOL = 1 THEN		-- PÒLISSA
IF PPRIMANY = 0 THEN	-- 1 REBUT
	BEGIN
	  SELECT MIN(NRECIBO)
	  INTO XNRECIBO
	  FROM RECIBOS
	  WHERE SSEGURO = PSSEGURO AND
		NMOVIMI = PNMOVIMI AND
		(NRIESGO = PNRIESGO OR PNRIESGO IS NULL);
	EXCEPTION
	  WHEN OTHERS THEN
	    RETURN 102367;			-- ERROR AL LLEGIR DE RECIBOS
	END;
	IF XNRECIBO IS NULL THEN
	  BEGIN
	    SELECT NVL(MAX(NMOVIMI), 1)
	    INTO XNMOVIMI
	    FROM RECIBOS
	    WHERE SSEGURO = PSSEGURO AND
		(NRIESGO = PNRIESGO OR PNRIESGO IS NULL);
	  EXCEPTION
	    WHEN OTHERS THEN
		RETURN 102367;			-- ERROR AL LLEGIR DE RECIBOS
	  END;
	  BEGIN
	    SELECT MIN(NRECIBO)
	    INTO XNRECIBO
	    FROM RECIBOS
	    WHERE SSEGURO = PSSEGURO AND
		NMOVIMI = XNMOVIMI AND
		(NRIESGO = PNRIESGO OR PNRIESGO IS NULL);
	  EXCEPTION
	    WHEN OTHERS THEN
		RETURN 102367;			-- ERROR AL LLEGIR DE RECIBOS
	  END;
	END IF;
	BEGIN
	    SELECT IPRINET, IRECEXT, ICONSOR, IRECCON, IIPS, IDGS, IARBITR,
		IFNG, IRECFRA, IDTOTEC, IDTOCOM, ICOMBRU, ICOMRET, IDTOOM,
		IPRIDEV, ITOTPRI, ITOTDTO, ITOTCON, ITOTIMP, ITOTALR
	    INTO XIPRINET, XIRECEXT, XICONSOR, XIRECCON, XIIPS, XIDGS, XIARBITR,
		XIFNG, XIRECFRA, XIDTOTEC, XIDTOCOM, XICOMBRU, XICOMRET, XIDTOOM,
		XIPRIDEV, XITOTPRI, XITOTDTO, XITOTCON, XITOTIMP, XITOTALR
	    FROM VDETRECIBOS
	    WHERE NRECIBO = XNRECIBO;
	EXCEPTION
	    WHEN NO_DATA_FOUND THEN
		RETURN 103936;		-- REBUT NO TROBAT A VDETRECIBOS
	    WHEN OTHERS THEN
		RETURN 103920;		-- ERROR AL LLEGIR DE VDETRECIBOS
	END;
	PIPRINET := XIPRINET;
	PIRECEXT := XIRECEXT;
	PICONSOR := XICONSOR;
	PIRECCON := XIRECCON;
	PIIPS := XIIPS;
	PIDGS := XIDGS;
	PIARBITR := XIARBITR;
	PIFNG := XIFNG;
	PIRECFRA := XIRECFRA;
	PIDTOTEC := XIDTOTEC;
	PIDTOCOM := XIDTOCOM;
	PICOMBRU := XICOMRET;
	PIDTOOM := XIDTOOM;
	PIPRIDEV := XIPRIDEV;
	PITOTPRI := XITOTPRI;
	PITOTDTO := XITOTDTO;
	PITOTCON := XITOTCON;
	PITOTIMP := XITOTIMP;
	PITOTALR := XITOTALR;
	RETURN 0;
ELSIF PPRIMANY = 1 THEN		-- REBUT ANUAL
BEGIN
	  SELECT NVL(MAX(NRECIBO), 0)
	  INTO XNRECIBO
	  FROM RECIBOSCAR
	  WHERE SPROCES = PSPROCES;
	  XNRECIBO1 := XNRECIBO + 1;
EXCEPTION
	  WHEN OTHERS THEN
	    XNRECIBO1 := 1;
END;
	XXFVENCIM := ADD_MONTHS(XFEFECTO, 12);
	IF XXFVENCIM > XFVENCIM THEN
	  XXFVENCIM := XFVENCIM;
	END IF;
	ERROR := F_ESTINSRECIBO(PSSEGURO, XCAGENTE, SYSDATE, XFEFECTO, XXFVENCIM,
		0, NULL, NULL, NULL, 0, PNRIESGO, XNRECIBO1, 'N', PSPROCES,
		PCMOVIMI, PNMOVIMI, SYSDATE);
	IF ERROR = 0 THEN
	  IF PNMOVIMI = 1 THEN
	    XTIPOMOVIM := 0;		-- NOVA PRODUCCIÓ
	  ELSIF PNMOVIMI > 1 THEN
	    XTIPOMOVIM := 1;		-- SUPLEMENT
	  END IF;
	  XFCARANU := NVL(XFCARANU, XXFVENCIM);
	  ERROR := F_ESTDETRECIBO(PSPROCES, PSSEGURO, XNRECIBO1, XTIPOMOVIM, 'N',
		1, SYSDATE, XFEFECTO, XXFVENCIM, XFCARANU, NULL, PNRIESGO, PNMOVIMI,
		PPROPPOL, DUMMY);
	  IF ERROR = 0 THEN
	  BEGIN
	    SELECT IPRINET, IRECEXT, ICONSOR, IRECCON, IIPS, IDGS, IARBITR,
		IFNG, IRECFRA, IDTOTEC, IDTOCOM, ICOMBRU, ICOMRET, IDTOOM,
		IPRIDEV, ITOTPRI, ITOTDTO, ITOTCON, ITOTIMP, ITOTALR
	    INTO XIPRINET, XIRECEXT, XICONSOR, XIRECCON, XIIPS, XIDGS, XIARBITR,
		XIFNG, XIRECFRA, XIDTOTEC, XIDTOCOM, XICOMBRU, XICOMRET, XIDTOOM,
		XIPRIDEV, XITOTPRI, XITOTDTO, XITOTCON, XITOTIMP, XITOTALR
	    FROM VDETRECIBOSCAR
	    WHERE SPROCES = PSPROCES AND
			NRECIBO = XNRECIBO1;
	  EXCEPTION
	    WHEN NO_DATA_FOUND THEN
		RETURN 104440;		-- REBUT NO TROBAT A VDETRECIBOSCAR
	    WHEN OTHERS THEN
		RETURN 104441;		-- ERROR AL LLEGIR DE VDETRECIBOSCAR
	  END;
	  PIPRINET := XIPRINET;
	  PIRECEXT := XIRECEXT;
	  PICONSOR := XICONSOR;
	  PIRECCON := XIRECCON;
	  PIIPS := XIIPS;
	  PIDGS := XIDGS;
	  PIARBITR := XIARBITR;
	  PIFNG := XIFNG;
	  PIRECFRA := XIRECFRA;
	  PIDTOTEC := XIDTOTEC;
	  PIDTOCOM := XIDTOCOM;
	  PICOMBRU := XICOMRET;
	  PIDTOOM := XIDTOOM;
	  PIPRIDEV := XIPRIDEV;
	  PITOTPRI := XITOTPRI;
	  PITOTDTO := XITOTDTO;
	  PITOTCON := XITOTCON;
	  PITOTIMP := XITOTIMP;
	  PITOTALR := XITOTALR;
	  RETURN 0;
	  ELSE
	    RETURN ERROR;
	  END IF;
	ELSE
	  RETURN ERROR;
	END IF;
ELSE
	RETURN 101901;		-- PAS DE PARÀMETRES INCORRECTE A LA FUNCIÓ
END IF;
ELSE
RETURN 101901;		-- PAS DE PARÀMETRES INCORRECTE A LA FUNCIÓ
END IF;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_ESTPREVRECIBO" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_ESTPREVRECIBO" TO "PROGRAMADORESCSI";
  GRANT EXECUTE ON "AXIS"."F_ESTPREVRECIBO" TO "R_AXIS";
