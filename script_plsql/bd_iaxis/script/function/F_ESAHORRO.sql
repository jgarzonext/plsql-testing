--------------------------------------------------------
--  DDL for Function F_ESAHORRO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_ESAHORRO" (PNRECIBO IN NUMBER, PSSEGURO IN NUMBER, PNERROR OUT
		     NUMBER) RETURN NUMBER
authid current_user IS
	XSSEGURO	NUMBER;
	XCRAMO	NUMBER;
	XCMODALI	NUMBER;
	XCTIPSEG	NUMBER;
	XCCOLECT	NUMBER;
	XCAGRPRO	NUMBER;
--
-- SI EL REBUT O LA PÒLISSA (SSEGURO)
-- PERTANYEN A UN PRODUCTE D' ESTALVI (CAGRPRO = 2) RETORNA UN 1, SINÓ, UN 0.
--
BEGIN
IF PNRECIBO IS NULL AND PSSEGURO IS NULL THEN
PNERROR := 101901;		-- PAS INCORRECTE DE PARÀMETRES A LA FUNCIÓ
RETURN 0;
ELSE	-- PARÀMETRES CORRECTES
IF PSSEGURO IS NULL THEN
	BEGIN
	  SELECT SSEGURO
	  INTO XSSEGURO
	  FROM RECIBOS
	  WHERE NRECIBO = PNRECIBO;
	EXCEPTION
	  WHEN NO_DATA_FOUND THEN
	    PNERROR := 101902;		-- REBUT NO TROBAT A LA TAULA RECIBOS
	    RETURN 0;
	  WHEN OTHERS THEN
	    PNERROR := 102367;		-- ERROR AL LLEGIR DE RECIBOS
	    RETURN 0;
	END;
ELSE
	XSSEGURO := PSSEGURO;
END IF;
BEGIN
	SELECT CRAMO, CMODALI, CTIPSEG, CCOLECT
	INTO XCRAMO, XCMODALI, XCTIPSEG, XCCOLECT
	FROM SEGUROS
	WHERE SSEGURO = XSSEGURO;
EXCEPTION
	WHEN NO_DATA_FOUND THEN
	  PNERROR := 101903;		-- ASSEGURANÇA NO TROBADA A SEGUROS
	  RETURN 0;
	WHEN OTHERS THEN
	  PNERROR := 101919;		-- ERROR AL LLEGIR DE SEGUROS
	  RETURN 0;
END;
BEGIN
	SELECT CAGRPRO
	INTO XCAGRPRO
	FROM PRODUCTOS
	WHERE CRAMO = XCRAMO AND
		CMODALI = XCMODALI AND
		CTIPSEG = XCTIPSEG AND
		CCOLECT = XCCOLECT;
EXCEPTION
	WHEN NO_DATA_FOUND THEN
	  PNERROR := 104347;		-- PRODUCTE NO TROBAT A PRODUCTOS
	  RETURN 0;
	WHEN OTHERS THEN
	  PNERROR := 102705;		-- ERROR AL LLEGIR DE PRODUCTOS
	  RETURN 0;
END;
-- *** Albert - Caixa Sabadell - Modf. Febrero 2001
-- *** Añado el grupo 11 de ahorro : Plan de Pensiones
IF XCAGRPRO = 2 OR XCAGRPRO = 21 OR XCAGRPRO = 11 OR XCAGRPRO = 10 THEN
	PNERROR := 0;
	RETURN 1;	-- ES D' ESTALVI
ELSE
	PNERROR := 0;
	RETURN 0;	-- NO HO ÉS
END IF;
END IF;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_ESAHORRO" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_ESAHORRO" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_ESAHORRO" TO "PROGRAMADORESCSI";
