--------------------------------------------------------
--  DDL for Function F_ESTBASECON
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_ESTBASECON" (PSSEGURO IN NUMBER, PFEFECTO IN DATE, PNRIESGO IN NUMBER,
	PCGARANT IN NUMBER, PCRAMO IN NUMBER, PCMODALI IN NUMBER, PCCOLECT IN NUMBER,
	PCTIPSEG IN NUMBER, PCMODO IN VARCHAR2, PCACTIVI IN NUMBER, PSPROCES IN
	NUMBER, PNMOVIMI IN NUMBER, PNERROR OUT NUMBER) RETURN NUMBER
authid current_user IS
--
-- ALLIBADM. CALCULA EL CAPITAL DE LES GARANTIES
-- CONSORCIABLES DEL RISC INTRODUÏT COM A PARÀMETRE.
--
--
CURSOR CUR_GARANT IS
	SELECT DISTINCT(CGARANT)
	FROM ESTGARANSEG
	WHERE SSEGURO = PSSEGURO AND
		TRUNC(PFEFECTO) >= TRUNC(FINIEFE) AND
		TRUNC(PFEFECTO) < TRUNC(NVL(FFINEFE, PFEFECTO + 2)) AND
		NRIESGO = NVL(PNRIESGO, NRIESGO);
XIPRIMA	NUMBER := 0;
XTOTPRIMA	NUMBER := 0;
XCGARANT	NUMBER;
XCRAMO	NUMBER;
XCMODALI	NUMBER;
XCTIPSEG	NUMBER;
XCCOLECT	NUMBER;
XCACTIVI	NUMBER;
XCIMPCON	NUMBER;
ERROR		NUMBER;
XICAPITAL	NUMBER;
BEGIN
IF PCMODO = 'R' OR PCMODO = 'N' THEN
	    BEGIN
		SELECT CIMPCON
		INTO XCIMPCON
		FROM GARANPRO
		WHERE CRAMO = PCRAMO AND
			CMODALI = PCMODALI AND
			CCOLECT = PCCOLECT AND
			CTIPSEG = PCTIPSEG AND
			CGARANT = PCGARANT AND
			CACTIVI = NVL(PCACTIVI, 0);
	    EXCEPTION
		WHEN NO_DATA_FOUND THEN
			BEGIN
			  SELECT NVL(CIMPCON, 0)
			  INTO XCIMPCON
			  FROM GARANPRO
		        WHERE CRAMO = PCRAMO AND
			    CMODALI = PCMODALI AND
			    CCOLECT = PCCOLECT AND
			    CTIPSEG = PCTIPSEG AND
			    CGARANT = PCGARANT AND
			    CACTIVI = 0;
			EXCEPTION
		        WHEN NO_DATA_FOUND THEN
			    PNERROR := 104110;	-- PRODUCTE NO TROBAT A GARANPRO
			    RETURN 0;
			  WHEN OTHERS THEN
			    PNERROR := 103503;  -- ERROR AL LLEGIR DE LA TAULA GARANPRO
			    RETURN 0;
			END;
		WHEN OTHERS THEN
		  PNERROR := 103503;	 -- ERROR AL LLEGIR DE LA TAULA GARANPRO
		  RETURN 0;
	    END;
	    IF XCIMPCON = 1 THEN	     -- ES SUMA EL CAPITAL DE LA GARANTIA
		BEGIN
		  SELECT NVL(ICAPITAL, 0)
		  INTO XICAPITAL
		  FROM ESTGARANSEG
		  WHERE SSEGURO = PSSEGURO AND
			NRIESGO = PNRIESGO AND
			CGARANT = PCGARANT AND
			NMOVIMI = PNMOVIMI;
		EXCEPTION
		  WHEN NO_DATA_FOUND THEN
			NULL;
--			PNERROR := 103839;	-- GARANTIA NO TROBADA A GARANSEG
--			RETURN 0;
		  WHEN OTHERS THEN
			PNERROR := 103500;  -- ERROR AL LLEGIR DE LA TAULA GARANSEG
			RETURN 0;
		END;
	    END IF;
	    PNERROR := 0;
	    RETURN NVL(XICAPITAL, 0);
ELSIF PCMODO = 'P' THEN	-- MODE DE PROVES
	    BEGIN
		SELECT CIMPCON
		INTO XCIMPCON
		FROM GARANPRO
		WHERE CRAMO = PCRAMO AND
			CMODALI = PCMODALI AND
			CCOLECT = PCCOLECT AND
			CTIPSEG = PCTIPSEG AND
			CGARANT = PCGARANT AND
			CACTIVI = NVL(PCACTIVI, 0);
	    EXCEPTION
		WHEN NO_DATA_FOUND THEN
			BEGIN
			  SELECT NVL(CIMPCON, 0)
			  INTO XCIMPCON
			  FROM GARANPRO
		        WHERE CRAMO = PCRAMO AND
			    CMODALI = PCMODALI AND
			    CCOLECT = PCCOLECT AND
			    CTIPSEG = PCTIPSEG AND
			    CGARANT = PCGARANT AND
			    CACTIVI = 0;
			EXCEPTION
		        WHEN NO_DATA_FOUND THEN
			    PNERROR := 104110;	-- PRODUCTE NO TROBAT A GARANPRO
			    RETURN 0;
			  WHEN OTHERS THEN
			    PNERROR := 103503;  -- ERROR AL LLEGIR DE LA TAULA GARANPRO
			    RETURN 0;
			END;
		WHEN OTHERS THEN
		  PNERROR := 103503;	  -- ERROR AL LLEGIR DE LA TAULA GARANPRO
		  RETURN 0;
	    END;
	    IF XCIMPCON = 1 THEN	     -- ES SUMA EL CAPITAL DE LA GARANTIA
		BEGIN
		  SELECT NVL(ICAPITAL,0)
		  INTO XICAPITAL
		  FROM GARANCAR
		  WHERE
			SPROCES = PSPROCES AND
			SSEGURO = PSSEGURO AND
			NRIESGO = PNRIESGO AND
			CGARANT = PCGARANT;
		EXCEPTION
		  WHEN NO_DATA_FOUND THEN
			NULL;
--			PNERROR := 103841;     -- GARANTIA NO TROBADA A GARANCAR
--			RETURN 0;
		  WHEN OTHERS THEN
			PNERROR := 103502;  -- ERROR AL LLEGIR DE LA TAULA GARANCAR
			RETURN 0;
		END;
	    END IF;
	    PNERROR := 0;
	    RETURN NVL(XICAPITAL, 0);
ELSIF PCMODO = 'D' THEN	-- OPCIÓ DIRECTA, QUAN NOMÉS SABEM EL SSEGURO
					-- I LA DATA D' EFECTE I EL NRIESGO (OPCIONAL)
IF PSSEGURO IS NOT NULL AND PFEFECTO IS NOT NULL THEN
	BEGIN
	  SELECT CRAMO, CMODALI, CTIPSEG, CCOLECT, CACTIVI
	  INTO XCRAMO, XCMODALI, XCTIPSEG, XCCOLECT, XCACTIVI
	  FROM SEGUROS
	  WHERE SSEGURO = PSSEGURO;
	EXCEPTION
	  WHEN NO_DATA_FOUND THEN
	    PNERROR := 101903;		-- ASSEGURANÇA NO TROBADA A SEGUROS
	    RETURN NULL;
	  WHEN OTHERS THEN
	    PNERROR := 101919;		-- ERROR AL LLEGIR DE SEGUROS
	    RETURN NULL;
END;
	OPEN CUR_GARANT;
	FETCH CUR_GARANT INTO XCGARANT;
	WHILE CUR_GARANT%FOUND LOOP
	  BEGIN
	    SELECT CIMPCON
	    INTO XCIMPCON
	    FROM GARANPRO
	    WHERE CRAMO = XCRAMO AND
		CMODALI = XCMODALI AND
		CCOLECT = XCCOLECT AND
		CTIPSEG = XCTIPSEG AND
		CGARANT = XCGARANT AND
		CACTIVI = XCACTIVI;
	  EXCEPTION
		WHEN NO_DATA_FOUND THEN
			BEGIN
			  SELECT NVL(CIMPCON, 0)
			  INTO XCIMPCON
			  FROM GARANPRO
		        WHERE CRAMO = XCRAMO AND
			    CMODALI = XCMODALI AND
			    CCOLECT = XCCOLECT AND
			    CTIPSEG = XCTIPSEG AND
			    CGARANT = XCGARANT AND
			    CACTIVI = 0;
			EXCEPTION
		        WHEN NO_DATA_FOUND THEN
			    PNERROR := 104110;	-- PRODUCTE NO TROBAT A GARANPRO
			    CLOSE CUR_GARANT;
			    RETURN NULL;
			  WHEN OTHERS THEN
			    PNERROR := 103503;  -- ERROR AL LLEGIR DE LA TAULA GARANPRO
			    CLOSE CUR_GARANT;
			    RETURN NULL;
			END;
		WHEN OTHERS THEN
		  PNERROR := 103503;  -- ERROR AL LLEGIR DE LA TAULA GARANPRO
		  CLOSE CUR_GARANT;
		  RETURN NULL;
	  END;
	  IF XCIMPCON = 1 THEN	    -- S' OBTÉ LA BASE PEL CÀLCUL DEL CONSORCI
	    BEGIN
		SELECT SUM(NVL(IPRIANU, 0))
		INTO XIPRIMA
		FROM ESTGARANSEG
		WHERE SSEGURO = PSSEGURO AND
			CGARANT = XCGARANT AND
			NRIESGO = NVL(PNRIESGO, NRIESGO);
	    EXCEPTION
		WHEN NO_DATA_FOUND THEN
		  NULL;
--		  PNERROR := 103839;		-- GARANTIA NO TROBADA A GARANSEG
--		  CLOSE CUR_GARANT;
--		  RETURN NULL;
		WHEN OTHERS THEN
		  PNERROR := 103500;		-- ERROR AL LLEGIR DE GARANSEG
		  CLOSE CUR_GARANT;
		  RETURN NULL;
	    END;
	    XTOTPRIMA := XTOTPRIMA + NVL(XIPRIMA, 0);
	  END IF;
	FETCH CUR_GARANT INTO XCGARANT;
	END LOOP;
	CLOSE CUR_GARANT;
	PNERROR := 0;
	RETURN XTOTPRIMA;
ELSE
	PNERROR := 101901;	-- PAS INCORRECTE DE PARÀMETRES A LA FUNCIÓ
	RETURN NULL;
END IF;
ELSE
PNERROR := 101901;		-- PAS DE PARÀMETRES INCORRECTE A LA FUNCIÓ
RETURN 0;
END IF;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_ESTBASECON" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_ESTBASECON" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_ESTBASECON" TO "PROGRAMADORESCSI";
