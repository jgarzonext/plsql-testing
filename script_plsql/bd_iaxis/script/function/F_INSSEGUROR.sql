--------------------------------------------------------
--  DDL for Function F_INSSEGUROR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_INSSEGUROR" 
(PNSEGURO IN NUMBER, PCEMPRES IN NUMBER,
PCAGENTE IN NUMBER, PFEMISIO IN DATE) RETURN NUMBER authid current_user IS
XMAXNIVEL	NUMBER(3) := 0;
DUMMY       NUMBER;
--
--
BEGIN
BEGIN
INSERT INTO SEGUROSREDCOM (SSEGURO, CEMPRES, CAGENTE, CTIPAGE, NNIVEL)
	 SELECT PNSEGURO, PCEMPRES, CAGENTE, CTIPAGE, LEVEL
	 FROM REDCOMERCIAL
	 WHERE  CEMPRES = PCEMPRES AND
		CPADRE IS NOT NULL AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)))
	 CONNECT BY PRIOR CPADRE = CAGENTE AND
		PRIOR CEMPRES = CEMPRES AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)))
	 START WITH CAGENTE = PCAGENTE AND
		CEMPRES = PCEMPRES AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)));
EXCEPTION
WHEN DUP_VAL_ON_INDEX THEN
	 RETURN 103907;	-- REGISTRE DUPLICAT A SEGUROSREDCOM
--
-- NUNCA DARÁ ESTE ERROR. LO PASAMOS AL SELECT DE ABAJO.
--
-- WHEN NO_DATA_FOUND THEN
-- 	 RETURN 103908;	-- NO S' HAN TROBAT REGISTRES A REDCOMERCIAL
--
WHEN OTHERS THEN
	 RETURN 103354;	-- ERROR A L' INSERIR A SEGUROSREDCOM
END;
BEGIN
SELECT SSEGURO
  INTO DUMMY
  FROM SEGUROSREDCOM
 WHERE SSEGURO = PNSEGURO
   AND CEMPRES = PCEMPRES;
EXCEPTION
WHEN NO_DATA_FOUND THEN
 	 RETURN 103908;	-- NO S' HAN TROBAT REGISTRES A REDCOMERCIAL
WHEN TOO_MANY_ROWS THEN
	NULL;
END;
BEGIN
SELECT MAX(NNIVEL)
INTO   XMAXNIVEL
FROM   SEGUROSREDCOM
WHERE  SSEGURO = PNSEGURO;
EXCEPTION
WHEN NO_DATA_FOUND THEN
	 XMAXNIVEL := 0;
WHEN OTHERS THEN
	 RETURN 103909;	-- ERROR AL LLEGIR DADES DE SEGUROSREDCOM
END;
BEGIN
UPDATE SEGUROSREDCOM
SET    NNIVEL  = XMAXNIVEL - NNIVEL + 1
WHERE  SSEGURO = PNSEGURO;
EXCEPTION
WHEN OTHERS THEN
	 RETURN 103910;	-- ERROR AL MODIFICAR SEGUROSREDCOM
END;
RETURN 0;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_INSSEGUROR" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_INSSEGUROR" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_INSSEGUROR" TO "PROGRAMADORESCSI";
