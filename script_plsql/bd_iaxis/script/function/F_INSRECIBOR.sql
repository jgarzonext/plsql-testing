--------------------------------------------------------
--  DDL for Function F_INSRECIBOR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "AXIS"."F_INSRECIBOR" (PNRECIBO IN NUMBER, PCEMPRES IN NUMBER, PCAGENTE IN
		     NUMBER, PFEMISIO IN DATE) RETURN NUMBER authid current_user IS
XMAXNIVEL	NUMBER(3) := 0;
--
--
BEGIN
BEGIN
INSERT INTO RECIBOSREDCOM (NRECIBO, CEMPRES, CAGENTE, CTIPAGE, NNIVEL)
	 SELECT PNRECIBO, PCEMPRES, CAGENTE, CTIPAGE, LEVEL
	 FROM REDCOMERCIAL
	 WHERE  CEMPRES = PCEMPRES AND
		CPADRE IS NOT NULL AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)))
	 CONNECT BY PRIOR CPADRE = CAGENTE AND
		PRIOR CEMPRES = CEMPRES AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)))
	 START WITH CAGENTE = PCAGENTE AND
		CEMPRES = PCEMPRES AND
		(TRUNC(PFEMISIO) >= TRUNC(FMOVINI)) AND
		(TRUNC(PFEMISIO) < NVL(TRUNC(FMOVFIN), TRUNC(PFEMISIO + 1)));
EXCEPTION
WHEN DUP_VAL_ON_INDEX THEN
	RETURN 103907;	-- REGISTRE DUPLICAT A RECIBOSREDCOM
WHEN NO_DATA_FOUND THEN
	RETURN 103908;	-- NO S' HAN TROBAT REGISTRES A REDCOMERCIAL
WHEN OTHERS THEN
	RETURN 103354;	-- ERROR A L' INSERIR A RECIBOSREDCOM
END;
BEGIN
SELECT MAX(NNIVEL)
INTO   XMAXNIVEL
FROM   RECIBOSREDCOM
WHERE  NRECIBO = PNRECIBO;
EXCEPTION
WHEN NO_DATA_FOUND THEN
	XMAXNIVEL := 0;
WHEN OTHERS THEN
	RETURN 103909;	-- ERROR AL LLEGIR DADES DE RECIBOSREDCOM
END;
BEGIN
UPDATE RECIBOSREDCOM
SET    NNIVEL  = XMAXNIVEL - NNIVEL + 1
WHERE  NRECIBO = PNRECIBO;
EXCEPTION
WHEN OTHERS THEN
	RETURN 103910;	-- ERROR AL MODIFICAR RECIBOSREDCOM
END;
RETURN 0;
END;
 
 

/

  GRANT EXECUTE ON "AXIS"."F_INSRECIBOR" TO "R_AXIS";
  GRANT EXECUTE ON "AXIS"."F_INSRECIBOR" TO "CONF_DWH";
  GRANT EXECUTE ON "AXIS"."F_INSRECIBOR" TO "PROGRAMADORESCSI";
