create or replace PROCEDURE P_FACT_COTIZACIONES_CREADAS(PI_FINICIO IN DATE, PI_FFIN    IN DATE) IS
                                         
CURSOR RESULT(P_FINICIO DATE, P_FFIN DATE) IS

SELECT DECODE(SE.CRAMO,802,2,1) COD_RAMO, 
(CASE AGE.CTIPAGE WHEN 2 THEN AGE.CAGENTE ELSE AXIS.PAC_REDCOMERCIAL.F_BUSCA_PADRE(SE.CEMPRES,SE.CAGENTE, NULL, AXIS.F_SYSDATE) END) SUCUR,
MSEG.NMOVIMI ||'-'||SE.NSOLICI NRO_COTIZACION, 
DECODE(SE.CSITUAC,4,'NUEVA',SE.NPOLIZA) POLIZA, 
DECODE(SE.CSITUAC,4,'NUEVA', (SELECT RDM.NCERTDIAN FROM AXIS.RANGO_DIAN_MOVSEGURO RDM WHERE RDM.SSEGURO = MSEG.SSEGURO AND RDM.NMOVIMI = MSEG.NMOVIMI)) CERTIF, 
MSEG.FMOVIMI FEC_CREA_COTIZACION,
CASE
WHEN MSEG.CMOVSEG = 0 THEN 'N'
WHEN MSEG.CMOVSEG NOT IN (0, 3, 52, 53, 2) THEN 'M'
WHEN MSEG.CMOVSEG IN (3, 52) THEN 'A'
WHEN MSEG.CMOVSEG = 53 THEN 'C'
WHEN MSEG.CMOVSEG = 2 THEN 'R'                     
END TIPO_CERTIFICADO,
AXIS.FF_DESVALORFIJO(61, 8, SE.CSITUAC) ESTADO_COT, 
CASE
WHEN SE.CTIPCOA = 0 THEN 1
WHEN SE.CTIPCOA IN (1, 2) THEN 2
WHEN SE.CTIPCOA IN (8, 9) THEN 3
END TIPO_COA,
DECODE(SE.CTIPCOA,0,100,(SELECT PLOCCOA FROM AXIS.COACUADRO CC WHERE CC.SSEGURO = SE.SSEGURO AND NCUACOA = 
(SELECT MAX(NCUACOA) FROM AXIS.COACUADRO CC2 WHERE CC2.SSEGURO = SE.SSEGURO))) PORCENTAJE_COA_CONFIANZA, 
MSEG.CUSUMOV USUARIO, 
DECODE(R.CTIPREC,9,-1*VDR.ITOTPRI,VDR.ITOTPRI)  VALOR_PRIMA,
DECODE(AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(SE.SPRODUC),8,1,6,2,1,8) MONEDA,
CASE
WHEN AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(SE.SPRODUC) = 8 THEN  0
WHEN AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(SE.SPRODUC) = 6 THEN AXIS.PAC_ECO_TIPOCAMBIO.F_CAMBIO('USD', 'COP', MSEG.FEMISIO)
WHEN AXIS.PAC_MONEDAS.F_MONEDA_PRODUCTO(SE.SPRODUC) = 1 THEN AXIS.PAC_ECO_TIPOCAMBIO.F_CAMBIO('EUR', 'COP', MSEG.FEMISIO)
END TRM                         
FROM AXIS.SEGUROS SE 
INNER JOIN AXIS.MOVSEGURO MSEG ON SE.SSEGURO = MSEG.SSEGURO
INNER JOIN AXIS.AGENTES AGE ON AGE.CAGENTE = SE.CAGENTE
LEFT JOIN AXIS.RECIBOS R ON R.SSEGURO = MSEG.SSEGURO AND R.NMOVIMI = MSEG.NMOVIMI
LEFT JOIN AXIS.VDETRECIBOS VDR ON R.NRECIBO = VDR.NRECIBO
WHERE MSEG.FMOVIMI BETWEEN P_FINICIO AND P_FFIN;

BEGIN

  DELETE FROM FACT_COTIZA_CREADAS_DUMMY;
  COMMIT;

  FOR ROWS IN RESULT(PI_FINICIO, PI_FFIN) LOOP

    INSERT INTO FACT_COTIZA_CREADAS_DUMMY
      (COTIZACIONES_ID,
       COD_RAMO,
       SUCUR,
       NRO_COTIZACION,
       POLIZA,
       CERTIF,
       FEC_CREA_COTIZACION,
       TIPO_CERTIFICADO,
       ESTADO_COT,
       TIPO_COA,
       PORCENTAJE_COA_CONFIANZA,
       USUARIO,
       VALOR_PRIMA,
       MONEDA,
       TRM)
    VALUES
      (SEQ_COTIZACIONES_ID.NEXTVAL,
       ROWS.COD_RAMO,
       ROWS.SUCUR,
       ROWS.NRO_COTIZACION,
       ROWS.POLIZA,
       ROWS.CERTIF,
       ROWS.FEC_CREA_COTIZACION,
       ROWS.TIPO_CERTIFICADO,
       ROWS.ESTADO_COT,
       ROWS.TIPO_COA,
       ROWS.PORCENTAJE_COA_CONFIANZA,
       ROWS.USUARIO,
       ROWS.VALOR_PRIMA,
       ROWS.MONEDA,
       ROWS.TRM);

  END LOOP;

  COMMIT;

END P_FACT_COTIZACIONES_CREADAS;