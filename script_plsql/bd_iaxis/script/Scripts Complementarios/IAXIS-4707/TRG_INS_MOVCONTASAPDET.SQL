CREATE OR REPLACE TRIGGER TRG_INS_MOVCONTASAPDET
  AFTER INSERT ON MOVSEGURO
  FOR EACH ROW
  WHEN (NEW.CMOVSEG IN (3, 52, 53))

DECLARE

  P_AGENTE      NUMBER;
  P_NMOVIMI     NUMBER;
  P_TIPCOA      NUMBER;
  P_TIPREC      NUMBER;
  P_EVENTO      VARCHAR2(20) := 'PRODUCCION';
  P_ESTREC      NUMBER;
  P_RECIBO      NUMBER;
  P_VALORTIPREC VARCHAR2(4);

BEGIN

  SELECT NRECIBO, CAGENTE, NMOVIMI, CTIPCOA, CTIPREC
    INTO P_RECIBO, P_AGENTE, P_NMOVIMI, P_TIPCOA, P_TIPREC
    FROM RECIBOS
   WHERE SSEGURO = :NEW.SSEGURO
     AND NMOVIMI = :NEW.NMOVIMI;

  IF :NEW.CMOVSEG = 52 THEN
    IF P_TIPREC = 1 THEN
      SELECT CESTREC INTO P_ESTREC FROM MOVRECIBO WHERE NRECIBO = P_RECIBO AND CMOTMOV = P_NMOVIMI;

      IF P_ESTREC = 2 THEN
        P_VALORTIPREC := '1522';
        INSERT INTO MOVCONTASAP
          (NRECIBO, CAGENTE, NMOVIMI, SSEGURO, CTIPCOA, CTIPREC, EVENTO)
        VALUES
          (P_RECIBO,
           P_AGENTE,
           :NEW.NMOVIMI,
           :NEW.SSEGURO,
           P_TIPCOA,
           P_VALORTIPREC,
           P_EVENTO);
      END IF;
    ELSIF P_TIPREC = 9 THEN
      SELECT CESTREC INTO P_ESTREC FROM MOVRECIBO WHERE NRECIBO = P_RECIBO AND CMOTMOV = P_NMOVIMI ;

      IF P_ESTREC = 2 THEN
        P_VALORTIPREC := '9522';
        INSERT INTO MOVCONTASAP
          (NRECIBO, CAGENTE, NMOVIMI, SSEGURO, CTIPCOA, CTIPREC, EVENTO)
        VALUES
          (P_RECIBO,
           P_AGENTE,
           :NEW.NMOVIMI,
           :NEW.SSEGURO,
           P_TIPCOA,
           P_VALORTIPREC,
           P_EVENTO);
      END IF;
    END IF;
  ELSIF :NEW.CMOVSEG = 3 THEN
    IF P_TIPREC = 9 THEN
      SELECT CESTREC INTO P_ESTREC FROM MOVRECIBO WHERE NRECIBO = P_RECIBO AND CMOTMOV = P_NMOVIMI;

      IF P_ESTREC = 2 THEN
        P_VALORTIPREC := '9032';
        INSERT INTO MOVCONTASAP
          (NRECIBO, CAGENTE, NMOVIMI, SSEGURO, CTIPCOA, CTIPREC, EVENTO)
        VALUES
          (P_RECIBO,
           P_AGENTE,
           :NEW.NMOVIMI,
           :NEW.SSEGURO,
           P_TIPCOA,
           P_VALORTIPREC,
           P_EVENTO);
      END IF;
    END IF;
  ELSIF :NEW.CMOVSEG = 53 THEN
    IF P_TIPREC = 9 THEN
      SELECT CESTREC INTO P_ESTREC FROM MOVRECIBO WHERE NRECIBO = P_RECIBO AND CMOTMOV = P_NMOVIMI;

      IF P_ESTREC = 2 THEN
        P_VALORTIPREC := '9532';
        INSERT INTO MOVCONTASAP
          (NRECIBO, CAGENTE, NMOVIMI, SSEGURO, CTIPCOA, CTIPREC, EVENTO)
        VALUES
          (P_RECIBO,
           P_AGENTE,
           :NEW.NMOVIMI,
           :NEW.SSEGURO,
           P_TIPCOA,
           P_VALORTIPREC,
           P_EVENTO);
      END IF;
    END IF;
  END IF;
END;
/

