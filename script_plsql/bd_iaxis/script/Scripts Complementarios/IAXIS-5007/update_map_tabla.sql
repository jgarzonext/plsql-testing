-----Actualizacion 20200114 JRV

update map_tabla mt 
set mt.tfrom = '(SELECT LINEA FROM (
SELECT ''AC'' MM, LINEA FROM (
 SELECT DISTINCT P.SPERSON_ACRE||''|''||AC.PPARTICI||''|''||DECODE(A.CTIPAGE,3,''A'',5,''A'',6,''A'',7,''A'',4,''C'')||''|''||DECODE(PR.CREGFISCAL, 2, ''S'', ''C'') LINEA
   FROM PER_PERSONAS P,PER_REGIMENFISCAL PR, AGE_CORRETAJE AC,MOVCONTASAP M,CONTAB_ASIENT_INTERF CAI,AGENTES A,SEGUROS SEG
  WHERE P.SPERSON = PR.SPERSON AND PR.SPERSON = A.SPERSON AND A.CAGENTE = AC.CAGENTE AND AC.SSEGURO = M.SSEGURO AND CAI.SINTERF = M.SINTERF
    AND SEG.SSEGURO = M.SSEGURO
    AND SEG.CTIPCOM <> 99
    AND AC.NMOVIMI = M.NMOVIMI AND CAI.IDPAGO = M.NRECIBO  AND CAI.CCUENTA IN (''168405'',''168410'',''168415'')
    AND PR.FEFECTO = (SELECT MAX(P.FEFECTO) FROM PER_REGIMENFISCAL P WHERE P.SPERSON = A.SPERSON)
    AND M.NRECIBO = PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',16,''#cmapead'')
    AND M.SINTERF = PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',10,''#cmapead''))
UNION
SELECT ''NO'' MM,'''' LINEA FROM DUAL
UNION
SELECT ''A'' MM, LINEA FROM (
SELECT DISTINCT P.SPERSON_ACRE||''|''||100||''|''||DECODE(A.CTIPAGE,3,''A'',5,''A'',6,''A'',7,''A'',4,''C'')||''|''||DECODE(PR.CREGFISCAL, 2, ''S'', ''C'') LINEA
 FROM PER_PERSONAS P,PER_REGIMENFISCAL PR, AGENTES A,MOVCONTASAP M,CONTAB_ASIENT_INTERF CAI,SEGUROS SEG
WHERE P.SPERSON = A.SPERSON
AND PR.SPERSON = A.SPERSON AND CAI.SINTERF = M.SINTERF
AND SEG.SSEGURO = M.SSEGURO
AND SEG.CTIPCOM <> 99
AND A.CAGENTE = M.CAGENTE
AND CAI.IDPAGO = M.NRECIBO  AND CAI.CCUENTA IN (''168405'',''168410'',''168415'')
AND PR.FEFECTO = (SELECT MAX(P.FEFECTO) FROM PER_REGIMENFISCAL P WHERE P.SPERSON = A.SPERSON)
AND M.NRECIBO = PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',16,''#cmapead'')
AND M.SINTERF = PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',10,''#cmapead''))) T1
WHERE PAC_CONTA_SAP.F_INTERMEDIARIO_SAP(PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',16,''#cmapead''),PAC_MAP.F_VALOR_PARAMETRO(''|'',''#lineaini'',10,''#cmapead'')) = T1.MM AND T1.LINEA IS NOT NULL)',
mt.tdescrip = 'INTERMEDIARIO'
where mt.ctabla = 100314;
commit;
/
